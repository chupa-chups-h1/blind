define('lib/cookies',[], function() {
	
	// Utils lib
	var root_domain;
	
	var getRootDomain = function() {
		if(typeof(root_domain) === 'string') {
			return root_domain;
		}
		var parts = window.location.hostname.split('.');
		if(parts.length >= 2) {
			root_domain = '';
			for(var i = parts.length - 2; i < parts.length; i++) {
				root_domain += '.'+parts[i];
			}
		}
		return root_domain;
	};
	
	// Cookies lib
	var cookies = {};
	var read_val = function(cookiestr, offset) {
		var endstr = cookiestr.indexOf(";", offset);
		if (endstr === -1) {
			endstr = cookiestr.length;
		}
		return unescape(cookiestr.substring(offset, endstr));
	};
	
	cookies.set = function (name, value, expires, path, domain, secure, same_site) {
		var toset = [];
		toset.push(name + "=" +encodeURIComponent(value));
		if (typeof expires === 'number') {
			if (expires >= 0) {
				var today = new Date();
				today.setTime(today.getTime());
				var expires_date = new Date(today.getTime() + expires);
				toset.push('Expires=' + expires_date.toGMTString());
			}
			else {
				toset.push('Expires=Thu, 01 Jan 1970 00:00:00 UTC');
			}
		}
		if (path) {
			toset.push('Path=' + path);
		}
		if (domain) {
			toset.push('Domain=' + domain);
		}
		if (secure && window.location.protocol.indexOf('s') > 0) {
			toset.push('Secure');
		}
		if (same_site && (same_site === 'Strict' || same_site === 'Lax' || same_site === 'None' && secure)) {
			toset.push('SameSite=' + same_site);
		}
 		document.cookie = toset.join(';');
	};
	
	cookies.setLocal = function (name, value, expires, path, secure, same_site) {
		cookies.set(name, value, expires, path, getRootDomain(), secure, same_site);
	};
	
	cookies.removeLocal = function (name, path) {
		cookies.setLocal(name, '', -1, path);
	};
	
	cookies.get = function(name) {
		var arg = name + "=",
			alen = arg.length,
			cookiestr = document.cookie,
			clen = cookiestr.length,
			i = 0;
		
		while (i < clen) {
			var j = i + alen;
			if (cookiestr.substring(i, j) === arg) {
				return read_val(cookiestr, j);
			}
			i = cookiestr.indexOf(" ", i) + 1;
			if (i === 0) {
				break;
			}
		}
		
		return null;
	};
	
	return cookies;
});
define('lib/storage',["./cookies"], function(cookies) {

	// IndexedDb storage lib
	// Documentation here : https://git-repos.webgroup-limited.com/wgvid/xvideos-static/-/wikis/IndexedDb
	var indexed_db = function () {
		this.s = window.indexedDB;
		this.type = 'indexedDb';
		this.oDb = null;
		this.bIsSupported = false;
		this.bRemoveLocalStorage = true; // @TODO IF ANY PROBLEM WITH LOCAL STORAGE DELETE TURN TO FALSE !!!!
		this.bDbIsOpen = null;
		this.bDbIsUpdating = null;
		this.sDbName = null;
		this.sDbStoreName = 'main_store';
		this.aDbStoreIndex = [
			{ index: 'key', unique: true }
		];
		this.aTempStackTodo = [];
		this.bKeyPathAutoIncrement = false;
		this.oResult = null;
		this.sDbName = 'DB_CHAT';
	}

	indexed_db.prototype = {
		/**
		 * Set IndexedDb support
		 * @param {Boolean} bValue
		 */
		setDbIsSupported: function (bValue) {
			this.bIsSupported = bValue;
		},


		// IDB SETTINGS
		/**
		 * Get Remove LocalStorage
		 * @returns {Boolean}
		 */
		getRemoveLocalStorage: function() {
			return this.bRemoveLocalStorage;
		},

		/**
		 * Get IndexedDb is supported
		 * @returns {Boolean}
		 */
		getDbIsSupported: function() {
			return this.bIsSupported;
		},

		/**
		 * Get IndexedDb is open
		 * @returns {Boolean}
		 */
		getDbIsOpen: function() {
			return this.bDbIsOpen;
		},

		/**
		 * Get IndexedDb is updating
		 * @returns {Boolean}
		 */
		getDbIsUpdating: function() {
			return this.bDbIsUpdating;
		},

		/**
		 * Get result from a get saved in the xv.indexedDb object
		 * @returns {Boolean}
		 */
		getResult: function() {
			return this.oResult;
		},

		/**
		 * Get all storename available in an array
		 * @returns {void|Boolean|Array}
		 */
		getAllStoreName: function() {
			var oSelf = this;
			if (!this.bDbIsOpen) {
				this.openCommonDb().then(function() {
					oSelf.getAllStoreName();
				});
				return;
			}

			try {
				this.oDb.objectStoreNames;
			} catch(e) {
				return false;
			}

			var aStoreNames = [];
			if (this.oDb.objectStoreNames.length) {
				for (var sIndex in this.oDb.objectStoreNames) {
					if (typeof this.oDb.objectStoreNames[sIndex] !== 'string') {
						continue;
					}
					aStoreNames.push(this.oDb.objectStoreNames[sIndex]);
				}
				return aStoreNames;
			}

			return false;
		},

		/**
		 * Get if store exists
		 * @param {Object} oOptions
		 * {
		 * 		store_name: {String},
		 * 		callback_store_no_exist: {Function},
		 * 		callback_store_exist: {function}
		 * 	}
		 * @returns {Boolean}
		 */
		getStoreExist: function(oOptions) {
			var aAllStores = this.getAllStoreName();
			if (!aAllStores || aAllStores.indexOf(oOptions.store_name) === -1) {
				if (typeof oOptions.callback_store_no_exist === 'function') {
					oOptions.callback_store_no_exist();
				}
				return false;
			}

			if (typeof oOptions.callback_store_exist === 'function') {
				oOptions.callback_store_exist();
			}
			return true;
		},

		// OPEN - CLOSE
		/**
		 * Open generic use for test
		 * @param {String} sDbName
		 * @param {Function} fnCallbackSuccess
		 * @param {Function} fnCallbackFailure
		 */
		open: function(sDbName, fnCallbackSuccess, fnCallbackFailure) {
			var oRequest = this.s.open(sDbName);

			oRequest.onsuccess = function (event) {
				if (typeof fnCallbackSuccess === 'function') {
					fnCallbackSuccess();
				}
			}

			oRequest.onerror = function(event) {
				if (typeof fnCallbackFailure === 'function') {
					fnCallbackFailure();
				}
			}
		},

		/**
		 * Open prod DB
		 * @param {Object} oConfigNewStore
		 */
		openCommonDb: function(oConfigNewStore) {
			if (this.bDbIsOpen) {
				return;
			}
			this.bDbIsOpen = true;

			var oSelf = this;
			return new Promise(function(resolve, reject) {
				if (typeof oConfigNewStore === 'undefined') {
					oSelf.oRequest = oSelf.s.open(oSelf.sDbName);
				}
				else {
					oSelf.iDbVersion = oSelf.iDbVersion + 1;
					oSelf.oRequest = oSelf.s.open(oSelf.sDbName, oSelf.iDbVersion);
				}
				oSelf.bDbIsUpdating = true;

				oSelf.oRequest.onupgradeneeded = function (event) {
					if (!oSelf.bDbIsUpdating) {
						oSelf.bDbIsUpdating = true;
					}
					oSelf.oDb =event.target.result;
					if (typeof oConfigNewStore === 'undefined') {
						return;
					}
					oSelf.iDbVersion = parseInt(oSelf.oDb.version);
					oSelf.storeUpdateDb(oConfigNewStore);
					resolve();
				}

				oSelf.oRequest.onsuccess = function (event) {
					oSelf.oDb = event.target.result;
					if (oSelf.oDb !== null) {
						oSelf.iDbVersion = parseInt(oSelf.oDb.version);
						if (oSelf.bDbIsUpdating) {
							oSelf.bDbIsUpdating = false;
						}
						if (oSelf.aTempStackTodo.length) {
							oSelf.tempStackExec();
						}
						resolve();
					}
				}

				oSelf.oRequest.onerror = function(event) {
					oSelf.setDbIsSupported(false);
					oSelf.closeCommonDb();
					//reject(event);
				}
			});
		},

		/**
		 * Close prod DB
		 */
		closeCommonDb: function() {
			if (!this.bDbIsOpen) {
				return;
			}
			this.bDbIsOpen = false;
			if (this.oDb !== null) {
				this.oDb.close();
			}
		},


		// STORES
		/**
		 * Update Current IndexedDB with a new store
		 * @param {Object} oOptions
		 */
		storeUpdateDb: function(oOptions) {
			var oStoreConfig = {};
			oStoreConfig.action = oOptions.action;

			if (oOptions.action === 'create') {
				oStoreConfig.store_index = oOptions.index_auto_increment ? { keyPath: 'id', autoIncrement: true } : { keyPath: oOptions.store_index[0].index }

				var oStore = this.oDb.createObjectStore(oOptions.store_name, oStoreConfig.store_index);
				for (var sIndex in oOptions.store_index) {
					oStore.createIndex(oOptions.store_index[sIndex].index, oOptions.store_index[sIndex].index, {unique: oOptions.store_index[sIndex].unique});
				}
				return;
			}

			if (oOptions.action === 'remove') {
				if (!this.getStoreExist({store_name: oOptions.store_name})) {
					return;
				}
				this.oDb.deleteObjectStore(oOptions.store_name);
				return;
			}

		},

		/**
		 * Create a new Store
		 * @param {Object} oOptions
		 */
		storeCreate: function(oOptions) {
			var oSelf = this,
				oConfigStore = {
					action: 'create',
					store_name: (typeof oOptions.store_name !== 'undefined' && oOptions.store_name !== null) ? oOptions.store_name : this.sDbStoreName,
					store_index: (typeof oOptions.store_index !== 'undefined' && oOptions.store_index !== null) ? oOptions.store_index : this.aDbStoreIndex,
					index_auto_increment: (typeof oOptions.index_auto_increment === 'boolean') ? oOptions.index_auto_increment : this.bKeyPathAutoIncrement,
				};

			if (!this.bDbIsOpen) {
				this.openCommonDb(oConfigStore).then(function() {
					oSelf.storeCreate(oOptions);
				});
				return;
			}

			this.closeCommonDb();
			this.openCommonDb(oConfigStore).then(function() {
				if (typeof oOptions.callback_store_created === 'function') {
					oOptions.callback_store_created();
				}
			});
		},

		/**
		 * Remove a Store
		 * @param {String} sDbStoreName
		 * @param {Function} fnCallback
		 */
		storeRemove: function(sDbStoreName, fnCallback) {
			var oStoreConfig = {
				action: 'remove',
				store_name: sDbStoreName
			};
			if (this.bDbIsOpen) {
				this.closeCommonDb();
			}
			this.openCommonDb(oStoreConfig).then(function(result) {
				if (typeof fnCallback === 'function') {
					fnCallback();
				}
			});
		},

		/**
		 * Create a new Store from localstorage
		 * @param {String} sNameKey
		 * @param {Object} oDataLocalStorage
		 * @param {Function} fnCallback
		 */
		storeCreateFromLocalStorage: function(sNameKey, oDataLocalStorage, fnCallback) {
			this.bDbIsMigrating = true;
			if (typeof this.aDatasStore === 'undefined') {
				this.aDatasStore = [];
			}
			var aDatas,
				sIndexStore,
				sDbStoreName = sNameKey,
				oSelf = this;

			this.aDatasStore.push({
				sStoreName: sDbStoreName,
				aDatas: (oDataLocalStorage && typeof oDataLocalStorage === 'object' && oDataLocalStorage.length > 0) ? oDataLocalStorage : xv.storage.get(sNameKey)
			});

			if (this.aDatasStore.length === 1) {
				sIndexStore = '0';
			}
			else {
				for (var sIndex in this.aDatasStore) {
					if (this.aDatasStore[sIndex].sStoreName !== sDbStoreName) {
						continue;
					}
					sIndexStore = sIndex;
				}
			}
			aDatas = oSelf.aDatasStore[sIndexStore].aDatas;

			for (var sIndex in aDatas) {
				function fnAdd(sIndex) {
					if (typeof aDatas[sIndex] === 'object') {
						var oCurrentData = aDatas[sIndex],
							oCurrentDate = new Date(oCurrentData.t);
						if (oCurrentDate.getFullYear() === 1970 && new Date(oCurrentData.t * 1000).getFullYear() === new Date().getFullYear()) {
							oCurrentData.t = oCurrentData.t * 1000;
						}
						oSelf.manageTempStackAdd(function() {
							oSelf.oDb.transaction(sDbStoreName, 'readwrite').objectStore(sDbStoreName).add(JSON.parse(JSON.stringify(oCurrentData)));
						}, sDbStoreName);
					}
				}
				fnAdd(sIndex);
			}
			if (typeof fnCallback === 'function') {
				fnCallback();
			}
			this.bDbIsMigrating = false;
		},


		// TEMPSTACK
		/**
		 * Manage functions in tempstack
		 * @param {Function} fnTodo
		 * @param {string} sStoreName (optional)
		 */
		manageTempStackAdd: function(fnTodo, sStoreName) {
			var bStoreExists = (sStoreName !== null && typeof sStoreName !== 'undefined' && typeof sStoreName === 'string' && sStoreName.length > 0) ? this.getStoreExist({store_name: sStoreName}) : true;
			if (typeof fnTodo === 'function' && this.bDbIsOpen && !this.bDbIsUpdating && !this.bDbIsMigrating && !this.bIsTempStackExecuting && bStoreExists) {
				fnTodo();
			}
			else {
				this.tempStackAdd(fnTodo);
			}
		},

		/**
		 * Add a function in the tempstack Array
		 * @param {Function} fnTodo
		 */
		tempStackAdd: function(fnTodo) {
			if (typeof fnTodo === 'function') {
				this.aTempStackTodo.push(fnTodo);
			}
		},

		/**
		 * Exec the tempstack Array
		 */
		tempStackExec: function() {
			this.bIsTempStackExecuting = true;
			while(this.aTempStackTodo.length > 0) {
				if (!this.bDbIsOpen || this.bDbIsUpdating) {
					break;
				}
				if (typeof this.aTempStackTodo[0] === 'function') {
					this.aTempStackTodo[0]();
				}
				this.aTempStackTodo.splice(0, 1);
			}
			this.bIsTempStackExecuting = false;
		},


		// DATAS
		/**
		 * Save data in IndexedDb
		 * @param {Object} oValue
		 * @param {String} sDbStoreName
		 */
		set: function(oValue, sDbStoreName) {
			if (typeof sDbStoreName === 'undefined' || sDbStoreName === '' || sDbStoreName === null) {
				sDbStoreName = this.sDbStoreName;
			}

			if (typeof oValue === 'undefined' || oValue === null || oValue === {}) {
				return;
			}

			var oSelf = this;
			if (!this.bDbIsOpen) {
				this.openCommonDb().then(function() {
					oSelf.set(oValue, sDbStoreName);
				});
				return;
			}

			if (!this.getStoreExist({store_name: sDbStoreName})) {
				var aDbStoreIndex = sDbStoreName === this.sDbStoreName ? null : [{'index': Object.getOwnPropertyNames(oValue)[0]}],
					oNewValue = oValue;

				if (sDbStoreName === this.sDbStoreName) {
					oNewValue.key = oValue[Object.keys(oValue)[0]];
				}

				this.storeCreate({
					store_name: sDbStoreName,
					store_index: aDbStoreIndex,
					index_auto_increment: null,
					callback_store_created: function() {
						oSelf.tempStackAdd(function() {
							if (!oNewValue.hasOwnProperty('t')) {
								oNewValue['t'] = new Date().getTime();
							}
							oSelf.oDb.transaction(sDbStoreName, 'readwrite').objectStore(sDbStoreName).add(oNewValue);
						});
					}
				});
				return;
			}

			this.manageTempStackAdd(function() {
				if (!oValue.hasOwnProperty('t')) {
					oValue['t'] = new Date().getTime();
				}
				oSelf.oDb.transaction(sDbStoreName, 'readwrite').objectStore(sDbStoreName).add(oValue);
			});

		},

		/**
		 * Get Data from IndexedDB
		 * @param {String} sDbStoreKey
		 * @param {String} sDbStoreName
		 * @param {Boolean} bResultAllInfos
		 */
		get: function(sDbStoreKey, sDbStoreName, bResultAllInfos) {
			if (typeof sDbStoreName === 'undefined' || sDbStoreName === '' || sDbStoreName === null) {
				sDbStoreName = this.sDbStoreName;
			}
			if (typeof bResultAllInfos === 'undefined' || typeof bResultAllInfos !== 'boolean' || bResultAllInfos === null) {
				bResultAllInfos = false;
			}

			if (!this.getStoreExist({store_name: sDbStoreName})) {
				return;
			}

			var oSelf = this;

			if (!this.bDbIsOpen) {
				this.openCommonDb().then( function() {
					oSelf.get(sDbStoreKey, sDbStoreName).then(function() {
						return;
					});
				});
				return;
			}

			this.oResult = null;

			return new Promise(function(resolve, reject) {
				var fnGet = function(bUsePromise) {
					if (typeof bUsePromise === 'undefined') {
						bUsePromise = false;
					}

					var oTransaction = oSelf.oDb.transaction(sDbStoreName, 'readonly').objectStore(sDbStoreName),
						fnTransactionSuccess = function(event) {
							if (event.target.result !== undefined) {
								oSelf.oResult = event.target.result;
								if (bUsePromise) {
									resolve(bResultAllInfos ? event : oSelf.oResult);
								}
								else {
									return bResultAllInfos ? event : oSelf.oResult;
								}
							}
							else {
								if (bUsePromise) {
									resolve(false);
								}
							}
						};

					if (sDbStoreKey !== null && sDbStoreKey !== '') {
						oTransaction.get(sDbStoreKey).onsuccess = function(event) {
							fnTransactionSuccess(event);
						}
					}
					else {
						oTransaction.getAll().onsuccess = function(event) {
							fnTransactionSuccess(event);
						}
					}

					oTransaction.onerror = function(event) {
						reject(event);
					}
				}

				if (!oSelf.bDbIsOpen || oSelf.bDbIsUpdating) {
					oSelf.tempStackAdd(fnGet);
				}
				else {
					fnGet(true);
				}
			});
		},

		/**
		 * Remove Data from IndexedDB
		 * @param {String} sDbStoreKey
		 * @param {String} sDbStoreName
		 */
		remove: function(sDbStoreKey, sDbStoreName) {
			if (typeof sDbStoreKey === 'undefined' || sDbStoreKey === '' || sDbStoreKey === null) {
				return;
			}

			if (typeof sDbStoreName === 'undefined' || sDbStoreName === '' || sDbStoreName === null) {
				sDbStoreName = this.sDbStoreName;
			}

			if (!this.bDbIsOpen) {
				var oSelf = this;
				this.openCommonDb().then(function() {
					oSelf.remove(sDbStoreKey, sDbStoreName);
				});
				return;
			}

			this.oDb.transaction(sDbStoreName, 'readwrite').objectStore(sDbStoreName).delete(sDbStoreKey);
		},

		/**
		 * Update Data in IndexedDB
		 * @param {Object} oValue
		 * @param {String} sDbStoreKey
		 * @param {String} sDbStoreName
		 */
		update: function(oValue, sDbStoreKey, sDbStoreName) {
			if (!this.bDbIsOpen) {
				var oSelf = this;
				this.openCommonDb().then(function() {
					oSelf.update(oValue, sDbStoreKey, sDbStoreName);
				});
				return;
			}

			if (typeof sDbStoreName === 'undefined' || sDbStoreName === '' || sDbStoreName === null) {
				sDbStoreName = this.sDbStoreName;
			}

			var oTransaction = this.oDb.transaction([sDbStoreName], 'readwrite').objectStore(sDbStoreName),
				oRequest = oTransaction.get(sDbStoreKey);

			oRequest.onsuccess = function(event) {
				if (event.target.result !== undefined) {
					var oResult = event.target.result;
					Array.from(Object.keys(oValue)).map( function(i) {
						oResult[i] = oValue[i];
					});
					oTransaction.put(oResult);
				}
			}
		},

		/**
		 * clear Datas
		 * @param {String} sDbStoreName
		 * @param {Number} iDaysLimit
		 */
		clear: function(sDbStoreName, iDaysLimit, fnCallback) {
			var oSelf = this,
				fnLoop = function(oResult, fnCallback) {
					for (var sIndex in oResult.target.result) {
						var oCurrentItem = oResult.target.result[sIndex];
						if (typeof iDaysLimit !== 'undefined' && typeof iDaysLimit === 'number') {
							iDaysLimit = iDaysLimit * 24 * 60 * 60 * 1000;
							if ((new Date().getTime() - iDaysLimit) > oCurrentItem.t) {
								oSelf.remove(oCurrentItem[oResult.target.source.keyPath].toString(), oResult.target.source.name.toString());
							}
						}
						else {
							oSelf.remove(oCurrentItem[oResult.target.source.keyPath], oResult.target.source.name.toString());
						}
					};
					if (typeof fnCallback === 'function') {
						fnCallback();
					}
				};

			if (this.getStoreExist({ store_name: sDbStoreName })) {
				this.get(null, sDbStoreName, true).then(function(result) {
					if (result.target.result.length > 0) {
						fnLoop(result);
					}
				});
			}
			else {
				var aAllStores = this.getAllStoreName();
				if (!aAllStores) {
					return;
				}
				for (var sIndex in aAllStores) {
					this.get(null, aAllStores[sIndex], true).then(function(result) {
						if (result.target.result.length > 0) {
							fnLoop(result);
						}
					});
				}
			}
		},

		/**
		 * clear Logs
		 */
		clearLogs: function() {
			var oSelf = this,
				sDbStoreLogs = 'debugconsole.logs',
				iLimit = 1000;
			this.get(null, sDbStoreLogs, true).then(function(result) {
				var oResult = result.target.result,
					iResultLength = oResult.length;

				if (iResultLength < iLimit) {
					return;
				}

				for (var i = 0; i < (iResultLength - iLimit); i++) {
					oSelf.remove(oResult[i].id, sDbStoreLogs);
				}
			});
		}
	};

	// Local storage lib
	var local_storage = function() {
		this.s = window.localStorage;
	};
	
	local_storage.prototype = {
		type: 'local',
		get: function(name, ns) {
			if (typeof ns === 'string' && ns.length > 0) {
				name = ns + '.' + name;
			}
			try {
				return JSON.parse(this.s.getItem(name));
			} catch (e) {
				return null;
			}
		},
		set: function(name, value, ns) {
			if (typeof ns === 'string' && ns.length > 0) {
				name = ns + '.' + name;
			}
			this.s.setItem(name, JSON.stringify(value));
		},
		remove: function(name, ns) {
			if (typeof ns === 'string' && ns.length > 0) {
				name = ns + '.' + name;
			}
			this.s.removeItem(name);
		},
		clear: function() {
			this.s.clear();
		}
	};
	
	// Cookie storage lib
	var defns = '_globalns_';
	
	var cookie_storage = function() {
		this.data = {};
	};
	
	cookie_storage.prototype = {
		type: 'cookie',
		_loadNs: function(ns) {
			if (typeof ns !== 'string' || ns.length === 0) {
				ns = defns;
			}
			if (typeof (this.data[ns]) !== 'object') {
				this.data[ns] = {};
				var data = cookies.get('hexavid_storage_' + ns);
				if (typeof data === 'string' && data.length > 0) {
					try {
						data = JSON.parse(data);
						if (typeof (data) === 'object') {
							this.data[ns] = data;
						}
					} catch (e) {
						console.error(e);
					}
				}
			}
		},
		_write: function(ns) {
			if (typeof ns !== 'string' || ns.length === 0) {
				ns = defns;
			}
			try {
				var data = JSON.stringify(this.data[ns]);
				cookies.setLocal('hexavid_storage_' + ns, data, 3600000 * 24 * 365, '/');
			} catch (e) {
				console.error(e);
			}
		},
		get: function(name, ns) {
			this._loadNs(ns);
			if (typeof this.data[ns || defns][name] === 'undefined') {
				return null;
			}
			return this.data[ns || defns][name];
		},
		set: function(name, value, ns) {
			this._loadNs(ns);
			this.data[ns || defns][name] = value;
			this._write(ns);
		},
		remove: function(name, ns) {
			this._loadNs(ns);
			if (typeof this.data[ns || defns][name] !== 'undefined') {
				delete this.data[ns || defns][name];
				this._write(ns);
			}
		},
		clear: function() {
			this._loadNs(ns);
			this.data[ns || defns] = {};
			this._write(ns);
		}
	};

	if (!window.storage) {
		window.storage = {};
	}

	try {
		if (typeof window.indexedDB === 'object') {
			storage.indexedDb = new indexed_db();
			storage.indexedDb.setDbIsSupported(true);
			storage.indexedDb.openCommonDb();
		}
		if (typeof window.localStorage === 'object') {
			var store = window.localStorage,
				x = '__storage_test__';
			store.setItem(x, x);
			store.removeItem(x);
			return new local_storage();
		}
	}
	catch (e)
	{
	}
	return new cookie_storage();
});
/*!
 * mustache.js - Logic-less {{mustache}} templates with JavaScript
 * http://github.com/janl/mustache.js
 */

/*global define: false Mustache: true*/

(function defineMustache (global, factory) {
  if (typeof exports === 'object' && exports && typeof exports.nodeName !== 'string') {
    factory(exports); // CommonJS
  } else if (typeof define === 'function' && define.amd) {
    define('mustache',['exports'], factory); // AMD
  } else {
    global.Mustache = {};
    factory(global.Mustache); // script, wsh, asp
  }
}(this, function mustacheFactory (mustache) {

  var objectToString = Object.prototype.toString;
  var isArray = Array.isArray || function isArrayPolyfill (object) {
    return objectToString.call(object) === '[object Array]';
  };

  function isFunction (object) {
    return typeof object === 'function';
  }

  /**
   * More correct typeof string handling array
   * which normally returns typeof 'object'
   */
  function typeStr (obj) {
    return isArray(obj) ? 'array' : typeof obj;
  }

  function escapeRegExp (string) {
    return string.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g, '\\$&');
  }

  /**
   * Null safe way of checking whether or not an object,
   * including its prototype, has a given property
   */
  function hasProperty (obj, propName) {
    return obj != null && typeof obj === 'object' && (propName in obj);
  }

  // Workaround for https://issues.apache.org/jira/browse/COUCHDB-577
  // See https://github.com/janl/mustache.js/issues/189
  var regExpTest = RegExp.prototype.test;
  function testRegExp (re, string) {
    return regExpTest.call(re, string);
  }

  var nonSpaceRe = /\S/;
  function isWhitespace (string) {
    return !testRegExp(nonSpaceRe, string);
  }

  var entityMap = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#39;',
    '/': '&#x2F;',
    '`': '&#x60;',
    '=': '&#x3D;'
  };

  function escapeHtml (string) {
    return String(string).replace(/[&<>"'`=\/]/g, function fromEntityMap (s) {
      return entityMap[s];
    });
  }

  var whiteRe = /\s*/;
  var spaceRe = /\s+/;
  var equalsRe = /\s*=/;
  var curlyRe = /\s*\}/;
  var tagRe = /#|\^|\/|>|\{|&|=|!/;

  /**
   * Breaks up the given `template` string into a tree of tokens. If the `tags`
   * argument is given here it must be an array with two string values: the
   * opening and closing tags used in the template (e.g. [ "<%", "%>" ]). Of
   * course, the default is to use mustaches (i.e. mustache.tags).
   *
   * A token is an array with at least 4 elements. The first element is the
   * mustache symbol that was used inside the tag, e.g. "#" or "&". If the tag
   * did not contain a symbol (i.e. {{myValue}}) this element is "name". For
   * all text that appears outside a symbol this element is "text".
   *
   * The second element of a token is its "value". For mustache tags this is
   * whatever else was inside the tag besides the opening symbol. For text tokens
   * this is the text itself.
   *
   * The third and fourth elements of the token are the start and end indices,
   * respectively, of the token in the original template.
   *
   * Tokens that are the root node of a subtree contain two more elements: 1) an
   * array of tokens in the subtree and 2) the index in the original template at
   * which the closing tag for that section begins.
   */
  function parseTemplate (template, tags) {
    if (!template)
      return [];

    var sections = [];     // Stack to hold section tokens
    var tokens = [];       // Buffer to hold the tokens
    var spaces = [];       // Indices of whitespace tokens on the current line
    var hasTag = false;    // Is there a {{tag}} on the current line?
    var nonSpace = false;  // Is there a non-space char on the current line?

    // Strips all whitespace tokens array for the current line
    // if there was a {{#tag}} on it and otherwise only space.
    function stripSpace () {
      if (hasTag && !nonSpace) {
        while (spaces.length)
          delete tokens[spaces.pop()];
      } else {
        spaces = [];
      }

      hasTag = false;
      nonSpace = false;
    }

    var openingTagRe, closingTagRe, closingCurlyRe;
    function compileTags (tagsToCompile) {
      if (typeof tagsToCompile === 'string')
        tagsToCompile = tagsToCompile.split(spaceRe, 2);

      if (!isArray(tagsToCompile) || tagsToCompile.length !== 2)
        throw new Error('Invalid tags: ' + tagsToCompile);

      openingTagRe = new RegExp(escapeRegExp(tagsToCompile[0]) + '\\s*');
      closingTagRe = new RegExp('\\s*' + escapeRegExp(tagsToCompile[1]));
      closingCurlyRe = new RegExp('\\s*' + escapeRegExp('}' + tagsToCompile[1]));
    }

    compileTags(tags || mustache.tags);

    var scanner = new Scanner(template);

    var start, type, value, chr, token, openSection;
    while (!scanner.eos()) {
      start = scanner.pos;

      // Match any text between tags.
      value = scanner.scanUntil(openingTagRe);

      if (value) {
        for (var i = 0, valueLength = value.length; i < valueLength; ++i) {
          chr = value.charAt(i);

          if (isWhitespace(chr)) {
            spaces.push(tokens.length);
          } else {
            nonSpace = true;
          }

          tokens.push([ 'text', chr, start, start + 1 ]);
          start += 1;

          // Check for whitespace on the current line.
          if (chr === '\n')
            stripSpace();
        }
      }

      // Match the opening tag.
      if (!scanner.scan(openingTagRe))
        break;

      hasTag = true;

      // Get the tag type.
      type = scanner.scan(tagRe) || 'name';
      scanner.scan(whiteRe);

      // Get the tag value.
      if (type === '=') {
        value = scanner.scanUntil(equalsRe);
        scanner.scan(equalsRe);
        scanner.scanUntil(closingTagRe);
      } else if (type === '{') {
        value = scanner.scanUntil(closingCurlyRe);
        scanner.scan(curlyRe);
        scanner.scanUntil(closingTagRe);
        type = '&';
      } else {
        value = scanner.scanUntil(closingTagRe);
      }

      // Match the closing tag.
      if (!scanner.scan(closingTagRe))
        throw new Error('Unclosed tag at ' + scanner.pos);

      token = [ type, value, start, scanner.pos ];
      tokens.push(token);

      if (type === '#' || type === '^') {
        sections.push(token);
      } else if (type === '/') {
        // Check section nesting.
        openSection = sections.pop();

        if (!openSection)
          throw new Error('Unopened section "' + value + '" at ' + start);

        if (openSection[1] !== value)
          throw new Error('Unclosed section "' + openSection[1] + '" at ' + start);
      } else if (type === 'name' || type === '{' || type === '&') {
        nonSpace = true;
      } else if (type === '=') {
        // Set the tags for the next time around.
        compileTags(value);
      }
    }

    // Make sure there are no open sections when we're done.
    openSection = sections.pop();

    if (openSection)
      throw new Error('Unclosed section "' + openSection[1] + '" at ' + scanner.pos);

    return nestTokens(squashTokens(tokens));
  }

  /**
   * Combines the values of consecutive text tokens in the given `tokens` array
   * to a single token.
   */
  function squashTokens (tokens) {
    var squashedTokens = [];

    var token, lastToken;
    for (var i = 0, numTokens = tokens.length; i < numTokens; ++i) {
      token = tokens[i];

      if (token) {
        if (token[0] === 'text' && lastToken && lastToken[0] === 'text') {
          lastToken[1] += token[1];
          lastToken[3] = token[3];
        } else {
          squashedTokens.push(token);
          lastToken = token;
        }
      }
    }

    return squashedTokens;
  }

  /**
   * Forms the given array of `tokens` into a nested tree structure where
   * tokens that represent a section have two additional items: 1) an array of
   * all tokens that appear in that section and 2) the index in the original
   * template that represents the end of that section.
   */
  function nestTokens (tokens) {
    var nestedTokens = [];
    var collector = nestedTokens;
    var sections = [];

    var token, section;
    for (var i = 0, numTokens = tokens.length; i < numTokens; ++i) {
      token = tokens[i];

      switch (token[0]) {
        case '#':
        case '^':
          collector.push(token);
          sections.push(token);
          collector = token[4] = [];
          break;
        case '/':
          section = sections.pop();
          section[5] = token[2];
          collector = sections.length > 0 ? sections[sections.length - 1][4] : nestedTokens;
          break;
        default:
          collector.push(token);
      }
    }

    return nestedTokens;
  }

  /**
   * A simple string scanner that is used by the template parser to find
   * tokens in template strings.
   */
  function Scanner (string) {
    this.string = string;
    this.tail = string;
    this.pos = 0;
  }

  /**
   * Returns `true` if the tail is empty (end of string).
   */
  Scanner.prototype.eos = function eos () {
    return this.tail === '';
  };

  /**
   * Tries to match the given regular expression at the current position.
   * Returns the matched text if it can match, the empty string otherwise.
   */
  Scanner.prototype.scan = function scan (re) {
    var match = this.tail.match(re);

    if (!match || match.index !== 0)
      return '';

    var string = match[0];

    this.tail = this.tail.substring(string.length);
    this.pos += string.length;

    return string;
  };

  /**
   * Skips all text until the given regular expression can be matched. Returns
   * the skipped string, which is the entire tail if no match can be made.
   */
  Scanner.prototype.scanUntil = function scanUntil (re) {
    var index = this.tail.search(re), match;

    switch (index) {
      case -1:
        match = this.tail;
        this.tail = '';
        break;
      case 0:
        match = '';
        break;
      default:
        match = this.tail.substring(0, index);
        this.tail = this.tail.substring(index);
    }

    this.pos += match.length;

    return match;
  };

  /**
   * Represents a rendering context by wrapping a view object and
   * maintaining a reference to the parent context.
   */
  function Context (view, parentContext) {
    this.view = view;
    this.cache = { '.': this.view };
    this.parent = parentContext;
  }

  /**
   * Creates a new context using the given view with this context
   * as the parent.
   */
  Context.prototype.push = function push (view) {
    return new Context(view, this);
  };

  /**
   * Returns the value of the given name in this context, traversing
   * up the context hierarchy if the value is absent in this context's view.
   */
  Context.prototype.lookup = function lookup (name) {
    var cache = this.cache;

    var value;
    if (cache.hasOwnProperty(name)) {
      value = cache[name];
    } else {
      var context = this, names, index, lookupHit = false;

      while (context) {
        if (name.indexOf('.') > 0) {
          value = context.view;
          names = name.split('.');
          index = 0;

          /**
           * Using the dot notion path in `name`, we descend through the
           * nested objects.
           *
           * To be certain that the lookup has been successful, we have to
           * check if the last object in the path actually has the property
           * we are looking for. We store the result in `lookupHit`.
           *
           * This is specially necessary for when the value has been set to
           * `undefined` and we want to avoid looking up parent contexts.
           **/
          while (value != null && index < names.length) {
            if (index === names.length - 1)
              lookupHit = hasProperty(value, names[index]);

            value = value[names[index++]];
          }
        } else {
          value = context.view[name];
          lookupHit = hasProperty(context.view, name);
        }

        if (lookupHit)
          break;

        context = context.parent;
      }

      cache[name] = value;
    }

    if (isFunction(value))
      value = value.call(this.view);

    return value;
  };

  /**
   * A Writer knows how to take a stream of tokens and render them to a
   * string, given a context. It also maintains a cache of templates to
   * avoid the need to parse the same template twice.
   */
  function Writer () {
    this.cache = {};
  }

  /**
   * Clears all cached templates in this writer.
   */
  Writer.prototype.clearCache = function clearCache () {
    this.cache = {};
  };

  /**
   * Parses and caches the given `template` and returns the array of tokens
   * that is generated from the parse.
   */
  Writer.prototype.parse = function parse (template, tags) {
    var cache = this.cache;
    var tokens = cache[template];

    if (tokens == null)
      tokens = cache[template] = parseTemplate(template, tags);

    return tokens;
  };

  /**
   * High-level method that is used to render the given `template` with
   * the given `view`.
   *
   * The optional `partials` argument may be an object that contains the
   * names and templates of partials that are used in the template. It may
   * also be a function that is used to load partial templates on the fly
   * that takes a single argument: the name of the partial.
   */
  Writer.prototype.render = function render (template, view, partials) {
    var tokens = this.parse(template);
    var context = (view instanceof Context) ? view : new Context(view);
    return this.renderTokens(tokens, context, partials, template);
  };

  /**
   * Low-level method that renders the given array of `tokens` using
   * the given `context` and `partials`.
   *
   * Note: The `originalTemplate` is only ever used to extract the portion
   * of the original template that was contained in a higher-order section.
   * If the template doesn't use higher-order sections, this argument may
   * be omitted.
   */
  Writer.prototype.renderTokens = function renderTokens (tokens, context, partials, originalTemplate) {
    var buffer = '';

    var token, symbol, value;
    for (var i = 0, numTokens = tokens.length; i < numTokens; ++i) {
      value = undefined;
      token = tokens[i];
      symbol = token[0];

      if (symbol === '#') value = this.renderSection(token, context, partials, originalTemplate);
      else if (symbol === '^') value = this.renderInverted(token, context, partials, originalTemplate);
      else if (symbol === '>') value = this.renderPartial(token, context, partials, originalTemplate);
      else if (symbol === '&') value = this.unescapedValue(token, context);
      else if (symbol === 'name') value = this.escapedValue(token, context);
      else if (symbol === 'text') value = this.rawValue(token);

      if (value !== undefined)
        buffer += value;
    }

    return buffer;
  };

  Writer.prototype.renderSection = function renderSection (token, context, partials, originalTemplate) {
    var self = this;
    var buffer = '';
    var value = context.lookup(token[1]);

    // This function is used to render an arbitrary template
    // in the current context by higher-order sections.
    function subRender (template) {
      return self.render(template, context, partials);
    }

    if (!value) return;

    if (isArray(value)) {
      for (var j = 0, valueLength = value.length; j < valueLength; ++j) {
        buffer += this.renderTokens(token[4], context.push(value[j]), partials, originalTemplate);
      }
    } else if (typeof value === 'object' || typeof value === 'string' || typeof value === 'number') {
      buffer += this.renderTokens(token[4], context.push(value), partials, originalTemplate);
    } else if (isFunction(value)) {
      if (typeof originalTemplate !== 'string')
        throw new Error('Cannot use higher-order sections without the original template');

      // Extract the portion of the original template that the section contains.
      value = value.call(context.view, originalTemplate.slice(token[3], token[5]), subRender);

      if (value != null)
        buffer += value;
    } else {
      buffer += this.renderTokens(token[4], context, partials, originalTemplate);
    }
    return buffer;
  };

  Writer.prototype.renderInverted = function renderInverted (token, context, partials, originalTemplate) {
    var value = context.lookup(token[1]);

    // Use JavaScript's definition of falsy. Include empty arrays.
    // See https://github.com/janl/mustache.js/issues/186
    if (!value || (isArray(value) && value.length === 0))
      return this.renderTokens(token[4], context, partials, originalTemplate);
  };

  Writer.prototype.renderPartial = function renderPartial (token, context, partials) {
    if (!partials) return;

    var value = isFunction(partials) ? partials(token[1]) : partials[token[1]];
    if (value != null)
      return this.renderTokens(this.parse(value), context, partials, value);
  };

  Writer.prototype.unescapedValue = function unescapedValue (token, context) {
    var value = context.lookup(token[1]);
    if (value != null)
      return value;
  };

  Writer.prototype.escapedValue = function escapedValue (token, context) {
    var value = context.lookup(token[1]);
    if (value != null)
      return mustache.escape(value);
  };

  Writer.prototype.rawValue = function rawValue (token) {
    return token[1];
  };

  mustache.name = 'mustache.js';
  mustache.version = '2.3.2';
  mustache.tags = [ '{{', '}}' ];

  // All high-level mustache.* functions use this writer.
  var defaultWriter = new Writer();

  /**
   * Clears all cached templates in the default writer.
   */
  mustache.clearCache = function clearCache () {
    return defaultWriter.clearCache();
  };

  /**
   * Parses and caches the given template in the default writer and returns the
   * array of tokens it contains. Doing this ahead of time avoids the need to
   * parse templates on the fly as they are rendered.
   */
  mustache.parse = function parse (template, tags) {
    return defaultWriter.parse(template, tags);
  };

  /**
   * Renders the `template` with the given `view` and `partials` using the
   * default writer.
   */
  mustache.render = function render (template, view, partials) {
    if (typeof template !== 'string') {
      throw new TypeError('Invalid template! Template should be a "string" ' +
                          'but "' + typeStr(template) + '" was given as the first ' +
                          'argument for mustache#render(template, view, partials)');
    }

    return defaultWriter.render(template, view, partials);
  };

  // This is here for backwards compatibility with 0.4.x.,
  /*eslint-disable */ // eslint wants camel cased function name
  mustache.to_html = function to_html (template, view, partials, send) {
    /*eslint-enable*/

    var result = mustache.render(template, view, partials);

    if (isFunction(send)) {
      send(result);
    } else {
      return result;
    }
  };

  // Export the escaping function so that the user may override it.
  // See https://github.com/janl/mustache.js/issues/244
  mustache.escape = escapeHtml;

  // Export these mainly for testing, but also for advanced usage.
  mustache.Scanner = Scanner;
  mustache.Context = Context;
  mustache.Writer = Writer;

  return mustache;
}));

/**
 * @license text 2.0.16 Copyright jQuery Foundation and other contributors.
 * Released under MIT license, http://github.com/requirejs/text/LICENSE
 */
/*jslint regexp: true */
/*global require, XMLHttpRequest, ActiveXObject,
  define, window, process, Packages,
  java, location, Components, FileUtils */

define('text',['module'], function (module) {
    'use strict';

    var text, fs, Cc, Ci, xpcIsWindows,
        progIds = ['Msxml2.XMLHTTP', 'Microsoft.XMLHTTP', 'Msxml2.XMLHTTP.4.0'],
        xmlRegExp = /^\s*<\?xml(\s)+version=[\'\"](\d)*.(\d)*[\'\"](\s)*\?>/im,
        bodyRegExp = /<body[^>]*>\s*([\s\S]+)\s*<\/body>/im,
        hasLocation = typeof location !== 'undefined' && location.href,
        defaultProtocol = hasLocation && location.protocol && location.protocol.replace(/\:/, ''),
        defaultHostName = hasLocation && location.hostname,
        defaultPort = hasLocation && (location.port || undefined),
        buildMap = {},
        masterConfig = (module.config && module.config()) || {};

    function useDefault(value, defaultValue) {
        return value === undefined || value === '' ? defaultValue : value;
    }

    //Allow for default ports for http and https.
    function isSamePort(protocol1, port1, protocol2, port2) {
        if (port1 === port2) {
            return true;
        } else if (protocol1 === protocol2) {
            if (protocol1 === 'http') {
                return useDefault(port1, '80') === useDefault(port2, '80');
            } else if (protocol1 === 'https') {
                return useDefault(port1, '443') === useDefault(port2, '443');
            }
        }
        return false;
    }

    text = {
        version: '2.0.16',

        strip: function (content) {
            //Strips <?xml ...?> declarations so that external SVG and XML
            //documents can be added to a document without worry. Also, if the string
            //is an HTML document, only the part inside the body tag is returned.
            if (content) {
                content = content.replace(xmlRegExp, "");
                var matches = content.match(bodyRegExp);
                if (matches) {
                    content = matches[1];
                }
            } else {
                content = "";
            }
            return content;
        },

        jsEscape: function (content) {
            return content.replace(/(['\\])/g, '\\$1')
                .replace(/[\f]/g, "\\f")
                .replace(/[\b]/g, "\\b")
                .replace(/[\n]/g, "\\n")
                .replace(/[\t]/g, "\\t")
                .replace(/[\r]/g, "\\r")
                .replace(/[\u2028]/g, "\\u2028")
                .replace(/[\u2029]/g, "\\u2029");
        },

        createXhr: masterConfig.createXhr || function () {
            //Would love to dump the ActiveX crap in here. Need IE 6 to die first.
            var xhr, i, progId;
            if (typeof XMLHttpRequest !== "undefined") {
                return new XMLHttpRequest();
            } else if (typeof ActiveXObject !== "undefined") {
                for (i = 0; i < 3; i += 1) {
                    progId = progIds[i];
                    try {
                        xhr = new ActiveXObject(progId);
                    } catch (e) {}

                    if (xhr) {
                        progIds = [progId];  // so faster next time
                        break;
                    }
                }
            }

            return xhr;
        },

        /**
         * Parses a resource name into its component parts. Resource names
         * look like: module/name.ext!strip, where the !strip part is
         * optional.
         * @param {String} name the resource name
         * @returns {Object} with properties "moduleName", "ext" and "strip"
         * where strip is a boolean.
         */
        parseName: function (name) {
            var modName, ext, temp,
                strip = false,
                index = name.lastIndexOf("."),
                isRelative = name.indexOf('./') === 0 ||
                             name.indexOf('../') === 0;

            if (index !== -1 && (!isRelative || index > 1)) {
                modName = name.substring(0, index);
                ext = name.substring(index + 1);
            } else {
                modName = name;
            }

            temp = ext || modName;
            index = temp.indexOf("!");
            if (index !== -1) {
                //Pull off the strip arg.
                strip = temp.substring(index + 1) === "strip";
                temp = temp.substring(0, index);
                if (ext) {
                    ext = temp;
                } else {
                    modName = temp;
                }
            }

            return {
                moduleName: modName,
                ext: ext,
                strip: strip
            };
        },

        xdRegExp: /^((\w+)\:)?\/\/([^\/\\]+)/,

        /**
         * Is an URL on another domain. Only works for browser use, returns
         * false in non-browser environments. Only used to know if an
         * optimized .js version of a text resource should be loaded
         * instead.
         * @param {String} url
         * @returns Boolean
         */
        useXhr: function (url, protocol, hostname, port) {
            var uProtocol, uHostName, uPort,
                match = text.xdRegExp.exec(url);
            if (!match) {
                return true;
            }
            uProtocol = match[2];
            uHostName = match[3];

            uHostName = uHostName.split(':');
            uPort = uHostName[1];
            uHostName = uHostName[0];

            return (!uProtocol || uProtocol === protocol) &&
                   (!uHostName || uHostName.toLowerCase() === hostname.toLowerCase()) &&
                   ((!uPort && !uHostName) || isSamePort(uProtocol, uPort, protocol, port));
        },

        finishLoad: function (name, strip, content, onLoad) {
            content = strip ? text.strip(content) : content;
            if (masterConfig.isBuild) {
                buildMap[name] = content;
            }
            onLoad(content);
        },

        load: function (name, req, onLoad, config) {
            //Name has format: some.module.filext!strip
            //The strip part is optional.
            //if strip is present, then that means only get the string contents
            //inside a body tag in an HTML string. For XML/SVG content it means
            //removing the <?xml ...?> declarations so the content can be inserted
            //into the current doc without problems.

            // Do not bother with the work if a build and text will
            // not be inlined.
            if (config && config.isBuild && !config.inlineText) {
                onLoad();
                return;
            }

            masterConfig.isBuild = config && config.isBuild;

            var parsed = text.parseName(name),
                nonStripName = parsed.moduleName +
                    (parsed.ext ? '.' + parsed.ext : ''),
                url = req.toUrl(nonStripName),
                useXhr = (masterConfig.useXhr) ||
                         text.useXhr;

            // Do not load if it is an empty: url
            if (url.indexOf('empty:') === 0) {
                onLoad();
                return;
            }

            //Load the text. Use XHR if possible and in a browser.
            if (!hasLocation || useXhr(url, defaultProtocol, defaultHostName, defaultPort)) {
                text.get(url, function (content) {
                    text.finishLoad(name, parsed.strip, content, onLoad);
                }, function (err) {
                    if (onLoad.error) {
                        onLoad.error(err);
                    }
                });
            } else {
                //Need to fetch the resource across domains. Assume
                //the resource has been optimized into a JS module. Fetch
                //by the module name + extension, but do not include the
                //!strip part to avoid file system issues.
                req([nonStripName], function (content) {
                    text.finishLoad(parsed.moduleName + '.' + parsed.ext,
                                    parsed.strip, content, onLoad);
                }, function (err) {
                    if (onLoad.error) {
                        onLoad.error(err);
                    }
                });
            }
        },

        write: function (pluginName, moduleName, write, config) {
            if (buildMap.hasOwnProperty(moduleName)) {
                var content = text.jsEscape(buildMap[moduleName]);
                write.asModule(pluginName + "!" + moduleName,
                               "define(function () { return '" +
                                   content +
                               "';});\n");
            }
        },

        writeFile: function (pluginName, moduleName, req, write, config) {
            var parsed = text.parseName(moduleName),
                extPart = parsed.ext ? '.' + parsed.ext : '',
                nonStripName = parsed.moduleName + extPart,
                //Use a '.js' file name so that it indicates it is a
                //script that can be loaded across domains.
                fileName = req.toUrl(parsed.moduleName + extPart) + '.js';

            //Leverage own load() method to load plugin value, but only
            //write out values that do not have the strip argument,
            //to avoid any potential issues with ! in file names.
            text.load(nonStripName, req, function (value) {
                //Use own write() method to construct full module value.
                //But need to create shell that translates writeFile's
                //write() to the right interface.
                var textWrite = function (contents) {
                    return write(fileName, contents);
                };
                textWrite.asModule = function (moduleName, contents) {
                    return write.asModule(moduleName, fileName, contents);
                };

                text.write(pluginName, nonStripName, textWrite, config);
            }, config);
        }
    };

    if (masterConfig.env === 'node' || (!masterConfig.env &&
            typeof process !== "undefined" &&
            process.versions &&
            !!process.versions.node &&
            !process.versions['node-webkit'] &&
            !process.versions['atom-shell'])) {
        //Using special require.nodeRequire, something added by r.js.
        fs = require.nodeRequire('fs');

        text.get = function (url, callback, errback) {
            try {
                var file = fs.readFileSync(url, 'utf8');
                //Remove BOM (Byte Mark Order) from utf8 files if it is there.
                if (file[0] === '\uFEFF') {
                    file = file.substring(1);
                }
                callback(file);
            } catch (e) {
                if (errback) {
                    errback(e);
                }
            }
        };
    } else if (masterConfig.env === 'xhr' || (!masterConfig.env &&
            text.createXhr())) {
        text.get = function (url, callback, errback, headers) {
            var xhr = text.createXhr(), header;
            xhr.open('GET', url, true);

            //Allow plugins direct access to xhr headers
            if (headers) {
                for (header in headers) {
                    if (headers.hasOwnProperty(header)) {
                        xhr.setRequestHeader(header.toLowerCase(), headers[header]);
                    }
                }
            }

            //Allow overrides specified in config
            if (masterConfig.onXhr) {
                masterConfig.onXhr(xhr, url);
            }

            xhr.onreadystatechange = function (evt) {
                var status, err;
                //Do not explicitly handle errors, those should be
                //visible via console output in the browser.
                if (xhr.readyState === 4) {
                    status = xhr.status || 0;
                    if (status > 399 && status < 600) {
                        //An http 4xx or 5xx error. Signal an error.
                        err = new Error(url + ' HTTP status: ' + status);
                        err.xhr = xhr;
                        if (errback) {
                            errback(err);
                        }
                    } else {
                        callback(xhr.responseText);
                    }

                    if (masterConfig.onXhrComplete) {
                        masterConfig.onXhrComplete(xhr, url);
                    }
                }
            };
            xhr.send(null);
        };
    } else if (masterConfig.env === 'rhino' || (!masterConfig.env &&
            typeof Packages !== 'undefined' && typeof java !== 'undefined')) {
        //Why Java, why is this so awkward?
        text.get = function (url, callback) {
            var stringBuffer, line,
                encoding = "utf-8",
                file = new java.io.File(url),
                lineSeparator = java.lang.System.getProperty("line.separator"),
                input = new java.io.BufferedReader(new java.io.InputStreamReader(new java.io.FileInputStream(file), encoding)),
                content = '';
            try {
                stringBuffer = new java.lang.StringBuffer();
                line = input.readLine();

                // Byte Order Mark (BOM) - The Unicode Standard, version 3.0, page 324
                // http://www.unicode.org/faq/utf_bom.html

                // Note that when we use utf-8, the BOM should appear as "EF BB BF", but it doesn't due to this bug in the JDK:
                // http://bugs.sun.com/bugdatabase/view_bug.do?bug_id=4508058
                if (line && line.length() && line.charAt(0) === 0xfeff) {
                    // Eat the BOM, since we've already found the encoding on this file,
                    // and we plan to concatenating this buffer with others; the BOM should
                    // only appear at the top of a file.
                    line = line.substring(1);
                }

                if (line !== null) {
                    stringBuffer.append(line);
                }

                while ((line = input.readLine()) !== null) {
                    stringBuffer.append(lineSeparator);
                    stringBuffer.append(line);
                }
                //Make sure we return a JavaScript string and not a Java string.
                content = String(stringBuffer.toString()); //String
            } finally {
                input.close();
            }
            callback(content);
        };
    } else if (masterConfig.env === 'xpconnect' || (!masterConfig.env &&
            typeof Components !== 'undefined' && Components.classes &&
            Components.interfaces)) {
        //Avert your gaze!
        Cc = Components.classes;
        Ci = Components.interfaces;
        Components.utils['import']('resource://gre/modules/FileUtils.jsm');
        xpcIsWindows = ('@mozilla.org/windows-registry-key;1' in Cc);

        text.get = function (url, callback) {
            var inStream, convertStream, fileObj,
                readData = {};

            if (xpcIsWindows) {
                url = url.replace(/\//g, '\\');
            }

            fileObj = new FileUtils.File(url);

            //XPCOM, you so crazy
            try {
                inStream = Cc['@mozilla.org/network/file-input-stream;1']
                           .createInstance(Ci.nsIFileInputStream);
                inStream.init(fileObj, 1, 0, false);

                convertStream = Cc['@mozilla.org/intl/converter-input-stream;1']
                                .createInstance(Ci.nsIConverterInputStream);
                convertStream.init(inStream, "utf-8", inStream.available(),
                Ci.nsIConverterInputStream.DEFAULT_REPLACEMENT_CHARACTER);

                convertStream.readString(inStream.available(), readData);
                convertStream.close();
                inStream.close();
                callback(readData.value);
            } catch (e) {
                throw new Error((fileObj && fileObj.path || '') + ': ' + e);
            }
        };
    }
    return text;
});


define('text!lib/helpers/overlay/template.html',[],function () { return '<div class="x-overlay">\n\t<div class="x-body">\n\t\t<div class="x-content"></div>\n\t\t<div class="x-close{{^closable}} hidden{{/closable}}" title="{{{ close_title }}}">{{{ icon }}}</div>\n\t</div>\n</div>';});

define('lib/i18n',[], function () {
	
	return {
		
		version: '1.0.0',
		
		/**
		 * Called when a dependency needs to be loaded.
		 */
		load: function (name, req, onLoad, config) {
			if (config.isBuild) {
				onLoad();
			} else {
				require(['lib/i18n/translator'], function(i18n) {
					i18n.getCatalog(name, function (catalog) {
						onLoad(catalog);
					});
				});
			}
		}
		
	};
	
});


define('lib/helpers/overlay',[
	'mustache',
	'text!./overlay/template.html',
	'lib/i18n!front'
], function(Mustache, tpl, i18n) {
	
	var overlay = function(contener, closable, close_action) {
		this.open = false;
		this.closable = !!closable;
		this.esc_close = false;
		this.esc_close_handler = null;
		this.click_close_handler = null;
		this.setCloseAction(close_action);
		
		var icon = '&times;';
		
		this.parent = $(contener).css('position', 'relative');
		this.node = $(Mustache.render(tpl, { closable: closable, close_title: i18n.__('misc.close'), icon: icon }));
		this.body = this.node.children('.x-body');
		
		var self = this;
		this.close_node = this.body.children('.x-close').on('click', function() { self.close_action === 'close' ? self.close() : self.hide(); });
		this.container = this.body.children('.x-content');
	};
	
	overlay.get = function(contener, closable, close_action) {
		return new overlay(contener, closable, close_action);
	};
	
	overlay.prototype = {
		
		onShow: null,
		
		onHide: null,
		
		onClose: null,
		
		getNode: function() {
			return this.node;
		},
		
		getContainer: function() {
			return this.container;
		},
		
		addClass: function(cls) {
			this.node.addClass(cls);
			return this;
		},
		
		setClosable: function(closable, close_on_escape, popbody_click_dontclose) {
			this.closable = !!closable;
			this.esc_close = closable && close_on_escape;
			this.popbody_click_dontclose = closable && !!popbody_click_dontclose;
			if(this.closable) {
				this.close_node.removeClass('hidden');
			} else {
				this.close_node.addClass('hidden');
			}
			if (this.esc_close) {
				if (!this.esc_close_handler) {
					$('body')
						.on('keyup.overlay', this.onKeyUpBody.bind(this))
						.on('click.overlay', this.onClickBody.bind(this));
				}
			} else if (this.esc_close_handler) {
				$('body').off('.overlay');
			}
			return this;
		},

		onClickBody: function(event) {
			var prevented = event.originalEvent && event.originalEvent.defaultPrevented;
			if (!prevented && this.open && $(event.target).closest(this.popbody_click_dontclose ? this.body : this.container).length === 0) {
				this.close_action === 'close' ? this.close() : this.hide();
			}
		},

		onKeyUpBody: function(event) {
			var prevented = event.originalEvent && event.originalEvent.defaultPrevented;
			if (!prevented && this.open && event.which === 27) {
				this.close_action === 'close' ? this.close() : this.hide();
			}
		},
		
		setCloseAction: function(action) {
			this.close_action = action === 'hide' ? 'hide' : 'close';
		},
		
		setText: function(text) {
			this.container.text(text);
			return this;
		},
		
		setContent: function(content) {
			var contentIsNodeElement = (content.nodeType !== 'undefined' && typeof content.nodeType === 'number' && content.nodeType === 1);
			if (contentIsNodeElement) {
				content = $(content)
			}

			this.container.html(content);
			return this;
		},
		
		empty: function() {
			this.container.empty();
			return this;
		},
		
		append: function(content) {
			this.container.append(content);
			return this;
		},
		
		prepend: function(content) {
			this.container.prepend(content);
			return this;
		},
		
		show: function() {
			if(this.open) {
				return;
			}
			this.node.appendTo(this.parent);
			this.open = true;
			if (this.onShow) {
				this.onShow();
			}
			return this;
		},
		
		hide: function() {
			if(!this.open) {
				return;
			}
			this.node.detach();
			this.open = false;
			if (this.onHide) {
				this.onHide();
			}
			return this;
		},
		
		close: function() {
			if(!this.open) {
				return;
			}
			this.node.remove();
			this.open = false;
			if (this.onClose) {
				this.onClose();
			}
		},
		
		autoclose: function(timeout) {
			if(!this.open) {
				return;
			}
			var self = this;
			window.setTimeout(function() { self.close(); }, timeout);
		},
		
		isOpen: function() {
			return !!this.open;
		}
		
	};
	
	return overlay;
	
});

define('text!window_error.mustache',[],function () { return '<div id="chat-window" class="{{#window_class}}{{window_class}}{{/window_class}}">\n\t<div class="overlay-container">\n\t\t<h3 class="chat-title">\n\t\t\t<div class="close"><div>_</div></div>\n\t\t\t<div class="chat-icon"><span class="icon-f icf-comments-o">&nbsp;</span></div>\n\t\t\t<span class="chat-title-text">{{{ trad.xvideos_chat }}}</span>\n\t\t</h3>\n\t\t<div class="row">\n\t\t</div>\n\t</div>\n</div>';});

define('lib/socket_queue_manager',[], function () {
	
	/**
	 * SocketQueueManager manage a queue for a single socket event.
	 *
	 * @param socket A socket.io instance
	 * @param eventName A socket event name
	 * @param intervalMs (optional) The time in milliseconds between each attempt to emit the event. Default: 100 ms.
	 * @constructor
	 */
	function SocketQueueManager(socket, eventName, intervalMs) {
		if (typeof socket == 'undefined' || typeof socket.emit != 'function') {
			wglog.debug('SocketQueueManager', 'Invalid or missing socket argument');
			return;
		}
		if (typeof eventName == 'undefined' || typeof eventName != 'string') {
			wglog.debug('SocketQueueManager', 'Invalid or missing eventName argument');
			return;
		}
		if (typeof intervalMs != 'undefined' && typeof intervalMs != 'number') {
			wglog.debug('SocketQueueManager', 'Invalid intervalMs argument');
			return;
		}
		
		this.queue = new Map();
		this.socket = socket;
		this.eventName = eventName;
		
		setInterval(this.process.bind(this), intervalMs || 100);
	}
	
	/**
	 * Set a new item to the queue.
	 *
	 * @param key The key. It can be a friend ID or something else.
	 * @param params Params to send with the event.
	 */
	SocketQueueManager.prototype.set = function (key, params) {
		this.queue.set(key, params);
	}
	
	/**
	 * Process the next item in the queue.
	 */
	SocketQueueManager.prototype.process = function () {
		let firstKey = this.queue.keys().next();
		if (firstKey && firstKey.value) {
			let params = this.queue.get(firstKey.value);
			
			this.socket.emit(this.eventName, params);
			this.queue.delete(firstKey.value);
		}
	}
	
	return SocketQueueManager;
});
define('lib/emoji',[], function () {
	return {
		utf8ToHtml: function (message) {
			if (typeof message === "undefined" || typeof emojione === "undefined" || !(!!message) || !(!!emojione)) {
				return message;
			}
			
			var message_smiley = emojione.toImage(message);
			var test_message = $.parseHTML(message_smiley);
			
			if (test_message.length === 1 && test_message[0].nodeName === "SPAN") {
				var message_span_smiley = $(test_message[0]);
				message_span_smiley.addClass("emoji-only");
				
				if ( typeof message_span_smiley[0] != "undefined" && typeof message_span_smiley[0].outerHTML != "undefined" ) {
					message_smiley = message_span_smiley[0].outerHTML;
				}
			}
			
			return message_smiley;
		},
		
		htmlToUtf8: function (messageHtml) {
			var $content = $('<div>').html(messageHtml);
			
			$content.find('img.emojione').each(function () {
				$(this).replaceWith(this.alt);
			});
			
			return $content.html();
		}
		
	};
	
});

define('lib/utils',[
	'config/chat',
	'lib/storage'
], function(conf, storage) {
	
	var utils = {};
	
	utils.createRequestObject = function () {
		var xhr;
		try {
			xhr = new XMLHttpRequest();
		} catch (e) {
			xhr = new ActiveXObject("Microsoft.XMLHTTP");
		}
		return xhr;
	};
	
	utils.loadScript = function (scripts, attrs, events, data) {
		var head = document.getElementsByTagName('head')[0], tag;
		if (typeof (scripts) === 'string') {
			scripts = [scripts];
		}
		for (var s in scripts) {
			tag = document.createElement('script');
			tag.type = 'text/javascript';
			if (typeof (attrs) === 'object') {
				for (var attr in attrs) {
					if (attrs.hasOwnProperty(attr)) {
						tag[attr] = attrs[attr];
					}
				}
			}
			if (typeof (events) === 'object') {
				for (var event in events) {
					if (events.hasOwnProperty(event)) {
						xv.dom.addEventListener(tag, event, events[event]);
					}
				}
			}
			if (typeof (data) === 'object') {
				for (var d in data) {
					if (data.hasOwnProperty(d)) {
						tag.dataset[d] = data[d];
					}
				}
			}
			head.appendChild(tag);
			tag.src = scripts[s];
		}
	};
	
	var static_domain;
	
	utils.getStaticDomain = function () {
		if (typeof (static_domain) === 'string') {
			return static_domain;
		}
		if (typeof (conf) === 'object' && conf.domains && conf.domains.static) {
			static_domain = conf.domains.static;
		} else {
			var cdn = 'ss',
				pos = (' ' + document.cookie).indexOf(' static_cdn=');
			if (pos !== -1) {
				cdn = (' ' + document.cookie).substr(pos + 16, 2);
			}
			static_domain = window.location.protocol + '//static-' + cdn + '.xvideos-cdn.com';
		}
		return static_domain;
	};

	utils.sanitize_filename = function(filename) {
		return filename.replaceAll(/[\/<>"'= ]/g, "_");
	};

    utils.normalizeCharactersOld = function (input) {
        var s = String(input);
        var from = "";
        var to   = "aaaaaaceeeeiiiinooooouuuuyy";

        for (var i = 0; i < from.length; i++) {
            s = s.replace(new RegExp(from.charAt(i), 'g'), to.charAt(i));
        }

        return s;
    }

    utils.sanitizeId = function (input) {
        var MAX_LEN = 64;

        if (input == null) input = '';
        var s = String(input);

        if (typeof String.prototype.normalize === 'function') {
            try {
                s = s.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            } catch (e) {
                s = utils.normalizeCharactersOld(s);
            }
        } else {
            s = utils.normalizeCharactersOld(s);
        }

        s = s.toLowerCase();

        s = s.replace(/[^a-z0-9_-]+/g, '-');

        s = s.replace(/-+/g, '-');

        s = s.replace(/^-|-$/g, '');

        if (!s) s = 'id';

        if (s.length > MAX_LEN) {
            s = s.slice(0, MAX_LEN).replace(/-+$/g, '');
        }

        return s || 'id';
    }
	
	utils.escape = function (input, escape_quotes) {
		var e = document.createElement('div');
		e.appendChild(document.createTextNode(input));
		if (escape_quotes) {
			return e.innerHTML.replace(/"/g, "&quot;").replace(/'/g, "&apos;");
		}
		return e.innerHTML;
	};

	utils.escapeHtml = function(htmlString) {
		return $('<textarea />').text(htmlString).html();
	};

	utils.unescape = function (input) {
		try {
			var doc = new DOMParser().parseFromString(input, "text/html");
			return doc.documentElement.textContent;
		} catch (e) {
			try {
				return unescape(input);
			} catch (e2) {
				return 'Error';
			}
		}
	};

	utils.unescapeHtml = function(htmlString) {
		htmlString = htmlString.replace(/&/g, '&amp;').replace(/>/g, '&gt;').replace(/</g, '&lt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
		var doc = new DOMParser().parseFromString(htmlString, "text/html");
		return doc.documentElement.textContent;
	};

	utils.decodeHTMLEntities = function (str) {
		const textarea = document.createElement("textarea");
		textarea.innerHTML = str;
		return textarea.value;
	}


	utils.indexOf = function (arr, obj, start) {
		if (Array.prototype.indexOf) {
			return arr.indexOf(obj, (start || 0));
		}
		for (var i = (start || 0), j = arr.length; i < j; i++) {
			if (arr[i] === obj) {
				return i;
			}
		}
		return -1;
	};
	
	utils.inArray = function (arr, obj) {
		for (var i = 0, j = arr.length; i < j; i++) {
			if (arr[i] === obj) {
				return true;
			}
		}
		return false;
	};
	
	utils.arraySum = function (arr) {
		var sum = 0;
		for (var i = 0, j = arr.length; i < j; i++) {
			sum += arr[i];
		}
		
		return sum;
	};
	
	utils.objLength = function (obj) {
		var nb_elt = 0;
		for (var i in obj) {
			if (typeof obj[i] == "undefined") {
				continue;
			}
			nb_elt++;
		}
		return nb_elt;
	};
	
	
	var bIsTouch = null;
	
	utils.isTouchScreen = function () {
		if (bIsTouch === null) {
			bIsTouch = /iPad|iPhone|iPod|Android/.test(navigator.userAgent);
		}
		return bIsTouch;
	};
	
	var is_first_page = storage.get('nb_tabs_opened', 'xvutils') <= 0;
	
	if (window.addEventListener) {
		storage.set('nb_tabs_opened', storage.get('nb_tabs_opened', 'xvutils') + 1, 'xvutils');
		window.addEventListener('beforeunload', function () {
			storage.set('nb_tabs_opened', Math.max(storage.get('nb_tabs_opened', 'xvutils') - 1, 0), 'xvutils');
		});
		window.addEventListener('touchstart', function () {
			bIsTouch = true;
		});
	}
	
	utils.getNbTabsOpened = function () {
		return storage.get('nb_tabs_opened', 'xvutils') + 0;
	};
	
	utils.isFirstPage = function () {
		return is_first_page;
	};
	
	/**
	 * returns the site ID, only works with XV and XNXX for now (02/2020)
	 * @returns {number} default : 0
	 */
	utils.getSiteId = function () {
		return !conf ? 0 : (conf.sitename === 'default' ? 1 : (conf.sitename === 'xnxx' ? 2 : 0));
	};
	
	utils.contextual_popup = {
		alert: function (sMessage, fOK, bClosable, oOptions) {
			sMessage = $('<div>' + sMessage + '</div>').text();
			alert(sMessage);
			if (typeof fOK === 'function') {
				fOK();
			}
		},
		
		confirm: function (sMessage, fOK, fNO, bClosable, oOptions) {
			sMessage = $('<div>' + sMessage + '</div>').text();
			if (confirm(sMessage)) {
				if (typeof fOK === 'function') {
					fOK();
				}
			} else {
				if (typeof fNO === 'function') {
					fNO();
				}
			}
		},
		
		loading: function (sMessage, oOptions) {
			sMessage = $('<div>' + sMessage + '</div>').text();
		}
	};
	
	return utils;
	
});
define('lib/tools',[
	'lib/utils',
	'lib/i18n!front'
], function (utils, i18n) {
	
	var tools = {
		pendingPrepare: []
	};
	
	tools.encloseTextWithTag = function (text, tag) {
		if (typeof (text) === 'string' && (text.length === 0 || text[0] !== '<')) {
			return '<' + tag + '>' + text + '</' + tag + '>';
		}
		return text;
	};
	
	tools.parseUrl = function (url, part, parse_query) {
		var parsed = {
			body: null,
			query: null,
			hash: null
		};
		var parts = url.split('#');
		if (parts.length === 2) {
			if (part === 'hash') {
				return parts[1];
			}
			parsed.hash = parts[1];
		}
		if (part === 'hash') {
			return null;
		}
		url = parts[0];
		parts = url.split('?');
		if (parts.length === 2) {
			parsed.query = parts[1];
		}
		parsed.body = parts[0];
		if (typeof parse_query !== "undefined" && parse_query) {
			var q = parsed.query;
			parsed.query = {};
			if (q) {
				var q_parts = q.split('&');
				for (var i = 0; i < q_parts.length; i++) {
					var keyval = q_parts[i];
					if (keyval.length) {
						var p = keyval.split('=');
						parsed.query[p.shift()] = p.join('=');
					}
				}
			}
		}
		if (typeof (part) === "undefined" || !part || typeof (parsed[part]) === "undefined") {
			return parsed;
		}
		return parsed[part];
	};
	
	/**
	 * @param url {string}
	 * @param param {string}
	 * @param value {string|boolean} false to delete parameter
	 */
	tools.addUrlParam = function (url, param, value) {
		var query = tools.parseUrl(url, false, true);
		param = param.toString();
		if (typeof value === "undefined" || value === false) {
			if (typeof query.query[param] !== "undefined") {
				delete query.query[param];
			}
		} else {
			query.query[param] = value.toString();
		}
		var params = '';
		for (var p in query.query) {
			params += (params === '' ? '?' : '&') + p + "=" + query.query[p];
		}
		return query.body + params;
	};
	
	tools.getUrlHash = function () {
		return window.location.hash.substr(1);
	};
	
	tools.setUrlHash = function (hash, replaceHistoryState) {
		// When set to true: avoid creating a new history state.
		replaceHistoryState = replaceHistoryState || false;
		
		if (hash.substr(0, 1) !== '#') {
			hash = '#' + hash;
		}
		if (hash !== window.location.hash) {
			if (replaceHistoryState) {
				history.replaceState(undefined, undefined, hash);
			} else {
				window.location.hash = hash;
			}
		}
	};
	
	tools.isEmpty = function (val) {
		var type = typeof (val);
		if (type === 'undefined' || val === null || val === 0 || val === false) {
			return true;
		}
		if (type === 'string' && $.trim(val).length === 0) {
			return true;
		}
		if (type === 'object') {
			if (typeof (val.length) === 'number') {
				return val.length === 0;
			}
			if (typeof (Object) === 'function' && typeof (Object.keys) === 'function') {
				return Object.keys(val).length === 0;
			}
			var count = 0;
			for (var key in val) {
				if (val.hasOwnProperty(key)) {
					count++;
				}
			}
			return count === 0;
		}
		return false;
	};
	
	tools.pad = function (string, pad_length, pad_string, pad_type) {
		if (typeof (pad_type) === "undefined" || pad_type !== "left") {
			pad_type = "right";
		}
		var str = '' + string;
		while (str.length < pad_length) {
			if (pad_type === "left") {
				str = pad_string + str;
			} else {
				str += pad_string;
			}
		}
		return str;
	};
	
	tools.ucfirst = function (str) {
		return str[0].toUpperCase() + str.substr(1).toLowerCase();
	};
	
	tools.ucwords = function (str) {
		return str.toLowerCase().replace(/(^([a-zA-Z\p{M}]))|([ -][a-zA-Z\p{M}])/g,
			function ($1) {
				return $1.toUpperCase();
			});
	};
	
	tools.cleanStr = function (string, translit) {
		string = string.replace(new RegExp("[[\\]{}()*+?.,\\^$|#\\s]"), "\\$&");
		if (translit) {
			return tools.translit(string);
		}
		return string;
	};
	
	tools.translit = function (string) {
		return string.toLowerCase()
			.replace(/[]/g, "a")
			.replace(//g, "ae")
			.replace(//g, "c")
			.replace(/[]/g, "e")
			.replace(/[]/g, "i")
			.replace(//g, "n")
			.replace(/[]/g, "o")
			.replace(//g, "oe")
			.replace(/[]/g, "u")
			.replace(/[]/g, "y");
	};
	
	var preloaded = {};
	
	tools.preloadPicture = function (url, pic) {
		var src = url;
		if (pic) {
			src += pic + ".jpg";
		}
		if (typeof (preloaded[src]) !== 'undefined') {
			return;
		}
		var heavyImage = new Image();
		heavyImage.src = src;
		preloaded[src] = true;
	};
	
	tools.stripStartScript = function(html) {
		html = $.trim(html);
		if (html.substr(0, 8) !== '<script ') {
			return html;
		}
		var pos = html.indexOf('>');
		if (pos === -1) {
			return html;
		}
		var pos2 = html.indexOf('</script>');
		if (pos2 === -1) {
			return html;
		}
		if (pos !== pos2 - 1) {
			return html;
		}
		return html.substr(pos2 + 9);
	};
	
	tools.replaceThumbcast = function (html) {
		var parts = html.split(/(<script>|<\/script>)/g);
		for (var i = 0; i < parts.length; i++) {
			if (parts[i] === '<script>' || parts[i] === '</script>') {
				parts[i] = '';
			} else if (parts[i].substr(0, 41) === 'document.write(xv.thumbs.replaceThumbUrl(') { // SHOULD BE COMPLETELY DEPRECATED
				parts[i] = window.xv.thumbs.replaceThumbUrl(parts[i].substring(42, parts[i].lastIndexOf('))') - 1));
			} else if (parts[i].substr(0, 37) === 'xv.thumbs.casting.displayRandomThumb(') { // NOT USED ANYMORE
				parts[i] = window.xv.thumbs.casting.displayRandomThumb(parts[i].substring(38, parts[i].lastIndexOf(')') - 1), true);
			} else if (parts[i].substr(0, 47) === 'document.write(xv.thumbs.replaceActGalThumbUrl(') {
				parts[i] = window.xv.thumbs.replaceActGalThumbUrl(parts[i].substring(48, parts[i].lastIndexOf('))') - 1));
			} else if (parts[i].substr(0, 44) === 'document.write(xv.thumbs.replacePicThumbUrl(') {
				parts[i] = window.xv.thumbs.replacePicThumbUrl(parts[i].substring(45, parts[i].lastIndexOf('))') - 1));
			} else if (parts[i].substr(0, 23) === 'xv.thumbs.prepareVideo(') {
				//tools.pendingPrepare.push(parts[i].substring(23, parts[i].lastIndexOf(')')));
				parts[i] = "";
			}
		}
		return parts.join('');
	};
	
	tools.executePendingPrepare = function (nodelist) {
		nodelist.each(function () {
			window.xv.thumbs.prepareVideo(this);
		});
		if (window.xv.pending_prepare_video_list) {
			for (var i in window.xv.pending_prepare_video_list) {
				if (typeof(window.xv.pending_prepare_video_list[i]) === "function") {
					window.xv.pending_prepare_video_list[i](nodelist);
				}
			}
		}
	};
	
	tools.addPendingPrepareList = function (func) {
		if (!window.xv.pending_prepare_video_list) {
			window.xv.pending_prepare_video_list = [];
		}
		window.xv.pending_prepare_video_list.push(func);
	};
	
	tools.scrollTo = function (node, margin_top, speed) {
		var $Node = $(node);
		if (!$Node || !$Node.length) {
			return;
		}
		if (typeof margin_top === 'undefined') {
			margin_top = 0;
		}
		if (typeof speed === 'undefined') {
			speed = 400;
		}
		$('html,body').animate({scrollTop: $Node.offset().top - 10 - margin_top}, speed);
	};
	
	var recaptcha_callbacks = [];
	
	tools.loadRecaptcha = function (callback, locale) {
		if (typeof (grecaptcha) === 'object') {
			callback();
			return;
		}
		recaptcha_callbacks.push(callback);
		if (recaptcha_callbacks.length > 1) { // Load only once
			return;
		}
		window.onToolsRecaptchaLoaded = function () {
			for (var i in recaptcha_callbacks) {
				(recaptcha_callbacks[i])();
			}
		};
		var script = 'https://www.google.com/recaptcha/api.js?onload=onToolsRecaptchaLoaded&render=explicit';
		if (typeof (locale) === 'string') {
			script += '&hl=' + locale;
		}
		utils.loadScript(script);
	};
	
	tools.formatNumberUnits = function (num, decimals) {
		if (typeof decimals == "undefined" || decimals != parseInt(decimals)) {
			decimals = 1;
		} else {
			decimals = parseInt(decimals);
		}
		
		var units = false;
		var pow = 0;
		if (num >= 1000000000) {
			units = "billions";
			pow = 9;
		} else if (num >= 1000000) {
			units = "millions";
			pow = 6;
		} else if (num >= 1000) {
			units = "thousands";
			pow = 3;
		}
		
		var number = Math.round(num / Math.pow(10, (pow - decimals)));
		number = number / Math.pow(10, (decimals));
		number = number.toLocaleString();
		
		if (!units) {
			return number;
		}
		
		return i18n.__("units.number_" + units, {"%number%": number});
	};

	tools.formatNumberCompact = function(number) {
		var formatted = number;

		if (number < 1000) {
			return formatted.toString();
		}

		formatted = formatted.toString();
		formatted = formatted.split('');
		if (number < 10000) {
			return formatted[0] + 'k';
		}
		if (number >= 10000 && number < 100000) {
			return formatted[0] + formatted[1] + 'k';
		}
		if (number >= 100000 && number < 1000000) {
			return formatted[0] + formatted[1] + formatted[2] + 'k';
		}
		if (number >= 1000000 && number < 10000000) {
			return formatted[0] + 'm';
		}
	};
	
	tools.formatFileSize = function(size, decimals) {
		if ( typeof decimals == "undefined" || decimals != parseInt(decimals) ) {
			decimals = 1;
		} else {
			decimals = parseInt(decimals);
		}
		
		var units= {
			"terabytes": 1099511627776,
			"gigabytes": 1073741824,
			"megabytes": 1048576,
			"kilobytes": 1024
		};
		var trad_prefix = "bytes";
		for (var unit in units) {
			if ( typeof units[unit] == "number" && size >= units[unit] ) {
				trad_prefix = unit;
				size = size / units[unit];
				break;
			}
		}
		
		size = Math.round( size * Math.pow(10,decimals) ) / Math.pow(10,decimals);
		size = size.toLocaleString();
		
		return i18n.__("units.file_size_" + trad_prefix, { "%size%": size });
	};
	
	tools.formatDurationMethods = {short: "short", medium: "medium", long: "long", diff: "ago"};

	tools.format_timestamp_relative = function (timestamp, is_ms) {
		var duration = Date.now()/1000 - timestamp/(is_ms ? 1000 : 1);
		var prefix = duration >= 0 ? "" : "in ";
		var method = duration >= 0 ? "ago" : "medium";
		return prefix + tools.formatDuration(Math.abs(duration), method);
	};

	tools.formatDuration = function (duration, method) {
		if ( !method ) {
			method = this.formatDurationMethods.medium;
		}
		
		if (duration < 5 && method == this.formatDurationMethods.diff) {
			return i18n.__("misc.just_now");
		}
		if ( duration >= 86400 &&  duration < (86400 * 2) && method == this.formatDurationMethods.diff ) {
			return i18n.__("misc.yesterday");
		}
		
		var times = {
			"sec": 60,
			"min": 3600,
			"hour": 86400,
			"day": 86400*7,
			"week": 86400*30,
			"month": 31536000,
			"year": -1
		};
		
		var last_limit = 1; 
		var trad;
		for (var key in times ){
			
			if (duration < times[key] || times[key] == -1) {
				
				duration = Math.floor(duration / last_limit);
				if (duration == 1) {
					trad = i18n.__("misc.one_" + key + "_" + method);
				} else {
					trad = i18n.__("misc.nb_" + key + "s_" + method, {"%nb%": duration.toString()});
				}
				break;
			}
			last_limit = times[key];
		}
		
		return trad;
		
	};

	tools.format_timestamp = function (timestamp) {
		var date = new Date(timestamp * 1000);
		var now = new Date();
		var date_string = '';

		if (date.getFullYear() !== now.getFullYear()) {
			date_string += date.getFullYear() + '/';
		}
		if (date.getDate() !== now.getDate()) {
			date_string += tools.format_date_number(date.getMonth() + 1) + '/' + tools.format_date_number(date.getDate()) + ' ';
		}
		date_string += tools.format_date_number(date.getHours()) + ':' + tools.format_date_number(date.getMinutes());

		return date_string;
	};

	tools.format_duration = function(ms) {
		var totalSeconds = Math.floor(ms / 1000),
			hours = Math.floor(totalSeconds / 3600),
			minutes = Math.floor((totalSeconds % 3600) / 60),
			seconds = totalSeconds % 60,
			duration = '';

		function formatDigit(n) {
			return (n < 10 ? '0' : '') + n;
		}

		if (hours > 0) duration += formatDigit(hours) + ':';
		duration += formatDigit(minutes) + ':' + formatDigit(seconds);

		return duration;
	};

	tools.format_date_number = function (num) {
		if (num <= 9) {
			return '0' + num;
		}
		else {
			return num;
		}
	};

	tools.string_to_node = function (str) {
		var dom = document.createElement('div');
		dom.innerHTML = str;
		return dom.firstChild;
	};
	/**
	 * Find a string in a text node and replace it with the provided replacement.
	 *
	 * @param node A text node.
	 * @param needle The string to find in the text node.
	 * @param replacement An HTML string or a function returning a node.
	 */
	tools.replace_text_in_node = function (node, needle, replacement) {
		var index = node.nodeValue.indexOf(needle);
		if (index === -1) {
			return;
		}

		var charAfterNeedle = node.nodeValue[index + needle.length];

		if (charAfterNeedle && /[a-zA-Z0-9/.]/.test(charAfterNeedle)) {
			return;
		}

		if (typeof replacement == "string") {
			replacement = tools.string_to_node(replacement);
		}

		var fragment = document.createDocumentFragment();
		fragment.appendChild(document.createTextNode(node.nodeValue.slice(0, index)));
		fragment.appendChild(typeof replacement === 'function' ? replacement(needle) : replacement);
		fragment.appendChild(document.createTextNode(node.nodeValue.slice(index + needle.length)));

		node.parentNode.replaceChild(fragment, node);
	}
	/**
	 * Recursively find a string in an element node and its children, and replace it with the provided replacement.
	 *
	 * @param container An element node.
	 * @param needle The string to find in the container.
	 * @param replacement An HTML string or a function returning a node.
	 */
	tools.replace_text_in_node_recursive = function (container, needle, replacement) {
		var node = container.firstChild;

		while (node) {
			var nextSibling = node.nextSibling;
			if (node.nodeType === 3) {
				tools.replace_text_in_node(node, needle, replacement);
			} else if (node.nodeType === 1) {
				tools.replace_text_in_node_recursive(node, needle, replacement);
			}
			node = nextSibling;
		}
	}

	tools.getKeyByValue = function (value, object) {
		for (var prop in object) {
			if (object.hasOwnProperty(prop)) {
				if (object[prop] === value) {
					return prop;
				}
			}
		}
	}

	tools.replaceElement = function (oldNode, newNode) {
		var oldNodeIsString = "string" === typeof oldNode;

		if (!(!!oldNode) && !(oldNode instanceof Node) && false === oldNodeIsString) {
			throw new TypeError('oldNode must be a Node')
		}

		if (oldNodeIsString) {
			oldNode = document.querySelector(oldNode);
		}

		if (!(!!newNode) || !(newNode instanceof Node)) {
			throw new TypeError('newNode must be a Node')
		}

		oldNode.parentNode.replaceChild(newNode, oldNode);
	}

	tools.walkDOMSubtree = function (startElement, callback) {
		if (!startElement.children) {
			return;
		}

		if (startElement.children.length === 0) {
			callback(startElement);
			return;
		}

		for (const child of startElement.children) {
			tools.walkDOMSubtree(child, callback);
		}

		callback(startElement);
	}

	tools.dateToLocaleISOString = function (date) {
		return date.getFullYear() + '-'
			+ ('0' + (date.getMonth() + 1)).slice(-2) + '-'
			+ ('0' + date.getDate()).slice(-2) + 'T'
			+ ('0' + date.getHours()).slice(-2) + ':'
			+ ('0' + date.getMinutes()).slice(-2) + ':'
			+ ('0' + date.getSeconds()).slice(-2) + '.'
			+ ('0' + date.getMilliseconds()).slice(-2);
	}

	tools.escape = function (input, escape_quotes) {
		var e = document.createElement('div');
		e.appendChild(document.createTextNode(input));
		if (escape_quotes) {
			return e.innerHTML.replace(/"/g, "&quot;").replace(/'/g, "&apos;");
		}
		return e.innerHTML;
	};

	tools.deepMerge = function (target, source) {
		for (var prop in source) {
			if (source.hasOwnProperty(prop)) {
				if (!(!!target[prop]) || Object.prototype.toString.call(source[prop]) !== '[object Object]') {
					target[prop] = source[prop];
				} else {
					target[prop] = this.deepMerge(target[prop], source[prop]);
				}
			}
		}

		return target;
	}

	/**
	 * Delay a function call
	 * @param {Function} func  the function to call
	 * @param {number} wait  delay in ms
	 * @param {boolean} immediate  if true, the function is called right away and prevent next calls.
	 * @return {Function}  the function with delay
	 */
	tools.debounce = function (func, wait, immediate) {
		var timeout;

		return function () {
			var context = this,
				args = arguments;

			var later = function () {
				timeout = null;
				if (!immediate) {
					func.apply(context, args);
				}
			};

			var callNow = immediate && !timeout;

			clearTimeout(timeout);
			timeout = setTimeout(later, wait);

			if (callNow) {
				func.apply(context, args);
			}
		};
	};
	
	return tools;
	
});
define('lib/helpers/events/scroll',[], function () {
	
	var startlisteners = [],
		endlisteners = [],
		scrolling = false,
		start_timeout = null,
		stop_timeout = null,
		delay_start = 100,
		delay_stop = 200;
	
	$(window).on('scroll', function () {
		if (!scrolling) {
			for (var i in startlisteners) {
				startlisteners[i]();
			}
		}
		if (scrolling !== true) {
			start_timeout = setTimeout(function () {
				scrolling = true;
			}, delay_start);
		}
		clearTimeout(stop_timeout);
		stop_timeout = setTimeout(function () {
			clearTimeout(start_timeout);
			scrolling = false;
			for (var i in endlisteners) {
				endlisteners[i]();
			}
		}, delay_stop);
	});
	
	var events = {
		addScrollStartListener: function (listener) {
			startlisteners.push(listener);
		},
		addScrollEndListener: function (listener) {
			endlisteners.push(listener);
		},
		isScrolling: function () {
			return scrolling;
		}
	};
	
	return events;
	
});

define('lib/helpers/events/tab',[], function() {
	
	var vlisteners = [],
		hlisteners = [],
		hiddenattr = "hidden",
		v = "visible",
		h = "hidden",
		evtMap = {
			focus:v,
			focusin:v,
			pageshow:v,
			blur:h,
			focusout:h,
			pagehide:h
		},
		last_event;
	
	// Standards:
	if (hiddenattr in document) {
		document.addEventListener("visibilitychange", onchange);
	} else if ((hiddenattr = "mozHidden") in document) {
		document.addEventListener("mozvisibilitychange", onchange);
	} else if ((hiddenattr = "webkitHidden") in document) {
		document.addEventListener("webkitvisibilitychange", onchange);
	} else if ((hiddenattr = "msHidden") in document) {
		document.addEventListener("msvisibilitychange", onchange);
	} else if ("onfocusin" in document) { // IE 9 and lower:
		document.onfocusin = document.onfocusout = onchange;
	} else { // All others:
		window.onpageshow = window.onpagehide = window.onfocus = window.onblur = onchange;
	}
	
	$(window).on('blur', onchange);
	$(window).on('focus', onchange);
	
	function onchange (evt) {
		evt = evt || window.event;
		var type;
		if (evt.type in evtMap) {
			type = evtMap[evt.type];
		} else {
			type = this[hiddenattr] ? "hidden" : "visible";
		}
		if (last_event === type) {
			return;
		}
		last_event = type;
		if (type === 'hidden') {
			for (var i in hlisteners) {
				hlisteners[i]();
			}
		} else {
			for (var i in vlisteners) {
				vlisteners[i]();
			}
		}
	}
	
	var events = {
		addHiddenListener: function(listener) {
			hlisteners.push(listener);
		},
		addVisibleListener: function(listener) {
			vlisteners.push(listener);
		}
	}
	
	return events;
	
});

define('lib/helpers/events',[
	'lib/helpers/events/scroll'
], function(scroll_events) {
	
	var idx = 0;
	
	var events = function() {
		this.thlistener;
		this.thlisteners = [];
		this.tvlistener;
		this.tvlisteners = [];
		this.sslisteners = [];
		this.selisteners = [];
	};
	
	events.prototype = {
		
		TAB_HIDDEN: 'tab.hidden',
		TAB_VISIBLE: 'tab.visible',
		SCROLL_START: 'scroll.start',
		SCROLL_END: 'scroll.end',
		
		addListener: function(type, listener) {
			switch (type) {
				case this.TAB_HIDDEN:
					this.thlisteners[idx] = listener;
					if (!this.thlistener) {
						this.thlistener = true;
						var self = this;
						require(['lib/helpers/events/tab'], function(tab_events) {
							tab_events.addHiddenListener(function() {
								for (var i in self.thlisteners) {
									self.thlisteners[i]();
								}
							});
						});
					}
					idx++;
					return idx - 1;
					
				case this.TAB_VISIBLE:
					this.tvlisteners[idx] = listener;
					if (!this.tvlistener) {
						this.tvlistener = true;
						var self = this;
						require(['lib/helpers/events/tab'], function(tab_events) {
							tab_events.addVisibleListener(function() {
								for (var i in self.tvlisteners) {
									self.tvlisteners[i]();
								}
							});
						});
					}
					idx++;
					return idx - 1;
				
				case this.SCROLL_START:
					this.sslisteners[idx] = listener;
					idx++;
					return idx - 1;
				
				case this.SCROLL_END:
					this.selisteners[idx] = listener;
					idx++;
					return idx - 1;
			}
			return false;
		},
		
		isScrolling: function() {
			return scroll_events.isScrolling();
		}
		
	};
	
	return new events();
	
});

define('text!lib/helpers/loader/before.mustache',[],function () { return '<span class="x-loader-inline before{{#is_button}} btn btn-default{{/is_button}}"{{#id}} id="{{id}}"{{/id}}>{{{ loader }}}{{#text}}{{#safe}}{{{ text }}}{{/safe}}{{^safe}}{{ text }}{{/safe}} {{/text}}</span>';});


define('text!lib/helpers/loader/after.mustache',[],function () { return '<span class="x-loader-inline after{{#is_button}} btn btn-default{{/is_button}}"{{#id}} id="{{id}}"{{/id}}>{{#text}}{{#safe}}{{{ text }}}{{/safe}}{{^safe}}{{ text }}{{/safe}} {{/text}}{{{ loader }}}</span>';});


/*
* Provides generic loader HTML snippet with animated image + text
*/

define('lib/helpers/inline_loader',[
	'lib/tools',
	"mustache",
	"text!./loader/before.mustache",
	"text!./loader/after.mustache"
], function(tools, Mustache, tpl_before, tpl_after) {
	
	var loader_img = '',
		cur_idx = -1;
	
	var get_template = function(type) {
		if(type === 'before' || type === 'button_before') {
			return tpl_before;
		}
		return tpl_after;
	};
	
	var get_id = function(id) {
		if(typeof(id) !== 'undefined') {
			return id;
		}
		cur_idx++;
		return '_x_loader_'+cur_idx;
	};
	
	var loader = function(type, text, id, safe) {
		if(typeof(type) !== 'string') {
			type = 'after';
		}
		this.html = Mustache.render(get_template(type), {
			id: get_id(id),
			text: text,
			is_button: type.indexOf('button_') === 0,
			loader: loader.getImg(),
			safe: !!safe
		});
		this.node = false;
	};
	
	loader.setup = function(loader_img_src) {
		tools.preloadPicture(loader_img_src);
		loader_img = '<img class="x-loader-inline-img" src="'+loader_img_src+'" />';
	};
	
	loader.get = function(type, text, id) {
		return new loader(type, text, id);
	};
	
	loader.getSafe = function(type, text, id) {
		return new loader(type, text, id, true);
	};
	
	loader.getImg = function() {
		return loader_img;
	};
	
	loader.getIcf = function() {
		return "<span class='icon-f icf-spinner icf-anim-pulse'></span>";
	};
	
	loader.prototype = {
		
		getHtml: function() {
			return this.html;
		},
		
		getNode: function() {
			if(!this.node) {
				this.node = $(this.html);
			}
			return this.node;
		},
		
		appendTo: function(node) {
			this.getNode().appendTo(node);
			return this;
		},
		
		prependTo: function(node) {
			this.getNode().prependTo(node);
			return this;
		},
		
		insertAfter: function(node) {
			this.getNode().insertAfter(node);
			return this;
		},
		
		insertBefore: function(node) {
			this.getNode().insertBefore(node);
			return this;
		},
		
		detach: function() {
			this.getNode().detach();
			return this;
		},
		
		remove: function() {
			if(this.node) {
				this.node.remove();
			}
		}
		
	};
	
	return loader;
	
});



(function () {
	
	var dom = {};
	
	dom.getChildren = function (node, allow_script) {
		var children = [];
		for (var i in node.childNodes) {
			if (node.childNodes[i].nodeType === 1 && (allow_script || node.childNodes[i].nodeName !== 'SCRIPT')) {
				children.push(node.childNodes[i]);
			}
		}
		return children;
	};
	
	dom.getChildrenRecursive = function (node) {
		var children = [];
		for (var i in node.childNodes) {
			if (node.childNodes[i].nodeType === 1) {
				var child_of_child = this.getChildrenRecursive(node.childNodes[i]);
				for (var j in child_of_child) {
					children.push(child_of_child[j]);
				}
				children.push(node.childNodes[i]);
			}
		}
		return children;
	};
	
	dom.getFirstChild = function (node) {
		for (var i in node.childNodes) {
			if (node.childNodes[i].nodeType === 1) {
				return node.childNodes[i];
			}
		}
	};
	
	dom.getPreviousSibling = function (node) {
		if (node.previousElementSibling) {
			return node.previousElementSibling;
		}
		do {
			node = node.previousSibling;
		} while (node && node.nodeType !== 1);
		return node;
	};
	
	dom.getNextSibling = function (node) {
		if (node.nextElementSibling) {
			return node.nextElementSibling;
		}
		do {
			node = node.nextSibling;
		} while (node && node.nodeType !== 1);
		return null;
	};
	
	dom.hasClass = function (node, cls) {
		return (' ' + node.className + ' ').indexOf(' ' + cls + ' ') !== -1;
	};
	
	dom.addClass = function (node, cls) {
		if ((' ' + node.className + ' ').indexOf(' ' + cls + ' ') !== -1) {
			return;
		}
		node.className = (node.className + ' ' + cls).trim();
		return node;
	};
	
	dom.removeClass = function (node, cls) {
		if (typeof cls === 'undefined' || cls.length === 0) {
			node.className = '';
			return node;
		}
		var class_name = ' ' + node.className + ' ',
			classes = cls.split(' ');
		for (var i = 0; i < classes.length; i++) {
			cls = classes[i];
			if (cls.length === 0) {
				continue;
			}
			class_name = class_name.replace(' ' + cls + ' ', ' ');
		}
		node.className = class_name.substring(1, class_name.length - 1);
		return node;
	};
	
	dom.addEventListener = function (obj, evt, fnc) {
		// W3C model
		if (obj.addEventListener) {
			obj.addEventListener(evt, fnc, false);
			return true;
		}
		// Microsoft model
		else if (obj.attachEvent) {
			return obj.attachEvent('on' + evt, fnc);
		}
		// Browser don't support W3C or MSFT model, go on with traditional
		else {
			evt = 'on' + evt;
			if (typeof obj[evt] === 'function') {
				// Object already has a function on traditional
				// Let's wrap it with our own function inside another function
				fnc = (function (f1, f2) {
					return function () {
						f1.apply(this, arguments);
						f2.apply(this, arguments);
					}
				})(obj[evt], fnc);
			}
			obj[evt] = fnc;
			return true;
		}
	};
	
	var viewport_method;
	
	dom.getViewportWidth = function () {
		try {
			if (viewport_method === 'inner' || typeof window.innerWidth !== 'undefined') {
				viewport_method = 'inner';
				return window.innerWidth;
			}
		} catch (e) {
			if (xv && xv.sda && xv.sda.manager && xv.sda.manager.sendError) {
				xv.sda.manager.sendError(e, 'dom.getViewportWidth (1) : ' + typeof window.innerWidth);
			}
		}
		// IE6
		try {
			if (viewport_method === 'documentElement'
				|| (typeof document.documentElement !== 'undefined' && typeof document.documentElement.clientWidth !== 'undefined' && document.documentElement.clientWidth != 0)) {
				viewport_method = 'documentElement'
				return document.documentElement.clientWidth;
			}
		} catch (e) {
			if (xv && xv.sda && xv.sda.manager && xv.sda.manager.sendError) {
				xv.sda.manager.sendError(e, 'dom.getViewportWidth (2)');
			}
		}
		// older IE
		try {
			return document.getElementsByTagName('body')[0].clientWidth;
		} catch (e) {
			if (xv && xv.sda && xv.sda.manager && xv.sda.manager.sendError) {
				xv.sda.manager.sendError(e, 'dom.getViewportWidth (3)');
			}
		}
		return 0;
	};
	
	dom.getViewportHeight = function () {
		if (viewport_method === 'inner' || typeof window.innerWidth !== 'undefined') {
			viewport_method = 'inner';
			return window.innerHeight;
		} else if (viewport_method === 'documentElement'
			|| (typeof document.documentElement !== 'undefined' && typeof document.documentElement.clientWidth !== 'undefined' && document.documentElement.clientWidth != 0)) {
			viewport_method = 'documentElement'
			return document.documentElement.clientHeight;
		}
		// older versions of IE
		return document.getElementsByTagName('body')[0].clientHeight;
	};
	
	dom.scrollToTop = function (to) {
		if (typeof to === 'undefined') {
			to = 0;
		}
		if (window.jQuery) {
			$("html, body").animate({scrollTop: to}, "slow");
		} else {
			document.getElementsByTagName('body')[0].scrollTop = to;
			document.getElementsByTagName('html')[0].scrollTop = to;
		}
	};
	
	dom.getScrollTop = function () {
		if (window.jQuery && typeof window.jQuery(window).scrollTop === 'function') {
			return window.jQuery(window).scrollTop();
		}
		if (typeof document.getElementsByTagName('body')[0] !== 'undefined') {
			return document.getElementsByTagName('body')[0].scrollTop;
		}
		return 0;
	};
	
	dom.element = function (element) {
		if (typeof element !== "object") {
			return false;
		}
		if (typeof element.tagName === "undefined") {
			if (typeof $ === "function" && $(element).length > 0) {
				element = $(element)[0];
			} else {
				if (typeof element[0] !== "object" || typeof element[0].tagName === "undefined") {
					return false;//in case => is visible!
				}
				element = element[0];
			}
		}
		return element;
	};
	
	dom.isFixedElement = function (element) {
		element = dom.element(element);
		if (!element) {
			return false;
		}
		return window.getComputedStyle(element,null).getPropertyValue('position') === 'fixed';
	};
	
	dom.getFixedParent = function (element) {
		while (element) {
			if (dom.isFixedElement(element)) {
				return element;
			}
			element = element.offsetParent;
		}
		return false;
	};
	
	dom.getElementOffset = function (element, with_body_scroll) {
		var xPos = 0;
		var yPos = 0;
		
		element = dom.element(element);
		
		if (typeof with_body_scroll !== "boolean") {
			with_body_scroll = false;
		}
		
		while (element) {
			if (element.tagName === "BODY") {
				var xScroll = !with_body_scroll ? 0 : element.scrollLeft || document.documentElement.scrollLeft;
				var yScroll = !with_body_scroll ? 0 : element.scrollTop || document.documentElement.scrollTop;
				xPos += (element.offsetLeft - xScroll + element.clientLeft);
				yPos += (element.offsetTop - yScroll + element.clientTop);
			} else {
				xPos += (element.offsetLeft - element.scrollLeft + element.clientLeft);
				yPos += (element.offsetTop - element.scrollTop + element.clientTop);
			}
			
			// if (dom.isFixedElement(element)) {
			// 	element = false;
			// } else {
				element = element.offsetParent;
			// }
		}
		return {
			left: xPos,
			top: yPos
		};
	};
	
	dom.isElementInView = function (element, fullyInView, options) {
		element = dom.element(element);
		if (!element || typeof element.offsetTop === "undefined" || typeof element.offsetHeight === "undefined") {
			return true;//in case => is visible!
		}
		
		var scroll_margin = typeof options !== "undefined" && typeof options["scroll_marge"] === "number" ? options["scroll_marge"] : 0;
		//easy way if one parent is in display none :
		var no_zero = typeof options !== "undefined" && typeof options["no_zero"] === "boolean" ? options["no_zero"] : false;
		
		if (typeof window.getComputedStyle === "function") {
			var style = window.getComputedStyle(element);
			if (style === null || style.display === 'none') {
				return false;
			}
		}
		var pageTop = dom.getScrollTop(),
			pageBottom = pageTop + dom.getViewportHeight(),
			elementTop = dom.getElementOffset(element).top,
			elementBottom = elementTop + element.offsetHeight,
			fixedParent = dom.getFixedParent(element);
		
		
		if (fixedParent) {
			pageTop = dom.getElementOffset(fixedParent).top;
			pageBottom = pageTop + fixedParent.offsetHeight;
		}
		
		if (no_zero === true && elementTop === 0 && elementBottom === 0) {
			//case if parent is display none
			return false;
		}
		if (fullyInView === true) {
			return ((pageTop - scroll_margin < elementTop) && (pageBottom + scroll_margin > elementBottom));
		}
		// console.info("%c(eTop <= pBot + marge) && (eBot >= pTop - marge)" +
		// 	"\n(" + elementTop + " <= " + pageBottom + " + " + scroll_marge + ") && (" + elementBottom + " >= " + pageTop + " - " + scroll_marge + ")" +
		// 	"\n(" + (elementTop <= pageBottom + scroll_marge) + ") && (" + (elementBottom >= pageTop - scroll_marge) + ")" +
		// 	"\n" + ((elementTop <= pageBottom + scroll_marge) && (elementBottom >= pageTop - scroll_marge)), 'color: #f8a41b');
		return ((elementTop <= pageBottom + scroll_margin) && (elementBottom >= pageTop - scroll_margin));
	};
	
	if (!window.xv) {
		window.xv = {};
	}
	window.xv.dom = dom;
	
})();

define('lib/dom',[], function () {
	return window.xv.dom;
});
define('lib/helpers/overlay/box',[
	'lib/tools',
	'../../dom',
	'../overlay'
], function (tools, dom, overlay) {
	
	var box = function (contener, closable, close_action, verticallyCentered, scrollTo) {
		overlay.apply(this, arguments);
		this.ori_padding = false;
		this.node.addClass('x-overlay-box');
		this.verticallyCentered = !!verticallyCentered;
		this.bCanReposition = true;
		this.scrollTo = !!scrollTo;
	};
	
	box.prototype = new overlay();
	
	box.get = function (contener, closable, close_action, verticallyCentered) {
		return new box(contener, closable, close_action, verticallyCentered);
	};
	
	box.prototype.show = function (relative, noOverlayExtended) {
		if (this.open) {
			return;
		}
		this.node.appendTo(this.parent);
		this.open = true;
		if (this.onShow) {
			this.onShow();
		}
		return this.position(relative, noOverlayExtended);
	};
	
	box.prototype.position = function (relative, noOverlayExtended) {
		if (!this.bCanReposition) {
			return this;
		}
		var node_height = this.node.height(),
			body_height = this.body.outerHeight();
		var marginTop = !this.verticallyCentered ? 10 : ($(window).height() - body_height) / 2;
		if (relative === false) {
			this.body.css('margin-top', marginTop + 'px');
			return this;
		}
		if (!noOverlayExtended && node_height < body_height + marginTop) {
			this.ori_padding = this.parent.css('padding-bottom');
			this.parent.css('padding-bottom', (body_height + marginTop - node_height) + 'px');
		}
		if (relative === 'auto') {
			var top = 0;
			if (node_height >= body_height + marginTop) {
				top = $(window).scrollTop();
			}
			this.body.css('margin-top', (top + marginTop) + 'px');
			return this;
		}
		if (typeof relative !== 'undefined') {
			relative = $(relative);
		} else {
			relative = false;
		}
		if (relative && relative.length > 0) {
			var relative_pos = relative.position().top,
				mtop = Math.max(marginTop, Math.min(relative_pos, node_height - body_height - marginTop));
			this.body.css('margin-top', mtop + 'px');
		} else {
			this.body.css('margin-top', Math.max(marginTop, Math.round(Math.min(Math.min($(window).height() * 0.01, 150), (node_height - body_height) / 2))) + 'px');
			if (this.closable && !dom.isElementInView(this.body, true)) {
				var elementOrParentIsFixed = function ($element) {
					var $checkElements = $element.add($element.parents());
					var isFixed = false;
					$checkElements.each(function(){
						if ($(this).css("position") === "fixed") {
							isFixed = true;
							return false;
						}
					});
					return isFixed;
				};
				if(this.scrollTo && !elementOrParentIsFixed(this.body)) {
					tools.scrollTo(this.body, 10);
				}
			}
		}
		return this;
	};
	
	box.prototype.setEscapeClosable = function (closable) {
		if (closable === false) {
			if (this.esc_close_handler) {
				$('body').off('keyup', this.esc_close_handler);
				this.esc_close_handler = null;
			}
		} else {
			if (!this.esc_close_handler) {
				var self = this;
				this.esc_close_handler = $('body').on('keyup', function (event) {
					if (self.open && event.which === 27) {
						self.close_action === 'close' ? self.close() : self.hide();
					}
				});
			}
		}
	};
	
	box.prototype.setCanReposition = function (bReposition) {
		this.bCanReposition = !!bReposition;
	};
	
	box.prototype.setOverlayClosable = function (closable) {
		if (closable === false) {
			if (this.overlay_close_handler) {
				this.node.off("click", this.overlay_close_handler);
				this.overlay_close_handler = null;
			}
		} else {
			if (!this.overlay_close_handler) {
				var self = this;
				this.overlay_close_handler = function (e) {
					if ($(e.target).hasClass("x-overlay-box")) {
						self.close_action === 'close' ? self.close() : self.hide()
					}
				};
				this.node.on("click", this.overlay_close_handler);
			}
		}
	};
	
	box.prototype.setOverlayReposition = function (relative) {
		var self = this;
		this.overlay_reposition_handler = function (e) {
			if ($(e.target).hasClass("x-overlay-box")) {
				self.open = false;
				self.show(relative);
			}
		};
		this.node.on("click", this.overlay_reposition_handler);
	};
	
	box.prototype.setScrollAndResizeReposition = function (relative) {
		if (typeof this.eScrollAndResizeReposition !== 'undefined') {
			$(window).off('scroll', this.eScrollAndResizeReposition).off('resize', this.eScrollAndResizeReposition);
		}
		
		var self = this;
		this.eScrollAndResizeReposition = function () {
			if (typeof self.tScrollAndResizeReposition !== 'undefiled') {
				clearTimeout(self.tScrollAndResizeReposition);
			}
			self.tScrollAndResizeReposition = setTimeout(function () {
				self.position(relative);
				self.setScrollAndResizeReposition(relative);
			}, 250);
		};
		
		$(window).on('scroll', this.eScrollAndResizeReposition).on('resize', this.eScrollAndResizeReposition);
	};
	
	box.prototype.hide = function () {
		if (this.ori_padding !== false) {
			this.parent.css('padding-bottom', this.ori_padding);
		}
		return overlay.prototype.hide.apply(this);
	};
	
	box.prototype.close = function () {
		if (this.ori_padding !== false) {
			this.parent.css('padding-bottom', this.ori_padding);
		}
		return overlay.prototype.close.apply(this);
	};
	
	return box;
	
});



define('text!lib/helpers/overlay/contextual_popup/alert.mustache',[],function () { return '<div class="contextual-popup-content">\n\t<div class="contextual-popup-message">\n\t\t{{{ message }}}\n\t</div>\n\t<div class="contextual-popup-actions">\n\t\t<button class="contextual-popup-content-close ok-close" data-send-form="1">{{{ ok }}}</button>\n\t</div>\n</div>';});


define('text!lib/helpers/overlay/contextual_popup/confirm.mustache',[],function () { return '<div class="contextual-popup-content">\n\t<div class="contextual-popup-message">\n\t\t{{{ message }}}\n\t</div>\n\t<div class="contextual-popup-actions">\n\t\t<button class="ok-close" data-send-form="1">{{{ ok }}}</button>\n\t\t<button class="contextual-popup-content-close">{{{ cancel }}}</button>\n\t</div>\n</div>';});


define('text!lib/helpers/overlay/contextual_popup/loading.mustache',[],function () { return '<div class="contextual-popup-content">\n\t<div class="contextual-popup-message">\n\t\t{{{ message }}}\n\t</div>\n</div>';});

define('lib/helpers/overlay/contextual_popup',[
	'mustache',
	'./box',
	'../inline_loader',
	'lib/i18n!front',
	'text!./contextual_popup/alert.mustache',
	'text!./contextual_popup/confirm.mustache',
	'text!./contextual_popup/loading.mustache'
], function (Mustache, overlay_box, inline_loader, i18n, sTplAlert, sTplConfirm, sTplLoading) {
	
	var contextual_popup = function () {
	};
	
	contextual_popup.prototype = {
		
		get_popup: function (bClosable, sPopClass, sTpl, oPopupOptions, fClose, iDelay) {
			
			bClosable = typeof bClosable === "boolean" ? bClosable : true;
			var oPopup = overlay_box.get(oPopupOptions.container || $("body"), bClosable, "close")
				.setContent($(Mustache.render(sTpl, oPopupOptions)));
			
			if (!iDelay) {
				oPopup.show("auto");
			} else {
				oPopup.cp_open_timer = setTimeout( function () {
					oPopup.show("auto");
				}, iDelay);
			}

			if (bClosable) {
				oPopup.setOverlayClosable(bClosable);
				oPopup.setEscapeClosable(bClosable);
			} else {
				oPopup.setOverlayReposition("auto");
			}
			
			sPopClass = "contextual-popup" + (typeof sPopClass === "string" ? " " + sPopClass : "");
			oPopup.addClass(sPopClass);
			
			if (iDelay) {
				oPopup.normal_close = oPopup.close;
				oPopup.close = function () {
					if (oPopup.cp_open_timer) {
						clearTimeout(oPopup.cp_open_timer);
					}
					oPopup.normal_close();
				}
			}
			
			if (typeof fClose === "function") {
				oPopup.onClose = fClose;
			}
			
			oPopup.getNode().find(".contextual-popup-content-close").on("click", function () {
				if ($(this).data("send-form")) {
					var form = oPopup.getNode().find("form");
					if (form.length > 0) {
						if (typeof oPopup.onClose === "function") {
							oPopup.onClose(form.serializeArray());
							oPopup.onClose = false;
						}
					}
				}
				oPopup.close();
			});
			
			return oPopup;
		},
		
		alert: function (sMessage, fOK, bClosable, oOptions) {
			var oPopupOptions = Object.assign({"message": sMessage, "ok": i18n.__("misc.OK")}, oOptions.popup || {});
			if (oOptions && oOptions.text_ok) {
				oPopupOptions.ok = oOptions.text_ok;
			}
			var iDelay = oOptions && typeof oOptions.delay === 'number' ? oOptions.delay : false;
			
			return this.get_popup(bClosable, "contextual-popup-alert", sTplAlert, oPopupOptions, fOK, iDelay);
		},
		
		confirm: function (sMessage, fOK, fNO, bClosable, oOptions) {
			var oPopupOptions = Object.assign({"message": sMessage, "ok": i18n.__("misc.OK"), "cancel": i18n.__("misc.cancel")}, oOptions.popup || {});
			if (oOptions) {
				if (oOptions.text_ok) {
					oPopupOptions.ok = oOptions.text_ok;
				}
				if (oOptions.text_cancel) {
					oPopupOptions.cancel = oOptions.text_cancel;
				}
			}
			var iDelay = oOptions && typeof oOptions.delay === 'number' ? oOptions.delay : false;
			
			var fnClose = fNO;
			
			if (oOptions) {
				if (typeof oOptions.override_otherclose === 'function') {
					fnClose = oOptions.override_otherclose;
				}
			}
			
			var oPopup = this.get_popup(bClosable, "contextual-popup-confirm", sTplConfirm, oPopupOptions, fnClose, iDelay);
			
			if (oOptions) {
				if (typeof oOptions.override_otherclose === 'function') {
					oPopup.getNode().find(".contextual-popup-content-close").off('click').on("click", function () {
						if (typeof fNO === "function") {
							if ($(this).data("send-form")) {
								var form = oPopup.getNode().find("form");
								if (form.length > 0) {
									fOK(form.serializeArray());
									oPopup.onClose = null;
									oPopup.close();
									return;
								}
							}
							fNO();
						}
						oPopup.onClose = null;
						oPopup.close();
					});
				}
			}
			
			oPopup.getNode().find(".ok-close").on("click", function () {
				if (typeof fOK === "function") {
					if ($(this).data("send-form")) {
						var form = oPopup.getNode().find("form");
						if (form.length > 0) {
							fOK(form.serializeArray());
							oPopup.onClose = null;
							oPopup.close();
							return;
						}
					}
					fOK();
				}
				oPopup.onClose = null;
				oPopup.close();
			});
			
			return oPopup;
		},
		
		loading: function(sMessage, oOptions) {
			var oPopupOptions = {"message": inline_loader.getSafe('after', sMessage || i18n.__("loading.loading")).getHtml() };
			var iDelay = oOptions && typeof oOptions.delay === 'number' ? oOptions.delay : false;
			return this.get_popup(false, "contextual-popup-loading", sTplLoading, oPopupOptions, null, iDelay);
		}
	};
	
	return new contextual_popup();
});

define('text!lib/helpers/popup/template.mustache',[],function () { return '<div class="x-popup {{ position }} {{ cls }}">\n\t<div class="x-popup-arrow"></div>\n\t<div class="x-popup-content"></div>\n\t{{{ closebtn }}}\n</div>\n';});


define('text!lib/helpers/popup/template_close.mustache',[],function () { return '<div class="x-popup-close">{{{ closebtn_content }}}</div>';});

define('lib/helpers/popup',[
	'mustache',
	'config/chat',
	'text!./popup/template.mustache',
	'text!./popup/template_close.mustache'
], function (Mustache, config, tpl, tpl_close) {
	
	var popups = [];
	
	var popup_options = {
		relative_to: null,
		relative_to_default: false,
		position: {v: 'below', h: 'right'},
		offset: {below: 0, above: 0, left: 0, right: 0},
		max_height: 0,
		max_width: 0,
		trigger: 'click',
		trigger_open: false,
		trigger_close: false,
		trigger_close_openevents: ["all"],
		autoclose: true,
		closebtn: false,
		closebtn_content: '<span class="icon-f icf-close-thin"><span>x</span></span>',
		template: tpl,
		template_close: tpl_close,
		popup_class: null,
		pos_on_scroll: false,
		close_on_resize: true,
		close_on_scroll: false,
		autoclose_on_same_level: false,
		mouseout_autoclose_openevents: ["mouseover_btn_timer"],
		popup_opened_btn_class: 'popup-opened-btn',
		popup_opened_class: 'popup-opened',
		fade: true
	};
	
	var popup = function (button, content, options) {
		this.options = $.extend({}, popup_options, options || {});
		this.setPosition(this.options.position, true);
		this.bRelativeToPosSet = false;
		
		this.button = $();
		this.content = content;
		this.opened = false;
		
		this.autoclose_timer = false;

		if (this.options.relative_to === null) {
			this.setDefaultRelativeTo();
		}

		this.setButton($(button));

		this.setupAutoCloseSameLevel();
		this.setupCloseOnResize();
		
		popups.push(this);
	};
	
	popup.prototype = {
		
		onOpen: null,
		
		onClose: null,
		
		levels: {
			header_menu: "HEADER_MENU",
			profile_submit: "PROFILE_SUBMIT",
			profile_related_submit: "PROFILE_SUBLVL_SUBMIT",
			profile_listing_dropdowns: "PROF_LIST_DROPDOWN",
			simple_dropdown_niv2: "SIMPLE_DROPDOWN",
			thumb_block_menu: "TB_MENU"
		},
		
		setButton: function (button) {
			if (this.button.is(button)) {
				return this;
			}
			if (this.button && this.button.length > 0) {
				this.button.removeClass(this.options.popup_opened_btn_class);
			}
			
			this.button = button;
			
			if (this.button && this.button.length > 0) {
				this.button.toggleClass(this.options.popup_opened_btn_class, this.opened);
			}
			if (this.options.relative_to_default === true) {
				this.setDefaultRelativeTo();
			}
			
			this.initButton();
			
			return this;
		},
		getButton: function() {
			return this.button;
		},
		initButton: function () {
			var self = this;
			
			if (this.options.trigger) {
				this.button
					.off(this.options.trigger, this.callbackButtonTrigger)
					.on(this.options.trigger, self, this.callbackButtonTrigger);
			}
			if (this.options.trigger_open) {
				this.button
					.off(this.options.trigger_open, this.callbackButtonTriggerOpen)
					.on(this.options.trigger_open, self, this.callbackButtonTriggerOpen);
			}
			if (this.options.trigger_close) {
				this.button
					.off(this.options.trigger_close, this.callbackButtonTriggerClose)
					.on(this.options.trigger_close, self, this.callbackButtonTriggerClose);
			}
			
			this.mouseover_open_timeout = false;
			this.mouseout_close_timeout = false;
			this.button
				.off("mouseover", this.onMouseOverButton)
				.on("mouseover", self, this.onMouseOverButton);
			
			if (config && config.is_desktop) {
				this.button
					.off("mouseout", this.onMouseOutButton)
					.on("mouseout", self, this.onMouseOutButton);
			} else {
				this.button_hovered = false;
				this.addMouseOutCloseFunc();
			}
			
			this.position();
		},
		addButtonPopupOpenedClass: function () {
			if (this.button && this.button.length > 0) {
				this.button.addClass(this.options.popup_opened_btn_class);

				var self = this;
				setTimeout(function () {
					if (self.opened) {
						self.button.addClass(self.options.popup_opened_btn_class);
					}
				}, 10);
			}
		},
		removeButtonPopupOpenedClass: function () {
			if (this.button && this.button.length > 0) {
				this.button.removeClass(this.options.popup_opened_btn_class);
			}
		},

		setDefaultRelativeTo: function () {
			this.options.relative_to_default = true;
			this.options.relative_to = null;
			var oSelf = this;
			this.button.parents().each(function () {
				if ($(this).css("position") === "fixed") {
					oSelf.options.relative_to = $(this);
					return false;
				}
			});
			if (this.options.relative_to === null) {
				this.options.relative_to = $(document.body);
			}
		},
		setRelativeToPosition: function () {
			var sRelativeToPosition = this.options.relative_to.css("position");
			if (sRelativeToPosition !== "relative" && sRelativeToPosition !== "absolute" && sRelativeToPosition !== "fixed") {
				this.options.relative_to.css("position", "relative");
				this.bRelativeToPosSet = true;
			}
		},
		unsetRelativeToPosition: function () {
			if (this.bRelativeToPosSet) {
				this.options.relative_to.css("position", "");
				this.bRelativeToPosSet = false;
			}
		},
		
		setContent: function (content) {
			this.popup
				.find('.x-popup-content')
				.empty()
				.append($(content));
			this.position();
			return this;
		},
		
		setPosition: function (position, set_default_on_error) {
			if (typeof position === 'object') {
				if (!position.v || !position.h || (position.v !== 'below' && position.v !== 'above') || (position.h !== 'right' && position.h !== 'center' && position.h !== 'left')) {
					if (set_default_on_error) {
						this.options.position = popup_options.position;
					}
					return false;
				}
				this.options.position = position;
				return true;
			}
			position = position.split(' ');
			if (position.length !== 2 || (position[0] !== 'below' && position[0] !== 'above') || (position[1] !== 'right' && position[1] !== 'center' && position[1] !== 'left')) {
				if (set_default_on_error) {
					this.options.position = popup_options.position;
				}
				return false;
			}
			this.options.position = {v: position[0], h: position[1]};
			return true;
		},
		position: function () {
			if (!this.popup) {
				return false;
			}
			
			var parent_offset = this.options.relative_to.offset(),
				button_offset = this.button.offset(),
				parent_notWindow_scroll = this.options.relative_to.is($(document.body)) || this.options.relative_to.is($(window)) ? 0 : this.options.relative_to.scrollTop();
			
			var top = button_offset.top - parent_offset.top + parent_notWindow_scroll,
				left = button_offset.left - parent_offset.left,
				bottom = false,
				right = false,
				arrow = this.popup.children('.x-popup-arrow');
			switch (this.options.position.v) {
				case "below":
					top += this.button.outerHeight();
					if (arrow.length > 0) {
						top += parseInt(arrow.css('border-bottom-width').replace('px', ''));
					}
					if (typeof this.options.offset.below === 'number') {
						top += this.options.offset.below;
					}
					break;
				case "above":
					bottom = this.options.relative_to.innerHeight() - top;
					if (arrow.length > 0) {
						bottom += parseInt(arrow.css('border-bottom-width').replace('px', ''));
					}
					if (typeof this.options.offset.above === 'number') {
						bottom += this.options.offset.above;
					}
					break;
			}
			switch (this.options.position.h) {
				case "right":
					right = this.options.relative_to.innerWidth() - left - this.button.outerWidth();
					var diffEdgeMinusPopupWidth = left - this.popup.outerWidth();
					if (diffEdgeMinusPopupWidth < 0) {
						right += Math.min(0, diffEdgeMinusPopupWidth);
					}
					if (typeof this.options.offset.right === 'number') {
						right += this.options.offset.right;
					}
					break;
				case "center":
					right = this.options.relative_to.innerWidth() - left - (this.button.outerWidth() / 2) - (this.popup.outerWidth() / 2);
					if (typeof this.options.offset.left === 'number') {
						right += this.options.offset.left;
					}
					break;
				case "left":
					if (typeof this.options.offset.left === 'number') {
						left += this.options.offset.left;
					}
					break;
			}
			if (typeof this.options.max_width === "function") {
				this.popup.find('.x-popup-content').css("max-width", this.options.max_width() + "px");
			}
			this.popup.css('max-width', 'none');
			if (right !== false) {
				this.popup.css('right', right + 'px');
				arrow.css('right', '');
			} else {
				this.popup.css('left', left + 'px');
				arrow.css('left', '');
			}
			if (bottom !== false) {
				this.popup.css('bottom', bottom + 'px');
			} else {
				this.popup.css('top', top + 'px');
			}
			var pos = this.popup.position();
			if (right !== false) {
				if (pos.left >= 2) {
					return true;
				}
				var w = this.popup.outerWidth(),
					maxw = $('body').outerWidth(true) - 4;
				if (w > maxw) {
					w = maxw;
					this.popup.css('max-width', w + 'px');
				}
				pos = this.popup.position();
				if (pos.left >= 2) {
					return true;
				}
				// var ar = parseInt(arrow.css('right').replace('px', ''));
				// this.popup.css('right', (right + pos.left - 2) + 'px');
				// arrow.css('right', (ar - pos.left + 2) + 'px');
				return true;
			}
			var w = this.popup.outerWidth(),
				maxw = $(document.body).outerWidth(true) - 2;
			if (pos.left + w <= maxw) {
				return true;
			}
			if (w > maxw - 2) {
				w = maxw - 2;
				this.popup.css('max-width', w + 'px');
			}
			var ar = parseInt(arrow.css('left').replace('px', '')),
				diff = pos.left + w - maxw;
			this.popup.css('left', (left - diff) + 'px');
			arrow.css('left', (ar + diff) + 'px');
			
			return true;
		},

		getCloseButtonHtml: function () {
			if (!this.options.closebtn) {
				return '';
			}
			return Mustache.render(this.options.template_close, {
				closebtn_content: this.options.closebtn_content
			});
		},

		createPopup: function () {
			if (this.popup) {
				var cur_popup_close = this.popup.children('.x-popup-close'),
					has_popup_close = cur_popup_close.length > 0;
				if (has_popup_close && !this.options.closebtn) {
					cur_popup_close.off('click').remove();
				} else if (!has_popup_close && this.options.closebtn) {
					this.popup.append($(this.getCloseButtonHtml()).on('click', this.close));
				}
				return this.popup;
			}

			this.popup = $(Mustache.render(this.options.template, {
				position: this.options.position.v + ' ' + this.options.position.h,
				cls: this.options.popup_class + (typeof this.options.popup_opened_class === 'string' ? ' ' + this.options.popup_opened_class : ''),
				closebtn: this.getCloseButtonHtml()
			}));

			var content;
			if (typeof this.content === 'function') {
				content = $(this.content());
			} else {
				content = $(this.content);
			}

			var contentnode = this.popup
				.find('.x-popup-content')
				.append(content);

			if (this.options.max_height > 0) {
				contentnode.css("max-height", this.options.max_height + "px");
			}
			if (this.options.max_width > 0) {
				contentnode.css("max-width", this.options.max_width + "px");
			}
			this.options.relative_to.append(this.popup);

			return this.popup;
		},
		deletePopup: function () {
			if (!!this.bRelativeToPosSet) {
				this.popup.remove();
			} else {
				var self = this;

				if (this.options.fade) {
					this.popup.fadeOut(function () {
						self.popup.remove();
					});
				} else {
					this.popup.remove();
				}
			}

			this.opened = false;
		},
		getPopup: function () {
			return this.popup;
		},
		hidePopup: function () {
			if (!!this.bRelativeToPosSet) {
				this.popup.hide();
			} else {
				if (this.options.fade) {
					this.popup.removeClass(this.options.popup_opened_class).fadeOut();
				} else {
					this.popup.removeClass(this.options.popup_opened_class).hide();
				}
			}

			this.opened = false;
		},
		showPopup: function () {
			this.opened = true;

			if (this.options.fade) {
				this.popup.addClass(this.options.popup_opened_class).fadeIn();
			} else {
				this.popup.addClass(this.options.popup_opened_class).show();
			}
		},
		isPopupOpened: function () {
			return this.opened;
		},

		open: function (event) {
			if (event) {
				if (typeof event === "string") {
					this.opened_with = event;
				} else {
					event.preventDefault();
					event.stopPropagation();
					this.opened_with = event.type;
				}
			} else {
				this.opened_with = "no_event";
			}
			
			this.closeSameLevelPopups();
			this.setRelativeToPosition();
			this.createPopup();
			this.setupAutoClose();
			this.addButtonPopupOpenedClass();
			this.position();

			if (this.opened) {
				return;
			}

			this.showPopup();
			this.addPopupListeners();

			if (this.onOpen) {
				this.onOpen();
			}

			if (!!this.options.no_dispatch_event) {
				return;
			}
			this.dispatchPopupOpenEvent();
		},
		close: function (event, delete_elem) {
			if (event && typeof event === "object") {
				event.preventDefault();
				event.stopPropagation();
				this.opened_with = event.type;
			}
			
			if (!this.opened) {
				return;
			}

			this.opened_with = false;
			this.popup.stop();

			this.removePopupListeners();

			if (delete_elem) {
				this.deletePopup();
			} else {
				this.hidePopup();
			}

			this.unsetRelativeToPosition();
			this.removeButtonPopupOpenedClass();

			this.button.blur();

			if (this.onClose) {
				this.onClose();
			}
		},
		closeSameLevelPopups: function () {
			if (!this.autoclose_level) {
				return false;
			}
			for (var i in popups) {
				if (popups[i].autoclose_level === this.autoclose_level && popups[i].uniqid !== this.uniqid) {
					popups[i].close();
				}
			}
		},
		delete: function () {
			this.close(null, true);
		},
		toggle: function (event) {
			if (this.opened) {
				this.close(event);
				return;
			}
			this.open(event);
		},


		dispatchPopupOpenEvent: function () {
			var evt = new Event('popupOpen', {bubbles: true, cancelable: true});
			this.getContextMenu().dispatchEvent(evt);
		},
		getContextMenu: function() {
			return this.getPopup().get(0);
		},

		addMouseOverOpenFunc: function () {
			if (this.mouseout_close_timeout) {
				clearTimeout(this.mouseout_close_timeout);
				this.mouseout_close_timeout = false;
			}
			if (this.mouseover_open_timeout) {
				return;
			}
			if (this.options.mouseover_open) {
				var self = this;
				this.mouseover_open_timeout = setTimeout(function () {
					self.mouseover_open_timeout = false;
					if (self.isPopupOpened()) {
						return;
					}
					self.opened_with = "mouseover_btn_timer";
					self.open();
				}, this.options.mouseover_open);
			}
		},
		addMouseOutCloseFunc: function () {
			if (this.mouseover_open_timeout) {
				clearTimeout(this.mouseover_open_timeout);
				this.mouseover_open_timeout = false;
			}
			if (this.mouseout_close_timeout) {
				clearTimeout(this.mouseout_close_timeout);
				this.mouseout_close_timeout = false;
			}
			var out_timer = typeof this.options.autoclose === "number" ? this.options.autoclose : (this.options.mouseout_autoclose ? this.options.mouseout_autoclose : false);
			if (out_timer) {
				var self = this;
				this.mouseout_close_timeout = setTimeout(function () {
					self.mouseout_close_timeout = false;
					if (!self.popup_hovered && !self.button_hovered && (typeof self.options.autoclose === "number" || self.options.mouseout_autoclose_openevents.indexOf(self.opened_with) !== -1)) {
						self.close();
					}
				}, out_timer);
			}
		},
		
		callbackButtonTrigger: function (event) {
			event.data.toggle(event);
		},
		callbackButtonTriggerOpen: function (event) {
			event.data.open(event);
		},
		callbackButtonTriggerClose: function (event) {
			if (event.data.options.trigger_close_openevents.indexOf(event.data.opened_with) !== -1) {
				event.data.close(event);
			}
		},
		onMouseOverButton: function (event) {
			event.data.button_hovered = true;
			event.data.addMouseOverOpenFunc();
		},
		onMouseOutButton: function (event) {
			event.data.button_hovered = false;
			event.data.addMouseOutCloseFunc();
		},

		onClickPopup: function (event) {
			event.stopPropagation();
		},
		onMouseOverPopup: function (event) {
			this.popup_hovered = true;
			if (this.mouseout_close_timeout) {
				clearTimeout(this.mouseout_close_timeout);
				this.mouseout_close_timeout = false;
			}
		},
		onMouseOutPopup: function (event) {
			this.popup_hovered = false;
			this.addMouseOutCloseFunc();
		},

		onScrollContextClose: function () {
			this.close();
		},

		addPopupListeners: function () {
			this.popup.on('click.popup', this.onClickPopup);
			this.popup.on("mouseover.popup", this.onMouseOverPopup.bind(this));
			this.popup.on("mouseout.popup", this.onMouseOutPopup.bind(this));

			if (this.options.close_on_scroll && this.options.close_on_scroll instanceof $) {
				this.options.close_on_scroll.on('scroll.popup', this.onScrollContextClose.bind(this));
			}
			if (this.options.closebtn) {
				this.popup.children('.x-popup-close').on('click.popup', this.close);
			}
		},
		removePopupListeners: function () {
			this.popup.off('.popup');

			if (this.options.close_on_scroll && this.options.close_on_scroll instanceof $) {
				this.options.close_on_scroll.off('.popup');
			}
			if (this.options.closebtn) {
				this.popup.children('.x-popup-close').off('.popup');
			}
		},

		setupAutoClose: function () {
			if (!this.options.autoclose) {
				return;
			}

			if (this.autoclose_timer !== false) {
				clearTimeout(this.autoclose_timer);
				this.autoclose_timer = false;
			}

			var self = this;

			if (typeof this.options.autoclose !== "number") {
				if (typeof this.closeOnBodyClick !== "function") {
					this.closeOnBodyClick = function (event) {
						if (self.opened) {
							self.close();
						}
					};
					$("body").on('click', this.closeOnBodyClick);
				}
			} else {
				if (typeof this.closeOnBodyClick === "function") {
					$("body").off('click', this.closeOnBodyClick);
					this.closeOnBodyClick = false;
				}

				this.autoclose_timer = setTimeout(function() {
					if (self.button_hovered || self.popup_hovered) {
						return;
					}
					self.close();
					self.autoclose_timer = false;
				}, this.options.autoclose);
			}
		},
		setupAutoCloseSameLevel: function () {
			if (this.options.autoclose_on_same_level) {
				if (typeof this.options.autoclose_on_same_level === "string" && !this.levels[this.options.autoclose_on_same_level]) {
					this.levels[this.options.autoclose_on_same_level] = this.options.autoclose_on_same_level.toUpperCase();
				}

				if (typeof this.levels[this.options.autoclose_on_same_level] === "string") {
					this.autoclose_level = this.levels[this.options.autoclose_on_same_level];
					this.uniqid = 'id-' + Math.random().toString(32).substring(2);
				} else {
					this.options.autoclose_on_same_level = false;
				}
			}
		},
		setupCloseOnResize: function () {
			if (this.options.close_on_resize) {
				this.options.iResizeLastWidth = $(window).outerWidth();
				var self = this;
				$(window).on('resize', function () {
					var iWindowWidth = $(window).outerWidth();
					if (self.options.iResizeLastWidth === iWindowWidth) {
						return false;
					}
					self.options.iResizeLastWidth = iWindowWidth;
					self.close();
				})
			}
		}
	};
	
	$(window).resize(function () {
		for (var p in popups) {
			if (popups[p].isPopupOpened()) {
				popups[p].position();
			}
		}
	});
	
	var scroll_timer;
	
	var on_scroll = function () {
		for (var p in popups) {
			if (popups[p].isPopupOpened() && popups[p].options.pos_on_scroll) {
				popups[p].position();
			}
		}
	};
	
	$(window).scroll(function () {
		if (scroll_timer) {
			window.clearTimeout(scroll_timer);
		}
		scroll_timer = window.setTimeout(on_scroll, 500);
	});
	
	return popup;
	
});

define('text!lib/helpers/popup/contextual_menu/menu.mustache',[],function () { return '<ul class="contextual-menu">\n{{#actions}}\n\t<li class="contextual-menu__item"><button class="contextual-menu__action{{#isActive}} is-active{{/isActive}}" data-action="{{name}}"{{#disabled}} disabled="disabled"{{/disabled}}>{{{label}}}{{#disabled}}{{#reason}}{{{reason}}}{{/reason}}{{/disabled}}</button></li>\n{{/actions}}\n</ul>\n';});

define('lib/helpers/popup/contextual_menu',[
	'mustache',
	'../popup',
	'text!./contextual_menu/menu.mustache'
], function (Mustache, Popup, tpl_menu) {
	/**
	 * Contextual menu.
	 *
	 * @param element {HTMLElement} Reference element that show/hide the menu.
	 * @param actions {Object[]} An array of actions ({label: '', callback: function () {}, callback_params: []})
	 * @param options {Object} A literal object that may contain these properties:
	 * @param options.enabled Add listeners on construct. Default: false.
	 * @param options.relative_to Default: null.
	 * @param options.relative_to_default Default: false.
	 * @param options.position Default: {v: 'below', h: 'right'}.
	 * @param options.offset Default: {below: 0, above: 0, left: 0, right: 0}.
	 * @param options.max_height Default: 0.
	 * @param options.max_width Default: 0.
	 * @param options.trigger Default: 'click'.
	 * @param options.trigger_open Default: false.
	 * @param options.trigger_close Default: false.
	 * @param options.trigger_close_openevents Default: ["all"].
	 * @param options.autoclose Default: true.
	 * @param options.closebtn Default: false.
	 * @param options.closebtn_content Default: '<span class="icon-f icf-close-thin"><span>x</span></span>'.
	 * @param options.template Default Mustache template string.
	 * @param options.template_close Default Mustache template string.
	 * @param options.popup_class Default: 'x-popup-contextual-menu'.
	 * @param options.pos_on_scroll Default: false.
	 * @param options.close_on_resize Default: true.
	 * @param options.close_on_scroll Default: false.
	 * @param options.autoclose_on_same_level Default: 'context_menu'.
	 * @param options.mouseout_autoclose_openevents Default: ["mouseover_btn_timer"].
	 * @param options.popup_opened_btn_class Default: 'popup-opened-btn'.
	 * @param options.popup_opened_class Default: 'popup-opened'.
	 * @param options.fade Default: false.
	 * @param options.on_open Callback to execute on open. Default: undefined.
	 * @param options.on_close Callback to execute on close. Default: undefined.
	 *
	 * @extends popup
	 */
	
	var contextual_menu_options = {
		popup_class: 'x-popup-contextual-menu',
		close_on_scroll: true,
		autoclose_on_same_level: 'context_menu',
		fade: false
	};
	
	var contextual_menu = function (element, actions, options) {
		if (element instanceof HTMLElement) {
			element = $(element);
		}

		this.actions = new Map();

		this.setActions(actions);
		
		Popup.call(this, element, this.renderActions(), $.extend({}, contextual_menu_options, options || {}));

		element[0].contextMenu = this;

		window.addEventListener('keyup', this.onKeyUp.bind(this));
	};
	
	contextual_menu.prototype = Object.create(Popup.prototype);
	
	// Event handlers
	contextual_menu.prototype.onActionClick = function (event) {
		var action_name = $(event.target).data('action');
		if (action_name) {
			var action = this.actions.get(event.target.dataset.action);
			action.callback.apply(this, action.callback_params);
			this.close();
		}
	}
	contextual_menu.prototype.onClose = function () {
		var _popup = this.getPopup();

		if (_popup == null || !this.onActionClickBinded) {
			return;
		}

		if (this.options.on_close && typeof this.options.on_close === "function") {
			this.options.on_close();
		}

		_popup.find('.contextual-menu__item button').off('click', this.onActionClickBinded);
	}
	contextual_menu.prototype.onOpen = function () {
		var _popup = this.getPopup();

		if (_popup == null) {
			return;
		}
		this.onActionClickBinded = this.onActionClick.bind(this);

		if (this.options.on_open && typeof this.options.on_open === "function") {
			this.options.on_open();
		}

		_popup.find('.contextual-menu__item button').on('click', this.onActionClickBinded);
	}
	contextual_menu.prototype.onClick = function (event) {
		this.close();
	}
	contextual_menu.prototype.onKeyUp = function (event) {
		if (event.keyCode === 27) { // Esc
			this.close();
		}
	}

	// Methods
	contextual_menu.prototype.disableAction = function (action_name, reason) {
		var action = this.getAction(action_name);

		if (!action) {
			return;
		}

		action.disabled = true;
		action.reason = reason ? '<small><i>' + reason + '</i></small>' : (action.reason || '');

		this.setAction(action);

		this.getContextMenu()
			.find('button[data-action="' + action_name + '"]')
			.attr('disabled', '')
			.append(action.reason);
	}
	contextual_menu.prototype.enableAction = function (action_name) {
		var action = this.getAction(action_name);

		if (!action) {
			return;
		}

		action.disabled = false;
		action.reason = '';

		this.setAction(action);

		this.getContextMenu()
			.find('button[data-action="' + action_name + '"]')
			.attr('disabled', null)
			.append(action.reason);
	}
	contextual_menu.prototype.getContextMenu = function () {
		return this.getPopup().get(0);
	}
	contextual_menu.prototype.getCoordinates = function (x, y, context) {
		var menu = this.getContextMenu(),
			coordinates = {x: x, y: y},
			menuWidth = menu.offsetWidth,
			menuHeight = menu.offsetHeight,
			contextWidth = context.innerWidth,
			contextHeight = context.innerHeight;

		if (contextWidth - x < menuWidth) {
			coordinates.x = x - menuWidth;
		}

		if (contextHeight - y < menuHeight) {
			coordinates.y = y - menuHeight;
		}

		return coordinates;
	}
	contextual_menu.prototype.open = function (event) {
		Popup.prototype.open.call(this, event);
	}
	contextual_menu.prototype.openAtPosition = function (x, y, context) {
		this.closeSameLevelPopups();
		this.open();
		this.setPositionToCoordinates(x, y, context);
	}
	contextual_menu.prototype.removeAction = function (action_name) {
		this.actions.delete(action_name);
		if (this.popup && this.popup.find('.x-popup-content').length) {
			this.content = this.renderActions();
			this.setContent(this.content);
		}
	}
	contextual_menu.prototype.renderActions = function () {
		return Mustache.render(tpl_menu, {actions: Array.from(this.actions.values())});
	}
	contextual_menu.prototype.setActions = function (actions) {
		if (!actions || !actions instanceof Array) {
			throw "actions argument must be an array";
		}

		actions.forEach(action => {
			this.setAction(action);
		});
	};
	contextual_menu.prototype.setPositionToCoordinates = function (x, y, context) {
		var _context = context || window,
			contextMenu = this.getContextMenu(),
			coordinates = this.getCoordinates(x, y, _context);

		contextMenu.style.left = `${coordinates.x}px`;
		contextMenu.style.top = `${coordinates.y}px`;
		contextMenu.style.bottom = `auto`;
		contextMenu.style.right = `auto`;
		// contextMenu.style.display = `block`;
	}

	// Accessors
	contextual_menu.prototype.getAction = function (action_name) {
		return this.actions.get(action_name);
	}
	contextual_menu.prototype.setAction = function (action) {
		if (typeof action.name !== "string" || !action.name) {
			throw 'the action must have a "name" property with a string value';
		}
		if (typeof action.label !== "string" || !action.label) {
			throw 'the action must have a "label" property with a string value';
		}
		if (typeof action.callback !== "function") {
			throw 'the action must have a "callback" property with a function value';
		}
		if (typeof action.callback_params !== "undefined" && !Array.isArray(action.callback_params)) {
			throw 'the action "before" property must be a string';
		}
		if (typeof action.before !== "undefined" && typeof action.before !== "string") {
			throw 'the action "before" property must be a string';
		}
		if (typeof action.position !== "undefined" && typeof action.position !== "number") {
			throw 'the action "position" property must be a number';
		}
		if (typeof action.disabled !== "undefined" && typeof action.disabled !== "boolean") {
			throw 'the action "disabled" property must be a boolean';
		}
		if (typeof action.reason !== "undefined" && typeof action.reason !== "string") {
			throw 'the action "reason" property must be a string';
		}

		var before_key = action.before,
			index = isNaN(action.position) ? false : action.position;

		if (index === false && before_key && this.actions.has(before_key)) {
			index = Array.from(this.actions.keys()).indexOf(before_key);
		}

		if (index !== false) {
			var arr = Array.from(this.actions.values());
			arr.splice(index, 0, action);
			this.actions = new Map(arr.map(action => [action.name, action]));
		} else {
			this.actions.set(action.name, action);
		}

		this.content = this.renderActions();

		if (this.popup && this.popup.find('.x-popup-content').length) {
			this.setContent(this.content);
		}
	}
	
	contextual_menu.get = function (element, actions, options) {
		return new contextual_menu(element, actions, options);
	};
	
	return contextual_menu;
	
});


/*!
 * Socket.IO v2.3.1
 * (c) 2014-2020 Guillermo Rauch
 * Released under the MIT License.
 */
!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define('libs/socket.io',[],e):"object"==typeof exports?exports.io=e():t.io=e()}(this,function(){return function(t){function e(r){if(n[r])return n[r].exports;var o=n[r]={exports:{},id:r,loaded:!1};return t[r].call(o.exports,o,o.exports,e),o.loaded=!0,o.exports}var n={};return e.m=t,e.c=n,e.p="",e(0)}([function(t,e,n){function r(t,e){"object"==typeof t&&(e=t,t=void 0),e=e||{};var n,r=o(t),i=r.source,p=r.id,u=r.path,h=c[p]&&u in c[p].nsps,f=e.forceNew||e["force new connection"]||!1===e.multiplex||h;return f?(a("ignoring socket cache for %s",i),n=s(i,e)):(c[p]||(a("new io instance for %s",i),c[p]=s(i,e)),n=c[p]),r.query&&!e.query&&(e.query=r.query),n.socket(r.path,e)}var o=n(1),i=n(7),s=n(12),a=n(3)("socket.io-client");t.exports=e=r;var c=e.managers={};e.protocol=i.protocol,e.connect=r,e.Manager=n(12),e.Socket=n(37)},function(t,e,n){function r(t,e){var n=t;e=e||"undefined"!=typeof location&&location,null==t&&(t=e.protocol+"//"+e.host),"string"==typeof t&&("/"===t.charAt(0)&&(t="/"===t.charAt(1)?e.protocol+t:e.host+t),/^(https?|wss?):\/\//.test(t)||(i("protocol-less url %s",t),t="undefined"!=typeof e?e.protocol+"//"+t:"https://"+t),i("parse %s",t),n=o(t)),n.port||(/^(http|ws)$/.test(n.protocol)?n.port="80":/^(http|ws)s$/.test(n.protocol)&&(n.port="443")),n.path=n.path||"/";var r=n.host.indexOf(":")!==-1,s=r?"["+n.host+"]":n.host;return n.id=n.protocol+"://"+s+":"+n.port,n.href=n.protocol+"://"+s+(e&&e.port===n.port?"":":"+n.port),n}var o=n(2),i=n(3)("socket.io-client:url");t.exports=r},function(t,e){function n(t,e){var n=/\/{2,9}/g,r=e.replace(n,"/").split("/");return"/"!=e.substr(0,1)&&0!==e.length||r.splice(0,1),"/"==e.substr(e.length-1,1)&&r.splice(r.length-1,1),r}function r(t,e){var n={};return e.replace(/(?:^|&)([^&=]*)=?([^&]*)/g,function(t,e,r){e&&(n[e]=r)}),n}var o=/^(?:(?![^:@]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,i=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];t.exports=function(t){var e=t,s=t.indexOf("["),a=t.indexOf("]");s!=-1&&a!=-1&&(t=t.substring(0,s)+t.substring(s,a).replace(/:/g,";")+t.substring(a,t.length));for(var c=o.exec(t||""),p={},u=14;u--;)p[i[u]]=c[u]||"";return s!=-1&&a!=-1&&(p.source=e,p.host=p.host.substring(1,p.host.length-1).replace(/;/g,":"),p.authority=p.authority.replace("[","").replace("]","").replace(/;/g,":"),p.ipv6uri=!0),p.pathNames=n(p,p.path),p.queryKey=r(p,p.query),p}},function(t,e,n){(function(r){"use strict";function o(){return!("undefined"==typeof window||!window.process||"renderer"!==window.process.type)||("undefined"==typeof navigator||!navigator.userAgent||!navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))&&("undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/))}function i(t){var n=this.useColors;if(t[0]=(n?"%c":"")+this.namespace+(n?" %c":" ")+t[0]+(n?"%c ":" ")+"+"+e.humanize(this.diff),n){var r="color: "+this.color;t.splice(1,0,r,"color: inherit");var o=0,i=0;t[0].replace(/%[a-zA-Z%]/g,function(t){"%%"!==t&&(o++,"%c"===t&&(i=o))}),t.splice(i,0,r)}}function s(){return"object"===("undefined"==typeof console?"undefined":u(console))&&console.log&&Function.prototype.apply.call(console.log,console,arguments)}function a(t){try{null==t?e.storage.removeItem("debug"):e.storage.debug=t}catch(n){}}function c(){var t;try{t=e.storage.debug}catch(n){}return!t&&"undefined"!=typeof r&&"env"in r&&(t=r.env.DEBUG),t}function p(){try{return window.localStorage}catch(t){}}var u="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};e=t.exports=n(5),e.log=s,e.formatArgs=i,e.save=a,e.load=c,e.useColors=o,e.storage="undefined"!=typeof chrome&&"undefined"!=typeof chrome.storage?chrome.storage.local:p(),e.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],e.formatters.j=function(t){try{return JSON.stringify(t)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}},e.enable(c())}).call(e,n(4))},function(t,e){function n(){throw new Error("setTimeout has not been defined")}function r(){throw new Error("clearTimeout has not been defined")}function o(t){if(u===setTimeout)return setTimeout(t,0);if((u===n||!u)&&setTimeout)return u=setTimeout,setTimeout(t,0);try{return u(t,0)}catch(e){try{return u.call(null,t,0)}catch(e){return u.call(this,t,0)}}}function i(t){if(h===clearTimeout)return clearTimeout(t);if((h===r||!h)&&clearTimeout)return h=clearTimeout,clearTimeout(t);try{return h(t)}catch(e){try{return h.call(null,t)}catch(e){return h.call(this,t)}}}function s(){y&&l&&(y=!1,l.length?d=l.concat(d):g=-1,d.length&&a())}function a(){if(!y){var t=o(s);y=!0;for(var e=d.length;e;){for(l=d,d=[];++g<e;)l&&l[g].run();g=-1,e=d.length}l=null,y=!1,i(t)}}function c(t,e){this.fun=t,this.array=e}function p(){}var u,h,f=t.exports={};!function(){try{u="function"==typeof setTimeout?setTimeout:n}catch(t){u=n}try{h="function"==typeof clearTimeout?clearTimeout:r}catch(t){h=r}}();var l,d=[],y=!1,g=-1;f.nextTick=function(t){var e=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)e[n-1]=arguments[n];d.push(new c(t,e)),1!==d.length||y||o(a)},c.prototype.run=function(){this.fun.apply(null,this.array)},f.title="browser",f.browser=!0,f.env={},f.argv=[],f.version="",f.versions={},f.on=p,f.addListener=p,f.once=p,f.off=p,f.removeListener=p,f.removeAllListeners=p,f.emit=p,f.prependListener=p,f.prependOnceListener=p,f.listeners=function(t){return[]},f.binding=function(t){throw new Error("process.binding is not supported")},f.cwd=function(){return"/"},f.chdir=function(t){throw new Error("process.chdir is not supported")},f.umask=function(){return 0}},function(t,e,n){"use strict";function r(t){var n,r=0;for(n in t)r=(r<<5)-r+t.charCodeAt(n),r|=0;return e.colors[Math.abs(r)%e.colors.length]}function o(t){function n(){if(n.enabled){var t=n,r=+new Date,i=r-(o||r);t.diff=i,t.prev=o,t.curr=r,o=r;for(var s=new Array(arguments.length),a=0;a<s.length;a++)s[a]=arguments[a];s[0]=e.coerce(s[0]),"string"!=typeof s[0]&&s.unshift("%O");var c=0;s[0]=s[0].replace(/%([a-zA-Z%])/g,function(n,r){if("%%"===n)return n;c++;var o=e.formatters[r];if("function"==typeof o){var i=s[c];n=o.call(t,i),s.splice(c,1),c--}return n}),e.formatArgs.call(t,s);var p=n.log||e.log||console.log.bind(console);p.apply(t,s)}}var o;return n.namespace=t,n.enabled=e.enabled(t),n.useColors=e.useColors(),n.color=r(t),n.destroy=i,"function"==typeof e.init&&e.init(n),e.instances.push(n),n}function i(){var t=e.instances.indexOf(this);return t!==-1&&(e.instances.splice(t,1),!0)}function s(t){e.save(t),e.names=[],e.skips=[];var n,r=("string"==typeof t?t:"").split(/[\s,]+/),o=r.length;for(n=0;n<o;n++)r[n]&&(t=r[n].replace(/\*/g,".*?"),"-"===t[0]?e.skips.push(new RegExp("^"+t.substr(1)+"$")):e.names.push(new RegExp("^"+t+"$")));for(n=0;n<e.instances.length;n++){var i=e.instances[n];i.enabled=e.enabled(i.namespace)}}function a(){e.enable("")}function c(t){if("*"===t[t.length-1])return!0;var n,r;for(n=0,r=e.skips.length;n<r;n++)if(e.skips[n].test(t))return!1;for(n=0,r=e.names.length;n<r;n++)if(e.names[n].test(t))return!0;return!1}function p(t){return t instanceof Error?t.stack||t.message:t}e=t.exports=o.debug=o["default"]=o,e.coerce=p,e.disable=a,e.enable=s,e.enabled=c,e.humanize=n(6),e.instances=[],e.names=[],e.skips=[],e.formatters={}},function(t,e){function n(t){if(t=String(t),!(t.length>100)){var e=/^((?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|years?|yrs?|y)?$/i.exec(t);if(e){var n=parseFloat(e[1]),r=(e[2]||"ms").toLowerCase();switch(r){case"years":case"year":case"yrs":case"yr":case"y":return n*u;case"days":case"day":case"d":return n*p;case"hours":case"hour":case"hrs":case"hr":case"h":return n*c;case"minutes":case"minute":case"mins":case"min":case"m":return n*a;case"seconds":case"second":case"secs":case"sec":case"s":return n*s;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return n;default:return}}}}function r(t){return t>=p?Math.round(t/p)+"d":t>=c?Math.round(t/c)+"h":t>=a?Math.round(t/a)+"m":t>=s?Math.round(t/s)+"s":t+"ms"}function o(t){return i(t,p,"day")||i(t,c,"hour")||i(t,a,"minute")||i(t,s,"second")||t+" ms"}function i(t,e,n){if(!(t<e))return t<1.5*e?Math.floor(t/e)+" "+n:Math.ceil(t/e)+" "+n+"s"}var s=1e3,a=60*s,c=60*a,p=24*c,u=365.25*p;t.exports=function(t,e){e=e||{};var i=typeof t;if("string"===i&&t.length>0)return n(t);if("number"===i&&isNaN(t)===!1)return e["long"]?o(t):r(t);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(t))}},function(t,e,n){function r(){}function o(t){var n=""+t.type;if(e.BINARY_EVENT!==t.type&&e.BINARY_ACK!==t.type||(n+=t.attachments+"-"),t.nsp&&"/"!==t.nsp&&(n+=t.nsp+","),null!=t.id&&(n+=t.id),null!=t.data){var r=i(t.data);if(r===!1)return m;n+=r}return f("encoded %j as %s",t,n),n}function i(t){try{return JSON.stringify(t)}catch(e){return!1}}function s(t,e){function n(t){var n=d.deconstructPacket(t),r=o(n.packet),i=n.buffers;i.unshift(r),e(i)}d.removeBlobs(t,n)}function a(){this.reconstructor=null}function c(t){var n=0,r={type:Number(t.charAt(0))};if(null==e.types[r.type])return h("unknown packet type "+r.type);if(e.BINARY_EVENT===r.type||e.BINARY_ACK===r.type){for(var o="";"-"!==t.charAt(++n)&&(o+=t.charAt(n),n!=t.length););if(o!=Number(o)||"-"!==t.charAt(n))throw new Error("Illegal attachments");r.attachments=Number(o)}if("/"===t.charAt(n+1))for(r.nsp="";++n;){var i=t.charAt(n);if(","===i)break;if(r.nsp+=i,n===t.length)break}else r.nsp="/";var s=t.charAt(n+1);if(""!==s&&Number(s)==s){for(r.id="";++n;){var i=t.charAt(n);if(null==i||Number(i)!=i){--n;break}if(r.id+=t.charAt(n),n===t.length)break}r.id=Number(r.id)}if(t.charAt(++n)){var a=p(t.substr(n)),c=a!==!1&&(r.type===e.ERROR||y(a));if(!c)return h("invalid payload");r.data=a}return f("decoded %s as %j",t,r),r}function p(t){try{return JSON.parse(t)}catch(e){return!1}}function u(t){this.reconPack=t,this.buffers=[]}function h(t){return{type:e.ERROR,data:"parser error: "+t}}var f=n(3)("socket.io-parser"),l=n(8),d=n(9),y=n(10),g=n(11);e.protocol=4,e.types=["CONNECT","DISCONNECT","EVENT","ACK","ERROR","BINARY_EVENT","BINARY_ACK"],e.CONNECT=0,e.DISCONNECT=1,e.EVENT=2,e.ACK=3,e.ERROR=4,e.BINARY_EVENT=5,e.BINARY_ACK=6,e.Encoder=r,e.Decoder=a;var m=e.ERROR+'"encode error"';r.prototype.encode=function(t,n){if(f("encoding packet %j",t),e.BINARY_EVENT===t.type||e.BINARY_ACK===t.type)s(t,n);else{var r=o(t);n([r])}},l(a.prototype),a.prototype.add=function(t){var n;if("string"==typeof t)n=c(t),e.BINARY_EVENT===n.type||e.BINARY_ACK===n.type?(this.reconstructor=new u(n),0===this.reconstructor.reconPack.attachments&&this.emit("decoded",n)):this.emit("decoded",n);else{if(!g(t)&&!t.base64)throw new Error("Unknown type: "+t);if(!this.reconstructor)throw new Error("got binary data when not reconstructing a packet");n=this.reconstructor.takeBinaryData(t),n&&(this.reconstructor=null,this.emit("decoded",n))}},a.prototype.destroy=function(){this.reconstructor&&this.reconstructor.finishedReconstruction()},u.prototype.takeBinaryData=function(t){if(this.buffers.push(t),this.buffers.length===this.reconPack.attachments){var e=d.reconstructPacket(this.reconPack,this.buffers);return this.finishedReconstruction(),e}return null},u.prototype.finishedReconstruction=function(){this.reconPack=null,this.buffers=[]}},function(t,e,n){function r(t){if(t)return o(t)}function o(t){for(var e in r.prototype)t[e]=r.prototype[e];return t}t.exports=r,r.prototype.on=r.prototype.addEventListener=function(t,e){return this._callbacks=this._callbacks||{},(this._callbacks["$"+t]=this._callbacks["$"+t]||[]).push(e),this},r.prototype.once=function(t,e){function n(){this.off(t,n),e.apply(this,arguments)}return n.fn=e,this.on(t,n),this},r.prototype.off=r.prototype.removeListener=r.prototype.removeAllListeners=r.prototype.removeEventListener=function(t,e){if(this._callbacks=this._callbacks||{},0==arguments.length)return this._callbacks={},this;var n=this._callbacks["$"+t];if(!n)return this;if(1==arguments.length)return delete this._callbacks["$"+t],this;for(var r,o=0;o<n.length;o++)if(r=n[o],r===e||r.fn===e){n.splice(o,1);break}return 0===n.length&&delete this._callbacks["$"+t],this},r.prototype.emit=function(t){this._callbacks=this._callbacks||{};for(var e=new Array(arguments.length-1),n=this._callbacks["$"+t],r=1;r<arguments.length;r++)e[r-1]=arguments[r];if(n){n=n.slice(0);for(var r=0,o=n.length;r<o;++r)n[r].apply(this,e)}return this},r.prototype.listeners=function(t){return this._callbacks=this._callbacks||{},this._callbacks["$"+t]||[]},r.prototype.hasListeners=function(t){return!!this.listeners(t).length}},function(t,e,n){function r(t,e){if(!t)return t;if(s(t)){var n={_placeholder:!0,num:e.length};return e.push(t),n}if(i(t)){for(var o=new Array(t.length),a=0;a<t.length;a++)o[a]=r(t[a],e);return o}if("object"==typeof t&&!(t instanceof Date)){var o={};for(var c in t)o[c]=r(t[c],e);return o}return t}function o(t,e){if(!t)return t;if(t&&t._placeholder)return e[t.num];if(i(t))for(var n=0;n<t.length;n++)t[n]=o(t[n],e);else if("object"==typeof t)for(var r in t)t[r]=o(t[r],e);return t}var i=n(10),s=n(11),a=Object.prototype.toString,c="function"==typeof Blob||"undefined"!=typeof Blob&&"[object BlobConstructor]"===a.call(Blob),p="function"==typeof File||"undefined"!=typeof File&&"[object FileConstructor]"===a.call(File);e.deconstructPacket=function(t){var e=[],n=t.data,o=t;return o.data=r(n,e),o.attachments=e.length,{packet:o,buffers:e}},e.reconstructPacket=function(t,e){return t.data=o(t.data,e),t.attachments=void 0,t},e.removeBlobs=function(t,e){function n(t,a,u){if(!t)return t;if(c&&t instanceof Blob||p&&t instanceof File){r++;var h=new FileReader;h.onload=function(){u?u[a]=this.result:o=this.result,--r||e(o)},h.readAsArrayBuffer(t)}else if(i(t))for(var f=0;f<t.length;f++)n(t[f],f,t);else if("object"==typeof t&&!s(t))for(var l in t)n(t[l],l,t)}var r=0,o=t;n(o),r||e(o)}},function(t,e){var n={}.toString;t.exports=Array.isArray||function(t){return"[object Array]"==n.call(t)}},function(t,e){function n(t){return r&&Buffer.isBuffer(t)||o&&(t instanceof ArrayBuffer||i(t))}t.exports=n;var r="function"==typeof Buffer&&"function"==typeof Buffer.isBuffer,o="function"==typeof ArrayBuffer,i=function(t){return"function"==typeof ArrayBuffer.isView?ArrayBuffer.isView(t):t.buffer instanceof ArrayBuffer}},function(t,e,n){function r(t,e){if(!(this instanceof r))return new r(t,e);t&&"object"==typeof t&&(e=t,t=void 0),e=e||{},e.path=e.path||"/socket.io",this.nsps={},this.subs=[],this.opts=e,this.reconnection(e.reconnection!==!1),this.reconnectionAttempts(e.reconnectionAttempts||1/0),this.reconnectionDelay(e.reconnectionDelay||1e3),this.reconnectionDelayMax(e.reconnectionDelayMax||5e3),this.randomizationFactor(e.randomizationFactor||.5),this.backoff=new f({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()}),this.timeout(null==e.timeout?2e4:e.timeout),this.readyState="closed",this.uri=t,this.connecting=[],this.lastPing=null,this.encoding=!1,this.packetBuffer=[];var n=e.parser||a;this.encoder=new n.Encoder,this.decoder=new n.Decoder,this.autoConnect=e.autoConnect!==!1,this.autoConnect&&this.open()}var o=n(13),i=n(37),s=n(8),a=n(7),c=n(39),p=n(40),u=n(3)("socket.io-client:manager"),h=n(36),f=n(41),l=Object.prototype.hasOwnProperty;t.exports=r,r.prototype.emitAll=function(){this.emit.apply(this,arguments);for(var t in this.nsps)l.call(this.nsps,t)&&this.nsps[t].emit.apply(this.nsps[t],arguments)},r.prototype.updateSocketIds=function(){for(var t in this.nsps)l.call(this.nsps,t)&&(this.nsps[t].id=this.generateId(t))},r.prototype.generateId=function(t){return("/"===t?"":t+"#")+this.engine.id},s(r.prototype),r.prototype.reconnection=function(t){return arguments.length?(this._reconnection=!!t,this):this._reconnection},r.prototype.reconnectionAttempts=function(t){return arguments.length?(this._reconnectionAttempts=t,this):this._reconnectionAttempts},r.prototype.reconnectionDelay=function(t){return arguments.length?(this._reconnectionDelay=t,this.backoff&&this.backoff.setMin(t),this):this._reconnectionDelay},r.prototype.randomizationFactor=function(t){return arguments.length?(this._randomizationFactor=t,this.backoff&&this.backoff.setJitter(t),this):this._randomizationFactor},r.prototype.reconnectionDelayMax=function(t){return arguments.length?(this._reconnectionDelayMax=t,this.backoff&&this.backoff.setMax(t),this):this._reconnectionDelayMax},r.prototype.timeout=function(t){return arguments.length?(this._timeout=t,this):this._timeout},r.prototype.maybeReconnectOnOpen=function(){!this.reconnecting&&this._reconnection&&0===this.backoff.attempts&&this.reconnect()},r.prototype.open=r.prototype.connect=function(t,e){if(u("readyState %s",this.readyState),~this.readyState.indexOf("open"))return this;u("opening %s",this.uri),this.engine=o(this.uri,this.opts);var n=this.engine,r=this;this.readyState="opening",this.skipReconnect=!1;var i=c(n,"open",function(){r.onopen(),t&&t()}),s=c(n,"error",function(e){if(u("connect_error"),r.cleanup(),r.readyState="closed",r.emitAll("connect_error",e),t){var n=new Error("Connection error");n.data=e,t(n)}else r.maybeReconnectOnOpen()});if(!1!==this._timeout){var a=this._timeout;u("connect attempt will timeout after %d",a),0===a&&i.destroy();var p=setTimeout(function(){u("connect attempt timed out after %d",a),i.destroy(),n.close(),n.emit("error","timeout"),r.emitAll("connect_timeout",a)},a);this.subs.push({destroy:function(){clearTimeout(p)}})}return this.subs.push(i),this.subs.push(s),this},r.prototype.onopen=function(){u("open"),this.cleanup(),this.readyState="open",this.emit("open");var t=this.engine;this.subs.push(c(t,"data",p(this,"ondata"))),this.subs.push(c(t,"ping",p(this,"onping"))),this.subs.push(c(t,"pong",p(this,"onpong"))),this.subs.push(c(t,"error",p(this,"onerror"))),this.subs.push(c(t,"close",p(this,"onclose"))),this.subs.push(c(this.decoder,"decoded",p(this,"ondecoded")))},r.prototype.onping=function(){this.lastPing=new Date,this.emitAll("ping")},r.prototype.onpong=function(){this.emitAll("pong",new Date-this.lastPing)},r.prototype.ondata=function(t){this.decoder.add(t)},r.prototype.ondecoded=function(t){this.emit("packet",t)},r.prototype.onerror=function(t){u("error",t),this.emitAll("error",t)},r.prototype.socket=function(t,e){function n(){~h(o.connecting,r)||o.connecting.push(r)}var r=this.nsps[t];if(!r){r=new i(this,t,e),this.nsps[t]=r;var o=this;r.on("connecting",n),r.on("connect",function(){r.id=o.generateId(t)}),this.autoConnect&&n()}return r},r.prototype.destroy=function(t){var e=h(this.connecting,t);~e&&this.connecting.splice(e,1),this.connecting.length||this.close()},r.prototype.packet=function(t){u("writing packet %j",t);var e=this;t.query&&0===t.type&&(t.nsp+="?"+t.query),e.encoding?e.packetBuffer.push(t):(e.encoding=!0,this.encoder.encode(t,function(n){for(var r=0;r<n.length;r++)e.engine.write(n[r],t.options);e.encoding=!1,e.processPacketQueue()}))},r.prototype.processPacketQueue=function(){if(this.packetBuffer.length>0&&!this.encoding){var t=this.packetBuffer.shift();this.packet(t)}},r.prototype.cleanup=function(){u("cleanup");for(var t=this.subs.length,e=0;e<t;e++){var n=this.subs.shift();n.destroy()}this.packetBuffer=[],this.encoding=!1,this.lastPing=null,this.decoder.destroy()},r.prototype.close=r.prototype.disconnect=function(){u("disconnect"),this.skipReconnect=!0,this.reconnecting=!1,"opening"===this.readyState&&this.cleanup(),this.backoff.reset(),this.readyState="closed",this.engine&&this.engine.close()},r.prototype.onclose=function(t){u("onclose"),this.cleanup(),this.backoff.reset(),this.readyState="closed",this.emit("close",t),this._reconnection&&!this.skipReconnect&&this.reconnect()},r.prototype.reconnect=function(){if(this.reconnecting||this.skipReconnect)return this;var t=this;if(this.backoff.attempts>=this._reconnectionAttempts)u("reconnect failed"),this.backoff.reset(),this.emitAll("reconnect_failed"),this.reconnecting=!1;else{var e=this.backoff.duration();u("will wait %dms before reconnect attempt",e),this.reconnecting=!0;var n=setTimeout(function(){t.skipReconnect||(u("attempting reconnect"),t.emitAll("reconnect_attempt",t.backoff.attempts),t.emitAll("reconnecting",t.backoff.attempts),t.skipReconnect||t.open(function(e){e?(u("reconnect attempt error"),t.reconnecting=!1,t.reconnect(),t.emitAll("reconnect_error",e.data)):(u("reconnect success"),t.onreconnect())}))},e);this.subs.push({destroy:function(){clearTimeout(n)}})}},r.prototype.onreconnect=function(){var t=this.backoff.attempts;this.reconnecting=!1,this.backoff.reset(),this.updateSocketIds(),this.emitAll("reconnect",t)}},function(t,e,n){t.exports=n(14),t.exports.parser=n(22)},function(t,e,n){function r(t,e){return this instanceof r?(e=e||{},t&&"object"==typeof t&&(e=t,t=null),t?(t=u(t),e.hostname=t.host,e.secure="https"===t.protocol||"wss"===t.protocol,e.port=t.port,t.query&&(e.query=t.query)):e.host&&(e.hostname=u(e.host).host),this.secure=null!=e.secure?e.secure:"undefined"!=typeof location&&"https:"===location.protocol,e.hostname&&!e.port&&(e.port=this.secure?"443":"80"),this.agent=e.agent||!1,this.hostname=e.hostname||("undefined"!=typeof location?location.hostname:"localhost"),this.port=e.port||("undefined"!=typeof location&&location.port?location.port:this.secure?443:80),this.query=e.query||{},"string"==typeof this.query&&(this.query=h.decode(this.query)),this.upgrade=!1!==e.upgrade,this.path=(e.path||"/engine.io").replace(/\/$/,"")+"/",this.forceJSONP=!!e.forceJSONP,this.jsonp=!1!==e.jsonp,this.forceBase64=!!e.forceBase64,this.enablesXDR=!!e.enablesXDR,this.withCredentials=!1!==e.withCredentials,this.timestampParam=e.timestampParam||"t",this.timestampRequests=e.timestampRequests,this.transports=e.transports||["polling","websocket"],this.transportOptions=e.transportOptions||{},this.readyState="",this.writeBuffer=[],this.prevBufferLen=0,this.policyPort=e.policyPort||843,this.rememberUpgrade=e.rememberUpgrade||!1,this.binaryType=null,this.onlyBinaryUpgrades=e.onlyBinaryUpgrades,this.perMessageDeflate=!1!==e.perMessageDeflate&&(e.perMessageDeflate||{}),!0===this.perMessageDeflate&&(this.perMessageDeflate={}),this.perMessageDeflate&&null==this.perMessageDeflate.threshold&&(this.perMessageDeflate.threshold=1024),this.pfx=e.pfx||null,this.key=e.key||null,this.passphrase=e.passphrase||null,this.cert=e.cert||null,this.ca=e.ca||null,this.ciphers=e.ciphers||null,this.rejectUnauthorized=void 0===e.rejectUnauthorized||e.rejectUnauthorized,this.forceNode=!!e.forceNode,this.isReactNative="undefined"!=typeof navigator&&"string"==typeof navigator.product&&"reactnative"===navigator.product.toLowerCase(),("undefined"==typeof self||this.isReactNative)&&(e.extraHeaders&&Object.keys(e.extraHeaders).length>0&&(this.extraHeaders=e.extraHeaders),e.localAddress&&(this.localAddress=e.localAddress)),this.id=null,this.upgrades=null,this.pingInterval=null,this.pingTimeout=null,this.pingIntervalTimer=null,this.pingTimeoutTimer=null,void this.open()):new r(t,e)}function o(t){var e={};for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e}var i=n(15),s=n(8),a=n(3)("engine.io-client:socket"),c=n(36),p=n(22),u=n(2),h=n(30);t.exports=r,r.priorWebsocketSuccess=!1,s(r.prototype),r.protocol=p.protocol,r.Socket=r,r.Transport=n(21),r.transports=n(15),r.parser=n(22),r.prototype.createTransport=function(t){a('creating transport "%s"',t);var e=o(this.query);e.EIO=p.protocol,e.transport=t;var n=this.transportOptions[t]||{};this.id&&(e.sid=this.id);var r=new i[t]({query:e,socket:this,agent:n.agent||this.agent,hostname:n.hostname||this.hostname,port:n.port||this.port,secure:n.secure||this.secure,path:n.path||this.path,forceJSONP:n.forceJSONP||this.forceJSONP,jsonp:n.jsonp||this.jsonp,forceBase64:n.forceBase64||this.forceBase64,enablesXDR:n.enablesXDR||this.enablesXDR,withCredentials:n.withCredentials||this.withCredentials,timestampRequests:n.timestampRequests||this.timestampRequests,timestampParam:n.timestampParam||this.timestampParam,policyPort:n.policyPort||this.policyPort,pfx:n.pfx||this.pfx,key:n.key||this.key,passphrase:n.passphrase||this.passphrase,cert:n.cert||this.cert,ca:n.ca||this.ca,ciphers:n.ciphers||this.ciphers,rejectUnauthorized:n.rejectUnauthorized||this.rejectUnauthorized,perMessageDeflate:n.perMessageDeflate||this.perMessageDeflate,extraHeaders:n.extraHeaders||this.extraHeaders,forceNode:n.forceNode||this.forceNode,localAddress:n.localAddress||this.localAddress,requestTimeout:n.requestTimeout||this.requestTimeout,protocols:n.protocols||void 0,isReactNative:this.isReactNative});return r},r.prototype.open=function(){var t;if(this.rememberUpgrade&&r.priorWebsocketSuccess&&this.transports.indexOf("websocket")!==-1)t="websocket";else{if(0===this.transports.length){var e=this;return void setTimeout(function(){e.emit("error","No transports available")},0)}t=this.transports[0]}this.readyState="opening";try{t=this.createTransport(t)}catch(n){return this.transports.shift(),void this.open()}t.open(),this.setTransport(t)},r.prototype.setTransport=function(t){a("setting transport %s",t.name);var e=this;this.transport&&(a("clearing existing transport %s",this.transport.name),this.transport.removeAllListeners()),this.transport=t,t.on("drain",function(){e.onDrain()}).on("packet",function(t){e.onPacket(t)}).on("error",function(t){e.onError(t)}).on("close",function(){e.onClose("transport close")})},r.prototype.probe=function(t){function e(){if(f.onlyBinaryUpgrades){var e=!this.supportsBinary&&f.transport.supportsBinary;h=h||e}h||(a('probe transport "%s" opened',t),u.send([{type:"ping",data:"probe"}]),u.once("packet",function(e){if(!h)if("pong"===e.type&&"probe"===e.data){if(a('probe transport "%s" pong',t),f.upgrading=!0,f.emit("upgrading",u),!u)return;r.priorWebsocketSuccess="websocket"===u.name,a('pausing current transport "%s"',f.transport.name),f.transport.pause(function(){h||"closed"!==f.readyState&&(a("changing transport and sending upgrade packet"),p(),f.setTransport(u),u.send([{type:"upgrade"}]),f.emit("upgrade",u),u=null,f.upgrading=!1,f.flush())})}else{a('probe transport "%s" failed',t);var n=new Error("probe error");n.transport=u.name,f.emit("upgradeError",n)}}))}function n(){h||(h=!0,p(),u.close(),u=null)}function o(e){var r=new Error("probe error: "+e);r.transport=u.name,n(),a('probe transport "%s" failed because of error: %s',t,e),f.emit("upgradeError",r)}function i(){o("transport closed")}function s(){o("socket closed")}function c(t){u&&t.name!==u.name&&(a('"%s" works - aborting "%s"',t.name,u.name),n())}function p(){u.removeListener("open",e),u.removeListener("error",o),u.removeListener("close",i),f.removeListener("close",s),f.removeListener("upgrading",c)}a('probing transport "%s"',t);var u=this.createTransport(t,{probe:1}),h=!1,f=this;r.priorWebsocketSuccess=!1,u.once("open",e),u.once("error",o),u.once("close",i),this.once("close",s),this.once("upgrading",c),u.open()},r.prototype.onOpen=function(){if(a("socket open"),this.readyState="open",r.priorWebsocketSuccess="websocket"===this.transport.name,this.emit("open"),this.flush(),"open"===this.readyState&&this.upgrade&&this.transport.pause){a("starting upgrade probes");for(var t=0,e=this.upgrades.length;t<e;t++)this.probe(this.upgrades[t])}},r.prototype.onPacket=function(t){if("opening"===this.readyState||"open"===this.readyState||"closing"===this.readyState)switch(a('socket receive: type "%s", data "%s"',t.type,t.data),this.emit("packet",t),this.emit("heartbeat"),t.type){case"open":this.onHandshake(JSON.parse(t.data));break;case"pong":this.setPing(),this.emit("pong");break;case"error":var e=new Error("server error");e.code=t.data,this.onError(e);break;case"message":this.emit("data",t.data),this.emit("message",t.data)}else a('packet received with socket readyState "%s"',this.readyState)},r.prototype.onHandshake=function(t){this.emit("handshake",t),this.id=t.sid,this.transport.query.sid=t.sid,this.upgrades=this.filterUpgrades(t.upgrades),this.pingInterval=t.pingInterval,this.pingTimeout=t.pingTimeout,this.onOpen(),"closed"!==this.readyState&&(this.setPing(),this.removeListener("heartbeat",this.onHeartbeat),this.on("heartbeat",this.onHeartbeat))},r.prototype.onHeartbeat=function(t){clearTimeout(this.pingTimeoutTimer);var e=this;e.pingTimeoutTimer=setTimeout(function(){"closed"!==e.readyState&&e.onClose("ping timeout")},t||e.pingInterval+e.pingTimeout)},r.prototype.setPing=function(){var t=this;clearTimeout(t.pingIntervalTimer),t.pingIntervalTimer=setTimeout(function(){a("writing ping packet - expecting pong within %sms",t.pingTimeout),t.ping(),t.onHeartbeat(t.pingTimeout)},t.pingInterval)},r.prototype.ping=function(){var t=this;this.sendPacket("ping",function(){t.emit("ping")})},r.prototype.onDrain=function(){this.writeBuffer.splice(0,this.prevBufferLen),this.prevBufferLen=0,0===this.writeBuffer.length?this.emit("drain"):this.flush()},r.prototype.flush=function(){"closed"!==this.readyState&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length&&(a("flushing %d packets in socket",this.writeBuffer.length),this.transport.send(this.writeBuffer),this.prevBufferLen=this.writeBuffer.length,this.emit("flush"))},r.prototype.write=r.prototype.send=function(t,e,n){return this.sendPacket("message",t,e,n),this},r.prototype.sendPacket=function(t,e,n,r){if("function"==typeof e&&(r=e,e=void 0),"function"==typeof n&&(r=n,n=null),"closing"!==this.readyState&&"closed"!==this.readyState){n=n||{},n.compress=!1!==n.compress;var o={type:t,data:e,options:n};this.emit("packetCreate",o),this.writeBuffer.push(o),r&&this.once("flush",r),this.flush()}},r.prototype.close=function(){function t(){r.onClose("forced close"),a("socket closing - telling transport to close"),r.transport.close()}function e(){r.removeListener("upgrade",e),r.removeListener("upgradeError",e),t()}function n(){r.once("upgrade",e),r.once("upgradeError",e)}if("opening"===this.readyState||"open"===this.readyState){this.readyState="closing";var r=this;this.writeBuffer.length?this.once("drain",function(){this.upgrading?n():t()}):this.upgrading?n():t()}return this},r.prototype.onError=function(t){a("socket error %j",t),r.priorWebsocketSuccess=!1,this.emit("error",t),this.onClose("transport error",t)},r.prototype.onClose=function(t,e){if("opening"===this.readyState||"open"===this.readyState||"closing"===this.readyState){a('socket close with reason: "%s"',t);var n=this;clearTimeout(this.pingIntervalTimer),clearTimeout(this.pingTimeoutTimer),this.transport.removeAllListeners("close"),this.transport.close(),
this.transport.removeAllListeners(),this.readyState="closed",this.id=null,this.emit("close",t,e),n.writeBuffer=[],n.prevBufferLen=0}},r.prototype.filterUpgrades=function(t){for(var e=[],n=0,r=t.length;n<r;n++)~c(this.transports,t[n])&&e.push(t[n]);return e}},function(t,e,n){function r(t){var e,n=!1,r=!1,a=!1!==t.jsonp;if("undefined"!=typeof location){var c="https:"===location.protocol,p=location.port;p||(p=c?443:80),n=t.hostname!==location.hostname||p!==t.port,r=t.secure!==c}if(t.xdomain=n,t.xscheme=r,e=new o(t),"open"in e&&!t.forceJSONP)return new i(t);if(!a)throw new Error("JSONP disabled");return new s(t)}var o=n(16),i=n(19),s=n(33),a=n(34);e.polling=r,e.websocket=a},function(t,e,n){var r=n(17),o=n(18);t.exports=function(t){var e=t.xdomain,n=t.xscheme,i=t.enablesXDR;try{if("undefined"!=typeof XMLHttpRequest&&(!e||r))return new XMLHttpRequest}catch(s){}try{if("undefined"!=typeof XDomainRequest&&!n&&i)return new XDomainRequest}catch(s){}if(!e)try{return new(o[["Active"].concat("Object").join("X")])("Microsoft.XMLHTTP")}catch(s){}}},function(t,e){try{t.exports="undefined"!=typeof XMLHttpRequest&&"withCredentials"in new XMLHttpRequest}catch(n){t.exports=!1}},function(t,e){t.exports=function(){return"undefined"!=typeof self?self:"undefined"!=typeof window?window:Function("return this")()}()},function(t,e,n){function r(){}function o(t){if(c.call(this,t),this.requestTimeout=t.requestTimeout,this.extraHeaders=t.extraHeaders,"undefined"!=typeof location){var e="https:"===location.protocol,n=location.port;n||(n=e?443:80),this.xd="undefined"!=typeof location&&t.hostname!==location.hostname||n!==t.port,this.xs=t.secure!==e}}function i(t){this.method=t.method||"GET",this.uri=t.uri,this.xd=!!t.xd,this.xs=!!t.xs,this.async=!1!==t.async,this.data=void 0!==t.data?t.data:null,this.agent=t.agent,this.isBinary=t.isBinary,this.supportsBinary=t.supportsBinary,this.enablesXDR=t.enablesXDR,this.withCredentials=t.withCredentials,this.requestTimeout=t.requestTimeout,this.pfx=t.pfx,this.key=t.key,this.passphrase=t.passphrase,this.cert=t.cert,this.ca=t.ca,this.ciphers=t.ciphers,this.rejectUnauthorized=t.rejectUnauthorized,this.extraHeaders=t.extraHeaders,this.create()}function s(){for(var t in i.requests)i.requests.hasOwnProperty(t)&&i.requests[t].abort()}var a=n(16),c=n(20),p=n(8),u=n(31),h=n(3)("engine.io-client:polling-xhr"),f=n(18);if(t.exports=o,t.exports.Request=i,u(o,c),o.prototype.supportsBinary=!0,o.prototype.request=function(t){return t=t||{},t.uri=this.uri(),t.xd=this.xd,t.xs=this.xs,t.agent=this.agent||!1,t.supportsBinary=this.supportsBinary,t.enablesXDR=this.enablesXDR,t.withCredentials=this.withCredentials,t.pfx=this.pfx,t.key=this.key,t.passphrase=this.passphrase,t.cert=this.cert,t.ca=this.ca,t.ciphers=this.ciphers,t.rejectUnauthorized=this.rejectUnauthorized,t.requestTimeout=this.requestTimeout,t.extraHeaders=this.extraHeaders,new i(t)},o.prototype.doWrite=function(t,e){var n="string"!=typeof t&&void 0!==t,r=this.request({method:"POST",data:t,isBinary:n}),o=this;r.on("success",e),r.on("error",function(t){o.onError("xhr post error",t)}),this.sendXhr=r},o.prototype.doPoll=function(){h("xhr poll");var t=this.request(),e=this;t.on("data",function(t){e.onData(t)}),t.on("error",function(t){e.onError("xhr poll error",t)}),this.pollXhr=t},p(i.prototype),i.prototype.create=function(){var t={agent:this.agent,xdomain:this.xd,xscheme:this.xs,enablesXDR:this.enablesXDR};t.pfx=this.pfx,t.key=this.key,t.passphrase=this.passphrase,t.cert=this.cert,t.ca=this.ca,t.ciphers=this.ciphers,t.rejectUnauthorized=this.rejectUnauthorized;var e=this.xhr=new a(t),n=this;try{h("xhr open %s: %s",this.method,this.uri),e.open(this.method,this.uri,this.async);try{if(this.extraHeaders){e.setDisableHeaderCheck&&e.setDisableHeaderCheck(!0);for(var r in this.extraHeaders)this.extraHeaders.hasOwnProperty(r)&&e.setRequestHeader(r,this.extraHeaders[r])}}catch(o){}if("POST"===this.method)try{this.isBinary?e.setRequestHeader("Content-type","application/octet-stream"):e.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch(o){}try{e.setRequestHeader("Accept","*/*")}catch(o){}"withCredentials"in e&&(e.withCredentials=this.withCredentials),this.requestTimeout&&(e.timeout=this.requestTimeout),this.hasXDR()?(e.onload=function(){n.onLoad()},e.onerror=function(){n.onError(e.responseText)}):e.onreadystatechange=function(){if(2===e.readyState)try{var t=e.getResponseHeader("Content-Type");(n.supportsBinary&&"application/octet-stream"===t||"application/octet-stream; charset=UTF-8"===t)&&(e.responseType="arraybuffer")}catch(r){}4===e.readyState&&(200===e.status||1223===e.status?n.onLoad():setTimeout(function(){n.onError("number"==typeof e.status?e.status:0)},0))},h("xhr data %s",this.data),e.send(this.data)}catch(o){return void setTimeout(function(){n.onError(o)},0)}"undefined"!=typeof document&&(this.index=i.requestsCount++,i.requests[this.index]=this)},i.prototype.onSuccess=function(){this.emit("success"),this.cleanup()},i.prototype.onData=function(t){this.emit("data",t),this.onSuccess()},i.prototype.onError=function(t){this.emit("error",t),this.cleanup(!0)},i.prototype.cleanup=function(t){if("undefined"!=typeof this.xhr&&null!==this.xhr){if(this.hasXDR()?this.xhr.onload=this.xhr.onerror=r:this.xhr.onreadystatechange=r,t)try{this.xhr.abort()}catch(e){}"undefined"!=typeof document&&delete i.requests[this.index],this.xhr=null}},i.prototype.onLoad=function(){var t;try{var e;try{e=this.xhr.getResponseHeader("Content-Type")}catch(n){}t="application/octet-stream"===e||"application/octet-stream; charset=UTF-8"===e?this.xhr.response||this.xhr.responseText:this.xhr.responseText}catch(n){this.onError(n)}null!=t&&this.onData(t)},i.prototype.hasXDR=function(){return"undefined"!=typeof XDomainRequest&&!this.xs&&this.enablesXDR},i.prototype.abort=function(){this.cleanup()},i.requestsCount=0,i.requests={},"undefined"!=typeof document)if("function"==typeof attachEvent)attachEvent("onunload",s);else if("function"==typeof addEventListener){var l="onpagehide"in f?"pagehide":"unload";addEventListener(l,s,!1)}},function(t,e,n){function r(t){var e=t&&t.forceBase64;u&&!e||(this.supportsBinary=!1),o.call(this,t)}var o=n(21),i=n(30),s=n(22),a=n(31),c=n(32),p=n(3)("engine.io-client:polling");t.exports=r;var u=function(){var t=n(16),e=new t({xdomain:!1});return null!=e.responseType}();a(r,o),r.prototype.name="polling",r.prototype.doOpen=function(){this.poll()},r.prototype.pause=function(t){function e(){p("paused"),n.readyState="paused",t()}var n=this;if(this.readyState="pausing",this.polling||!this.writable){var r=0;this.polling&&(p("we are currently polling - waiting to pause"),r++,this.once("pollComplete",function(){p("pre-pause polling complete"),--r||e()})),this.writable||(p("we are currently writing - waiting to pause"),r++,this.once("drain",function(){p("pre-pause writing complete"),--r||e()}))}else e()},r.prototype.poll=function(){p("polling"),this.polling=!0,this.doPoll(),this.emit("poll")},r.prototype.onData=function(t){var e=this;p("polling got data %s",t);var n=function(t,n,r){return"opening"===e.readyState&&e.onOpen(),"close"===t.type?(e.onClose(),!1):void e.onPacket(t)};s.decodePayload(t,this.socket.binaryType,n),"closed"!==this.readyState&&(this.polling=!1,this.emit("pollComplete"),"open"===this.readyState?this.poll():p('ignoring poll - transport state "%s"',this.readyState))},r.prototype.doClose=function(){function t(){p("writing close packet"),e.write([{type:"close"}])}var e=this;"open"===this.readyState?(p("transport open - closing"),t()):(p("transport not open - deferring close"),this.once("open",t))},r.prototype.write=function(t){var e=this;this.writable=!1;var n=function(){e.writable=!0,e.emit("drain")};s.encodePayload(t,this.supportsBinary,function(t){e.doWrite(t,n)})},r.prototype.uri=function(){var t=this.query||{},e=this.secure?"https":"http",n="";!1!==this.timestampRequests&&(t[this.timestampParam]=c()),this.supportsBinary||t.sid||(t.b64=1),t=i.encode(t),this.port&&("https"===e&&443!==Number(this.port)||"http"===e&&80!==Number(this.port))&&(n=":"+this.port),t.length&&(t="?"+t);var r=this.hostname.indexOf(":")!==-1;return e+"://"+(r?"["+this.hostname+"]":this.hostname)+n+this.path+t}},function(t,e,n){function r(t){this.path=t.path,this.hostname=t.hostname,this.port=t.port,this.secure=t.secure,this.query=t.query,this.timestampParam=t.timestampParam,this.timestampRequests=t.timestampRequests,this.readyState="",this.agent=t.agent||!1,this.socket=t.socket,this.enablesXDR=t.enablesXDR,this.withCredentials=t.withCredentials,this.pfx=t.pfx,this.key=t.key,this.passphrase=t.passphrase,this.cert=t.cert,this.ca=t.ca,this.ciphers=t.ciphers,this.rejectUnauthorized=t.rejectUnauthorized,this.forceNode=t.forceNode,this.isReactNative=t.isReactNative,this.extraHeaders=t.extraHeaders,this.localAddress=t.localAddress}var o=n(22),i=n(8);t.exports=r,i(r.prototype),r.prototype.onError=function(t,e){var n=new Error(t);return n.type="TransportError",n.description=e,this.emit("error",n),this},r.prototype.open=function(){return"closed"!==this.readyState&&""!==this.readyState||(this.readyState="opening",this.doOpen()),this},r.prototype.close=function(){return"opening"!==this.readyState&&"open"!==this.readyState||(this.doClose(),this.onClose()),this},r.prototype.send=function(t){if("open"!==this.readyState)throw new Error("Transport not open");this.write(t)},r.prototype.onOpen=function(){this.readyState="open",this.writable=!0,this.emit("open")},r.prototype.onData=function(t){var e=o.decodePacket(t,this.socket.binaryType);this.onPacket(e)},r.prototype.onPacket=function(t){this.emit("packet",t)},r.prototype.onClose=function(){this.readyState="closed",this.emit("close")}},function(t,e,n){function r(t,n){var r="b"+e.packets[t.type]+t.data.data;return n(r)}function o(t,n,r){if(!n)return e.encodeBase64Packet(t,r);var o=t.data,i=new Uint8Array(o),s=new Uint8Array(1+o.byteLength);s[0]=v[t.type];for(var a=0;a<i.length;a++)s[a+1]=i[a];return r(s.buffer)}function i(t,n,r){if(!n)return e.encodeBase64Packet(t,r);var o=new FileReader;return o.onload=function(){e.encodePacket({type:t.type,data:o.result},n,!0,r)},o.readAsArrayBuffer(t.data)}function s(t,n,r){if(!n)return e.encodeBase64Packet(t,r);if(m)return i(t,n,r);var o=new Uint8Array(1);o[0]=v[t.type];var s=new k([o.buffer,t.data]);return r(s)}function a(t){try{t=d.decode(t,{strict:!1})}catch(e){return!1}return t}function c(t,e,n){for(var r=new Array(t.length),o=l(t.length,n),i=function(t,n,o){e(n,function(e,n){r[t]=n,o(e,r)})},s=0;s<t.length;s++)i(s,t[s],o)}var p,u=n(23),h=n(24),f=n(25),l=n(26),d=n(27);"undefined"!=typeof ArrayBuffer&&(p=n(28));var y="undefined"!=typeof navigator&&/Android/i.test(navigator.userAgent),g="undefined"!=typeof navigator&&/PhantomJS/i.test(navigator.userAgent),m=y||g;e.protocol=3;var v=e.packets={open:0,close:1,ping:2,pong:3,message:4,upgrade:5,noop:6},b=u(v),w={type:"error",data:"parser error"},k=n(29);e.encodePacket=function(t,e,n,i){"function"==typeof e&&(i=e,e=!1),"function"==typeof n&&(i=n,n=null);var a=void 0===t.data?void 0:t.data.buffer||t.data;if("undefined"!=typeof ArrayBuffer&&a instanceof ArrayBuffer)return o(t,e,i);if("undefined"!=typeof k&&a instanceof k)return s(t,e,i);if(a&&a.base64)return r(t,i);var c=v[t.type];return void 0!==t.data&&(c+=n?d.encode(String(t.data),{strict:!1}):String(t.data)),i(""+c)},e.encodeBase64Packet=function(t,n){var r="b"+e.packets[t.type];if("undefined"!=typeof k&&t.data instanceof k){var o=new FileReader;return o.onload=function(){var t=o.result.split(",")[1];n(r+t)},o.readAsDataURL(t.data)}var i;try{i=String.fromCharCode.apply(null,new Uint8Array(t.data))}catch(s){for(var a=new Uint8Array(t.data),c=new Array(a.length),p=0;p<a.length;p++)c[p]=a[p];i=String.fromCharCode.apply(null,c)}return r+=btoa(i),n(r)},e.decodePacket=function(t,n,r){if(void 0===t)return w;if("string"==typeof t){if("b"===t.charAt(0))return e.decodeBase64Packet(t.substr(1),n);if(r&&(t=a(t),t===!1))return w;var o=t.charAt(0);return Number(o)==o&&b[o]?t.length>1?{type:b[o],data:t.substring(1)}:{type:b[o]}:w}var i=new Uint8Array(t),o=i[0],s=f(t,1);return k&&"blob"===n&&(s=new k([s])),{type:b[o],data:s}},e.decodeBase64Packet=function(t,e){var n=b[t.charAt(0)];if(!p)return{type:n,data:{base64:!0,data:t.substr(1)}};var r=p.decode(t.substr(1));return"blob"===e&&k&&(r=new k([r])),{type:n,data:r}},e.encodePayload=function(t,n,r){function o(t){return t.length+":"+t}function i(t,r){e.encodePacket(t,!!s&&n,!1,function(t){r(null,o(t))})}"function"==typeof n&&(r=n,n=null);var s=h(t);return n&&s?k&&!m?e.encodePayloadAsBlob(t,r):e.encodePayloadAsArrayBuffer(t,r):t.length?void c(t,i,function(t,e){return r(e.join(""))}):r("0:")},e.decodePayload=function(t,n,r){if("string"!=typeof t)return e.decodePayloadAsBinary(t,n,r);"function"==typeof n&&(r=n,n=null);var o;if(""===t)return r(w,0,1);for(var i,s,a="",c=0,p=t.length;c<p;c++){var u=t.charAt(c);if(":"===u){if(""===a||a!=(i=Number(a)))return r(w,0,1);if(s=t.substr(c+1,i),a!=s.length)return r(w,0,1);if(s.length){if(o=e.decodePacket(s,n,!1),w.type===o.type&&w.data===o.data)return r(w,0,1);var h=r(o,c+i,p);if(!1===h)return}c+=i,a=""}else a+=u}return""!==a?r(w,0,1):void 0},e.encodePayloadAsArrayBuffer=function(t,n){function r(t,n){e.encodePacket(t,!0,!0,function(t){return n(null,t)})}return t.length?void c(t,r,function(t,e){var r=e.reduce(function(t,e){var n;return n="string"==typeof e?e.length:e.byteLength,t+n.toString().length+n+2},0),o=new Uint8Array(r),i=0;return e.forEach(function(t){var e="string"==typeof t,n=t;if(e){for(var r=new Uint8Array(t.length),s=0;s<t.length;s++)r[s]=t.charCodeAt(s);n=r.buffer}e?o[i++]=0:o[i++]=1;for(var a=n.byteLength.toString(),s=0;s<a.length;s++)o[i++]=parseInt(a[s]);o[i++]=255;for(var r=new Uint8Array(n),s=0;s<r.length;s++)o[i++]=r[s]}),n(o.buffer)}):n(new ArrayBuffer(0))},e.encodePayloadAsBlob=function(t,n){function r(t,n){e.encodePacket(t,!0,!0,function(t){var e=new Uint8Array(1);if(e[0]=1,"string"==typeof t){for(var r=new Uint8Array(t.length),o=0;o<t.length;o++)r[o]=t.charCodeAt(o);t=r.buffer,e[0]=0}for(var i=t instanceof ArrayBuffer?t.byteLength:t.size,s=i.toString(),a=new Uint8Array(s.length+1),o=0;o<s.length;o++)a[o]=parseInt(s[o]);if(a[s.length]=255,k){var c=new k([e.buffer,a.buffer,t]);n(null,c)}})}c(t,r,function(t,e){return n(new k(e))})},e.decodePayloadAsBinary=function(t,n,r){"function"==typeof n&&(r=n,n=null);for(var o=t,i=[];o.byteLength>0;){for(var s=new Uint8Array(o),a=0===s[0],c="",p=1;255!==s[p];p++){if(c.length>310)return r(w,0,1);c+=s[p]}o=f(o,2+c.length),c=parseInt(c);var u=f(o,0,c);if(a)try{u=String.fromCharCode.apply(null,new Uint8Array(u))}catch(h){var l=new Uint8Array(u);u="";for(var p=0;p<l.length;p++)u+=String.fromCharCode(l[p])}i.push(u),o=f(o,c)}var d=i.length;i.forEach(function(t,o){r(e.decodePacket(t,n,!0),o,d)})}},function(t,e){t.exports=Object.keys||function(t){var e=[],n=Object.prototype.hasOwnProperty;for(var r in t)n.call(t,r)&&e.push(r);return e}},function(t,e,n){function r(t){if(!t||"object"!=typeof t)return!1;if(o(t)){for(var e=0,n=t.length;e<n;e++)if(r(t[e]))return!0;return!1}if("function"==typeof Buffer&&Buffer.isBuffer&&Buffer.isBuffer(t)||"function"==typeof ArrayBuffer&&t instanceof ArrayBuffer||s&&t instanceof Blob||a&&t instanceof File)return!0;if(t.toJSON&&"function"==typeof t.toJSON&&1===arguments.length)return r(t.toJSON(),!0);for(var i in t)if(Object.prototype.hasOwnProperty.call(t,i)&&r(t[i]))return!0;return!1}var o=n(10),i=Object.prototype.toString,s="function"==typeof Blob||"undefined"!=typeof Blob&&"[object BlobConstructor]"===i.call(Blob),a="function"==typeof File||"undefined"!=typeof File&&"[object FileConstructor]"===i.call(File);t.exports=r},function(t,e){t.exports=function(t,e,n){var r=t.byteLength;if(e=e||0,n=n||r,t.slice)return t.slice(e,n);if(e<0&&(e+=r),n<0&&(n+=r),n>r&&(n=r),e>=r||e>=n||0===r)return new ArrayBuffer(0);for(var o=new Uint8Array(t),i=new Uint8Array(n-e),s=e,a=0;s<n;s++,a++)i[a]=o[s];return i.buffer}},function(t,e){function n(t,e,n){function o(t,r){if(o.count<=0)throw new Error("after called too many times");--o.count,t?(i=!0,e(t),e=n):0!==o.count||i||e(null,r)}var i=!1;return n=n||r,o.count=t,0===t?e():o}function r(){}t.exports=n},function(t,e){function n(t){for(var e,n,r=[],o=0,i=t.length;o<i;)e=t.charCodeAt(o++),e>=55296&&e<=56319&&o<i?(n=t.charCodeAt(o++),56320==(64512&n)?r.push(((1023&e)<<10)+(1023&n)+65536):(r.push(e),o--)):r.push(e);return r}function r(t){for(var e,n=t.length,r=-1,o="";++r<n;)e=t[r],e>65535&&(e-=65536,o+=d(e>>>10&1023|55296),e=56320|1023&e),o+=d(e);return o}function o(t,e){if(t>=55296&&t<=57343){if(e)throw Error("Lone surrogate U+"+t.toString(16).toUpperCase()+" is not a scalar value");return!1}return!0}function i(t,e){return d(t>>e&63|128)}function s(t,e){if(0==(4294967168&t))return d(t);var n="";return 0==(4294965248&t)?n=d(t>>6&31|192):0==(4294901760&t)?(o(t,e)||(t=65533),n=d(t>>12&15|224),n+=i(t,6)):0==(4292870144&t)&&(n=d(t>>18&7|240),n+=i(t,12),n+=i(t,6)),n+=d(63&t|128)}function a(t,e){e=e||{};for(var r,o=!1!==e.strict,i=n(t),a=i.length,c=-1,p="";++c<a;)r=i[c],p+=s(r,o);return p}function c(){if(l>=f)throw Error("Invalid byte index");var t=255&h[l];if(l++,128==(192&t))return 63&t;throw Error("Invalid continuation byte")}function p(t){var e,n,r,i,s;if(l>f)throw Error("Invalid byte index");if(l==f)return!1;if(e=255&h[l],l++,0==(128&e))return e;if(192==(224&e)){if(n=c(),s=(31&e)<<6|n,s>=128)return s;throw Error("Invalid continuation byte")}if(224==(240&e)){if(n=c(),r=c(),s=(15&e)<<12|n<<6|r,s>=2048)return o(s,t)?s:65533;throw Error("Invalid continuation byte")}if(240==(248&e)&&(n=c(),r=c(),i=c(),s=(7&e)<<18|n<<12|r<<6|i,s>=65536&&s<=1114111))return s;throw Error("Invalid UTF-8 detected")}function u(t,e){e=e||{};var o=!1!==e.strict;h=n(t),f=h.length,l=0;for(var i,s=[];(i=p(o))!==!1;)s.push(i);return r(s)}/*! https://mths.be/utf8js v2.1.2 by @mathias */
var h,f,l,d=String.fromCharCode;t.exports={version:"2.1.2",encode:a,decode:u}},function(t,e){!function(t){"use strict";e.encode=function(e){var n,r=new Uint8Array(e),o=r.length,i="";for(n=0;n<o;n+=3)i+=t[r[n]>>2],i+=t[(3&r[n])<<4|r[n+1]>>4],i+=t[(15&r[n+1])<<2|r[n+2]>>6],i+=t[63&r[n+2]];return o%3===2?i=i.substring(0,i.length-1)+"=":o%3===1&&(i=i.substring(0,i.length-2)+"=="),i},e.decode=function(e){var n,r,o,i,s,a=.75*e.length,c=e.length,p=0;"="===e[e.length-1]&&(a--,"="===e[e.length-2]&&a--);var u=new ArrayBuffer(a),h=new Uint8Array(u);for(n=0;n<c;n+=4)r=t.indexOf(e[n]),o=t.indexOf(e[n+1]),i=t.indexOf(e[n+2]),s=t.indexOf(e[n+3]),h[p++]=r<<2|o>>4,h[p++]=(15&o)<<4|i>>2,h[p++]=(3&i)<<6|63&s;return u}}("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/")},function(t,e){function n(t){return t.map(function(t){if(t.buffer instanceof ArrayBuffer){var e=t.buffer;if(t.byteLength!==e.byteLength){var n=new Uint8Array(t.byteLength);n.set(new Uint8Array(e,t.byteOffset,t.byteLength)),e=n.buffer}return e}return t})}function r(t,e){e=e||{};var r=new i;return n(t).forEach(function(t){r.append(t)}),e.type?r.getBlob(e.type):r.getBlob()}function o(t,e){return new Blob(n(t),e||{})}var i="undefined"!=typeof i?i:"undefined"!=typeof WebKitBlobBuilder?WebKitBlobBuilder:"undefined"!=typeof MSBlobBuilder?MSBlobBuilder:"undefined"!=typeof MozBlobBuilder&&MozBlobBuilder,s=function(){try{var t=new Blob(["hi"]);return 2===t.size}catch(e){return!1}}(),a=s&&function(){try{var t=new Blob([new Uint8Array([1,2])]);return 2===t.size}catch(e){return!1}}(),c=i&&i.prototype.append&&i.prototype.getBlob;"undefined"!=typeof Blob&&(r.prototype=Blob.prototype,o.prototype=Blob.prototype),t.exports=function(){return s?a?Blob:o:c?r:void 0}()},function(t,e){e.encode=function(t){var e="";for(var n in t)t.hasOwnProperty(n)&&(e.length&&(e+="&"),e+=encodeURIComponent(n)+"="+encodeURIComponent(t[n]));return e},e.decode=function(t){for(var e={},n=t.split("&"),r=0,o=n.length;r<o;r++){var i=n[r].split("=");e[decodeURIComponent(i[0])]=decodeURIComponent(i[1])}return e}},function(t,e){t.exports=function(t,e){var n=function(){};n.prototype=e.prototype,t.prototype=new n,t.prototype.constructor=t}},function(t,e){"use strict";function n(t){var e="";do e=s[t%a]+e,t=Math.floor(t/a);while(t>0);return e}function r(t){var e=0;for(u=0;u<t.length;u++)e=e*a+c[t.charAt(u)];return e}function o(){var t=n(+new Date);return t!==i?(p=0,i=t):t+"."+n(p++)}for(var i,s="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_".split(""),a=64,c={},p=0,u=0;u<a;u++)c[s[u]]=u;o.encode=n,o.decode=r,t.exports=o},function(t,e,n){function r(){}function o(t){i.call(this,t),this.query=this.query||{},c||(c=a.___eio=a.___eio||[]),this.index=c.length;var e=this;c.push(function(t){e.onData(t)}),this.query.j=this.index,"function"==typeof addEventListener&&addEventListener("beforeunload",function(){e.script&&(e.script.onerror=r)},!1)}var i=n(20),s=n(31),a=n(18);t.exports=o;var c,p=/\n/g,u=/\\n/g;s(o,i),o.prototype.supportsBinary=!1,o.prototype.doClose=function(){this.script&&(this.script.parentNode.removeChild(this.script),this.script=null),this.form&&(this.form.parentNode.removeChild(this.form),this.form=null,this.iframe=null),i.prototype.doClose.call(this)},o.prototype.doPoll=function(){var t=this,e=document.createElement("script");this.script&&(this.script.parentNode.removeChild(this.script),this.script=null),e.async=!0,e.src=this.uri(),e.onerror=function(e){t.onError("jsonp poll error",e)};var n=document.getElementsByTagName("script")[0];n?n.parentNode.insertBefore(e,n):(document.head||document.body).appendChild(e),this.script=e;var r="undefined"!=typeof navigator&&/gecko/i.test(navigator.userAgent);r&&setTimeout(function(){var t=document.createElement("iframe");document.body.appendChild(t),document.body.removeChild(t)},100)},o.prototype.doWrite=function(t,e){function n(){r(),e()}function r(){if(o.iframe)try{o.form.removeChild(o.iframe)}catch(t){o.onError("jsonp polling iframe removal error",t)}try{var e='<iframe src="javascript:0" name="'+o.iframeId+'">';i=document.createElement(e)}catch(t){i=document.createElement("iframe"),i.name=o.iframeId,i.src="javascript:0"}i.id=o.iframeId,o.form.appendChild(i),o.iframe=i}var o=this;if(!this.form){var i,s=document.createElement("form"),a=document.createElement("textarea"),c=this.iframeId="eio_iframe_"+this.index;s.className="socketio",s.style.position="absolute",s.style.top="-1000px",s.style.left="-1000px",s.target=c,s.method="POST",s.setAttribute("accept-charset","utf-8"),a.name="d",s.appendChild(a),document.body.appendChild(s),this.form=s,this.area=a}this.form.action=this.uri(),r(),t=t.replace(u,"\\\n"),this.area.value=t.replace(p,"\\n");try{this.form.submit()}catch(h){}this.iframe.attachEvent?this.iframe.onreadystatechange=function(){"complete"===o.iframe.readyState&&n()}:this.iframe.onload=n}},function(t,e,n){function r(t){var e=t&&t.forceBase64;e&&(this.supportsBinary=!1),this.perMessageDeflate=t.perMessageDeflate,this.usingBrowserWebSocket=o&&!t.forceNode,this.protocols=t.protocols,this.usingBrowserWebSocket||(l=i),s.call(this,t)}var o,i,s=n(21),a=n(22),c=n(30),p=n(31),u=n(32),h=n(3)("engine.io-client:websocket");if("undefined"!=typeof WebSocket?o=WebSocket:"undefined"!=typeof self&&(o=self.WebSocket||self.MozWebSocket),"undefined"==typeof window)try{i=n(35)}catch(f){}var l=o||i;t.exports=r,p(r,s),r.prototype.name="websocket",r.prototype.supportsBinary=!0,r.prototype.doOpen=function(){if(this.check()){var t=this.uri(),e=this.protocols,n={};this.isReactNative||(n.agent=this.agent,n.perMessageDeflate=this.perMessageDeflate,n.pfx=this.pfx,n.key=this.key,n.passphrase=this.passphrase,n.cert=this.cert,n.ca=this.ca,n.ciphers=this.ciphers,n.rejectUnauthorized=this.rejectUnauthorized),this.extraHeaders&&(n.headers=this.extraHeaders),this.localAddress&&(n.localAddress=this.localAddress);try{this.ws=this.usingBrowserWebSocket&&!this.isReactNative?e?new l(t,e):new l(t):new l(t,e,n)}catch(r){return this.emit("error",r)}void 0===this.ws.binaryType&&(this.supportsBinary=!1),this.ws.supports&&this.ws.supports.binary?(this.supportsBinary=!0,this.ws.binaryType="nodebuffer"):this.ws.binaryType="arraybuffer",this.addEventListeners()}},r.prototype.addEventListeners=function(){var t=this;this.ws.onopen=function(){t.onOpen()},this.ws.onclose=function(){t.onClose()},this.ws.onmessage=function(e){t.onData(e.data)},this.ws.onerror=function(e){t.onError("websocket error",e)}},r.prototype.write=function(t){function e(){n.emit("flush"),setTimeout(function(){n.writable=!0,n.emit("drain")},0)}var n=this;this.writable=!1;for(var r=t.length,o=0,i=r;o<i;o++)!function(t){a.encodePacket(t,n.supportsBinary,function(o){if(!n.usingBrowserWebSocket){var i={};if(t.options&&(i.compress=t.options.compress),n.perMessageDeflate){var s="string"==typeof o?Buffer.byteLength(o):o.length;s<n.perMessageDeflate.threshold&&(i.compress=!1)}}try{n.usingBrowserWebSocket?n.ws.send(o):n.ws.send(o,i)}catch(a){h("websocket closed before onclose event")}--r||e()})}(t[o])},r.prototype.onClose=function(){s.prototype.onClose.call(this)},r.prototype.doClose=function(){"undefined"!=typeof this.ws&&this.ws.close()},r.prototype.uri=function(){var t=this.query||{},e=this.secure?"wss":"ws",n="";this.port&&("wss"===e&&443!==Number(this.port)||"ws"===e&&80!==Number(this.port))&&(n=":"+this.port),this.timestampRequests&&(t[this.timestampParam]=u()),this.supportsBinary||(t.b64=1),t=c.encode(t),t.length&&(t="?"+t);var r=this.hostname.indexOf(":")!==-1;return e+"://"+(r?"["+this.hostname+"]":this.hostname)+n+this.path+t},r.prototype.check=function(){return!(!l||"__initialize"in l&&this.name===r.prototype.name)}},function(t,e){},function(t,e){var n=[].indexOf;t.exports=function(t,e){if(n)return t.indexOf(e);for(var r=0;r<t.length;++r)if(t[r]===e)return r;return-1}},function(t,e,n){function r(t,e,n){this.io=t,this.nsp=e,this.json=this,this.ids=0,this.acks={},this.receiveBuffer=[],this.sendBuffer=[],this.connected=!1,this.disconnected=!0,this.flags={},n&&n.query&&(this.query=n.query),this.io.autoConnect&&this.open()}var o=n(7),i=n(8),s=n(38),a=n(39),c=n(40),p=n(3)("socket.io-client:socket"),u=n(30),h=n(24);t.exports=e=r;var f={connect:1,connect_error:1,connect_timeout:1,connecting:1,disconnect:1,error:1,reconnect:1,reconnect_attempt:1,reconnect_failed:1,reconnect_error:1,reconnecting:1,ping:1,pong:1},l=i.prototype.emit;i(r.prototype),r.prototype.subEvents=function(){if(!this.subs){var t=this.io;this.subs=[a(t,"open",c(this,"onopen")),a(t,"packet",c(this,"onpacket")),a(t,"close",c(this,"onclose"))]}},r.prototype.open=r.prototype.connect=function(){return this.connected?this:(this.subEvents(),this.io.reconnecting||this.io.open(),"open"===this.io.readyState&&this.onopen(),this.emit("connecting"),this)},r.prototype.send=function(){var t=s(arguments);return t.unshift("message"),this.emit.apply(this,t),this},r.prototype.emit=function(t){if(f.hasOwnProperty(t))return l.apply(this,arguments),this;var e=s(arguments),n={type:(void 0!==this.flags.binary?this.flags.binary:h(e))?o.BINARY_EVENT:o.EVENT,data:e};return n.options={},n.options.compress=!this.flags||!1!==this.flags.compress,"function"==typeof e[e.length-1]&&(p("emitting packet with ack id %d",this.ids),this.acks[this.ids]=e.pop(),n.id=this.ids++),this.connected?this.packet(n):this.sendBuffer.push(n),this.flags={},this},r.prototype.packet=function(t){t.nsp=this.nsp,this.io.packet(t)},r.prototype.onopen=function(){if(p("transport is open - connecting"),"/"!==this.nsp)if(this.query){var t="object"==typeof this.query?u.encode(this.query):this.query;p("sending connect packet with query %s",t),this.packet({type:o.CONNECT,query:t})}else this.packet({type:o.CONNECT})},r.prototype.onclose=function(t){p("close (%s)",t),this.connected=!1,this.disconnected=!0,delete this.id,this.emit("disconnect",t)},r.prototype.onpacket=function(t){var e=t.nsp===this.nsp,n=t.type===o.ERROR&&"/"===t.nsp;if(e||n)switch(t.type){case o.CONNECT:this.onconnect();break;case o.EVENT:this.onevent(t);break;case o.BINARY_EVENT:this.onevent(t);break;case o.ACK:this.onack(t);break;case o.BINARY_ACK:this.onack(t);break;case o.DISCONNECT:this.ondisconnect();break;case o.ERROR:this.emit("error",t.data)}},r.prototype.onevent=function(t){var e=t.data||[];p("emitting event %j",e),null!=t.id&&(p("attaching ack callback to event"),e.push(this.ack(t.id))),this.connected?l.apply(this,e):this.receiveBuffer.push(e)},r.prototype.ack=function(t){var e=this,n=!1;return function(){if(!n){n=!0;var r=s(arguments);p("sending ack %j",r),e.packet({type:h(r)?o.BINARY_ACK:o.ACK,id:t,data:r})}}},r.prototype.onack=function(t){var e=this.acks[t.id];"function"==typeof e?(p("calling ack %s with %j",t.id,t.data),e.apply(this,t.data),delete this.acks[t.id]):p("bad ack %s",t.id)},r.prototype.onconnect=function(){this.connected=!0,this.disconnected=!1,this.emit("connect"),this.emitBuffered()},r.prototype.emitBuffered=function(){var t;for(t=0;t<this.receiveBuffer.length;t++)l.apply(this,this.receiveBuffer[t]);for(this.receiveBuffer=[],t=0;t<this.sendBuffer.length;t++)this.packet(this.sendBuffer[t]);this.sendBuffer=[]},r.prototype.ondisconnect=function(){p("server disconnect (%s)",this.nsp),this.destroy(),this.onclose("io server disconnect")},r.prototype.destroy=function(){if(this.subs){for(var t=0;t<this.subs.length;t++)this.subs[t].destroy();this.subs=null}this.io.destroy(this)},r.prototype.close=r.prototype.disconnect=function(){return this.connected&&(p("performing disconnect (%s)",this.nsp),this.packet({type:o.DISCONNECT})),this.destroy(),this.connected&&this.onclose("io client disconnect"),this},r.prototype.compress=function(t){return this.flags.compress=t,this},r.prototype.binary=function(t){return this.flags.binary=t,this}},function(t,e){function n(t,e){var n=[];e=e||0;for(var r=e||0;r<t.length;r++)n[r-e]=t[r];return n}t.exports=n},function(t,e){function n(t,e,n){return t.on(e,n),{destroy:function(){t.removeListener(e,n)}}}t.exports=n},function(t,e){var n=[].slice;t.exports=function(t,e){if("string"==typeof e&&(e=t[e]),"function"!=typeof e)throw new Error("bind() requires a function");var r=n.call(arguments,2);return function(){return e.apply(t,r.concat(n.call(arguments)))}}},function(t,e){function n(t){t=t||{},this.ms=t.min||100,this.max=t.max||1e4,this.factor=t.factor||2,this.jitter=t.jitter>0&&t.jitter<=1?t.jitter:0,this.attempts=0}t.exports=n,n.prototype.duration=function(){var t=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var e=Math.random(),n=Math.floor(e*this.jitter*t);t=0==(1&Math.floor(10*e))?t-n:t+n}return 0|Math.min(t,this.max)},n.prototype.reset=function(){this.attempts=0},n.prototype.setMin=function(t){this.ms=t},n.prototype.setMax=function(t){this.max=t},n.prototype.setJitter=function(t){this.jitter=t}}])});
;

define('text!avatar.mustache',[],function () { return '<figure class="chat-avatar{{#modifier}} chat-avatar--{{modifier}}{{/modifier}}{{#status}} chat-avatar--{{status}}{{/status}}{{#reminder}} chat-avatar--reminder-{{reminder.status}}{{/reminder}}"{{#reminder}} title="{{reminder.desc}}"{{/reminder}}>\n\t{{#profile_url}}<a href="{{profile_url}}">{{/profile_url}}\n\t{{#is_user_inactive}}<span class="icon-f icf-close"></span>{{/is_user_inactive}}\n\t{{^is_user_inactive}}\n\t\t{{#is_user_not_reviewed}}\n\t\t\t<span class="icon-f icf-handshake" alt="{{review_not_validated}}" title="{{review_not_validated}}"></span>\n\t\t{{/is_user_not_reviewed}}\n\t\t<img src="{{src}}" alt="{{alt}}">\n\t{{/is_user_inactive}}\n\t{{#profile_url}}</a>{{/profile_url}}\n</figure>';});


define('text!get_history.mustache',[],function () { return '<li class="text-center mb-5">\n\t<button type="button" id="{{id}}" class="chat-btn get_history">\n\t\t<span>{{{label}}}</span>\n\t</button>\n</li>\n';});


define('text!icon_sprite.mustache',[],function () { return '<svg aria-hidden="true" style="position: absolute; width: 0; height: 0; overflow: hidden;" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n\t<defs>\n\t\t<symbol id="scc-attachment-icon" viewBox="0 0 42 42">\n\t\t\t<circle cx="21" cy="21" r="21" fill="var(--scc-bg)"/>\n\t\t\t<path fill="none" stroke="var(--scc-secondary)" stroke-miterlimit="10" d="M29.1 18.9H23v-6.1a2 2 0 0 0-2-2 2 2 0 0 0-2 2v6.1h-6.1a2 2 0 0 0-2 2v.1c0 1.1.9 2 2 2H19v6.1c0 1.1.9 2 2 2h.1a2 2 0 0 0 2-2V23h6.1a2 2 0 0 0 2-2v-.1c-.1-1.1-1-2-2.1-2z"/>\n\t\t</symbol>\n\t\t<symbol id="scc-back-icon" viewBox="0 0 13 13">\n\t\t\t<path fill="#fff" d="M12.9 6H1.8L7.2.8 6.5.1.2 6.2c-.1 0-.2.2-.2.3 0 .1.1.3.1.4l6.4 6.2.7-.7L1.7 7h11.2V6z"/>\n\t\t</symbol>\n\t\t<symbol id="scc-blur-the-images-icon" viewBox="0 0 16 16">\n\t\t\t<linearGradient id="scc_blur_1" x1=".55" x2="15.44" y1="7.98" y2="7.98" gradientUnits="userSpaceOnUse">\n\t\t\t\t<stop offset="0" stop-color="var(--scc-gradient-start)"/>\n\t\t\t\t<stop offset="1" stop-color="var(--scc-gradient-stop)"/>\n\t\t\t</linearGradient>\n\t\t\t<path fill="none" stroke="url(#scc_blur_1)" stroke-miterlimit="10" d="M13.5 14.5h-11c-.8 0-1.5-.7-1.5-1.5V2.9c0-.8.6-1.4 1.4-1.4h11.1c.8 0 1.4.6 1.4 1.4V13c0 .8-.6 1.5-1.4 1.5z"/>\n\t\t\t<linearGradient id="scc_blur_2" x1="8.65" x2="13.88" y1="4.78" y2="4.78" gradientUnits="userSpaceOnUse">\n\t\t\t\t<stop offset="0" stop-color="var(--scc-gradient-start)"/>\n\t\t\t\t<stop offset="1" stop-color="var(--scc-gradient-stop)"/>\n\t\t\t</linearGradient>\n\t\t\t<circle cx="11.3" cy="4.8" r="2.1" fill="none" stroke="url(#scc_blur_2)" stroke-miterlimit="10"/>\n\t\t\t<linearGradient id="scc_blur_3" x1="1.05" x2="14.94" y1="11.31" y2="11.31" gradientUnits="userSpaceOnUse">\n\t\t\t\t<stop offset="0" stop-color="var(--scc-gradient-start)"/>\n\t\t\t\t<stop offset="1" stop-color="var(--scc-gradient-stop)"/>\n\t\t\t</linearGradient>\n\t\t\t<path fill="url(#scc_blur_3)" d="m1.2 10.3 3.5-2.4 10.2 4.7-.1 1-1.1.8-5.7.3-5.5-.2-1.2-.6-.3-3.6"/>\n\t\t\t<path fill="#EDE8E8" d="M9.9 7H.7C.3 7 0 6.7 0 6.4v-3c0-.4.3-.7.7-.7h9.2c.4 0 .7.3.7.7v3c0 .3-.3.6-.7.6z" opacity=".64"/>\n\t\t\t<g fill="#EDE8E8">\n\t\t\t\t<path d="M8.1 5.7H3.6c-.3 0-.5-.2-.5-.5V1.8c0-.3.2-.5.5-.5h4.6c.3 0 .5.2.5.5v3.4c-.1.3-.3.5-.6.5z" opacity=".64"/>\n\t\t\t\t<path d="M15.3 4.4H6.4c-.4 0-.7-.3-.7-.7v-3c0-.4.3-.7.7-.7h8.9c.4 0 .7.3.7.7v3.1c0 .3-.3.6-.7.6zm.1 4.4H9.3c-.3 0-.5-.2-.5-.5V5c0-.3.3-.6.6-.6h6.1c.2 0 .5.3.5.6v3.3c0 .3-.3.5-.6.5z" opacity=".64"/>\n\t\t\t\t<path d="M12.8 9.6H3.6c-.4 0-.7-.3-.7-.7v-3c0-.4.3-.7.7-.7h9.2c.4 0 .7.3.7.7v3c0 .4-.3.7-.7.7z" opacity=".64"/>\n\t\t\t\t<path d="M11.4 12.6H2.2c-.4 0-.7-.3-.7-.7v-3c0-.4.3-.7.7-.7h9.2c.4 0 .7.3.7.7v3c0 .4-.3.7-.7.7z" opacity=".64"/>\n\t\t\t\t<path d="M15.5 12.6h-5.3c-.3 0-.5-.2-.5-.5V8.7c0-.3.2-.5.5-.5h5.3c.3 0 .5.2.5.5V12c0 .3-.2.6-.5.6z" opacity=".64"/>\n\t\t\t\t<path d="M12.6 14.6H3.4c-.4 0-.7-.3-.7-.7v-3c0-.4.3-.7.7-.7h9.2c.4 0 .7.3.7.7v3c0 .3-.3.7-.7.7z" opacity=".64"/>\n\t\t\t</g>\n\t\t</symbol>\n\t\t<symbol id="scc-chat-send-icon" viewBox="0 0 42 42">\n\t\t\t<path fill="none" stroke="#fff" stroke-miterlimit="10" d="m9.2 17.1 7.1 3.6c.3.2.5.5.4.8l-2 8.6c-.2.7.7 1.2 1.2.7L33 14.6c.5-.5.1-1.3-.6-1.3l-23 2.4c-.7.1-.9 1.1-.2 1.4zm7.4 4 16.3-7.2" />\n\t\t</symbol>\n\t\t<symbol id="scc-chat-size-icon" viewBox="0 0 16 16">\n\t\t\t<linearGradient id="scc_chat_size_1" x1="2.03" x2="13.99" y1="8.47" y2="8.47" gradientUnits="userSpaceOnUse">\n\t\t\t\t<stop offset="0" stop-color="var(--scc-gradient-start)"/>\n\t\t\t\t<stop offset="1" stop-color="var(--scc-gradient-stop)"/>\n\t\t\t</linearGradient>\n\t\t\t<path fill="none" stroke="url(#scc_chat_size_1)" stroke-miterlimit="10" stroke-width=".94" d="M11.4 2.5H4.6c-1.2 0-2.1 1-2.1 2.3V14c0 .3.3.5.6.4l2.5-1.6c.1 0 .1-.1.2-.1h5.6c1.2 0 2.1-1 2.1-2.3V4.8c0-1.3-.9-2.3-2.1-2.3z"/>\n\t\t\t<linearGradient id="scc_chat_size_2" x1=".01" x2="5" y1="2" y2="2" gradientUnits="userSpaceOnUse">\n\t\t\t\t<stop offset="0" stop-color="var(--scc-gradient-start)"/>\n\t\t\t\t<stop offset="1" stop-color="var(--scc-gradient-stop)"/>\n\t\t\t</linearGradient>\n\t\t\t<path fill="none" stroke="url(#scc_chat_size_2)" stroke-miterlimit="10" d="M5 .5H2.3C1.3.5.5 1.3.5 2.3V4"/>\n\t\t\t<linearGradient id="scc_chat_size_3" x1="-4.49" x2=".51" y1="-11.49" y2="-11.49" gradientTransform="rotate(180 5.75 1.25)" gradientUnits="userSpaceOnUse">\n\t\t\t\t<stop offset="0" stop-color="var(--scc-gradient-start)"/>\n\t\t\t\t<stop offset="1" stop-color="var(--scc-gradient-stop)"/>\n\t\t\t</linearGradient>\n\t\t\t<path fill="none" stroke="url(#scc_chat_size_3)" stroke-miterlimit="10" d="M11 15.5h2.7c1 0 1.8-.8 1.8-1.8V12"/>\n\t\t</symbol>\n\t\t<symbol id="scc-color-theme-icon" viewBox="0 0 16 16">\n\t\t\t<linearGradient id="scc_color_theme_1" x1="0" x2="16" y1="8.01" y2="8.01" gradientUnits="userSpaceOnUse">\n\t\t\t\t<stop offset="0" stop-color="var(--scc-gradient-start)"/>\n\t\t\t\t<stop offset="1" stop-color="var(--scc-gradient-stop)"/>\n\t\t\t</linearGradient>\n\t\t\t<path fill="none" stroke="url(#scc_color_theme_1)" stroke-miterlimit="10" d="M12.7 7.2c0 3.5 9.2 6.2-5.9 7.2C3.3 14.7.5 11.6.5 8s2.8-6.4 6.3-6.4 5.9 2 5.9 5.6z"/>\n\t\t\t<linearGradient id="scc_color_theme_2" x1="2.82" x2="6.05" y1="10.08" y2="10.08" gradientUnits="userSpaceOnUse">\n\t\t\t\t<stop offset="0" stop-color="var(--scc-gradient-start)"/>\n\t\t\t\t<stop offset="1" stop-color="var(--scc-gradient-stop)"/>\n\t\t\t</linearGradient>\n\t\t\t<circle cx="4.4" cy="10.1" r="1.6" fill="url(#scc_color_theme_2)"/>\n\t\t\t<linearGradient id="scc_color_theme_3" x1="11.4" x2="14.11" y1="11.48" y2="11.48" gradientUnits="userSpaceOnUse">\n\t\t\t\t<stop offset="0" stop-color="var(--scc-gradient-start)"/>\n\t\t\t\t<stop offset="1" stop-color="var(--scc-gradient-stop)"/>\n\t\t\t</linearGradient>\n\t\t\t<circle cx="12.8" cy="11.5" r="1" fill="none" stroke="url(#scc_color_theme_3)" stroke-miterlimit="10" stroke-width=".71"/>\n\t\t\t<linearGradient id="scc_color_theme_4" x1="3.31" x2="6.55" y1="5.35" y2="5.35" gradientUnits="userSpaceOnUse">\n\t\t\t\t<stop offset="0" stop-color="var(--scc-gradient-start)"/>\n\t\t\t\t<stop offset="1" stop-color="var(--scc-gradient-stop)"/>\n\t\t\t</linearGradient>\n\t\t\t<circle cx="4.9" cy="5.3" r="1.6" fill="url(#scc_color_theme_4)"/>\n\t\t\t<linearGradient id="scc_color_theme_5" x1="8.1" x2="11.33" y1="5.59" y2="5.59" gradientUnits="userSpaceOnUse">\n\t\t\t\t<stop offset="0" stop-color="var(--scc-gradient-start)"/>\n\t\t\t\t<stop offset="1" stop-color="var(--scc-gradient-stop)"/>\n\t\t\t</linearGradient>\n\t\t\t<circle cx="9.7" cy="5.6" r="1.6" fill="url(#scc_color_theme_5)"/>\n\t\t</symbol>\n\t\t<symbol id="scc-contact-icon-active" viewBox="0 0 24 24">\n\t\t\t<linearGradient id="scc_contact_active_1" x1="13.27" x2="24.08" y1="5.43" y2="5.43" gradientUnits="userSpaceOnUse">\n\t\t\t\t<stop offset="0" stop-color="var(--scc-gradient-start)"/>\n\t\t\t\t<stop offset="1" stop-color="var(--scc-gradient-stop)"/>\n\t\t\t</linearGradient>\n\t\t\t<path fill="url(#scc_contact_active_1)" d="m13.6 10.9.6-2.6c-.6-.9-.9-1.9-.9-2.9 0-3 2.4-5.4 5.4-5.4s5.4 2.4 5.4 5.4-2.4 5.4-5.4 5.4c-.7 0-1.4-.1-2.1-.4l-3 .5zm3.1-1.5.1.1a4.37 4.37 0 0 0 6.2-4c0-2.5-2-4.4-4.4-4.4-2.5 0-4.4 2-4.4 4.4 0 .9.3 1.8.8 2.6l.1.2-.3 1.6 1.9-.5z"/>\n\t\t\t<linearGradient id="scc_contact_active_2" x1="-.01" x2="17.27" y1="18.95" y2="18.95" gradientUnits="userSpaceOnUse">\n\t\t\t\t<stop offset="0" stop-color="var(--scc-gradient-start)"/>\n\t\t\t\t<stop offset="1" stop-color="var(--scc-gradient-stop)"/>\n\t\t\t</linearGradient>\n\t\t\t<path fill="none" stroke="url(#scc_contact_active_2)" stroke-miterlimit="10" d="M12.5 14.4h-.4c-.8 1-2.1 1.6-3.4 1.6s-2.7-.6-3.5-1.6h-.4c-2.4 0-4.3 1.9-4.3 4.3v.5c0 2.4 1.9 4.3 4.3 4.3h7.7c2.4 0 4.3-1.9 4.3-4.3v-.5c0-2.4-2-4.3-4.3-4.3z"/>\n\t\t\t<linearGradient id="scc_contact_active_3" x1="4.14" x2="13.12" y1="9.84" y2="9.84" gradientUnits="userSpaceOnUse">\n\t\t\t\t<stop offset="0" stop-color="var(--scc-gradient-start)"/>\n\t\t\t\t<stop offset="1" stop-color="var(--scc-gradient-stop)"/>\n\t\t\t</linearGradient>\n\t\t\t<circle cx="8.6" cy="9.8" r="4.5" fill="url(#scc_contact_active_3)"/>\n\t\t</symbol>\n\t\t<symbol id="scc-contact-icon-inactive" viewBox="0 0 24 24">\n\t\t\t<path fill="#b8b8b8" d="m13.6 10.9.6-2.6c-.6-.9-.9-1.9-.9-2.9 0-3 2.4-5.4 5.4-5.4s5.4 2.4 5.4 5.4-2.4 5.4-5.4 5.4c-.7 0-1.4-.1-2.1-.4l-3 .5zm3.1-1.5.1.1a4.37 4.37 0 0 0 6.2-4c0-2.5-2-4.4-4.4-4.4-2.5 0-4.4 2-4.4 4.4 0 .9.3 1.8.8 2.6l.1.2-.3 1.6 1.9-.5z"/>\n\t\t\t<path fill="none" stroke="#b8b8b8" stroke-miterlimit="10" stroke-width=".99" d="M12.5 14.4h-.4c-.8 1-2.1 1.6-3.4 1.6s-2.7-.6-3.5-1.6h-.4c-2.4 0-4.3 1.9-4.3 4.3v.5c0 2.4 1.9 4.3 4.3 4.3h7.7c2.4 0 4.3-1.9 4.3-4.3v-.5c0-2.4-2-4.3-4.3-4.3z"/>\n\t\t\t<circle cx="8.6" cy="9.8" r="4" fill="none" stroke="#b8b8b8" stroke-miterlimit="10" stroke-width=".88"/>\n\t\t</symbol>\n\t\t<symbol id="scc-contact-no-new" viewBox="0 0 500 500">\n\t\t\t<circle cx="214" cy="308.7" r="184.4" fill="#A280BA" opacity=".07"/>\n\t\t\t<linearGradient id="scc_contact_no_new_1" x1="101.58" x2="470.39" y1="272.92" y2="272.92" gradientUnits="userSpaceOnUse">\n\t\t\t\t<stop offset="0" stop-color="var(--scc-gradient-start)"/>\n\t\t\t\t<stop offset="1" stop-color="var(--scc-gradient-stop)"/>\n\t\t\t</linearGradient>\n\t\t\t<circle cx="286" cy="272.9" r="184.4" fill="url(#scc_contact_no_new_1)" opacity=".1"/>\n\t\t\t<linearGradient id="scc_contact_no_new_2" x1="137.87" x2="410.5" y1="290.78" y2="290.78" gradientUnits="userSpaceOnUse">\n\t\t\t\t<stop offset="0" stop-color="var(--scc-gradient-start)"/>\n\t\t\t\t<stop offset="1" stop-color="var(--scc-gradient-stop)"/>\n\t\t\t</linearGradient>\n\t\t\t<path fill="url(#scc_contact_no_new_2)" d="M274.2 427.1c-75.2 0-136.3-61.1-136.3-136.3S199 154.5 274.2 154.5s136.3 61.1 136.3 136.3-61.2 136.3-136.3 136.3zm0-260c-68.2 0-123.7 55.5-123.7 123.7S206 414.4 274.2 414.4s123.7-55.5 123.7-123.7-55.5-123.6-123.7-123.6z"/>\n\t\t\t<path fill="#8D62C4" d="M298.2 6.9h-39.9c-7 0-12.6 5.7-12.6 12.6v50.9c0 1.8 1.9 2.9 3.5 2l14.8-8.7c.4-.2.8-.3 1.2-.3h33.2c7 0 12.6-5.7 12.6-12.6V19.6c-.1-7-5.8-12.7-12.8-12.7z"/>\n\t\t\t<path fill="#73CDE5" d="M55.6 72.8h50.8c8.9 0 16.1 7.2 16.1 16.1v64.8c0 2.3-2.5 3.7-4.4 2.5l-18.8-11.1c-.5-.3-1-.4-1.5-.4H55.6c-8.9 0-16.1-7.2-16.1-16.1V88.9c0-8.9 7.2-16.1 16.1-16.1z"/>\n\t\t\t<circle cx="182.4" cy="88.2" r="6.1" fill="#8D62C4"/>\n\t\t\t<circle cx="195.1" cy="13.5" r="6.6" fill="#8D62C4"/>\n\t\t\t<circle cx="79.7" cy="39.3" r="8.2" fill="#8D62C4"/>\n\t\t\t<path fill="#FFF" d="M275 359.6h-45c-15.5 0-28.2-12.6-28.2-28.2v-2.9c0-15.5 12.6-28.2 28.2-28.2h3.7l.9 1c4.5 5.3 11 8.3 17.9 8.3s13.4-3 17.9-8.3l.9-1h3.7c15.5 0 28.2 12.6 28.2 28.2v2.9a28.3 28.3 0 0 1-28.2 28.2zm-45-53.5c-12.3 0-22.3 10-22.3 22.3v2.9c0 12.3 10 22.3 22.3 22.3h45c12.3 0 22.3-10 22.3-22.3v-2.9c0-12.3-10-22.3-22.3-22.3h-1.1c-5.5 6-13.3 9.3-21.4 9.3-8.2 0-15.9-3.4-21.4-9.3H230z"/>\n\t\t\t<circle cx="252.5" cy="269.4" r="25.7" fill="#FFF"/>\n\t\t\t<path fill="#FFF" d="M322.1 213.2c-18 0-32.7 14.6-32.7 32.7 0 7 2.2 13.5 6 18.8l-3 13.7 16.4-2.7c4.1 1.8 8.6 2.9 13.4 2.9 18 0 32.7-14.6 32.7-32.7s-14.8-32.7-32.8-32.7z"/>\n\t\t</symbol>\n\t\t<symbol id="scc-debug-icon" viewBox="0 0 16 16">\n\t\t\t<linearGradient id="scc_debub_1" x1="-.02" x2="15.98" y1="26" y2="26" gradientTransform="matrix(1 0 0 -1 0 34)" gradientUnits="userSpaceOnUse">\n\t\t\t\t<stop offset="0" stop-color="var(--scc-gradient-start)"/>\n\t\t\t\t<stop offset="1" stop-color="var(--scc-gradient-stop)"/>\n\t\t\t</linearGradient>\n\t\t\t<path fill="url(#scc_debub_1)" d="M8.4 16h-1c-.8 0-1.4-.7-1.4-1.4v-.4a3 3 0 0 1-1-.4l-.4.3c-.6.5-1.4.4-2-.2l-.7-.7c-.6-.6-.6-1.4-.1-2l.3-.4c-.2-.3-.3-.6-.4-.9l-.5-.2C.5 9.6 0 9 0 8.3v-1c0-.7.6-1.4 1.3-1.5h.4c.1-.3.2-.7.4-.9l-.2-.4c-.5-.5-.5-1.4.1-2l.7-.7c.5-.5 1.3-.6 2-.1L5 2c.3-.2.7-.3 1.2-.4v-.3C6.3.6 6.9 0 7.6 0h1c.8 0 1.4.6 1.4 1.4v.3c.4.1.7.3 1 .4l.3-.2c.7-.5 1.4-.4 2 .2l.8.7c.6.6.6 1.4.1 2l-.2.4c.2.3.3.6.4.9h.3c.7.1 1.3.8 1.3 1.5v1c0 .7-.6 1.4-1.3 1.5h-.3c-.1.3-.3.6-.4.9l.3.3c.5.7.4 1.4-.2 2l-.7.7c-.6.6-1.4.6-2 .1l-.3-.2a3 3 0 0 1-1 .4l-.1.4c-.3.7-.9 1.3-1.6 1.3zm-3.5-3.4.3.2c.4.3.8.4 1.2.5l.3.1.2 1.1c0 .3.2.5.4.5h1c.3 0 .5-.2.5-.4l.2-1 .3-.1c.4-.1.9-.3 1.3-.5l.3-.2.8.7c.2.2.5.2.7 0l.7-.7c.2-.2.3-.4.1-.7l-.6-.8.2-.3c.2-.4.5-.9.6-1.3l.1-.3 1-.1c.3-.3.5-.5.5-.7v-1c0-.3-.2-.5-.4-.5l-1-.1-.1-.3c-.1-.4-.3-.9-.5-1.3l-.2-.3.8-.9c.1-.2.2-.5 0-.7l-.8-.7c-.2-.2-.4-.3-.7-.1l-.8.6-.3-.2c-.4-.2-.8-.5-1.4-.6h-.4l-.1-1c0-.3-.2-.5-.4-.5h-1c-.3 0-.5.2-.6.4l-.1 1h-.4c-.5.2-1 .3-1.4.5l-.2.2-.9-.5c-.2-.3-.5-.2-.7 0l-.7.6c-.2.2-.3.4 0 .7l.7.9-.2.3c-.3.4-.5.8-.6 1.3l-.1.3-1.1.1c-.3 0-.5.3-.5.5v1c0 .3.2.5.4.5l1.1.4.1.2c.1.4.3.8.5 1.2l.2.3-.7.9c-.2.2-.2.5 0 .7l.7.7c.2.2.4.3.7.1l1-.7zm3.2-1.7h-.2c-.8 0-1.6-.3-2.2-1A3.1 3.1 0 0 1 8 4.6c.9 0 1.7.3 2.3 1 .7.6 1 1.4.9 2.2 0 .8-.3 1.6-1 2.2-.6.6-1.3.9-2.1.9zm0-5.3c-1.2 0-2.2 1-2.2 2.1 0 .6.2 1.1.6 1.5.4.4 1 .7 1.5.7.6 0 1.1-.2 1.5-.6.4-.4.7-1 .7-1.5 0-.6-.2-1.1-.6-1.5-.4-.4-1-.7-1.5-.7z"/>\n\t\t</symbol>\n\t\t<symbol id="scc-disable-mini-chat-icon" viewBox="0 0 16 16">\n\t\t\t<linearGradient id="scc_disable_mini_chat_1" x1="-.02" x2="16.03" y1="8" y2="8" gradientUnits="userSpaceOnUse">\n\t\t\t\t<stop offset="0" stop-color="var(--scc-gradient-start)"/>\n\t\t\t\t<stop offset="1" stop-color="var(--scc-gradient-stop)"/>\n\t\t\t</linearGradient>\n\t\t\t<path fill="none" stroke="url(#scc_disable_mini_chat_1)" stroke-miterlimit="10" stroke-width="1.05" d="M12.6.5H3.4A2.9 2.9 0 0 0 .5 3.4V15c0 .4.4.7.8.5l3.4-2c.1 0 .2-.1.3-.1h7.6c1.6 0 2.9-1.3 2.9-2.9V3.4c0-1.6-1.3-2.9-2.9-2.9z"/>\n\t\t\t<linearGradient id="scc_b" x1="5.54" x2="10.46" y1="6.95" y2="6.95" gradientUnits="userSpaceOnUse">\n\t\t\t\t<stop offset="0" stop-color="var(--scc-gradient-start)"/>\n\t\t\t\t<stop offset="1" stop-color="var(--scc-gradient-stop)"/>\n\t\t\t</linearGradient>\n\t\t\t<path fill="url(#scc_b)" d="m8.6 7 1.8-1.8c.2-.2.2-.4 0-.6-.2-.2-.4-.2-.6 0L8 6.4 6.2 4.6c-.2-.2-.4-.2-.6 0-.1.2-.1.4.1.6L7.4 7 5.7 8.7c-.2.2-.2.4 0 .6.2.2.4.2.6 0L8 7.5l1.7 1.7c.2.2.4.2.6 0 .2-.2.2-.4 0-.6L8.6 7z"/>\n\t\t</symbol>\n\t\t<symbol id="scc-down-icon" viewBox="0 0 13 13">\n\t\t\t<path fill="none" stroke="var(--scc-secondary)" stroke-miterlimit="10" stroke-width=".93" d="m.5 3.3 6 6.5 6-6.5"/>\n\t\t</symbol>\n\t\t<symbol id="scc-error-message-indicator-icon" viewBox="0 0 13 13">\n\t\t\t<circle cx="6.5" cy="6.5" r="6.5" fill="#EF5B5B"/>\n\t\t\t<path fill="#FFF" d="M6 9h1v1H6zm0-6h1v5H6z"/>\n\t\t</symbol>\n\t\t<symbol id="scc-inbox-icon-active" viewBox="0 0 24 24">\n\t\t\t<linearGradient id="scc_inbox_active_1" x1="0" x2="23.998" y1="12" y2="12" gradientUnits="userSpaceOnUse">\n\t\t\t\t<stop offset="0" stop-color="var(--scc-gradient-start)"/>\n\t\t\t\t<stop offset="1" stop-color="var(--scc-gradient-stop)"/>\n\t\t\t</linearGradient>\n\t\t\t<path fill="url(#scc_inbox_active_1)" d="M19.3 0H4.7C2.1 0 0 2.1 0 4.6v18.5c0 .6.7 1.1 1.3.7l5.4-3.2c.1-.1.3-.1.4-.1h12.2c2.6 0 4.7-2.1 4.7-4.6V4.6C24 2.1 21.9 0 19.3 0zm-5.1 12.2c0 .5-.4.9-.9.9H5.5c-.5 0-.9-.4-.9-.9v-.4c0-.5.4-.9.9-.9h7.8c.5 0 .9.4.9.9v.4zm4.1-3.6H5.7c-.6 0-1.1-.5-1.1-1.1 0-.6.5-1.1 1.1-1.1h12.6c.6 0 1.1.5 1.1 1.1 0 .6-.5 1.1-1.1 1.1z"/>\n\t\t</symbol>\n\t\t<symbol id="scc-inbox-icon-inactive" viewBox="0 0 24 24">\n\t\t\t<path fill="#FFF" stroke="#B8B8B8" stroke-miterlimit="10" stroke-width=".99" d="M19.1.5H5C2.5.5.5 2.5.5 4.9v17.9c0 .6.7 1 1.2.7l5.2-3c.1-.1.3-.1.4-.1H19c2.5 0 4.5-2 4.5-4.4V4.9c0-2.4-2-4.4-4.4-4.4z"/>\n\t\t\t<path fill="#B8B8B8" d="M18.3 8.6H5.7c-.6 0-1.1-.5-1.1-1.1 0-.6.5-1.1 1.1-1.1h12.6c.6 0 1.1.5 1.1 1.1 0 .6-.5 1.1-1.1 1.1zm-5 4.5H5.5c-.5 0-.9-.4-.9-.9v-.4c0-.5.4-.9.9-.9h7.8c.5 0 .9.4.9.9v.4c0 .5-.4.9-.9.9z"/>\n\t\t</symbol>\n\t\t<symbol id="scc-message-no-new" viewBox="0 0 500 500">\n\t\t\t<circle cx="214" cy="308.7" r="184.4" fill="#A280BA" opacity=".07"/>\n\t\t\t<linearGradient id="scc_message_no_new_1" x1="101.584" x2="470.39" y1="272.917" y2="272.917" gradientUnits="userSpaceOnUse">\n\t\t\t\t<stop offset="0" stop-color="var(--scc-gradient-start)"/>\n\t\t\t\t<stop offset="1" stop-color="var(--scc-gradient-stop)"/>\n\t\t\t</linearGradient>\n\t\t\t<circle cx="286" cy="272.9" r="184.4" fill="url(#scc_message_no_new_1)" opacity=".1"/>\n\t\t\t<linearGradient id="scc_message_no_new_2" x1="137.872" x2="410.497" y1="290.784" y2="290.784" gradientUnits="userSpaceOnUse">\n\t\t\t\t<stop offset="0" stop-color="var(--scc-gradient-start)"/>\n\t\t\t\t<stop offset="1" stop-color="var(--scc-gradient-stop)"/>\n\t\t\t</linearGradient>\n\t\t\t<path fill="url(#scc_message_no_new_2)" d="M274.2 427.1c-75.2 0-136.3-61.1-136.3-136.3S199 154.5 274.2 154.5s136.3 61.1 136.3 136.3-61.2 136.3-136.3 136.3zm0-260c-68.2 0-123.7 55.5-123.7 123.7S206 414.4 274.2 414.4s123.7-55.5 123.7-123.7-55.5-123.6-123.7-123.6z"/>\n\t\t\t<path fill="#8D62C4" d="M298.2 6.9h-39.9c-7 0-12.6 5.7-12.6 12.6v50.9c0 1.8 1.9 2.9 3.5 2l14.8-8.7c.4-.2.8-.3 1.2-.3h33.2c7 0 12.6-5.7 12.6-12.6V19.6c-.1-7-5.8-12.7-12.8-12.7z"/>\n\t\t\t<path fill="#73CDE5" d="M55.6 72.8h50.8c8.9 0 16.1 7.2 16.1 16.1v64.8c0 2.3-2.5 3.7-4.4 2.5l-18.8-11.1c-.5-.3-1-.4-1.5-.4H55.6c-8.9 0-16.1-7.2-16.1-16.1V88.9c0-8.9 7.2-16.1 16.1-16.1z"/>\n\t\t\t<circle cx="182.4" cy="88.2" r="6.1" fill="#8D62C4"/>\n\t\t\t<circle cx="195.1" cy="13.5" r="6.6" fill="#8D62C4"/>\n\t\t\t<circle cx="79.7" cy="39.3" r="8.2" fill="#8D62C4"/>\n\t\t\t<path fill="#FFF" d="M325.2 210.9h-93.9c-16.4 0-29.8 13.3-29.8 29.8v119.9c0 4.2 4.6 6.8 8.2 4.7l34.7-20.5c.8-.5 1.8-.7 2.7-.7h78c16.4 0 29.8-13.3 29.8-29.8v-73.5c.1-16.6-13.2-29.9-29.7-29.9z"/>\n\t\t\t<linearGradient id="scc_message_no_new_3" x1="231.208" x2="325.46" y1="259.684" y2="259.684" gradientUnits="userSpaceOnUse">\n\t\t\t\t<stop offset="0" stop-color="var(--scc-gradient-start)"/>\n\t\t\t\t<stop offset="1" stop-color="var(--scc-gradient-stop)"/>\n\t\t\t</linearGradient>\n\t\t\t<path fill="url(#scc_message_no_new_3)" d="M318.5 266.6h-80.4c-3.8 0-6.9-3.1-6.9-6.9 0-3.8 3.1-6.9 6.9-6.9h80.4c3.8 0 6.9 3.1 6.9 6.9.1 3.8-3.1 6.9-6.9 6.9z"/>\n\t\t\t<linearGradient id="scc_d" x1="231.142" x2="292.273" y1="288.389" y2="288.389" gradientUnits="userSpaceOnUse">\n\t\t\t\t<stop offset="0" stop-color="var(--scc-gradient-start)"/>\n\t\t\t\t<stop offset="1" stop-color="var(--scc-gradient-stop)"/>\n\t\t\t</linearGradient>\n\t\t\t<path fill="url(#scc_d)" d="M286.7 295.3h-50c-3.1 0-5.6-2.5-5.6-5.6V287c0-3.1 2.5-5.6 5.6-5.6h50c3.1 0 5.6 2.5 5.6 5.6v2.7c0 3.1-2.5 5.6-5.6 5.6z"/>\n\t\t</symbol>\n\t\t<symbol id="scc-notifications-icon" viewBox="0 0 16 16">\n\t\t\t<linearGradient id="scc_notifications_1" x1=".491" x2="15.509" y1="7.995" y2="7.995" gradientUnits="userSpaceOnUse">\n\t\t\t\t<stop offset="0" stop-color="var(--scc-gradient-start)"/>\n\t\t\t\t<stop offset="1" stop-color="var(--scc-gradient-stop)"/>\n\t\t\t</linearGradient>\n\t\t\t<path fill="none" stroke="url(#scc_notifications_1)" stroke-miterlimit="10" d="m14.9 12.7-3.4-5.9V4.1c0-2-1.6-3.6-3.6-3.6S4.3 2.1 4.3 4.1v3L1 12.5c-.3.5.1 1.1.6 1.1h4.1c.2 1 1.1 1.8 2.1 1.8s2-.8 2.1-1.8h4.3c.7.1 1-.5.7-.9z"/>\n\t\t</symbol>\n\t\t<symbol id="scc-read-message-indicator-icon" viewBox="0 0 13 13">\n\t\t\t<linearGradient id="scc_read_indicator_1" x1="0" x2="13" y1="6.5" y2="6.5" gradientUnits="userSpaceOnUse">\n\t\t\t\t<stop offset="0" stop-color="var(--scc-gradient-start)"/>\n\t\t\t\t<stop offset="1" stop-color="var(--scc-gradient-stop)"/>\n\t\t\t</linearGradient>\n\t\t\t<circle cx="6.5" cy="6.5" r="6.5" fill="url(#scc_read_indicator_1)"/>\n\t\t\t<path fill="none" stroke="#fff" stroke-miterlimit="10" d="m3.3 6 2.6 2.3 3.8-4.4"/>\n\t\t</symbol>\n\t\t<symbol id="scc-search-icon" viewBox="0 0 24 24">\n\t\t\t<linearGradient id="scc_search_1" x1=".045" x2="23.094" y1="11.894" y2="11.894" gradientUnits="userSpaceOnUse">\n\t\t\t\t<stop offset="0" stop-color="var(--scc-gradient-start)"/>\n\t\t\t\t<stop offset="1" stop-color="var(--scc-gradient-stop)"/>\n\t\t\t</linearGradient>\n\t\t\t<path fill="url(#scc_search_1)" d="M22.8 21.9 15.9 15c1.4-1.6 2.2-3.6 2.2-5.9 0-5-4-9-9-9s-9 4-9 9 4 9 9 9c2 0 3.8-.6 5.3-1.7l7 7c.4.4 1.1.4 1.5 0 .3-.4.3-1.1-.1-1.5zM1 9.1C1 4.6 4.6 1 9.1 1s8.1 3.6 8.1 8.1-3.6 8.1-8.1 8.1S1 13.6 1 9.1z"/>\n\t\t</symbol>\n\t\t<symbol id="scc-smiley-icon" viewBox="0 0 13 13">\n\t\t\t<circle cx="6.5" cy="6.5" r="6" fill="none" stroke="#D7D7D7" stroke-miterlimit="10"/>\n\t\t\t<path fill="#D7D7D7" d="M4.6 4.8c.4 0 .7.3.7.7 0 .4-.3.7-.7.7-.4 0-.7-.3-.7-.7-.1-.4.3-.7.7-.7zm-.8 3.9H9c-2.8 2.6-5.2 0-5.2 0zm4.8-2.5c-.4 0-.7-.3-.7-.7 0-.4.3-.7.7-.7s.7.3.7.7c.1.4-.3.7-.7.7z"/>\n\t\t</symbol>\n\t\t<symbol id="scc-status-icon" viewBox="0 0 16 16">\n\t\t\t<linearGradient id="scc_status_1" x1="-.008" x2="15.999" y1="8.025" y2="8.025" gradientUnits="userSpaceOnUse">\n\t\t\t\t<stop offset="0" stop-color="var(--scc-gradient-start)"/>\n\t\t\t\t<stop offset="1" stop-color="var(--scc-gradient-stop)"/>\n\t\t\t</linearGradient>\n\t\t\t<circle cx="8" cy="8" r="7.5" fill="none" stroke="url(#scc_status_1)" stroke-miterlimit="10" stroke-width=".996"/>\n\t\t\t<linearGradient id="scc_status_2" x1="4.24" x2="12.359" y1="7.686" y2="7.686" gradientUnits="userSpaceOnUse">\n\t\t\t\t<stop offset="0" stop-color="var(--scc-gradient-start)"/>\n\t\t\t\t<stop offset="1" stop-color="var(--scc-gradient-stop)"/>\n\t\t\t</linearGradient>\n\t\t\t<path fill="none" stroke="url(#scc_status_2)" stroke-miterlimit="10" stroke-width=".996" d="M4.5 8.5 7.2 10 12 5"/>\n\t\t</symbol>\n\t\t<symbol id="scc-three-dots" viewBox="0 0 13 13">\n\t\t\t<circle cx="2" cy="6.5" r="2" fill="currentColor"/>\n\t\t\t<circle cx="6.5" cy="6.5" r="2" fill="currentColor"/>\n\t\t\t<circle cx="11" cy="6.5" r="2" fill="currentColor"/>\n\t\t</symbol>\n\t\t<symbol id="scc-unread-message-indicator-icon" viewBox="0 0 13 13">\n\t\t\t<circle cx="6.5" cy="6.5" r="6.5" fill="currentColor"/>\n\t\t\t<path fill="none" stroke="#fff" stroke-miterlimit="10" d="m3.3 6 2.6 2.3 3.8-4.4"/>\n\t\t</symbol>\n\t\t<symbol id="scc-message-loader-icon" viewBox="0 0 13 13">\n\t\t\t<linearGradient id="a">\n\t\t\t\t<stop offset="5%" stop-color="#a8a8a8"></stop>\n\t\t\t\t<stop offset="95%" stop-color="transparent"></stop>\n\t\t\t</linearGradient>\n\t\t\t<circle stroke="url(#a)" stroke-width="2" cx="6.5" cy="6.5" r="5" fill="none" style="stroke-dasharray: calc(40.841 / 2), calc(40.841 / 2); stroke-dashoffset: 0;" class="spin"></circle>\n\t\t</symbol>\n\t\t<symbol id="scc-message-loader-icon-2" viewBox="0 0 13 13">\n\t\t\t<linearGradient id="scc-message-loader-icon-gradient">\n\t\t\t\t<stop offset="5%" stop-color="#fff"></stop>\n\t\t\t\t<stop offset="95%" stop-color="#fff" stop-opacity=".5"></stop>\n\t\t\t</linearGradient>\n\t\t\t<circle stroke="url(#scc-message-loader-icon-gradient)" stroke-width="2" cx="6.5" cy="6.5" r="5" fill="none" style="stroke-dasharray: calc(40.841 / 2), calc(40.841 / 2); stroke-dashoffset: 0;" class="spin"></circle>\n\t\t</symbol>\n\t\t<symbol id="scc-message-attachment-icon" viewBox="0 0 42 42">\n\t\t\t<circle cx="21" cy="21" r="21" fill="#fff"/>\n\t\t\t<path fill="none" stroke="var(--scc-secondary)" stroke-miterlimit="10" d="M29.1 18.9H23v-6.1c0-1.1-.9-2-2-2s-2 .9-2 2v6.1h-6.1c-1.1 0-2 .9-2 2v.1c0 1.1.9 2 2 2H19v6.1c0 1.1.9 2 2 2h.1c1.1 0 2-.9 2-2V23h6.1c1.1 0 2-.9 2-2v-.1c-.1-1.1-1-2-2.1-2z"/>\n\t\t</symbol>\n\t\t<symbol id="scc-message-attachment-hover-icon" viewBox="0 0 42 42">\n\t\t\t<circle cx="21.1" cy="21.1" r="20.6" fill="#fff" stroke="url(#message_attachment_hover_1)" stroke-miterlimit="10" stroke-width=".9166"/>\n\t\t\t<path fill="url(#message_attachment_hover_2)" d="M31.7 20.9c-.1-1.4-1.3-2.4-2.6-2.4h-5.6v-5.6c0-1.4-1.1-2.5-2.5-2.5s-2.5 1.1-2.5 2.5v5.6h-5.6c-1.4 0-2.5 1.1-2.5 2.5s1.1 2.5 2.5 2.5h5.6v5.6c0 1.4 1.1 2.5 2.6 2.5 1.4 0 2.5-1.1 2.5-2.5v-5.6h5.6c1.4 0 2.5-1.1 2.5-2.5v-.1z"/>\n\t\t</symbol>\n\t\t<symbol id="scc-message-attachment-close-icon" viewBox="0 0 42 42">\n\t\t\t<circle cx="21" cy="21" r="21" fill="var(--scc-gradient-stop)"/>\n\t\t\t<path fill="#fff" stroke="none" style="transform-origin: center; transform: rotate(45deg);" stroke-miterlimit="10" d="M29.1 18.9H23v-6.1c0-1.1-.9-2-2-2s-2 .9-2 2v6.1h-6.1c-1.1 0-2 .9-2 2v.1c0 1.1.9 2 2 2H19v6.1c0 1.1.9 2 2 2h.1c1.1 0 2-.9 2-2V23h6.1c1.1 0 2-.9 2-2v-.1c-.1-1.1-1-2-2.1-2z"/>\n\t\t</symbol>\n\t\t<symbol id="scc-image-icon" fill="currentColor" viewBox="0 0 42 42">\n\t\t\t<path fill="none" d="M21 .6c11.5 0 20.5 9 20.5 20.5s-9 20.5-20.5 20.5S.5 32.6.5 21.1 9.5.6 21 .6" />\n\t\t\t<path fill="currentColor" d="M21 42C9.2 42 0 32.8 0 21S9.2 0 21 0s21 9.2 21 21-9.2 21-21 21zm0-41C9.8 1 1 9.8 1 21.1c0 11.2 8.8 20 20 20s20-8.8 20-20C41 9.8 32.3 1 21 1z" />\n\t\t\t<circle fill="currentColor" cx="26.1" cy="16.6" r="3.1" />\n\t\t\t<path fill="currentColor" d="M29.3 10.8H13.1c-1.4 0-2.6 1.2-2.6 2.6v16.3c0 1.4 1.2 2.6 2.6 2.6h16.3c1.4 0 2.6-1.2 2.6-2.6V13.4c-.1-1.4-1.2-2.6-2.7-2.6zm-16.2.9h16.3c1 0 1.7.7 1.7 1.7v15.2l-14.7-7.1-4.9 3.6V13.4c-.1-1 .7-1.7 1.6-1.7z" />\n\t\t</symbol>\n\t\t<symbol id="scc-video-icon" fill="currentColor" viewBox="0 0 42 42">\n\t\t\t<path fill="none" d="M21 .6c11.5 0 20.5 9 20.5 20.5s-9 20.5-20.5 20.5S.5 32.6.5 21.1 9.5.6 21 .6" />\n\t\t\t<path fill="currentColor" d="M21 42C9.2 42 0 32.8 0 21S9.2 0 21 0s21 9.2 21 21-9.2 21-21 21zm0-41C9.8 1 1 9.8 1 21.1c0 11.2 8.8 20 20 20s20-8.8 20-20C41 9.8 32.3 1 21 1z" />\n\t\t\t<path fill="none" stroke="currentColor" stroke-miterlimit="10" d="M29.3 10.8H13.1c-1.4 0-2.6 1.2-2.6 2.6v16.3c0 1.4 1.2 2.6 2.6 2.6h16.3c1.4 0 2.6-1.2 2.6-2.6V13.4c-.1-1.4-1.2-2.6-2.7-2.6z" />\n\t\t\t<path fill="currentColor" d="M21.3 16.9c-2.7 0-4.8 2.1-4.8 4.8s2.1 4.8 4.8 4.8 4.8-2.1 4.8-4.8c0-2.6-2.1-4.8-4.8-4.8zm2.5 5.4L19.6 24c-.4.2-.8-.1-.8-.6V20c0-.5.5-.7.8-.6l4.2 1.8c.5.1.5.9 0 1.1z" />\n\t\t</symbol>\n\t\t<symbol id="scc-audio-icon" fill="currentColor" viewBox="0 0 42 42">\n\t\t\t<path fill="none" d="M21 .6c11.5 0 20.5 9 20.5 20.5s-9 20.5-20.5 20.5S.5 32.6.5 21.1 9.5.6 21 .6" />\n\t\t\t<path fill="currentColor" d="M21 42C9.2 42 0 32.8 0 21S9.2 0 21 0s21 9.2 21 21-9.2 21-21 21zm0-41C9.8 1 1 9.8 1 21.1c0 11.2 8.8 20 20 20s20-8.8 20-20C41 9.8 32.3 1 21 1z" />\n\t\t\t<path fill="currentColor" d="M32.6 21.5c0 2.5-.8 4.7-2.2 6.7-.3.5-.7.6-1.1.3-.3-.3-.3-.6 0-1.1 1-1.4 1.7-2.9 1.9-4.6.3-2.6-.3-5-1.8-7.1-.1-.1-.1-.2-.2-.3-.2-.3-.2-.7.1-.9.3-.2.7-.2.9.1.5.8 1 1.5 1.4 2.3.7 1.5 1 3.1 1 4.6z" />\n\t\t\t<path fill="currentColor" d="M30.1 21.4c0 2-.5 3.6-1.6 5.1-.2.2-.3.5-.6.4-.2 0-.4-.2-.6-.3-.2-.2-.1-.5 0-.7.3-.5.6-1 .9-1.6.9-2.4.7-4.7-.7-6.9 0-.1-.1-.1-.2-.2-.2-.3-.2-.7.2-.9.3-.2.7-.2.9.2.9 1.2 1.4 2.6 1.6 4.1.1.3.1.6.1.8z" />\n\t\t\t<path fill="currentColor" d="M27.5 21.5c0 1.1-.3 2.1-.8 3.1-.3.4-.6.6-1 .3-.4-.2-.4-.6-.2-1 .9-1.6.9-3.2 0-4.8-.2-.4-.2-.8.2-1 .3-.2.7-.1 1 .3.5 1 .8 2 .8 3.1z" />\n\t\t\t<path fill="currentColor" stroke="currentColor" stroke-width=".935" stroke-miterlimit="10" d="m21.6 10.8-8.7 4.9h-2.5c-1 0-1.9.8-1.9 1.9V25c0 1 .8 1.9 1.9 1.9h2.4l8.6 5c.8.4 1.7-.1 1.7-1l.1-9.5v-9.6c.1-.8-.9-1.4-1.6-1z" />\n\t\t</symbol>\n\t\t<symbol id="scc-file-icon" fill="currentColor" viewBox="0 0 42 42">\n\t\t\t<path fill="none" d="M21 .6c11.5 0 20.5 9 20.5 20.5s-9 20.5-20.5 20.5S.5 32.6.5 21.1 9.5.6 21 .6" />\n\t\t\t<path fill="currentColor" d="M21 42C9.2 42 0 32.8 0 21S9.2 0 21 0s21 9.2 21 21-9.2 21-21 21zm0-41C9.8 1 1 9.8 1 21.1c0 11.2 8.8 20 20 20s20-8.8 20-20C41 9.8 32.3 1 21 1z" />\n\t\t\t<path fill="none" stroke="currentColor" stroke-miterlimit="10" d="M25.7 32.4h-9.4c-1.9 0-3.4-1.5-3.4-3.4V13.9c0-1.9 1.5-3.4 3.4-3.4h12.8V29c0 1.9-1.5 3.4-3.4 3.4z" />\n\t\t\t<path fill="none" stroke="currentColor" stroke-width="1.048" stroke-linecap="round" stroke-miterlimit="10" d="M15.8 18.3h8.4"/>\n\t\t\t<path fill="none" stroke="currentColor" stroke-width="1.048" stroke-linecap="round" stroke-miterlimit="10" d="M15.8 21.3h5.9"/>\n\t\t</symbol>\n\t\t<symbol id="scc-word-icon" fill="currentColor" viewBox="0 0 42 42">\n\t\t\t<path fill="none" d="M21 .6c11.5 0 20.5 9 20.5 20.5s-9 20.5-20.5 20.5S.5 32.6.5 21.1 9.5.6 21 .6"/>\n\t\t\t<path fill="currentColor" d="M21 42C9.2 42 0 32.8 0 21S9.2 0 21 0s21 9.2 21 21-9.2 21-21 21zm0-41C9.8 1 1 9.8 1 21.1c0 11.2 8.8 20 20 20s20-8.8 20-20C41 9.8 32.3 1 21 1z" />\n\t\t\t<path fill="none" stroke="currentColor" stroke-miterlimit="10" d="M23.7 32.4h-9.4c-1.9 0-3.4-1.5-3.4-3.4V13.9c0-1.9 1.5-3.4 3.4-3.4h12.8V29c0 1.9-1.5 3.4-3.4 3.4z" />\n\t\t\t<path fill="none" stroke="currentColor" stroke-width="1.048" stroke-linecap="round" stroke-miterlimit="10" d="M13.8 18.3h8.4"/>\n\t\t\t<path fill="none" stroke="currentColor" stroke-width="1.048" stroke-linecap="round" stroke-miterlimit="10" d="M13.8 21.3h5.9"/>\n\t\t\t<path fill="currentColor" d="M31.4 30.4h-9.6v-7.5c0-1.2 1-2.1 2.1-2.1h7.5v9.6z" />\n\t\t\t<path fill="#ffffff" d="M28.3 27.2c0-.3.1-.6.2-.9.2-.9.4-1.9.5-2.8 0-.3.1-.5.1-.8 0 0 0-.1.1-.1h1.1c0 .2-.1.3-.1.5L29 28.2c0 .1-.1.1-.2.1h-1c-.1 0-.1 0-.1-.1l-.9-3.9c0-.2-.1-.4-.1-.6 0 .2-.1.4-.1.5-.1.6-.3 1.3-.4 1.9-.1.7-.3 1.3-.5 2 0 .1-.1.1-.2.1h-1.1c-.1 0-.1 0-.1-.1-.4-1.8-.9-3.6-1.3-5.5v-.2h1.1c.1 0 .1 0 .1.1.3 1.3.5 2.5.8 3.8.1.3.1.5.1.7.1-.6.3-1.3.4-2 .2-.8.4-1.7.6-2.5 0-.1 0-.1.1-.1h1c.1 0 .1 0 .1.1.3 1.1.5 2.3.8 3.4 0 .6.1 1 .2 1.3z"/>\n\t\t</symbol>\n\t\t<symbol id="scc-excel-icon" fill="currentColor" viewBox="0 0 42 42">\n\t\t\t<path fill="none" d="M21 .6c11.5 0 20.5 9 20.5 20.5s-9 20.5-20.5 20.5S.5 32.6.5 21.1 9.5.6 21 .6"/>\n\t\t\t<path fill="currentColor" d="M21 42C9.2 42 0 32.8 0 21S9.2 0 21 0s21 9.2 21 21-9.2 21-21 21zm0-41C9.8 1 1 9.8 1 21.1c0 11.2 8.8 20 20 20s20-8.8 20-20C41 9.8 32.3 1 21 1z" />\n\t\t\t<path fill="none" stroke="currentColor" stroke-miterlimit="10" d="M23.7 32.4h-9.4c-1.9 0-3.4-1.5-3.4-3.4V13.9c0-1.9 1.5-3.4 3.4-3.4h12.8V29c0 1.9-1.5 3.4-3.4 3.4z" />\n\t\t\t<path fill="none" stroke="currentColor" stroke-width="1.048" stroke-linecap="round" stroke-miterlimit="10" d="M13.8 18.3h8.4"/>\n\t\t\t<path fill="none" stroke="currentColor" stroke-width="1.048" stroke-linecap="round" stroke-miterlimit="10" d="M13.8 21.3h5.9"/>\n\t\t\t<path fill="currentColor" d="M31.4 30.4h-9.6v-7.5c0-1.2 1-2.1 2.1-2.1h7.5v9.6z" />\n\t\t\t<path fill="#ffffff" d="m29.2 28.3-1.8-2.8 1.8-2.7h-1.3l-1.1 1.6-1-1.6h-1.3l1.6 2.7-1.8 2.8h1.3l1.2-1.8 1.1 1.8z"/>\n\t\t</symbol>\n\t\t<symbol id="scc-tip-icon" viewBox="0 0 42 42">\n\t\t\t<path fill="var(--scc-bg)" d="M21 0c11.8 0 21 9.2 21 21s-9.2 21-21 21S0 32.8 0 21 9.2 0 21 0"/>\n\t\t\t<linearGradient id="tip_1" x1="9.09" x2="32.91" y1="21" y2="21" gradientUnits="userSpaceOnUse">\n\t\t\t\t<stop offset="0" stop-color="var(--scc-gradient-start)"/>\n\t\t\t\t<stop offset="1" stop-color="var(--scc-gradient-stop)"/>\n\t\t\t</linearGradient>\n\t\t\t<path fill="url(#tip_1)" d="M21 32.9c-6.6 0-11.9-5.3-11.9-11.9 0-6.6 5.3-11.9 11.9-11.9 6.6 0 11.9 5.3 11.9 11.9 0 6.6-5.3 11.9-11.9 11.9zm0-22.8c-6 0-10.9 4.9-10.9 10.9S15 31.9 21 31.9 31.9 27 31.9 21 27 10.1 21 10.1z"/>\n\t\t\t<linearGradient id="tip_2" x1="17.55" x2="24.45" y1="21" y2="21" gradientUnits="userSpaceOnUse">\n\t\t\t\t<stop offset="0" stop-color="var(--scc-gradient-start)"/>\n\t\t\t\t<stop offset="1" stop-color="var(--scc-gradient-stop)"/>\n\t\t\t</linearGradient>\n\t\t\t<path fill="url(#tip_2)" d="M20.4 28.6v-1.9c-1.1 0-2.2-.4-2.8-.8l.4-1.2c.7.4 1.6.8 2.7.8 1.3 0 2.2-.8 2.2-1.8s-.7-1.6-2.1-2.2c-1.9-.7-3-1.6-3-3.2 0-1.5 1.1-2.7 2.8-3v-1.9h1.1v1.8c1.1 0 1.9.3 2.4.6l-.5 1.2c-.4-.2-1.1-.6-2.3-.6-1.4 0-2 .8-2 1.6 0 1 .7 1.4 2.3 2.1 1.9.8 2.9 1.7 2.9 3.4 0 1.5-1 2.8-2.9 3.1v1.9h-1.2z"/>x\n\t\t</symbol>\n\t\t<symbol id="scc-headshot" viewBox="0 0 42 42">\n\t\t\t<linearGradient id="headshot-1" gradientUnits="userSpaceOnUse" x1="2.296" y1="12.401" x2="39.485" y2="12.401" gradientTransform="matrix(1 0 0 -1 0 43.323)">\n\t\t\t\t<stop offset="0" stop-color="var(--scc-gradient-start)"/>\n\t\t\t\t<stop offset="1" stop-color="var(--scc-gradient-stop)"/>\n\t\t\t</linearGradient>\n\t\t\t<path fill="url(#headshot-1)" d="M29.3 41.6H12.4c-5.6 0-10.1-4.5-10.1-10.1v-1.1c0-5.6 4.5-10.1 10.1-10.1h1.2l.2.2c1.6 1.9 4.1 3.1 7.2 3.3 4.1.3 5.1-.9 6.6-2.7.2-.2.3-.4.5-.6l.2-.2h1.2c5.6 0 10.1 4.5 10.1 10.1v1.1c-.1 5.5-4.7 10.1-10.3 10.1zM12.4 21.4c-4.9 0-8.9 4-8.9 8.9v1.1c0 4.9 4 8.9 8.9 8.9h17c4.9 0 8.9-4 8.9-8.9v-1.1c0-4.9-4-8.9-8.9-8.9h-.6c-.1.1-.2.2-.3.4-1.6 1.9-2.9 3.5-7.6 3.1-3.2-.2-6-1.4-7.8-3.5h-.7z" />\n\t\t\t<linearGradient id="headshot-2" gradientUnits="userSpaceOnUse" x1="10.328" y1="32.44" x2="31.413" y2="32.44" gradientTransform="matrix(1 0 0 -1 0 43.323)">\n\t\t\t\t<stop offset="0" stop-color="var(--scc-gradient-start)"/>\n\t\t\t\t<stop offset="1" stop-color="var(--scc-gradient-stop)"/>\n\t\t\t</linearGradient>\n\t\t\t<path fill="url(#headshot-2)" d="M20.9 21.4c-5.8 0-10.5-4.8-10.5-10.5S15.1.4 20.9.4s10.5 4.8 10.5 10.5-4.7 10.5-10.5 10.5zm0-19.8c-5.2 0-9.3 4.2-9.3 9.3s4.2 9.3 9.3 9.3 9.3-4.2 9.3-9.3-4.2-9.3-9.3-9.3z" />\n\t\t</symbol>\n\t\t<symbol id="scc-edit-message" viewBox="0 0 15 15">\n\t\t\t<path fill="currentColor" d="M 9.328 2.504 L 12.38 5.57 L 4.656 13.33 L 1.606 10.265 L 9.328 2.504 Z M 14.694 1.763 L 13.334 0.397 C 12.808 -0.132 11.954 -0.132 11.426 0.397 L 10.123 1.705 L 13.175 4.773 L 14.694 3.245 C 15.103 2.835 15.103 2.173 14.694 1.763 Z M 0.009 14.575 C -0.046 14.826 0.179 15.051 0.429 14.99 L 3.83 14.161 L 0.78 11.095 L 0.009 14.575 Z" />\n\t\t</symbol>\n\t\t<symbol id="scc-safe-icon" viewBox="0 0 24 24">\n            <path fill="currentColor" d="M9.4 22.3H7.2c-.4 0-.7-.3-.7-.7 0-.4.3-.7.7-.7h2.3c.4 0 .7.3.7.7 0 .4-.4.7-.8.7zm6.8 0h-2.3c-.4 0-.7-.3-.7-.7 0-.4.3-.7.7-.7h2.3c.4 0 .7.3.7.7 0 .4-.3.7-.7.7zM11.9 5.1c-1.2 0-2.1.9-2.1 2.1 0 1.2.9 2.1 2.1 2.1 1.2 0 2.1-.9 2.1-2.1 0-1.2-.9-2.1-2.1-2.1zm0 3.6c-.8 0-1.5-.7-1.5-1.5s.7-1.5 1.5-1.5 1.5.7 1.5 1.5-.7 1.5-1.5 1.5z" class="st0"/>\n\t\t\t<path fill="currentColor" d="m12.9 6.1-.7.5c-.1-.1-.2-.1-.4-.1-.4 0-.7.3-.7.7 0 .4.3.7.7.7.4 0 .7-.3.7-.7V7l.4-.9zm1.8 7.8H14c-.1-.2-.1-.4-.3-.6l.6-.6c.2-.2.2-.6 0-.8s-.6-.2-.8 0l-.6.6c-.2-.1-.4-.2-.6-.2v-.9c0-.3-.2-.5-.5-.5s-.5.2-.5.5v.9c-.2.1-.4.1-.6.2l-.7-.7a.6.6 0 0 0-.8 0c-.2.2-.2.6 0 .8l.6.6-.3.6h-1c-.3 0-.5.2-.5.5 0 .4.2.7.6.7h1c.1.2.1.4.2.6l-.6.6c-.2.2-.2.5 0 .8.2.2.6.2.8 0l.6-.6.6.3v.9c0 .3.2.5.5.5s.5-.3.5-.5v-.9c.2-.1.4-.1.6-.3l.6.6c.2.2.6.2.8 0 .2-.2.2-.6 0-.8l-.6-.6c.1-.2.2-.4.2-.6h.7c.3 0 .5-.2.5-.5.2-.4 0-.6-.3-.6zm-2.9 1.5c-.6 0-1.1-.5-1.1-1.1 0-.6.5-1.1 1.1-1.1.6 0 1.1.5 1.1 1.1 0 .6-.5 1.1-1.1 1.1z" class="st0"/>\n\t\t\t<path fill="none" stroke="currentColor" stroke-miterlimit="10" stroke-width="1.25" d="M16.4 20.9H6.9a2 2 0 0 1-2-2V4.3c0-1.1.9-2 2-2h9.5a2 2 0 0 1 2 2v14.6c0 1.1-.8 2-2 2z"/>\n\t\t</symbol>\n\t\t<symbol id="scc-file-sharing-icon" viewBox="0 0 24 24">\n\t\t\t<path fill="none" stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="1.25" d="M18.75 13.84v5.58a2 2 0 0 1-2 2.14h-9.5a2.09 2.09 0 0 1-2-2.15v-5.7"/>\n\t\t\t<path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.25" d="m7.48 6.88 4.53-4.45 4.51 4.46M12 3.08v13"/>\n\t\t</symbol>\n\t\t<symbol id="scc-dollar-icon" viewBox="0 0 42 42">\n\t\t\t<path fill="none" d="M21 .6a20.28 20.28 0 0 1 20.5 20.5A20.28 20.28 0 0 1 21 41.6 20.28 20.28 0 0 1 .5 21.1 20.28 20.28 0 0 1 21 .6"/>\n\t\t\t<path fill="currentColor" d="M21 42A20.75 20.75 0 0 1 0 21 20.75 20.75 0 0 1 21 0a20.75 20.75 0 0 1 21 21 20.75 20.75 0 0 1-21 21Zm0-41A19.83 19.83 0 0 0 1 21.1a19.81 19.81 0 0 0 20 20 19.81 19.81 0 0 0 20-20A19.77 19.77 0 0 0 21 1Z"/>\n\t\t\t<path fill="currentColor" d="M19.91 32.81V30a8.13 8.13 0 0 1-4.15-1.18l.6-1.78a7.84 7.84 0 0 0 4 1.19c1.92 0 3.25-1.19 3.25-2.67s-1-2.36-3.1-3.25c-2.81-1-4.44-2.37-4.44-4.73a4.59 4.59 0 0 1 4.14-4.44v-2.81h1.63V13a6.9 6.9 0 0 1 3.55.89l-.74 1.77a6.88 6.88 0 0 0-3.4-.88c-2.07 0-3 1.18-3 2.36 0 1.48 1 2.07 3.4 3.11 2.81 1.18 4.29 2.51 4.29 5 0 2.22-1.48 4.14-4.29 4.58v2.81h-1.74Z"/>\n\t\t</symbol>\n\t\t<symbol id="scc-setting-icon" viewBox="0 0 16 16">\n\t\t\t<linearGradient id="setting_1" x1=".078" x2="15.968" y1="8" y2="8" gradientUnits="userSpaceOnUse">\n\t\t\t\t<stop offset="0" stop-color="var(--scc-gradient-start)"/>\n\t\t\t\t<stop offset="1" stop-color="var(--scc-gradient-stop)"/>\n\t\t\t</linearGradient>\n\t\t    <path fill="url(#setting_1)" d="M8.4 16h-1c-.8 0-1.4-.7-1.4-1.4v-.4c-.3-.1-.6-.2-.9-.4l-.4.3c-.6.5-1.4.4-2-.2l-.7-.7c-.6-.6-.6-1.4-.1-2l.3-.4c-.2-.3-.3-.6-.4-.9l-.5-.2C.6 9.6.1 9 .1 8.3v-1c0-.7.6-1.4 1.3-1.5h.4c.1-.3.2-.7.4-.9L2 4.5c-.5-.5-.5-1.4.1-2l.7-.7c.5-.5 1.3-.6 2-.1l.3.3c.3-.2.7-.3 1.2-.4v-.3C6.4.6 7 0 7.7 0h1c.8 0 1.4.6 1.4 1.4v.3c.4.1.7.3 1 .4l.3-.2c.7-.5 1.4-.4 2 .2l.8.7c.6.6.6 1.4.1 2l-.3.4c.2.3.3.6.4.9h.3c.7.1 1.3.8 1.3 1.5v1c0 .7-.6 1.4-1.3 1.5h-.3c-.1.3-.3.6-.4.9l.3.3c.5.7.4 1.4-.2 2l-.7.7c-.6.6-1.4.6-2 .1l-.3-.2c-.3.2-.6.3-1 .4l-.1.4c-.3.7-.9 1.3-1.6 1.3zM5 12.6l.3.2c.4.3.8.4 1.2.5l.3.1.2 1.1c0 .3.2.5.4.5h1c.3 0 .5-.2.5-.4l.2-1 .3-.1c.4-.1.9-.3 1.3-.5l.3-.2.8.7c.2.2.5.2.7 0l.7-.7c.2-.2.3-.4.1-.7l-.6-.8.2-.3c.2-.4.5-.9.6-1.3l.1-.3 1-.1c.2-.3.4-.5.4-.7v-1c0-.3-.2-.5-.4-.5l-1-.1-.1-.3c-.1-.4-.3-.9-.5-1.3l-.2-.3.8-.9c.1-.2.2-.5 0-.7l-.8-.7c-.2-.2-.4-.3-.7-.1l-.8.6-.3-.2c-.4-.2-.8-.5-1.4-.6h-.4l-.1-1c0-.3-.2-.5-.4-.5h-1c-.2 0-.4.2-.5.4l-.1 1h-.4c-.5.2-1 .3-1.4.5l-.2.2-.9-.5c-.2-.3-.5-.2-.7 0l-.7.6c-.2.2-.3.4 0 .7l.7.9-.2.3c-.3.4-.5.8-.6 1.3l-.1.3-1.1.1c-.3 0-.5.3-.5.5v1c0 .3.2.5.4.5l1.1.4.1.2c.1.4.3.8.5 1.2l.2.3-.7.9c-.2.2-.2.5 0 .7l.7.7c.2.2.4.3.7.1l1-.7zm3.1-1.7H8c-.8 0-1.6-.3-2.2-1-.6-.6-.9-1.4-.9-2.2 0-1.7 1.4-3.1 3.2-3.1.9 0 1.7.3 2.3 1 .6.6.9 1.4.8 2.2 0 .8-.3 1.6-1 2.2-.6.6-1.3.9-2.1.9zm0-5.3c-1.2 0-2.2 1-2.2 2.1 0 .6.2 1.1.6 1.5.4.4 1 .7 1.5.7.6 0 1.1-.2 1.5-.6.4-.4.7-1 .7-1.5 0-.6-.2-1.1-.6-1.5-.4-.4-1-.7-1.5-.7z"/>\n\t\t</symbol>\n\t\t<symbol id="scc-dollar-icon-2" viewBox="0 0 48 48">\n\t\t\t<path fill="currentColor" d="M24 0A24 24 0 0 0 0 24a24 24 0 0 0 24 24 24 24 0 0 0 24-24A24 24 0 0 0 24 0zm-1.43 2.89h3.28v5a14.3 14.3 0 0 1 6.67 1.79l-1.26 3.45a12.27 12.27 0 0 0-6.49-1.78c-3.93 0-5.42 2.38-5.42 4.4 0 2.03 1.91 3.93 6.38 5.96 4.46 2.02 7.92 4.82 7.92 9.4a9 9 0 0 1-8.16 8.58V45h-3.34v-5.12a14.05 14.05 0 0 1-7.8-2.26l1.25-3.46a13.7 13.7 0 0 0 7.39 2.2c3.69 0 5.95-2.08 5.95-5 0-2.91-2.02-4.58-5.95-5.95-5-2.26-8.1-4.59-8.1-9.05a8.34 8.34 0 0 1 7.68-8.22z"/>\n\t\t</symbol>\n\t\t<symbol id="scc-delay-message" viewBox="0 0 16 16">\n\t\t\t<path fill="currentColor" d="M3.7.252C1.852.252.45 1.782.45 3.6v11c0 .416.237.793.537.984.3.191.663.25 1.018.13l.07-.023 3.32-2.035.004-.008h.713a5.606 5.606 0 0 1-.033-.072 5.606 5.606 0 0 1-.254-.945 5.606 5.606 0 0 1-.023-.28H5.1s-.122.007-.196.028a.819.819 0 0 0-.226.105c-.065.043-.103.126-.156.186l-2.774 1.7V3.6c0-1.183.797-2.051 1.951-2.051h8.5c1.03 0 1.852.868 1.852 2.05V6.75a5.606 5.606 0 0 1 .1.053 5.606 5.606 0 0 1 .277.172 5.606 5.606 0 0 1 .267.187 5.606 5.606 0 0 1 .256.201 5.606 5.606 0 0 1 .244.217 5.606 5.606 0 0 1 .155.154V3.6c0-1.818-1.38-3.348-3.15-3.348H3.7z" />\n\t\t\t<path fill="currentColor" d="M3.4 4.752a.649.649 0 0 0-.648.648.649.649 0 0 0 .648.649h8.8a.649.649 0 0 0 .65-.649.649.649 0 0 0-.65-.648z" />\n\t\t\t<path fill="currentColor" d="M6.975 8.15H3.4a.649.649 0 0 0-.648.65.649.649 0 0 0 .648.65h2.805a5.606 5.606 0 0 1 .092-.223 5.606 5.606 0 0 1 .305-.551 5.606 5.606 0 0 1 .363-.514 5.606 5.606 0 0 1 .01-.012z" />\n\t\t\t<path fill="currentColor" d="M10.801 6.6a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4zm.006.601a.76.76 0 0 1 .068.002l.067.008a.895.895 0 0 1 .302.101.63.63 0 0 1 .051.036.575.575 0 0 1 .158.182.54.54 0 0 1 .059.256v2.72l1.166 1.166a.718.718 0 0 1 .125.172c.01.02.016.04.023.06a.574.574 0 0 1-.02.428c-.007.02-.017.038-.026.057a.823.823 0 0 1-.15.207.839.839 0 0 1-.384.215.623.623 0 0 1-.183.01.537.537 0 0 1-.123-.028c-.02-.007-.04-.014-.06-.024a.598.598 0 0 1-.061-.033.448.448 0 0 1-.057-.043.621.621 0 0 1-.057-.049l-1.554-1.554a3.312 3.312 0 0 1-.114-.117.512.512 0 0 1-.056-.079.254.254 0 0 1-.021-.078 1.24 1.24 0 0 1-.005-.117V7.785a.75.75 0 0 1 .217-.355.55.55 0 0 1 .109-.082c.019-.012.039-.025.059-.036s.041-.02.063-.029a.968.968 0 0 1 .064-.025 1.054 1.054 0 0 1 .203-.047l.068-.008c.022-.002.046-.002.069-.002z" transform="translate(.547 1.059)"/>\n\t\t</symbol>\n\t\t<symbol id="scc-switch-contact-list" viewBox="0 0 25 22">\n\t\t\t<path fill="currentColor" transform="translate(-613.63356,-421.76272)" d="M 638.43302,428.60437 L 616.99684,428.60437 L 620.48136,432.82082 L 619.57337,433.7878 L 613.83406,427.81345 L 619.57337,421.781 L 620.48136,422.74709 L 616.99684,426.96444 L 638.43302,426.96444 L 638.43302,428.60437 z M 638.43302,437.71113 L 632.69282,443.74446 L 631.78482,442.77749 L 635.27024,438.56103 L 613.83406,438.56103 L 613.83406,436.9211 L 635.27024,436.9211 L 631.78482,432.70375 L 632.69282,431.73767 L 638.43302,437.71113 z" />\n\t\t</symbol>\n\t\t<symbol id="scc-star-icon" viewBox="0 0 512 512">\n\t\t  <path fill="var(--scc-secondary)" d="M256 512a11 11 0 0 1-7.8-3.2l-47.4-46.9-64.4 17-2.9.3c-5 0-9.3-3.4-10.7-8.2l-17.5-64.3L41 389.2a11.2 11.2 0 0 1-7.8-13.6L50 311.2 3.2 263.8a11.2 11.2 0 0 1 0-15.6l46.9-47.4-17-64.4c-1.5-5.9 2-12 7.9-13.6l64.3-17.5L122.8 41a11.1 11.1 0 0 1 13.6-7.8L200.8 50l47.4-46.9a11 11 0 0 1 15.6 0L311.2 50l64.4-17c1-.2 1.9-.3 2.9-.3 5 0 9.4 3.4 10.7 8.2l17.5 64.3 64.3 17.5c5.9 1.6 9.4 7.7 7.8 13.6L462 200.8l46.9 47.4a11.2 11.2 0 0 1 0 15.6L462 311.2l17 64.4c1.5 5.9-2 12-7.9 13.6l-64.3 17.5-17.5 64.3a11.1 11.1 0 0 1-13.6 7.8L311.2 462l-47.4 46.9a11 11 0 0 1-7.8 3.2z"/>\n\t\t</symbol>\n\t\t<symbol id="scc-creator-messages-duplicate-icon" viewBox="0 0 15 15">\n\t\t\t<defs>\n\t\t\t\t<mask fill="white" id="clip577">\n\t\t\t\t\t<path d="M 11.019867549668875 7.609271523178807  C 11.019867549668875 9.198675496688741  9.748344370860929 10.470198675496688  8.158940397350992 10.47019867549669  L 3.4966887417218544 10.47019867549669  C 1.9072847682119203 10.47019867549669  0.635761589403973 9.198675496688743  0.635761589403973 7.609271523178807  L 0.635761589403973 3.7947019867549656  C 0.635761589403973 2.3112582781456945  1.90728476821192 0.9337748344370853  3.4966887417218544 0.9337748344370853  L 8.158940397350994 0.9337748344370853  C 9.748344370860929 0.9337748344370853  11.019867549668875 2.2052980132450326  11.019867549668875 3.7947019867549656  L 11.019867549668875 7.609271523178807  Z " fill-rule="evenodd"></path>\n\t\t\t\t</mask>\n\t\t\t</defs>\n\t\t\t<g transform="matrix(1.056138, 0, 0, 1.056097, -1103.190796, -429.11972)">\n\t\t\t\t<path d="M 11.019867549668875 7.609271523178807  C 11.019867549668875 9.198675496688741  9.748344370860929 10.470198675496688  8.158940397350992 10.47019867549669  L 3.4966887417218544 10.47019867549669  C 1.9072847682119203 10.47019867549669  0.635761589403973 9.198675496688743  0.635761589403973 7.609271523178807  L 0.635761589403973 3.7947019867549656  C 0.635761589403973 2.3112582781456945  1.90728476821192 0.9337748344370853  3.4966887417218544 0.9337748344370853  L 8.158940397350994 0.9337748344370853  C 9.748344370860929 0.9337748344370853  11.019867549668875 2.2052980132450326  11.019867549668875 3.7947019867549656  L 11.019867549668875 7.609271523178807  Z " fill-rule="nonzero" fill="#ffffff" stroke="none" fill-opacity="0" transform="matrix(1 0 0 1 1044 410 )"></path>\n\t\t\t\t<path d="M 11.019867549668875 7.609271523178807  C 11.019867549668875 9.198675496688741  9.748344370860929 10.470198675496688  8.158940397350992 10.47019867549669  L 3.4966887417218544 10.47019867549669  C 1.9072847682119203 10.47019867549669  0.635761589403973 9.198675496688743  0.635761589403973 7.609271523178807  L 0.635761589403973 3.7947019867549656  C 0.635761589403973 2.3112582781456945  1.90728476821192 0.9337748344370853  3.4966887417218544 0.9337748344370853  L 8.158940397350994 0.9337748344370853  C 9.748344370860929 0.9337748344370853  11.019867549668875 2.2052980132450326  11.019867549668875 3.7947019867549656  L 11.019867549668875 7.609271523178807  Z " stroke-width="2" stroke="currentColor" fill="none" transform="matrix(1 0 0 1 1044 410 )" mask="url(#clip577)"></path>\n\t\t\t\t<path d="M 1047.869 410.648 L 1047.869 409.695 C 1047.869 408.105 1049.141 406.834 1050.73 406.834 L 1055.392 406.834 C 1056.982 406.834 1058.253 408.105 1058.253 409.695 L 1058.253 413.509 C 1058.253 415.099 1056.982 416.37 1055.392 416.37 L 1055.18 416.37" stroke-width="1" stroke="currentColor" fill="none"></path>\n\t\t\t\t<path d="M 1053.236 415.635 C 1053.236 415.317 1053.024 415.105 1052.812 415.105 L 1050.375 415.105 L 1050.375 412.774 C 1050.375 412.456 1050.163 412.244 1049.845 412.244 C 1049.527 412.244 1049.315 412.456 1049.315 412.774 L 1049.315 415.105 L 1046.984 415.105 C 1046.666 415.105 1046.454 415.317 1046.454 415.635 C 1046.454 415.953 1046.666 416.165 1046.984 416.165 L 1049.315 416.165 L 1049.315 418.496 C 1049.315 418.814 1049.527 419.026 1049.845 419.026 C 1050.163 419.026 1050.375 418.814 1050.375 418.496 L 1050.375 416.165 L 1052.706 416.165 C 1053.024 416.165 1053.236 415.953 1053.236 415.635 Z" fill-rule="nonzero" fill="currentColor" stroke="none"></path>\n\t\t\t</g>\n\t\t</symbol>\n\t\t<symbol id="scc-creator-messages-cancel-icon" viewBox="0 0 15 15">\n\t\t\t<g transform="matrix(1 0 0 1 -1164 -406 )">\n\t\t\t\t<path d="M 1171.5 406.5  C 1175.42 406.5  1178.5 409.58  1178.5 413.5  C 1178.5 417.42  1175.42 420.5  1171.5 420.5  C 1167.58 420.5  1164.5 417.42  1164.5 413.5  C 1164.5 409.58  1167.58 406.5  1171.5 406.5  Z " stroke-width="1" stroke="currentColor" fill="none"></path>\n\t\t\t\t<path d="M 1174.273 415.663 L 1172.033 413.516 L 1174.18 411.369 C 1174.367 411.183 1174.367 410.903 1174.18 410.716 C 1173.993 410.529 1173.713 410.529 1173.527 410.716 L 1171.38 412.863 L 1169.233 410.716 C 1169.047 410.529 1168.767 410.529 1168.58 410.716 C 1168.393 410.903 1168.393 411.183 1168.58 411.369 L 1170.727 413.516 L 1168.58 415.663 C 1168.393 415.849 1168.393 416.129 1168.58 416.316 C 1168.673 416.409 1168.767 416.409 1168.953 416.409 C 1169.14 416.409 1169.233 416.409 1169.327 416.316 L 1171.38 414.169 L 1173.527 416.316 C 1173.62 416.409 1173.713 416.409 1173.9 416.409 C 1174.087 416.409 1174.18 416.409 1174.273 416.316 C 1174.46 416.129 1174.46 415.849 1174.273 415.663 Z" fill-rule="nonzero" fill="currentColor" stroke="none"></path>\n\t\t\t</g>\n\t\t</symbol>\n\t\t<symbol id="scc-creator-messages-price-icon" viewBox="0 0 42 42">\n\t\t\t<path d="M 21 0  C 32.76 0  42 9.239999999999998  42 21  C 42 32.76  32.76 42  21 42  C 9.239999999999998 42  0 32.76  0 21  C 0 9.239999999999998  9.239999999999998 0  21 0  Z " fill="#ffffff"></path>\n\t\t\t<path d="M 11.363 9.619 C 13.98 7.383 17.371 6.031 21.079 6.031 C 29.333 6.031 36.028 12.726 36.028 20.981 C 36.028 29.235 29.333 35.93 21.079 35.93 C 12.824 35.93 6.129 29.246 6.129 20.981 C 6.129 19.083 6.478 17.273 7.121 15.616" stroke="var(--scc-secondary)" fill="none"></path>\n\t\t\t<path d="M 22.335 24.77 C 22.62 24.51 22.758 24.152 22.758 23.696 C 22.758 23.229 22.631 22.86 22.378 22.589 C 22.124 22.318 21.702 22.057 21.101 21.829 C 20.499 21.601 19.982 21.362 19.539 21.134 C 19.096 20.907 18.727 20.635 18.421 20.342 C 18.115 20.049 17.861 19.691 17.693 19.289 C 17.524 18.888 17.429 18.41 17.429 17.846 C 17.429 16.891 17.724 16.098 18.326 15.491 C 18.917 14.883 19.719 14.514 20.7 14.416 L 20.7 12.593 L 22.029 12.593 L 22.029 14.438 C 23.011 14.579 23.771 15.002 24.319 15.697 C 24.868 16.391 25.153 17.292 25.153 18.399 L 22.758 18.399 C 22.758 17.716 22.62 17.205 22.346 16.869 C 22.072 16.532 21.702 16.359 21.249 16.359 C 20.795 16.359 20.447 16.489 20.193 16.75 C 19.94 17.01 19.824 17.379 19.824 17.846 C 19.824 18.28 19.94 18.627 20.183 18.888 C 20.426 19.148 20.879 19.42 21.534 19.691 C 22.198 19.962 22.736 20.223 23.159 20.462 C 23.581 20.7 23.939 20.972 24.235 21.276 C 24.53 21.579 24.752 21.927 24.91 22.318 C 25.069 22.708 25.142 23.164 25.142 23.674 C 25.142 24.64 24.847 25.422 24.267 26.03 C 23.686 26.637 22.874 26.985 21.85 27.093 L 21.85 28.786 L 20.531 28.786 L 20.531 27.104 C 19.402 26.974 18.526 26.561 17.904 25.867 C 17.281 25.161 16.975 24.228 16.975 23.066 L 19.37 23.066 C 19.37 23.739 19.529 24.26 19.835 24.619 C 20.141 24.977 20.594 25.161 21.185 25.161 C 21.671 25.161 22.051 25.031 22.335 24.77 Z" fill="var(--scc-secondary)"></path>\n\t\t</symbol>\n\t\t<symbol id="scc-creator-messages-delay-icon" viewBox="0 0 24 24">\n\t\t\t<path d="M 12 0 C 18.72 0 24 5.28 24 12 C 24 18.72 18.72 24 12 24 C 5.28 24 0 18.72 0 12 C 0 5.28 5.28 0 12 0 Z" fill="currentColor" fill-opacity="0"></path>\n\t\t\t<path d="M 12 0.5 C 18.44 0.5 23.5 5.56 23.5 12 C 23.5 18.44 18.44 23.5 12 23.5 C 5.56 23.5 0.5 18.44 0.5 12 C 0.5 5.56 5.56 0.5 12 0.5 Z" stroke="currentColor" fill="none"></path>\n\t\t\t<path d="M 12.119 6.892 L 12.119 12.865 L 18.226 16.583" stroke-width="2" stroke="currentColor" fill="none"></path>\n\t\t</symbol>\n\t\t<symbol id="scc-message-icon" viewBox="0 0 24 24">\n\t\t\t<path fill="currentColor" d="M19.3,0H4.7C2.1,0,0,2.1,0,4.6v5.7v3.4v3.1v6.3c0,0.6,0.7,1.1,1.3,0.7l5.4-3.2c0.1-0.1,0.3-0.1,0.4-0.1h12.2 c2.6,0,4.7-2.1,4.7-4.6V4.6C24,2.1,21.9,0,19.3,0z M14.2,12.2c0,0.5-0.4,0.9-0.9,0.9H5.5c-0.5,0-0.9-0.4-0.9-0.9v-0.4 c0-0.5,0.4-0.9,0.9-0.9h7.8c0.5,0,0.9,0.4,0.9,0.9V12.2z M18.3,8.6H5.7c-0.6,0-1.1-0.5-1.1-1.1c0-0.6,0.5-1.1,1.1-1.1h12.6 c0.6,0,1.1,0.5,1.1,1.1C19.4,8.1,18.9,8.6,18.3,8.6z"/>\n\t\t</symbol>\n\t\t<symbol id="scc-request-custom-order-icon" viewBox="0 0 42 42">\n            <path fill="var(--scc-bg)" d="M21 0c11.8 0 21 9.2 21 21s-9.2 21-21 21S0 32.8 0 21 9.2 0 21 0"/>\n\t\t\t<linearGradient id="setting-1" gradientUnits="userSpaceOnUse" x1="13.2744" y1="5.4333" x2="24.082" y2="5.4333" gradientTransform="matrix(1.106383, 0, 0, 1.106383, 7.713338, 7.81801)">\n\t\t\t\t<stop offset="0" stop-color="var(--scc-gradient-start)"></stop>\n\t\t\t\t<stop offset="1" stop-color="var(--scc-gradient-stop)"></stop>\n\t\t\t</linearGradient>\n\t\t\t<path fill="url(#setting-1)" d="M 24.379 20.132 L 24.991 17.477 C 24.379 16.557 24.073 15.536 24.073 14.514 C 24.073 11.451 26.523 9 29.587 9 C 32.651 9 35.102 11.451 35.102 14.514 C 35.102 17.579 32.651 20.03 29.587 20.03 C 28.873 20.03 28.157 19.927 27.443 19.621 L 24.379 20.132 Z M 27.544 18.6 L 27.647 18.702 C 28.26 19.009 28.873 19.11 29.486 19.11 C 32.038 19.11 33.979 17.068 33.979 14.617 C 33.979 12.064 31.936 10.123 29.486 10.123 C 26.932 10.123 24.991 12.166 24.991 14.617 C 24.991 15.536 25.298 16.456 25.809 17.273 L 25.91 17.477 L 25.604 19.11 L 27.544 18.6 Z"></path>\n\t\t\t<linearGradient id="setting-2" gradientUnits="userSpaceOnUse" x1="-1.276947e-02" y1="18.95" x2="17.272" y2="18.95" gradientTransform="matrix(1.106383, 0, 0, 1.106383, 7.713338, 7.81801)">\n\t\t\t\t<stop offset="0" stop-color="var(--scc-gradient-start)"></stop>\n\t\t\t\t<stop offset="1" stop-color="var(--scc-gradient-stop)"></stop>\n\t\t\t</linearGradient>\n\t\t\t<path fill="url(#setting-2)" d="M 23.256 23.706 L 22.847 23.706 C 22.03 24.727 20.702 25.34 19.374 25.34 C 18.047 25.34 16.617 24.727 15.8 23.706 L 15.391 23.706 C 12.94 23.706 11 25.647 11 28.098 L 11 28.609 C 11 31.06 12.94 33 15.391 33 L 23.256 33 C 25.706 33 27.647 31.06 27.647 28.609 L 27.647 28.098 C 27.647 25.647 25.604 23.706 23.256 23.706 Z"></path>\n\t\t\t<linearGradient id="setting-3" gradientUnits="userSpaceOnUse" x1="4.1436" y1="9.8413" x2="13.1152" y2="9.8413" gradientTransform="matrix(1.106383, 0, 0, 1.106383, 7.713338, 7.81801)">\n\t\t\t\t<stop offset="0" stop-color="var(--scc-gradient-start)"></stop>\n\t\t\t\t<stop offset="1" stop-color="var(--scc-gradient-stop)"></stop>\n\t\t\t</linearGradient>\n\t\t\t<circle fill="url(#setting-3)" cx="19.273" cy="19.009" r="4.596"></circle>\n\t\t\t<linearGradient id="setting-4" gradientUnits="userSpaceOnUse" x1="2.9287" y1="10.6137" x2="9.3506" y2="10.6137" gradientTransform="matrix(0.806935, 0, 0, 0.806935, 23.368623, 5.143972)">\n\t\t\t\t<stop offset="0" stop-color="var(--scc-gradient-start)"></stop>\n\t\t\t\t<stop offset="1" stop-color="var(--scc-gradient-stop)"></stop>\n\t\t\t</linearGradient>\n\t\t\t<path fill="url(#setting-4)" d="M 31.572 14.054 L 29.858 14.054 L 29.858 12.416 C 29.858 12.194 29.708 12.043 29.484 12.043 C 29.262 12.043 29.113 12.194 29.113 12.416 L 29.113 14.054 L 27.473 14.054 C 27.252 14.054 27.101 14.204 27.101 14.426 C 27.101 14.651 27.252 14.801 27.473 14.801 L 29.113 14.801 L 29.113 16.438 C 29.113 16.662 29.262 16.812 29.484 16.812 C 29.708 16.812 29.858 16.662 29.858 16.438 L 29.858 14.801 L 31.496 14.801 C 31.719 14.801 31.869 14.651 31.869 14.426 C 31.869 14.204 31.719 14.054 31.572 14.054 Z"></path>\n\t\t</symbol>\n        <symbol id="announcement" viewBox="0 0 24 24">\n            <linearGradient id="a" x1="19.858" x2="255.11" y1="121.48" y2="121.48" gradientTransform="translate(-.231 -.221) scale(.1125)" gradientUnits="userSpaceOnUse">\n                <stop offset="0" stop-color="var(--scc-gradient-start)"></stop>\n                <stop offset="1" stop-color="var(--scc-gradient-stop)"></stop>\n            </linearGradient>\n            <path fill="url(#a)" d="M1.17 16.332c.234.577.892.854 1.467.62l.607-.248a1.543 1.543 0 0 0 1.59.661l.274.677a.978.978 0 0 0 1.08.591l1.532 3.771a1.673 1.673 0 0 0 3.1-1.26l-1.533-3.77a.976.976 0 0 0 .363-1.18l-.264-.65c.128-.026 5.228-2.532 11.148-.039a.302.302 0 0 0 .397-.391l-1.799-4.425a2.97 2.97 0 0 0 1.355-1.48 2.97 2.97 0 0 0 .014-2.288 2.977 2.977 0 0 0-1.608-1.632 2.967 2.967 0 0 0-2.003-.116l-1.8-4.43a.302.302 0 0 0-.278-.189h-.002a.303.303 0 0 0-.279.186 14.323 14.323 0 0 1-7.749 7.643L2.24 10.231a1.543 1.543 0 0 0-.931 1.716l-.607.247a1.129 1.129 0 0 0-.62 1.468zm8.502 6.431a1.068 1.068 0 0 1-1.391-.586l-1.526-3.751 1.982-.805 1.526 3.75a1.07 1.07 0 0 1-.59 1.394zm-.58-6.342a.372.372 0 0 1-.204.486l-2.734 1.111a.372.372 0 0 1-.486-.204l-.265-.651 3.425-1.392zm9.567-10.576a2.38 2.38 0 0 1 1.285 1.301 2.372 2.372 0 0 1-.012 1.828 2.366 2.366 0 0 1-1.027 1.149l-1.784-4.386a2.367 2.367 0 0 1 1.538.106zm-3.863-4.223 5.312 13.065a14.721 14.721 0 0 0-10.404.081L7.288 8.823a14.945 14.945 0 0 0 7.51-7.2zM2.468 10.79 6.73 9.057l2.414 5.933-4.246 1.726-.016.007a.938.938 0 0 1-1.218-.514v-.002s-.002 0-.002-.002L1.956 12.01v-.002h-.001a.938.938 0 0 1 .514-1.22zM.93 12.753l.58-.236 1.48 3.64-.58.236a.523.523 0 0 1-.682-.288l-1.085-2.67a.523.523 0 0 1 .287-.682zm17.85-8.881a.302.302 0 0 1-.13-.407l.83-1.607a.302.302 0 0 1 .535.278l-.83 1.606a.302.302 0 0 1-.406.13zm3.793.16a.302.302 0 0 1-.065.421l-1.439 1.058a.302.302 0 0 1-.358-.487l1.44-1.058a.301.301 0 0 1 .422.065zm1.17 3.85-1.767.25a.302.302 0 0 1-.085-.597l1.767-.25a.302.302 0 0 1 .086.598zm-.253 2.801a.302.302 0 1 1-.19.574l-1.708-.565a.302.302 0 1 1 .19-.574z"/>\n        </symbol>\n\t</defs>\n</svg>';});


define('text!message.mustache',[],function () { return '<li class="chat-message chat-message--{{message_from}} {{message_other_classes}}">\n\t<div class="chat-message__header">\n\t\t{{{avatar}}}\n\t</div>\n\t<div class="chat-message__body">\n\t\t<div class="chat-message__username {{^display_user_name}}d-none{{/display_user_name}}">\n\t\t{{#profile_url}}<a href="{{profile_url}}">{{/profile_url}}\n\t\t\t{{{user_name}}}\n\t\t{{#profile_url}}</a>{{/profile_url}}\n\t\t</div>\n\t\t<div class="chat-message__display">\n\t\t\t{{>inside}}\n\t\t</div>\n\t</div>\n</li>\n';});


define('text!message_inside.mustache',[],function () { return '<div id="chat_message_{{ message_id }}" class="{{class_multi}} chat-message__id chat_message_id"{{#id_mass_message}} data-mm="{{id_mass_message}}"{{/id_mass_message}}{{#id_auto_message}} data-am="{{id_auto_message}}"{{/id_auto_message}}>\n\t<div class="d-flex flex-row align-items-end flex-wrap">\n\t\t<div class="d-flex flex-row align-items-end">\n\t\t\t<div class="chat-message__message chat_message {{ class_li }}">\n\t\t\t\t{{{ content }}}{{{ quote }}}\n\t\t\t\t{{#message_html}}\n\t\t\t\t\t{{{message_html}}}\n\t\t\t\t{{/message_html}}\n\t\t\t\t{{^message_html}}\n\t\t\t\t\t<p>{{{ message }}}</p>\n\t\t\t\t{{/message_html}}\n\t\t\t\t{{#display_metas}}\n\t\t\t\t\t<div class="chat-message__metas">\n\t\t\t\t\t<span class="chat-message__meta chat-message__meta--left">\n\t\t\t\t\t\t<time class="chat-message__meta-sub chat-message__meta--time" title="{{time}}" data-timestamp="{{timestamp}}"{{#enable_refresh_rt}} data-refresh-rt{{/enable_refresh_rt}}>{{{relative_time}}}</time>\n\t\t\t\t\t</span>\n\t\t\t\t\t\t{{#display_cm}}\n\t\t\t\t\t\t\t<span class="chat-message__actions chat-actions"{{#is_temp}} style="display: none;"{{/is_temp}}>\n\t\t\t\t\t\t\t<button class="chat-message__action chat-message__action--context-menu"><svg class="chat-scc chat-scc--rotate-90"><use xlink:href="#scc-three-dots"></use></svg></button>\n\t\t\t\t\t\t</span>\n\t\t\t\t\t\t{{/display_cm}}\n\t\t\t\t\t\t<span class="chat-message__delivery-status"{{^is_temp}} style="display: none;"{{/is_temp}}>\n\t\t\t\t\t\t<svg class="chat-scc chat-scc--spin"><use xlink:href="#scc-message-loader-icon"></use></svg>\n\t\t\t\t\t</span>\n\t\t\t\t\t</div>\n\t\t\t\t{{/display_metas}}\n\t\t\t</div>\n\t\t\t{{#display_read_status}}\n\t\t\t\t<div class="chat-message__read-status">\n\t\t\t\t\t<input id="chat_message_read_status_{{ message_id }}" class="chat_message_status_not_read" type="checkbox" data-timestamp="{{read_status_timestamp}}" data-user-id="{{user_id}}"{{#read}} checked="checked"{{/read}}>\n\t\t\t\t\t<label for="chat_message_read_status_{{ message_id }}" title="{{read_status_label_title}}"></label>\n\t\t\t\t</div>\n\t\t\t{{/display_read_status}}\n\t\t</div>\n\t\t{{#forwarded_from}}\n\t\t\t<div class="chat-message__meta-forward chat-message__meta-forward--from">\n\t\t\t\t<span class="chat-message__meta">{{ forward_label_from }} <span class="chat-message__meta-contact" data-id="{{ user_id_from }}">{{ user_name_forward_from }}</span>,</span>\n\t\t\t\t<time class="chat-message__meta chat-message__meta--time" title="{{ time_forward_from }}" data-timestamp="{{ timestamp_forward_from }}"{{#enable_refresh_rt}} data-refresh-rt{{/enable_refresh_rt}}>{{{ relative_time_forward_from }}}</time>\n\t\t\t</div>\n\t\t{{/forwarded_from}}\n\t\t{{#forwarded_to}}\n\t\t\t<div class="chat-message__meta-forward chat-message__meta-forward--to">\n\t\t\t\t<span class="chat-message__meta">{{ forward_label_to }} <span class="chat-message__meta-contact" data-id="{{ user_id_to }}">{{ user_name_forward_to }}</span>,</span>\n\t\t\t\t<time class="chat-message__meta chat-message__meta--time" title="{{ time_forward_to }}" data-timestamp="{{ timestamp_forward_to }}"{{#enable_refresh_rt}} data-refresh-rt{{/enable_refresh_rt}}>{{{ relative_time_forward_to }}}</time>\n\t\t\t</div>\n\t\t{{/forwarded_to}}\n\t</div>\n\n\t<p class="d-none chat_message_report {{ class_li }}">{{ message_report }}</p>\n</div>';});


define('text!message_quote.mustache',[],function () { return '<figure class="chat-quote{{# modifier }} chat-quote--{{ modifier }}{{/ modifier }}{{#is_file_shared}} chat-quote--file{{/is_file_shared}}{{^show_more_label}} chat-quote--message-visible{{/show_more_label}}"{{# message_id}} data-quote-message-id="{{message_id}}"{{/ message_id}}>\n\t{{# in_form }}<a href="#" class="chat-quote__remove remove-quote" title="{{ trad.remove }}"><i class="icon-f icf-close"></i></a>{{/ in_form }}\n\t<div class="chat-quote__inner">\n\t\t<blockquote>{{#use_paragraph}}<p>{{/use_paragraph}}{{{ content }}}{{#use_paragraph}}</p>{{/use_paragraph}}{{#show_more_label}}<button class="chat-quote__show-more chat-quote__show-more--hidden">{{show_more_label}}</button>{{/show_more_label}}</blockquote>\n\t\t{{^forwarded}}\n\t\t<figcaption class="chat-message__metas">\n\t\t\t{{#user_name}}\n\t\t\t\t{{#forward_label}}\n\t\t\t\t<span class="chat-message__meta">{{forward_label}} {{ user_name }},</span>\n\t\t\t\t{{/forward_label}}\n\t\t\t{{/user_name}}\n\t\t\t{{^forward_label}}\n\t\t\t\t<cite class="chat-message__meta chat-message__meta--cite"{{# user_id }}data-user-id="{{ user_id }}"{{/ user_id }}>{{ user_name }},</cite>\n\t\t\t{{/forward_label}}\n\t\t\t<time class="chat-message__meta chat-message__meta--time" title="{{ time }}" data-timestamp="{{ timestamp }}"{{#enable_refresh_rt}} data-refresh-rt{{/enable_refresh_rt}}>{{{ relative_time }}}</time>\n\t\t</figcaption>\n\t\t{{/forwarded}}\n\t</div>\n</figure>';});


define('text!message_edit.mustache',[],function () { return '<div class="chat-message__edit"{{#date}} title="{{date}}"{{/date}}>\n\t<svg class="chat-scc"><use xlink:href="#scc-edit-message"></use></svg>\n</div>';});


define('text!window.mustache',[],function () { return '<div id="chat-window" class="chat-window chat-window--home {{#window_class}}{{window_class}}{{/window_class}}{{#is_fan}} is-fan{{/is_fan}}{{#is_creator}} is-creator{{/is_creator}}{{#is_support}} is-support{{/is_support}}">\r\n\t<div id="chat_loading_overlay" >\r\n\t\t<div class="loading_back">&nbsp;</div>\r\n\t\t<div class="loading_text">\r\n\t\t\t<i class="icon-f icf-spinner icf-anim-pulse icf-2x icf-fw"></i>\r\n\t\t</div>\r\n\t</div>\r\n\t<div class="overlay-container chat-window__overlay-container">\r\n\t\t<audio id="mess_notif" volume="0.5">\r\n\t\t\t<source src="{{{ sound_file }}}"></source>\r\n\t\t</audio>\r\n        <div id="chat-window-announcement" class="chat-window__announcement"></div>\r\n\t\t<div id="chat-drag-file" class="chat-window__main">\r\n\t\t\t<div id="chat-drag-file-overlay" >\r\n\t\t\t\t<div id="chat-drag-file-overlay-opacity"></div>\r\n\t\t\t\t<div id="chat-drag-file-overlay-icon"><span class="icon-f icf-image"></span></div>\r\n\t\t\t</div>\r\n\t\t\t<div class="chat-window__messenger chat-messenger">\r\n\t\t\t\t<div id="chat-home" class="chat-window__home">\r\n\t\t\t\t\t{{#friend_request_enabled}}\r\n\t\t\t\t\t<ul id="chat-home-tabs">\r\n\t\t\t\t\t\t<li id="chat-home-tabs-news" class="chat-selected">\r\n\t\t\t\t\t\t\t<div class="chat-home-tabs-icon"><span class="icon-f icf-home"></span></div>\r\n\t\t\t\t\t\t</li>\r\n\t\t\t\t\t\t<li id="chat-home-tabs-requests" class="chat-home-tabs-hide">\r\n\t\t\t\t\t\t\t<div class="chat-home-tabs-icon"><span class="icon-f icf-user-plus" title="{{{ trad.friend_requests }}}"></span> <span class="chat-home-tabs-text">{{{ trad.friend_requests }}}</span></div>\r\n\t\t\t\t\t\t</li>\r\n\t\t\t\t\t\t<li id="chat-home-tabs-requests-sent" class="chat-home-tabs-hide">\r\n\t\t\t\t\t\t\t<div class="chat-home-tabs-icon"><span class="icon-f icf-user-hourglass" title="{{{ trad.friend_requests_sent }}}"></span> <span class="chat-home-tabs-text">{{{ trad.friend_requests_sent }}}</span></div>\r\n\t\t\t\t\t\t</li>\r\n\t\t\t\t\t</ul>\r\n\t\t\t\t\t{{/friend_request_enabled}}\r\n\r\n\t\t\t\t\t<div id="chat-home-tabs-content" class="chat-home__content">\r\n\t\t\t\t\t\t<div id="chat-home-tab-container-requests" class="chat-home-tab-container">\r\n\t\t\t\t\t\t\t<p id="chat-home-friend-request"></p>\r\n\t\t\t\t\t\t\t<div id="chat-home-last-friend-request"></div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t<div id="chat-home-tab-container-requests-sent" class="chat-home-tab-container">\r\n\t\t\t\t\t\t\t<p id="chat-home-friend-request-sent"></p>\r\n\t\t\t\t\t\t\t<div id="chat-home-last-friend-request-sent"></div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</div>\r\n\t\t\t\t<div class="chat-header-messages"></div>\r\n\t\t\t\t<div class="chat-window__message"></div>\r\n\t\t\t\t<div class="chat-messages"></div>\r\n\t\t\t\t<div class="chat-setting-area"></div>\r\n\t\t\t\t<div class="chat-messages-actions"></div>\r\n\t\t\t\t<div class="chat-message-form">\r\n\t\t\t\t\t<div id="textarea-group" class="chat-message-form__textarea-group">\r\n\t\t\t\t\t\t{{#attachment_fields}}{{{attachment_fields}}}{{/attachment_fields}}\r\n\t\t\t\t\t\t{{^attachment_fields}}<div class="attachment-fields-placeholder"></div>{{/attachment_fields}}\r\n\t\t\t\t\t\t<div class="chat-message-form__chat-wrapper">\r\n\t\t\t\t\t\t\t<div class="chat-message-form__textarea-wrapper">\r\n                                <div class="chat-message-form__textarea-edit-popup">\r\n                                    {{trad.message_editing}}\r\n                                    <span id="chat-textarea-edit-close"><svg class="chat-scc chat-scc--creator-messages-cancel"><use xlink:href="#scc-creator-messages-cancel-icon"></use></svg></span>\r\n                                </div>\r\n\t\t\t\t\t\t\t\t<textarea class="chat-message-form__textarea" id="chat-textarea-message" placeholder="{{{ trad.textarea_message_placeholder }}}" rows="1" onInput="this.parentNode.dataset.replicatedValue = this.value"></textarea>\r\n\t\t\t\t\t\t\t\t<div id="container-emojionearea"></div>\r\n\t\t\t\t\t\t\t\t<div id="container-smiley" class="d-none"></div>\r\n\t\t\t\t\t\t\t</div>\r\n                            {{#attachment_button}}{{{attachment_button}}}{{/attachment_button}}\r\n                            {{^attachment_button}}<div class="attachment-button-placeholder"></div>{{/attachment_button}}\r\n                            <button type="button" id="chat-send-btn" class="chat-message-form__action chat-message-form__action--send chat-btn input-group-addon"><span>{{{ trad.message_send }}}</span></button>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</div>\r\n                <div class="chat-messages-blocked"><p></p></div>\r\n\t\t\t</div>\r\n\t\t\t<div class="chat-window__sidebar chat-sidebar" id="chat-side-column">\r\n\t\t\t\t<div class="chat-sidebar__top">\r\n\t\t\t\t\t<div class="chat-sidebar__profile{{^sidebar_feature.search_form_enabled}} chat-sidebar__profile--full-width{{/sidebar_feature.search_form_enabled}}">\r\n\t\t\t\t\t\t<div class="chat-sidebar__settings chat-settings">\r\n\t\t\t\t\t\t\t<svg class="chat-sidebar__settings-down chat-scc"><use xlink:href="#scc-down-icon"></use></svg>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t<div class="chat-sidebar__username-wrapper">\r\n\t\t\t\t\t\t\t<div class="chat-sidebar__username">{{user.name}}</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t{{#sidebar_feature.search_form_enabled}}\r\n\t\t\t\t\t<div id="chat-users-search-input" class="chat-sidebar__search-wrapper chat-sidebar__header-action-wrapper">\r\n\t\t\t\t\t\t<button class="chat-sidebar__search-close menu-mobile__btn menu-mobile__btn--close chat-btn-close" type="button"><span>close</span></button>\r\n\t\t\t\t\t\t<div class="chat-sidebar__search chat-search input-group">\r\n\t\t\t\t\t\t\t<input class="chat-search__input search-input form-control form--input" placeholder="{{{ trad.input_search_placeholder }}}" type="text" maxlength="40" name="friend_name" disabled>\r\n\t\t\t\t\t\t\t<button class="chat-search__submit search-submit btn btn--flat" disabled type="button" id="chat-search-button" title="{{{ trad.button_search_friends }}}">\r\n\t\t\t\t\t\t\t\t<span>Search</span>\r\n\t\t\t\t\t\t\t</button>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t<button class="chat-sidebar__search-open btn btn--flat" type="button" title="{{{ trad.button_search_friends }}}">\r\n\t\t\t\t\t\t\t<span>Search</span>\r\n\t\t\t\t\t\t</button>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t{{/sidebar_feature.search_form_enabled}}\r\n\t\t\t\t\t{{#is_creator}}\r\n\t\t\t\t\t\t<div id="chat-users-creator-messages" class="chat-sidebar__creator-messages-wrapper chat-sidebar__header-action-wrapper">\r\n\t\t\t\t\t\t\t<button type="button" class="btn btn--flat btn--creator-messages chat-creator-messages" title="{{trad.mass_message}} & {{trad.auto_message}}"></button>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t{{/is_creator}}\r\n\t\t\t\t\t{{^is_fan}}\r\n\t\t\t\t\t\t<div id="chat-users-contact-list-filters" class="chat-sidebar__contact-list-filters-wrapper chat-sidebar__header-action-wrapper">\r\n\t\t\t\t\t\t\t<button type="button" class="btn btn--flat btn--contact-list-filters chat-contact-list-filters" title=""></button>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t{{/is_fan}}\r\n\t\t\t\t</div>\r\n\t\t\t\t<div class="chat-sidebar__middle">\r\n\t\t\t\t\t<div id="chat-settings-list" class="chat-sidebar__settings-list chat-settings-list">\r\n\t\t\t\t\t\t<div class="chat-settings-list__header">\r\n\t\t\t\t\t\t\t<h2 class="chat-settings-list__title">{{ trad.chat_settings }}</h2>\r\n\t\t\t\t\t\t\t<button class="chat-settings-list__close menu-mobile__btn menu-mobile__btn--close chat-btn-close" type="button" title="{{ trad.close }}"><span>close</span></button>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t{{#is_dev}}\r\n\t\t\t\t\t\t\t<div class="chat-setting chat-setting--line chat-setting--switch">\r\n\t\t\t\t\t\t\t\t<label class="chat-setting__title chat-setting__clickable" for="chat-setting-debug">\r\n\t\t\t\t\t\t\t\t\t<svg class="chat-setting__icon chat-scc"><use xlink:href="#scc-debug-icon"></use></svg>\r\n\t\t\t\t\t\t\t\t\t<span>Debug</span>\r\n\t\t\t\t\t\t\t\t</label>\r\n\t\t\t\t\t\t\t\t<input class="chat-setting__action chat-setting__switch-input" type="checkbox" id="chat-setting-debug">\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t{{/is_dev}}\r\n\t\t\t\t\t\t{{#is_fan}}\r\n\t\t\t\t\t\t\t<div class="chat-setting chat-setting--line chat-setting--switch">\r\n\t\t\t\t\t\t\t\t<label class="chat-setting__title chat-setting__clickable" for="chat-setting-silent-ppv">\r\n\t\t\t\t\t\t\t\t\t<span>{{{ trad.silent_ppv }}}</span>\r\n\t\t\t\t\t\t\t\t</label>\r\n\t\t\t\t\t\t\t\t<input class="chat-setting__action chat-setting__switch-input" type="checkbox" id="chat-setting-silent-ppv">\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t{{/is_fan}}\r\n\t\t\t\t\t\t{{#is_creator}}\r\n\t\t\t\t\t\t\t<div class="chat-setting chat-setting--line chat-setting--switch">\r\n\t\t\t\t\t\t\t\t<label class="chat-setting__title chat-setting__clickable" for="chat-setting-manager">\r\n\t\t\t\t\t\t\t\t\t<span>{{{ trad.manager }}}</span>\r\n\t\t\t\t\t\t\t\t</label>\r\n\t\t\t\t\t\t\t\t<input class="chat-setting__action chat-setting__switch-input" type="checkbox" id="chat-setting-manager">\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t{{/is_creator}}\r\n\t\t\t\t\t\t{{#settings_menu_items.status_switch_enabled}}\r\n\t\t\t\t\t\t\t<div class="chat-setting chat-setting--block" id="chat-setting-status">\r\n\t\t\t\t\t\t\t\t<button class="chat-setting__title chat-setting__clickable" type="button" data-toggle="collapse" data-target="#chat-setting-status-collapsible" aria-expanded="false" aria-controls="chat-setting-status-collapsible" id="chat-setting-status-title">\r\n\t\t\t\t\t\t\t\t\t<svg class="chat-setting__icon chat-scc"><use xlink:href="#scc-status-icon"></use></svg>\r\n\t\t\t\t\t\t\t\t\t<span>{{{ trad.status }}}</span>\r\n\t\t\t\t\t\t\t\t</button>\r\n\t\t\t\t\t\t\t\t<div id="chat-setting-status-collapsible" class="collapse show" aria-labelledby="chat-setting-status-title" data-parent="#chat-setting-status">\r\n\t\t\t\t\t\t\t\t\t<div class="chat-setting__body">\r\n\t\t\t\t\t\t\t\t\t\t<div class="chat-setting__radio">\r\n\t\t\t\t\t\t\t\t\t\t\t<input class="chat-setting__radio-input" type="radio" name="chat-setting-status" id="chat-setting-status-online" data-value="online">\r\n\t\t\t\t\t\t\t\t\t\t\t<label for="chat-setting-status-online">\r\n\t\t\t\t\t\t\t\t\t\t\t\t{{{ trad.status_online }}}\r\n\t\t\t\t\t\t\t\t\t\t\t</label>\r\n\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t\t<div class="chat-setting__radio">\r\n\t\t\t\t\t\t\t\t\t\t\t<input class="chat-setting__radio-input" type="radio" name="chat-setting-status" id="chat-setting-status-away" data-value="away">\r\n\t\t\t\t\t\t\t\t\t\t\t<label for="chat-setting-status-away">\r\n\t\t\t\t\t\t\t\t\t\t\t\t{{{ trad.status_away }}}\r\n\t\t\t\t\t\t\t\t\t\t\t</label>\r\n\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t\t<div class="chat-setting__radio">\r\n\t\t\t\t\t\t\t\t\t\t\t<input class="chat-setting__radio-input" type="radio" name="chat-setting-status" id="chat-setting-status-invisible" data-value="invisible">\r\n\t\t\t\t\t\t\t\t\t\t\t<label for="chat-setting-status-invisible">\r\n\t\t\t\t\t\t\t\t\t\t\t\t{{{ trad.status_invisible }}}\r\n\t\t\t\t\t\t\t\t\t\t\t</label>\r\n\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t{{/settings_menu_items.status_switch_enabled}}\r\n\t\t\t\t\t\t{{#settings_menu_items.size_switch_enabled}}\r\n\t\t\t\t\t\t\t<div class="chat-setting chat-setting--block" id="chat-setting-size">\r\n\t\t\t\t\t\t\t\t<button class="chat-setting__title chat-setting__clickable" type="button" data-toggle="collapse" data-target="#chat-setting-size-collapsible" aria-expanded="false" aria-controls="chat-setting-size-collapsible" id="chat-setting-size-title">\r\n\t\t\t\t\t\t\t\t\t<svg class="chat-setting__icon chat-scc"><use xlink:href="#scc-chat-size-icon"></use></svg>\r\n\t\t\t\t\t\t\t\t\t<span>{{{ trad.chat_size }}}</span>\r\n\t\t\t\t\t\t\t\t</button>\r\n\t\t\t\t\t\t\t\t<div id="chat-setting-size-collapsible" class="collapse show" aria-labelledby="chat-setting-size-title" data-parent="#chat-setting-size">\r\n\t\t\t\t\t\t\t\t\t<div class="chat-setting__body">\r\n\t\t\t\t\t\t\t\t\t\t<div class="chat-setting__radio">\r\n\t\t\t\t\t\t\t\t\t\t\t<input class="chat-setting__radio-input" type="radio" name="chat-setting-size" id="chat-setting-size-small" data-value="small">\r\n\t\t\t\t\t\t\t\t\t\t\t<label for="chat-setting-size-small">\r\n\t\t\t\t\t\t\t\t\t\t\t\t{{{ trad.small_size }}}\r\n\t\t\t\t\t\t\t\t\t\t\t</label>\r\n\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t\t<div class="chat-setting__radio">\r\n\t\t\t\t\t\t\t\t\t\t\t<input class="chat-setting__radio-input" type="radio" name="chat-setting-size" id="chat-setting-size-medium" data-value="medium">\r\n\t\t\t\t\t\t\t\t\t\t\t<label for="chat-setting-size-medium">\r\n\t\t\t\t\t\t\t\t\t\t\t\t{{{ trad.medium_size }}}\r\n\t\t\t\t\t\t\t\t\t\t\t</label>\r\n\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t\t<div class="chat-setting__radio">\r\n\t\t\t\t\t\t\t\t\t\t\t<input class="chat-setting__radio-input" type="radio" name="chat-setting-size" id="chat-setting-size-big" data-value="big">\r\n\t\t\t\t\t\t\t\t\t\t\t<label for="chat-setting-size-big">\r\n\t\t\t\t\t\t\t\t\t\t\t\t{{{ trad.big_size }}}\r\n\t\t\t\t\t\t\t\t\t\t\t</label>\r\n\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t{{/settings_menu_items.size_switch_enabled}}\r\n\t\t\t\t\t\t{{#settings_menu_items.color_switch_enabled}}\r\n\t\t\t\t\t\t\t<div class="chat-setting chat-setting--block" id="chat-setting-theme">\r\n\t\t\t\t\t\t\t\t<button class="chat-setting__title chat-setting__clickable" type="button" data-toggle="collapse" data-target="#chat-setting-theme-collapsible" aria-expanded="false" aria-controls="chat-setting-theme-collapsible" id="chat-setting-theme-title">\r\n\t\t\t\t\t\t\t\t\t<svg class="chat-setting__icon chat-scc"><use xlink:href="#scc-color-theme-icon"></use></svg>\r\n\t\t\t\t\t\t\t\t\t<span>{{{ trad.color_theme }}}</span>\r\n\t\t\t\t\t\t\t\t</button>\r\n\t\t\t\t\t\t\t\t<div id="chat-setting-theme-collapsible" class="collapse show" aria-labelledby="chat-setting-theme-title" data-parent="#chat-setting-theme">\r\n\t\t\t\t\t\t\t\t\t<div class="chat-setting__body">\r\n\t\t\t\t\t\t\t\t\t\t{{#settings_menu_items.color_switch_colors}}\r\n\t\t\t\t\t\t\t\t\t\t\t<div class="chat-setting__radio chat-setting__radio--color-swatch">\r\n\t\t\t\t\t\t\t\t\t\t\t\t<input class="chat-setting__action chat-setting__action--hidden" type="radio" name="chat-setting-theme" id="chat-setting-theme-{{ name }}" data-value="{{ name }}">\r\n\t\t\t\t\t\t\t\t\t\t\t\t<label for="chat-setting-theme-{{ name }}">\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t{{{ i18n }}} <span class="color-swatch color-swatch--{{ name }}"></span>\r\n\t\t\t\t\t\t\t\t\t\t\t\t</label>\r\n\t\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t\t{{/settings_menu_items.color_switch_colors}}\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t{{/settings_menu_items.color_switch_enabled}}\r\n\t\t\t\t\t\t{{#settings_menu_items.notification_enabled}}\r\n\t\t\t\t\t\t\t<div class="chat-setting chat-setting--line chat-setting--switch">\r\n\t\t\t\t\t\t\t\t<label class="chat-setting__title chat-setting__clickable" for="chat-setting-notification">\r\n\t\t\t\t\t\t\t\t\t<svg class="chat-setting__icon chat-scc"><use xlink:href="#scc-notifications-icon"></use></svg>\r\n\t\t\t\t\t\t\t\t\t<span>{{{ trad.notifications }}}</span>\r\n\t\t\t\t\t\t\t\t</label>\r\n\t\t\t\t\t\t\t\t<input class="chat-setting__action chat-setting__switch-input" type="checkbox" id="chat-setting-notification">\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t{{/settings_menu_items.notification_enabled}}\r\n\t\t\t\t\t\t{{#settings_menu_items.sound_enabled}}\r\n\t\t\t\t\t\t\t<div class="chat-setting chat-setting--line chat-setting--switch">\r\n\t\t\t\t\t\t\t\t<label class="chat-setting__title chat-setting__clickable" for="chat-setting-sound">\r\n\t\t\t\t\t\t\t\t\t<svg class="chat-setting__icon chat-scc"><use xlink:href="#scc-notifications-icon"></use></svg>\r\n\t\t\t\t\t\t\t\t\t<span>{{{ trad.sound }}}</span>\r\n\t\t\t\t\t\t\t\t</label>\r\n\t\t\t\t\t\t\t\t<input class="chat-setting__action chat-setting__switch-input" type="checkbox" id="chat-setting-sound">\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t{{/settings_menu_items.sound_enabled}}\r\n\t\t\t\t\t\t{{#settings_menu_items.blur_images_enabled}}\r\n\t\t\t\t\t\t\t<div class="chat-setting chat-setting--line chat-setting--switch">\r\n\t\t\t\t\t\t\t\t<label class="chat-setting__title chat-setting__clickable" for="chat-setting-blur-images">\r\n\t\t\t\t\t\t\t\t\t<svg class="chat-setting__icon chat-scc"><use xlink:href="#scc-blur-the-images-icon"></use></svg>\r\n\t\t\t\t\t\t\t\t\t<span>{{{ trad.blur_image }}}</span>\r\n\t\t\t\t\t\t\t\t</label>\r\n\t\t\t\t\t\t\t\t<input class="chat-setting__action chat-setting__switch-input" type="checkbox" id="chat-setting-blur-images">\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t{{/settings_menu_items.blur_images_enabled}}\r\n\t\t\t\t\t\t{{#settings_menu_items.disable_mini_chat_enabled}}\r\n\t\t\t\t\t\t\t<div class="chat-setting chat-setting--line chat-setting--switch">\r\n\t\t\t\t\t\t\t\t<label class="chat-setting__title chat-setting__clickable" for="chat-setting-mini-chat">\r\n\t\t\t\t\t\t\t\t\t<svg class="chat-setting__icon chat-scc"><use xlink:href="#scc-disable-mini-chat-icon"></use></svg>\r\n\t\t\t\t\t\t\t\t\t<span>{{{ trad.disable_mini_chat }}}</span>\r\n\t\t\t\t\t\t\t\t</label>\r\n\t\t\t\t\t\t\t\t<input class="chat-setting__action chat-setting__switch-input" type="checkbox" id="chat-setting-mini-chat">\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t{{/settings_menu_items.disable_mini_chat_enabled}}\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t<div class="chat-sidebar__tabs-wrapper">\r\n\t\t\t\t\t\t<ul class="chat-sidebar__tabs chat-tabs chat-tabs--sidebar"></ul>\r\n\t\t\t\t\t\t<div id="chat-users-lists" class="chat-sidebar__users">\r\n\t\t\t\t\t\t\t<div id="chat-users-support" class="chat-users"></div>\r\n\t\t\t\t\t\t\t{{#display_support_toggler}}\r\n\t\t\t\t\t\t\t<div id="chat-support-toggler" class="chat-support-toggler">\r\n\t\t\t\t\t\t\t\t<div id="chat-users-support-hidden" class="chat-support-toggler__list chat-toggle chat-users chat-users-support"></div>\r\n\t\t\t\t\t\t\t\t<button id="chat-support-toggler-button" class="chat-support-toggler__button" type="button" data-toggle="#chat-users-support-hidden">{{trad.support_button_label}}</button>\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t{{/display_support_toggler}}\r\n\t\t\t\t\t\t\t<div id="chat-users-search" class="chat-users"></div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t</div>\r\n\t<div id="chat-preloader"></div>\r\n</div>';});


define('text!system_message.mustache',[],function () { return '<li class="chat-message{{^type}} chat-message--system{{/type}}{{#type}} chat-message--{{type}}{{/type}}">\n\t<div class="chat-message__body">\n\t\t<div class="chat_message_display">\n\t\t\t<p id="chat_message_{{message_id}}" class="chat-message__id">{{{message}}}</p>\n\t\t</div>\n\t\t<p class="d-none chat_message_report">{{{message}}}</p>\n\t</div>\n</li>';});


define('text!textarea_error_popup.mustache',[],function () { return '<p id="chat-textarea-error-popup">\n\t{{#timer}}<span class="chat-ui-timer-pie chat-ui-timer-pie--{{timer}}"></span>{{/timer}} <span style="text-align: left;">{{content}}</span>\n</p>';});

;(function (root, factory) {
	if (typeof exports === "object") {
		// CommonJS
		module.exports = exports = factory();
	}
	else if (typeof define === "function" && define.amd) {
		// AMD
		define('libs/c3r18y25p16t',[], factory);
	}
	else {
		// Global (browser)
		root.CryptoJS = factory();
	}
}(this, function () {

	/**
	 * CryptoJS core components.
	 */
	var CryptoJS = CryptoJS || (function (Math, undefined) {
	    /*
	     * Local polyfil of Object.create
	     */
	    var create = Object.create || (function () {
	        function F() {};

	        return function (obj) {
	            var subtype;

	            F.prototype = obj;

	            subtype = new F();

	            F.prototype = null;

	            return subtype;
	        };
	    }())

	    /**
	     * CryptoJS namespace.
	     */
	    var C = {};

	    /**
	     * Library namespace.
	     */
	    var C_lib = C.lib = {};

	    /**
	     * Base object for prototypal inheritance.
	     */
	    var Base = C_lib.Base = (function () {


	        return {
	            /**
	             * Creates a new object that inherits from this object.
	             *
	             * @param {Object} overrides Properties to copy into the new object.
	             *
	             * @return {Object} The new object.
	             *
	             * @static
	             *
	             * @example
	             *
	             *     var MyType = CryptoJS.lib.Base.extend({
	             *         field: 'value',
	             *
	             *         method: function () {
	             *         }
	             *     });
	             */
	            extend: function (overrides) {
	                // Spawn
	                var subtype = create(this);

	                // Augment
	                if (overrides) {
	                    subtype.mixIn(overrides);
	                }

	                // Create default initializer
	                if (!subtype.hasOwnProperty('init') || this.init === subtype.init) {
	                    subtype.init = function () {
	                        subtype.$super.init.apply(this, arguments);
	                    };
	                }

	                // Initializer's prototype is the subtype object
	                subtype.init.prototype = subtype;

	                // Reference supertype
	                subtype.$super = this;

	                return subtype;
	            },

	            /**
	             * Extends this object and runs the init method.
	             * Arguments to create() will be passed to init().
	             *
	             * @return {Object} The new object.
	             *
	             * @static
	             *
	             * @example
	             *
	             *     var instance = MyType.create();
	             */
	            create: function () {
	                var instance = this.extend();
	                instance.init.apply(instance, arguments);

	                return instance;
	            },

	            /**
	             * Initializes a newly created object.
	             * Override this method to add some logic when your objects are created.
	             *
	             * @example
	             *
	             *     var MyType = CryptoJS.lib.Base.extend({
	             *         init: function () {
	             *             // ...
	             *         }
	             *     });
	             */
	            init: function () {
	            },

	            /**
	             * Copies properties into this object.
	             *
	             * @param {Object} properties The properties to mix in.
	             *
	             * @example
	             *
	             *     MyType.mixIn({
	             *         field: 'value'
	             *     });
	             */
	            mixIn: function (properties) {
	                for (var propertyName in properties) {
	                    if (properties.hasOwnProperty(propertyName)) {
	                        this[propertyName] = properties[propertyName];
	                    }
	                }

	                // IE won't copy toString using the loop above
	                if (properties.hasOwnProperty('toString')) {
	                    this.toString = properties.toString;
	                }
	            },

	            /**
	             * Creates a copy of this object.
	             *
	             * @return {Object} The clone.
	             *
	             * @example
	             *
	             *     var clone = instance.clone();
	             */
	            clone: function () {
	                return this.init.prototype.extend(this);
	            }
	        };
	    }());

	    /**
	     * An array of 32-bit words.
	     *
	     * @property {Array} words The array of 32-bit words.
	     * @property {number} sigBytes The number of significant bytes in this word array.
	     */
	    var WordArray = C_lib.WordArray = Base.extend({
	        /**
	         * Initializes a newly created word array.
	         *
	         * @param {Array} words (Optional) An array of 32-bit words.
	         * @param {number} sigBytes (Optional) The number of significant bytes in the words.
	         *
	         * @example
	         *
	         *     var wordArray = CryptoJS.lib.WordArray.create();
	         *     var wordArray = CryptoJS.lib.WordArray.create([0x00010203, 0x04050607]);
	         *     var wordArray = CryptoJS.lib.WordArray.create([0x00010203, 0x04050607], 6);
	         */
	        init: function (words, sigBytes) {
	            words = this.words = words || [];

	            if (sigBytes != undefined) {
	                this.sigBytes = sigBytes;
	            } else {
	                this.sigBytes = words.length * 4;
	            }
	        },

	        /**
	         * Converts this word array to a string.
	         *
	         * @param {Encoder} encoder (Optional) The encoding strategy to use. Default: CryptoJS.enc.Hex
	         *
	         * @return {string} The stringified word array.
	         *
	         * @example
	         *
	         *     var string = wordArray + '';
	         *     var string = wordArray.toString();
	         *     var string = wordArray.toString(CryptoJS.enc.Utf8);
	         */
	        toString: function (encoder) {
	            return (encoder || Hex).stringify(this);
	        },

	        /**
	         * Concatenates a word array to this word array.
	         *
	         * @param {WordArray} wordArray The word array to append.
	         *
	         * @return {WordArray} This word array.
	         *
	         * @example
	         *
	         *     wordArray1.concat(wordArray2);
	         */
	        concat: function (wordArray) {
	            // Shortcuts
	            var thisWords = this.words;
	            var thatWords = wordArray.words;
	            var thisSigBytes = this.sigBytes;
	            var thatSigBytes = wordArray.sigBytes;

	            // Clamp excess bits
	            this.clamp();

	            // Concat
	            if (thisSigBytes % 4) {
	                // Copy one byte at a time
	                for (var i = 0; i < thatSigBytes; i++) {
	                    var thatByte = (thatWords[i >>> 2] >>> (24 - (i % 4) * 8)) & 0xff;
	                    thisWords[(thisSigBytes + i) >>> 2] |= thatByte << (24 - ((thisSigBytes + i) % 4) * 8);
	                }
	            } else {
	                // Copy one word at a time
	                for (var i = 0; i < thatSigBytes; i += 4) {
	                    thisWords[(thisSigBytes + i) >>> 2] = thatWords[i >>> 2];
	                }
	            }
	            this.sigBytes += thatSigBytes;

	            // Chainable
	            return this;
	        },

	        /**
	         * Removes insignificant bits.
	         *
	         * @example
	         *
	         *     wordArray.clamp();
	         */
	        clamp: function () {
	            // Shortcuts
	            var words = this.words;
	            var sigBytes = this.sigBytes;

	            // Clamp
	            words[sigBytes >>> 2] &= 0xffffffff << (32 - (sigBytes % 4) * 8);
	            words.length = Math.ceil(sigBytes / 4);
	        },

	        /**
	         * Creates a copy of this word array.
	         *
	         * @return {WordArray} The clone.
	         *
	         * @example
	         *
	         *     var clone = wordArray.clone();
	         */
	        clone: function () {
	            var clone = Base.clone.call(this);
	            clone.words = this.words.slice(0);

	            return clone;
	        },

	        /**
	         * Creates a word array filled with random bytes.
	         *
	         * @param {number} nBytes The number of random bytes to generate.
	         *
	         * @return {WordArray} The random word array.
	         *
	         * @static
	         *
	         * @example
	         *
	         *     var wordArray = CryptoJS.lib.WordArray.random(16);
	         */
	        random: function (nBytes) {
	            var words = [];

	            var r = (function (m_w) {
	                var m_w = m_w;
	                var m_z = 0x3ade68b1;
	                var mask = 0xffffffff;

	                return function () {
	                    m_z = (0x9069 * (m_z & 0xFFFF) + (m_z >> 0x10)) & mask;
	                    m_w = (0x4650 * (m_w & 0xFFFF) + (m_w >> 0x10)) & mask;
	                    var result = ((m_z << 0x10) + m_w) & mask;
	                    result /= 0x100000000;
	                    result += 0.5;
	                    return result * (Math.random() > .5 ? 1 : -1);
	                }
	            });

	            for (var i = 0, rcache; i < nBytes; i += 4) {
	                var _r = r((rcache || Math.random()) * 0x100000000);

	                rcache = _r() * 0x3ade67b7;
	                words.push((_r() * 0x100000000) | 0);
	            }

	            return new WordArray.init(words, nBytes);
	        }
	    });

	    /**
	     * Encoder namespace.
	     */
	    var C_enc = C.enc = {};

	    /**
	     * Hex encoding strategy.
	     */
	    var Hex = C_enc.Hex = {
	        /**
	         * Converts a word array to a hex string.
	         *
	         * @param {WordArray} wordArray The word array.
	         *
	         * @return {string} The hex string.
	         *
	         * @static
	         *
	         * @example
	         *
	         *     var hexString = CryptoJS.enc.Hex.stringify(wordArray);
	         */
	        stringify: function (wordArray) {
	            // Shortcuts
	            var words = wordArray.words;
	            var sigBytes = wordArray.sigBytes;

	            // Convert
	            var hexChars = [];
	            for (var i = 0; i < sigBytes; i++) {
	                var bite = (words[i >>> 2] >>> (24 - (i % 4) * 8)) & 0xff;
	                hexChars.push((bite >>> 4).toString(16));
	                hexChars.push((bite & 0x0f).toString(16));
	            }

	            return hexChars.join('');
	        },

	        /**
	         * Converts a hex string to a word array.
	         *
	         * @param {string} hexStr The hex string.
	         *
	         * @return {WordArray} The word array.
	         *
	         * @static
	         *
	         * @example
	         *
	         *     var wordArray = CryptoJS.enc.Hex.parse(hexString);
	         */
	        parse: function (hexStr) {
	            // Shortcut
	            var hexStrLength = hexStr.length;

	            // Convert
	            var words = [];
	            for (var i = 0; i < hexStrLength; i += 2) {
	                words[i >>> 3] |= parseInt(hexStr.substr(i, 2), 16) << (24 - (i % 8) * 4);
	            }

	            return new WordArray.init(words, hexStrLength / 2);
	        }
	    };

	    /**
	     * Latin1 encoding strategy.
	     */
	    var Latin1 = C_enc.Latin1 = {
	        /**
	         * Converts a word array to a Latin1 string.
	         *
	         * @param {WordArray} wordArray The word array.
	         *
	         * @return {string} The Latin1 string.
	         *
	         * @static
	         *
	         * @example
	         *
	         *     var latin1String = CryptoJS.enc.Latin1.stringify(wordArray);
	         */
	        stringify: function (wordArray) {
	            // Shortcuts
	            var words = wordArray.words;
	            var sigBytes = wordArray.sigBytes;

	            // Convert
	            var latin1Chars = [];
	            for (var i = 0; i < sigBytes; i++) {
	                var bite = (words[i >>> 2] >>> (24 - (i % 4) * 8)) & 0xff;
	                latin1Chars.push(String.fromCharCode(bite));
	            }

	            return latin1Chars.join('');
	        },

	        /**
	         * Converts a Latin1 string to a word array.
	         *
	         * @param {string} latin1Str The Latin1 string.
	         *
	         * @return {WordArray} The word array.
	         *
	         * @static
	         *
	         * @example
	         *
	         *     var wordArray = CryptoJS.enc.Latin1.parse(latin1String);
	         */
	        parse: function (latin1Str) {
	            // Shortcut
	            var latin1StrLength = latin1Str.length;

	            // Convert
	            var words = [];
	            for (var i = 0; i < latin1StrLength; i++) {
	                words[i >>> 2] |= (latin1Str.charCodeAt(i) & 0xff) << (24 - (i % 4) * 8);
	            }

	            return new WordArray.init(words, latin1StrLength);
	        }
	    };

	    /**
	     * UTF-8 encoding strategy.
	     */
	    var Utf8 = C_enc.Utf8 = {
	        /**
	         * Converts a word array to a UTF-8 string.
	         *
	         * @param {WordArray} wordArray The word array.
	         *
	         * @return {string} The UTF-8 string.
	         *
	         * @static
	         *
	         * @example
	         *
	         *     var utf8String = CryptoJS.enc.Utf8.stringify(wordArray);
	         */
	        stringify: function (wordArray) {
	            try {
	                return decodeURIComponent(escape(Latin1.stringify(wordArray)));
	            } catch (e) {
	                throw new Error('Malformed UTF-8 data');
	            }
	        },

	        /**
	         * Converts a UTF-8 string to a word array.
	         *
	         * @param {string} utf8Str The UTF-8 string.
	         *
	         * @return {WordArray} The word array.
	         *
	         * @static
	         *
	         * @example
	         *
	         *     var wordArray = CryptoJS.enc.Utf8.parse(utf8String);
	         */
	        parse: function (utf8Str) {
	            return Latin1.parse(unescape(encodeURIComponent(utf8Str)));
	        }
	    };

	    /**
	     * Abstract buffered block algorithm template.
	     *
	     * The property blockSize must be implemented in a concrete subtype.
	     *
	     * @property {number} _minBufferSize The number of blocks that should be kept unprocessed in the buffer. Default: 0
	     */
	    var BufferedBlockAlgorithm = C_lib.BufferedBlockAlgorithm = Base.extend({
	        /**
	         * Resets this block algorithm's data buffer to its initial state.
	         *
	         * @example
	         *
	         *     bufferedBlockAlgorithm.reset();
	         */
	        reset: function () {
	            // Initial values
	            this._data = new WordArray.init();
	            this._nDataBytes = 0;
	        },

	        /**
	         * Adds new data to this block algorithm's buffer.
	         *
	         * @param {WordArray|string} data The data to append. Strings are converted to a WordArray using UTF-8.
	         *
	         * @example
	         *
	         *     bufferedBlockAlgorithm._append('data');
	         *     bufferedBlockAlgorithm._append(wordArray);
	         */
	        _append: function (data) {
	            // Convert string to WordArray, else assume WordArray already
	            if (typeof data == 'string') {
	                data = Utf8.parse(data);
	            }

	            // Append
	            this._data.concat(data);
	            this._nDataBytes += data.sigBytes;
	        },

	        /**
	         * Processes available data blocks.
	         *
	         * This method invokes _doProcessBlock(offset), which must be implemented by a concrete subtype.
	         *
	         * @param {boolean} doFlush Whether all blocks and partial blocks should be processed.
	         *
	         * @return {WordArray} The processed data.
	         *
	         * @example
	         *
	         *     var processedData = bufferedBlockAlgorithm._process();
	         *     var processedData = bufferedBlockAlgorithm._process(!!'flush');
	         */
	        _process: function (doFlush) {
	            // Shortcuts
	            var data = this._data;
	            var dataWords = data.words;
	            var dataSigBytes = data.sigBytes;
	            var blockSize = this.blockSize;
	            var blockSizeBytes = blockSize * 4;

	            // Count blocks ready
	            var nBlocksReady = dataSigBytes / blockSizeBytes;
	            if (doFlush) {
	                // Round up to include partial blocks
	                nBlocksReady = Math.ceil(nBlocksReady);
	            } else {
	                // Round down to include only full blocks,
	                // less the number of blocks that must remain in the buffer
	                nBlocksReady = Math.max((nBlocksReady | 0) - this._minBufferSize, 0);
	            }

	            // Count words ready
	            var nWordsReady = nBlocksReady * blockSize;

	            // Count bytes ready
	            var nBytesReady = Math.min(nWordsReady * 4, dataSigBytes);

	            // Process blocks
	            if (nWordsReady) {
	                for (var offset = 0; offset < nWordsReady; offset += blockSize) {
	                    // Perform concrete-algorithm logic
	                    this._doProcessBlock(dataWords, offset);
	                }

	                // Remove processed words
	                var processedWords = dataWords.splice(0, nWordsReady);
	                data.sigBytes -= nBytesReady;
	            }

	            // Return processed words
	            return new WordArray.init(processedWords, nBytesReady);
	        },

	        /**
	         * Creates a copy of this object.
	         *
	         * @return {Object} The clone.
	         *
	         * @example
	         *
	         *     var clone = bufferedBlockAlgorithm.clone();
	         */
	        clone: function () {
	            var clone = Base.clone.call(this);
	            clone._data = this._data.clone();

	            return clone;
	        },

	        _minBufferSize: 0
	    });

	    /**
	     * Abstract hasher template.
	     *
	     * @property {number} blockSize The number of 32-bit words this hasher operates on. Default: 16 (512 bits)
	     */
	    var Hasher = C_lib.Hasher = BufferedBlockAlgorithm.extend({
	        /**
	         * Configuration options.
	         */
	        cfg: Base.extend(),

	        /**
	         * Initializes a newly created hasher.
	         *
	         * @param {Object} cfg (Optional) The configuration options to use for this hash computation.
	         *
	         * @example
	         *
	         *     var hasher = CryptoJS.algo.SHA256.create();
	         */
	        init: function (cfg) {
	            // Apply config defaults
	            this.cfg = this.cfg.extend(cfg);

	            // Set initial values
	            this.reset();
	        },

	        /**
	         * Resets this hasher to its initial state.
	         *
	         * @example
	         *
	         *     hasher.reset();
	         */
	        reset: function () {
	            // Reset data buffer
	            BufferedBlockAlgorithm.reset.call(this);

	            // Perform concrete-hasher logic
	            this._doReset();
	        },

	        /**
	         * Updates this hasher with a message.
	         *
	         * @param {WordArray|string} messageUpdate The message to append.
	         *
	         * @return {Hasher} This hasher.
	         *
	         * @example
	         *
	         *     hasher.update('message');
	         *     hasher.update(wordArray);
	         */
	        update: function (messageUpdate) {
	            // Append
	            this._append(messageUpdate);

	            // Update the hash
	            this._process();

	            // Chainable
	            return this;
	        },

	        /**
	         * Finalizes the hash computation.
	         * Note that the finalize operation is effectively a destructive, read-once operation.
	         *
	         * @param {WordArray|string} messageUpdate (Optional) A final message update.
	         *
	         * @return {WordArray} The hash.
	         *
	         * @example
	         *
	         *     var hash = hasher.finalize();
	         *     var hash = hasher.finalize('message');
	         *     var hash = hasher.finalize(wordArray);
	         */
	        finalize: function (messageUpdate) {
	            // Final message update
	            if (messageUpdate) {
	                this._append(messageUpdate);
	            }

	            // Perform concrete-hasher logic
	            var hash = this._doFinalize();

	            return hash;
	        },

	        blockSize: 512/32,

	        /**
	         * Creates a shortcut function to a hasher's object interface.
	         *
	         * @param {Hasher} hasher The hasher to create a helper for.
	         *
	         * @return {Function} The shortcut function.
	         *
	         * @static
	         *
	         * @example
	         *
	         *     var SHA256 = CryptoJS.lib.Hasher._createHelper(CryptoJS.algo.SHA256);
	         */
	        _createHelper: function (hasher) {
	            return function (message, cfg) {
	                return new hasher.init(cfg).finalize(message);
	            };
	        },

	        /**
	         * Creates a shortcut function to the HMAC's object interface.
	         *
	         * @param {Hasher} hasher The hasher to use in this HMAC helper.
	         *
	         * @return {Function} The shortcut function.
	         *
	         * @static
	         *
	         * @example
	         *
	         *     var HmacSHA256 = CryptoJS.lib.Hasher._createHmacHelper(CryptoJS.algo.SHA256);
	         */
	        _createHmacHelper: function (hasher) {
	            return function (message, key) {
	                return new C_algo.HMAC.init(hasher, key).finalize(message);
	            };
	        }
	    });

	    /**
	     * Algorithm namespace.
	     */
	    var C_algo = C.algo = {};

	    return C;
	}(Math));


	(function () {
	    // Shortcuts
	    var C = CryptoJS;
	    var C_lib = C.lib;
	    var WordArray = C_lib.WordArray;
	    var C_enc = C.enc;

	    /**
	     * Base64 encoding strategy.
	     */
	    var Base64 = C_enc.Base64 = {
	        /**
	         * Converts a word array to a Base64 string.
	         *
	         * @param {WordArray} wordArray The word array.
	         *
	         * @return {string} The Base64 string.
	         *
	         * @static
	         *
	         * @example
	         *
	         *     var base64String = CryptoJS.enc.Base64.stringify(wordArray);
	         */
	        stringify: function (wordArray) {
	            // Shortcuts
	            var words = wordArray.words;
	            var sigBytes = wordArray.sigBytes;
	            var map = this._map;

	            // Clamp excess bits
	            wordArray.clamp();

	            // Convert
	            var base64Chars = [];
	            for (var i = 0; i < sigBytes; i += 3) {
	                var byte1 = (words[i >>> 2]       >>> (24 - (i % 4) * 8))       & 0xff;
	                var byte2 = (words[(i + 1) >>> 2] >>> (24 - ((i + 1) % 4) * 8)) & 0xff;
	                var byte3 = (words[(i + 2) >>> 2] >>> (24 - ((i + 2) % 4) * 8)) & 0xff;

	                var triplet = (byte1 << 16) | (byte2 << 8) | byte3;

	                for (var j = 0; (j < 4) && (i + j * 0.75 < sigBytes); j++) {
	                    base64Chars.push(map.charAt((triplet >>> (6 * (3 - j))) & 0x3f));
	                }
	            }

	            // Add padding
	            var paddingChar = map.charAt(64);
	            if (paddingChar) {
	                while (base64Chars.length % 4) {
	                    base64Chars.push(paddingChar);
	                }
	            }

	            return base64Chars.join('');
	        },

	        /**
	         * Converts a Base64 string to a word array.
	         *
	         * @param {string} base64Str The Base64 string.
	         *
	         * @return {WordArray} The word array.
	         *
	         * @static
	         *
	         * @example
	         *
	         *     var wordArray = CryptoJS.enc.Base64.parse(base64String);
	         */
	        parse: function (base64Str) {
	            // Shortcuts
	            var base64StrLength = base64Str.length;
	            var map = this._map;
	            var reverseMap = this._reverseMap;

	            if (!reverseMap) {
	                    reverseMap = this._reverseMap = [];
	                    for (var j = 0; j < map.length; j++) {
	                        reverseMap[map.charCodeAt(j)] = j;
	                    }
	            }

	            // Ignore padding
	            var paddingChar = map.charAt(64);
	            if (paddingChar) {
	                var paddingIndex = base64Str.indexOf(paddingChar);
	                if (paddingIndex !== -1) {
	                    base64StrLength = paddingIndex;
	                }
	            }

	            // Convert
	            return parseLoop(base64Str, base64StrLength, reverseMap);

	        },

	        _map: 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/='
	    };

	    function parseLoop(base64Str, base64StrLength, reverseMap) {
	      var words = [];
	      var nBytes = 0;
	      for (var i = 0; i < base64StrLength; i++) {
	          if (i % 4) {
	              var bits1 = reverseMap[base64Str.charCodeAt(i - 1)] << ((i % 4) * 2);
	              var bits2 = reverseMap[base64Str.charCodeAt(i)] >>> (6 - (i % 4) * 2);
	              words[nBytes >>> 2] |= (bits1 | bits2) << (24 - (nBytes % 4) * 8);
	              nBytes++;
	          }
	      }
	      return WordArray.create(words, nBytes);
	    }
	}());


	(function (Math) {
	    // Shortcuts
	    var C = CryptoJS;
	    var C_lib = C.lib;
	    var WordArray = C_lib.WordArray;
	    var Hasher = C_lib.Hasher;
	    var C_algo = C.algo;

	    // Constants table
	    var T = [];

	    // Compute constants
	    (function () {
	        for (var i = 0; i < 64; i++) {
	            T[i] = (Math.abs(Math.sin(i + 1)) * 0x100000000) | 0;
	        }
	    }());

	    /**
	     * MD5 hash algorithm.
	     */
	    var MD5 = C_algo.MD5 = Hasher.extend({
	        _doReset: function () {
	            this._hash = new WordArray.init([
	                0x67452301, 0xefcdab89,
	                0x98badcfe, 0x10325476
	            ]);
	        },

	        _doProcessBlock: function (M, offset) {
	            // Swap endian
	            for (var i = 0; i < 16; i++) {
	                // Shortcuts
	                var offset_i = offset + i;
	                var M_offset_i = M[offset_i];

	                M[offset_i] = (
	                    (((M_offset_i << 8)  | (M_offset_i >>> 24)) & 0x00ff00ff) |
	                    (((M_offset_i << 24) | (M_offset_i >>> 8))  & 0xff00ff00)
	                );
	            }

	            // Shortcuts
	            var H = this._hash.words;

	            var M_offset_0  = M[offset + 0];
	            var M_offset_1  = M[offset + 1];
	            var M_offset_2  = M[offset + 2];
	            var M_offset_3  = M[offset + 3];
	            var M_offset_4  = M[offset + 4];
	            var M_offset_5  = M[offset + 5];
	            var M_offset_6  = M[offset + 6];
	            var M_offset_7  = M[offset + 7];
	            var M_offset_8  = M[offset + 8];
	            var M_offset_9  = M[offset + 9];
	            var M_offset_10 = M[offset + 10];
	            var M_offset_11 = M[offset + 11];
	            var M_offset_12 = M[offset + 12];
	            var M_offset_13 = M[offset + 13];
	            var M_offset_14 = M[offset + 14];
	            var M_offset_15 = M[offset + 15];

	            // Working varialbes
	            var a = H[0];
	            var b = H[1];
	            var c = H[2];
	            var d = H[3];

	            // Computation
	            a = FF(a, b, c, d, M_offset_0,  7,  T[0]);
	            d = FF(d, a, b, c, M_offset_1,  12, T[1]);
	            c = FF(c, d, a, b, M_offset_2,  17, T[2]);
	            b = FF(b, c, d, a, M_offset_3,  22, T[3]);
	            a = FF(a, b, c, d, M_offset_4,  7,  T[4]);
	            d = FF(d, a, b, c, M_offset_5,  12, T[5]);
	            c = FF(c, d, a, b, M_offset_6,  17, T[6]);
	            b = FF(b, c, d, a, M_offset_7,  22, T[7]);
	            a = FF(a, b, c, d, M_offset_8,  7,  T[8]);
	            d = FF(d, a, b, c, M_offset_9,  12, T[9]);
	            c = FF(c, d, a, b, M_offset_10, 17, T[10]);
	            b = FF(b, c, d, a, M_offset_11, 22, T[11]);
	            a = FF(a, b, c, d, M_offset_12, 7,  T[12]);
	            d = FF(d, a, b, c, M_offset_13, 12, T[13]);
	            c = FF(c, d, a, b, M_offset_14, 17, T[14]);
	            b = FF(b, c, d, a, M_offset_15, 22, T[15]);

	            a = GG(a, b, c, d, M_offset_1,  5,  T[16]);
	            d = GG(d, a, b, c, M_offset_6,  9,  T[17]);
	            c = GG(c, d, a, b, M_offset_11, 14, T[18]);
	            b = GG(b, c, d, a, M_offset_0,  20, T[19]);
	            a = GG(a, b, c, d, M_offset_5,  5,  T[20]);
	            d = GG(d, a, b, c, M_offset_10, 9,  T[21]);
	            c = GG(c, d, a, b, M_offset_15, 14, T[22]);
	            b = GG(b, c, d, a, M_offset_4,  20, T[23]);
	            a = GG(a, b, c, d, M_offset_9,  5,  T[24]);
	            d = GG(d, a, b, c, M_offset_14, 9,  T[25]);
	            c = GG(c, d, a, b, M_offset_3,  14, T[26]);
	            b = GG(b, c, d, a, M_offset_8,  20, T[27]);
	            a = GG(a, b, c, d, M_offset_13, 5,  T[28]);
	            d = GG(d, a, b, c, M_offset_2,  9,  T[29]);
	            c = GG(c, d, a, b, M_offset_7,  14, T[30]);
	            b = GG(b, c, d, a, M_offset_12, 20, T[31]);

	            a = HH(a, b, c, d, M_offset_5,  4,  T[32]);
	            d = HH(d, a, b, c, M_offset_8,  11, T[33]);
	            c = HH(c, d, a, b, M_offset_11, 16, T[34]);
	            b = HH(b, c, d, a, M_offset_14, 23, T[35]);
	            a = HH(a, b, c, d, M_offset_1,  4,  T[36]);
	            d = HH(d, a, b, c, M_offset_4,  11, T[37]);
	            c = HH(c, d, a, b, M_offset_7,  16, T[38]);
	            b = HH(b, c, d, a, M_offset_10, 23, T[39]);
	            a = HH(a, b, c, d, M_offset_13, 4,  T[40]);
	            d = HH(d, a, b, c, M_offset_0,  11, T[41]);
	            c = HH(c, d, a, b, M_offset_3,  16, T[42]);
	            b = HH(b, c, d, a, M_offset_6,  23, T[43]);
	            a = HH(a, b, c, d, M_offset_9,  4,  T[44]);
	            d = HH(d, a, b, c, M_offset_12, 11, T[45]);
	            c = HH(c, d, a, b, M_offset_15, 16, T[46]);
	            b = HH(b, c, d, a, M_offset_2,  23, T[47]);

	            a = II(a, b, c, d, M_offset_0,  6,  T[48]);
	            d = II(d, a, b, c, M_offset_7,  10, T[49]);
	            c = II(c, d, a, b, M_offset_14, 15, T[50]);
	            b = II(b, c, d, a, M_offset_5,  21, T[51]);
	            a = II(a, b, c, d, M_offset_12, 6,  T[52]);
	            d = II(d, a, b, c, M_offset_3,  10, T[53]);
	            c = II(c, d, a, b, M_offset_10, 15, T[54]);
	            b = II(b, c, d, a, M_offset_1,  21, T[55]);
	            a = II(a, b, c, d, M_offset_8,  6,  T[56]);
	            d = II(d, a, b, c, M_offset_15, 10, T[57]);
	            c = II(c, d, a, b, M_offset_6,  15, T[58]);
	            b = II(b, c, d, a, M_offset_13, 21, T[59]);
	            a = II(a, b, c, d, M_offset_4,  6,  T[60]);
	            d = II(d, a, b, c, M_offset_11, 10, T[61]);
	            c = II(c, d, a, b, M_offset_2,  15, T[62]);
	            b = II(b, c, d, a, M_offset_9,  21, T[63]);

	            // Intermediate hash value
	            H[0] = (H[0] + a) | 0;
	            H[1] = (H[1] + b) | 0;
	            H[2] = (H[2] + c) | 0;
	            H[3] = (H[3] + d) | 0;
	        },

	        _doFinalize: function () {
	            // Shortcuts
	            var data = this._data;
	            var dataWords = data.words;

	            var nBitsTotal = this._nDataBytes * 8;
	            var nBitsLeft = data.sigBytes * 8;

	            // Add padding
	            dataWords[nBitsLeft >>> 5] |= 0x80 << (24 - nBitsLeft % 32);

	            var nBitsTotalH = Math.floor(nBitsTotal / 0x100000000);
	            var nBitsTotalL = nBitsTotal;
	            dataWords[(((nBitsLeft + 64) >>> 9) << 4) + 15] = (
	                (((nBitsTotalH << 8)  | (nBitsTotalH >>> 24)) & 0x00ff00ff) |
	                (((nBitsTotalH << 24) | (nBitsTotalH >>> 8))  & 0xff00ff00)
	            );
	            dataWords[(((nBitsLeft + 64) >>> 9) << 4) + 14] = (
	                (((nBitsTotalL << 8)  | (nBitsTotalL >>> 24)) & 0x00ff00ff) |
	                (((nBitsTotalL << 24) | (nBitsTotalL >>> 8))  & 0xff00ff00)
	            );

	            data.sigBytes = (dataWords.length + 1) * 4;

	            // Hash final blocks
	            this._process();

	            // Shortcuts
	            var hash = this._hash;
	            var H = hash.words;

	            // Swap endian
	            for (var i = 0; i < 4; i++) {
	                // Shortcut
	                var H_i = H[i];

	                H[i] = (((H_i << 8)  | (H_i >>> 24)) & 0x00ff00ff) |
	                       (((H_i << 24) | (H_i >>> 8))  & 0xff00ff00);
	            }

	            // Return final computed hash
	            return hash;
	        },

	        clone: function () {
	            var clone = Hasher.clone.call(this);
	            clone._hash = this._hash.clone();

	            return clone;
	        }
	    });

	    function FF(a, b, c, d, x, s, t) {
	        var n = a + ((b & c) | (~b & d)) + x + t;
	        return ((n << s) | (n >>> (32 - s))) + b;
	    }

	    function GG(a, b, c, d, x, s, t) {
	        var n = a + ((b & d) | (c & ~d)) + x + t;
	        return ((n << s) | (n >>> (32 - s))) + b;
	    }

	    function HH(a, b, c, d, x, s, t) {
	        var n = a + (b ^ c ^ d) + x + t;
	        return ((n << s) | (n >>> (32 - s))) + b;
	    }

	    function II(a, b, c, d, x, s, t) {
	        var n = a + (c ^ (b | ~d)) + x + t;
	        return ((n << s) | (n >>> (32 - s))) + b;
	    }

	    /**
	     * Shortcut function to the hasher's object interface.
	     *
	     * @param {WordArray|string} message The message to hash.
	     *
	     * @return {WordArray} The hash.
	     *
	     * @static
	     *
	     * @example
	     *
	     *     var hash = CryptoJS.MD5('message');
	     *     var hash = CryptoJS.MD5(wordArray);
	     */
	    C.MD5 = Hasher._createHelper(MD5);

	    /**
	     * Shortcut function to the HMAC's object interface.
	     *
	     * @param {WordArray|string} message The message to hash.
	     * @param {WordArray|string} key The secret key.
	     *
	     * @return {WordArray} The HMAC.
	     *
	     * @static
	     *
	     * @example
	     *
	     *     var hmac = CryptoJS.HmacMD5(message, key);
	     */
	    C.HmacMD5 = Hasher._createHmacHelper(MD5);
	}(Math));


	(function () {
	    // Shortcuts
	    var C = CryptoJS;
	    var C_lib = C.lib;
	    var WordArray = C_lib.WordArray;
	    var Hasher = C_lib.Hasher;
	    var C_algo = C.algo;

	    // Reusable object
	    var W = [];

	    /**
	     * SHA-1 hash algorithm.
	     */
	    var SHA1 = C_algo.SHA1 = Hasher.extend({
	        _doReset: function () {
	            this._hash = new WordArray.init([
	                0x67452301, 0xefcdab89,
	                0x98badcfe, 0x10325476,
	                0xc3d2e1f0
	            ]);
	        },

	        _doProcessBlock: function (M, offset) {
	            // Shortcut
	            var H = this._hash.words;

	            // Working variables
	            var a = H[0];
	            var b = H[1];
	            var c = H[2];
	            var d = H[3];
	            var e = H[4];

	            // Computation
	            for (var i = 0; i < 80; i++) {
	                if (i < 16) {
	                    W[i] = M[offset + i] | 0;
	                } else {
	                    var n = W[i - 3] ^ W[i - 8] ^ W[i - 14] ^ W[i - 16];
	                    W[i] = (n << 1) | (n >>> 31);
	                }

	                var t = ((a << 5) | (a >>> 27)) + e + W[i];
	                if (i < 20) {
	                    t += ((b & c) | (~b & d)) + 0x5a827999;
	                } else if (i < 40) {
	                    t += (b ^ c ^ d) + 0x6ed9eba1;
	                } else if (i < 60) {
	                    t += ((b & c) | (b & d) | (c & d)) - 0x70e44324;
	                } else /* if (i < 80) */ {
	                    t += (b ^ c ^ d) - 0x359d3e2a;
	                }

	                e = d;
	                d = c;
	                c = (b << 30) | (b >>> 2);
	                b = a;
	                a = t;
	            }

	            // Intermediate hash value
	            H[0] = (H[0] + a) | 0;
	            H[1] = (H[1] + b) | 0;
	            H[2] = (H[2] + c) | 0;
	            H[3] = (H[3] + d) | 0;
	            H[4] = (H[4] + e) | 0;
	        },

	        _doFinalize: function () {
	            // Shortcuts
	            var data = this._data;
	            var dataWords = data.words;

	            var nBitsTotal = this._nDataBytes * 8;
	            var nBitsLeft = data.sigBytes * 8;

	            // Add padding
	            dataWords[nBitsLeft >>> 5] |= 0x80 << (24 - nBitsLeft % 32);
	            dataWords[(((nBitsLeft + 64) >>> 9) << 4) + 14] = Math.floor(nBitsTotal / 0x100000000);
	            dataWords[(((nBitsLeft + 64) >>> 9) << 4) + 15] = nBitsTotal;
	            data.sigBytes = dataWords.length * 4;

	            // Hash final blocks
	            this._process();

	            // Return final computed hash
	            return this._hash;
	        },

	        clone: function () {
	            var clone = Hasher.clone.call(this);
	            clone._hash = this._hash.clone();

	            return clone;
	        }
	    });

	    /**
	     * Shortcut function to the hasher's object interface.
	     *
	     * @param {WordArray|string} message The message to hash.
	     *
	     * @return {WordArray} The hash.
	     *
	     * @static
	     *
	     * @example
	     *
	     *     var hash = CryptoJS.SHA1('message');
	     *     var hash = CryptoJS.SHA1(wordArray);
	     */
	    C.SHA1 = Hasher._createHelper(SHA1);

	    /**
	     * Shortcut function to the HMAC's object interface.
	     *
	     * @param {WordArray|string} message The message to hash.
	     * @param {WordArray|string} key The secret key.
	     *
	     * @return {WordArray} The HMAC.
	     *
	     * @static
	     *
	     * @example
	     *
	     *     var hmac = CryptoJS.HmacSHA1(message, key);
	     */
	    C.HmacSHA1 = Hasher._createHmacHelper(SHA1);
	}());


	(function (Math) {
	    // Shortcuts
	    var C = CryptoJS;
	    var C_lib = C.lib;
	    var WordArray = C_lib.WordArray;
	    var Hasher = C_lib.Hasher;
	    var C_algo = C.algo;

	    // Initialization and round constants tables
	    var H = [];
	    var K = [];

	    // Compute constants
	    (function () {
	        function isPrime(n) {
	            var sqrtN = Math.sqrt(n);
	            for (var factor = 2; factor <= sqrtN; factor++) {
	                if (!(n % factor)) {
	                    return false;
	                }
	            }

	            return true;
	        }

	        function getFractionalBits(n) {
	            return ((n - (n | 0)) * 0x100000000) | 0;
	        }

	        var n = 2;
	        var nPrime = 0;
	        while (nPrime < 64) {
	            if (isPrime(n)) {
	                if (nPrime < 8) {
	                    H[nPrime] = getFractionalBits(Math.pow(n, 1 / 2));
	                }
	                K[nPrime] = getFractionalBits(Math.pow(n, 1 / 3));

	                nPrime++;
	            }

	            n++;
	        }
	    }());

	    // Reusable object
	    var W = [];

	    /**
	     * SHA-256 hash algorithm.
	     */
	    var SHA256 = C_algo.SHA256 = Hasher.extend({
	        _doReset: function () {
	            this._hash = new WordArray.init(H.slice(0));
	        },

	        _doProcessBlock: function (M, offset) {
	            // Shortcut
	            var H = this._hash.words;

	            // Working variables
	            var a = H[0];
	            var b = H[1];
	            var c = H[2];
	            var d = H[3];
	            var e = H[4];
	            var f = H[5];
	            var g = H[6];
	            var h = H[7];

	            // Computation
	            for (var i = 0; i < 64; i++) {
	                if (i < 16) {
	                    W[i] = M[offset + i] | 0;
	                } else {
	                    var gamma0x = W[i - 15];
	                    var gamma0  = ((gamma0x << 25) | (gamma0x >>> 7))  ^
	                                  ((gamma0x << 14) | (gamma0x >>> 18)) ^
	                                   (gamma0x >>> 3);

	                    var gamma1x = W[i - 2];
	                    var gamma1  = ((gamma1x << 15) | (gamma1x >>> 17)) ^
	                                  ((gamma1x << 13) | (gamma1x >>> 19)) ^
	                                   (gamma1x >>> 10);

	                    W[i] = gamma0 + W[i - 7] + gamma1 + W[i - 16];
	                }

	                var ch  = (e & f) ^ (~e & g);
	                var maj = (a & b) ^ (a & c) ^ (b & c);

	                var sigma0 = ((a << 30) | (a >>> 2)) ^ ((a << 19) | (a >>> 13)) ^ ((a << 10) | (a >>> 22));
	                var sigma1 = ((e << 26) | (e >>> 6)) ^ ((e << 21) | (e >>> 11)) ^ ((e << 7)  | (e >>> 25));

	                var t1 = h + sigma1 + ch + K[i] + W[i];
	                var t2 = sigma0 + maj;

	                h = g;
	                g = f;
	                f = e;
	                e = (d + t1) | 0;
	                d = c;
	                c = b;
	                b = a;
	                a = (t1 + t2) | 0;
	            }

	            // Intermediate hash value
	            H[0] = (H[0] + a) | 0;
	            H[1] = (H[1] + b) | 0;
	            H[2] = (H[2] + c) | 0;
	            H[3] = (H[3] + d) | 0;
	            H[4] = (H[4] + e) | 0;
	            H[5] = (H[5] + f) | 0;
	            H[6] = (H[6] + g) | 0;
	            H[7] = (H[7] + h) | 0;
	        },

	        _doFinalize: function () {
	            // Shortcuts
	            var data = this._data;
	            var dataWords = data.words;

	            var nBitsTotal = this._nDataBytes * 8;
	            var nBitsLeft = data.sigBytes * 8;

	            // Add padding
	            dataWords[nBitsLeft >>> 5] |= 0x80 << (24 - nBitsLeft % 32);
	            dataWords[(((nBitsLeft + 64) >>> 9) << 4) + 14] = Math.floor(nBitsTotal / 0x100000000);
	            dataWords[(((nBitsLeft + 64) >>> 9) << 4) + 15] = nBitsTotal;
	            data.sigBytes = dataWords.length * 4;

	            // Hash final blocks
	            this._process();

	            // Return final computed hash
	            return this._hash;
	        },

	        clone: function () {
	            var clone = Hasher.clone.call(this);
	            clone._hash = this._hash.clone();

	            return clone;
	        }
	    });

	    /**
	     * Shortcut function to the hasher's object interface.
	     *
	     * @param {WordArray|string} message The message to hash.
	     *
	     * @return {WordArray} The hash.
	     *
	     * @static
	     *
	     * @example
	     *
	     *     var hash = CryptoJS.SHA256('message');
	     *     var hash = CryptoJS.SHA256(wordArray);
	     */
	    C.SHA256 = Hasher._createHelper(SHA256);

	    /**
	     * Shortcut function to the HMAC's object interface.
	     *
	     * @param {WordArray|string} message The message to hash.
	     * @param {WordArray|string} key The secret key.
	     *
	     * @return {WordArray} The HMAC.
	     *
	     * @static
	     *
	     * @example
	     *
	     *     var hmac = CryptoJS.HmacSHA256(message, key);
	     */
	    C.HmacSHA256 = Hasher._createHmacHelper(SHA256);
	}(Math));


	(function () {
	    // Shortcuts
	    var C = CryptoJS;
	    var C_lib = C.lib;
	    var WordArray = C_lib.WordArray;
	    var C_enc = C.enc;

	    /**
	     * UTF-16 BE encoding strategy.
	     */
	    var Utf16BE = C_enc.Utf16 = C_enc.Utf16BE = {
	        /**
	         * Converts a word array to a UTF-16 BE string.
	         *
	         * @param {WordArray} wordArray The word array.
	         *
	         * @return {string} The UTF-16 BE string.
	         *
	         * @static
	         *
	         * @example
	         *
	         *     var utf16String = CryptoJS.enc.Utf16.stringify(wordArray);
	         */
	        stringify: function (wordArray) {
	            // Shortcuts
	            var words = wordArray.words;
	            var sigBytes = wordArray.sigBytes;

	            // Convert
	            var utf16Chars = [];
	            for (var i = 0; i < sigBytes; i += 2) {
	                var codePoint = (words[i >>> 2] >>> (16 - (i % 4) * 8)) & 0xffff;
	                utf16Chars.push(String.fromCharCode(codePoint));
	            }

	            return utf16Chars.join('');
	        },

	        /**
	         * Converts a UTF-16 BE string to a word array.
	         *
	         * @param {string} utf16Str The UTF-16 BE string.
	         *
	         * @return {WordArray} The word array.
	         *
	         * @static
	         *
	         * @example
	         *
	         *     var wordArray = CryptoJS.enc.Utf16.parse(utf16String);
	         */
	        parse: function (utf16Str) {
	            // Shortcut
	            var utf16StrLength = utf16Str.length;

	            // Convert
	            var words = [];
	            for (var i = 0; i < utf16StrLength; i++) {
	                words[i >>> 1] |= utf16Str.charCodeAt(i) << (16 - (i % 2) * 16);
	            }

	            return WordArray.create(words, utf16StrLength * 2);
	        }
	    };

	    /**
	     * UTF-16 LE encoding strategy.
	     */
	    C_enc.Utf16LE = {
	        /**
	         * Converts a word array to a UTF-16 LE string.
	         *
	         * @param {WordArray} wordArray The word array.
	         *
	         * @return {string} The UTF-16 LE string.
	         *
	         * @static
	         *
	         * @example
	         *
	         *     var utf16Str = CryptoJS.enc.Utf16LE.stringify(wordArray);
	         */
	        stringify: function (wordArray) {
	            // Shortcuts
	            var words = wordArray.words;
	            var sigBytes = wordArray.sigBytes;

	            // Convert
	            var utf16Chars = [];
	            for (var i = 0; i < sigBytes; i += 2) {
	                var codePoint = swapEndian((words[i >>> 2] >>> (16 - (i % 4) * 8)) & 0xffff);
	                utf16Chars.push(String.fromCharCode(codePoint));
	            }

	            return utf16Chars.join('');
	        },

	        /**
	         * Converts a UTF-16 LE string to a word array.
	         *
	         * @param {string} utf16Str The UTF-16 LE string.
	         *
	         * @return {WordArray} The word array.
	         *
	         * @static
	         *
	         * @example
	         *
	         *     var wordArray = CryptoJS.enc.Utf16LE.parse(utf16Str);
	         */
	        parse: function (utf16Str) {
	            // Shortcut
	            var utf16StrLength = utf16Str.length;

	            // Convert
	            var words = [];
	            for (var i = 0; i < utf16StrLength; i++) {
	                words[i >>> 1] |= swapEndian(utf16Str.charCodeAt(i) << (16 - (i % 2) * 16));
	            }

	            return WordArray.create(words, utf16StrLength * 2);
	        }
	    };

	    function swapEndian(word) {
	        return ((word << 8) & 0xff00ff00) | ((word >>> 8) & 0x00ff00ff);
	    }
	}());


	(function () {
	    // Check if typed arrays are supported
	    if (typeof ArrayBuffer != 'function') {
	        return;
	    }

	    // Shortcuts
	    var C = CryptoJS;
	    var C_lib = C.lib;
	    var WordArray = C_lib.WordArray;

	    // Reference original init
	    var superInit = WordArray.init;

	    // Augment WordArray.init to handle typed arrays
	    var subInit = WordArray.init = function (typedArray) {
	        // Convert buffers to uint8
	        if (typedArray instanceof ArrayBuffer) {
	            typedArray = new Uint8Array(typedArray);
	        }

	        // Convert other array views to uint8
	        if (
	            typedArray instanceof Int8Array ||
	            (typeof Uint8ClampedArray !== "undefined" && typedArray instanceof Uint8ClampedArray) ||
	            typedArray instanceof Int16Array ||
	            typedArray instanceof Uint16Array ||
	            typedArray instanceof Int32Array ||
	            typedArray instanceof Uint32Array ||
	            typedArray instanceof Float32Array ||
	            typedArray instanceof Float64Array
	        ) {
	            typedArray = new Uint8Array(typedArray.buffer, typedArray.byteOffset, typedArray.byteLength);
	        }

	        // Handle Uint8Array
	        if (typedArray instanceof Uint8Array) {
	            // Shortcut
	            var typedArrayByteLength = typedArray.byteLength;

	            // Extract bytes
	            var words = [];
	            for (var i = 0; i < typedArrayByteLength; i++) {
	                words[i >>> 2] |= typedArray[i] << (24 - (i % 4) * 8);
	            }

	            // Initialize this word array
	            superInit.call(this, words, typedArrayByteLength);
	        } else {
	            // Else call normal init
	            superInit.apply(this, arguments);
	        }
	    };

	    subInit.prototype = WordArray;
	}());


	/** @preserve
	(c) 2012 by Cdric Mesnil. All rights reserved.

	Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:

	    - Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.
	    - Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.

	THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
	*/

	(function (Math) {
	    // Shortcuts
	    var C = CryptoJS;
	    var C_lib = C.lib;
	    var WordArray = C_lib.WordArray;
	    var Hasher = C_lib.Hasher;
	    var C_algo = C.algo;

	    // Constants table
	    var _zl = WordArray.create([
	        0,  1,  2,  3,  4,  5,  6,  7,  8,  9, 10, 11, 12, 13, 14, 15,
	        7,  4, 13,  1, 10,  6, 15,  3, 12,  0,  9,  5,  2, 14, 11,  8,
	        3, 10, 14,  4,  9, 15,  8,  1,  2,  7,  0,  6, 13, 11,  5, 12,
	        1,  9, 11, 10,  0,  8, 12,  4, 13,  3,  7, 15, 14,  5,  6,  2,
	        4,  0,  5,  9,  7, 12,  2, 10, 14,  1,  3,  8, 11,  6, 15, 13]);
	    var _zr = WordArray.create([
	        5, 14,  7,  0,  9,  2, 11,  4, 13,  6, 15,  8,  1, 10,  3, 12,
	        6, 11,  3,  7,  0, 13,  5, 10, 14, 15,  8, 12,  4,  9,  1,  2,
	        15,  5,  1,  3,  7, 14,  6,  9, 11,  8, 12,  2, 10,  0,  4, 13,
	        8,  6,  4,  1,  3, 11, 15,  0,  5, 12,  2, 13,  9,  7, 10, 14,
	        12, 15, 10,  4,  1,  5,  8,  7,  6,  2, 13, 14,  0,  3,  9, 11]);
	    var _sl = WordArray.create([
	         11, 14, 15, 12,  5,  8,  7,  9, 11, 13, 14, 15,  6,  7,  9,  8,
	        7, 6,   8, 13, 11,  9,  7, 15,  7, 12, 15,  9, 11,  7, 13, 12,
	        11, 13,  6,  7, 14,  9, 13, 15, 14,  8, 13,  6,  5, 12,  7,  5,
	          11, 12, 14, 15, 14, 15,  9,  8,  9, 14,  5,  6,  8,  6,  5, 12,
	        9, 15,  5, 11,  6,  8, 13, 12,  5, 12, 13, 14, 11,  8,  5,  6 ]);
	    var _sr = WordArray.create([
	        8,  9,  9, 11, 13, 15, 15,  5,  7,  7,  8, 11, 14, 14, 12,  6,
	        9, 13, 15,  7, 12,  8,  9, 11,  7,  7, 12,  7,  6, 15, 13, 11,
	        9,  7, 15, 11,  8,  6,  6, 14, 12, 13,  5, 14, 13, 13,  7,  5,
	        15,  5,  8, 11, 14, 14,  6, 14,  6,  9, 12,  9, 12,  5, 15,  8,
	        8,  5, 12,  9, 12,  5, 14,  6,  8, 13,  6,  5, 15, 13, 11, 11 ]);

	    var _hl =  WordArray.create([ 0x00000000, 0x5A827999, 0x6ED9EBA1, 0x8F1BBCDC, 0xA953FD4E]);
	    var _hr =  WordArray.create([ 0x50A28BE6, 0x5C4DD124, 0x6D703EF3, 0x7A6D76E9, 0x00000000]);

	    /**
	     * RIPEMD160 hash algorithm.
	     */
	    var RIPEMD160 = C_algo.RIPEMD160 = Hasher.extend({
	        _doReset: function () {
	            this._hash  = WordArray.create([0x67452301, 0xEFCDAB89, 0x98BADCFE, 0x10325476, 0xC3D2E1F0]);
	        },

	        _doProcessBlock: function (M, offset) {

	            // Swap endian
	            for (var i = 0; i < 16; i++) {
	                // Shortcuts
	                var offset_i = offset + i;
	                var M_offset_i = M[offset_i];

	                // Swap
	                M[offset_i] = (
	                    (((M_offset_i << 8)  | (M_offset_i >>> 24)) & 0x00ff00ff) |
	                    (((M_offset_i << 24) | (M_offset_i >>> 8))  & 0xff00ff00)
	                );
	            }
	            // Shortcut
	            var H  = this._hash.words;
	            var hl = _hl.words;
	            var hr = _hr.words;
	            var zl = _zl.words;
	            var zr = _zr.words;
	            var sl = _sl.words;
	            var sr = _sr.words;

	            // Working variables
	            var al, bl, cl, dl, el;
	            var ar, br, cr, dr, er;

	            ar = al = H[0];
	            br = bl = H[1];
	            cr = cl = H[2];
	            dr = dl = H[3];
	            er = el = H[4];
	            // Computation
	            var t;
	            for (var i = 0; i < 80; i += 1) {
	                t = (al +  M[offset+zl[i]])|0;
	                if (i<16){
		            t +=  f1(bl,cl,dl) + hl[0];
	                } else if (i<32) {
		            t +=  f2(bl,cl,dl) + hl[1];
	                } else if (i<48) {
		            t +=  f3(bl,cl,dl) + hl[2];
	                } else if (i<64) {
		            t +=  f4(bl,cl,dl) + hl[3];
	                } else {// if (i<80) {
		            t +=  f5(bl,cl,dl) + hl[4];
	                }
	                t = t|0;
	                t =  rotl(t,sl[i]);
	                t = (t+el)|0;
	                al = el;
	                el = dl;
	                dl = rotl(cl, 10);
	                cl = bl;
	                bl = t;

	                t = (ar + M[offset+zr[i]])|0;
	                if (i<16){
		            t +=  f5(br,cr,dr) + hr[0];
	                } else if (i<32) {
		            t +=  f4(br,cr,dr) + hr[1];
	                } else if (i<48) {
		            t +=  f3(br,cr,dr) + hr[2];
	                } else if (i<64) {
		            t +=  f2(br,cr,dr) + hr[3];
	                } else {// if (i<80) {
		            t +=  f1(br,cr,dr) + hr[4];
	                }
	                t = t|0;
	                t =  rotl(t,sr[i]) ;
	                t = (t+er)|0;
	                ar = er;
	                er = dr;
	                dr = rotl(cr, 10);
	                cr = br;
	                br = t;
	            }
	            // Intermediate hash value
	            t    = (H[1] + cl + dr)|0;
	            H[1] = (H[2] + dl + er)|0;
	            H[2] = (H[3] + el + ar)|0;
	            H[3] = (H[4] + al + br)|0;
	            H[4] = (H[0] + bl + cr)|0;
	            H[0] =  t;
	        },

	        _doFinalize: function () {
	            // Shortcuts
	            var data = this._data;
	            var dataWords = data.words;

	            var nBitsTotal = this._nDataBytes * 8;
	            var nBitsLeft = data.sigBytes * 8;

	            // Add padding
	            dataWords[nBitsLeft >>> 5] |= 0x80 << (24 - nBitsLeft % 32);
	            dataWords[(((nBitsLeft + 64) >>> 9) << 4) + 14] = (
	                (((nBitsTotal << 8)  | (nBitsTotal >>> 24)) & 0x00ff00ff) |
	                (((nBitsTotal << 24) | (nBitsTotal >>> 8))  & 0xff00ff00)
	            );
	            data.sigBytes = (dataWords.length + 1) * 4;

	            // Hash final blocks
	            this._process();

	            // Shortcuts
	            var hash = this._hash;
	            var H = hash.words;

	            // Swap endian
	            for (var i = 0; i < 5; i++) {
	                // Shortcut
	                var H_i = H[i];

	                // Swap
	                H[i] = (((H_i << 8)  | (H_i >>> 24)) & 0x00ff00ff) |
	                       (((H_i << 24) | (H_i >>> 8))  & 0xff00ff00);
	            }

	            // Return final computed hash
	            return hash;
	        },

	        clone: function () {
	            var clone = Hasher.clone.call(this);
	            clone._hash = this._hash.clone();

	            return clone;
	        }
	    });


	    function f1(x, y, z) {
	        return ((x) ^ (y) ^ (z));

	    }

	    function f2(x, y, z) {
	        return (((x)&(y)) | ((~x)&(z)));
	    }

	    function f3(x, y, z) {
	        return (((x) | (~(y))) ^ (z));
	    }

	    function f4(x, y, z) {
	        return (((x) & (z)) | ((y)&(~(z))));
	    }

	    function f5(x, y, z) {
	        return ((x) ^ ((y) |(~(z))));

	    }

	    function rotl(x,n) {
	        return (x<<n) | (x>>>(32-n));
	    }


	    /**
	     * Shortcut function to the hasher's object interface.
	     *
	     * @param {WordArray|string} message The message to hash.
	     *
	     * @return {WordArray} The hash.
	     *
	     * @static
	     *
	     * @example
	     *
	     *     var hash = CryptoJS.RIPEMD160('message');
	     *     var hash = CryptoJS.RIPEMD160(wordArray);
	     */
	    C.RIPEMD160 = Hasher._createHelper(RIPEMD160);

	    /**
	     * Shortcut function to the HMAC's object interface.
	     *
	     * @param {WordArray|string} message The message to hash.
	     * @param {WordArray|string} key The secret key.
	     *
	     * @return {WordArray} The HMAC.
	     *
	     * @static
	     *
	     * @example
	     *
	     *     var hmac = CryptoJS.HmacRIPEMD160(message, key);
	     */
	    C.HmacRIPEMD160 = Hasher._createHmacHelper(RIPEMD160);
	}(Math));


	(function () {
	    // Shortcuts
	    var C = CryptoJS;
	    var C_lib = C.lib;
	    var Base = C_lib.Base;
	    var C_enc = C.enc;
	    var Utf8 = C_enc.Utf8;
	    var C_algo = C.algo;

	    /**
	     * HMAC algorithm.
	     */
	    var HMAC = C_algo.HMAC = Base.extend({
	        /**
	         * Initializes a newly created HMAC.
	         *
	         * @param {Hasher} hasher The hash algorithm to use.
	         * @param {WordArray|string} key The secret key.
	         *
	         * @example
	         *
	         *     var hmacHasher = CryptoJS.algo.HMAC.create(CryptoJS.algo.SHA256, key);
	         */
	        init: function (hasher, key) {
	            // Init hasher
	            hasher = this._hasher = new hasher.init();

	            // Convert string to WordArray, else assume WordArray already
	            if (typeof key == 'string') {
	                key = Utf8.parse(key);
	            }

	            // Shortcuts
	            var hasherBlockSize = hasher.blockSize;
	            var hasherBlockSizeBytes = hasherBlockSize * 4;

	            // Allow arbitrary length keys
	            if (key.sigBytes > hasherBlockSizeBytes) {
	                key = hasher.finalize(key);
	            }

	            // Clamp excess bits
	            key.clamp();

	            // Clone key for inner and outer pads
	            var oKey = this._oKey = key.clone();
	            var iKey = this._iKey = key.clone();

	            // Shortcuts
	            var oKeyWords = oKey.words;
	            var iKeyWords = iKey.words;

	            // XOR keys with pad constants
	            for (var i = 0; i < hasherBlockSize; i++) {
	                oKeyWords[i] ^= 0x5c5c5c5c;
	                iKeyWords[i] ^= 0x36363636;
	            }
	            oKey.sigBytes = iKey.sigBytes = hasherBlockSizeBytes;

	            // Set initial values
	            this.reset();
	        },

	        /**
	         * Resets this HMAC to its initial state.
	         *
	         * @example
	         *
	         *     hmacHasher.reset();
	         */
	        reset: function () {
	            // Shortcut
	            var hasher = this._hasher;

	            // Reset
	            hasher.reset();
	            hasher.update(this._iKey);
	        },

	        /**
	         * Updates this HMAC with a message.
	         *
	         * @param {WordArray|string} messageUpdate The message to append.
	         *
	         * @return {HMAC} This HMAC instance.
	         *
	         * @example
	         *
	         *     hmacHasher.update('message');
	         *     hmacHasher.update(wordArray);
	         */
	        update: function (messageUpdate) {
	            this._hasher.update(messageUpdate);

	            // Chainable
	            return this;
	        },

	        /**
	         * Finalizes the HMAC computation.
	         * Note that the finalize operation is effectively a destructive, read-once operation.
	         *
	         * @param {WordArray|string} messageUpdate (Optional) A final message update.
	         *
	         * @return {WordArray} The HMAC.
	         *
	         * @example
	         *
	         *     var hmac = hmacHasher.finalize();
	         *     var hmac = hmacHasher.finalize('message');
	         *     var hmac = hmacHasher.finalize(wordArray);
	         */
	        finalize: function (messageUpdate) {
	            // Shortcut
	            var hasher = this._hasher;

	            // Compute HMAC
	            var innerHash = hasher.finalize(messageUpdate);
	            hasher.reset();
	            var hmac = hasher.finalize(this._oKey.clone().concat(innerHash));

	            return hmac;
	        }
	    });
	}());


	(function () {
	    // Shortcuts
	    var C = CryptoJS;
	    var C_lib = C.lib;
	    var Base = C_lib.Base;
	    var WordArray = C_lib.WordArray;
	    var C_algo = C.algo;
	    var SHA1 = C_algo.SHA1;
	    var HMAC = C_algo.HMAC;

	    /**
	     * Password-Based Key Derivation Function 2 algorithm.
	     */
	    var PBKDF2 = C_algo.PBKDF2 = Base.extend({
	        /**
	         * Configuration options.
	         *
	         * @property {number} keySize The key size in words to generate. Default: 4 (128 bits)
	         * @property {Hasher} hasher The hasher to use. Default: SHA1
	         * @property {number} iterations The number of iterations to perform. Default: 1
	         */
	        cfg: Base.extend({
	            keySize: 128/32,
	            hasher: SHA1,
	            iterations: 1
	        }),

	        /**
	         * Initializes a newly created key derivation function.
	         *
	         * @param {Object} cfg (Optional) The configuration options to use for the derivation.
	         *
	         * @example
	         *
	         *     var kdf = CryptoJS.algo.PBKDF2.create();
	         *     var kdf = CryptoJS.algo.PBKDF2.create({ keySize: 8 });
	         *     var kdf = CryptoJS.algo.PBKDF2.create({ keySize: 8, iterations: 1000 });
	         */
	        init: function (cfg) {
	            this.cfg = this.cfg.extend(cfg);
	        },

	        /**
	         * Computes the Password-Based Key Derivation Function 2.
	         *
	         * @param {WordArray|string} password The password.
	         * @param {WordArray|string} salt A salt.
	         *
	         * @return {WordArray} The derived key.
	         *
	         * @example
	         *
	         *     var key = kdf.compute(password, salt);
	         */
	        compute: function (password, salt) {
	            // Shortcut
	            var cfg = this.cfg;

	            // Init HMAC
	            var hmac = HMAC.create(cfg.hasher, password);

	            // Initial values
	            var derivedKey = WordArray.create();
	            var blockIndex = WordArray.create([0x00000001]);

	            // Shortcuts
	            var derivedKeyWords = derivedKey.words;
	            var blockIndexWords = blockIndex.words;
	            var keySize = cfg.keySize;
	            var iterations = cfg.iterations;

	            // Generate key
	            while (derivedKeyWords.length < keySize) {
	                var block = hmac.update(salt).finalize(blockIndex);
	                hmac.reset();

	                // Shortcuts
	                var blockWords = block.words;
	                var blockWordsLength = blockWords.length;

	                // Iterations
	                var intermediate = block;
	                for (var i = 1; i < iterations; i++) {
	                    intermediate = hmac.finalize(intermediate);
	                    hmac.reset();

	                    // Shortcut
	                    var intermediateWords = intermediate.words;

	                    // XOR intermediate with block
	                    for (var j = 0; j < blockWordsLength; j++) {
	                        blockWords[j] ^= intermediateWords[j];
	                    }
	                }

	                derivedKey.concat(block);
	                blockIndexWords[0]++;
	            }
	            derivedKey.sigBytes = keySize * 4;

	            return derivedKey;
	        }
	    });

	    /**
	     * Computes the Password-Based Key Derivation Function 2.
	     *
	     * @param {WordArray|string} password The password.
	     * @param {WordArray|string} salt A salt.
	     * @param {Object} cfg (Optional) The configuration options to use for this computation.
	     *
	     * @return {WordArray} The derived key.
	     *
	     * @static
	     *
	     * @example
	     *
	     *     var key = CryptoJS.PBKDF2(password, salt);
	     *     var key = CryptoJS.PBKDF2(password, salt, { keySize: 8 });
	     *     var key = CryptoJS.PBKDF2(password, salt, { keySize: 8, iterations: 1000 });
	     */
	    C.PBKDF2 = function (password, salt, cfg) {
	        return PBKDF2.create(cfg).compute(password, salt);
	    };
	}());


	(function () {
	    // Shortcuts
	    var C = CryptoJS;
	    var C_lib = C.lib;
	    var Base = C_lib.Base;
	    var WordArray = C_lib.WordArray;
	    var C_algo = C.algo;
	    var MD5 = C_algo.MD5;

	    /**
	     * This key derivation function is meant to conform with EVP_BytesToKey.
	     * www.openssl.org/docs/crypto/EVP_BytesToKey.html
	     */
	    var EvpKDF = C_algo.EvpKDF = Base.extend({
	        /**
	         * Configuration options.
	         *
	         * @property {number} keySize The key size in words to generate. Default: 4 (128 bits)
	         * @property {Hasher} hasher The hash algorithm to use. Default: MD5
	         * @property {number} iterations The number of iterations to perform. Default: 1
	         */
	        cfg: Base.extend({
	            keySize: 128/32,
	            hasher: MD5,
	            iterations: 1
	        }),

	        /**
	         * Initializes a newly created key derivation function.
	         *
	         * @param {Object} cfg (Optional) The configuration options to use for the derivation.
	         *
	         * @example
	         *
	         *     var kdf = CryptoJS.algo.EvpKDF.create();
	         *     var kdf = CryptoJS.algo.EvpKDF.create({ keySize: 8 });
	         *     var kdf = CryptoJS.algo.EvpKDF.create({ keySize: 8, iterations: 1000 });
	         */
	        init: function (cfg) {
	            this.cfg = this.cfg.extend(cfg);
	        },

	        /**
	         * Derives a key from a password.
	         *
	         * @param {WordArray|string} password The password.
	         * @param {WordArray|string} salt A salt.
	         *
	         * @return {WordArray} The derived key.
	         *
	         * @example
	         *
	         *     var key = kdf.compute(password, salt);
	         */
	        compute: function (password, salt) {
	            // Shortcut
	            var cfg = this.cfg;

	            // Init hasher
	            var hasher = cfg.hasher.create();

	            // Initial values
	            var derivedKey = WordArray.create();

	            // Shortcuts
	            var derivedKeyWords = derivedKey.words;
	            var keySize = cfg.keySize;
	            var iterations = cfg.iterations;

	            // Generate key
	            while (derivedKeyWords.length < keySize) {
	                if (block) {
	                    hasher.update(block);
	                }
	                var block = hasher.update(password).finalize(salt);
	                hasher.reset();

	                // Iterations
	                for (var i = 1; i < iterations; i++) {
	                    block = hasher.finalize(block);
	                    hasher.reset();
	                }

	                derivedKey.concat(block);
	            }
	            derivedKey.sigBytes = keySize * 4;

	            return derivedKey;
	        }
	    });

	    /**
	     * Derives a key from a password.
	     *
	     * @param {WordArray|string} password The password.
	     * @param {WordArray|string} salt A salt.
	     * @param {Object} cfg (Optional) The configuration options to use for this computation.
	     *
	     * @return {WordArray} The derived key.
	     *
	     * @static
	     *
	     * @example
	     *
	     *     var key = CryptoJS.EvpKDF(password, salt);
	     *     var key = CryptoJS.EvpKDF(password, salt, { keySize: 8 });
	     *     var key = CryptoJS.EvpKDF(password, salt, { keySize: 8, iterations: 1000 });
	     */
	    C.EvpKDF = function (password, salt, cfg) {
	        return EvpKDF.create(cfg).compute(password, salt);
	    };
	}());


	(function () {
	    // Shortcuts
	    var C = CryptoJS;
	    var C_lib = C.lib;
	    var WordArray = C_lib.WordArray;
	    var C_algo = C.algo;
	    var SHA256 = C_algo.SHA256;

	    /**
	     * SHA-224 hash algorithm.
	     */
	    var SHA224 = C_algo.SHA224 = SHA256.extend({
	        _doReset: function () {
	            this._hash = new WordArray.init([
	                0xc1059ed8, 0x367cd507, 0x3070dd17, 0xf70e5939,
	                0xffc00b31, 0x68581511, 0x64f98fa7, 0xbefa4fa4
	            ]);
	        },

	        _doFinalize: function () {
	            var hash = SHA256._doFinalize.call(this);

	            hash.sigBytes -= 4;

	            return hash;
	        }
	    });

	    /**
	     * Shortcut function to the hasher's object interface.
	     *
	     * @param {WordArray|string} message The message to hash.
	     *
	     * @return {WordArray} The hash.
	     *
	     * @static
	     *
	     * @example
	     *
	     *     var hash = CryptoJS.SHA224('message');
	     *     var hash = CryptoJS.SHA224(wordArray);
	     */
	    C.SHA224 = SHA256._createHelper(SHA224);

	    /**
	     * Shortcut function to the HMAC's object interface.
	     *
	     * @param {WordArray|string} message The message to hash.
	     * @param {WordArray|string} key The secret key.
	     *
	     * @return {WordArray} The HMAC.
	     *
	     * @static
	     *
	     * @example
	     *
	     *     var hmac = CryptoJS.HmacSHA224(message, key);
	     */
	    C.HmacSHA224 = SHA256._createHmacHelper(SHA224);
	}());


	(function (undefined) {
	    // Shortcuts
	    var C = CryptoJS;
	    var C_lib = C.lib;
	    var Base = C_lib.Base;
	    var X32WordArray = C_lib.WordArray;

	    /**
	     * x64 namespace.
	     */
	    var C_x64 = C.x64 = {};

	    /**
	     * A 64-bit word.
	     */
	    var X64Word = C_x64.Word = Base.extend({
	        /**
	         * Initializes a newly created 64-bit word.
	         *
	         * @param {number} high The high 32 bits.
	         * @param {number} low The low 32 bits.
	         *
	         * @example
	         *
	         *     var x64Word = CryptoJS.x64.Word.create(0x00010203, 0x04050607);
	         */
	        init: function (high, low) {
	            this.high = high;
	            this.low = low;
	        }

	        /**
	         * Bitwise NOTs this word.
	         *
	         * @return {X64Word} A new x64-Word object after negating.
	         *
	         * @example
	         *
	         *     var negated = x64Word.not();
	         */
	        // not: function () {
	            // var high = ~this.high;
	            // var low = ~this.low;

	            // return X64Word.create(high, low);
	        // },

	        /**
	         * Bitwise ANDs this word with the passed word.
	         *
	         * @param {X64Word} word The x64-Word to AND with this word.
	         *
	         * @return {X64Word} A new x64-Word object after ANDing.
	         *
	         * @example
	         *
	         *     var anded = x64Word.and(anotherX64Word);
	         */
	        // and: function (word) {
	            // var high = this.high & word.high;
	            // var low = this.low & word.low;

	            // return X64Word.create(high, low);
	        // },

	        /**
	         * Bitwise ORs this word with the passed word.
	         *
	         * @param {X64Word} word The x64-Word to OR with this word.
	         *
	         * @return {X64Word} A new x64-Word object after ORing.
	         *
	         * @example
	         *
	         *     var ored = x64Word.or(anotherX64Word);
	         */
	        // or: function (word) {
	            // var high = this.high | word.high;
	            // var low = this.low | word.low;

	            // return X64Word.create(high, low);
	        // },

	        /**
	         * Bitwise XORs this word with the passed word.
	         *
	         * @param {X64Word} word The x64-Word to XOR with this word.
	         *
	         * @return {X64Word} A new x64-Word object after XORing.
	         *
	         * @example
	         *
	         *     var xored = x64Word.xor(anotherX64Word);
	         */
	        // xor: function (word) {
	            // var high = this.high ^ word.high;
	            // var low = this.low ^ word.low;

	            // return X64Word.create(high, low);
	        // },

	        /**
	         * Shifts this word n bits to the left.
	         *
	         * @param {number} n The number of bits to shift.
	         *
	         * @return {X64Word} A new x64-Word object after shifting.
	         *
	         * @example
	         *
	         *     var shifted = x64Word.shiftL(25);
	         */
	        // shiftL: function (n) {
	            // if (n < 32) {
	                // var high = (this.high << n) | (this.low >>> (32 - n));
	                // var low = this.low << n;
	            // } else {
	                // var high = this.low << (n - 32);
	                // var low = 0;
	            // }

	            // return X64Word.create(high, low);
	        // },

	        /**
	         * Shifts this word n bits to the right.
	         *
	         * @param {number} n The number of bits to shift.
	         *
	         * @return {X64Word} A new x64-Word object after shifting.
	         *
	         * @example
	         *
	         *     var shifted = x64Word.shiftR(7);
	         */
	        // shiftR: function (n) {
	            // if (n < 32) {
	                // var low = (this.low >>> n) | (this.high << (32 - n));
	                // var high = this.high >>> n;
	            // } else {
	                // var low = this.high >>> (n - 32);
	                // var high = 0;
	            // }

	            // return X64Word.create(high, low);
	        // },

	        /**
	         * Rotates this word n bits to the left.
	         *
	         * @param {number} n The number of bits to rotate.
	         *
	         * @return {X64Word} A new x64-Word object after rotating.
	         *
	         * @example
	         *
	         *     var rotated = x64Word.rotL(25);
	         */
	        // rotL: function (n) {
	            // return this.shiftL(n).or(this.shiftR(64 - n));
	        // },

	        /**
	         * Rotates this word n bits to the right.
	         *
	         * @param {number} n The number of bits to rotate.
	         *
	         * @return {X64Word} A new x64-Word object after rotating.
	         *
	         * @example
	         *
	         *     var rotated = x64Word.rotR(7);
	         */
	        // rotR: function (n) {
	            // return this.shiftR(n).or(this.shiftL(64 - n));
	        // },

	        /**
	         * Adds this word with the passed word.
	         *
	         * @param {X64Word} word The x64-Word to add with this word.
	         *
	         * @return {X64Word} A new x64-Word object after adding.
	         *
	         * @example
	         *
	         *     var added = x64Word.add(anotherX64Word);
	         */
	        // add: function (word) {
	            // var low = (this.low + word.low) | 0;
	            // var carry = (low >>> 0) < (this.low >>> 0) ? 1 : 0;
	            // var high = (this.high + word.high + carry) | 0;

	            // return X64Word.create(high, low);
	        // }
	    });

	    /**
	     * An array of 64-bit words.
	     *
	     * @property {Array} words The array of CryptoJS.x64.Word objects.
	     * @property {number} sigBytes The number of significant bytes in this word array.
	     */
	    var X64WordArray = C_x64.WordArray = Base.extend({
	        /**
	         * Initializes a newly created word array.
	         *
	         * @param {Array} words (Optional) An array of CryptoJS.x64.Word objects.
	         * @param {number} sigBytes (Optional) The number of significant bytes in the words.
	         *
	         * @example
	         *
	         *     var wordArray = CryptoJS.x64.WordArray.create();
	         *
	         *     var wordArray = CryptoJS.x64.WordArray.create([
	         *         CryptoJS.x64.Word.create(0x00010203, 0x04050607),
	         *         CryptoJS.x64.Word.create(0x18191a1b, 0x1c1d1e1f)
	         *     ]);
	         *
	         *     var wordArray = CryptoJS.x64.WordArray.create([
	         *         CryptoJS.x64.Word.create(0x00010203, 0x04050607),
	         *         CryptoJS.x64.Word.create(0x18191a1b, 0x1c1d1e1f)
	         *     ], 10);
	         */
	        init: function (words, sigBytes) {
	            words = this.words = words || [];

	            if (sigBytes != undefined) {
	                this.sigBytes = sigBytes;
	            } else {
	                this.sigBytes = words.length * 8;
	            }
	        },

	        /**
	         * Converts this 64-bit word array to a 32-bit word array.
	         *
	         * @return {CryptoJS.lib.WordArray} This word array's data as a 32-bit word array.
	         *
	         * @example
	         *
	         *     var x32WordArray = x64WordArray.toX32();
	         */
	        toX32: function () {
	            // Shortcuts
	            var x64Words = this.words;
	            var x64WordsLength = x64Words.length;

	            // Convert
	            var x32Words = [];
	            for (var i = 0; i < x64WordsLength; i++) {
	                var x64Word = x64Words[i];
	                x32Words.push(x64Word.high);
	                x32Words.push(x64Word.low);
	            }

	            return X32WordArray.create(x32Words, this.sigBytes);
	        },

	        /**
	         * Creates a copy of this word array.
	         *
	         * @return {X64WordArray} The clone.
	         *
	         * @example
	         *
	         *     var clone = x64WordArray.clone();
	         */
	        clone: function () {
	            var clone = Base.clone.call(this);

	            // Clone "words" array
	            var words = clone.words = this.words.slice(0);

	            // Clone each X64Word object
	            var wordsLength = words.length;
	            for (var i = 0; i < wordsLength; i++) {
	                words[i] = words[i].clone();
	            }

	            return clone;
	        }
	    });
	}());


	(function (Math) {
	    // Shortcuts
	    var C = CryptoJS;
	    var C_lib = C.lib;
	    var WordArray = C_lib.WordArray;
	    var Hasher = C_lib.Hasher;
	    var C_x64 = C.x64;
	    var X64Word = C_x64.Word;
	    var C_algo = C.algo;

	    // Constants tables
	    var RHO_OFFSETS = [];
	    var PI_INDEXES  = [];
	    var ROUND_CONSTANTS = [];

	    // Compute Constants
	    (function () {
	        // Compute rho offset constants
	        var x = 1, y = 0;
	        for (var t = 0; t < 24; t++) {
	            RHO_OFFSETS[x + 5 * y] = ((t + 1) * (t + 2) / 2) % 64;

	            var newX = y % 5;
	            var newY = (2 * x + 3 * y) % 5;
	            x = newX;
	            y = newY;
	        }

	        // Compute pi index constants
	        for (var x = 0; x < 5; x++) {
	            for (var y = 0; y < 5; y++) {
	                PI_INDEXES[x + 5 * y] = y + ((2 * x + 3 * y) % 5) * 5;
	            }
	        }

	        // Compute round constants
	        var LFSR = 0x01;
	        for (var i = 0; i < 24; i++) {
	            var roundConstantMsw = 0;
	            var roundConstantLsw = 0;

	            for (var j = 0; j < 7; j++) {
	                if (LFSR & 0x01) {
	                    var bitPosition = (1 << j) - 1;
	                    if (bitPosition < 32) {
	                        roundConstantLsw ^= 1 << bitPosition;
	                    } else /* if (bitPosition >= 32) */ {
	                        roundConstantMsw ^= 1 << (bitPosition - 32);
	                    }
	                }

	                // Compute next LFSR
	                if (LFSR & 0x80) {
	                    // Primitive polynomial over GF(2): x^8 + x^6 + x^5 + x^4 + 1
	                    LFSR = (LFSR << 1) ^ 0x71;
	                } else {
	                    LFSR <<= 1;
	                }
	            }

	            ROUND_CONSTANTS[i] = X64Word.create(roundConstantMsw, roundConstantLsw);
	        }
	    }());

	    // Reusable objects for temporary values
	    var T = [];
	    (function () {
	        for (var i = 0; i < 25; i++) {
	            T[i] = X64Word.create();
	        }
	    }());

	    /**
	     * SHA-3 hash algorithm.
	     */
	    var SHA3 = C_algo.SHA3 = Hasher.extend({
	        /**
	         * Configuration options.
	         *
	         * @property {number} outputLength
	         *   The desired number of bits in the output hash.
	         *   Only values permitted are: 224, 256, 384, 512.
	         *   Default: 512
	         */
	        cfg: Hasher.cfg.extend({
	            outputLength: 512
	        }),

	        _doReset: function () {
	            var state = this._state = []
	            for (var i = 0; i < 25; i++) {
	                state[i] = new X64Word.init();
	            }

	            this.blockSize = (1600 - 2 * this.cfg.outputLength) / 32;
	        },

	        _doProcessBlock: function (M, offset) {
	            // Shortcuts
	            var state = this._state;
	            var nBlockSizeLanes = this.blockSize / 2;

	            // Absorb
	            for (var i = 0; i < nBlockSizeLanes; i++) {
	                // Shortcuts
	                var M2i  = M[offset + 2 * i];
	                var M2i1 = M[offset + 2 * i + 1];

	                // Swap endian
	                M2i = (
	                    (((M2i << 8)  | (M2i >>> 24)) & 0x00ff00ff) |
	                    (((M2i << 24) | (M2i >>> 8))  & 0xff00ff00)
	                );
	                M2i1 = (
	                    (((M2i1 << 8)  | (M2i1 >>> 24)) & 0x00ff00ff) |
	                    (((M2i1 << 24) | (M2i1 >>> 8))  & 0xff00ff00)
	                );

	                // Absorb message into state
	                var lane = state[i];
	                lane.high ^= M2i1;
	                lane.low  ^= M2i;
	            }

	            // Rounds
	            for (var round = 0; round < 24; round++) {
	                // Theta
	                for (var x = 0; x < 5; x++) {
	                    // Mix column lanes
	                    var tMsw = 0, tLsw = 0;
	                    for (var y = 0; y < 5; y++) {
	                        var lane = state[x + 5 * y];
	                        tMsw ^= lane.high;
	                        tLsw ^= lane.low;
	                    }

	                    // Temporary values
	                    var Tx = T[x];
	                    Tx.high = tMsw;
	                    Tx.low  = tLsw;
	                }
	                for (var x = 0; x < 5; x++) {
	                    // Shortcuts
	                    var Tx4 = T[(x + 4) % 5];
	                    var Tx1 = T[(x + 1) % 5];
	                    var Tx1Msw = Tx1.high;
	                    var Tx1Lsw = Tx1.low;

	                    // Mix surrounding columns
	                    var tMsw = Tx4.high ^ ((Tx1Msw << 1) | (Tx1Lsw >>> 31));
	                    var tLsw = Tx4.low  ^ ((Tx1Lsw << 1) | (Tx1Msw >>> 31));
	                    for (var y = 0; y < 5; y++) {
	                        var lane = state[x + 5 * y];
	                        lane.high ^= tMsw;
	                        lane.low  ^= tLsw;
	                    }
	                }

	                // Rho Pi
	                for (var laneIndex = 1; laneIndex < 25; laneIndex++) {
	                    // Shortcuts
	                    var lane = state[laneIndex];
	                    var laneMsw = lane.high;
	                    var laneLsw = lane.low;
	                    var rhoOffset = RHO_OFFSETS[laneIndex];

	                    // Rotate lanes
	                    if (rhoOffset < 32) {
	                        var tMsw = (laneMsw << rhoOffset) | (laneLsw >>> (32 - rhoOffset));
	                        var tLsw = (laneLsw << rhoOffset) | (laneMsw >>> (32 - rhoOffset));
	                    } else /* if (rhoOffset >= 32) */ {
	                        var tMsw = (laneLsw << (rhoOffset - 32)) | (laneMsw >>> (64 - rhoOffset));
	                        var tLsw = (laneMsw << (rhoOffset - 32)) | (laneLsw >>> (64 - rhoOffset));
	                    }

	                    // Transpose lanes
	                    var TPiLane = T[PI_INDEXES[laneIndex]];
	                    TPiLane.high = tMsw;
	                    TPiLane.low  = tLsw;
	                }

	                // Rho pi at x = y = 0
	                var T0 = T[0];
	                var state0 = state[0];
	                T0.high = state0.high;
	                T0.low  = state0.low;

	                // Chi
	                for (var x = 0; x < 5; x++) {
	                    for (var y = 0; y < 5; y++) {
	                        // Shortcuts
	                        var laneIndex = x + 5 * y;
	                        var lane = state[laneIndex];
	                        var TLane = T[laneIndex];
	                        var Tx1Lane = T[((x + 1) % 5) + 5 * y];
	                        var Tx2Lane = T[((x + 2) % 5) + 5 * y];

	                        // Mix rows
	                        lane.high = TLane.high ^ (~Tx1Lane.high & Tx2Lane.high);
	                        lane.low  = TLane.low  ^ (~Tx1Lane.low  & Tx2Lane.low);
	                    }
	                }

	                // Iota
	                var lane = state[0];
	                var roundConstant = ROUND_CONSTANTS[round];
	                lane.high ^= roundConstant.high;
	                lane.low  ^= roundConstant.low;;
	            }
	        },

	        _doFinalize: function () {
	            // Shortcuts
	            var data = this._data;
	            var dataWords = data.words;
	            var nBitsTotal = this._nDataBytes * 8;
	            var nBitsLeft = data.sigBytes * 8;
	            var blockSizeBits = this.blockSize * 32;

	            // Add padding
	            dataWords[nBitsLeft >>> 5] |= 0x1 << (24 - nBitsLeft % 32);
	            dataWords[((Math.ceil((nBitsLeft + 1) / blockSizeBits) * blockSizeBits) >>> 5) - 1] |= 0x80;
	            data.sigBytes = dataWords.length * 4;

	            // Hash final blocks
	            this._process();

	            // Shortcuts
	            var state = this._state;
	            var outputLengthBytes = this.cfg.outputLength / 8;
	            var outputLengthLanes = outputLengthBytes / 8;

	            // Squeeze
	            var hashWords = [];
	            for (var i = 0; i < outputLengthLanes; i++) {
	                // Shortcuts
	                var lane = state[i];
	                var laneMsw = lane.high;
	                var laneLsw = lane.low;

	                // Swap endian
	                laneMsw = (
	                    (((laneMsw << 8)  | (laneMsw >>> 24)) & 0x00ff00ff) |
	                    (((laneMsw << 24) | (laneMsw >>> 8))  & 0xff00ff00)
	                );
	                laneLsw = (
	                    (((laneLsw << 8)  | (laneLsw >>> 24)) & 0x00ff00ff) |
	                    (((laneLsw << 24) | (laneLsw >>> 8))  & 0xff00ff00)
	                );

	                // Squeeze state to retrieve hash
	                hashWords.push(laneLsw);
	                hashWords.push(laneMsw);
	            }

	            // Return final computed hash
	            return new WordArray.init(hashWords, outputLengthBytes);
	        },

	        clone: function () {
	            var clone = Hasher.clone.call(this);

	            var state = clone._state = this._state.slice(0);
	            for (var i = 0; i < 25; i++) {
	                state[i] = state[i].clone();
	            }

	            return clone;
	        }
	    });

	    /**
	     * Shortcut function to the hasher's object interface.
	     *
	     * @param {WordArray|string} message The message to hash.
	     *
	     * @return {WordArray} The hash.
	     *
	     * @static
	     *
	     * @example
	     *
	     *     var hash = CryptoJS.SHA3('message');
	     *     var hash = CryptoJS.SHA3(wordArray);
	     */
	    C.SHA3 = Hasher._createHelper(SHA3);

	    /**
	     * Shortcut function to the HMAC's object interface.
	     *
	     * @param {WordArray|string} message The message to hash.
	     * @param {WordArray|string} key The secret key.
	     *
	     * @return {WordArray} The HMAC.
	     *
	     * @static
	     *
	     * @example
	     *
	     *     var hmac = CryptoJS.HmacSHA3(message, key);
	     */
	    C.HmacSHA3 = Hasher._createHmacHelper(SHA3);
	}(Math));


	(function () {
	    // Shortcuts
	    var C = CryptoJS;
	    var C_lib = C.lib;
	    var Hasher = C_lib.Hasher;
	    var C_x64 = C.x64;
	    var X64Word = C_x64.Word;
	    var X64WordArray = C_x64.WordArray;
	    var C_algo = C.algo;

	    function X64Word_create() {
	        return X64Word.create.apply(X64Word, arguments);
	    }

	    // Constants
	    var K = [
	        X64Word_create(0x428a2f98, 0xd728ae22), X64Word_create(0x71374491, 0x23ef65cd),
	        X64Word_create(0xb5c0fbcf, 0xec4d3b2f), X64Word_create(0xe9b5dba5, 0x8189dbbc),
	        X64Word_create(0x3956c25b, 0xf348b538), X64Word_create(0x59f111f1, 0xb605d019),
	        X64Word_create(0x923f82a4, 0xaf194f9b), X64Word_create(0xab1c5ed5, 0xda6d8118),
	        X64Word_create(0xd807aa98, 0xa3030242), X64Word_create(0x12835b01, 0x45706fbe),
	        X64Word_create(0x243185be, 0x4ee4b28c), X64Word_create(0x550c7dc3, 0xd5ffb4e2),
	        X64Word_create(0x72be5d74, 0xf27b896f), X64Word_create(0x80deb1fe, 0x3b1696b1),
	        X64Word_create(0x9bdc06a7, 0x25c71235), X64Word_create(0xc19bf174, 0xcf692694),
	        X64Word_create(0xe49b69c1, 0x9ef14ad2), X64Word_create(0xefbe4786, 0x384f25e3),
	        X64Word_create(0x0fc19dc6, 0x8b8cd5b5), X64Word_create(0x240ca1cc, 0x77ac9c65),
	        X64Word_create(0x2de92c6f, 0x592b0275), X64Word_create(0x4a7484aa, 0x6ea6e483),
	        X64Word_create(0x5cb0a9dc, 0xbd41fbd4), X64Word_create(0x76f988da, 0x831153b5),
	        X64Word_create(0x983e5152, 0xee66dfab), X64Word_create(0xa831c66d, 0x2db43210),
	        X64Word_create(0xb00327c8, 0x98fb213f), X64Word_create(0xbf597fc7, 0xbeef0ee4),
	        X64Word_create(0xc6e00bf3, 0x3da88fc2), X64Word_create(0xd5a79147, 0x930aa725),
	        X64Word_create(0x06ca6351, 0xe003826f), X64Word_create(0x14292967, 0x0a0e6e70),
	        X64Word_create(0x27b70a85, 0x46d22ffc), X64Word_create(0x2e1b2138, 0x5c26c926),
	        X64Word_create(0x4d2c6dfc, 0x5ac42aed), X64Word_create(0x53380d13, 0x9d95b3df),
	        X64Word_create(0x650a7354, 0x8baf63de), X64Word_create(0x766a0abb, 0x3c77b2a8),
	        X64Word_create(0x81c2c92e, 0x47edaee6), X64Word_create(0x92722c85, 0x1482353b),
	        X64Word_create(0xa2bfe8a1, 0x4cf10364), X64Word_create(0xa81a664b, 0xbc423001),
	        X64Word_create(0xc24b8b70, 0xd0f89791), X64Word_create(0xc76c51a3, 0x0654be30),
	        X64Word_create(0xd192e819, 0xd6ef5218), X64Word_create(0xd6990624, 0x5565a910),
	        X64Word_create(0xf40e3585, 0x5771202a), X64Word_create(0x106aa070, 0x32bbd1b8),
	        X64Word_create(0x19a4c116, 0xb8d2d0c8), X64Word_create(0x1e376c08, 0x5141ab53),
	        X64Word_create(0x2748774c, 0xdf8eeb99), X64Word_create(0x34b0bcb5, 0xe19b48a8),
	        X64Word_create(0x391c0cb3, 0xc5c95a63), X64Word_create(0x4ed8aa4a, 0xe3418acb),
	        X64Word_create(0x5b9cca4f, 0x7763e373), X64Word_create(0x682e6ff3, 0xd6b2b8a3),
	        X64Word_create(0x748f82ee, 0x5defb2fc), X64Word_create(0x78a5636f, 0x43172f60),
	        X64Word_create(0x84c87814, 0xa1f0ab72), X64Word_create(0x8cc70208, 0x1a6439ec),
	        X64Word_create(0x90befffa, 0x23631e28), X64Word_create(0xa4506ceb, 0xde82bde9),
	        X64Word_create(0xbef9a3f7, 0xb2c67915), X64Word_create(0xc67178f2, 0xe372532b),
	        X64Word_create(0xca273ece, 0xea26619c), X64Word_create(0xd186b8c7, 0x21c0c207),
	        X64Word_create(0xeada7dd6, 0xcde0eb1e), X64Word_create(0xf57d4f7f, 0xee6ed178),
	        X64Word_create(0x06f067aa, 0x72176fba), X64Word_create(0x0a637dc5, 0xa2c898a6),
	        X64Word_create(0x113f9804, 0xbef90dae), X64Word_create(0x1b710b35, 0x131c471b),
	        X64Word_create(0x28db77f5, 0x23047d84), X64Word_create(0x32caab7b, 0x40c72493),
	        X64Word_create(0x3c9ebe0a, 0x15c9bebc), X64Word_create(0x431d67c4, 0x9c100d4c),
	        X64Word_create(0x4cc5d4be, 0xcb3e42b6), X64Word_create(0x597f299c, 0xfc657e2a),
	        X64Word_create(0x5fcb6fab, 0x3ad6faec), X64Word_create(0x6c44198c, 0x4a475817)
	    ];

	    // Reusable objects
	    var W = [];
	    (function () {
	        for (var i = 0; i < 80; i++) {
	            W[i] = X64Word_create();
	        }
	    }());

	    /**
	     * SHA-512 hash algorithm.
	     */
	    var SHA512 = C_algo.SHA512 = Hasher.extend({
	        _doReset: function () {
	            this._hash = new X64WordArray.init([
	                new X64Word.init(0x6a09e667, 0xf3bcc908), new X64Word.init(0xbb67ae85, 0x84caa73b),
	                new X64Word.init(0x3c6ef372, 0xfe94f82b), new X64Word.init(0xa54ff53a, 0x5f1d36f1),
	                new X64Word.init(0x510e527f, 0xade682d1), new X64Word.init(0x9b05688c, 0x2b3e6c1f),
	                new X64Word.init(0x1f83d9ab, 0xfb41bd6b), new X64Word.init(0x5be0cd19, 0x137e2179)
	            ]);
	        },

	        _doProcessBlock: function (M, offset) {
	            // Shortcuts
	            var H = this._hash.words;

	            var H0 = H[0];
	            var H1 = H[1];
	            var H2 = H[2];
	            var H3 = H[3];
	            var H4 = H[4];
	            var H5 = H[5];
	            var H6 = H[6];
	            var H7 = H[7];

	            var H0h = H0.high;
	            var H0l = H0.low;
	            var H1h = H1.high;
	            var H1l = H1.low;
	            var H2h = H2.high;
	            var H2l = H2.low;
	            var H3h = H3.high;
	            var H3l = H3.low;
	            var H4h = H4.high;
	            var H4l = H4.low;
	            var H5h = H5.high;
	            var H5l = H5.low;
	            var H6h = H6.high;
	            var H6l = H6.low;
	            var H7h = H7.high;
	            var H7l = H7.low;

	            // Working variables
	            var ah = H0h;
	            var al = H0l;
	            var bh = H1h;
	            var bl = H1l;
	            var ch = H2h;
	            var cl = H2l;
	            var dh = H3h;
	            var dl = H3l;
	            var eh = H4h;
	            var el = H4l;
	            var fh = H5h;
	            var fl = H5l;
	            var gh = H6h;
	            var gl = H6l;
	            var hh = H7h;
	            var hl = H7l;

	            // Rounds
	            for (var i = 0; i < 80; i++) {
	                // Shortcut
	                var Wi = W[i];

	                // Extend message
	                if (i < 16) {
	                    var Wih = Wi.high = M[offset + i * 2]     | 0;
	                    var Wil = Wi.low  = M[offset + i * 2 + 1] | 0;
	                } else {
	                    // Gamma0
	                    var gamma0x  = W[i - 15];
	                    var gamma0xh = gamma0x.high;
	                    var gamma0xl = gamma0x.low;
	                    var gamma0h  = ((gamma0xh >>> 1) | (gamma0xl << 31)) ^ ((gamma0xh >>> 8) | (gamma0xl << 24)) ^ (gamma0xh >>> 7);
	                    var gamma0l  = ((gamma0xl >>> 1) | (gamma0xh << 31)) ^ ((gamma0xl >>> 8) | (gamma0xh << 24)) ^ ((gamma0xl >>> 7) | (gamma0xh << 25));

	                    // Gamma1
	                    var gamma1x  = W[i - 2];
	                    var gamma1xh = gamma1x.high;
	                    var gamma1xl = gamma1x.low;
	                    var gamma1h  = ((gamma1xh >>> 19) | (gamma1xl << 13)) ^ ((gamma1xh << 3) | (gamma1xl >>> 29)) ^ (gamma1xh >>> 6);
	                    var gamma1l  = ((gamma1xl >>> 19) | (gamma1xh << 13)) ^ ((gamma1xl << 3) | (gamma1xh >>> 29)) ^ ((gamma1xl >>> 6) | (gamma1xh << 26));

	                    // W[i] = gamma0 + W[i - 7] + gamma1 + W[i - 16]
	                    var Wi7  = W[i - 7];
	                    var Wi7h = Wi7.high;
	                    var Wi7l = Wi7.low;

	                    var Wi16  = W[i - 16];
	                    var Wi16h = Wi16.high;
	                    var Wi16l = Wi16.low;

	                    var Wil = gamma0l + Wi7l;
	                    var Wih = gamma0h + Wi7h + ((Wil >>> 0) < (gamma0l >>> 0) ? 1 : 0);
	                    var Wil = Wil + gamma1l;
	                    var Wih = Wih + gamma1h + ((Wil >>> 0) < (gamma1l >>> 0) ? 1 : 0);
	                    var Wil = Wil + Wi16l;
	                    var Wih = Wih + Wi16h + ((Wil >>> 0) < (Wi16l >>> 0) ? 1 : 0);

	                    Wi.high = Wih;
	                    Wi.low  = Wil;
	                }

	                var chh  = (eh & fh) ^ (~eh & gh);
	                var chl  = (el & fl) ^ (~el & gl);
	                var majh = (ah & bh) ^ (ah & ch) ^ (bh & ch);
	                var majl = (al & bl) ^ (al & cl) ^ (bl & cl);

	                var sigma0h = ((ah >>> 28) | (al << 4))  ^ ((ah << 30)  | (al >>> 2)) ^ ((ah << 25) | (al >>> 7));
	                var sigma0l = ((al >>> 28) | (ah << 4))  ^ ((al << 30)  | (ah >>> 2)) ^ ((al << 25) | (ah >>> 7));
	                var sigma1h = ((eh >>> 14) | (el << 18)) ^ ((eh >>> 18) | (el << 14)) ^ ((eh << 23) | (el >>> 9));
	                var sigma1l = ((el >>> 14) | (eh << 18)) ^ ((el >>> 18) | (eh << 14)) ^ ((el << 23) | (eh >>> 9));

	                // t1 = h + sigma1 + ch + K[i] + W[i]
	                var Ki  = K[i];
	                var Kih = Ki.high;
	                var Kil = Ki.low;

	                var t1l = hl + sigma1l;
	                var t1h = hh + sigma1h + ((t1l >>> 0) < (hl >>> 0) ? 1 : 0);
	                var t1l = t1l + chl;
	                var t1h = t1h + chh + ((t1l >>> 0) < (chl >>> 0) ? 1 : 0);
	                var t1l = t1l + Kil;
	                var t1h = t1h + Kih + ((t1l >>> 0) < (Kil >>> 0) ? 1 : 0);
	                var t1l = t1l + Wil;
	                var t1h = t1h + Wih + ((t1l >>> 0) < (Wil >>> 0) ? 1 : 0);

	                // t2 = sigma0 + maj
	                var t2l = sigma0l + majl;
	                var t2h = sigma0h + majh + ((t2l >>> 0) < (sigma0l >>> 0) ? 1 : 0);

	                // Update working variables
	                hh = gh;
	                hl = gl;
	                gh = fh;
	                gl = fl;
	                fh = eh;
	                fl = el;
	                el = (dl + t1l) | 0;
	                eh = (dh + t1h + ((el >>> 0) < (dl >>> 0) ? 1 : 0)) | 0;
	                dh = ch;
	                dl = cl;
	                ch = bh;
	                cl = bl;
	                bh = ah;
	                bl = al;
	                al = (t1l + t2l) | 0;
	                ah = (t1h + t2h + ((al >>> 0) < (t1l >>> 0) ? 1 : 0)) | 0;
	            }

	            // Intermediate hash value
	            H0l = H0.low  = (H0l + al);
	            H0.high = (H0h + ah + ((H0l >>> 0) < (al >>> 0) ? 1 : 0));
	            H1l = H1.low  = (H1l + bl);
	            H1.high = (H1h + bh + ((H1l >>> 0) < (bl >>> 0) ? 1 : 0));
	            H2l = H2.low  = (H2l + cl);
	            H2.high = (H2h + ch + ((H2l >>> 0) < (cl >>> 0) ? 1 : 0));
	            H3l = H3.low  = (H3l + dl);
	            H3.high = (H3h + dh + ((H3l >>> 0) < (dl >>> 0) ? 1 : 0));
	            H4l = H4.low  = (H4l + el);
	            H4.high = (H4h + eh + ((H4l >>> 0) < (el >>> 0) ? 1 : 0));
	            H5l = H5.low  = (H5l + fl);
	            H5.high = (H5h + fh + ((H5l >>> 0) < (fl >>> 0) ? 1 : 0));
	            H6l = H6.low  = (H6l + gl);
	            H6.high = (H6h + gh + ((H6l >>> 0) < (gl >>> 0) ? 1 : 0));
	            H7l = H7.low  = (H7l + hl);
	            H7.high = (H7h + hh + ((H7l >>> 0) < (hl >>> 0) ? 1 : 0));
	        },

	        _doFinalize: function () {
	            // Shortcuts
	            var data = this._data;
	            var dataWords = data.words;

	            var nBitsTotal = this._nDataBytes * 8;
	            var nBitsLeft = data.sigBytes * 8;

	            // Add padding
	            dataWords[nBitsLeft >>> 5] |= 0x80 << (24 - nBitsLeft % 32);
	            dataWords[(((nBitsLeft + 128) >>> 10) << 5) + 30] = Math.floor(nBitsTotal / 0x100000000);
	            dataWords[(((nBitsLeft + 128) >>> 10) << 5) + 31] = nBitsTotal;
	            data.sigBytes = dataWords.length * 4;

	            // Hash final blocks
	            this._process();

	            // Convert hash to 32-bit word array before returning
	            var hash = this._hash.toX32();

	            // Return final computed hash
	            return hash;
	        },

	        clone: function () {
	            var clone = Hasher.clone.call(this);
	            clone._hash = this._hash.clone();

	            return clone;
	        },

	        blockSize: 1024/32
	    });

	    /**
	     * Shortcut function to the hasher's object interface.
	     *
	     * @param {WordArray|string} message The message to hash.
	     *
	     * @return {WordArray} The hash.
	     *
	     * @static
	     *
	     * @example
	     *
	     *     var hash = CryptoJS.SHA512('message');
	     *     var hash = CryptoJS.SHA512(wordArray);
	     */
	    C.SHA512 = Hasher._createHelper(SHA512);

	    /**
	     * Shortcut function to the HMAC's object interface.
	     *
	     * @param {WordArray|string} message The message to hash.
	     * @param {WordArray|string} key The secret key.
	     *
	     * @return {WordArray} The HMAC.
	     *
	     * @static
	     *
	     * @example
	     *
	     *     var hmac = CryptoJS.HmacSHA512(message, key);
	     */
	    C.HmacSHA512 = Hasher._createHmacHelper(SHA512);
	}());


	(function () {
	    // Shortcuts
	    var C = CryptoJS;
	    var C_x64 = C.x64;
	    var X64Word = C_x64.Word;
	    var X64WordArray = C_x64.WordArray;
	    var C_algo = C.algo;
	    var SHA512 = C_algo.SHA512;

	    /**
	     * SHA-384 hash algorithm.
	     */
	    var SHA384 = C_algo.SHA384 = SHA512.extend({
	        _doReset: function () {
	            this._hash = new X64WordArray.init([
	                new X64Word.init(0xcbbb9d5d, 0xc1059ed8), new X64Word.init(0x629a292a, 0x367cd507),
	                new X64Word.init(0x9159015a, 0x3070dd17), new X64Word.init(0x152fecd8, 0xf70e5939),
	                new X64Word.init(0x67332667, 0xffc00b31), new X64Word.init(0x8eb44a87, 0x68581511),
	                new X64Word.init(0xdb0c2e0d, 0x64f98fa7), new X64Word.init(0x47b5481d, 0xbefa4fa4)
	            ]);
	        },

	        _doFinalize: function () {
	            var hash = SHA512._doFinalize.call(this);

	            hash.sigBytes -= 16;

	            return hash;
	        }
	    });

	    /**
	     * Shortcut function to the hasher's object interface.
	     *
	     * @param {WordArray|string} message The message to hash.
	     *
	     * @return {WordArray} The hash.
	     *
	     * @static
	     *
	     * @example
	     *
	     *     var hash = CryptoJS.SHA384('message');
	     *     var hash = CryptoJS.SHA384(wordArray);
	     */
	    C.SHA384 = SHA512._createHelper(SHA384);

	    /**
	     * Shortcut function to the HMAC's object interface.
	     *
	     * @param {WordArray|string} message The message to hash.
	     * @param {WordArray|string} key The secret key.
	     *
	     * @return {WordArray} The HMAC.
	     *
	     * @static
	     *
	     * @example
	     *
	     *     var hmac = CryptoJS.HmacSHA384(message, key);
	     */
	    C.HmacSHA384 = SHA512._createHmacHelper(SHA384);
	}());


	/**
	 * Cipher core components.
	 */
	CryptoJS.lib.Cipher || (function (undefined) {
	    // Shortcuts
	    var C = CryptoJS;
	    var C_lib = C.lib;
	    var Base = C_lib.Base;
	    var WordArray = C_lib.WordArray;
	    var BufferedBlockAlgorithm = C_lib.BufferedBlockAlgorithm;
	    var C_enc = C.enc;
	    var Utf8 = C_enc.Utf8;
	    var Base64 = C_enc.Base64;
	    var C_algo = C.algo;
	    var EvpKDF = C_algo.EvpKDF;

	    /**
	     * Abstract base cipher template.
	     *
	     * @property {number} keySize This cipher's key size. Default: 4 (128 bits)
	     * @property {number} ivSize This cipher's IV size. Default: 4 (128 bits)
	     * @property {number} _ENC_XFORM_MODE A constant representing encryption mode.
	     * @property {number} _DEC_XFORM_MODE A constant representing decryption mode.
	     */
	    var Cipher = C_lib.Cipher = BufferedBlockAlgorithm.extend({
	        /**
	         * Configuration options.
	         *
	         * @property {WordArray} iv The IV to use for this operation.
	         */
	        cfg: Base.extend(),

	        /**
	         * Creates this cipher in encryption mode.
	         *
	         * @param {WordArray} key The key.
	         * @param {Object} cfg (Optional) The configuration options to use for this operation.
	         *
	         * @return {Cipher} A cipher instance.
	         *
	         * @static
	         *
	         * @example
	         *
	         *     var cipher = CryptoJS.algo.AES.createEncryptor(keyWordArray, { iv: ivWordArray });
	         */
	        createEncryptor: function (key, cfg) {
	            return this.create(this._ENC_XFORM_MODE, key, cfg);
	        },

	        /**
	         * Creates this cipher in decryption mode.
	         *
	         * @param {WordArray} key The key.
	         * @param {Object} cfg (Optional) The configuration options to use for this operation.
	         *
	         * @return {Cipher} A cipher instance.
	         *
	         * @static
	         *
	         * @example
	         *
	         *     var cipher = CryptoJS.algo.AES.createDecryptor(keyWordArray, { iv: ivWordArray });
	         */
	        createDecryptor: function (key, cfg) {
	            return this.create(this._DEC_XFORM_MODE, key, cfg);
	        },

	        /**
	         * Initializes a newly created cipher.
	         *
	         * @param {number} xformMode Either the encryption or decryption transormation mode constant.
	         * @param {WordArray} key The key.
	         * @param {Object} cfg (Optional) The configuration options to use for this operation.
	         *
	         * @example
	         *
	         *     var cipher = CryptoJS.algo.AES.create(CryptoJS.algo.AES._ENC_XFORM_MODE, keyWordArray, { iv: ivWordArray });
	         */
	        init: function (xformMode, key, cfg) {
	            // Apply config defaults
	            this.cfg = this.cfg.extend(cfg);

	            // Store transform mode and key
	            this._xformMode = xformMode;
	            this._key = key;

	            // Set initial values
	            this.reset();
	        },

	        /**
	         * Resets this cipher to its initial state.
	         *
	         * @example
	         *
	         *     cipher.reset();
	         */
	        reset: function () {
	            // Reset data buffer
	            BufferedBlockAlgorithm.reset.call(this);

	            // Perform concrete-cipher logic
	            this._doReset();
	        },

	        /**
	         * Adds data to be encrypted or decrypted.
	         *
	         * @param {WordArray|string} dataUpdate The data to encrypt or decrypt.
	         *
	         * @return {WordArray} The data after processing.
	         *
	         * @example
	         *
	         *     var encrypted = cipher.process('data');
	         *     var encrypted = cipher.process(wordArray);
	         */
	        process: function (dataUpdate) {
	            // Append
	            this._append(dataUpdate);

	            // Process available blocks
	            return this._process();
	        },

	        /**
	         * Finalizes the encryption or decryption process.
	         * Note that the finalize operation is effectively a destructive, read-once operation.
	         *
	         * @param {WordArray|string} dataUpdate The final data to encrypt or decrypt.
	         *
	         * @return {WordArray} The data after final processing.
	         *
	         * @example
	         *
	         *     var encrypted = cipher.finalize();
	         *     var encrypted = cipher.finalize('data');
	         *     var encrypted = cipher.finalize(wordArray);
	         */
	        finalize: function (dataUpdate) {
	            // Final data update
	            if (dataUpdate) {
	                this._append(dataUpdate);
	            }

	            // Perform concrete-cipher logic
	            var finalProcessedData = this._doFinalize();

	            return finalProcessedData;
	        },

	        keySize: 128/32,

	        ivSize: 128/32,

	        _ENC_XFORM_MODE: 1,

	        _DEC_XFORM_MODE: 2,

	        /**
	         * Creates shortcut functions to a cipher's object interface.
	         *
	         * @param {Cipher} cipher The cipher to create a helper for.
	         *
	         * @return {Object} An object with encrypt and decrypt shortcut functions.
	         *
	         * @static
	         *
	         * @example
	         *
	         *     var AES = CryptoJS.lib.Cipher._createHelper(CryptoJS.algo.AES);
	         */
	        _createHelper: (function () {
	            function selectCipherStrategy(key) {
	                if (typeof key == 'string') {
	                    return PasswordBasedCipher;
	                } else {
	                    return SerializableCipher;
	                }
	            }

	            return function (cipher) {
	                return {
	                    encrypt: function (message, key, cfg) {
	                        return selectCipherStrategy(key).encrypt(cipher, message, key, cfg);
	                    },

	                    decrypt: function (ciphertext, key, cfg) {
	                        return selectCipherStrategy(key).decrypt(cipher, ciphertext, key, cfg);
	                    }
	                };
	            };
	        }())
	    });

	    /**
	     * Abstract base stream cipher template.
	     *
	     * @property {number} blockSize The number of 32-bit words this cipher operates on. Default: 1 (32 bits)
	     */
	    var StreamCipher = C_lib.StreamCipher = Cipher.extend({
	        _doFinalize: function () {
	            // Process partial blocks
	            var finalProcessedBlocks = this._process(!!'flush');

	            return finalProcessedBlocks;
	        },

	        blockSize: 1
	    });

	    /**
	     * Mode namespace.
	     */
	    var C_mode = C.mode = {};

	    /**
	     * Abstract base block cipher mode template.
	     */
	    var BlockCipherMode = C_lib.BlockCipherMode = Base.extend({
	        /**
	         * Creates this mode for encryption.
	         *
	         * @param {Cipher} cipher A block cipher instance.
	         * @param {Array} iv The IV words.
	         *
	         * @static
	         *
	         * @example
	         *
	         *     var mode = CryptoJS.mode.CBC.createEncryptor(cipher, iv.words);
	         */
	        createEncryptor: function (cipher, iv) {
	            return this.Encryptor.create(cipher, iv);
	        },

	        /**
	         * Creates this mode for decryption.
	         *
	         * @param {Cipher} cipher A block cipher instance.
	         * @param {Array} iv The IV words.
	         *
	         * @static
	         *
	         * @example
	         *
	         *     var mode = CryptoJS.mode.CBC.createDecryptor(cipher, iv.words);
	         */
	        createDecryptor: function (cipher, iv) {
	            return this.Decryptor.create(cipher, iv);
	        },

	        /**
	         * Initializes a newly created mode.
	         *
	         * @param {Cipher} cipher A block cipher instance.
	         * @param {Array} iv The IV words.
	         *
	         * @example
	         *
	         *     var mode = CryptoJS.mode.CBC.Encryptor.create(cipher, iv.words);
	         */
	        init: function (cipher, iv) {
	            this._cipher = cipher;
	            this._iv = iv;
	        }
	    });

	    /**
	     * Cipher Block Chaining mode.
	     */
	    var CBC = C_mode.CBC = (function () {
	        /**
	         * Abstract base CBC mode.
	         */
	        var CBC = BlockCipherMode.extend();

	        /**
	         * CBC encryptor.
	         */
	        CBC.Encryptor = CBC.extend({
	            /**
	             * Processes the data block at offset.
	             *
	             * @param {Array} words The data words to operate on.
	             * @param {number} offset The offset where the block starts.
	             *
	             * @example
	             *
	             *     mode.processBlock(data.words, offset);
	             */
	            processBlock: function (words, offset) {
	                // Shortcuts
	                var cipher = this._cipher;
	                var blockSize = cipher.blockSize;

	                // XOR and encrypt
	                xorBlock.call(this, words, offset, blockSize);
	                cipher.encryptBlock(words, offset);

	                // Remember this block to use with next block
	                this._prevBlock = words.slice(offset, offset + blockSize);
	            }
	        });

	        /**
	         * CBC decryptor.
	         */
	        CBC.Decryptor = CBC.extend({
	            /**
	             * Processes the data block at offset.
	             *
	             * @param {Array} words The data words to operate on.
	             * @param {number} offset The offset where the block starts.
	             *
	             * @example
	             *
	             *     mode.processBlock(data.words, offset);
	             */
	            processBlock: function (words, offset) {
	                // Shortcuts
	                var cipher = this._cipher;
	                var blockSize = cipher.blockSize;

	                // Remember this block to use with next block
	                var thisBlock = words.slice(offset, offset + blockSize);

	                // Decrypt and XOR
	                cipher.decryptBlock(words, offset);
	                xorBlock.call(this, words, offset, blockSize);

	                // This block becomes the previous block
	                this._prevBlock = thisBlock;
	            }
	        });

	        function xorBlock(words, offset, blockSize) {
	            // Shortcut
	            var iv = this._iv;

	            // Choose mixing block
	            if (iv) {
	                var block = iv;

	                // Remove IV for subsequent blocks
	                this._iv = undefined;
	            } else {
	                var block = this._prevBlock;
	            }

	            // XOR blocks
	            for (var i = 0; i < blockSize; i++) {
	                words[offset + i] ^= block[i];
	            }
	        }

	        return CBC;
	    }());

	    /**
	     * Padding namespace.
	     */
	    var C_pad = C.pad = {};

	    /**
	     * PKCS #5/7 padding strategy.
	     */
	    var Pkcs7 = C_pad.Pkcs7 = {
	        /**
	         * Pads data using the algorithm defined in PKCS #5/7.
	         *
	         * @param {WordArray} data The data to pad.
	         * @param {number} blockSize The multiple that the data should be padded to.
	         *
	         * @static
	         *
	         * @example
	         *
	         *     CryptoJS.pad.Pkcs7.pad(wordArray, 4);
	         */
	        pad: function (data, blockSize) {
	            // Shortcut
	            var blockSizeBytes = blockSize * 4;

	            // Count padding bytes
	            var nPaddingBytes = blockSizeBytes - data.sigBytes % blockSizeBytes;

	            // Create padding word
	            var paddingWord = (nPaddingBytes << 24) | (nPaddingBytes << 16) | (nPaddingBytes << 8) | nPaddingBytes;

	            // Create padding
	            var paddingWords = [];
	            for (var i = 0; i < nPaddingBytes; i += 4) {
	                paddingWords.push(paddingWord);
	            }
	            var padding = WordArray.create(paddingWords, nPaddingBytes);

	            // Add padding
	            data.concat(padding);
	        },

	        /**
	         * Unpads data that had been padded using the algorithm defined in PKCS #5/7.
	         *
	         * @param {WordArray} data The data to unpad.
	         *
	         * @static
	         *
	         * @example
	         *
	         *     CryptoJS.pad.Pkcs7.unpad(wordArray);
	         */
	        unpad: function (data) {
	            // Get number of padding bytes from last byte
	            var nPaddingBytes = data.words[(data.sigBytes - 1) >>> 2] & 0xff;

	            // Remove padding
	            data.sigBytes -= nPaddingBytes;
	        }
	    };

	    /**
	     * Abstract base block cipher template.
	     *
	     * @property {number} blockSize The number of 32-bit words this cipher operates on. Default: 4 (128 bits)
	     */
	    var BlockCipher = C_lib.BlockCipher = Cipher.extend({
	        /**
	         * Configuration options.
	         *
	         * @property {Mode} mode The block mode to use. Default: CBC
	         * @property {Padding} padding The padding strategy to use. Default: Pkcs7
	         */
	        cfg: Cipher.cfg.extend({
	            mode: CBC,
	            padding: Pkcs7
	        }),

	        reset: function () {
	            // Reset cipher
	            Cipher.reset.call(this);

	            // Shortcuts
	            var cfg = this.cfg;
	            var iv = cfg.iv;
	            var mode = cfg.mode;

	            // Reset block mode
	            if (this._xformMode == this._ENC_XFORM_MODE) {
	                var modeCreator = mode.createEncryptor;
	            } else /* if (this._xformMode == this._DEC_XFORM_MODE) */ {
	                var modeCreator = mode.createDecryptor;
	                // Keep at least one block in the buffer for unpadding
	                this._minBufferSize = 1;
	            }

	            if (this._mode && this._mode.__creator == modeCreator) {
	                this._mode.init(this, iv && iv.words);
	            } else {
	                this._mode = modeCreator.call(mode, this, iv && iv.words);
	                this._mode.__creator = modeCreator;
	            }
	        },

	        _doProcessBlock: function (words, offset) {
	            this._mode.processBlock(words, offset);
	        },

	        _doFinalize: function () {
	            // Shortcut
	            var padding = this.cfg.padding;

	            // Finalize
	            if (this._xformMode == this._ENC_XFORM_MODE) {
	                // Pad data
	                padding.pad(this._data, this.blockSize);

	                // Process final blocks
	                var finalProcessedBlocks = this._process(!!'flush');
	            } else /* if (this._xformMode == this._DEC_XFORM_MODE) */ {
	                // Process final blocks
	                var finalProcessedBlocks = this._process(!!'flush');

	                // Unpad data
	                padding.unpad(finalProcessedBlocks);
	            }

	            return finalProcessedBlocks;
	        },

	        blockSize: 128/32
	    });

	    /**
	     * A collection of cipher parameters.
	     *
	     * @property {WordArray} ciphertext The raw ciphertext.
	     * @property {WordArray} key The key to this ciphertext.
	     * @property {WordArray} iv The IV used in the ciphering operation.
	     * @property {WordArray} salt The salt used with a key derivation function.
	     * @property {Cipher} algorithm The cipher algorithm.
	     * @property {Mode} mode The block mode used in the ciphering operation.
	     * @property {Padding} padding The padding scheme used in the ciphering operation.
	     * @property {number} blockSize The block size of the cipher.
	     * @property {Format} formatter The default formatting strategy to convert this cipher params object to a string.
	     */
	    var CipherParams = C_lib.CipherParams = Base.extend({
	        /**
	         * Initializes a newly created cipher params object.
	         *
	         * @param {Object} cipherParams An object with any of the possible cipher parameters.
	         *
	         * @example
	         *
	         *     var cipherParams = CryptoJS.lib.CipherParams.create({
	         *         ciphertext: ciphertextWordArray,
	         *         key: keyWordArray,
	         *         iv: ivWordArray,
	         *         salt: saltWordArray,
	         *         algorithm: CryptoJS.algo.AES,
	         *         mode: CryptoJS.mode.CBC,
	         *         padding: CryptoJS.pad.PKCS7,
	         *         blockSize: 4,
	         *         formatter: CryptoJS.format.OpenSSL
	         *     });
	         */
	        init: function (cipherParams) {
	            this.mixIn(cipherParams);
	        },

	        /**
	         * Converts this cipher params object to a string.
	         *
	         * @param {Format} formatter (Optional) The formatting strategy to use.
	         *
	         * @return {string} The stringified cipher params.
	         *
	         * @throws Error If neither the formatter nor the default formatter is set.
	         *
	         * @example
	         *
	         *     var string = cipherParams + '';
	         *     var string = cipherParams.toString();
	         *     var string = cipherParams.toString(CryptoJS.format.OpenSSL);
	         */
	        toString: function (formatter) {
	            return (formatter || this.formatter).stringify(this);
	        }
	    });

	    /**
	     * Format namespace.
	     */
	    var C_format = C.format = {};

	    /**
	     * OpenSSL formatting strategy.
	     */
	    var OpenSSLFormatter = C_format.OpenSSL = {
	        /**
	         * Converts a cipher params object to an OpenSSL-compatible string.
	         *
	         * @param {CipherParams} cipherParams The cipher params object.
	         *
	         * @return {string} The OpenSSL-compatible string.
	         *
	         * @static
	         *
	         * @example
	         *
	         *     var openSSLString = CryptoJS.format.OpenSSL.stringify(cipherParams);
	         */
	        stringify: function (cipherParams) {
	            // Shortcuts
	            var ciphertext = cipherParams.ciphertext;
	            var salt = cipherParams.salt;

	            // Format
	            if (salt) {
	                var wordArray = WordArray.create([0x53616c74, 0x65645f5f]).concat(salt).concat(ciphertext);
	            } else {
	                var wordArray = ciphertext;
	            }

	            return wordArray.toString(Base64);
	        },

	        /**
	         * Converts an OpenSSL-compatible string to a cipher params object.
	         *
	         * @param {string} openSSLStr The OpenSSL-compatible string.
	         *
	         * @return {CipherParams} The cipher params object.
	         *
	         * @static
	         *
	         * @example
	         *
	         *     var cipherParams = CryptoJS.format.OpenSSL.parse(openSSLString);
	         */
	        parse: function (openSSLStr) {
	            // Parse base64
	            var ciphertext = Base64.parse(openSSLStr);

	            // Shortcut
	            var ciphertextWords = ciphertext.words;

	            // Test for salt
	            if (ciphertextWords[0] == 0x53616c74 && ciphertextWords[1] == 0x65645f5f) {
	                // Extract salt
	                var salt = WordArray.create(ciphertextWords.slice(2, 4));

	                // Remove salt from ciphertext
	                ciphertextWords.splice(0, 4);
	                ciphertext.sigBytes -= 16;
	            }

	            return CipherParams.create({ ciphertext: ciphertext, salt: salt });
	        }
	    };

	    /**
	     * A cipher wrapper that returns ciphertext as a serializable cipher params object.
	     */
	    var SerializableCipher = C_lib.SerializableCipher = Base.extend({
	        /**
	         * Configuration options.
	         *
	         * @property {Formatter} format The formatting strategy to convert cipher param objects to and from a string. Default: OpenSSL
	         */
	        cfg: Base.extend({
	            format: OpenSSLFormatter
	        }),

	        /**
	         * Encrypts a message.
	         *
	         * @param {Cipher} cipher The cipher algorithm to use.
	         * @param {WordArray|string} message The message to encrypt.
	         * @param {WordArray} key The key.
	         * @param {Object} cfg (Optional) The configuration options to use for this operation.
	         *
	         * @return {CipherParams} A cipher params object.
	         *
	         * @static
	         *
	         * @example
	         *
	         *     var ciphertextParams = CryptoJS.lib.SerializableCipher.encrypt(CryptoJS.algo.AES, message, key);
	         *     var ciphertextParams = CryptoJS.lib.SerializableCipher.encrypt(CryptoJS.algo.AES, message, key, { iv: iv });
	         *     var ciphertextParams = CryptoJS.lib.SerializableCipher.encrypt(CryptoJS.algo.AES, message, key, { iv: iv, format: CryptoJS.format.OpenSSL });
	         */
	        encrypt: function (cipher, message, key, cfg) {
	            // Apply config defaults
	            cfg = this.cfg.extend(cfg);

	            // Encrypt
	            var encryptor = cipher.createEncryptor(key, cfg);
	            var ciphertext = encryptor.finalize(message);

	            // Shortcut
	            var cipherCfg = encryptor.cfg;

	            // Create and return serializable cipher params
	            return CipherParams.create({
	                ciphertext: ciphertext,
	                key: key,
	                iv: cipherCfg.iv,
	                algorithm: cipher,
	                mode: cipherCfg.mode,
	                padding: cipherCfg.padding,
	                blockSize: cipher.blockSize,
	                formatter: cfg.format
	            });
	        },

	        /**
	         * Decrypts serialized ciphertext.
	         *
	         * @param {Cipher} cipher The cipher algorithm to use.
	         * @param {CipherParams|string} ciphertext The ciphertext to decrypt.
	         * @param {WordArray} key The key.
	         * @param {Object} cfg (Optional) The configuration options to use for this operation.
	         *
	         * @return {WordArray} The plaintext.
	         *
	         * @static
	         *
	         * @example
	         *
	         *     var plaintext = CryptoJS.lib.SerializableCipher.decrypt(CryptoJS.algo.AES, formattedCiphertext, key, { iv: iv, format: CryptoJS.format.OpenSSL });
	         *     var plaintext = CryptoJS.lib.SerializableCipher.decrypt(CryptoJS.algo.AES, ciphertextParams, key, { iv: iv, format: CryptoJS.format.OpenSSL });
	         */
	        decrypt: function (cipher, ciphertext, key, cfg) {
	            // Apply config defaults
	            cfg = this.cfg.extend(cfg);

	            // Convert string to CipherParams
	            ciphertext = this._parse(ciphertext, cfg.format);

	            // Decrypt
	            var plaintext = cipher.createDecryptor(key, cfg).finalize(ciphertext.ciphertext);

	            return plaintext;
	        },

	        /**
	         * Converts serialized ciphertext to CipherParams,
	         * else assumed CipherParams already and returns ciphertext unchanged.
	         *
	         * @param {CipherParams|string} ciphertext The ciphertext.
	         * @param {Formatter} format The formatting strategy to use to parse serialized ciphertext.
	         *
	         * @return {CipherParams} The unserialized ciphertext.
	         *
	         * @static
	         *
	         * @example
	         *
	         *     var ciphertextParams = CryptoJS.lib.SerializableCipher._parse(ciphertextStringOrParams, format);
	         */
	        _parse: function (ciphertext, format) {
	            if (typeof ciphertext == 'string') {
	                return format.parse(ciphertext, this);
	            } else {
	                return ciphertext;
	            }
	        }
	    });

	    /**
	     * Key derivation function namespace.
	     */
	    var C_kdf = C.kdf = {};

	    /**
	     * OpenSSL key derivation function.
	     */
	    var OpenSSLKdf = C_kdf.OpenSSL = {
	        /**
	         * Derives a key and IV from a password.
	         *
	         * @param {string} password The password to derive from.
	         * @param {number} keySize The size in words of the key to generate.
	         * @param {number} ivSize The size in words of the IV to generate.
	         * @param {WordArray|string} salt (Optional) A 64-bit salt to use. If omitted, a salt will be generated randomly.
	         *
	         * @return {CipherParams} A cipher params object with the key, IV, and salt.
	         *
	         * @static
	         *
	         * @example
	         *
	         *     var derivedParams = CryptoJS.kdf.OpenSSL.execute('Password', 256/32, 128/32);
	         *     var derivedParams = CryptoJS.kdf.OpenSSL.execute('Password', 256/32, 128/32, 'saltsalt');
	         */
	        execute: function (password, keySize, ivSize, salt) {
	            // Generate random salt
	            if (!salt) {
	                salt = WordArray.random(64/8);
	            }

	            // Derive key and IV
	            var key = EvpKDF.create({ keySize: keySize + ivSize }).compute(password, salt);

	            // Separate key and IV
	            var iv = WordArray.create(key.words.slice(keySize), ivSize * 4);
	            key.sigBytes = keySize * 4;

	            // Return params
	            return CipherParams.create({ key: key, iv: iv, salt: salt });
	        }
	    };

	    /**
	     * A serializable cipher wrapper that derives the key from a password,
	     * and returns ciphertext as a serializable cipher params object.
	     */
	    var PasswordBasedCipher = C_lib.PasswordBasedCipher = SerializableCipher.extend({
	        /**
	         * Configuration options.
	         *
	         * @property {KDF} kdf The key derivation function to use to generate a key and IV from a password. Default: OpenSSL
	         */
	        cfg: SerializableCipher.cfg.extend({
	            kdf: OpenSSLKdf
	        }),

	        /**
	         * Encrypts a message using a password.
	         *
	         * @param {Cipher} cipher The cipher algorithm to use.
	         * @param {WordArray|string} message The message to encrypt.
	         * @param {string} password The password.
	         * @param {Object} cfg (Optional) The configuration options to use for this operation.
	         *
	         * @return {CipherParams} A cipher params object.
	         *
	         * @static
	         *
	         * @example
	         *
	         *     var ciphertextParams = CryptoJS.lib.PasswordBasedCipher.encrypt(CryptoJS.algo.AES, message, 'password');
	         *     var ciphertextParams = CryptoJS.lib.PasswordBasedCipher.encrypt(CryptoJS.algo.AES, message, 'password', { format: CryptoJS.format.OpenSSL });
	         */
	        encrypt: function (cipher, message, password, cfg) {
	            // Apply config defaults
	            cfg = this.cfg.extend(cfg);

	            // Derive key and other params
	            var derivedParams = cfg.kdf.execute(password, cipher.keySize, cipher.ivSize);

	            // Add IV to config
	            cfg.iv = derivedParams.iv;

	            // Encrypt
	            var ciphertext = SerializableCipher.encrypt.call(this, cipher, message, derivedParams.key, cfg);

	            // Mix in derived params
	            ciphertext.mixIn(derivedParams);

	            return ciphertext;
	        },

	        /**
	         * Decrypts serialized ciphertext using a password.
	         *
	         * @param {Cipher} cipher The cipher algorithm to use.
	         * @param {CipherParams|string} ciphertext The ciphertext to decrypt.
	         * @param {string} password The password.
	         * @param {Object} cfg (Optional) The configuration options to use for this operation.
	         *
	         * @return {WordArray} The plaintext.
	         *
	         * @static
	         *
	         * @example
	         *
	         *     var plaintext = CryptoJS.lib.PasswordBasedCipher.decrypt(CryptoJS.algo.AES, formattedCiphertext, 'password', { format: CryptoJS.format.OpenSSL });
	         *     var plaintext = CryptoJS.lib.PasswordBasedCipher.decrypt(CryptoJS.algo.AES, ciphertextParams, 'password', { format: CryptoJS.format.OpenSSL });
	         */
	        decrypt: function (cipher, ciphertext, password, cfg) {
	            // Apply config defaults
	            cfg = this.cfg.extend(cfg);

	            // Convert string to CipherParams
	            ciphertext = this._parse(ciphertext, cfg.format);

	            // Derive key and other params
	            var derivedParams = cfg.kdf.execute(password, cipher.keySize, cipher.ivSize, ciphertext.salt);

	            // Add IV to config
	            cfg.iv = derivedParams.iv;

	            // Decrypt
	            var plaintext = SerializableCipher.decrypt.call(this, cipher, ciphertext, derivedParams.key, cfg);

	            return plaintext;
	        }
	    });
	}());


	/**
	 * Cipher Feedback block mode.
	 */
	CryptoJS.mode.CFB = (function () {
	    var CFB = CryptoJS.lib.BlockCipherMode.extend();

	    CFB.Encryptor = CFB.extend({
	        processBlock: function (words, offset) {
	            // Shortcuts
	            var cipher = this._cipher;
	            var blockSize = cipher.blockSize;

	            generateKeystreamAndEncrypt.call(this, words, offset, blockSize, cipher);

	            // Remember this block to use with next block
	            this._prevBlock = words.slice(offset, offset + blockSize);
	        }
	    });

	    CFB.Decryptor = CFB.extend({
	        processBlock: function (words, offset) {
	            // Shortcuts
	            var cipher = this._cipher;
	            var blockSize = cipher.blockSize;

	            // Remember this block to use with next block
	            var thisBlock = words.slice(offset, offset + blockSize);

	            generateKeystreamAndEncrypt.call(this, words, offset, blockSize, cipher);

	            // This block becomes the previous block
	            this._prevBlock = thisBlock;
	        }
	    });

	    function generateKeystreamAndEncrypt(words, offset, blockSize, cipher) {
	        // Shortcut
	        var iv = this._iv;

	        // Generate keystream
	        if (iv) {
	            var keystream = iv.slice(0);

	            // Remove IV for subsequent blocks
	            this._iv = undefined;
	        } else {
	            var keystream = this._prevBlock;
	        }
	        cipher.encryptBlock(keystream, 0);

	        // Encrypt
	        for (var i = 0; i < blockSize; i++) {
	            words[offset + i] ^= keystream[i];
	        }
	    }

	    return CFB;
	}());


	/**
	 * Electronic Codebook block mode.
	 */
	CryptoJS.mode.ECB = (function () {
	    var ECB = CryptoJS.lib.BlockCipherMode.extend();

	    ECB.Encryptor = ECB.extend({
	        processBlock: function (words, offset) {
	            this._cipher.encryptBlock(words, offset);
	        }
	    });

	    ECB.Decryptor = ECB.extend({
	        processBlock: function (words, offset) {
	            this._cipher.decryptBlock(words, offset);
	        }
	    });

	    return ECB;
	}());


	/**
	 * ANSI X.923 padding strategy.
	 */
	CryptoJS.pad.AnsiX923 = {
	    pad: function (data, blockSize) {
	        // Shortcuts
	        var dataSigBytes = data.sigBytes;
	        var blockSizeBytes = blockSize * 4;

	        // Count padding bytes
	        var nPaddingBytes = blockSizeBytes - dataSigBytes % blockSizeBytes;

	        // Compute last byte position
	        var lastBytePos = dataSigBytes + nPaddingBytes - 1;

	        // Pad
	        data.clamp();
	        data.words[lastBytePos >>> 2] |= nPaddingBytes << (24 - (lastBytePos % 4) * 8);
	        data.sigBytes += nPaddingBytes;
	    },

	    unpad: function (data) {
	        // Get number of padding bytes from last byte
	        var nPaddingBytes = data.words[(data.sigBytes - 1) >>> 2] & 0xff;

	        // Remove padding
	        data.sigBytes -= nPaddingBytes;
	    }
	};


	/**
	 * ISO 10126 padding strategy.
	 */
	CryptoJS.pad.Iso10126 = {
	    pad: function (data, blockSize) {
	        // Shortcut
	        var blockSizeBytes = blockSize * 4;

	        // Count padding bytes
	        var nPaddingBytes = blockSizeBytes - data.sigBytes % blockSizeBytes;

	        // Pad
	        data.concat(CryptoJS.lib.WordArray.random(nPaddingBytes - 1)).
	             concat(CryptoJS.lib.WordArray.create([nPaddingBytes << 24], 1));
	    },

	    unpad: function (data) {
	        // Get number of padding bytes from last byte
	        var nPaddingBytes = data.words[(data.sigBytes - 1) >>> 2] & 0xff;

	        // Remove padding
	        data.sigBytes -= nPaddingBytes;
	    }
	};


	/**
	 * ISO/IEC 9797-1 Padding Method 2.
	 */
	CryptoJS.pad.Iso97971 = {
	    pad: function (data, blockSize) {
	        // Add 0x80 byte
	        data.concat(CryptoJS.lib.WordArray.create([0x80000000], 1));

	        // Zero pad the rest
	        CryptoJS.pad.ZeroPadding.pad(data, blockSize);
	    },

	    unpad: function (data) {
	        // Remove zero padding
	        CryptoJS.pad.ZeroPadding.unpad(data);

	        // Remove one more byte -- the 0x80 byte
	        data.sigBytes--;
	    }
	};


	/**
	 * Output Feedback block mode.
	 */
	CryptoJS.mode.OFB = (function () {
	    var OFB = CryptoJS.lib.BlockCipherMode.extend();

	    var Encryptor = OFB.Encryptor = OFB.extend({
	        processBlock: function (words, offset) {
	            // Shortcuts
	            var cipher = this._cipher
	            var blockSize = cipher.blockSize;
	            var iv = this._iv;
	            var keystream = this._keystream;

	            // Generate keystream
	            if (iv) {
	                keystream = this._keystream = iv.slice(0);

	                // Remove IV for subsequent blocks
	                this._iv = undefined;
	            }
	            cipher.encryptBlock(keystream, 0);

	            // Encrypt
	            for (var i = 0; i < blockSize; i++) {
	                words[offset + i] ^= keystream[i];
	            }
	        }
	    });

	    OFB.Decryptor = Encryptor;

	    return OFB;
	}());


	/**
	 * A noop padding strategy.
	 */
	CryptoJS.pad.NoPadding = {
	    pad: function () {
	    },

	    unpad: function () {
	    }
	};


	(function (undefined) {
	    // Shortcuts
	    var C = CryptoJS;
	    var C_lib = C.lib;
	    var CipherParams = C_lib.CipherParams;
	    var C_enc = C.enc;
	    var Hex = C_enc.Hex;
	    var C_format = C.format;

	    var HexFormatter = C_format.Hex = {
	        /**
	         * Converts the ciphertext of a cipher params object to a hexadecimally encoded string.
	         *
	         * @param {CipherParams} cipherParams The cipher params object.
	         *
	         * @return {string} The hexadecimally encoded string.
	         *
	         * @static
	         *
	         * @example
	         *
	         *     var hexString = CryptoJS.format.Hex.stringify(cipherParams);
	         */
	        stringify: function (cipherParams) {
	            return cipherParams.ciphertext.toString(Hex);
	        },

	        /**
	         * Converts a hexadecimally encoded ciphertext string to a cipher params object.
	         *
	         * @param {string} input The hexadecimally encoded string.
	         *
	         * @return {CipherParams} The cipher params object.
	         *
	         * @static
	         *
	         * @example
	         *
	         *     var cipherParams = CryptoJS.format.Hex.parse(hexString);
	         */
	        parse: function (input) {
	            var ciphertext = Hex.parse(input);
	            return CipherParams.create({ ciphertext: ciphertext });
	        }
	    };
	}());


	(function () {
	    // Shortcuts
	    var C = CryptoJS;
	    var C_lib = C.lib;
	    var BlockCipher = C_lib.BlockCipher;
	    var C_algo = C.algo;

	    // Lookup tables
	    var SBOX = [];
	    var INV_SBOX = [];
	    var SUB_MIX_0 = [];
	    var SUB_MIX_1 = [];
	    var SUB_MIX_2 = [];
	    var SUB_MIX_3 = [];
	    var INV_SUB_MIX_0 = [];
	    var INV_SUB_MIX_1 = [];
	    var INV_SUB_MIX_2 = [];
	    var INV_SUB_MIX_3 = [];

	    // Compute lookup tables
	    (function () {
	        // Compute double table
	        var d = [];
	        for (var i = 0; i < 256; i++) {
	            if (i < 128) {
	                d[i] = i << 1;
	            } else {
	                d[i] = (i << 1) ^ 0x11b;
	            }
	        }

	        // Walk GF(2^8)
	        var x = 0;
	        var xi = 0;
	        for (var i = 0; i < 256; i++) {
	            // Compute sbox
	            var sx = xi ^ (xi << 1) ^ (xi << 2) ^ (xi << 3) ^ (xi << 4);
	            sx = (sx >>> 8) ^ (sx & 0xff) ^ 0x63;
	            SBOX[x] = sx;
	            INV_SBOX[sx] = x;

	            // Compute multiplication
	            var x2 = d[x];
	            var x4 = d[x2];
	            var x8 = d[x4];

	            // Compute sub bytes, mix columns tables
	            var t = (d[sx] * 0x101) ^ (sx * 0x1010100);
	            SUB_MIX_0[x] = (t << 24) | (t >>> 8);
	            SUB_MIX_1[x] = (t << 16) | (t >>> 16);
	            SUB_MIX_2[x] = (t << 8)  | (t >>> 24);
	            SUB_MIX_3[x] = t;

	            // Compute inv sub bytes, inv mix columns tables
	            var t = (x8 * 0x1010101) ^ (x4 * 0x10001) ^ (x2 * 0x101) ^ (x * 0x1010100);
	            INV_SUB_MIX_0[sx] = (t << 24) | (t >>> 8);
	            INV_SUB_MIX_1[sx] = (t << 16) | (t >>> 16);
	            INV_SUB_MIX_2[sx] = (t << 8)  | (t >>> 24);
	            INV_SUB_MIX_3[sx] = t;

	            // Compute next counter
	            if (!x) {
	                x = xi = 1;
	            } else {
	                x = x2 ^ d[d[d[x8 ^ x2]]];
	                xi ^= d[d[xi]];
	            }
	        }
	    }());

	    // Precomputed Rcon lookup
	    var RCON = [0x00, 0x01, 0x02, 0x04, 0x08, 0x10, 0x20, 0x40, 0x80, 0x1b, 0x36];

	    /**
	     * AES block cipher algorithm.
	     */
	    var AES = C_algo.AES = BlockCipher.extend({
	        _doReset: function () {
	            // Skip reset of nRounds has been set before and key did not change
	            if (this._nRounds && this._keyPriorReset === this._key) {
	                return;
	            }

	            // Shortcuts
	            var key = this._keyPriorReset = this._key;
	            var keyWords = key.words;
	            var keySize = key.sigBytes / 4;

	            // Compute number of rounds
	            var nRounds = this._nRounds = keySize + 6;

	            // Compute number of key schedule rows
	            var ksRows = (nRounds + 1) * 4;

	            // Compute key schedule
	            var keySchedule = this._keySchedule = [];
	            for (var ksRow = 0; ksRow < ksRows; ksRow++) {
	                if (ksRow < keySize) {
	                    keySchedule[ksRow] = keyWords[ksRow];
	                } else {
	                    var t = keySchedule[ksRow - 1];

	                    if (!(ksRow % keySize)) {
	                        // Rot word
	                        t = (t << 8) | (t >>> 24);

	                        // Sub word
	                        t = (SBOX[t >>> 24] << 24) | (SBOX[(t >>> 16) & 0xff] << 16) | (SBOX[(t >>> 8) & 0xff] << 8) | SBOX[t & 0xff];

	                        // Mix Rcon
	                        t ^= RCON[(ksRow / keySize) | 0] << 24;
	                    } else if (keySize > 6 && ksRow % keySize == 4) {
	                        // Sub word
	                        t = (SBOX[t >>> 24] << 24) | (SBOX[(t >>> 16) & 0xff] << 16) | (SBOX[(t >>> 8) & 0xff] << 8) | SBOX[t & 0xff];
	                    }

	                    keySchedule[ksRow] = keySchedule[ksRow - keySize] ^ t;
	                }
	            }

	            // Compute inv key schedule
	            var invKeySchedule = this._invKeySchedule = [];
	            for (var invKsRow = 0; invKsRow < ksRows; invKsRow++) {
	                var ksRow = ksRows - invKsRow;

	                if (invKsRow % 4) {
	                    var t = keySchedule[ksRow];
	                } else {
	                    var t = keySchedule[ksRow - 4];
	                }

	                if (invKsRow < 4 || ksRow <= 4) {
	                    invKeySchedule[invKsRow] = t;
	                } else {
	                    invKeySchedule[invKsRow] = INV_SUB_MIX_0[SBOX[t >>> 24]] ^ INV_SUB_MIX_1[SBOX[(t >>> 16) & 0xff]] ^
	                                               INV_SUB_MIX_2[SBOX[(t >>> 8) & 0xff]] ^ INV_SUB_MIX_3[SBOX[t & 0xff]];
	                }
	            }
	        },

	        encryptBlock: function (M, offset) {
	            this._doCryptBlock(M, offset, this._keySchedule, SUB_MIX_0, SUB_MIX_1, SUB_MIX_2, SUB_MIX_3, SBOX);
	        },

	        decryptBlock: function (M, offset) {
	            // Swap 2nd and 4th rows
	            var t = M[offset + 1];
	            M[offset + 1] = M[offset + 3];
	            M[offset + 3] = t;

	            this._doCryptBlock(M, offset, this._invKeySchedule, INV_SUB_MIX_0, INV_SUB_MIX_1, INV_SUB_MIX_2, INV_SUB_MIX_3, INV_SBOX);

	            // Inv swap 2nd and 4th rows
	            var t = M[offset + 1];
	            M[offset + 1] = M[offset + 3];
	            M[offset + 3] = t;
	        },

	        _doCryptBlock: function (M, offset, keySchedule, SUB_MIX_0, SUB_MIX_1, SUB_MIX_2, SUB_MIX_3, SBOX) {
	            // Shortcut
	            var nRounds = this._nRounds;

	            // Get input, add round key
	            var s0 = M[offset]     ^ keySchedule[0];
	            var s1 = M[offset + 1] ^ keySchedule[1];
	            var s2 = M[offset + 2] ^ keySchedule[2];
	            var s3 = M[offset + 3] ^ keySchedule[3];

	            // Key schedule row counter
	            var ksRow = 4;

	            // Rounds
	            for (var round = 1; round < nRounds; round++) {
	                // Shift rows, sub bytes, mix columns, add round key
	                var t0 = SUB_MIX_0[s0 >>> 24] ^ SUB_MIX_1[(s1 >>> 16) & 0xff] ^ SUB_MIX_2[(s2 >>> 8) & 0xff] ^ SUB_MIX_3[s3 & 0xff] ^ keySchedule[ksRow++];
	                var t1 = SUB_MIX_0[s1 >>> 24] ^ SUB_MIX_1[(s2 >>> 16) & 0xff] ^ SUB_MIX_2[(s3 >>> 8) & 0xff] ^ SUB_MIX_3[s0 & 0xff] ^ keySchedule[ksRow++];
	                var t2 = SUB_MIX_0[s2 >>> 24] ^ SUB_MIX_1[(s3 >>> 16) & 0xff] ^ SUB_MIX_2[(s0 >>> 8) & 0xff] ^ SUB_MIX_3[s1 & 0xff] ^ keySchedule[ksRow++];
	                var t3 = SUB_MIX_0[s3 >>> 24] ^ SUB_MIX_1[(s0 >>> 16) & 0xff] ^ SUB_MIX_2[(s1 >>> 8) & 0xff] ^ SUB_MIX_3[s2 & 0xff] ^ keySchedule[ksRow++];

	                // Update state
	                s0 = t0;
	                s1 = t1;
	                s2 = t2;
	                s3 = t3;
	            }

	            // Shift rows, sub bytes, add round key
	            var t0 = ((SBOX[s0 >>> 24] << 24) | (SBOX[(s1 >>> 16) & 0xff] << 16) | (SBOX[(s2 >>> 8) & 0xff] << 8) | SBOX[s3 & 0xff]) ^ keySchedule[ksRow++];
	            var t1 = ((SBOX[s1 >>> 24] << 24) | (SBOX[(s2 >>> 16) & 0xff] << 16) | (SBOX[(s3 >>> 8) & 0xff] << 8) | SBOX[s0 & 0xff]) ^ keySchedule[ksRow++];
	            var t2 = ((SBOX[s2 >>> 24] << 24) | (SBOX[(s3 >>> 16) & 0xff] << 16) | (SBOX[(s0 >>> 8) & 0xff] << 8) | SBOX[s1 & 0xff]) ^ keySchedule[ksRow++];
	            var t3 = ((SBOX[s3 >>> 24] << 24) | (SBOX[(s0 >>> 16) & 0xff] << 16) | (SBOX[(s1 >>> 8) & 0xff] << 8) | SBOX[s2 & 0xff]) ^ keySchedule[ksRow++];

	            // Set output
	            M[offset]     = t0;
	            M[offset + 1] = t1;
	            M[offset + 2] = t2;
	            M[offset + 3] = t3;
	        },

	        keySize: 256/32
	    });

	    /**
	     * Shortcut functions to the cipher's object interface.
	     *
	     * @example
	     *
	     *     var ciphertext = CryptoJS.AES.encrypt(message, key, cfg);
	     *     var plaintext  = CryptoJS.AES.decrypt(ciphertext, key, cfg);
	     */
	    C.AES = BlockCipher._createHelper(AES);
	}());


	(function () {
	    // Shortcuts
	    var C = CryptoJS;
	    var C_lib = C.lib;
	    var WordArray = C_lib.WordArray;
	    var BlockCipher = C_lib.BlockCipher;
	    var C_algo = C.algo;

	    // Permuted Choice 1 constants
	    var PC1 = [
	        57, 49, 41, 33, 25, 17, 9,  1,
	        58, 50, 42, 34, 26, 18, 10, 2,
	        59, 51, 43, 35, 27, 19, 11, 3,
	        60, 52, 44, 36, 63, 55, 47, 39,
	        31, 23, 15, 7,  62, 54, 46, 38,
	        30, 22, 14, 6,  61, 53, 45, 37,
	        29, 21, 13, 5,  28, 20, 12, 4
	    ];

	    // Permuted Choice 2 constants
	    var PC2 = [
	        14, 17, 11, 24, 1,  5,
	        3,  28, 15, 6,  21, 10,
	        23, 19, 12, 4,  26, 8,
	        16, 7,  27, 20, 13, 2,
	        41, 52, 31, 37, 47, 55,
	        30, 40, 51, 45, 33, 48,
	        44, 49, 39, 56, 34, 53,
	        46, 42, 50, 36, 29, 32
	    ];

	    // Cumulative bit shift constants
	    var BIT_SHIFTS = [1,  2,  4,  6,  8,  10, 12, 14, 15, 17, 19, 21, 23, 25, 27, 28];

	    // SBOXes and round permutation constants
	    var SBOX_P = [
	        {
	            0x0: 0x808200,
	            0x10000000: 0x8000,
	            0x20000000: 0x808002,
	            0x30000000: 0x2,
	            0x40000000: 0x200,
	            0x50000000: 0x808202,
	            0x60000000: 0x800202,
	            0x70000000: 0x800000,
	            0x80000000: 0x202,
	            0x90000000: 0x800200,
	            0xa0000000: 0x8200,
	            0xb0000000: 0x808000,
	            0xc0000000: 0x8002,
	            0xd0000000: 0x800002,
	            0xe0000000: 0x0,
	            0xf0000000: 0x8202,
	            0x8000000: 0x0,
	            0x18000000: 0x808202,
	            0x28000000: 0x8202,
	            0x38000000: 0x8000,
	            0x48000000: 0x808200,
	            0x58000000: 0x200,
	            0x68000000: 0x808002,
	            0x78000000: 0x2,
	            0x88000000: 0x800200,
	            0x98000000: 0x8200,
	            0xa8000000: 0x808000,
	            0xb8000000: 0x800202,
	            0xc8000000: 0x800002,
	            0xd8000000: 0x8002,
	            0xe8000000: 0x202,
	            0xf8000000: 0x800000,
	            0x1: 0x8000,
	            0x10000001: 0x2,
	            0x20000001: 0x808200,
	            0x30000001: 0x800000,
	            0x40000001: 0x808002,
	            0x50000001: 0x8200,
	            0x60000001: 0x200,
	            0x70000001: 0x800202,
	            0x80000001: 0x808202,
	            0x90000001: 0x808000,
	            0xa0000001: 0x800002,
	            0xb0000001: 0x8202,
	            0xc0000001: 0x202,
	            0xd0000001: 0x800200,
	            0xe0000001: 0x8002,
	            0xf0000001: 0x0,
	            0x8000001: 0x808202,
	            0x18000001: 0x808000,
	            0x28000001: 0x800000,
	            0x38000001: 0x200,
	            0x48000001: 0x8000,
	            0x58000001: 0x800002,
	            0x68000001: 0x2,
	            0x78000001: 0x8202,
	            0x88000001: 0x8002,
	            0x98000001: 0x800202,
	            0xa8000001: 0x202,
	            0xb8000001: 0x808200,
	            0xc8000001: 0x800200,
	            0xd8000001: 0x0,
	            0xe8000001: 0x8200,
	            0xf8000001: 0x808002
	        },
	        {
	            0x0: 0x40084010,
	            0x1000000: 0x4000,
	            0x2000000: 0x80000,
	            0x3000000: 0x40080010,
	            0x4000000: 0x40000010,
	            0x5000000: 0x40084000,
	            0x6000000: 0x40004000,
	            0x7000000: 0x10,
	            0x8000000: 0x84000,
	            0x9000000: 0x40004010,
	            0xa000000: 0x40000000,
	            0xb000000: 0x84010,
	            0xc000000: 0x80010,
	            0xd000000: 0x0,
	            0xe000000: 0x4010,
	            0xf000000: 0x40080000,
	            0x800000: 0x40004000,
	            0x1800000: 0x84010,
	            0x2800000: 0x10,
	            0x3800000: 0x40004010,
	            0x4800000: 0x40084010,
	            0x5800000: 0x40000000,
	            0x6800000: 0x80000,
	            0x7800000: 0x40080010,
	            0x8800000: 0x80010,
	            0x9800000: 0x0,
	            0xa800000: 0x4000,
	            0xb800000: 0x40080000,
	            0xc800000: 0x40000010,
	            0xd800000: 0x84000,
	            0xe800000: 0x40084000,
	            0xf800000: 0x4010,
	            0x10000000: 0x0,
	            0x11000000: 0x40080010,
	            0x12000000: 0x40004010,
	            0x13000000: 0x40084000,
	            0x14000000: 0x40080000,
	            0x15000000: 0x10,
	            0x16000000: 0x84010,
	            0x17000000: 0x4000,
	            0x18000000: 0x4010,
	            0x19000000: 0x80000,
	            0x1a000000: 0x80010,
	            0x1b000000: 0x40000010,
	            0x1c000000: 0x84000,
	            0x1d000000: 0x40004000,
	            0x1e000000: 0x40000000,
	            0x1f000000: 0x40084010,
	            0x10800000: 0x84010,
	            0x11800000: 0x80000,
	            0x12800000: 0x40080000,
	            0x13800000: 0x4000,
	            0x14800000: 0x40004000,
	            0x15800000: 0x40084010,
	            0x16800000: 0x10,
	            0x17800000: 0x40000000,
	            0x18800000: 0x40084000,
	            0x19800000: 0x40000010,
	            0x1a800000: 0x40004010,
	            0x1b800000: 0x80010,
	            0x1c800000: 0x0,
	            0x1d800000: 0x4010,
	            0x1e800000: 0x40080010,
	            0x1f800000: 0x84000
	        },
	        {
	            0x0: 0x104,
	            0x100000: 0x0,
	            0x200000: 0x4000100,
	            0x300000: 0x10104,
	            0x400000: 0x10004,
	            0x500000: 0x4000004,
	            0x600000: 0x4010104,
	            0x700000: 0x4010000,
	            0x800000: 0x4000000,
	            0x900000: 0x4010100,
	            0xa00000: 0x10100,
	            0xb00000: 0x4010004,
	            0xc00000: 0x4000104,
	            0xd00000: 0x10000,
	            0xe00000: 0x4,
	            0xf00000: 0x100,
	            0x80000: 0x4010100,
	            0x180000: 0x4010004,
	            0x280000: 0x0,
	            0x380000: 0x4000100,
	            0x480000: 0x4000004,
	            0x580000: 0x10000,
	            0x680000: 0x10004,
	            0x780000: 0x104,
	            0x880000: 0x4,
	            0x980000: 0x100,
	            0xa80000: 0x4010000,
	            0xb80000: 0x10104,
	            0xc80000: 0x10100,
	            0xd80000: 0x4000104,
	            0xe80000: 0x4010104,
	            0xf80000: 0x4000000,
	            0x1000000: 0x4010100,
	            0x1100000: 0x10004,
	            0x1200000: 0x10000,
	            0x1300000: 0x4000100,
	            0x1400000: 0x100,
	            0x1500000: 0x4010104,
	            0x1600000: 0x4000004,
	            0x1700000: 0x0,
	            0x1800000: 0x4000104,
	            0x1900000: 0x4000000,
	            0x1a00000: 0x4,
	            0x1b00000: 0x10100,
	            0x1c00000: 0x4010000,
	            0x1d00000: 0x104,
	            0x1e00000: 0x10104,
	            0x1f00000: 0x4010004,
	            0x1080000: 0x4000000,
	            0x1180000: 0x104,
	            0x1280000: 0x4010100,
	            0x1380000: 0x0,
	            0x1480000: 0x10004,
	            0x1580000: 0x4000100,
	            0x1680000: 0x100,
	            0x1780000: 0x4010004,
	            0x1880000: 0x10000,
	            0x1980000: 0x4010104,
	            0x1a80000: 0x10104,
	            0x1b80000: 0x4000004,
	            0x1c80000: 0x4000104,
	            0x1d80000: 0x4010000,
	            0x1e80000: 0x4,
	            0x1f80000: 0x10100
	        },
	        {
	            0x0: 0x80401000,
	            0x10000: 0x80001040,
	            0x20000: 0x401040,
	            0x30000: 0x80400000,
	            0x40000: 0x0,
	            0x50000: 0x401000,
	            0x60000: 0x80000040,
	            0x70000: 0x400040,
	            0x80000: 0x80000000,
	            0x90000: 0x400000,
	            0xa0000: 0x40,
	            0xb0000: 0x80001000,
	            0xc0000: 0x80400040,
	            0xd0000: 0x1040,
	            0xe0000: 0x1000,
	            0xf0000: 0x80401040,
	            0x8000: 0x80001040,
	            0x18000: 0x40,
	            0x28000: 0x80400040,
	            0x38000: 0x80001000,
	            0x48000: 0x401000,
	            0x58000: 0x80401040,
	            0x68000: 0x0,
	            0x78000: 0x80400000,
	            0x88000: 0x1000,
	            0x98000: 0x80401000,
	            0xa8000: 0x400000,
	            0xb8000: 0x1040,
	            0xc8000: 0x80000000,
	            0xd8000: 0x400040,
	            0xe8000: 0x401040,
	            0xf8000: 0x80000040,
	            0x100000: 0x400040,
	            0x110000: 0x401000,
	            0x120000: 0x80000040,
	            0x130000: 0x0,
	            0x140000: 0x1040,
	            0x150000: 0x80400040,
	            0x160000: 0x80401000,
	            0x170000: 0x80001040,
	            0x180000: 0x80401040,
	            0x190000: 0x80000000,
	            0x1a0000: 0x80400000,
	            0x1b0000: 0x401040,
	            0x1c0000: 0x80001000,
	            0x1d0000: 0x400000,
	            0x1e0000: 0x40,
	            0x1f0000: 0x1000,
	            0x108000: 0x80400000,
	            0x118000: 0x80401040,
	            0x128000: 0x0,
	            0x138000: 0x401000,
	            0x148000: 0x400040,
	            0x158000: 0x80000000,
	            0x168000: 0x80001040,
	            0x178000: 0x40,
	            0x188000: 0x80000040,
	            0x198000: 0x1000,
	            0x1a8000: 0x80001000,
	            0x1b8000: 0x80400040,
	            0x1c8000: 0x1040,
	            0x1d8000: 0x80401000,
	            0x1e8000: 0x400000,
	            0x1f8000: 0x401040
	        },
	        {
	            0x0: 0x80,
	            0x1000: 0x1040000,
	            0x2000: 0x40000,
	            0x3000: 0x20000000,
	            0x4000: 0x20040080,
	            0x5000: 0x1000080,
	            0x6000: 0x21000080,
	            0x7000: 0x40080,
	            0x8000: 0x1000000,
	            0x9000: 0x20040000,
	            0xa000: 0x20000080,
	            0xb000: 0x21040080,
	            0xc000: 0x21040000,
	            0xd000: 0x0,
	            0xe000: 0x1040080,
	            0xf000: 0x21000000,
	            0x800: 0x1040080,
	            0x1800: 0x21000080,
	            0x2800: 0x80,
	            0x3800: 0x1040000,
	            0x4800: 0x40000,
	            0x5800: 0x20040080,
	            0x6800: 0x21040000,
	            0x7800: 0x20000000,
	            0x8800: 0x20040000,
	            0x9800: 0x0,
	            0xa800: 0x21040080,
	            0xb800: 0x1000080,
	            0xc800: 0x20000080,
	            0xd800: 0x21000000,
	            0xe800: 0x1000000,
	            0xf800: 0x40080,
	            0x10000: 0x40000,
	            0x11000: 0x80,
	            0x12000: 0x20000000,
	            0x13000: 0x21000080,
	            0x14000: 0x1000080,
	            0x15000: 0x21040000,
	            0x16000: 0x20040080,
	            0x17000: 0x1000000,
	            0x18000: 0x21040080,
	            0x19000: 0x21000000,
	            0x1a000: 0x1040000,
	            0x1b000: 0x20040000,
	            0x1c000: 0x40080,
	            0x1d000: 0x20000080,
	            0x1e000: 0x0,
	            0x1f000: 0x1040080,
	            0x10800: 0x21000080,
	            0x11800: 0x1000000,
	            0x12800: 0x1040000,
	            0x13800: 0x20040080,
	            0x14800: 0x20000000,
	            0x15800: 0x1040080,
	            0x16800: 0x80,
	            0x17800: 0x21040000,
	            0x18800: 0x40080,
	            0x19800: 0x21040080,
	            0x1a800: 0x0,
	            0x1b800: 0x21000000,
	            0x1c800: 0x1000080,
	            0x1d800: 0x40000,
	            0x1e800: 0x20040000,
	            0x1f800: 0x20000080
	        },
	        {
	            0x0: 0x10000008,
	            0x100: 0x2000,
	            0x200: 0x10200000,
	            0x300: 0x10202008,
	            0x400: 0x10002000,
	            0x500: 0x200000,
	            0x600: 0x200008,
	            0x700: 0x10000000,
	            0x800: 0x0,
	            0x900: 0x10002008,
	            0xa00: 0x202000,
	            0xb00: 0x8,
	            0xc00: 0x10200008,
	            0xd00: 0x202008,
	            0xe00: 0x2008,
	            0xf00: 0x10202000,
	            0x80: 0x10200000,
	            0x180: 0x10202008,
	            0x280: 0x8,
	            0x380: 0x200000,
	            0x480: 0x202008,
	            0x580: 0x10000008,
	            0x680: 0x10002000,
	            0x780: 0x2008,
	            0x880: 0x200008,
	            0x980: 0x2000,
	            0xa80: 0x10002008,
	            0xb80: 0x10200008,
	            0xc80: 0x0,
	            0xd80: 0x10202000,
	            0xe80: 0x202000,
	            0xf80: 0x10000000,
	            0x1000: 0x10002000,
	            0x1100: 0x10200008,
	            0x1200: 0x10202008,
	            0x1300: 0x2008,
	            0x1400: 0x200000,
	            0x1500: 0x10000000,
	            0x1600: 0x10000008,
	            0x1700: 0x202000,
	            0x1800: 0x202008,
	            0x1900: 0x0,
	            0x1a00: 0x8,
	            0x1b00: 0x10200000,
	            0x1c00: 0x2000,
	            0x1d00: 0x10002008,
	            0x1e00: 0x10202000,
	            0x1f00: 0x200008,
	            0x1080: 0x8,
	            0x1180: 0x202000,
	            0x1280: 0x200000,
	            0x1380: 0x10000008,
	            0x1480: 0x10002000,
	            0x1580: 0x2008,
	            0x1680: 0x10202008,
	            0x1780: 0x10200000,
	            0x1880: 0x10202000,
	            0x1980: 0x10200008,
	            0x1a80: 0x2000,
	            0x1b80: 0x202008,
	            0x1c80: 0x200008,
	            0x1d80: 0x0,
	            0x1e80: 0x10000000,
	            0x1f80: 0x10002008
	        },
	        {
	            0x0: 0x100000,
	            0x10: 0x2000401,
	            0x20: 0x400,
	            0x30: 0x100401,
	            0x40: 0x2100401,
	            0x50: 0x0,
	            0x60: 0x1,
	            0x70: 0x2100001,
	            0x80: 0x2000400,
	            0x90: 0x100001,
	            0xa0: 0x2000001,
	            0xb0: 0x2100400,
	            0xc0: 0x2100000,
	            0xd0: 0x401,
	            0xe0: 0x100400,
	            0xf0: 0x2000000,
	            0x8: 0x2100001,
	            0x18: 0x0,
	            0x28: 0x2000401,
	            0x38: 0x2100400,
	            0x48: 0x100000,
	            0x58: 0x2000001,
	            0x68: 0x2000000,
	            0x78: 0x401,
	            0x88: 0x100401,
	            0x98: 0x2000400,
	            0xa8: 0x2100000,
	            0xb8: 0x100001,
	            0xc8: 0x400,
	            0xd8: 0x2100401,
	            0xe8: 0x1,
	            0xf8: 0x100400,
	            0x100: 0x2000000,
	            0x110: 0x100000,
	            0x120: 0x2000401,
	            0x130: 0x2100001,
	            0x140: 0x100001,
	            0x150: 0x2000400,
	            0x160: 0x2100400,
	            0x170: 0x100401,
	            0x180: 0x401,
	            0x190: 0x2100401,
	            0x1a0: 0x100400,
	            0x1b0: 0x1,
	            0x1c0: 0x0,
	            0x1d0: 0x2100000,
	            0x1e0: 0x2000001,
	            0x1f0: 0x400,
	            0x108: 0x100400,
	            0x118: 0x2000401,
	            0x128: 0x2100001,
	            0x138: 0x1,
	            0x148: 0x2000000,
	            0x158: 0x100000,
	            0x168: 0x401,
	            0x178: 0x2100400,
	            0x188: 0x2000001,
	            0x198: 0x2100000,
	            0x1a8: 0x0,
	            0x1b8: 0x2100401,
	            0x1c8: 0x100401,
	            0x1d8: 0x400,
	            0x1e8: 0x2000400,
	            0x1f8: 0x100001
	        },
	        {
	            0x0: 0x8000820,
	            0x1: 0x20000,
	            0x2: 0x8000000,
	            0x3: 0x20,
	            0x4: 0x20020,
	            0x5: 0x8020820,
	            0x6: 0x8020800,
	            0x7: 0x800,
	            0x8: 0x8020000,
	            0x9: 0x8000800,
	            0xa: 0x20800,
	            0xb: 0x8020020,
	            0xc: 0x820,
	            0xd: 0x0,
	            0xe: 0x8000020,
	            0xf: 0x20820,
	            0x80000000: 0x800,
	            0x80000001: 0x8020820,
	            0x80000002: 0x8000820,
	            0x80000003: 0x8000000,
	            0x80000004: 0x8020000,
	            0x80000005: 0x20800,
	            0x80000006: 0x20820,
	            0x80000007: 0x20,
	            0x80000008: 0x8000020,
	            0x80000009: 0x820,
	            0x8000000a: 0x20020,
	            0x8000000b: 0x8020800,
	            0x8000000c: 0x0,
	            0x8000000d: 0x8020020,
	            0x8000000e: 0x8000800,
	            0x8000000f: 0x20000,
	            0x10: 0x20820,
	            0x11: 0x8020800,
	            0x12: 0x20,
	            0x13: 0x800,
	            0x14: 0x8000800,
	            0x15: 0x8000020,
	            0x16: 0x8020020,
	            0x17: 0x20000,
	            0x18: 0x0,
	            0x19: 0x20020,
	            0x1a: 0x8020000,
	            0x1b: 0x8000820,
	            0x1c: 0x8020820,
	            0x1d: 0x20800,
	            0x1e: 0x820,
	            0x1f: 0x8000000,
	            0x80000010: 0x20000,
	            0x80000011: 0x800,
	            0x80000012: 0x8020020,
	            0x80000013: 0x20820,
	            0x80000014: 0x20,
	            0x80000015: 0x8020000,
	            0x80000016: 0x8000000,
	            0x80000017: 0x8000820,
	            0x80000018: 0x8020820,
	            0x80000019: 0x8000020,
	            0x8000001a: 0x8000800,
	            0x8000001b: 0x0,
	            0x8000001c: 0x20800,
	            0x8000001d: 0x820,
	            0x8000001e: 0x20020,
	            0x8000001f: 0x8020800
	        }
	    ];

	    // Masks that select the SBOX input
	    var SBOX_MASK = [
	        0xf8000001, 0x1f800000, 0x01f80000, 0x001f8000,
	        0x0001f800, 0x00001f80, 0x000001f8, 0x8000001f
	    ];

	    /**
	     * DES block cipher algorithm.
	     */
	    var DES = C_algo.DES = BlockCipher.extend({
	        _doReset: function () {
	            // Shortcuts
	            var key = this._key;
	            var keyWords = key.words;

	            // Select 56 bits according to PC1
	            var keyBits = [];
	            for (var i = 0; i < 56; i++) {
	                var keyBitPos = PC1[i] - 1;
	                keyBits[i] = (keyWords[keyBitPos >>> 5] >>> (31 - keyBitPos % 32)) & 1;
	            }

	            // Assemble 16 subkeys
	            var subKeys = this._subKeys = [];
	            for (var nSubKey = 0; nSubKey < 16; nSubKey++) {
	                // Create subkey
	                var subKey = subKeys[nSubKey] = [];

	                // Shortcut
	                var bitShift = BIT_SHIFTS[nSubKey];

	                // Select 48 bits according to PC2
	                for (var i = 0; i < 24; i++) {
	                    // Select from the left 28 key bits
	                    subKey[(i / 6) | 0] |= keyBits[((PC2[i] - 1) + bitShift) % 28] << (31 - i % 6);

	                    // Select from the right 28 key bits
	                    subKey[4 + ((i / 6) | 0)] |= keyBits[28 + (((PC2[i + 24] - 1) + bitShift) % 28)] << (31 - i % 6);
	                }

	                // Since each subkey is applied to an expanded 32-bit input,
	                // the subkey can be broken into 8 values scaled to 32-bits,
	                // which allows the key to be used without expansion
	                subKey[0] = (subKey[0] << 1) | (subKey[0] >>> 31);
	                for (var i = 1; i < 7; i++) {
	                    subKey[i] = subKey[i] >>> ((i - 1) * 4 + 3);
	                }
	                subKey[7] = (subKey[7] << 5) | (subKey[7] >>> 27);
	            }

	            // Compute inverse subkeys
	            var invSubKeys = this._invSubKeys = [];
	            for (var i = 0; i < 16; i++) {
	                invSubKeys[i] = subKeys[15 - i];
	            }
	        },

	        encryptBlock: function (M, offset) {
	            this._doCryptBlock(M, offset, this._subKeys);
	        },

	        decryptBlock: function (M, offset) {
	            this._doCryptBlock(M, offset, this._invSubKeys);
	        },

	        _doCryptBlock: function (M, offset, subKeys) {
	            // Get input
	            this._lBlock = M[offset];
	            this._rBlock = M[offset + 1];

	            // Initial permutation
	            exchangeLR.call(this, 4,  0x0f0f0f0f);
	            exchangeLR.call(this, 16, 0x0000ffff);
	            exchangeRL.call(this, 2,  0x33333333);
	            exchangeRL.call(this, 8,  0x00ff00ff);
	            exchangeLR.call(this, 1,  0x55555555);

	            // Rounds
	            for (var round = 0; round < 16; round++) {
	                // Shortcuts
	                var subKey = subKeys[round];
	                var lBlock = this._lBlock;
	                var rBlock = this._rBlock;

	                // Feistel function
	                var f = 0;
	                for (var i = 0; i < 8; i++) {
	                    f |= SBOX_P[i][((rBlock ^ subKey[i]) & SBOX_MASK[i]) >>> 0];
	                }
	                this._lBlock = rBlock;
	                this._rBlock = lBlock ^ f;
	            }

	            // Undo swap from last round
	            var t = this._lBlock;
	            this._lBlock = this._rBlock;
	            this._rBlock = t;

	            // Final permutation
	            exchangeLR.call(this, 1,  0x55555555);
	            exchangeRL.call(this, 8,  0x00ff00ff);
	            exchangeRL.call(this, 2,  0x33333333);
	            exchangeLR.call(this, 16, 0x0000ffff);
	            exchangeLR.call(this, 4,  0x0f0f0f0f);

	            // Set output
	            M[offset] = this._lBlock;
	            M[offset + 1] = this._rBlock;
	        },

	        keySize: 64/32,

	        ivSize: 64/32,

	        blockSize: 64/32
	    });

	    // Swap bits across the left and right words
	    function exchangeLR(offset, mask) {
	        var t = ((this._lBlock >>> offset) ^ this._rBlock) & mask;
	        this._rBlock ^= t;
	        this._lBlock ^= t << offset;
	    }

	    function exchangeRL(offset, mask) {
	        var t = ((this._rBlock >>> offset) ^ this._lBlock) & mask;
	        this._lBlock ^= t;
	        this._rBlock ^= t << offset;
	    }

	    /**
	     * Shortcut functions to the cipher's object interface.
	     *
	     * @example
	     *
	     *     var ciphertext = CryptoJS.DES.encrypt(message, key, cfg);
	     *     var plaintext  = CryptoJS.DES.decrypt(ciphertext, key, cfg);
	     */
	    C.DES = BlockCipher._createHelper(DES);

	    /**
	     * Triple-DES block cipher algorithm.
	     */
	    var TripleDES = C_algo.TripleDES = BlockCipher.extend({
	        _doReset: function () {
	            // Shortcuts
	            var key = this._key;
	            var keyWords = key.words;

	            // Create DES instances
	            this._des1 = DES.createEncryptor(WordArray.create(keyWords.slice(0, 2)));
	            this._des2 = DES.createEncryptor(WordArray.create(keyWords.slice(2, 4)));
	            this._des3 = DES.createEncryptor(WordArray.create(keyWords.slice(4, 6)));
	        },

	        encryptBlock: function (M, offset) {
	            this._des1.encryptBlock(M, offset);
	            this._des2.decryptBlock(M, offset);
	            this._des3.encryptBlock(M, offset);
	        },

	        decryptBlock: function (M, offset) {
	            this._des3.decryptBlock(M, offset);
	            this._des2.encryptBlock(M, offset);
	            this._des1.decryptBlock(M, offset);
	        },

	        keySize: 192/32,

	        ivSize: 64/32,

	        blockSize: 64/32
	    });

	    /**
	     * Shortcut functions to the cipher's object interface.
	     *
	     * @example
	     *
	     *     var ciphertext = CryptoJS.TripleDES.encrypt(message, key, cfg);
	     *     var plaintext  = CryptoJS.TripleDES.decrypt(ciphertext, key, cfg);
	     */
	    C.TripleDES = BlockCipher._createHelper(TripleDES);
	}());


	(function () {
	    // Shortcuts
	    var C = CryptoJS;
	    var C_lib = C.lib;
	    var StreamCipher = C_lib.StreamCipher;
	    var C_algo = C.algo;

	    /**
	     * RC4 stream cipher algorithm.
	     */
	    var RC4 = C_algo.RC4 = StreamCipher.extend({
	        _doReset: function () {
	            // Shortcuts
	            var key = this._key;
	            var keyWords = key.words;
	            var keySigBytes = key.sigBytes;

	            // Init sbox
	            var S = this._S = [];
	            for (var i = 0; i < 256; i++) {
	                S[i] = i;
	            }

	            // Key setup
	            for (var i = 0, j = 0; i < 256; i++) {
	                var keyByteIndex = i % keySigBytes;
	                var keyByte = (keyWords[keyByteIndex >>> 2] >>> (24 - (keyByteIndex % 4) * 8)) & 0xff;

	                j = (j + S[i] + keyByte) % 256;

	                // Swap
	                var t = S[i];
	                S[i] = S[j];
	                S[j] = t;
	            }

	            // Counters
	            this._i = this._j = 0;
	        },

	        _doProcessBlock: function (M, offset) {
	            M[offset] ^= generateKeystreamWord.call(this);
	        },

	        keySize: 256/32,

	        ivSize: 0
	    });

	    function generateKeystreamWord() {
	        // Shortcuts
	        var S = this._S;
	        var i = this._i;
	        var j = this._j;

	        // Generate keystream word
	        var keystreamWord = 0;
	        for (var n = 0; n < 4; n++) {
	            i = (i + 1) % 256;
	            j = (j + S[i]) % 256;

	            // Swap
	            var t = S[i];
	            S[i] = S[j];
	            S[j] = t;

	            keystreamWord |= S[(S[i] + S[j]) % 256] << (24 - n * 8);
	        }

	        // Update counters
	        this._i = i;
	        this._j = j;

	        return keystreamWord;
	    }

	    /**
	     * Shortcut functions to the cipher's object interface.
	     *
	     * @example
	     *
	     *     var ciphertext = CryptoJS.RC4.encrypt(message, key, cfg);
	     *     var plaintext  = CryptoJS.RC4.decrypt(ciphertext, key, cfg);
	     */
	    C.RC4 = StreamCipher._createHelper(RC4);

	    /**
	     * Modified RC4 stream cipher algorithm.
	     */
	    var RC4Drop = C_algo.RC4Drop = RC4.extend({
	        /**
	         * Configuration options.
	         *
	         * @property {number} drop The number of keystream words to drop. Default 192
	         */
	        cfg: RC4.cfg.extend({
	            drop: 192
	        }),

	        _doReset: function () {
	            RC4._doReset.call(this);

	            // Drop
	            for (var i = this.cfg.drop; i > 0; i--) {
	                generateKeystreamWord.call(this);
	            }
	        }
	    });

	    /**
	     * Shortcut functions to the cipher's object interface.
	     *
	     * @example
	     *
	     *     var ciphertext = CryptoJS.RC4Drop.encrypt(message, key, cfg);
	     *     var plaintext  = CryptoJS.RC4Drop.decrypt(ciphertext, key, cfg);
	     */
	    C.RC4Drop = StreamCipher._createHelper(RC4Drop);
	}());


	/** @preserve
	 * Counter block mode compatible with  Dr Brian Gladman fileenc.c
	 * derived from CryptoJS.mode.CTR
	 * Jan Hruby jhruby.web@gmail.com
	 */
	CryptoJS.mode.CTRGladman = (function () {
	    var CTRGladman = CryptoJS.lib.BlockCipherMode.extend();

		function incWord(word)
		{
			if (((word >> 24) & 0xff) === 0xff) { //overflow
			var b1 = (word >> 16)&0xff;
			var b2 = (word >> 8)&0xff;
			var b3 = word & 0xff;

			if (b1 === 0xff) // overflow b1
			{
			b1 = 0;
			if (b2 === 0xff)
			{
				b2 = 0;
				if (b3 === 0xff)
				{
					b3 = 0;
				}
				else
				{
					++b3;
				}
			}
			else
			{
				++b2;
			}
			}
			else
			{
			++b1;
			}

			word = 0;
			word += (b1 << 16);
			word += (b2 << 8);
			word += b3;
			}
			else
			{
			word += (0x01 << 24);
			}
			return word;
		}

		function incCounter(counter)
		{
			if ((counter[0] = incWord(counter[0])) === 0)
			{
				// encr_data in fileenc.c from  Dr Brian Gladman's counts only with DWORD j < 8
				counter[1] = incWord(counter[1]);
			}
			return counter;
		}

	    var Encryptor = CTRGladman.Encryptor = CTRGladman.extend({
	        processBlock: function (words, offset) {
	            // Shortcuts
	            var cipher = this._cipher
	            var blockSize = cipher.blockSize;
	            var iv = this._iv;
	            var counter = this._counter;

	            // Generate keystream
	            if (iv) {
	                counter = this._counter = iv.slice(0);

	                // Remove IV for subsequent blocks
	                this._iv = undefined;
	            }

				incCounter(counter);

				var keystream = counter.slice(0);
	            cipher.encryptBlock(keystream, 0);

	            // Encrypt
	            for (var i = 0; i < blockSize; i++) {
	                words[offset + i] ^= keystream[i];
	            }
	        }
	    });

	    CTRGladman.Decryptor = Encryptor;

	    return CTRGladman;
	}());




	(function () {
	    // Shortcuts
	    var C = CryptoJS;
	    var C_lib = C.lib;
	    var StreamCipher = C_lib.StreamCipher;
	    var C_algo = C.algo;

	    // Reusable objects
	    var S  = [];
	    var C_ = [];
	    var G  = [];

	    /**
	     * Rabbit stream cipher algorithm
	     */
	    var Rabbit = C_algo.Rabbit = StreamCipher.extend({
	        _doReset: function () {
	            // Shortcuts
	            var K = this._key.words;
	            var iv = this.cfg.iv;

	            // Swap endian
	            for (var i = 0; i < 4; i++) {
	                K[i] = (((K[i] << 8)  | (K[i] >>> 24)) & 0x00ff00ff) |
	                       (((K[i] << 24) | (K[i] >>> 8))  & 0xff00ff00);
	            }

	            // Generate initial state values
	            var X = this._X = [
	                K[0], (K[3] << 16) | (K[2] >>> 16),
	                K[1], (K[0] << 16) | (K[3] >>> 16),
	                K[2], (K[1] << 16) | (K[0] >>> 16),
	                K[3], (K[2] << 16) | (K[1] >>> 16)
	            ];

	            // Generate initial counter values
	            var C = this._C = [
	                (K[2] << 16) | (K[2] >>> 16), (K[0] & 0xffff0000) | (K[1] & 0x0000ffff),
	                (K[3] << 16) | (K[3] >>> 16), (K[1] & 0xffff0000) | (K[2] & 0x0000ffff),
	                (K[0] << 16) | (K[0] >>> 16), (K[2] & 0xffff0000) | (K[3] & 0x0000ffff),
	                (K[1] << 16) | (K[1] >>> 16), (K[3] & 0xffff0000) | (K[0] & 0x0000ffff)
	            ];

	            // Carry bit
	            this._b = 0;

	            // Iterate the system four times
	            for (var i = 0; i < 4; i++) {
	                nextState.call(this);
	            }

	            // Modify the counters
	            for (var i = 0; i < 8; i++) {
	                C[i] ^= X[(i + 4) & 7];
	            }

	            // IV setup
	            if (iv) {
	                // Shortcuts
	                var IV = iv.words;
	                var IV_0 = IV[0];
	                var IV_1 = IV[1];

	                // Generate four subvectors
	                var i0 = (((IV_0 << 8) | (IV_0 >>> 24)) & 0x00ff00ff) | (((IV_0 << 24) | (IV_0 >>> 8)) & 0xff00ff00);
	                var i2 = (((IV_1 << 8) | (IV_1 >>> 24)) & 0x00ff00ff) | (((IV_1 << 24) | (IV_1 >>> 8)) & 0xff00ff00);
	                var i1 = (i0 >>> 16) | (i2 & 0xffff0000);
	                var i3 = (i2 << 16)  | (i0 & 0x0000ffff);

	                // Modify counter values
	                C[0] ^= i0;
	                C[1] ^= i1;
	                C[2] ^= i2;
	                C[3] ^= i3;
	                C[4] ^= i0;
	                C[5] ^= i1;
	                C[6] ^= i2;
	                C[7] ^= i3;

	                // Iterate the system four times
	                for (var i = 0; i < 4; i++) {
	                    nextState.call(this);
	                }
	            }
	        },

	        _doProcessBlock: function (M, offset) {
	            // Shortcut
	            var X = this._X;

	            // Iterate the system
	            nextState.call(this);

	            // Generate four keystream words
	            S[0] = X[0] ^ (X[5] >>> 16) ^ (X[3] << 16);
	            S[1] = X[2] ^ (X[7] >>> 16) ^ (X[5] << 16);
	            S[2] = X[4] ^ (X[1] >>> 16) ^ (X[7] << 16);
	            S[3] = X[6] ^ (X[3] >>> 16) ^ (X[1] << 16);

	            for (var i = 0; i < 4; i++) {
	                // Swap endian
	                S[i] = (((S[i] << 8)  | (S[i] >>> 24)) & 0x00ff00ff) |
	                       (((S[i] << 24) | (S[i] >>> 8))  & 0xff00ff00);

	                // Encrypt
	                M[offset + i] ^= S[i];
	            }
	        },

	        blockSize: 128/32,

	        ivSize: 64/32
	    });

	    function nextState() {
	        // Shortcuts
	        var X = this._X;
	        var C = this._C;

	        // Save old counter values
	        for (var i = 0; i < 8; i++) {
	            C_[i] = C[i];
	        }

	        // Calculate new counter values
	        C[0] = (C[0] + 0x4d34d34d + this._b) | 0;
	        C[1] = (C[1] + 0xd34d34d3 + ((C[0] >>> 0) < (C_[0] >>> 0) ? 1 : 0)) | 0;
	        C[2] = (C[2] + 0x34d34d34 + ((C[1] >>> 0) < (C_[1] >>> 0) ? 1 : 0)) | 0;
	        C[3] = (C[3] + 0x4d34d34d + ((C[2] >>> 0) < (C_[2] >>> 0) ? 1 : 0)) | 0;
	        C[4] = (C[4] + 0xd34d34d3 + ((C[3] >>> 0) < (C_[3] >>> 0) ? 1 : 0)) | 0;
	        C[5] = (C[5] + 0x34d34d34 + ((C[4] >>> 0) < (C_[4] >>> 0) ? 1 : 0)) | 0;
	        C[6] = (C[6] + 0x4d34d34d + ((C[5] >>> 0) < (C_[5] >>> 0) ? 1 : 0)) | 0;
	        C[7] = (C[7] + 0xd34d34d3 + ((C[6] >>> 0) < (C_[6] >>> 0) ? 1 : 0)) | 0;
	        this._b = (C[7] >>> 0) < (C_[7] >>> 0) ? 1 : 0;

	        // Calculate the g-values
	        for (var i = 0; i < 8; i++) {
	            var gx = X[i] + C[i];

	            // Construct high and low argument for squaring
	            var ga = gx & 0xffff;
	            var gb = gx >>> 16;

	            // Calculate high and low result of squaring
	            var gh = ((((ga * ga) >>> 17) + ga * gb) >>> 15) + gb * gb;
	            var gl = (((gx & 0xffff0000) * gx) | 0) + (((gx & 0x0000ffff) * gx) | 0);

	            // High XOR low
	            G[i] = gh ^ gl;
	        }

	        // Calculate new state values
	        X[0] = (G[0] + ((G[7] << 16) | (G[7] >>> 16)) + ((G[6] << 16) | (G[6] >>> 16))) | 0;
	        X[1] = (G[1] + ((G[0] << 8)  | (G[0] >>> 24)) + G[7]) | 0;
	        X[2] = (G[2] + ((G[1] << 16) | (G[1] >>> 16)) + ((G[0] << 16) | (G[0] >>> 16))) | 0;
	        X[3] = (G[3] + ((G[2] << 8)  | (G[2] >>> 24)) + G[1]) | 0;
	        X[4] = (G[4] + ((G[3] << 16) | (G[3] >>> 16)) + ((G[2] << 16) | (G[2] >>> 16))) | 0;
	        X[5] = (G[5] + ((G[4] << 8)  | (G[4] >>> 24)) + G[3]) | 0;
	        X[6] = (G[6] + ((G[5] << 16) | (G[5] >>> 16)) + ((G[4] << 16) | (G[4] >>> 16))) | 0;
	        X[7] = (G[7] + ((G[6] << 8)  | (G[6] >>> 24)) + G[5]) | 0;
	    }

	    /**
	     * Shortcut functions to the cipher's object interface.
	     *
	     * @example
	     *
	     *     var ciphertext = CryptoJS.Rabbit.encrypt(message, key, cfg);
	     *     var plaintext  = CryptoJS.Rabbit.decrypt(ciphertext, key, cfg);
	     */
	    C.Rabbit = StreamCipher._createHelper(Rabbit);
	}());


	/**
	 * Counter block mode.
	 */
	CryptoJS.mode.CTR = (function () {
	    var CTR = CryptoJS.lib.BlockCipherMode.extend();

	    var Encryptor = CTR.Encryptor = CTR.extend({
	        processBlock: function (words, offset) {
	            // Shortcuts
	            var cipher = this._cipher
	            var blockSize = cipher.blockSize;
	            var iv = this._iv;
	            var counter = this._counter;

	            // Generate keystream
	            if (iv) {
	                counter = this._counter = iv.slice(0);

	                // Remove IV for subsequent blocks
	                this._iv = undefined;
	            }
	            var keystream = counter.slice(0);
	            cipher.encryptBlock(keystream, 0);

	            // Increment counter
	            counter[blockSize - 1] = (counter[blockSize - 1] + 1) | 0

	            // Encrypt
	            for (var i = 0; i < blockSize; i++) {
	                words[offset + i] ^= keystream[i];
	            }
	        }
	    });

	    CTR.Decryptor = Encryptor;

	    return CTR;
	}());


	(function () {
	    // Shortcuts
	    var C = CryptoJS;
	    var C_lib = C.lib;
	    var StreamCipher = C_lib.StreamCipher;
	    var C_algo = C.algo;

	    // Reusable objects
	    var S  = [];
	    var C_ = [];
	    var G  = [];

	    /**
	     * Rabbit stream cipher algorithm.
	     *
	     * This is a legacy version that neglected to convert the key to little-endian.
	     * This error doesn't affect the cipher's security,
	     * but it does affect its compatibility with other implementations.
	     */
	    var RabbitLegacy = C_algo.RabbitLegacy = StreamCipher.extend({
	        _doReset: function () {
	            // Shortcuts
	            var K = this._key.words;
	            var iv = this.cfg.iv;

	            // Generate initial state values
	            var X = this._X = [
	                K[0], (K[3] << 16) | (K[2] >>> 16),
	                K[1], (K[0] << 16) | (K[3] >>> 16),
	                K[2], (K[1] << 16) | (K[0] >>> 16),
	                K[3], (K[2] << 16) | (K[1] >>> 16)
	            ];

	            // Generate initial counter values
	            var C = this._C = [
	                (K[2] << 16) | (K[2] >>> 16), (K[0] & 0xffff0000) | (K[1] & 0x0000ffff),
	                (K[3] << 16) | (K[3] >>> 16), (K[1] & 0xffff0000) | (K[2] & 0x0000ffff),
	                (K[0] << 16) | (K[0] >>> 16), (K[2] & 0xffff0000) | (K[3] & 0x0000ffff),
	                (K[1] << 16) | (K[1] >>> 16), (K[3] & 0xffff0000) | (K[0] & 0x0000ffff)
	            ];

	            // Carry bit
	            this._b = 0;

	            // Iterate the system four times
	            for (var i = 0; i < 4; i++) {
	                nextState.call(this);
	            }

	            // Modify the counters
	            for (var i = 0; i < 8; i++) {
	                C[i] ^= X[(i + 4) & 7];
	            }

	            // IV setup
	            if (iv) {
	                // Shortcuts
	                var IV = iv.words;
	                var IV_0 = IV[0];
	                var IV_1 = IV[1];

	                // Generate four subvectors
	                var i0 = (((IV_0 << 8) | (IV_0 >>> 24)) & 0x00ff00ff) | (((IV_0 << 24) | (IV_0 >>> 8)) & 0xff00ff00);
	                var i2 = (((IV_1 << 8) | (IV_1 >>> 24)) & 0x00ff00ff) | (((IV_1 << 24) | (IV_1 >>> 8)) & 0xff00ff00);
	                var i1 = (i0 >>> 16) | (i2 & 0xffff0000);
	                var i3 = (i2 << 16)  | (i0 & 0x0000ffff);

	                // Modify counter values
	                C[0] ^= i0;
	                C[1] ^= i1;
	                C[2] ^= i2;
	                C[3] ^= i3;
	                C[4] ^= i0;
	                C[5] ^= i1;
	                C[6] ^= i2;
	                C[7] ^= i3;

	                // Iterate the system four times
	                for (var i = 0; i < 4; i++) {
	                    nextState.call(this);
	                }
	            }
	        },

	        _doProcessBlock: function (M, offset) {
	            // Shortcut
	            var X = this._X;

	            // Iterate the system
	            nextState.call(this);

	            // Generate four keystream words
	            S[0] = X[0] ^ (X[5] >>> 16) ^ (X[3] << 16);
	            S[1] = X[2] ^ (X[7] >>> 16) ^ (X[5] << 16);
	            S[2] = X[4] ^ (X[1] >>> 16) ^ (X[7] << 16);
	            S[3] = X[6] ^ (X[3] >>> 16) ^ (X[1] << 16);

	            for (var i = 0; i < 4; i++) {
	                // Swap endian
	                S[i] = (((S[i] << 8)  | (S[i] >>> 24)) & 0x00ff00ff) |
	                       (((S[i] << 24) | (S[i] >>> 8))  & 0xff00ff00);

	                // Encrypt
	                M[offset + i] ^= S[i];
	            }
	        },

	        blockSize: 128/32,

	        ivSize: 64/32
	    });

	    function nextState() {
	        // Shortcuts
	        var X = this._X;
	        var C = this._C;

	        // Save old counter values
	        for (var i = 0; i < 8; i++) {
	            C_[i] = C[i];
	        }

	        // Calculate new counter values
	        C[0] = (C[0] + 0x4d34d34d + this._b) | 0;
	        C[1] = (C[1] + 0xd34d34d3 + ((C[0] >>> 0) < (C_[0] >>> 0) ? 1 : 0)) | 0;
	        C[2] = (C[2] + 0x34d34d34 + ((C[1] >>> 0) < (C_[1] >>> 0) ? 1 : 0)) | 0;
	        C[3] = (C[3] + 0x4d34d34d + ((C[2] >>> 0) < (C_[2] >>> 0) ? 1 : 0)) | 0;
	        C[4] = (C[4] + 0xd34d34d3 + ((C[3] >>> 0) < (C_[3] >>> 0) ? 1 : 0)) | 0;
	        C[5] = (C[5] + 0x34d34d34 + ((C[4] >>> 0) < (C_[4] >>> 0) ? 1 : 0)) | 0;
	        C[6] = (C[6] + 0x4d34d34d + ((C[5] >>> 0) < (C_[5] >>> 0) ? 1 : 0)) | 0;
	        C[7] = (C[7] + 0xd34d34d3 + ((C[6] >>> 0) < (C_[6] >>> 0) ? 1 : 0)) | 0;
	        this._b = (C[7] >>> 0) < (C_[7] >>> 0) ? 1 : 0;

	        // Calculate the g-values
	        for (var i = 0; i < 8; i++) {
	            var gx = X[i] + C[i];

	            // Construct high and low argument for squaring
	            var ga = gx & 0xffff;
	            var gb = gx >>> 16;

	            // Calculate high and low result of squaring
	            var gh = ((((ga * ga) >>> 17) + ga * gb) >>> 15) + gb * gb;
	            var gl = (((gx & 0xffff0000) * gx) | 0) + (((gx & 0x0000ffff) * gx) | 0);

	            // High XOR low
	            G[i] = gh ^ gl;
	        }

	        // Calculate new state values
	        X[0] = (G[0] + ((G[7] << 16) | (G[7] >>> 16)) + ((G[6] << 16) | (G[6] >>> 16))) | 0;
	        X[1] = (G[1] + ((G[0] << 8)  | (G[0] >>> 24)) + G[7]) | 0;
	        X[2] = (G[2] + ((G[1] << 16) | (G[1] >>> 16)) + ((G[0] << 16) | (G[0] >>> 16))) | 0;
	        X[3] = (G[3] + ((G[2] << 8)  | (G[2] >>> 24)) + G[1]) | 0;
	        X[4] = (G[4] + ((G[3] << 16) | (G[3] >>> 16)) + ((G[2] << 16) | (G[2] >>> 16))) | 0;
	        X[5] = (G[5] + ((G[4] << 8)  | (G[4] >>> 24)) + G[3]) | 0;
	        X[6] = (G[6] + ((G[5] << 16) | (G[5] >>> 16)) + ((G[4] << 16) | (G[4] >>> 16))) | 0;
	        X[7] = (G[7] + ((G[6] << 8)  | (G[6] >>> 24)) + G[5]) | 0;
	    }

	    /**
	     * Shortcut functions to the cipher's object interface.
	     *
	     * @example
	     *
	     *     var ciphertext = CryptoJS.RabbitLegacy.encrypt(message, key, cfg);
	     *     var plaintext  = CryptoJS.RabbitLegacy.decrypt(ciphertext, key, cfg);
	     */
	    C.RabbitLegacy = StreamCipher._createHelper(RabbitLegacy);
	}());


	/**
	 * Zero padding strategy.
	 */
	CryptoJS.pad.ZeroPadding = {
	    pad: function (data, blockSize) {
	        // Shortcut
	        var blockSizeBytes = blockSize * 4;

	        // Pad
	        data.clamp();
	        data.sigBytes += blockSizeBytes - ((data.sigBytes % blockSizeBytes) || blockSizeBytes);
	    },

	    unpad: function (data) {
	        // Shortcut
	        var dataWords = data.words;

	        // Unpad
	        var i = data.sigBytes - 1;
	        while (!((dataWords[i >>> 2] >>> (24 - (i % 4) * 8)) & 0xff)) {
	            i--;
	        }
	        data.sigBytes = i + 1;
	    }
	};


	return CryptoJS;

}));
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define('libs/jsencrypt.min',["exports"],e):e(t.JSEncrypt={})}(this,function(t){"use strict";var e="0123456789abcdefghijklmnopqrstuvwxyz";function a(t){return e.charAt(t)}function i(t,e){return t&e}function u(t,e){return t|e}function r(t,e){return t^e}function n(t,e){return t&~e}function s(t){if(0==t)return-1;var e=0;return 0==(65535&t)&&(t>>=16,e+=16),0==(255&t)&&(t>>=8,e+=8),0==(15&t)&&(t>>=4,e+=4),0==(3&t)&&(t>>=2,e+=2),0==(1&t)&&++e,e}function o(t){for(var e=0;0!=t;)t&=t-1,++e;return e}var h="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";function c(t){var e,i,r="";for(e=0;e+3<=t.length;e+=3)i=parseInt(t.substring(e,e+3),16),r+=h.charAt(i>>6)+h.charAt(63&i);for(e+1==t.length?(i=parseInt(t.substring(e,e+1),16),r+=h.charAt(i<<2)):e+2==t.length&&(i=parseInt(t.substring(e,e+2),16),r+=h.charAt(i>>2)+h.charAt((3&i)<<4));0<(3&r.length);)r+="=";return r}function f(t){var e,i="",r=0,n=0;for(e=0;e<t.length&&"="!=t.charAt(e);++e){var s=h.indexOf(t.charAt(e));s<0||(0==r?(i+=a(s>>2),n=3&s,r=1):1==r?(i+=a(n<<2|s>>4),n=15&s,r=2):2==r?(i+=a(n),i+=a(s>>2),n=3&s,r=3):(i+=a(n<<2|s>>4),i+=a(15&s),r=0))}return 1==r&&(i+=a(n<<2)),i}var l,p=function(t,e){return(p=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)};var g,d=function(t){var e;if(void 0===l){var i="0123456789ABCDEF",r=" \f\n\r\t\u2028\u2029";for(l={},e=0;e<16;++e)l[i.charAt(e)]=e;for(i=i.toLowerCase(),e=10;e<16;++e)l[i.charAt(e)]=e;for(e=0;e<r.length;++e)l[r.charAt(e)]=-1}var n=[],s=0,o=0;for(e=0;e<t.length;++e){var h=t.charAt(e);if("="==h)break;if(-1!=(h=l[h])){if(void 0===h)throw new Error("Illegal character at offset "+e);s|=h,2<=++o?(n[n.length]=s,o=s=0):s<<=4}}if(o)throw new Error("Hex encoding incomplete: 4 bits missing");return n},v={decode:function(t){var e;if(void 0===g){var i="= \f\n\r\t\u2028\u2029";for(g=Object.create(null),e=0;e<64;++e)g["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(e)]=e;for(e=0;e<i.length;++e)g[i.charAt(e)]=-1}var r=[],n=0,s=0;for(e=0;e<t.length;++e){var o=t.charAt(e);if("="==o)break;if(-1!=(o=g[o])){if(void 0===o)throw new Error("Illegal character at offset "+e);n|=o,4<=++s?(r[r.length]=n>>16,r[r.length]=n>>8&255,r[r.length]=255&n,s=n=0):n<<=6}}switch(s){case 1:throw new Error("Base64 encoding incomplete: at least 2 bits missing");case 2:r[r.length]=n>>10;break;case 3:r[r.length]=n>>16,r[r.length]=n>>8&255}return r},re:/-----BEGIN [^-]+-----([A-Za-z0-9+\/=\s]+)-----END [^-]+-----|begin-base64[^\n]+\n([A-Za-z0-9+\/=\s]+)====/,unarmor:function(t){var e=v.re.exec(t);if(e)if(e[1])t=e[1];else{if(!e[2])throw new Error("RegExp out of sync");t=e[2]}return v.decode(t)}},m=1e13,y=function(){function t(t){this.buf=[+t||0]}return t.prototype.mulAdd=function(t,e){var i,r,n=this.buf,s=n.length;for(i=0;i<s;++i)(r=n[i]*t+e)<m?e=0:r-=(e=0|r/m)*m,n[i]=r;0<e&&(n[i]=e)},t.prototype.sub=function(t){var e,i,r=this.buf,n=r.length;for(e=0;e<n;++e)(i=r[e]-t)<0?(i+=m,t=1):t=0,r[e]=i;for(;0===r[r.length-1];)r.pop()},t.prototype.toString=function(t){if(10!=(t||10))throw new Error("only base 10 is supported");for(var e=this.buf,i=e[e.length-1].toString(),r=e.length-2;0<=r;--r)i+=(m+e[r]).toString().substring(1);return i},t.prototype.valueOf=function(){for(var t=this.buf,e=0,i=t.length-1;0<=i;--i)e=e*m+t[i];return e},t.prototype.simplify=function(){var t=this.buf;return 1==t.length?t[0]:this},t}(),b="",T=/^(\d\d)(0[1-9]|1[0-2])(0[1-9]|[12]\d|3[01])([01]\d|2[0-3])(?:([0-5]\d)(?:([0-5]\d)(?:[.,](\d{1,3}))?)?)?(Z|[-+](?:[0]\d|1[0-2])([0-5]\d)?)?$/,S=/^(\d\d\d\d)(0[1-9]|1[0-2])(0[1-9]|[12]\d|3[01])([01]\d|2[0-3])(?:([0-5]\d)(?:([0-5]\d)(?:[.,](\d{1,3}))?)?)?(Z|[-+](?:[0]\d|1[0-2])([0-5]\d)?)?$/;function E(t,e){return t.length>e&&(t=t.substring(0,e)+b),t}var w,D=function(){function i(t,e){this.hexDigits="0123456789ABCDEF",t instanceof i?(this.enc=t.enc,this.pos=t.pos):(this.enc=t,this.pos=e)}return i.prototype.get=function(t){if(void 0===t&&(t=this.pos++),t>=this.enc.length)throw new Error("Requesting byte offset "+t+" on a stream of length "+this.enc.length);return"string"==typeof this.enc?this.enc.charCodeAt(t):this.enc[t]},i.prototype.hexByte=function(t){return this.hexDigits.charAt(t>>4&15)+this.hexDigits.charAt(15&t)},i.prototype.hexDump=function(t,e,i){for(var r="",n=t;n<e;++n)if(r+=this.hexByte(this.get(n)),!0!==i)switch(15&n){case 7:r+="  ";break;case 15:r+="\n";break;default:r+=" "}return r},i.prototype.isASCII=function(t,e){for(var i=t;i<e;++i){var r=this.get(i);if(r<32||176<r)return!1}return!0},i.prototype.parseStringISO=function(t,e){for(var i="",r=t;r<e;++r)i+=String.fromCharCode(this.get(r));return i},i.prototype.parseStringUTF=function(t,e){for(var i="",r=t;r<e;){var n=this.get(r++);i+=n<128?String.fromCharCode(n):191<n&&n<224?String.fromCharCode((31&n)<<6|63&this.get(r++)):String.fromCharCode((15&n)<<12|(63&this.get(r++))<<6|63&this.get(r++))}return i},i.prototype.parseStringBMP=function(t,e){for(var i,r,n="",s=t;s<e;)i=this.get(s++),r=this.get(s++),n+=String.fromCharCode(i<<8|r);return n},i.prototype.parseTime=function(t,e,i){var r=this.parseStringISO(t,e),n=(i?T:S).exec(r);return n?(i&&(n[1]=+n[1],n[1]+=+n[1]<70?2e3:1900),r=n[1]+"-"+n[2]+"-"+n[3]+" "+n[4],n[5]&&(r+=":"+n[5],n[6]&&(r+=":"+n[6],n[7]&&(r+="."+n[7]))),n[8]&&(r+=" UTC","Z"!=n[8]&&(r+=n[8],n[9]&&(r+=":"+n[9]))),r):"Unrecognized time: "+r},i.prototype.parseInteger=function(t,e){for(var i,r=this.get(t),n=127<r,s=n?255:0,o="";r==s&&++t<e;)r=this.get(t);if(0===(i=e-t))return n?-1:0;if(4<i){for(o=r,i<<=3;0==(128&(+o^s));)o=+o<<1,--i;o="("+i+" bit)\n"}n&&(r-=256);for(var h=new y(r),a=t+1;a<e;++a)h.mulAdd(256,this.get(a));return o+h.toString()},i.prototype.parseBitString=function(t,e,i){for(var r=this.get(t),n="("+((e-t-1<<3)-r)+" bit)\n",s="",o=t+1;o<e;++o){for(var h=this.get(o),a=o==e-1?r:0,u=7;a<=u;--u)s+=h>>u&1?"1":"0";if(s.length>i)return n+E(s,i)}return n+s},i.prototype.parseOctetString=function(t,e,i){if(this.isASCII(t,e))return E(this.parseStringISO(t,e),i);var r=e-t,n="("+r+" byte)\n";(i/=2)<r&&(e=t+i);for(var s=t;s<e;++s)n+=this.hexByte(this.get(s));return i<r&&(n+=b),n},i.prototype.parseOID=function(t,e,i){for(var r="",n=new y,s=0,o=t;o<e;++o){var h=this.get(o);if(n.mulAdd(128,127&h),s+=7,!(128&h)){if(""===r)if((n=n.simplify())instanceof y)n.sub(80),r="2."+n.toString();else{var a=n<80?n<40?0:1:2;r=a+"."+(n-40*a)}else r+="."+n.toString();if(r.length>i)return E(r,i);n=new y,s=0}}return 0<s&&(r+=".incomplete"),r},i}(),x=function(){function c(t,e,i,r,n){if(!(r instanceof R))throw new Error("Invalid tag value.");this.stream=t,this.header=e,this.length=i,this.tag=r,this.sub=n}return c.prototype.typeName=function(){switch(this.tag.tagClass){case 0:switch(this.tag.tagNumber){case 0:return"EOC";case 1:return"BOOLEAN";case 2:return"INTEGER";case 3:return"BIT_STRING";case 4:return"OCTET_STRING";case 5:return"NULL";case 6:return"OBJECT_IDENTIFIER";case 7:return"ObjectDescriptor";case 8:return"EXTERNAL";case 9:return"REAL";case 10:return"ENUMERATED";case 11:return"EMBEDDED_PDV";case 12:return"UTF8String";case 16:return"SEQUENCE";case 17:return"SET";case 18:return"NumericString";case 19:return"PrintableString";case 20:return"TeletexString";case 21:return"VideotexString";case 22:return"IA5String";case 23:return"UTCTime";case 24:return"GeneralizedTime";case 25:return"GraphicString";case 26:return"VisibleString";case 27:return"GeneralString";case 28:return"UniversalString";case 30:return"BMPString"}return"Universal_"+this.tag.tagNumber.toString();case 1:return"Application_"+this.tag.tagNumber.toString();case 2:return"["+this.tag.tagNumber.toString()+"]";case 3:return"Private_"+this.tag.tagNumber.toString()}},c.prototype.content=function(t){if(void 0===this.tag)return null;void 0===t&&(t=1/0);var e=this.posContent(),i=Math.abs(this.length);if(!this.tag.isUniversal())return null!==this.sub?"("+this.sub.length+" elem)":this.stream.parseOctetString(e,e+i,t);switch(this.tag.tagNumber){case 1:return 0===this.stream.get(e)?"false":"true";case 2:return this.stream.parseInteger(e,e+i);case 3:return this.sub?"("+this.sub.length+" elem)":this.stream.parseBitString(e,e+i,t);case 4:return this.sub?"("+this.sub.length+" elem)":this.stream.parseOctetString(e,e+i,t);case 6:return this.stream.parseOID(e,e+i,t);case 16:case 17:return null!==this.sub?"("+this.sub.length+" elem)":"(no elem)";case 12:return E(this.stream.parseStringUTF(e,e+i),t);case 18:case 19:case 20:case 21:case 22:case 26:return E(this.stream.parseStringISO(e,e+i),t);case 30:return E(this.stream.parseStringBMP(e,e+i),t);case 23:case 24:return this.stream.parseTime(e,e+i,23==this.tag.tagNumber)}return null},c.prototype.toString=function(){return this.typeName()+"@"+this.stream.pos+"[header:"+this.header+",length:"+this.length+",sub:"+(null===this.sub?"null":this.sub.length)+"]"},c.prototype.toPrettyString=function(t){void 0===t&&(t="");var e=t+this.typeName()+" @"+this.stream.pos;if(0<=this.length&&(e+="+"),e+=this.length,this.tag.tagConstructed?e+=" (constructed)":!this.tag.isUniversal()||3!=this.tag.tagNumber&&4!=this.tag.tagNumber||null===this.sub||(e+=" (encapsulates)"),e+="\n",null!==this.sub){t+="  ";for(var i=0,r=this.sub.length;i<r;++i)e+=this.sub[i].toPrettyString(t)}return e},c.prototype.posStart=function(){return this.stream.pos},c.prototype.posContent=function(){return this.stream.pos+this.header},c.prototype.posEnd=function(){return this.stream.pos+this.header+Math.abs(this.length)},c.prototype.toHexString=function(){return this.stream.hexDump(this.posStart(),this.posEnd(),!0)},c.decodeLength=function(t){var e=t.get(),i=127&e;if(i==e)return i;if(6<i)throw new Error("Length over 48 bits not supported at position "+(t.pos-1));if(0===i)return null;for(var r=e=0;r<i;++r)e=256*e+t.get();return e},c.prototype.getHexStringValue=function(){var t=this.toHexString(),e=2*this.header,i=2*this.length;return t.substr(e,i)},c.decode=function(t){var r;r=t instanceof D?t:new D(t,0);var e=new D(r),i=new R(r),n=c.decodeLength(r),s=r.pos,o=s-e.pos,h=null,a=function(){var t=[];if(null!==n){for(var e=s+n;r.pos<e;)t[t.length]=c.decode(r);if(r.pos!=e)throw new Error("Content size is not correct for container starting at offset "+s)}else try{for(;;){var i=c.decode(r);if(i.tag.isEOC())break;t[t.length]=i}n=s-r.pos}catch(t){throw new Error("Exception while decoding undefined length content: "+t)}return t};if(i.tagConstructed)h=a();else if(i.isUniversal()&&(3==i.tagNumber||4==i.tagNumber))try{if(3==i.tagNumber&&0!=r.get())throw new Error("BIT STRINGs with unused bits cannot encapsulate.");h=a();for(var u=0;u<h.length;++u)if(h[u].tag.isEOC())throw new Error("EOC is not supposed to be actual content.")}catch(t){h=null}if(null===h){if(null===n)throw new Error("We can't skip over an invalid tag with undefined length at offset "+s);r.pos=s+Math.abs(n)}return new c(e,o,n,i,h)},c}(),R=function(){function t(t){var e=t.get();if(this.tagClass=e>>6,this.tagConstructed=0!=(32&e),this.tagNumber=31&e,31==this.tagNumber){for(var i=new y;e=t.get(),i.mulAdd(128,127&e),128&e;);this.tagNumber=i.simplify()}}return t.prototype.isUniversal=function(){return 0===this.tagClass},t.prototype.isEOC=function(){return 0===this.tagClass&&0===this.tagNumber},t}(),B=[2,3,5,7,11,13,17,19,23,29,31,37,41,43,47,53,59,61,67,71,73,79,83,89,97,101,103,107,109,113,127,131,137,139,149,151,157,163,167,173,179,181,191,193,197,199,211,223,227,229,233,239,241,251,257,263,269,271,277,281,283,293,307,311,313,317,331,337,347,349,353,359,367,373,379,383,389,397,401,409,419,421,431,433,439,443,449,457,461,463,467,479,487,491,499,503,509,521,523,541,547,557,563,569,571,577,587,593,599,601,607,613,617,619,631,641,643,647,653,659,661,673,677,683,691,701,709,719,727,733,739,743,751,757,761,769,773,787,797,809,811,821,823,827,829,839,853,857,859,863,877,881,883,887,907,911,919,929,937,941,947,953,967,971,977,983,991,997],A=(1<<26)/B[B.length-1],O=function(){function b(t,e,i){null!=t&&("number"==typeof t?this.fromNumber(t,e,i):null==e&&"string"!=typeof t?this.fromString(t,256):this.fromString(t,e))}return b.prototype.toString=function(t){if(this.s<0)return"-"+this.negate().toString(t);var e;if(16==t)e=4;else if(8==t)e=3;else if(2==t)e=1;else if(32==t)e=5;else{if(4!=t)return this.toRadix(t);e=2}var i,r=(1<<e)-1,n=!1,s="",o=this.t,h=this.DB-o*this.DB%e;if(0<o--)for(h<this.DB&&0<(i=this[o]>>h)&&(n=!0,s=a(i));0<=o;)h<e?(i=(this[o]&(1<<h)-1)<<e-h,i|=this[--o]>>(h+=this.DB-e)):(i=this[o]>>(h-=e)&r,h<=0&&(h+=this.DB,--o)),0<i&&(n=!0),n&&(s+=a(i));return n?s:"0"},b.prototype.negate=function(){var t=M();return b.ZERO.subTo(this,t),t},b.prototype.abs=function(){return this.s<0?this.negate():this},b.prototype.compareTo=function(t){var e=this.s-t.s;if(0!=e)return e;var i=this.t;if(0!=(e=i-t.t))return this.s<0?-e:e;for(;0<=--i;)if(0!=(e=this[i]-t[i]))return e;return 0},b.prototype.bitLength=function(){return this.t<=0?0:this.DB*(this.t-1)+U(this[this.t-1]^this.s&this.DM)},b.prototype.mod=function(t){var e=M();return this.abs().divRemTo(t,null,e),this.s<0&&0<e.compareTo(b.ZERO)&&t.subTo(e,e),e},b.prototype.modPowInt=function(t,e){var i;return i=t<256||e.isEven()?new I(e):new N(e),this.exp(t,i)},b.prototype.clone=function(){var t=M();return this.copyTo(t),t},b.prototype.intValue=function(){if(this.s<0){if(1==this.t)return this[0]-this.DV;if(0==this.t)return-1}else{if(1==this.t)return this[0];if(0==this.t)return 0}return(this[1]&(1<<32-this.DB)-1)<<this.DB|this[0]},b.prototype.byteValue=function(){return 0==this.t?this.s:this[0]<<24>>24},b.prototype.shortValue=function(){return 0==this.t?this.s:this[0]<<16>>16},b.prototype.signum=function(){return this.s<0?-1:this.t<=0||1==this.t&&this[0]<=0?0:1},b.prototype.toByteArray=function(){var t=this.t,e=[];e[0]=this.s;var i,r=this.DB-t*this.DB%8,n=0;if(0<t--)for(r<this.DB&&(i=this[t]>>r)!=(this.s&this.DM)>>r&&(e[n++]=i|this.s<<this.DB-r);0<=t;)r<8?(i=(this[t]&(1<<r)-1)<<8-r,i|=this[--t]>>(r+=this.DB-8)):(i=this[t]>>(r-=8)&255,r<=0&&(r+=this.DB,--t)),0!=(128&i)&&(i|=-256),0==n&&(128&this.s)!=(128&i)&&++n,(0<n||i!=this.s)&&(e[n++]=i);return e},b.prototype.equals=function(t){return 0==this.compareTo(t)},b.prototype.min=function(t){return this.compareTo(t)<0?this:t},b.prototype.max=function(t){return 0<this.compareTo(t)?this:t},b.prototype.and=function(t){var e=M();return this.bitwiseTo(t,i,e),e},b.prototype.or=function(t){var e=M();return this.bitwiseTo(t,u,e),e},b.prototype.xor=function(t){var e=M();return this.bitwiseTo(t,r,e),e},b.prototype.andNot=function(t){var e=M();return this.bitwiseTo(t,n,e),e},b.prototype.not=function(){for(var t=M(),e=0;e<this.t;++e)t[e]=this.DM&~this[e];return t.t=this.t,t.s=~this.s,t},b.prototype.shiftLeft=function(t){var e=M();return t<0?this.rShiftTo(-t,e):this.lShiftTo(t,e),e},b.prototype.shiftRight=function(t){var e=M();return t<0?this.lShiftTo(-t,e):this.rShiftTo(t,e),e},b.prototype.getLowestSetBit=function(){for(var t=0;t<this.t;++t)if(0!=this[t])return t*this.DB+s(this[t]);return this.s<0?this.t*this.DB:-1},b.prototype.bitCount=function(){for(var t=0,e=this.s&this.DM,i=0;i<this.t;++i)t+=o(this[i]^e);return t},b.prototype.testBit=function(t){var e=Math.floor(t/this.DB);return e>=this.t?0!=this.s:0!=(this[e]&1<<t%this.DB)},b.prototype.setBit=function(t){return this.changeBit(t,u)},b.prototype.clearBit=function(t){return this.changeBit(t,n)},b.prototype.flipBit=function(t){return this.changeBit(t,r)},b.prototype.add=function(t){var e=M();return this.addTo(t,e),e},b.prototype.subtract=function(t){var e=M();return this.subTo(t,e),e},b.prototype.multiply=function(t){var e=M();return this.multiplyTo(t,e),e},b.prototype.divide=function(t){var e=M();return this.divRemTo(t,e,null),e},b.prototype.remainder=function(t){var e=M();return this.divRemTo(t,null,e),e},b.prototype.divideAndRemainder=function(t){var e=M(),i=M();return this.divRemTo(t,e,i),[e,i]},b.prototype.modPow=function(t,e){var i,r,n=t.bitLength(),s=F(1);if(n<=0)return s;i=n<18?1:n<48?3:n<144?4:n<768?5:6,r=n<8?new I(e):e.isEven()?new P(e):new N(e);var o=[],h=3,a=i-1,u=(1<<i)-1;if(o[1]=r.convert(this),1<i){var c=M();for(r.sqrTo(o[1],c);h<=u;)o[h]=M(),r.mulTo(c,o[h-2],o[h]),h+=2}var f,l,p=t.t-1,g=!0,d=M();for(n=U(t[p])-1;0<=p;){for(a<=n?f=t[p]>>n-a&u:(f=(t[p]&(1<<n+1)-1)<<a-n,0<p&&(f|=t[p-1]>>this.DB+n-a)),h=i;0==(1&f);)f>>=1,--h;if((n-=h)<0&&(n+=this.DB,--p),g)o[f].copyTo(s),g=!1;else{for(;1<h;)r.sqrTo(s,d),r.sqrTo(d,s),h-=2;0<h?r.sqrTo(s,d):(l=s,s=d,d=l),r.mulTo(d,o[f],s)}for(;0<=p&&0==(t[p]&1<<n);)r.sqrTo(s,d),l=s,s=d,d=l,--n<0&&(n=this.DB-1,--p)}return r.revert(s)},b.prototype.modInverse=function(t){var e=t.isEven();if(this.isEven()&&e||0==t.signum())return b.ZERO;for(var i=t.clone(),r=this.clone(),n=F(1),s=F(0),o=F(0),h=F(1);0!=i.signum();){for(;i.isEven();)i.rShiftTo(1,i),e?(n.isEven()&&s.isEven()||(n.addTo(this,n),s.subTo(t,s)),n.rShiftTo(1,n)):s.isEven()||s.subTo(t,s),s.rShiftTo(1,s);for(;r.isEven();)r.rShiftTo(1,r),e?(o.isEven()&&h.isEven()||(o.addTo(this,o),h.subTo(t,h)),o.rShiftTo(1,o)):h.isEven()||h.subTo(t,h),h.rShiftTo(1,h);0<=i.compareTo(r)?(i.subTo(r,i),e&&n.subTo(o,n),s.subTo(h,s)):(r.subTo(i,r),e&&o.subTo(n,o),h.subTo(s,h))}return 0!=r.compareTo(b.ONE)?b.ZERO:0<=h.compareTo(t)?h.subtract(t):h.signum()<0?(h.addTo(t,h),h.signum()<0?h.add(t):h):h},b.prototype.pow=function(t){return this.exp(t,new V)},b.prototype.gcd=function(t){var e=this.s<0?this.negate():this.clone(),i=t.s<0?t.negate():t.clone();if(e.compareTo(i)<0){var r=e;e=i,i=r}var n=e.getLowestSetBit(),s=i.getLowestSetBit();if(s<0)return e;for(n<s&&(s=n),0<s&&(e.rShiftTo(s,e),i.rShiftTo(s,i));0<e.signum();)0<(n=e.getLowestSetBit())&&e.rShiftTo(n,e),0<(n=i.getLowestSetBit())&&i.rShiftTo(n,i),0<=e.compareTo(i)?(e.subTo(i,e),e.rShiftTo(1,e)):(i.subTo(e,i),i.rShiftTo(1,i));return 0<s&&i.lShiftTo(s,i),i},b.prototype.isProbablePrime=function(t){var e,i=this.abs();if(1==i.t&&i[0]<=B[B.length-1]){for(e=0;e<B.length;++e)if(i[0]==B[e])return!0;return!1}if(i.isEven())return!1;for(e=1;e<B.length;){for(var r=B[e],n=e+1;n<B.length&&r<A;)r*=B[n++];for(r=i.modInt(r);e<n;)if(r%B[e++]==0)return!1}return i.millerRabin(t)},b.prototype.copyTo=function(t){for(var e=this.t-1;0<=e;--e)t[e]=this[e];t.t=this.t,t.s=this.s},b.prototype.fromInt=function(t){this.t=1,this.s=t<0?-1:0,0<t?this[0]=t:t<-1?this[0]=t+this.DV:this.t=0},b.prototype.fromString=function(t,e){var i;if(16==e)i=4;else if(8==e)i=3;else if(256==e)i=8;else if(2==e)i=1;else if(32==e)i=5;else{if(4!=e)return void this.fromRadix(t,e);i=2}this.t=0,this.s=0;for(var r=t.length,n=!1,s=0;0<=--r;){var o=8==i?255&+t[r]:C(t,r);o<0?"-"==t.charAt(r)&&(n=!0):(n=!1,0==s?this[this.t++]=o:s+i>this.DB?(this[this.t-1]|=(o&(1<<this.DB-s)-1)<<s,this[this.t++]=o>>this.DB-s):this[this.t-1]|=o<<s,(s+=i)>=this.DB&&(s-=this.DB))}8==i&&0!=(128&+t[0])&&(this.s=-1,0<s&&(this[this.t-1]|=(1<<this.DB-s)-1<<s)),this.clamp(),n&&b.ZERO.subTo(this,this)},b.prototype.clamp=function(){for(var t=this.s&this.DM;0<this.t&&this[this.t-1]==t;)--this.t},b.prototype.dlShiftTo=function(t,e){var i;for(i=this.t-1;0<=i;--i)e[i+t]=this[i];for(i=t-1;0<=i;--i)e[i]=0;e.t=this.t+t,e.s=this.s},b.prototype.drShiftTo=function(t,e){for(var i=t;i<this.t;++i)e[i-t]=this[i];e.t=Math.max(this.t-t,0),e.s=this.s},b.prototype.lShiftTo=function(t,e){for(var i=t%this.DB,r=this.DB-i,n=(1<<r)-1,s=Math.floor(t/this.DB),o=this.s<<i&this.DM,h=this.t-1;0<=h;--h)e[h+s+1]=this[h]>>r|o,o=(this[h]&n)<<i;for(h=s-1;0<=h;--h)e[h]=0;e[s]=o,e.t=this.t+s+1,e.s=this.s,e.clamp()},b.prototype.rShiftTo=function(t,e){e.s=this.s;var i=Math.floor(t/this.DB);if(i>=this.t)e.t=0;else{var r=t%this.DB,n=this.DB-r,s=(1<<r)-1;e[0]=this[i]>>r;for(var o=i+1;o<this.t;++o)e[o-i-1]|=(this[o]&s)<<n,e[o-i]=this[o]>>r;0<r&&(e[this.t-i-1]|=(this.s&s)<<n),e.t=this.t-i,e.clamp()}},b.prototype.subTo=function(t,e){for(var i=0,r=0,n=Math.min(t.t,this.t);i<n;)r+=this[i]-t[i],e[i++]=r&this.DM,r>>=this.DB;if(t.t<this.t){for(r-=t.s;i<this.t;)r+=this[i],e[i++]=r&this.DM,r>>=this.DB;r+=this.s}else{for(r+=this.s;i<t.t;)r-=t[i],e[i++]=r&this.DM,r>>=this.DB;r-=t.s}e.s=r<0?-1:0,r<-1?e[i++]=this.DV+r:0<r&&(e[i++]=r),e.t=i,e.clamp()},b.prototype.multiplyTo=function(t,e){var i=this.abs(),r=t.abs(),n=i.t;for(e.t=n+r.t;0<=--n;)e[n]=0;for(n=0;n<r.t;++n)e[n+i.t]=i.am(0,r[n],e,n,0,i.t);e.s=0,e.clamp(),this.s!=t.s&&b.ZERO.subTo(e,e)},b.prototype.squareTo=function(t){for(var e=this.abs(),i=t.t=2*e.t;0<=--i;)t[i]=0;for(i=0;i<e.t-1;++i){var r=e.am(i,e[i],t,2*i,0,1);(t[i+e.t]+=e.am(i+1,2*e[i],t,2*i+1,r,e.t-i-1))>=e.DV&&(t[i+e.t]-=e.DV,t[i+e.t+1]=1)}0<t.t&&(t[t.t-1]+=e.am(i,e[i],t,2*i,0,1)),t.s=0,t.clamp()},b.prototype.divRemTo=function(t,e,i){var r=t.abs();if(!(r.t<=0)){var n=this.abs();if(n.t<r.t)return null!=e&&e.fromInt(0),void(null!=i&&this.copyTo(i));null==i&&(i=M());var s=M(),o=this.s,h=t.s,a=this.DB-U(r[r.t-1]);0<a?(r.lShiftTo(a,s),n.lShiftTo(a,i)):(r.copyTo(s),n.copyTo(i));var u=s.t,c=s[u-1];if(0!=c){var f=c*(1<<this.F1)+(1<u?s[u-2]>>this.F2:0),l=this.FV/f,p=(1<<this.F1)/f,g=1<<this.F2,d=i.t,v=d-u,m=null==e?M():e;for(s.dlShiftTo(v,m),0<=i.compareTo(m)&&(i[i.t++]=1,i.subTo(m,i)),b.ONE.dlShiftTo(u,m),m.subTo(s,s);s.t<u;)s[s.t++]=0;for(;0<=--v;){var y=i[--d]==c?this.DM:Math.floor(i[d]*l+(i[d-1]+g)*p);if((i[d]+=s.am(0,y,i,v,0,u))<y)for(s.dlShiftTo(v,m),i.subTo(m,i);i[d]<--y;)i.subTo(m,i)}null!=e&&(i.drShiftTo(u,e),o!=h&&b.ZERO.subTo(e,e)),i.t=u,i.clamp(),0<a&&i.rShiftTo(a,i),o<0&&b.ZERO.subTo(i,i)}}},b.prototype.invDigit=function(){if(this.t<1)return 0;var t=this[0];if(0==(1&t))return 0;var e=3&t;return 0<(e=(e=(e=(e=e*(2-(15&t)*e)&15)*(2-(255&t)*e)&255)*(2-((65535&t)*e&65535))&65535)*(2-t*e%this.DV)%this.DV)?this.DV-e:-e},b.prototype.isEven=function(){return 0==(0<this.t?1&this[0]:this.s)},b.prototype.exp=function(t,e){if(4294967295<t||t<1)return b.ONE;var i=M(),r=M(),n=e.convert(this),s=U(t)-1;for(n.copyTo(i);0<=--s;)if(e.sqrTo(i,r),0<(t&1<<s))e.mulTo(r,n,i);else{var o=i;i=r,r=o}return e.revert(i)},b.prototype.chunkSize=function(t){return Math.floor(Math.LN2*this.DB/Math.log(t))},b.prototype.toRadix=function(t){if(null==t&&(t=10),0==this.signum()||t<2||36<t)return"0";var e=this.chunkSize(t),i=Math.pow(t,e),r=F(i),n=M(),s=M(),o="";for(this.divRemTo(r,n,s);0<n.signum();)o=(i+s.intValue()).toString(t).substr(1)+o,n.divRemTo(r,n,s);return s.intValue().toString(t)+o},b.prototype.fromRadix=function(t,e){this.fromInt(0),null==e&&(e=10);for(var i=this.chunkSize(e),r=Math.pow(e,i),n=!1,s=0,o=0,h=0;h<t.length;++h){var a=C(t,h);a<0?"-"==t.charAt(h)&&0==this.signum()&&(n=!0):(o=e*o+a,++s>=i&&(this.dMultiply(r),this.dAddOffset(o,0),o=s=0))}0<s&&(this.dMultiply(Math.pow(e,s)),this.dAddOffset(o,0)),n&&b.ZERO.subTo(this,this)},b.prototype.fromNumber=function(t,e,i){if("number"==typeof e)if(t<2)this.fromInt(1);else for(this.fromNumber(t,i),this.testBit(t-1)||this.bitwiseTo(b.ONE.shiftLeft(t-1),u,this),this.isEven()&&this.dAddOffset(1,0);!this.isProbablePrime(e);)this.dAddOffset(2,0),this.bitLength()>t&&this.subTo(b.ONE.shiftLeft(t-1),this);else{var r=[],n=7&t;r.length=1+(t>>3),e.nextBytes(r),0<n?r[0]&=(1<<n)-1:r[0]=0,this.fromString(r,256)}},b.prototype.bitwiseTo=function(t,e,i){var r,n,s=Math.min(t.t,this.t);for(r=0;r<s;++r)i[r]=e(this[r],t[r]);if(t.t<this.t){for(n=t.s&this.DM,r=s;r<this.t;++r)i[r]=e(this[r],n);i.t=this.t}else{for(n=this.s&this.DM,r=s;r<t.t;++r)i[r]=e(n,t[r]);i.t=t.t}i.s=e(this.s,t.s),i.clamp()},b.prototype.changeBit=function(t,e){var i=b.ONE.shiftLeft(t);return this.bitwiseTo(i,e,i),i},b.prototype.addTo=function(t,e){for(var i=0,r=0,n=Math.min(t.t,this.t);i<n;)r+=this[i]+t[i],e[i++]=r&this.DM,r>>=this.DB;if(t.t<this.t){for(r+=t.s;i<this.t;)r+=this[i],e[i++]=r&this.DM,r>>=this.DB;r+=this.s}else{for(r+=this.s;i<t.t;)r+=t[i],e[i++]=r&this.DM,r>>=this.DB;r+=t.s}e.s=r<0?-1:0,0<r?e[i++]=r:r<-1&&(e[i++]=this.DV+r),e.t=i,e.clamp()},b.prototype.dMultiply=function(t){this[this.t]=this.am(0,t-1,this,0,0,this.t),++this.t,this.clamp()},b.prototype.dAddOffset=function(t,e){if(0!=t){for(;this.t<=e;)this[this.t++]=0;for(this[e]+=t;this[e]>=this.DV;)this[e]-=this.DV,++e>=this.t&&(this[this.t++]=0),++this[e]}},b.prototype.multiplyLowerTo=function(t,e,i){var r=Math.min(this.t+t.t,e);for(i.s=0,i.t=r;0<r;)i[--r]=0;for(var n=i.t-this.t;r<n;++r)i[r+this.t]=this.am(0,t[r],i,r,0,this.t);for(n=Math.min(t.t,e);r<n;++r)this.am(0,t[r],i,r,0,e-r);i.clamp()},b.prototype.multiplyUpperTo=function(t,e,i){--e;var r=i.t=this.t+t.t-e;for(i.s=0;0<=--r;)i[r]=0;for(r=Math.max(e-this.t,0);r<t.t;++r)i[this.t+r-e]=this.am(e-r,t[r],i,0,0,this.t+r-e);i.clamp(),i.drShiftTo(1,i)},b.prototype.modInt=function(t){if(t<=0)return 0;var e=this.DV%t,i=this.s<0?t-1:0;if(0<this.t)if(0==e)i=this[0]%t;else for(var r=this.t-1;0<=r;--r)i=(e*i+this[r])%t;return i},b.prototype.millerRabin=function(t){var e=this.subtract(b.ONE),i=e.getLowestSetBit();if(i<=0)return!1;var r=e.shiftRight(i);B.length<(t=t+1>>1)&&(t=B.length);for(var n=M(),s=0;s<t;++s){n.fromInt(B[Math.floor(Math.random()*B.length)]);var o=n.modPow(r,this);if(0!=o.compareTo(b.ONE)&&0!=o.compareTo(e)){for(var h=1;h++<i&&0!=o.compareTo(e);)if(0==(o=o.modPowInt(2,this)).compareTo(b.ONE))return!1;if(0!=o.compareTo(e))return!1}}return!0},b.prototype.square=function(){var t=M();return this.squareTo(t),t},b.prototype.gcda=function(t,e){var i=this.s<0?this.negate():this.clone(),r=t.s<0?t.negate():t.clone();if(i.compareTo(r)<0){var n=i;i=r,r=n}var s=i.getLowestSetBit(),o=r.getLowestSetBit();if(o<0)e(i);else{s<o&&(o=s),0<o&&(i.rShiftTo(o,i),r.rShiftTo(o,r));var h=function(){0<(s=i.getLowestSetBit())&&i.rShiftTo(s,i),0<(s=r.getLowestSetBit())&&r.rShiftTo(s,r),0<=i.compareTo(r)?(i.subTo(r,i),i.rShiftTo(1,i)):(r.subTo(i,r),r.rShiftTo(1,r)),0<i.signum()?setTimeout(h,0):(0<o&&r.lShiftTo(o,r),setTimeout(function(){e(r)},0))};setTimeout(h,10)}},b.prototype.fromNumberAsync=function(t,e,i,r){if("number"==typeof e)if(t<2)this.fromInt(1);else{this.fromNumber(t,i),this.testBit(t-1)||this.bitwiseTo(b.ONE.shiftLeft(t-1),u,this),this.isEven()&&this.dAddOffset(1,0);var n=this,s=function(){n.dAddOffset(2,0),n.bitLength()>t&&n.subTo(b.ONE.shiftLeft(t-1),n),n.isProbablePrime(e)?setTimeout(function(){r()},0):setTimeout(s,0)};setTimeout(s,0)}else{var o=[],h=7&t;o.length=1+(t>>3),e.nextBytes(o),0<h?o[0]&=(1<<h)-1:o[0]=0,this.fromString(o,256)}},b}(),V=function(){function t(){}return t.prototype.convert=function(t){return t},t.prototype.revert=function(t){return t},t.prototype.mulTo=function(t,e,i){t.multiplyTo(e,i)},t.prototype.sqrTo=function(t,e){t.squareTo(e)},t}(),I=function(){function t(t){this.m=t}return t.prototype.convert=function(t){return t.s<0||0<=t.compareTo(this.m)?t.mod(this.m):t},t.prototype.revert=function(t){return t},t.prototype.reduce=function(t){t.divRemTo(this.m,null,t)},t.prototype.mulTo=function(t,e,i){t.multiplyTo(e,i),this.reduce(i)},t.prototype.sqrTo=function(t,e){t.squareTo(e),this.reduce(e)},t}(),N=function(){function t(t){this.m=t,this.mp=t.invDigit(),this.mpl=32767&this.mp,this.mph=this.mp>>15,this.um=(1<<t.DB-15)-1,this.mt2=2*t.t}return t.prototype.convert=function(t){var e=M();return t.abs().dlShiftTo(this.m.t,e),e.divRemTo(this.m,null,e),t.s<0&&0<e.compareTo(O.ZERO)&&this.m.subTo(e,e),e},t.prototype.revert=function(t){var e=M();return t.copyTo(e),this.reduce(e),e},t.prototype.reduce=function(t){for(;t.t<=this.mt2;)t[t.t++]=0;for(var e=0;e<this.m.t;++e){var i=32767&t[e],r=i*this.mpl+((i*this.mph+(t[e]>>15)*this.mpl&this.um)<<15)&t.DM;for(t[i=e+this.m.t]+=this.m.am(0,r,t,e,0,this.m.t);t[i]>=t.DV;)t[i]-=t.DV,t[++i]++}t.clamp(),t.drShiftTo(this.m.t,t),0<=t.compareTo(this.m)&&t.subTo(this.m,t)},t.prototype.mulTo=function(t,e,i){t.multiplyTo(e,i),this.reduce(i)},t.prototype.sqrTo=function(t,e){t.squareTo(e),this.reduce(e)},t}(),P=function(){function t(t){this.m=t,this.r2=M(),this.q3=M(),O.ONE.dlShiftTo(2*t.t,this.r2),this.mu=this.r2.divide(t)}return t.prototype.convert=function(t){if(t.s<0||t.t>2*this.m.t)return t.mod(this.m);if(t.compareTo(this.m)<0)return t;var e=M();return t.copyTo(e),this.reduce(e),e},t.prototype.revert=function(t){return t},t.prototype.reduce=function(t){for(t.drShiftTo(this.m.t-1,this.r2),t.t>this.m.t+1&&(t.t=this.m.t+1,t.clamp()),this.mu.multiplyUpperTo(this.r2,this.m.t+1,this.q3),this.m.multiplyLowerTo(this.q3,this.m.t+1,this.r2);t.compareTo(this.r2)<0;)t.dAddOffset(1,this.m.t+1);for(t.subTo(this.r2,t);0<=t.compareTo(this.m);)t.subTo(this.m,t)},t.prototype.mulTo=function(t,e,i){t.multiplyTo(e,i),this.reduce(i)},t.prototype.sqrTo=function(t,e){t.squareTo(e),this.reduce(e)},t}();function M(){return new O(null)}function q(t,e){return new O(t,e)}"Microsoft Internet Explorer"==navigator.appName?(O.prototype.am=function(t,e,i,r,n,s){for(var o=32767&e,h=e>>15;0<=--s;){var a=32767&this[t],u=this[t++]>>15,c=h*a+u*o;n=((a=o*a+((32767&c)<<15)+i[r]+(1073741823&n))>>>30)+(c>>>15)+h*u+(n>>>30),i[r++]=1073741823&a}return n},w=30):"Netscape"!=navigator.appName?(O.prototype.am=function(t,e,i,r,n,s){for(;0<=--s;){var o=e*this[t++]+i[r]+n;n=Math.floor(o/67108864),i[r++]=67108863&o}return n},w=26):(O.prototype.am=function(t,e,i,r,n,s){for(var o=16383&e,h=e>>14;0<=--s;){var a=16383&this[t],u=this[t++]>>14,c=h*a+u*o;n=((a=o*a+((16383&c)<<14)+i[r]+n)>>28)+(c>>14)+h*u,i[r++]=268435455&a}return n},w=28),O.prototype.DB=w,O.prototype.DM=(1<<w)-1,O.prototype.DV=1<<w;O.prototype.FV=Math.pow(2,52),O.prototype.F1=52-w,O.prototype.F2=2*w-52;var j,L,H=[];for(j="0".charCodeAt(0),L=0;L<=9;++L)H[j++]=L;for(j="a".charCodeAt(0),L=10;L<36;++L)H[j++]=L;for(j="A".charCodeAt(0),L=10;L<36;++L)H[j++]=L;function C(t,e){var i=H[t.charCodeAt(e)];return null==i?-1:i}function F(t){var e=M();return e.fromInt(t),e}function U(t){var e,i=1;return 0!=(e=t>>>16)&&(t=e,i+=16),0!=(e=t>>8)&&(t=e,i+=8),0!=(e=t>>4)&&(t=e,i+=4),0!=(e=t>>2)&&(t=e,i+=2),0!=(e=t>>1)&&(t=e,i+=1),i}O.ZERO=F(0),O.ONE=F(1);var K=function(){function t(){this.i=0,this.j=0,this.S=[]}return t.prototype.init=function(t){var e,i,r;for(e=0;e<256;++e)this.S[e]=e;for(e=i=0;e<256;++e)i=i+this.S[e]+t[e%t.length]&255,r=this.S[e],this.S[e]=this.S[i],this.S[i]=r;this.i=0,this.j=0},t.prototype.next=function(){var t;return this.i=this.i+1&255,this.j=this.j+this.S[this.i]&255,t=this.S[this.i],this.S[this.i]=this.S[this.j],this.S[this.j]=t,this.S[t+this.S[this.i]&255]},t}();var k,_,z=256,Z=null;if(null==Z){Z=[];var G=void(_=0);if(window.crypto&&window.crypto.getRandomValues){var $=new Uint32Array(256);for(window.crypto.getRandomValues($),G=0;G<$.length;++G)Z[_++]=255&$[G]}var Y=function(t){if(this.count=this.count||0,256<=this.count||z<=_)window.removeEventListener?window.removeEventListener("mousemove",Y,!1):window.detachEvent&&window.detachEvent("onmousemove",Y);else try{var e=t.x+t.y;Z[_++]=255&e,this.count+=1}catch(t){}};window.addEventListener?window.addEventListener("mousemove",Y,!1):window.attachEvent&&window.attachEvent("onmousemove",Y)}function J(){if(null==k){for(k=new K;_<z;){var t=Math.floor(65536*Math.random());Z[_++]=255&t}for(k.init(Z),_=0;_<Z.length;++_)Z[_]=0;_=0}return k.next()}var X=function(){function t(){}return t.prototype.nextBytes=function(t){for(var e=0;e<t.length;++e)t[e]=J()},t}();var Q=function(){function t(){this.n=null,this.e=0,this.d=null,this.p=null,this.q=null,this.dmp1=null,this.dmq1=null,this.coeff=null}return t.prototype.doPublic=function(t){return t.modPowInt(this.e,this.n)},t.prototype.doPrivate=function(t){if(null==this.p||null==this.q)return t.modPow(this.d,this.n);for(var e=t.mod(this.p).modPow(this.dmp1,this.p),i=t.mod(this.q).modPow(this.dmq1,this.q);e.compareTo(i)<0;)e=e.add(this.p);return e.subtract(i).multiply(this.coeff).mod(this.p).multiply(this.q).add(i)},t.prototype.setPublic=function(t,e){null!=t&&null!=e&&0<t.length&&0<e.length?(this.n=q(t,16),this.e=parseInt(e,16)):console.error("Invalid RSA public key")},t.prototype.encrypt=function(t){var e=function(t,e){if(e<t.length+11)return console.error("Message too long for RSA"),null;for(var i=[],r=t.length-1;0<=r&&0<e;){var n=t.charCodeAt(r--);n<128?i[--e]=n:127<n&&n<2048?(i[--e]=63&n|128,i[--e]=n>>6|192):(i[--e]=63&n|128,i[--e]=n>>6&63|128,i[--e]=n>>12|224)}i[--e]=0;for(var s=new X,o=[];2<e;){for(o[0]=0;0==o[0];)s.nextBytes(o);i[--e]=o[0]}return i[--e]=2,i[--e]=0,new O(i)}(t,this.n.bitLength()+7>>3);if(null==e)return null;var i=this.doPublic(e);if(null==i)return null;var r=i.toString(16);return 0==(1&r.length)?r:"0"+r},t.prototype.setPrivate=function(t,e,i){null!=t&&null!=e&&0<t.length&&0<e.length?(this.n=q(t,16),this.e=parseInt(e,16),this.d=q(i,16)):console.error("Invalid RSA private key")},t.prototype.setPrivateEx=function(t,e,i,r,n,s,o,h){null!=t&&null!=e&&0<t.length&&0<e.length?(this.n=q(t,16),this.e=parseInt(e,16),this.d=q(i,16),this.p=q(r,16),this.q=q(n,16),this.dmp1=q(s,16),this.dmq1=q(o,16),this.coeff=q(h,16)):console.error("Invalid RSA private key")},t.prototype.generate=function(t,e){var i=new X,r=t>>1;this.e=parseInt(e,16);for(var n=new O(e,16);;){for(;this.p=new O(t-r,1,i),0!=this.p.subtract(O.ONE).gcd(n).compareTo(O.ONE)||!this.p.isProbablePrime(10););for(;this.q=new O(r,1,i),0!=this.q.subtract(O.ONE).gcd(n).compareTo(O.ONE)||!this.q.isProbablePrime(10););if(this.p.compareTo(this.q)<=0){var s=this.p;this.p=this.q,this.q=s}var o=this.p.subtract(O.ONE),h=this.q.subtract(O.ONE),a=o.multiply(h);if(0==a.gcd(n).compareTo(O.ONE)){this.n=this.p.multiply(this.q),this.d=n.modInverse(a),this.dmp1=this.d.mod(o),this.dmq1=this.d.mod(h),this.coeff=this.q.modInverse(this.p);break}}},t.prototype.decrypt=function(t){var e=q(t,16),i=this.doPrivate(e);return null==i?null:function(t,e){var i=t.toByteArray(),r=0;for(;r<i.length&&0==i[r];)++r;if(i.length-r!=e-1||2!=i[r])return null;++r;for(;0!=i[r];)if(++r>=i.length)return null;var n="";for(;++r<i.length;){var s=255&i[r];s<128?n+=String.fromCharCode(s):191<s&&s<224?(n+=String.fromCharCode((31&s)<<6|63&i[r+1]),++r):(n+=String.fromCharCode((15&s)<<12|(63&i[r+1])<<6|63&i[r+2]),r+=2)}return n}(i,this.n.bitLength()+7>>3)},t.prototype.generateAsync=function(t,e,n){var s=new X,o=t>>1;this.e=parseInt(e,16);var h=new O(e,16),a=this,u=function(){var e=function(){if(a.p.compareTo(a.q)<=0){var t=a.p;a.p=a.q,a.q=t}var e=a.p.subtract(O.ONE),i=a.q.subtract(O.ONE),r=e.multiply(i);0==r.gcd(h).compareTo(O.ONE)?(a.n=a.p.multiply(a.q),a.d=h.modInverse(r),a.dmp1=a.d.mod(e),a.dmq1=a.d.mod(i),a.coeff=a.q.modInverse(a.p),setTimeout(function(){n()},0)):setTimeout(u,0)},i=function(){a.q=M(),a.q.fromNumberAsync(o,1,s,function(){a.q.subtract(O.ONE).gcda(h,function(t){0==t.compareTo(O.ONE)&&a.q.isProbablePrime(10)?setTimeout(e,0):setTimeout(i,0)})})},r=function(){a.p=M(),a.p.fromNumberAsync(t-o,1,s,function(){a.p.subtract(O.ONE).gcda(h,function(t){0==t.compareTo(O.ONE)&&a.p.isProbablePrime(10)?setTimeout(i,0):setTimeout(r,0)})})};setTimeout(r,0)};setTimeout(u,0)},t.prototype.sign=function(t,e,i){var r=function(t,e){if(e<t.length+22)return console.error("Message too long for RSA"),null;for(var i=e-t.length-6,r="",n=0;n<i;n+=2)r+="ff";return q("0001"+r+"00"+t,16)}((W[i]||"")+e(t).toString(),this.n.bitLength()/4);if(null==r)return null;var n=this.doPrivate(r);if(null==n)return null;var s=n.toString(16);return 0==(1&s.length)?s:"0"+s},t.prototype.verify=function(t,e,i){var r=q(e,16),n=this.doPublic(r);return null==n?null:function(t){for(var e in W)if(W.hasOwnProperty(e)){var i=W[e],r=i.length;if(t.substr(0,r)==i)return t.substr(r)}return t}(n.toString(16).replace(/^1f+00/,""))==i(t).toString()},t}();var W={md2:"3020300c06082a864886f70d020205000410",md5:"3020300c06082a864886f70d020505000410",sha1:"3021300906052b0e03021a05000414",sha224:"302d300d06096086480165030402040500041c",sha256:"3031300d060960864801650304020105000420",sha384:"3041300d060960864801650304020205000430",sha512:"3051300d060960864801650304020305000440",ripemd160:"3021300906052b2403020105000414"};var tt={};tt.lang={extend:function(t,e,i){if(!e||!t)throw new Error("YAHOO.lang.extend failed, please check that all dependencies are included.");var r=function(){};if(r.prototype=e.prototype,t.prototype=new r,(t.prototype.constructor=t).superclass=e.prototype,e.prototype.constructor==Object.prototype.constructor&&(e.prototype.constructor=e),i){var n;for(n in i)t.prototype[n]=i[n];var s=function(){},o=["toString","valueOf"];try{/MSIE/.test(navigator.userAgent)&&(s=function(t,e){for(n=0;n<o.length;n+=1){var i=o[n],r=e[i];"function"==typeof r&&r!=Object.prototype[i]&&(t[i]=r)}})}catch(t){}s(t.prototype,i)}}};var et={};void 0!==et.asn1&&et.asn1||(et.asn1={}),et.asn1.ASN1Util=new function(){this.integerToByteHex=function(t){var e=t.toString(16);return e.length%2==1&&(e="0"+e),e},this.bigIntToMinTwosComplementsHex=function(t){var e=t.toString(16);if("-"!=e.substr(0,1))e.length%2==1?e="0"+e:e.match(/^[0-7]/)||(e="00"+e);else{var i=e.substr(1).length;i%2==1?i+=1:e.match(/^[0-7]/)||(i+=2);for(var r="",n=0;n<i;n++)r+="f";e=new O(r,16).xor(t).add(O.ONE).toString(16).replace(/^-/,"")}return e},this.getPEMStringFromHex=function(t,e){return hextopem(t,e)},this.newObject=function(t){var e=et.asn1,i=e.DERBoolean,r=e.DERInteger,n=e.DERBitString,s=e.DEROctetString,o=e.DERNull,h=e.DERObjectIdentifier,a=e.DEREnumerated,u=e.DERUTF8String,c=e.DERNumericString,f=e.DERPrintableString,l=e.DERTeletexString,p=e.DERIA5String,g=e.DERUTCTime,d=e.DERGeneralizedTime,v=e.DERSequence,m=e.DERSet,y=e.DERTaggedObject,b=e.ASN1Util.newObject,T=Object.keys(t);if(1!=T.length)throw"key of param shall be only one.";var S=T[0];if(-1==":bool:int:bitstr:octstr:null:oid:enum:utf8str:numstr:prnstr:telstr:ia5str:utctime:gentime:seq:set:tag:".indexOf(":"+S+":"))throw"undefined key: "+S;if("bool"==S)return new i(t[S]);if("int"==S)return new r(t[S]);if("bitstr"==S)return new n(t[S]);if("octstr"==S)return new s(t[S]);if("null"==S)return new o(t[S]);if("oid"==S)return new h(t[S]);if("enum"==S)return new a(t[S]);if("utf8str"==S)return new u(t[S]);if("numstr"==S)return new c(t[S]);if("prnstr"==S)return new f(t[S]);if("telstr"==S)return new l(t[S]);if("ia5str"==S)return new p(t[S]);if("utctime"==S)return new g(t[S]);if("gentime"==S)return new d(t[S]);if("seq"==S){for(var E=t[S],w=[],D=0;D<E.length;D++){var x=b(E[D]);w.push(x)}return new v({array:w})}if("set"==S){for(E=t[S],w=[],D=0;D<E.length;D++){x=b(E[D]);w.push(x)}return new m({array:w})}if("tag"==S){var R=t[S];if("[object Array]"===Object.prototype.toString.call(R)&&3==R.length){var B=b(R[2]);return new y({tag:R[0],explicit:R[1],obj:B})}var A={};if(void 0!==R.explicit&&(A.explicit=R.explicit),void 0!==R.tag&&(A.tag=R.tag),void 0===R.obj)throw"obj shall be specified for 'tag'.";return A.obj=b(R.obj),new y(A)}},this.jsonToASN1HEX=function(t){return this.newObject(t).getEncodedHex()}},et.asn1.ASN1Util.oidHexToInt=function(t){for(var e="",i=parseInt(t.substr(0,2),16),r=(e=Math.floor(i/40)+"."+i%40,""),n=2;n<t.length;n+=2){var s=("00000000"+parseInt(t.substr(n,2),16).toString(2)).slice(-8);if(r+=s.substr(1,7),"0"==s.substr(0,1))e=e+"."+new O(r,2).toString(10),r=""}return e},et.asn1.ASN1Util.oidIntToHex=function(t){var h=function(t){var e=t.toString(16);return 1==e.length&&(e="0"+e),e},e=function(t){var e="",i=new O(t,10).toString(2),r=7-i.length%7;7==r&&(r=0);for(var n="",s=0;s<r;s++)n+="0";i=n+i;for(s=0;s<i.length-1;s+=7){var o=i.substr(s,7);s!=i.length-7&&(o="1"+o),e+=h(parseInt(o,2))}return e};if(!t.match(/^[0-9.]+$/))throw"malformed oid string: "+t;var i="",r=t.split("."),n=40*parseInt(r[0])+parseInt(r[1]);i+=h(n),r.splice(0,2);for(var s=0;s<r.length;s++)i+=e(r[s]);return i},et.asn1.ASN1Object=function(){this.getLengthHexFromValue=function(){if(void 0===this.hV||null==this.hV)throw"this.hV is null or undefined.";if(this.hV.length%2==1)throw"value hex must be even length: n="+"".length+",v="+this.hV;var t=this.hV.length/2,e=t.toString(16);if(e.length%2==1&&(e="0"+e),t<128)return e;var i=e.length/2;if(15<i)throw"ASN.1 length too long to represent by 8x: n = "+t.toString(16);return(128+i).toString(16)+e},this.getEncodedHex=function(){return(null==this.hTLV||this.isModified)&&(this.hV=this.getFreshValueHex(),this.hL=this.getLengthHexFromValue(),this.hTLV=this.hT+this.hL+this.hV,this.isModified=!1),this.hTLV},this.getValueHex=function(){return this.getEncodedHex(),this.hV},this.getFreshValueHex=function(){return""}},et.asn1.DERAbstractString=function(t){et.asn1.DERAbstractString.superclass.constructor.call(this),this.getString=function(){return this.s},this.setString=function(t){this.hTLV=null,this.isModified=!0,this.s=t,this.hV=stohex(this.s)},this.setStringHex=function(t){this.hTLV=null,this.isModified=!0,this.s=null,this.hV=t},this.getFreshValueHex=function(){return this.hV},void 0!==t&&("string"==typeof t?this.setString(t):void 0!==t.str?this.setString(t.str):void 0!==t.hex&&this.setStringHex(t.hex))},tt.lang.extend(et.asn1.DERAbstractString,et.asn1.ASN1Object),et.asn1.DERAbstractTime=function(t){et.asn1.DERAbstractTime.superclass.constructor.call(this),this.localDateToUTC=function(t){return utc=t.getTime()+6e4*t.getTimezoneOffset(),new Date(utc)},this.formatDate=function(t,e,i){var r=this.zeroPadding,n=this.localDateToUTC(t),s=String(n.getFullYear());"utc"==e&&(s=s.substr(2,2));var o=s+r(String(n.getMonth()+1),2)+r(String(n.getDate()),2)+r(String(n.getHours()),2)+r(String(n.getMinutes()),2)+r(String(n.getSeconds()),2);if(!0===i){var h=n.getMilliseconds();if(0!=h){var a=r(String(h),3);o=o+"."+(a=a.replace(/[0]+$/,""))}}return o+"Z"},this.zeroPadding=function(t,e){return t.length>=e?t:new Array(e-t.length+1).join("0")+t},this.getString=function(){return this.s},this.setString=function(t){this.hTLV=null,this.isModified=!0,this.s=t,this.hV=stohex(t)},this.setByDateValue=function(t,e,i,r,n,s){var o=new Date(Date.UTC(t,e-1,i,r,n,s,0));this.setByDate(o)},this.getFreshValueHex=function(){return this.hV}},tt.lang.extend(et.asn1.DERAbstractTime,et.asn1.ASN1Object),et.asn1.DERAbstractStructured=function(t){et.asn1.DERAbstractString.superclass.constructor.call(this),this.setByASN1ObjectArray=function(t){this.hTLV=null,this.isModified=!0,this.asn1Array=t},this.appendASN1Object=function(t){this.hTLV=null,this.isModified=!0,this.asn1Array.push(t)},this.asn1Array=new Array,void 0!==t&&void 0!==t.array&&(this.asn1Array=t.array)},tt.lang.extend(et.asn1.DERAbstractStructured,et.asn1.ASN1Object),et.asn1.DERBoolean=function(){et.asn1.DERBoolean.superclass.constructor.call(this),this.hT="01",this.hTLV="0101ff"},tt.lang.extend(et.asn1.DERBoolean,et.asn1.ASN1Object),et.asn1.DERInteger=function(t){et.asn1.DERInteger.superclass.constructor.call(this),this.hT="02",this.setByBigInteger=function(t){this.hTLV=null,this.isModified=!0,this.hV=et.asn1.ASN1Util.bigIntToMinTwosComplementsHex(t)},this.setByInteger=function(t){var e=new O(String(t),10);this.setByBigInteger(e)},this.setValueHex=function(t){this.hV=t},this.getFreshValueHex=function(){return this.hV},void 0!==t&&(void 0!==t.bigint?this.setByBigInteger(t.bigint):void 0!==t.int?this.setByInteger(t.int):"number"==typeof t?this.setByInteger(t):void 0!==t.hex&&this.setValueHex(t.hex))},tt.lang.extend(et.asn1.DERInteger,et.asn1.ASN1Object),et.asn1.DERBitString=function(t){if(void 0!==t&&void 0!==t.obj){var e=et.asn1.ASN1Util.newObject(t.obj);t.hex="00"+e.getEncodedHex()}et.asn1.DERBitString.superclass.constructor.call(this),this.hT="03",this.setHexValueIncludingUnusedBits=function(t){this.hTLV=null,this.isModified=!0,this.hV=t},this.setUnusedBitsAndHexValue=function(t,e){if(t<0||7<t)throw"unused bits shall be from 0 to 7: u = "+t;var i="0"+t;this.hTLV=null,this.isModified=!0,this.hV=i+e},this.setByBinaryString=function(t){var e=8-(t=t.replace(/0+$/,"")).length%8;8==e&&(e=0);for(var i=0;i<=e;i++)t+="0";var r="";for(i=0;i<t.length-1;i+=8){var n=t.substr(i,8),s=parseInt(n,2).toString(16);1==s.length&&(s="0"+s),r+=s}this.hTLV=null,this.isModified=!0,this.hV="0"+e+r},this.setByBooleanArray=function(t){for(var e="",i=0;i<t.length;i++)1==t[i]?e+="1":e+="0";this.setByBinaryString(e)},this.newFalseArray=function(t){for(var e=new Array(t),i=0;i<t;i++)e[i]=!1;return e},this.getFreshValueHex=function(){return this.hV},void 0!==t&&("string"==typeof t&&t.toLowerCase().match(/^[0-9a-f]+$/)?this.setHexValueIncludingUnusedBits(t):void 0!==t.hex?this.setHexValueIncludingUnusedBits(t.hex):void 0!==t.bin?this.setByBinaryString(t.bin):void 0!==t.array&&this.setByBooleanArray(t.array))},tt.lang.extend(et.asn1.DERBitString,et.asn1.ASN1Object),et.asn1.DEROctetString=function(t){if(void 0!==t&&void 0!==t.obj){var e=et.asn1.ASN1Util.newObject(t.obj);t.hex=e.getEncodedHex()}et.asn1.DEROctetString.superclass.constructor.call(this,t),this.hT="04"},tt.lang.extend(et.asn1.DEROctetString,et.asn1.DERAbstractString),et.asn1.DERNull=function(){et.asn1.DERNull.superclass.constructor.call(this),this.hT="05",this.hTLV="0500"},tt.lang.extend(et.asn1.DERNull,et.asn1.ASN1Object),et.asn1.DERObjectIdentifier=function(t){var h=function(t){var e=t.toString(16);return 1==e.length&&(e="0"+e),e},s=function(t){var e="",i=new O(t,10).toString(2),r=7-i.length%7;7==r&&(r=0);for(var n="",s=0;s<r;s++)n+="0";i=n+i;for(s=0;s<i.length-1;s+=7){var o=i.substr(s,7);s!=i.length-7&&(o="1"+o),e+=h(parseInt(o,2))}return e};et.asn1.DERObjectIdentifier.superclass.constructor.call(this),this.hT="06",this.setValueHex=function(t){this.hTLV=null,this.isModified=!0,this.s=null,this.hV=t},this.setValueOidString=function(t){if(!t.match(/^[0-9.]+$/))throw"malformed oid string: "+t;var e="",i=t.split("."),r=40*parseInt(i[0])+parseInt(i[1]);e+=h(r),i.splice(0,2);for(var n=0;n<i.length;n++)e+=s(i[n]);this.hTLV=null,this.isModified=!0,this.s=null,this.hV=e},this.setValueName=function(t){var e=et.asn1.x509.OID.name2oid(t);if(""===e)throw"DERObjectIdentifier oidName undefined: "+t;this.setValueOidString(e)},this.getFreshValueHex=function(){return this.hV},void 0!==t&&("string"==typeof t?t.match(/^[0-2].[0-9.]+$/)?this.setValueOidString(t):this.setValueName(t):void 0!==t.oid?this.setValueOidString(t.oid):void 0!==t.hex?this.setValueHex(t.hex):void 0!==t.name&&this.setValueName(t.name))},tt.lang.extend(et.asn1.DERObjectIdentifier,et.asn1.ASN1Object),et.asn1.DEREnumerated=function(t){et.asn1.DEREnumerated.superclass.constructor.call(this),this.hT="0a",this.setByBigInteger=function(t){this.hTLV=null,this.isModified=!0,this.hV=et.asn1.ASN1Util.bigIntToMinTwosComplementsHex(t)},this.setByInteger=function(t){var e=new O(String(t),10);this.setByBigInteger(e)},this.setValueHex=function(t){this.hV=t},this.getFreshValueHex=function(){return this.hV},void 0!==t&&(void 0!==t.int?this.setByInteger(t.int):"number"==typeof t?this.setByInteger(t):void 0!==t.hex&&this.setValueHex(t.hex))},tt.lang.extend(et.asn1.DEREnumerated,et.asn1.ASN1Object),et.asn1.DERUTF8String=function(t){et.asn1.DERUTF8String.superclass.constructor.call(this,t),this.hT="0c"},tt.lang.extend(et.asn1.DERUTF8String,et.asn1.DERAbstractString),et.asn1.DERNumericString=function(t){et.asn1.DERNumericString.superclass.constructor.call(this,t),this.hT="12"},tt.lang.extend(et.asn1.DERNumericString,et.asn1.DERAbstractString),et.asn1.DERPrintableString=function(t){et.asn1.DERPrintableString.superclass.constructor.call(this,t),this.hT="13"},tt.lang.extend(et.asn1.DERPrintableString,et.asn1.DERAbstractString),et.asn1.DERTeletexString=function(t){et.asn1.DERTeletexString.superclass.constructor.call(this,t),this.hT="14"},tt.lang.extend(et.asn1.DERTeletexString,et.asn1.DERAbstractString),et.asn1.DERIA5String=function(t){et.asn1.DERIA5String.superclass.constructor.call(this,t),this.hT="16"},tt.lang.extend(et.asn1.DERIA5String,et.asn1.DERAbstractString),et.asn1.DERUTCTime=function(t){et.asn1.DERUTCTime.superclass.constructor.call(this,t),this.hT="17",this.setByDate=function(t){this.hTLV=null,this.isModified=!0,this.date=t,this.s=this.formatDate(this.date,"utc"),this.hV=stohex(this.s)},this.getFreshValueHex=function(){return void 0===this.date&&void 0===this.s&&(this.date=new Date,this.s=this.formatDate(this.date,"utc"),this.hV=stohex(this.s)),this.hV},void 0!==t&&(void 0!==t.str?this.setString(t.str):"string"==typeof t&&t.match(/^[0-9]{12}Z$/)?this.setString(t):void 0!==t.hex?this.setStringHex(t.hex):void 0!==t.date&&this.setByDate(t.date))},tt.lang.extend(et.asn1.DERUTCTime,et.asn1.DERAbstractTime),et.asn1.DERGeneralizedTime=function(t){et.asn1.DERGeneralizedTime.superclass.constructor.call(this,t),this.hT="18",this.withMillis=!1,this.setByDate=function(t){this.hTLV=null,this.isModified=!0,this.date=t,this.s=this.formatDate(this.date,"gen",this.withMillis),this.hV=stohex(this.s)},this.getFreshValueHex=function(){return void 0===this.date&&void 0===this.s&&(this.date=new Date,this.s=this.formatDate(this.date,"gen",this.withMillis),this.hV=stohex(this.s)),this.hV},void 0!==t&&(void 0!==t.str?this.setString(t.str):"string"==typeof t&&t.match(/^[0-9]{14}Z$/)?this.setString(t):void 0!==t.hex?this.setStringHex(t.hex):void 0!==t.date&&this.setByDate(t.date),!0===t.millis&&(this.withMillis=!0))},tt.lang.extend(et.asn1.DERGeneralizedTime,et.asn1.DERAbstractTime),et.asn1.DERSequence=function(t){et.asn1.DERSequence.superclass.constructor.call(this,t),this.hT="30",this.getFreshValueHex=function(){for(var t="",e=0;e<this.asn1Array.length;e++){t+=this.asn1Array[e].getEncodedHex()}return this.hV=t,this.hV}},tt.lang.extend(et.asn1.DERSequence,et.asn1.DERAbstractStructured),et.asn1.DERSet=function(t){et.asn1.DERSet.superclass.constructor.call(this,t),this.hT="31",this.sortFlag=!0,this.getFreshValueHex=function(){for(var t=new Array,e=0;e<this.asn1Array.length;e++){var i=this.asn1Array[e];t.push(i.getEncodedHex())}return 1==this.sortFlag&&t.sort(),this.hV=t.join(""),this.hV},void 0!==t&&void 0!==t.sortflag&&0==t.sortflag&&(this.sortFlag=!1)},tt.lang.extend(et.asn1.DERSet,et.asn1.DERAbstractStructured),et.asn1.DERTaggedObject=function(t){et.asn1.DERTaggedObject.superclass.constructor.call(this),this.hT="a0",this.hV="",this.isExplicit=!0,this.asn1Object=null,this.setASN1Object=function(t,e,i){this.hT=e,this.isExplicit=t,this.asn1Object=i,this.isExplicit?(this.hV=this.asn1Object.getEncodedHex(),this.hTLV=null,this.isModified=!0):(this.hV=null,this.hTLV=i.getEncodedHex(),this.hTLV=this.hTLV.replace(/^../,e),this.isModified=!1)},this.getFreshValueHex=function(){return this.hV},void 0!==t&&(void 0!==t.tag&&(this.hT=t.tag),void 0!==t.explicit&&(this.isExplicit=t.explicit),void 0!==t.obj&&(this.asn1Object=t.obj,this.setASN1Object(this.isExplicit,this.hT,this.asn1Object)))},tt.lang.extend(et.asn1.DERTaggedObject,et.asn1.ASN1Object);var it=function(i){function r(t){var e=i.call(this)||this;return t&&("string"==typeof t?e.parseKey(t):(r.hasPrivateKeyProperty(t)||r.hasPublicKeyProperty(t))&&e.parsePropertiesFrom(t)),e}return function(t,e){function i(){this.constructor=t}p(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}(r,i),r.prototype.parseKey=function(t){try{var e=0,i=0,r=/^\s*(?:[0-9A-Fa-f][0-9A-Fa-f]\s*)+$/.test(t)?d(t):v.unarmor(t),n=x.decode(r);if(3===n.sub.length&&(n=n.sub[2].sub[0]),9===n.sub.length){e=n.sub[1].getHexStringValue(),this.n=q(e,16),i=n.sub[2].getHexStringValue(),this.e=parseInt(i,16);var s=n.sub[3].getHexStringValue();this.d=q(s,16);var o=n.sub[4].getHexStringValue();this.p=q(o,16);var h=n.sub[5].getHexStringValue();this.q=q(h,16);var a=n.sub[6].getHexStringValue();this.dmp1=q(a,16);var u=n.sub[7].getHexStringValue();this.dmq1=q(u,16);var c=n.sub[8].getHexStringValue();this.coeff=q(c,16)}else{if(2!==n.sub.length)return!1;var f=n.sub[1].sub[0];e=f.sub[0].getHexStringValue(),this.n=q(e,16),i=f.sub[1].getHexStringValue(),this.e=parseInt(i,16)}return!0}catch(t){return!1}},r.prototype.getPrivateBaseKey=function(){var t={array:[new et.asn1.DERInteger({int:0}),new et.asn1.DERInteger({bigint:this.n}),new et.asn1.DERInteger({int:this.e}),new et.asn1.DERInteger({bigint:this.d}),new et.asn1.DERInteger({bigint:this.p}),new et.asn1.DERInteger({bigint:this.q}),new et.asn1.DERInteger({bigint:this.dmp1}),new et.asn1.DERInteger({bigint:this.dmq1}),new et.asn1.DERInteger({bigint:this.coeff})]};return new et.asn1.DERSequence(t).getEncodedHex()},r.prototype.getPrivateBaseKeyB64=function(){return c(this.getPrivateBaseKey())},r.prototype.getPublicBaseKey=function(){var t=new et.asn1.DERSequence({array:[new et.asn1.DERObjectIdentifier({oid:"1.2.840.113549.1.1.1"}),new et.asn1.DERNull]}),e=new et.asn1.DERSequence({array:[new et.asn1.DERInteger({bigint:this.n}),new et.asn1.DERInteger({int:this.e})]}),i=new et.asn1.DERBitString({hex:"00"+e.getEncodedHex()});return new et.asn1.DERSequence({array:[t,i]}).getEncodedHex()},r.prototype.getPublicBaseKeyB64=function(){return c(this.getPublicBaseKey())},r.wordwrap=function(t,e){if(!t)return t;var i="(.{1,"+(e=e||64)+"})( +|$\n?)|(.{1,"+e+"})";return t.match(RegExp(i,"g")).join("\n")},r.prototype.getPrivateKey=function(){var t="-----BEGIN RSA PRIVATE KEY-----\n";return t+=r.wordwrap(this.getPrivateBaseKeyB64())+"\n",t+="-----END RSA PRIVATE KEY-----"},r.prototype.getPublicKey=function(){var t="-----BEGIN PUBLIC KEY-----\n";return t+=r.wordwrap(this.getPublicBaseKeyB64())+"\n",t+="-----END PUBLIC KEY-----"},r.hasPublicKeyProperty=function(t){return(t=t||{}).hasOwnProperty("n")&&t.hasOwnProperty("e")},r.hasPrivateKeyProperty=function(t){return(t=t||{}).hasOwnProperty("n")&&t.hasOwnProperty("e")&&t.hasOwnProperty("d")&&t.hasOwnProperty("p")&&t.hasOwnProperty("q")&&t.hasOwnProperty("dmp1")&&t.hasOwnProperty("dmq1")&&t.hasOwnProperty("coeff")},r.prototype.parsePropertiesFrom=function(t){this.n=t.n,this.e=t.e,t.hasOwnProperty("d")&&(this.d=t.d,this.p=t.p,this.q=t.q,this.dmp1=t.dmp1,this.dmq1=t.dmq1,this.coeff=t.coeff)},r}(Q),rt=function(){function t(t){t=t||{},this.default_key_size=parseInt(t.default_key_size,10)||1024,this.default_public_exponent=t.default_public_exponent||"010001",this.log=t.log||!1,this.key=null}return t.prototype.setKey=function(t){this.log&&this.key&&console.warn("A key was already set, overriding existing."),this.key=new it(t)},t.prototype.setPrivateKey=function(t){this.setKey(t)},t.prototype.setPublicKey=function(t){this.setKey(t)},t.prototype.decrypt=function(t){try{return this.getKey().decrypt(f(t))}catch(t){return!1}},t.prototype.encrypt=function(t){try{return c(this.getKey().encrypt(t))}catch(t){return!1}},t.prototype.sign=function(t,e,i){try{return c(this.getKey().sign(t,e,i))}catch(t){return!1}},t.prototype.verify=function(t,e,i){try{return this.getKey().verify(t,f(e),i)}catch(t){return!1}},t.prototype.getKey=function(t){if(!this.key){if(this.key=new it,t&&"[object Function]"==={}.toString.call(t))return void this.key.generateAsync(this.default_key_size,this.default_public_exponent,t);this.key.generate(this.default_key_size,this.default_public_exponent)}return this.key},t.prototype.getPrivateKey=function(){return this.getKey().getPrivateKey()},t.prototype.getPrivateKeyB64=function(){return this.getKey().getPrivateBaseKeyB64()},t.prototype.getPublicKey=function(){return this.getKey().getPublicKey()},t.prototype.getPublicKeyB64=function(){return this.getKey().getPublicBaseKeyB64()},t.version="3.0.0-rc.1",t}();window.JSEncrypt=rt,t.JSEncrypt=rt,t.default=rt,Object.defineProperty(t,"__esModule",{value:!0})});
define('internal_message',['config/chat', 'lib/cookies', 'libs/jsencrypt.min'], function(config, cookies, jsencrypt) {

	var actions = {};

	actions.ask_conv_key = function(chat_manager, message_id, message, user_id, timestamp, info_friend) {

		if ( user_id == chat_manager.user_id ) {
			return true;
		}
		if ( typeof message.timestamp == "undefined" ) {
			return {"error":"missing timestamp"};
		}
		if ( typeof chat_manager.chat_friend_manager.friends[user_id] == "undefined" ||
			typeof chat_manager.chat_friend_manager.friends[user_id]["conversation_key"] === "undefined" ) {
			return {"error":"missing friend conv keys"};
		}
		
		var conv_key = null;
		if ( typeof chat_manager.chat_friend_manager.friends[user_id]["conversation_key"][message.timestamp] !== "undefined" ) {
			conv_key = chat_manager.chat_friend_manager.friends[user_id]["conversation_key"][message.timestamp];
		}

		var params_message = {
			"id_friend": user_id,
			"action": "add_message",
			"params": {
				"message": chat_manager.make_real_message( JSON.stringify( { "action":"send_conv_key", "timestamp": message.timestamp, "conv_key": conv_key } ), user_id ),
				"message_id": message_id
			}
		};
		
		params_message[config.cookie_name] = cookies.get( config.cookie_name );
		
		chat_manager.socket_connection.emit("internal_message", params_message);

		return true;
	};

	actions.send_conv_key = function(chat_manager, message_id, message, user_id, timestamp, info_friend) {

		if ( user_id == chat_manager.user_id ) {
			return true;
		}

		if ( typeof message.conv_key == "undefined" ) {
			return {"error":"missing conv_key"};
		}
		if ( typeof message.timestamp == "undefined" ) {
			return {"error":"missing timestamp"};
		}

		var encrypted = "null";

		if ( message.conv_key !== null ) {
			var encrypt = new jsencrypt.JSEncrypt();
			encrypt.setPrivateKey( chat_manager.priv_key );
			encrypted = encrypt.encrypt( message.conv_key );
		}

		var params_message = {
			"id_friend": user_id,
			"action": "set_conv_key",
			"params": {
				"message_id": message_id,
				"conv_key": encrypted,
				"timestamp": message.timestamp
			}
		};

		params_message[config.cookie_name] = cookies.get( config.cookie_name );
		
		chat_manager.socket_connection.emit("internal_message", params_message);


		return true;
	};

	return {
		execute_action: function( chat_manager, message_id, message, user_id, timestamp, info_friend) {

			if (typeof params == "undefined") {params={};}

			try {
				message = JSON.parse(message);
			} catch (e) {
				wglog.debug("failed to parse JSON");
				return false;
			}

			if ( typeof message.action == "undefined" || typeof actions[message.action] !== "function" ) {
				return {"error":"bad action"};
			}

			return actions[message.action](chat_manager, message_id, message, user_id, timestamp, info_friend);
		}
	};

});


define('log_and_tooltip',[
	'config/chat',
	'lib/i18n!front',
	'lib/helpers/popup',
	'lib/helpers/overlay/box',
	'lib/helpers/overlay/contextual_popup',
	'lib/storage'
], function(config, i18n, Popup, box, contextual_popup, xv_storage) {
	var instance = null;

	var LEVEL_ERROR = 1;
	var LEVEL_WARNING = 2;
	var LEVEL_INFO = 3;
	var LEVEL_DEBUG = 4;

	var log_and_tooltip = function () {
		if (instance !== null) {
			throw new Error("Can not instantiate more than one instance of log_and_tooltip, use log_and_tooltip.getInstance();");
		}
	};

	log_and_tooltip.prototype = {

		init: function (debug, debug_id) {
			this.debug = debug;
			this.debug_id = debug_id;
			this.log_debug_on = (xv_storage.get("chat_log_debug_on") == 1);
			this.log_important_on = true;
			this.log_info_on = (xv_storage.get("chat_log_debug_on") == 1);
			this.log_error_on = true;

			this.debug_me = false;
			if ( typeof config != "undefined" && typeof config.login_info != "undefined" && typeof config.login_info.id != "undefined" && config.login_info.id === this.debug_id ) {
				this.debug_i = 0;
				this.debug_me = true;
				$("#chat-window").append('<div id="log-display-box" style="overflow:auto;display:none;position:absolute;left:12px;bottom:0;right:0;top:0;z-index:780;"></div>');
				$("#chat-window").append('<div id="display-log" style="position:absolute;left:0;bottom:0;height:10px;width:3px;z-index:800;"></div>');
				$("#display-log").on('click', function (event) {
					$("#log-display-box").toggle();
				});
			}

			this.display_message_old_browser = false;

			this.popup = false;

			this.overlays = [];
			// this.overlay = false;
			this.contextual_popup = false;
		},
		
		encode_html_special_cars: function (input) {
			var car_to_enco = ["<", ">", "'", '"', /*"&",*/ "/"];//& comment en 02/2020, sinon on se retrouve avec des problmes d'encodage des messages d'erreurs, en franais entre autres
			var text = "";
			var car_tmp;
			for (var i = 0; i < input.length; i++) {
				car_tmp = input[i];
				if (car_to_enco.indexOf(car_tmp) !== -1) {
					car_tmp = "&#" + car_tmp.charCodeAt() + ";";
				}
				text += car_tmp;
			}
			
			return text;
		},
		
		set_log_debug: function (value) {
			if (value !== 0 && value !== 1) {
				return;
			}
			this.log_debug_on = value;
		},
		
		write_error: function (data) {
			var message = data.message;
			if (this.write_error.caller && this.write_error.caller.name) {
				message += ' < ' + this.write_error.caller.name;
				if (this.write_error.caller.caller && this.write_error.caller.caller.name) {
					message += ' < ' + this.write_error.caller.caller.name;
				}
			}

			data.title = data.hasOwnProperty('title') ? data.title : i18n.__('error');
			data.type = data.hasOwnProperty('type') ? data.type : null;

			if (data.refresh) {
				data.type = 'refresh';
			}

			this.log_error(data.logTitle || 'write_error', data.logMessage || message);
			var content = "<p>" + data.message + "</p>";
			if (typeof data.source === "string") {
				content = "<p>" + data.message + "<br>" + data.source + "</p>"
			}
			this.modal(content, data);
		},

		write_error_old_browser: function() {
			this.write_error({"message": i18n.__('chat.old_not_supported_browser') }, false);
			this.display_message_old_browser = true;
		},

		write_message: function (data) {
			this.log_debug('MESSAGE', data);
			this.modal("Message", "<p>" + data.message + "</p>");
		},

		write_message_no_private_key: function(send_pass_fct) {
			this.log_debug('write_message_no_private_key');
			var display = '<br /><p style="text-align:center;"><b>' + i18n.__('chat.crypt_enabling', { "%website_name%": config.i18n_website_name }) + "</b></p><br/>";
			display += "<p>" + i18n.__('chat.crypt_even_for_us') + "</p>";
			if (typeof send_pass_fct == "function") {
				display += "<p><b>" + i18n.__('chat.crypt_enter_password', {"%link_start%": "<a id='chat_pass_no_key_toggle'>", "%link_stop%": "</a>"}) + "</b></p>";
				display += '<div id="chat_pass_no_key_check_pass">' + i18n.__('chat.check_password') + '</div>';
				display += '<div id="chat_pass_no_key_form"><div id="chat_pass_no_key_error"></div>';
				display += '<div>' + i18n.__("login_form.your_password") + ' <input type="password" id="chat_pass_no_key" /> <button id="chat_pass_no_key_submit">' + i18n.__("misc.OK") + '</button></div>';
				display += "</div>";
			} else {
				display += "<p><b>" + i18n.__('chat.crypt_need_reconnect', {"%start_link%":"<a href='/account/signout'>", "%end_link%": "</a>"}) + "</b></p>";
			}
			this.modal(display, {title: i18n.__('chat.new_feature')});
			if (typeof send_pass_fct == "function") {
				$("#chat_pass_no_key_toggle").on('click', function() {
					$("#chat_pass_no_key_form").toggle();
					$("#chat_pass_no_key_check_pass").hide();
					var overlay_body = $("body > .chat-external-overlay-container .x-overlay .x-body");
					if (overlay_body.length > 0) {
						overlay_body.scrollTop(overlay_body[0].scrollHeight);
					}
				});
				$("#chat_pass_no_key_submit").on('click', function() {
					$("#chat_pass_no_key_form").hide();
					$("#chat_pass_no_key_check_pass").show();
					send_pass_fct($("#chat_pass_no_key").val());
				});
			}
		},

		modal: function (content, options, closeExistingModal) {
			options = options || {};

			if (this.display_message_old_browser) {
				content = "<p>" + i18n.__('chat.old_not_supported_browser') + "</p>" + content;
			}

			if (typeof closeExistingModal === 'undefined') {
				closeExistingModal = true;
			}

			if (closeExistingModal) {
				this.overlay_close();
			}

			var contentIsNodeElement = (content.nodeType !== 'undefined' && typeof content.nodeType === 'number' && content.nodeType === 1);

			if (typeof content === 'string' && options.title) {
				content = '<h3>' + options.title + '</h3>' + content;
			}

			options.closable = options.closable || false;
			options.popup = options.popup || {};
			if (typeof options.popup.container === "undefined") {
				options.popup.container = $("body > .chat-external-overlay-container");
			}

			if (options.type === "refresh") {
				options.type = "alert";
				options.text_ok = options.text_ok || i18n.__('misc.refresh_this_page');
				options.on_ok = options.on_ok || function () { window.location.reload(); };
			}

			if (options.type === "alert") {
				this.overlays.push(contextual_popup.alert(content, options.on_ok, options.closable, options));
			} else if (options.type === "confirm") {
				this.overlays.push(contextual_popup.confirm(content, options.on_ok, (typeof options.on_no !== 'undefined' && typeof options.on_no === 'function') ? options.on_no : null, options.closable, options));
			} else {
				var formatedContent;
				if (contentIsNodeElement) {
					formatedContent = document.createElement('div');
					formatedContent.classList.add('x-message');
					formatedContent.appendChild(content);
				}
				else {
					formatedContent = '<div class="x-message">' + content + '</div>';
				}

				var overlay = box.get(options.popup.container, options.closable, "close", options.verticallyCentered, options.scrollTo)
					.setContent(formatedContent)
					.show(null, options.noOverlayExtended);

				if (options.on_close) {
					overlay.onClose = options.on_close;
				}
				this.overlays.push(overlay);
			}
			return this.get_last_overlay();
		},

		close_last_overlay: function () {
			this.overlays.pop().close();
		},

		get_last_overlay: function () {
			return this.overlays[this.overlays.length - 1];
		},

		overlay_close: function() {
			while (this.overlays.length) {
				this.close_last_overlay();
			}
		},

		overlay_remove: function() {
			for (var index in this.overlays) {
				this.overlays[index].remove();
			}
		},

		log_debug: function (title, desc, ...rest) {
			if (window.wglog) {
				window.wglog.debug('', title, desc, ...rest);
				return;
			}

			if ( !this.log_debug_on && !this.debug_me ) {
				return;
			}
			this.log(LEVEL_DEBUG, title, desc, ...rest);
		},

		log_important: function (title, desc, ...rest) {
			if (window.wglog) {
				window.wglog.warn('', title, desc, ...rest);
				return;
			}

			if ( !this.log_important_on && !this.debug_me ) {
				return;
			}
			this.log(LEVEL_WARNING, title, desc, ...rest);
		},

		log_info: function (title, desc, ...rest) {
			if (window.wglog) {
				window.wglog.info(title, desc, ...rest);
				return;
			}

			if ( !this.log_info_on && !this.debug_me ) {
				return;
			}
			this.log(LEVEL_INFO, title, desc, ...rest);
		},

		log_error: function (title, desc, ...rest) {
			if (window.wglog) {
				window.wglog.error(title, desc || title, ...rest);
				return;
			}

			if ( !this.log_error_on && !this.debug_me ) {
				return;
			}
			this.log(LEVEL_ERROR, title, desc, ...rest);
		},

		log: function (level, title, desc, ...rest) {
			if (window.wglog) {
				window.wglog.log('', title, desc, ...rest);
				return;
			}

			try {
				desc_display = "";
				if (typeof desc !== 'undefined') {
					desc_display = ' -> ' + JSON.stringify(desc);
				}
			} catch(e) {
				desc_display = " -> log's JSON stringify failed";
			}

			var line = "";
			try {
				var stack = (new Error("StackLog")).stack.split("\n");
				for (var i in stack) {
					if ( i > 0 && typeof stack[i] !== "undefined" && stack[i].indexOf("log_and_tooltip.js") == -1 ) {
						var paths = stack[i].split("/");
						line = paths[paths.length - 1];
						break;
					}
				}
			} catch (e) {

			}

			if ( this.debug_me ) {
				this.debug_i++;

				color = ( this.debug_i%2 == 0)?"#FFFFFF":"#DDDDDD";
				$("#log-display-box").append( '<div style="background-color:' + color + '">' + title + desc_display + '</div>' );

			}

			if (!this.debug) {
				return;
			}

			var args = ["CHAT" + ": " + title];
			if (typeof desc !== "undefined") {
				args.push(desc)
			}
			args.push(...rest);

			switch (level) {
				case LEVEL_ERROR:
					console.error.apply(console, args);
					break;
				case LEVEL_WARNING:
					console.warn.apply(console, args);
					break;
				case LEVEL_INFO:
					console.info.apply(console, args);
					break;
				case LEVEL_DEBUG:
					args.unshift('%c%s', 'color: dodgerblue;');
					console.debug.apply(console, args);
					break;
				default:
					console.log.apply(console, args);
			}
		},

		popup_open: function(button, content, options, event) {

			var max_width = Math.min( $("#chat-window .chat-header-container").width(), 400);

			var popup_options = { closebtn: true, max_width: max_width, popup_class: "chat_xv_popup" };

			var options_popup = $.extend({}, popup_options, options || {});

			$(".chat_xv_popup").remove();

			this.popup = new Popup(button, content, options_popup);
			this.popup.open(event);
		},

		popup_title_open: function(content) {
			var popup_options = {position: { v: 'below', h: 'left' }  };
			this.popup_open( $("#chat-window .chat-title"), content, popup_options );
		},

		popup_close: function() {
			if (this.popup) {
				this.popup.close();
			}
		}


	};

	log_and_tooltip.getInstance = function () {
		if (instance === null) {
			instance =  new log_and_tooltip();
		}
		return instance;
	}

	return log_and_tooltip.getInstance();

});
define('libs/firebase.amd',["exports"],(function(e){"use strict";function t(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function n(e,t,n,r,a,i,o){try{var s=e[i](o),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function r(e){return function(){var t=this,r=arguments;return new Promise((function(a,i){var o=e.apply(t,r);function s(e){n(o,a,i,s,c,"next",e)}function c(e){n(o,a,i,s,c,"throw",e)}s(void 0)}))}}function a(e,t,n){return t=u(t),function(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}(e,p()?Reflect.construct(t,n||[],u(e).constructor):t.apply(e,n))}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t,n){return t&&function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,y(r.key),r)}}(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e}function s(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=w(e))||t){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,o=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,i=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw i}}}}function c(e,t,n){return(t=y(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function u(e){return u=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},u(e)}function f(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&v(e,t)}function p(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(p=function(){return!!e})()}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function h(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){c(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function d(){d=function(){return t};var e,t={},n=Object.prototype,r=n.hasOwnProperty,a=Object.defineProperty||function(e,t,n){e[t]=n.value},i="function"==typeof Symbol?Symbol:{},o=i.iterator||"@@iterator",s=i.asyncIterator||"@@asyncIterator",c=i.toStringTag||"@@toStringTag";function u(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{u({},"")}catch(e){u=function(e,t,n){return e[t]=n}}function f(e,t,n,r){var i=t&&t.prototype instanceof y?t:y,o=Object.create(i.prototype),s=new A(r||[]);return a(o,"_invoke",{value:O(e,n,s)}),o}function p(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}t.wrap=f;var l="suspendedStart",h="suspendedYield",v="executing",g="completed",b={};function y(){}function m(){}function w(){}var k={};u(k,o,(function(){return this}));var x=Object.getPrototypeOf,S=x&&x(x(j([])));S&&S!==n&&r.call(S,o)&&(k=S);var I=w.prototype=y.prototype=Object.create(k);function E(e){["next","throw","return"].forEach((function(t){u(e,t,(function(e){return this._invoke(t,e)}))}))}function _(e,t){function n(a,i,o,s){var c=p(e[a],e,i);if("throw"!==c.type){var u=c.arg,f=u.value;return f&&"object"==typeof f&&r.call(f,"__await")?t.resolve(f.__await).then((function(e){n("next",e,o,s)}),(function(e){n("throw",e,o,s)})):t.resolve(f).then((function(e){u.value=e,o(u)}),(function(e){return n("throw",e,o,s)}))}s(c.arg)}var i;a(this,"_invoke",{value:function(e,r){function a(){return new t((function(t,a){n(e,r,t,a)}))}return i=i?i.then(a,a):a()}})}function O(t,n,r){var a=l;return function(i,o){if(a===v)throw Error("Generator is already running");if(a===g){if("throw"===i)throw o;return{value:e,done:!0}}for(r.method=i,r.arg=o;;){var s=r.delegate;if(s){var c=C(s,r);if(c){if(c===b)continue;return c}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(a===l)throw a=g,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);a=v;var u=p(t,n,r);if("normal"===u.type){if(a=r.done?g:h,u.arg===b)continue;return{value:u.arg,done:r.done}}"throw"===u.type&&(a=g,r.method="throw",r.arg=u.arg)}}}function C(t,n){var r=n.method,a=t.iterator[r];if(a===e)return n.delegate=null,"throw"===r&&t.iterator.return&&(n.method="return",n.arg=e,C(t,n),"throw"===n.method)||"return"!==r&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+r+"' method")),b;var i=p(a,t.iterator,n.arg);if("throw"===i.type)return n.method="throw",n.arg=i.arg,n.delegate=null,b;var o=i.arg;return o?o.done?(n[t.resultName]=o.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=e),n.delegate=null,b):o:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,b)}function D(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function T(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function A(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(D,this),this.reset(!0)}function j(t){if(t||""===t){var n=t[o];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var a=-1,i=function n(){for(;++a<t.length;)if(r.call(t,a))return n.value=t[a],n.done=!1,n;return n.value=e,n.done=!0,n};return i.next=i}}throw new TypeError(typeof t+" is not iterable")}return m.prototype=w,a(I,"constructor",{value:w,configurable:!0}),a(w,"constructor",{value:m,configurable:!0}),m.displayName=u(w,c,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===m||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,w):(e.__proto__=w,u(e,c,"GeneratorFunction")),e.prototype=Object.create(I),e},t.awrap=function(e){return{__await:e}},E(_.prototype),u(_.prototype,s,(function(){return this})),t.AsyncIterator=_,t.async=function(e,n,r,a,i){void 0===i&&(i=Promise);var o=new _(f(e,n,r,a),i);return t.isGeneratorFunction(n)?o:o.next().then((function(e){return e.done?e.value:o.next()}))},E(I),u(I,c,"Generator"),u(I,o,(function(){return this})),u(I,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),n=[];for(var r in t)n.push(r);return n.reverse(),function e(){for(;n.length;){var r=n.pop();if(r in t)return e.value=r,e.done=!1,e}return e.done=!0,e}},t.values=j,A.prototype={constructor:A,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(T),!t)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var n=this;function a(r,a){return s.type="throw",s.arg=t,n.next=r,a&&(n.method="next",n.arg=e),!!a}for(var i=this.tryEntries.length-1;i>=0;--i){var o=this.tryEntries[i],s=o.completion;if("root"===o.tryLoc)return a("end");if(o.tryLoc<=this.prev){var c=r.call(o,"catchLoc"),u=r.call(o,"finallyLoc");if(c&&u){if(this.prev<o.catchLoc)return a(o.catchLoc,!0);if(this.prev<o.finallyLoc)return a(o.finallyLoc)}else if(c){if(this.prev<o.catchLoc)return a(o.catchLoc,!0)}else{if(!u)throw Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return a(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var i=a;break}}i&&("break"===e||"continue"===e)&&i.tryLoc<=t&&t<=i.finallyLoc&&(i=null);var o=i?i.completion:{};return o.type=e,o.arg=t,i?(this.method="next",this.next=i.finallyLoc,b):this.complete(o)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),b},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),T(n),b}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var a=r.arg;T(n)}return a}}throw Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={iterator:j(t),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=e),b}},t}function v(e,t){return v=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},v(e,t)}function g(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,a,i,o,s=[],c=!0,u=!1;try{if(i=(n=n.call(e)).next,0===t);else for(;!(c=(r=i.call(n)).done)&&(s.push(r.value),s.length!==t);c=!0);}catch(e){u=!0,a=e}finally{try{if(!c&&null!=n.return&&(o=n.return(),Object(o)!==o))return}finally{if(u)throw a}}return s}}(e,t)||w(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function b(e){return function(e){if(Array.isArray(e))return t(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||w(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function y(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}function m(e){return m="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},m(e)}function w(e,n){if(e){if("string"==typeof e)return t(e,n);var r={}.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?t(e,n):void 0}}function k(e){var t="function"==typeof Map?new Map:void 0;return k=function(e){if(null===e||!function(e){try{return-1!==Function.toString.call(e).indexOf("[native code]")}catch(t){return"function"==typeof e}}(e))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,n)}function n(){return function(e,t,n){if(p())return Reflect.construct.apply(null,arguments);var r=[null];r.push.apply(r,t);var a=new(e.bind.apply(e,r));return n&&v(a,n.prototype),a}(e,arguments,u(this).constructor)}return n.prototype=Object.create(e.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),v(n,e)},k(e)}var x=function(e){for(var t=[],n=0,r=0;r<e.length;r++){var a=e.charCodeAt(r);a<128?t[n++]=a:a<2048?(t[n++]=a>>6|192,t[n++]=63&a|128):55296==(64512&a)&&r+1<e.length&&56320==(64512&e.charCodeAt(r+1))?(a=65536+((1023&a)<<10)+(1023&e.charCodeAt(++r)),t[n++]=a>>18|240,t[n++]=a>>12&63|128,t[n++]=a>>6&63|128,t[n++]=63&a|128):(t[n++]=a>>12|224,t[n++]=a>>6&63|128,t[n++]=63&a|128)}return t},S={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:"function"==typeof atob,encodeByteArray:function(e,t){if(!Array.isArray(e))throw Error("encodeByteArray takes an array as a parameter");this.init_();for(var n=t?this.byteToCharMapWebSafe_:this.byteToCharMap_,r=[],a=0;a<e.length;a+=3){var i=e[a],o=a+1<e.length,s=o?e[a+1]:0,c=a+2<e.length,u=c?e[a+2]:0,f=i>>2,p=(3&i)<<4|s>>4,l=(15&s)<<2|u>>6,h=63&u;c||(h=64,o||(l=64)),r.push(n[f],n[p],n[l],n[h])}return r.join("")},encodeString:function(e,t){return this.HAS_NATIVE_SUPPORT&&!t?btoa(e):this.encodeByteArray(x(e),t)},decodeString:function(e,t){return this.HAS_NATIVE_SUPPORT&&!t?atob(e):function(e){for(var t=[],n=0,r=0;n<e.length;){var a=e[n++];if(a<128)t[r++]=String.fromCharCode(a);else if(a>191&&a<224){var i=e[n++];t[r++]=String.fromCharCode((31&a)<<6|63&i)}else if(a>239&&a<365){var o=((7&a)<<18|(63&e[n++])<<12|(63&e[n++])<<6|63&e[n++])-65536;t[r++]=String.fromCharCode(55296+(o>>10)),t[r++]=String.fromCharCode(56320+(1023&o))}else{var s=e[n++],c=e[n++];t[r++]=String.fromCharCode((15&a)<<12|(63&s)<<6|63&c)}}return t.join("")}(this.decodeStringToByteArray(e,t))},decodeStringToByteArray:function(e,t){this.init_();for(var n=t?this.charToByteMapWebSafe_:this.charToByteMap_,r=[],a=0;a<e.length;){var i=n[e.charAt(a++)],o=a<e.length?n[e.charAt(a)]:0,s=++a<e.length?n[e.charAt(a)]:64,c=++a<e.length?n[e.charAt(a)]:64;if(++a,null==i||null==o||null==s||null==c)throw new I;var u=i<<2|o>>4;if(r.push(u),64!==s){var f=o<<4&240|s>>2;if(r.push(f),64!==c){var p=s<<6&192|c;r.push(p)}}}return r},init_:function(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(var e=0;e<this.ENCODED_VALS.length;e++)this.byteToCharMap_[e]=this.ENCODED_VALS.charAt(e),this.charToByteMap_[this.byteToCharMap_[e]]=e,this.byteToCharMapWebSafe_[e]=this.ENCODED_VALS_WEBSAFE.charAt(e),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[e]]=e,e>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(e)]=e,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(e)]=e)}}},I=function(e){function t(){var e;return i(this,t),(e=a(this,t,arguments)).name="DecodeBase64StringError",e}return f(t,e),o(t)}(k(Error)),E=function(e){return function(e){var t=x(e);return S.encodeByteArray(t,!0)}(e).replace(/\./g,"")};var _=function(){return function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw new Error("Unable to locate global object.")}().__FIREBASE_DEFAULTS__},O=function(){if("undefined"!=typeof document){var e;try{e=document.cookie.match(/__FIREBASE_DEFAULTS__=([^;]+)/)}catch(e){return}var t=e&&function(e){try{return S.decodeString(e,!0)}catch(e){console.error("base64Decode failed: ",e)}return null}(e[1]);return t&&JSON.parse(t)}},C=function(){try{return _()||function(){if("undefined"!=typeof process&&void 0!==process.env){var e=process.env.__FIREBASE_DEFAULTS__;return e?JSON.parse(e):void 0}}()||O()}catch(e){return void console.info("Unable to get __FIREBASE_DEFAULTS__ due to: ".concat(e))}},D=function(){var e;return null===(e=C())||void 0===e?void 0:e.config},T=function(){return o((function e(){var t=this;i(this,e),this.reject=function(){},this.resolve=function(){},this.promise=new Promise((function(e,n){t.resolve=e,t.reject=n}))}),[{key:"wrapCallback",value:function(e){var t=this;return function(n,r){n?t.reject(n):t.resolve(r),"function"==typeof e&&(t.promise.catch((function(){})),1===e.length?e(n):e(n,r))}}}])}();function A(){try{return"object"===("undefined"==typeof indexedDB?"undefined":m(indexedDB))}catch(e){return!1}}function j(){return new Promise((function(e,t){try{var n=!0,r="validate-browser-context-for-indexeddb-analytics-module",a=self.indexedDB.open(r);a.onsuccess=function(){a.result.close(),n||self.indexedDB.deleteDatabase(r),e(!0)},a.onupgradeneeded=function(){n=!1},a.onerror=function(){var e;t((null===(e=a.error)||void 0===e?void 0:e.message)||"")}}catch(e){t(e)}}))}var P=function(e){function t(e,n,r){var o;return i(this,t),(o=a(this,t,[n])).code=e,o.customData=r,o.name="FirebaseError",Object.setPrototypeOf(o,t.prototype),Error.captureStackTrace&&Error.captureStackTrace(o,L.prototype.create),o}return f(t,e),o(t)}(k(Error)),L=function(){return o((function e(t,n,r){i(this,e),this.service=t,this.serviceName=n,this.errors=r}),[{key:"create",value:function(e){var t=(arguments.length<=1?void 0:arguments[1])||{},n="".concat(this.service,"/").concat(e),r=this.errors[e],a=r?function(e,t){return e.replace(N,(function(e,n){var r=t[n];return null!=r?String(r):"<".concat(n,"?>")}))}(r,t):"Error",i="".concat(this.serviceName,": ").concat(a," (").concat(n,").");return new P(n,i,t)}}])}();var N=/\{\$([^}]+)}/g;function M(e,t){if(e===t)return!0;for(var n=Object.keys(e),r=Object.keys(t),a=0,i=n;a<i.length;a++){var o=i[a];if(!r.includes(o))return!1;var s=e[o],c=t[o];if(B(s)&&B(c)){if(!M(s,c))return!1}else if(s!==c)return!1}for(var u=0,f=r;u<f.length;u++){var p=f[u];if(!n.includes(p))return!1}return!0}function B(e){return null!==e&&"object"===m(e)}function R(e){return e&&e._delegate?e._delegate:e}var F=function(){return o((function e(t,n,r){i(this,e),this.name=t,this.instanceFactory=n,this.type=r,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}),[{key:"setInstantiationMode",value:function(e){return this.instantiationMode=e,this}},{key:"setMultipleInstances",value:function(e){return this.multipleInstances=e,this}},{key:"setServiceProps",value:function(e){return this.serviceProps=e,this}},{key:"setInstanceCreatedCallback",value:function(e){return this.onInstanceCreated=e,this}}])}(),H="[DEFAULT]",V=function(){return o((function e(t,n){i(this,e),this.name=t,this.container=n,this.component=null,this.instances=new Map,this.instancesDeferred=new Map,this.instancesOptions=new Map,this.onInitCallbacks=new Map}),[{key:"get",value:function(e){var t=this.normalizeInstanceIdentifier(e);if(!this.instancesDeferred.has(t)){var n=new T;if(this.instancesDeferred.set(t,n),this.isInitialized(t)||this.shouldAutoInitialize())try{var r=this.getOrInitializeService({instanceIdentifier:t});r&&n.resolve(r)}catch(e){}}return this.instancesDeferred.get(t).promise}},{key:"getImmediate",value:function(e){var t,n=this.normalizeInstanceIdentifier(null==e?void 0:e.identifier),r=null!==(t=null==e?void 0:e.optional)&&void 0!==t&&t;if(!this.isInitialized(n)&&!this.shouldAutoInitialize()){if(r)return null;throw Error("Service ".concat(this.name," is not available"))}try{return this.getOrInitializeService({instanceIdentifier:n})}catch(e){if(r)return null;throw e}}},{key:"getComponent",value:function(){return this.component}},{key:"setComponent",value:function(e){if(e.name!==this.name)throw Error("Mismatching Component ".concat(e.name," for Provider ").concat(this.name,"."));if(this.component)throw Error("Component for ".concat(this.name," has already been provided"));if(this.component=e,this.shouldAutoInitialize()){if(function(e){return"EAGER"===e.instantiationMode}(e))try{this.getOrInitializeService({instanceIdentifier:H})}catch(e){}var t,n=s(this.instancesDeferred.entries());try{for(n.s();!(t=n.n()).done;){var r=g(t.value,2),a=r[0],i=r[1],o=this.normalizeInstanceIdentifier(a);try{var c=this.getOrInitializeService({instanceIdentifier:o});i.resolve(c)}catch(e){}}}catch(e){n.e(e)}finally{n.f()}}}},{key:"clearInstance",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:H;this.instancesDeferred.delete(e),this.instancesOptions.delete(e),this.instances.delete(e)}},{key:"delete",value:(e=r(d().mark((function e(){var t;return d().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=Array.from(this.instances.values()),e.next=3,Promise.all([].concat(b(t.filter((function(e){return"INTERNAL"in e})).map((function(e){return e.INTERNAL.delete()}))),b(t.filter((function(e){return"_delete"in e})).map((function(e){return e._delete()})))));case 3:case"end":return e.stop()}}),e,this)}))),function(){return e.apply(this,arguments)})},{key:"isComponentSet",value:function(){return null!=this.component}},{key:"isInitialized",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:H;return this.instances.has(e)}},{key:"getOptions",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:H;return this.instancesOptions.get(e)||{}}},{key:"initialize",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.options,n=void 0===t?{}:t,r=this.normalizeInstanceIdentifier(e.instanceIdentifier);if(this.isInitialized(r))throw Error("".concat(this.name,"(").concat(r,") has already been initialized"));if(!this.isComponentSet())throw Error("Component ".concat(this.name," has not been registered yet"));var a,i=this.getOrInitializeService({instanceIdentifier:r,options:n}),o=s(this.instancesDeferred.entries());try{for(o.s();!(a=o.n()).done;){var c=g(a.value,2),u=c[0],f=c[1];r===this.normalizeInstanceIdentifier(u)&&f.resolve(i)}}catch(e){o.e(e)}finally{o.f()}return i}},{key:"onInit",value:function(e,t){var n,r=this.normalizeInstanceIdentifier(t),a=null!==(n=this.onInitCallbacks.get(r))&&void 0!==n?n:new Set;a.add(e),this.onInitCallbacks.set(r,a);var i=this.instances.get(r);return i&&e(i,r),function(){a.delete(e)}}},{key:"invokeOnInitCallbacks",value:function(e,t){var n=this.onInitCallbacks.get(t);if(n){var r,a=s(n);try{for(a.s();!(r=a.n()).done;){var i=r.value;try{i(e,t)}catch(e){}}}catch(e){a.e(e)}finally{a.f()}}}},{key:"getOrInitializeService",value:function(e){var t,n=e.instanceIdentifier,r=e.options,a=void 0===r?{}:r,i=this.instances.get(n);if(!i&&this.component&&(i=this.component.instanceFactory(this.container,{instanceIdentifier:(t=n,t===H?void 0:t),options:a}),this.instances.set(n,i),this.instancesOptions.set(n,a),this.invokeOnInitCallbacks(i,n),this.component.onInstanceCreated))try{this.component.onInstanceCreated(this.container,n,i)}catch(e){}return i||null}},{key:"normalizeInstanceIdentifier",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:H;return this.component?this.component.multipleInstances?e:H:e}},{key:"shouldAutoInitialize",value:function(){return!!this.component&&"EXPLICIT"!==this.component.instantiationMode}}]);var e}();var K,W=function(){return o((function e(t){i(this,e),this.name=t,this.providers=new Map}),[{key:"addComponent",value:function(e){var t=this.getProvider(e.name);if(t.isComponentSet())throw new Error("Component ".concat(e.name," has already been registered with ").concat(this.name));t.setComponent(e)}},{key:"addOrOverwriteComponent",value:function(e){this.getProvider(e.name).isComponentSet()&&this.providers.delete(e.name),this.addComponent(e)}},{key:"getProvider",value:function(e){if(this.providers.has(e))return this.providers.get(e);var t=new V(e,this);return this.providers.set(e,t),t}},{key:"getProviders",value:function(){return Array.from(this.providers.values())}}])}();!function(e){e[e.DEBUG=0]="DEBUG",e[e.VERBOSE=1]="VERBOSE",e[e.INFO=2]="INFO",e[e.WARN=3]="WARN",e[e.ERROR=4]="ERROR",e[e.SILENT=5]="SILENT"}(K||(K={}));var U,z,q={debug:K.DEBUG,verbose:K.VERBOSE,info:K.INFO,warn:K.WARN,error:K.ERROR,silent:K.SILENT},$=K.INFO,G=c(c(c(c(c({},K.DEBUG,"log"),K.VERBOSE,"log"),K.INFO,"info"),K.WARN,"warn"),K.ERROR,"error"),J=function(e,t){if(!(t<e.logLevel)){var n=(new Date).toISOString(),r=G[t];if(!r)throw new Error("Attempted to log a message with an invalid logType (value: ".concat(t,")"));for(var a,i=arguments.length,o=new Array(i>2?i-2:0),s=2;s<i;s++)o[s-2]=arguments[s];(a=console)[r].apply(a,["[".concat(n,"]  ").concat(e.name,":")].concat(o))}},Y=function(){return o((function e(t){i(this,e),this.name=t,this._logLevel=$,this._logHandler=J,this._userLogHandler=null}),[{key:"logLevel",get:function(){return this._logLevel},set:function(e){if(!(e in K))throw new TypeError('Invalid value "'.concat(e,'" assigned to `logLevel`'));this._logLevel=e}},{key:"setLogLevel",value:function(e){this._logLevel="string"==typeof e?q[e]:e}},{key:"logHandler",get:function(){return this._logHandler},set:function(e){if("function"!=typeof e)throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=e}},{key:"userLogHandler",get:function(){return this._userLogHandler},set:function(e){this._userLogHandler=e}},{key:"debug",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this._userLogHandler&&this._userLogHandler.apply(this,[this,K.DEBUG].concat(t)),this._logHandler.apply(this,[this,K.DEBUG].concat(t))}},{key:"log",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this._userLogHandler&&this._userLogHandler.apply(this,[this,K.VERBOSE].concat(t)),this._logHandler.apply(this,[this,K.VERBOSE].concat(t))}},{key:"info",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this._userLogHandler&&this._userLogHandler.apply(this,[this,K.INFO].concat(t)),this._logHandler.apply(this,[this,K.INFO].concat(t))}},{key:"warn",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this._userLogHandler&&this._userLogHandler.apply(this,[this,K.WARN].concat(t)),this._logHandler.apply(this,[this,K.WARN].concat(t))}},{key:"error",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this._userLogHandler&&this._userLogHandler.apply(this,[this,K.ERROR].concat(t)),this._logHandler.apply(this,[this,K.ERROR].concat(t))}}])}();var Q=new WeakMap,X=new WeakMap,Z=new WeakMap,ee=new WeakMap,te=new WeakMap;var ne={get:function(e,t,n){if(e instanceof IDBTransaction){if("done"===t)return X.get(e);if("objectStoreNames"===t)return e.objectStoreNames||Z.get(e);if("store"===t)return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return ie(e[t])},set:function(e,t,n){return e[t]=n,!0},has:function(e,t){return e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e}};function re(e){return e!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?(z||(z=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(e)?function(){for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];return e.apply(oe(this),n),ie(Q.get(this))}:function(){for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];return ie(e.apply(oe(this),n))}:function(t){for(var n=arguments.length,r=new Array(n>1?n-1:0),a=1;a<n;a++)r[a-1]=arguments[a];var i=e.call.apply(e,[oe(this),t].concat(r));return Z.set(i,t.sort?t.sort():[t]),ie(i)}}function ae(e){return"function"==typeof e?re(e):(e instanceof IDBTransaction&&function(e){if(!X.has(e)){var t=new Promise((function(t,n){var r=function(){e.removeEventListener("complete",a),e.removeEventListener("error",i),e.removeEventListener("abort",i)},a=function(){t(),r()},i=function(){n(e.error||new DOMException("AbortError","AbortError")),r()};e.addEventListener("complete",a),e.addEventListener("error",i),e.addEventListener("abort",i)}));X.set(e,t)}}(e),t=e,(U||(U=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])).some((function(e){return t instanceof e}))?new Proxy(e,ne):e);var t}function ie(e){if(e instanceof IDBRequest)return t=e,(n=new Promise((function(e,n){var r=function(){t.removeEventListener("success",a),t.removeEventListener("error",i)},a=function(){e(ie(t.result)),r()},i=function(){n(t.error),r()};t.addEventListener("success",a),t.addEventListener("error",i)}))).then((function(e){e instanceof IDBCursor&&Q.set(e,t)})).catch((function(){})),te.set(n,t),n;var t,n;if(ee.has(e))return ee.get(e);var r=ae(e);return r!==e&&(ee.set(e,r),te.set(r,e)),r}var oe=function(e){return te.get(e)};function se(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=n.blocked,a=n.upgrade,i=n.blocking,o=n.terminated,s=indexedDB.open(e,t),c=ie(s);return a&&s.addEventListener("upgradeneeded",(function(e){a(ie(s.result),e.oldVersion,e.newVersion,ie(s.transaction),e)})),r&&s.addEventListener("blocked",(function(e){return r(e.oldVersion,e.newVersion,e)})),c.then((function(e){o&&e.addEventListener("close",(function(){return o()})),i&&e.addEventListener("versionchange",(function(e){return i(e.oldVersion,e.newVersion,e)}))})).catch((function(){})),c}function ce(e){var t=(arguments.length>1&&void 0!==arguments[1]?arguments[1]:{}).blocked,n=indexedDB.deleteDatabase(e);return t&&n.addEventListener("blocked",(function(e){return t(e.oldVersion,e)})),ie(n).then((function(){}))}var ue,fe,pe=["get","getKey","getAll","getAllKeys","count"],le=["put","add","delete","clear"],he=new Map;function de(e,t){if(e instanceof IDBDatabase&&!(t in e)&&"string"==typeof t){if(he.get(t))return he.get(t);var n=t.replace(/FromIndex$/,""),a=t!==n,i=le.includes(n);if(n in(a?IDBIndex:IDBObjectStore).prototype&&(i||pe.includes(n))){var o=function(){var e=r(d().mark((function e(t){var r,o,s,c,u,f,p=arguments;return d().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(o=this.transaction(t,i?"readwrite":"readonly"),s=o.store,c=p.length,u=new Array(c>1?c-1:0),f=1;f<c;f++)u[f-1]=p[f];return a&&(s=s.index(u.shift())),e.next=6,Promise.all([(r=s)[n].apply(r,u),i&&o.done]);case 6:return e.abrupt("return",e.sent[0]);case 7:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}();return he.set(t,o),o}}}ne=function(e){return h(h({},e),{},{get:function(t,n,r){return de(t,n)||e.get(t,n,r)},has:function(t,n){return!!de(t,n)||e.has(t,n)}})}(ne);var ve=function(){return o((function e(t){i(this,e),this.container=t}),[{key:"getPlatformInfoString",value:function(){return this.container.getProviders().map((function(e){if(function(e){var t=e.getComponent();return"VERSION"===(null==t?void 0:t.type)}(e)){var t=e.getImmediate();return"".concat(t.library,"/").concat(t.version)}return null})).filter((function(e){return e})).join(" ")}}])}();var ge="@firebase/app",be="0.10.16",ye=new Y("@firebase/app"),me="[DEFAULT]",we=(c(c(c(c(c(c(c(c(c(c(ue={},ge,"fire-core"),"@firebase/app-compat","fire-core-compat"),"@firebase/analytics","fire-analytics"),"@firebase/analytics-compat","fire-analytics-compat"),"@firebase/app-check","fire-app-check"),"@firebase/app-check-compat","fire-app-check-compat"),"@firebase/auth","fire-auth"),"@firebase/auth-compat","fire-auth-compat"),"@firebase/database","fire-rtdb"),"@firebase/data-connect","fire-data-connect"),c(c(c(c(c(c(c(c(c(c(ue,"@firebase/database-compat","fire-rtdb-compat"),"@firebase/functions","fire-fn"),"@firebase/functions-compat","fire-fn-compat"),"@firebase/installations","fire-iid"),"@firebase/installations-compat","fire-iid-compat"),"@firebase/messaging","fire-fcm"),"@firebase/messaging-compat","fire-fcm-compat"),"@firebase/performance","fire-perf"),"@firebase/performance-compat","fire-perf-compat"),"@firebase/remote-config","fire-rc"),c(c(c(c(c(c(c(c(ue,"@firebase/remote-config-compat","fire-rc-compat"),"@firebase/storage","fire-gcs"),"@firebase/storage-compat","fire-gcs-compat"),"@firebase/firestore","fire-fst"),"@firebase/firestore-compat","fire-fst-compat"),"@firebase/vertexai","fire-vertex"),"fire-js","fire-js"),"firebase","fire-js-all")),ke=new Map,xe=new Map,Se=new Map;function Ie(e,t){try{e.container.addComponent(t)}catch(n){ye.debug("Component ".concat(t.name," failed to register with FirebaseApp ").concat(e.name),n)}}function Ee(e){var t=e.name;if(Se.has(t))return ye.debug("There were multiple attempts to register component ".concat(t,".")),!1;Se.set(t,e);var n,r=s(ke.values());try{for(r.s();!(n=r.n()).done;){Ie(n.value,e)}}catch(e){r.e(e)}finally{r.f()}var a,i=s(xe.values());try{for(i.s();!(a=i.n()).done;){Ie(a.value,e)}}catch(e){i.e(e)}finally{i.f()}return!0}function _e(e,t){var n=e.container.getProvider("heartbeat").getImmediate({optional:!0});return n&&n.triggerHeartbeat(),e.container.getProvider(t)}var Oe=(c(c(c(c(c(c(c(c(c(c(fe={},"no-app","No Firebase App '{$appName}' has been created - call initializeApp() first"),"bad-app-name","Illegal App name: '{$appName}'"),"duplicate-app","Firebase App named '{$appName}' already exists with different options or config"),"app-deleted","Firebase App named '{$appName}' already deleted"),"server-app-deleted","Firebase Server App has been deleted"),"no-options","Need to provide options, when not being deployed to hosting via source."),"invalid-app-argument","firebase.{$appName}() takes either no argument or a Firebase App instance."),"invalid-log-argument","First argument to `onLog` must be null or a function."),"idb-open","Error thrown when opening IndexedDB. Original error: {$originalErrorMessage}."),"idb-get","Error thrown when reading from IndexedDB. Original error: {$originalErrorMessage}."),c(c(c(c(fe,"idb-set","Error thrown when writing to IndexedDB. Original error: {$originalErrorMessage}."),"idb-delete","Error thrown when deleting from IndexedDB. Original error: {$originalErrorMessage}."),"finalization-registry-not-supported","FirebaseServerApp deleteOnDeref field defined but the JS runtime does not support FinalizationRegistry."),"invalid-server-app-environment","FirebaseServerApp is not for use in browser environments.")),Ce=new L("app","Firebase",Oe),De=function(){return o((function e(t,n,r){var a=this;i(this,e),this._isDeleted=!1,this._options=Object.assign({},t),this._config=Object.assign({},n),this._name=n.name,this._automaticDataCollectionEnabled=n.automaticDataCollectionEnabled,this._container=r,this.container.addComponent(new F("app",(function(){return a}),"PUBLIC"))}),[{key:"automaticDataCollectionEnabled",get:function(){return this.checkDestroyed(),this._automaticDataCollectionEnabled},set:function(e){this.checkDestroyed(),this._automaticDataCollectionEnabled=e}},{key:"name",get:function(){return this.checkDestroyed(),this._name}},{key:"options",get:function(){return this.checkDestroyed(),this._options}},{key:"config",get:function(){return this.checkDestroyed(),this._config}},{key:"container",get:function(){return this._container}},{key:"isDeleted",get:function(){return this._isDeleted},set:function(e){this._isDeleted=e}},{key:"checkDestroyed",value:function(){if(this.isDeleted)throw Ce.create("app-deleted",{appName:this._name})}}])}();function Te(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=e;"object"!==m(t)&&(t={name:t});var r=Object.assign({name:me,automaticDataCollectionEnabled:!1},t),a=r.name;if("string"!=typeof a||!a)throw Ce.create("bad-app-name",{appName:String(a)});if(n||(n=D()),!n)throw Ce.create("no-options");var i=ke.get(a);if(i){if(M(n,i.options)&&M(r,i.config))return i;throw Ce.create("duplicate-app",{appName:a})}var o,c=new W(a),u=s(Se.values());try{for(u.s();!(o=u.n()).done;){var f=o.value;c.addComponent(f)}}catch(e){u.e(e)}finally{u.f()}var p=new De(n,r,c);return ke.set(a,p),p}function Ae(e,t,n){var r,a=null!==(r=we[e])&&void 0!==r?r:e;n&&(a+="-".concat(n));var i=a.match(/\s|\//),o=t.match(/\s|\//);if(i||o){var s=['Unable to register library "'.concat(a,'" with version "').concat(t,'":')];return i&&s.push('library name "'.concat(a,'" contains illegal characters (whitespace or "/")')),i&&o&&s.push("and"),o&&s.push('version name "'.concat(t,'" contains illegal characters (whitespace or "/")')),void ye.warn(s.join(" "))}Ee(new F("".concat(a,"-version"),(function(){return{library:a,version:t}}),"VERSION"))}var je="firebase-heartbeat-store",Pe=null;function Le(){return Pe||(Pe=se("firebase-heartbeat-database",1,{upgrade:function(e,t){if(0===t)try{e.createObjectStore(je)}catch(e){console.warn(e)}}}).catch((function(e){throw Ce.create("idb-open",{originalErrorMessage:e.message})}))),Pe}function Ne(e){return Me.apply(this,arguments)}function Me(){return(Me=r(d().mark((function e(t){var n,r,a,i;return d().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Le();case 3:return n=e.sent,r=n.transaction(je),e.next=7,r.objectStore(je).get(Fe(t));case 7:return a=e.sent,e.next=10,r.done;case 10:return e.abrupt("return",a);case 13:e.prev=13,e.t0=e.catch(0),e.t0 instanceof P?ye.warn(e.t0.message):(i=Ce.create("idb-get",{originalErrorMessage:null===e.t0||void 0===e.t0?void 0:e.t0.message}),ye.warn(i.message));case 16:case"end":return e.stop()}}),e,null,[[0,13]])})))).apply(this,arguments)}function Be(e,t){return Re.apply(this,arguments)}function Re(){return(Re=r(d().mark((function e(t,n){var r,a,i,o;return d().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Le();case 3:return r=e.sent,a=r.transaction(je,"readwrite"),i=a.objectStore(je),e.next=8,i.put(n,Fe(t));case 8:return e.next=10,a.done;case 10:e.next=15;break;case 12:e.prev=12,e.t0=e.catch(0),e.t0 instanceof P?ye.warn(e.t0.message):(o=Ce.create("idb-set",{originalErrorMessage:null===e.t0||void 0===e.t0?void 0:e.t0.message}),ye.warn(o.message));case 15:case"end":return e.stop()}}),e,null,[[0,12]])})))).apply(this,arguments)}function Fe(e){return"".concat(e.name,"!").concat(e.options.appId)}var He=function(){return o((function e(t){var n=this;i(this,e),this.container=t,this._heartbeatsCache=null;var r=this.container.getProvider("app").getImmediate();this._storage=new Ue(r),this._heartbeatsCachePromise=this._storage.read().then((function(e){return n._heartbeatsCache=e,e}))}),[{key:"triggerHeartbeat",value:(t=r(d().mark((function e(){var t,n,r,a,i;return d().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,r=this.container.getProvider("platform-logger").getImmediate(),a=r.getPlatformInfoString(),i=Ve(),null!=(null===(t=this._heartbeatsCache)||void 0===t?void 0:t.heartbeats)){e.next=10;break}return e.next=7,this._heartbeatsCachePromise;case 7:if(this._heartbeatsCache=e.sent,null!=(null===(n=this._heartbeatsCache)||void 0===n?void 0:n.heartbeats)){e.next=10;break}return e.abrupt("return");case 10:if(this._heartbeatsCache.lastSentHeartbeatDate!==i&&!this._heartbeatsCache.heartbeats.some((function(e){return e.date===i}))){e.next=14;break}return e.abrupt("return");case 14:this._heartbeatsCache.heartbeats.push({date:i,agent:a});case 15:return this._heartbeatsCache.heartbeats=this._heartbeatsCache.heartbeats.filter((function(e){var t=new Date(e.date).valueOf();return Date.now()-t<=2592e6})),e.abrupt("return",this._storage.overwrite(this._heartbeatsCache));case 19:e.prev=19,e.t0=e.catch(0),ye.warn(e.t0);case 22:case"end":return e.stop()}}),e,this,[[0,19]])}))),function(){return t.apply(this,arguments)})},{key:"getHeartbeatsHeader",value:(e=r(d().mark((function e(){var t,n,r,a,i,o;return d().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,null!==this._heartbeatsCache){e.next=4;break}return e.next=4,this._heartbeatsCachePromise;case 4:if(null!=(null===(t=this._heartbeatsCache)||void 0===t?void 0:t.heartbeats)&&0!==this._heartbeatsCache.heartbeats.length){e.next=6;break}return e.abrupt("return","");case 6:if(n=Ve(),r=Ke(this._heartbeatsCache.heartbeats),a=r.heartbeatsToSend,i=r.unsentEntries,o=E(JSON.stringify({version:2,heartbeats:a})),this._heartbeatsCache.lastSentHeartbeatDate=n,!(i.length>0)){e.next=16;break}return this._heartbeatsCache.heartbeats=i,e.next=14,this._storage.overwrite(this._heartbeatsCache);case 14:e.next=18;break;case 16:this._heartbeatsCache.heartbeats=[],this._storage.overwrite(this._heartbeatsCache);case 18:return e.abrupt("return",o);case 21:return e.prev=21,e.t0=e.catch(0),ye.warn(e.t0),e.abrupt("return","");case 25:case"end":return e.stop()}}),e,this,[[0,21]])}))),function(){return e.apply(this,arguments)})}]);var e,t}();function Ve(){return(new Date).toISOString().substring(0,10)}function Ke(e){var t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1024,r=[],a=e.slice(),i=s(e);try{var o=function(){var e=t.value,i=r.find((function(t){return t.agent===e.agent}));if(i){if(i.dates.push(e.date),ze(r)>n)return i.dates.pop(),0}else if(r.push({agent:e.agent,dates:[e.date]}),ze(r)>n)return r.pop(),0;a=a.slice(1)};for(i.s();!(t=i.n()).done&&0!==o(););}catch(e){i.e(e)}finally{i.f()}return{heartbeatsToSend:r,unsentEntries:a}}var We,Ue=function(){return o((function e(t){i(this,e),this.app=t,this._canUseIndexedDBPromise=this.runIndexedDBEnvironmentCheck()}),[{key:"runIndexedDBEnvironmentCheck",value:(a=r(d().mark((function e(){return d().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(A()){e.next=4;break}return e.abrupt("return",!1);case 4:return e.abrupt("return",j().then((function(){return!0})).catch((function(){return!1})));case 5:case"end":return e.stop()}}),e)}))),function(){return a.apply(this,arguments)})},{key:"read",value:(n=r(d().mark((function e(){var t;return d().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._canUseIndexedDBPromise;case 2:if(e.sent){e.next=7;break}return e.abrupt("return",{heartbeats:[]});case 7:return e.next=9,Ne(this.app);case 9:if(!(null==(t=e.sent)?void 0:t.heartbeats)){e.next=14;break}return e.abrupt("return",t);case 14:return e.abrupt("return",{heartbeats:[]});case 15:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"overwrite",value:(t=r(d().mark((function e(t){var n,r;return d().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._canUseIndexedDBPromise;case 2:if(e.sent){e.next=7;break}return e.abrupt("return");case 7:return e.next=9,this.read();case 9:return r=e.sent,e.abrupt("return",Be(this.app,{lastSentHeartbeatDate:null!==(n=t.lastSentHeartbeatDate)&&void 0!==n?n:r.lastSentHeartbeatDate,heartbeats:t.heartbeats}));case 11:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})},{key:"add",value:(e=r(d().mark((function e(t){var n,r;return d().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._canUseIndexedDBPromise;case 2:if(e.sent){e.next=7;break}return e.abrupt("return");case 7:return e.next=9,this.read();case 9:return r=e.sent,e.abrupt("return",Be(this.app,{lastSentHeartbeatDate:null!==(n=t.lastSentHeartbeatDate)&&void 0!==n?n:r.lastSentHeartbeatDate,heartbeats:[].concat(b(r.heartbeats),b(t.heartbeats))}));case 11:case"end":return e.stop()}}),e,this)}))),function(t){return e.apply(this,arguments)})}]);var e,t,n,a}();function ze(e){return E(JSON.stringify({version:2,heartbeats:e})).length}We="",Ee(new F("platform-logger",(function(e){return new ve(e)}),"PRIVATE")),Ee(new F("heartbeat",(function(e){return new He(e)}),"PRIVATE")),Ae(ge,be,We),Ae(ge,be,"esm2017"),Ae("fire-js","");Ae("firebase","11.0.2","app");var qe="@firebase/installations",$e="0.6.11",Ge=1e4,Je="w:".concat($e),Ye="FIS_v2",Qe=36e5,Xe=c(c(c(c(c(c({},"missing-app-config-values",'Missing App configuration value: "{$valueName}"'),"not-registered","Firebase Installation is not registered."),"installation-not-found","Firebase Installation not found."),"request-failed",'{$requestName} request failed with error "{$serverCode} {$serverStatus}: {$serverMessage}"'),"app-offline","Could not process request. Application offline."),"delete-pending-registration","Can't delete installation while there is a pending registration request."),Ze=new L("installations","Installations",Xe);function et(e){return e instanceof P&&e.code.includes("request-failed")}function tt(e){var t=e.projectId;return"".concat("https://firebaseinstallations.googleapis.com/v1","/projects/").concat(t,"/installations")}function nt(e){return{token:e.token,requestStatus:2,expiresIn:(t=e.expiresIn,Number(t.replace("s","000"))),creationTime:Date.now()};var t}function rt(e,t){return at.apply(this,arguments)}function at(){return(at=r(d().mark((function e(t,n){var r,a;return d().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.json();case 2:return r=e.sent,a=r.error,e.abrupt("return",Ze.create("request-failed",{requestName:t,serverCode:a.code,serverMessage:a.message,serverStatus:a.status}));case 5:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function it(e){var t=e.apiKey;return new Headers({"Content-Type":"application/json",Accept:"application/json","x-goog-api-key":t})}function ot(e,t){var n=t.refreshToken,r=it(e);return r.append("Authorization",function(e){return"".concat(Ye," ").concat(e)}(n)),r}function st(e){return ct.apply(this,arguments)}function ct(){return(ct=r(d().mark((function e(t){var n;return d().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t();case 2:if(!((n=e.sent).status>=500&&n.status<600)){e.next=5;break}return e.abrupt("return",t());case 5:return e.abrupt("return",n);case 6:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function ut(e,t){return ft.apply(this,arguments)}function ft(){return(ft=r(d().mark((function e(t,n){var r,a,i,o,s,c,u,f,p,l,h,v;return d().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.appConfig,a=t.heartbeatServiceProvider,i=n.fid,o=tt(r),s=it(r),!(c=a.getImmediate({optional:!0}))){e.next=10;break}return e.next=8,c.getHeartbeatsHeader();case 8:(u=e.sent)&&s.append("x-firebase-client",u);case 10:return f={fid:i,authVersion:Ye,appId:r.appId,sdkVersion:Je},p={method:"POST",headers:s,body:JSON.stringify(f)},e.next=14,st((function(){return fetch(o,p)}));case 14:if(!(l=e.sent).ok){e.next=23;break}return e.next=18,l.json();case 18:return h=e.sent,v={fid:h.fid||i,registrationStatus:2,refreshToken:h.refreshToken,authToken:nt(h.authToken)},e.abrupt("return",v);case 23:return e.next=25,rt("Create Installation",l);case 25:throw e.sent;case 26:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function pt(e){return new Promise((function(t){setTimeout(t,e)}))}var lt=/^[cdef][\w-]{21}$/;function ht(){try{var e=new Uint8Array(17);(self.crypto||self.msCrypto).getRandomValues(e),e[0]=112+e[0]%16;var t=function(e){var t=(n=e,btoa(String.fromCharCode.apply(String,b(n))).replace(/\+/g,"-").replace(/\//g,"_"));var n;return t.substr(0,22)}(e);return lt.test(t)?t:""}catch(e){return""}}function dt(e){return"".concat(e.appName,"!").concat(e.appId)}var vt=new Map;function gt(e,t){var n=dt(e);bt(n,t),function(e,t){var n=function(){!yt&&"BroadcastChannel"in self&&((yt=new BroadcastChannel("[Firebase] FID Change")).onmessage=function(e){bt(e.data.key,e.data.fid)});return yt}();n&&n.postMessage({key:e,fid:t});0===vt.size&&yt&&(yt.close(),yt=null)}(n,t)}function bt(e,t){var n=vt.get(e);if(n){var r,a=s(n);try{for(a.s();!(r=a.n()).done;){(0,r.value)(t)}}catch(e){a.e(e)}finally{a.f()}}}var yt=null;var mt="firebase-installations-store",wt=null;function kt(){return wt||(wt=se("firebase-installations-database",1,{upgrade:function(e,t){if(0===t)e.createObjectStore(mt)}})),wt}function xt(e,t){return St.apply(this,arguments)}function St(){return(St=r(d().mark((function e(t,n){var r,a,i,o,s;return d().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=dt(t),e.next=3,kt();case 3:return a=e.sent,i=a.transaction(mt,"readwrite"),o=i.objectStore(mt),e.next=8,o.get(r);case 8:return s=e.sent,e.next=11,o.put(n,r);case 11:return e.next=13,i.done;case 13:return s&&s.fid===n.fid||gt(t,n.fid),e.abrupt("return",n);case 15:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function It(e){return Et.apply(this,arguments)}function Et(){return(Et=r(d().mark((function e(t){var n,r,a;return d().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=dt(t),e.next=3,kt();case 3:return r=e.sent,a=r.transaction(mt,"readwrite"),e.next=7,a.objectStore(mt).delete(n);case 7:return e.next=9,a.done;case 9:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function _t(e,t){return Ot.apply(this,arguments)}function Ot(){return(Ot=r(d().mark((function e(t,n){var r,a,i,o,s,c;return d().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=dt(t),e.next=3,kt();case 3:return a=e.sent,i=a.transaction(mt,"readwrite"),o=i.objectStore(mt),e.next=8,o.get(r);case 8:if(s=e.sent,void 0!==(c=n(s))){e.next=15;break}return e.next=13,o.delete(r);case 13:e.next=17;break;case 15:return e.next=17,o.put(c,r);case 17:return e.next=19,i.done;case 19:return!c||s&&s.fid===c.fid||gt(t,c.fid),e.abrupt("return",c);case 21:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Ct(e){return Dt.apply(this,arguments)}function Dt(){return(Dt=r(d().mark((function e(t){var n,r;return d().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,_t(t.appConfig,(function(e){var r=Tt(e),a=At(t,r);return n=a.registrationPromise,a.installationEntry}));case 2:if(""!==(r=e.sent).fid){e.next=8;break}return e.next=6,n;case 6:return e.t0=e.sent,e.abrupt("return",{installationEntry:e.t0});case 8:return e.abrupt("return",{installationEntry:r,registrationPromise:n});case 9:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Tt(e){return Mt(e||{fid:ht(),registrationStatus:0})}function At(e,t){if(0===t.registrationStatus){if(!navigator.onLine)return{installationEntry:t,registrationPromise:Promise.reject(Ze.create("app-offline"))};var n={fid:t.fid,registrationStatus:1,registrationTime:Date.now()},r=function(e,t){return jt.apply(this,arguments)}(e,n);return{installationEntry:n,registrationPromise:r}}return 1===t.registrationStatus?{installationEntry:t,registrationPromise:Pt(e)}:{installationEntry:t}}function jt(){return(jt=r(d().mark((function e(t,n){var r;return d().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,ut(t,n);case 3:return r=e.sent,e.abrupt("return",xt(t.appConfig,r));case 7:if(e.prev=7,e.t0=e.catch(0),!et(e.t0)||409!==e.t0.customData.serverCode){e.next=14;break}return e.next=12,It(t.appConfig);case 12:e.next=16;break;case 14:return e.next=16,xt(t.appConfig,{fid:n.fid,registrationStatus:0});case 16:throw e.t0;case 17:case"end":return e.stop()}}),e,null,[[0,7]])})))).apply(this,arguments)}function Pt(e){return Lt.apply(this,arguments)}function Lt(){return(Lt=r(d().mark((function e(t){var n,r,a,i;return d().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Nt(t.appConfig);case 2:n=e.sent;case 3:if(1!==n.registrationStatus){e.next=11;break}return e.next=6,pt(100);case 6:return e.next=8,Nt(t.appConfig);case 8:n=e.sent,e.next=3;break;case 11:if(0!==n.registrationStatus){e.next=22;break}return e.next=14,Ct(t);case 14:if(r=e.sent,a=r.installationEntry,!(i=r.registrationPromise)){e.next=21;break}return e.abrupt("return",i);case 21:return e.abrupt("return",a);case 22:return e.abrupt("return",n);case 23:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Nt(e){return _t(e,(function(e){if(!e)throw Ze.create("installation-not-found");return Mt(e)}))}function Mt(e){return 1===(t=e).registrationStatus&&t.registrationTime+Ge<Date.now()?{fid:e.fid,registrationStatus:0}:e;var t}function Bt(e,t){return Rt.apply(this,arguments)}function Rt(){return(Rt=r(d().mark((function e(t,n){var r,a,i,o,s,c,u,f,p,l,h;return d().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.appConfig,a=t.heartbeatServiceProvider,i=Ft(r,n),o=ot(r,n),!(s=a.getImmediate({optional:!0}))){e.next=9;break}return e.next=7,s.getHeartbeatsHeader();case 7:(c=e.sent)&&o.append("x-firebase-client",c);case 9:return u={installation:{sdkVersion:Je,appId:r.appId}},f={method:"POST",headers:o,body:JSON.stringify(u)},e.next=13,st((function(){return fetch(i,f)}));case 13:if(!(p=e.sent).ok){e.next=22;break}return e.next=17,p.json();case 17:return l=e.sent,h=nt(l),e.abrupt("return",h);case 22:return e.next=24,rt("Generate Auth Token",p);case 24:throw e.sent;case 25:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Ft(e,t){var n=t.fid;return"".concat(tt(e),"/").concat(n,"/authTokens:generate")}function Ht(e){return Vt.apply(this,arguments)}function Vt(){return Vt=r(d().mark((function e(t){var n,r,a,i,o=arguments;return d().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=o.length>1&&void 0!==o[1]&&o[1],e.next=3,_t(t.appConfig,(function(e){if(!$t(e))throw Ze.create("not-registered");var a=e.authToken;if(!n&&Gt(a))return e;if(1===a.requestStatus)return r=Kt(t,n),e;if(!navigator.onLine)throw Ze.create("app-offline");var i=Jt(e);return r=zt(t,i),i}));case 3:if(a=e.sent,!r){e.next=10;break}return e.next=7,r;case 7:e.t0=e.sent,e.next=11;break;case 10:e.t0=a.authToken;case 11:return i=e.t0,e.abrupt("return",i);case 13:case"end":return e.stop()}}),e)}))),Vt.apply(this,arguments)}function Kt(e,t){return Wt.apply(this,arguments)}function Wt(){return(Wt=r(d().mark((function e(t,n){var r,a;return d().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Ut(t.appConfig);case 2:r=e.sent;case 3:if(1!==r.authToken.requestStatus){e.next=11;break}return e.next=6,pt(100);case 6:return e.next=8,Ut(t.appConfig);case 8:r=e.sent,e.next=3;break;case 11:if(0!==(a=r.authToken).requestStatus){e.next=16;break}return e.abrupt("return",Ht(t,n));case 16:return e.abrupt("return",a);case 17:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Ut(e){return _t(e,(function(e){if(!$t(e))throw Ze.create("not-registered");var t,n=e.authToken;return 1===(t=n).requestStatus&&t.requestTime+Ge<Date.now()?Object.assign(Object.assign({},e),{authToken:{requestStatus:0}}):e}))}function zt(e,t){return qt.apply(this,arguments)}function qt(){return(qt=r(d().mark((function e(t,n){var r,a,i;return d().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Bt(t,n);case 3:return r=e.sent,a=Object.assign(Object.assign({},n),{authToken:r}),e.next=7,xt(t.appConfig,a);case 7:return e.abrupt("return",r);case 10:if(e.prev=10,e.t0=e.catch(0),!et(e.t0)||401!==e.t0.customData.serverCode&&404!==e.t0.customData.serverCode){e.next=17;break}return e.next=15,It(t.appConfig);case 15:e.next=20;break;case 17:return i=Object.assign(Object.assign({},n),{authToken:{requestStatus:0}}),e.next=20,xt(t.appConfig,i);case 20:throw e.t0;case 21:case"end":return e.stop()}}),e,null,[[0,10]])})))).apply(this,arguments)}function $t(e){return void 0!==e&&2===e.registrationStatus}function Gt(e){return 2===e.requestStatus&&!function(e){var t=Date.now();return t<e.creationTime||e.creationTime+e.expiresIn<t+Qe}(e)}function Jt(e){var t={requestStatus:1,requestTime:Date.now()};return Object.assign(Object.assign({},e),{authToken:t})}function Yt(){return(Yt=r(d().mark((function e(t){var n,r,a,i;return d().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t,e.next=3,Ct(n);case 3:return r=e.sent,a=r.installationEntry,(i=r.registrationPromise)?i.catch(console.error):Ht(n).catch(console.error),e.abrupt("return",a.fid);case 8:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Qt(){return Qt=r(d().mark((function e(t){var n,r,a,i=arguments;return d().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=i.length>1&&void 0!==i[1]&&i[1],r=t,e.next=4,Xt(r);case 4:return e.next=6,Ht(r,n);case 6:return a=e.sent,e.abrupt("return",a.token);case 8:case"end":return e.stop()}}),e)}))),Qt.apply(this,arguments)}function Xt(e){return Zt.apply(this,arguments)}function Zt(){return(Zt=r(d().mark((function e(t){var n,r;return d().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Ct(t);case 2:if(n=e.sent,!(r=n.registrationPromise)){e.next=7;break}return e.next=7,r;case 7:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function en(e){return Ze.create("missing-app-config-values",{valueName:e})}var tn,nn="installations",rn=function(e){var t=_e(e.getProvider("app").getImmediate(),nn).getImmediate(),n={getId:function(){return function(e){return Yt.apply(this,arguments)}(t)},getToken:function(e){return function(e){return Qt.apply(this,arguments)}(t,e)}};return n};Ee(new F(nn,(function(e){var t=e.getProvider("app").getImmediate(),n=function(e){if(!e||!e.options)throw en("App Configuration");if(!e.name)throw en("App Name");for(var t=0,n=["projectId","apiKey","appId"];t<n.length;t++){var r=n[t];if(!e.options[r])throw en(r)}return{appName:e.name,projectId:e.options.projectId,apiKey:e.options.apiKey,appId:e.options.appId}}(t);return{app:t,appConfig:n,heartbeatServiceProvider:_e(t,"heartbeat"),_delete:function(){return Promise.resolve()}}}),"PUBLIC")),Ee(new F("installations-internal",rn,"PRIVATE")),Ae(qe,$e),Ae(qe,$e,"esm2017");var an,on,sn="BDOU99-h67HcA6JeFXHbSNMu7e2yNNu3RzoMj8TM4W88jITfq7ZmPvIM1Iv-4_l2LxQcYwhqby2xGpWwzjfAnG4",cn="google.c.a.c_id";function un(e){var t=new Uint8Array(e);return btoa(String.fromCharCode.apply(String,b(t))).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}function fn(e){for(var t=(e+"=".repeat((4-e.length%4)%4)).replace(/\-/g,"+").replace(/_/g,"/"),n=atob(t),r=new Uint8Array(n.length),a=0;a<n.length;++a)r[a]=n.charCodeAt(a);return r}!function(e){e[e.DATA_MESSAGE=1]="DATA_MESSAGE",e[e.DISPLAY_NOTIFICATION=3]="DISPLAY_NOTIFICATION"}(an||(an={})),function(e){e.PUSH_RECEIVED="push-received",e.NOTIFICATION_CLICKED="notification-clicked"}(on||(on={}));var pn="fcm_token_details_db",ln="fcm_token_object_Store";function hn(e){return dn.apply(this,arguments)}function dn(){return dn=r(d().mark((function e(t){var n,a,i;return d().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!("databases"in indexedDB)){e.next=7;break}return e.next=3,indexedDB.databases();case 3:if(n=e.sent,a=n.map((function(e){return e.name})),a.includes(pn)){e.next=7;break}return e.abrupt("return",null);case 7:return i=null,e.next=10,se(pn,5,{upgrade:function(){var e=r(d().mark((function e(n,r,a,o){var s,c,u,f,p,l;return d().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(r<2)){e.next=2;break}return e.abrupt("return");case 2:if(n.objectStoreNames.contains(ln)){e.next=4;break}return e.abrupt("return");case 4:return c=o.objectStore(ln),e.next=7,c.index("fcmSenderId").get(t);case 7:return u=e.sent,e.next=10,c.clear();case 10:if(u){e.next=12;break}return e.abrupt("return");case 12:if(2!==r){e.next=19;break}if((f=u).auth&&f.p256dh&&f.endpoint){e.next=16;break}return e.abrupt("return");case 16:i={token:f.fcmToken,createTime:null!==(s=f.createTime)&&void 0!==s?s:Date.now(),subscriptionOptions:{auth:f.auth,p256dh:f.p256dh,endpoint:f.endpoint,swScope:f.swScope,vapidKey:"string"==typeof f.vapidKey?f.vapidKey:un(f.vapidKey)}},e.next=20;break;case 19:3===r?i={token:(p=u).fcmToken,createTime:p.createTime,subscriptionOptions:{auth:un(p.auth),p256dh:un(p.p256dh),endpoint:p.endpoint,swScope:p.swScope,vapidKey:un(p.vapidKey)}}:4===r&&(i={token:(l=u).fcmToken,createTime:l.createTime,subscriptionOptions:{auth:un(l.auth),p256dh:un(l.p256dh),endpoint:l.endpoint,swScope:l.swScope,vapidKey:un(l.vapidKey)}});case 20:case"end":return e.stop()}}),e)})));return function(t,n,r,a){return e.apply(this,arguments)}}()});case 10:return e.sent.close(),e.next=14,ce(pn);case 14:return e.next=16,ce("fcm_vapid_details_db");case 16:return e.next=18,ce("undefined");case 18:return e.abrupt("return",vn(i)?i:null);case 19:case"end":return e.stop()}}),e)}))),dn.apply(this,arguments)}function vn(e){if(!e||!e.subscriptionOptions)return!1;var t=e.subscriptionOptions;return"number"==typeof e.createTime&&e.createTime>0&&"string"==typeof e.token&&e.token.length>0&&"string"==typeof t.auth&&t.auth.length>0&&"string"==typeof t.p256dh&&t.p256dh.length>0&&"string"==typeof t.endpoint&&t.endpoint.length>0&&"string"==typeof t.swScope&&t.swScope.length>0&&"string"==typeof t.vapidKey&&t.vapidKey.length>0}var gn="firebase-messaging-store",bn=null;function yn(){return bn||(bn=se("firebase-messaging-database",1,{upgrade:function(e,t){if(0===t)e.createObjectStore(gn)}})),bn}function mn(e){return wn.apply(this,arguments)}function wn(){return(wn=r(d().mark((function e(t){var n,r,a,i;return d().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=Sn(t),e.next=3,yn();case 3:return r=e.sent,e.next=6,r.transaction(gn).objectStore(gn).get(n);case 6:if(!(a=e.sent)){e.next=11;break}return e.abrupt("return",a);case 11:return e.next=13,hn(t.appConfig.senderId);case 13:if(!(i=e.sent)){e.next=18;break}return e.next=17,kn(t,i);case 17:return e.abrupt("return",i);case 18:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function kn(e,t){return xn.apply(this,arguments)}function xn(){return(xn=r(d().mark((function e(t,n){var r,a,i;return d().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=Sn(t),e.next=3,yn();case 3:return a=e.sent,i=a.transaction(gn,"readwrite"),e.next=7,i.objectStore(gn).put(n,r);case 7:return e.next=9,i.done;case 9:return e.abrupt("return",n);case 10:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Sn(e){return e.appConfig.appId}var In=(c(c(c(c(c(c(c(c(c(c(tn={},"missing-app-config-values",'Missing App configuration value: "{$valueName}"'),"only-available-in-window","This method is available in a Window context."),"only-available-in-sw","This method is available in a service worker context."),"permission-default","The notification permission was not granted and dismissed instead."),"permission-blocked","The notification permission was not granted and blocked instead."),"unsupported-browser","This browser doesn't support the API's required to use the Firebase SDK."),"indexed-db-unsupported","This browser doesn't support indexedDb.open() (ex. Safari iFrame, Firefox Private Browsing, etc)"),"failed-service-worker-registration","We are unable to register the default service worker. {$browserErrorMessage}"),"token-subscribe-failed","A problem occurred while subscribing the user to FCM: {$errorInfo}"),"token-subscribe-no-token","FCM returned no token when subscribing the user to push."),c(c(c(c(c(c(c(c(tn,"token-unsubscribe-failed","A problem occurred while unsubscribing the user from FCM: {$errorInfo}"),"token-update-failed","A problem occurred while updating the user from FCM: {$errorInfo}"),"token-update-no-token","FCM returned no token when updating the user to push."),"use-sw-after-get-token","The useServiceWorker() method may only be called once and must be called before calling getToken() to ensure your service worker is used."),"invalid-sw-registration","The input to useServiceWorker() must be a ServiceWorkerRegistration."),"invalid-bg-handler","The input to setBackgroundMessageHandler() must be a function."),"invalid-vapid-key","The public VAPID key must be a string."),"use-vapid-key-after-get-token","The usePublicVapidKey() method may only be called once and must be called before calling getToken() to ensure your VAPID key is used.")),En=new L("messaging","Messaging",In);function _n(e,t){return On.apply(this,arguments)}function On(){return(On=r(d().mark((function e(t,n){var r,a,i,o,s,c;return d().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Pn(t);case 2:return r=e.sent,a=Nn(n),i={method:"POST",headers:r,body:JSON.stringify(a)},e.prev=5,e.next=8,fetch(jn(t.appConfig),i);case 8:return s=e.sent,e.next=11,s.json();case 11:o=e.sent,e.next=17;break;case 14:throw e.prev=14,e.t0=e.catch(5),En.create("token-subscribe-failed",{errorInfo:null===e.t0||void 0===e.t0?void 0:e.t0.toString()});case 17:if(!o.error){e.next=20;break}throw c=o.error.message,En.create("token-subscribe-failed",{errorInfo:c});case 20:if(o.token){e.next=22;break}throw En.create("token-subscribe-no-token");case 22:return e.abrupt("return",o.token);case 23:case"end":return e.stop()}}),e,null,[[5,14]])})))).apply(this,arguments)}function Cn(e,t){return Dn.apply(this,arguments)}function Dn(){return(Dn=r(d().mark((function e(t,n){var r,a,i,o,s,c;return d().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Pn(t);case 2:return r=e.sent,a=Nn(n.subscriptionOptions),i={method:"PATCH",headers:r,body:JSON.stringify(a)},e.prev=5,e.next=8,fetch("".concat(jn(t.appConfig),"/").concat(n.token),i);case 8:return s=e.sent,e.next=11,s.json();case 11:o=e.sent,e.next=17;break;case 14:throw e.prev=14,e.t0=e.catch(5),En.create("token-update-failed",{errorInfo:null===e.t0||void 0===e.t0?void 0:e.t0.toString()});case 17:if(!o.error){e.next=20;break}throw c=o.error.message,En.create("token-update-failed",{errorInfo:c});case 20:if(o.token){e.next=22;break}throw En.create("token-update-no-token");case 22:return e.abrupt("return",o.token);case 23:case"end":return e.stop()}}),e,null,[[5,14]])})))).apply(this,arguments)}function Tn(e,t){return An.apply(this,arguments)}function An(){return(An=r(d().mark((function e(t,n){var r,a,i,o,s;return d().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Pn(t);case 2:return r=e.sent,a={method:"DELETE",headers:r},e.prev=4,e.next=7,fetch("".concat(jn(t.appConfig),"/").concat(n),a);case 7:return i=e.sent,e.next=10,i.json();case 10:if(!(o=e.sent).error){e.next=14;break}throw s=o.error.message,En.create("token-unsubscribe-failed",{errorInfo:s});case 14:e.next=19;break;case 16:throw e.prev=16,e.t0=e.catch(4),En.create("token-unsubscribe-failed",{errorInfo:null===e.t0||void 0===e.t0?void 0:e.t0.toString()});case 19:case"end":return e.stop()}}),e,null,[[4,16]])})))).apply(this,arguments)}function jn(e){var t=e.projectId;return"".concat("https://fcmregistrations.googleapis.com/v1","/projects/").concat(t,"/registrations")}function Pn(e){return Ln.apply(this,arguments)}function Ln(){return(Ln=r(d().mark((function e(t){var n,r,a;return d().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.appConfig,r=t.installations,e.next=3,r.getToken();case 3:return a=e.sent,e.abrupt("return",new Headers({"Content-Type":"application/json",Accept:"application/json","x-goog-api-key":n.apiKey,"x-goog-firebase-installations-auth":"FIS ".concat(a)}));case 5:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Nn(e){var t=e.p256dh,n=e.auth,r=e.endpoint,a=e.vapidKey,i={web:{endpoint:r,auth:n,p256dh:t}};return a!==sn&&(i.web.applicationPubKey=a),i}function Mn(e){return Bn.apply(this,arguments)}function Bn(){return(Bn=r(d().mark((function e(t){var n,r,a;return d().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Kn(t.swRegistration,t.vapidKey);case 2:return n=e.sent,r={vapidKey:t.vapidKey,swScope:t.swRegistration.scope,endpoint:n.endpoint,auth:un(n.getKey("auth")),p256dh:un(n.getKey("p256dh"))},e.next=6,mn(t.firebaseDependencies);case 6:if(a=e.sent){e.next=11;break}return e.abrupt("return",Hn(t.firebaseDependencies,r));case 11:if(i=a.subscriptionOptions,s=void 0,c=void 0,u=void 0,f=void 0,s=(o=r).vapidKey===i.vapidKey,c=o.endpoint===i.endpoint,u=o.auth===i.auth,f=o.p256dh===i.p256dh,s&&c&&u&&f){e.next=23;break}return e.prev=12,e.next=15,Tn(t.firebaseDependencies,a.token);case 15:e.next=20;break;case 17:e.prev=17,e.t0=e.catch(12),console.warn(e.t0);case 20:return e.abrupt("return",Hn(t.firebaseDependencies,r));case 23:if(!(Date.now()>=a.createTime+6048e5)){e.next=27;break}return e.abrupt("return",Rn(t,{token:a.token,createTime:Date.now(),subscriptionOptions:r}));case 27:return e.abrupt("return",a.token);case 28:case"end":return e.stop()}var i,o,s,c,u,f}),e,null,[[12,17]])})))).apply(this,arguments)}function Rn(e,t){return Fn.apply(this,arguments)}function Fn(){return(Fn=r(d().mark((function e(t,n){var r,a;return d().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Cn(t.firebaseDependencies,n);case 3:return r=e.sent,a=Object.assign(Object.assign({},n),{token:r,createTime:Date.now()}),e.next=7,kn(t.firebaseDependencies,a);case 7:return e.abrupt("return",r);case 10:throw e.prev=10,e.t0=e.catch(0),e.t0;case 13:case"end":return e.stop()}}),e,null,[[0,10]])})))).apply(this,arguments)}function Hn(e,t){return Vn.apply(this,arguments)}function Vn(){return(Vn=r(d().mark((function e(t,n){var r,a;return d().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,_n(t,n);case 2:return r=e.sent,a={token:r,createTime:Date.now(),subscriptionOptions:n},e.next=6,kn(t,a);case 6:return e.abrupt("return",a.token);case 7:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Kn(e,t){return Wn.apply(this,arguments)}function Wn(){return(Wn=r(d().mark((function e(t,n){var r;return d().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.pushManager.getSubscription();case 2:if(!(r=e.sent)){e.next=5;break}return e.abrupt("return",r);case 5:return e.abrupt("return",t.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:fn(n)}));case 6:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Un(e){var t={from:e.from,collapseKey:e.collapse_key,messageId:e.fcmMessageId};return function(e,t){if(!t.notification)return;e.notification={};var n=t.notification.title;n&&(e.notification.title=n);var r=t.notification.body;r&&(e.notification.body=r);var a=t.notification.image;a&&(e.notification.image=a);var i=t.notification.icon;i&&(e.notification.icon=i)}(t,e),function(e,t){if(!t.data)return;e.data=t.data}(t,e),function(e,t){var n,r,a,i,o;if(!t.fcmOptions&&!(null===(n=t.notification)||void 0===n?void 0:n.click_action))return;e.fcmOptions={};var s=null!==(a=null===(r=t.fcmOptions)||void 0===r?void 0:r.link)&&void 0!==a?a:null===(i=t.notification)||void 0===i?void 0:i.click_action;s&&(e.fcmOptions.link=s);var c=null===(o=t.fcmOptions)||void 0===o?void 0:o.analytics_label;c&&(e.fcmOptions.analyticsLabel=c)}(t,e),t}function zn(e){return En.create("missing-app-config-values",{valueName:e})}var qn=function(){return o((function e(t,n,r){i(this,e),this.deliveryMetricsExportedToBigQueryEnabled=!1,this.onBackgroundMessageHandler=null,this.onMessageHandler=null,this.logEvents=[],this.isLogServiceStarted=!1;var a=function(e){if(!e||!e.options)throw zn("App Configuration Object");if(!e.name)throw zn("App Name");for(var t=e.options,n=0,r=["projectId","apiKey","appId","messagingSenderId"];n<r.length;n++){var a=r[n];if(!t[a])throw zn(a)}return{appName:e.name,projectId:t.projectId,apiKey:t.apiKey,appId:t.appId,senderId:t.messagingSenderId}}(t);this.firebaseDependencies={app:t,appConfig:a,installations:n,analyticsProvider:r}}),[{key:"_delete",value:function(){return Promise.resolve()}}])}();function $n(e){return Gn.apply(this,arguments)}function Gn(){return(Gn=r(d().mark((function e(t){return d().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,navigator.serviceWorker.register("/firebase-messaging-sw.js",{scope:"/firebase-cloud-messaging-push-scope"});case 3:t.swRegistration=e.sent,t.swRegistration.update().catch((function(){})),e.next=10;break;case 7:throw e.prev=7,e.t0=e.catch(0),En.create("failed-service-worker-registration",{browserErrorMessage:null===e.t0||void 0===e.t0?void 0:e.t0.message});case 10:case"end":return e.stop()}}),e,null,[[0,7]])})))).apply(this,arguments)}function Jn(e,t){return Yn.apply(this,arguments)}function Yn(){return(Yn=r(d().mark((function e(t,n){return d().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n||t.swRegistration){e.next=3;break}return e.next=3,$n(t);case 3:if(n||!t.swRegistration){e.next=5;break}return e.abrupt("return");case 5:if(n instanceof ServiceWorkerRegistration){e.next=7;break}throw En.create("invalid-sw-registration");case 7:t.swRegistration=n;case 8:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Qn(e,t){return Xn.apply(this,arguments)}function Xn(){return(Xn=r(d().mark((function e(t,n){return d().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n?t.vapidKey=n:t.vapidKey||(t.vapidKey=sn);case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Zn(e,t){return er.apply(this,arguments)}function er(){return(er=r(d().mark((function e(t,n){return d().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(navigator){e.next=2;break}throw En.create("only-available-in-window");case 2:if("default"!==Notification.permission){e.next=5;break}return e.next=5,Notification.requestPermission();case 5:if("granted"===Notification.permission){e.next=7;break}throw En.create("permission-blocked");case 7:return e.next=9,Qn(t,null==n?void 0:n.vapidKey);case 9:return e.next=11,Jn(t,null==n?void 0:n.serviceWorkerRegistration);case 11:return e.abrupt("return",Mn(t));case 12:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function tr(e,t,n){return nr.apply(this,arguments)}function nr(){return(nr=r(d().mark((function e(t,n,r){var a;return d().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=rr(n),e.next=3,t.firebaseDependencies.analyticsProvider.get();case 3:e.sent.logEvent(a,{message_id:r[cn],message_name:r["google.c.a.c_l"],message_time:r["google.c.a.ts"],message_device_time:Math.floor(Date.now()/1e3)});case 5:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function rr(e){switch(e){case on.NOTIFICATION_CLICKED:return"notification_open";case on.PUSH_RECEIVED:return"notification_foreground";default:throw new Error}}function ar(){return(ar=r(d().mark((function e(t,n){var r,a;return d().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((r=n.data).isFirebaseMessaging){e.next=3;break}return e.abrupt("return");case 3:if(t.onMessageHandler&&r.messageType===on.PUSH_RECEIVED&&("function"==typeof t.onMessageHandler?t.onMessageHandler(Un(r)):t.onMessageHandler.next(Un(r))),a=r.data,"object"!==m(i=a)||!i||!(cn in i)||"1"!==a["google.c.a.e"]){e.next=8;break}return e.next=8,tr(t,r.messageType,a);case 8:case"end":return e.stop()}var i}),e)})))).apply(this,arguments)}var ir="@firebase/messaging",or="0.12.14",sr=function(e){var t=new qn(e.getProvider("app").getImmediate(),e.getProvider("installations-internal").getImmediate(),e.getProvider("analytics-internal"));return navigator.serviceWorker.addEventListener("message",(function(e){return function(e,t){return ar.apply(this,arguments)}(t,e)})),t},cr=function(e){var t=e.getProvider("messaging").getImmediate();return{getToken:function(e){return Zn(t,e)}}};function ur(){return(ur=r(d().mark((function e(){return d().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,j();case 3:e.next=8;break;case 5:return e.prev=5,e.t0=e.catch(0),e.abrupt("return",!1);case 8:return e.abrupt("return","undefined"!=typeof window&&A()&&!("undefined"==typeof navigator||!navigator.cookieEnabled)&&"serviceWorker"in navigator&&"PushManager"in window&&"Notification"in window&&"fetch"in window&&ServiceWorkerRegistration.prototype.hasOwnProperty("showNotification")&&PushSubscription.prototype.hasOwnProperty("getKey"));case 9:case"end":return e.stop()}}),e,null,[[0,5]])})))).apply(this,arguments)}function fr(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:me,t=ke.get(e);if(!t&&e===me&&D())return Te();if(!t)throw Ce.create("no-app",{appName:e});return t}();return function(){return ur.apply(this,arguments)}().then((function(e){if(!e)throw En.create("unsupported-browser")}),(function(e){throw En.create("indexed-db-unsupported")})),_e(R(e),"messaging").getImmediate()}function pr(){return(pr=r(d().mark((function e(t,n){return d().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=R(t),e.abrupt("return",Zn(t,n));case 2:case"end":return e.stop()}}),e)})))).apply(this,arguments)}Ee(new F("messaging",sr,"PUBLIC")),Ee(new F("messaging-internal",cr,"PRIVATE")),Ae(ir,or),Ae(ir,or,"esm2017"),e.getToken=function(e,t){return pr.apply(this,arguments)},e.init=function(e){var t=Te(e);return{app:t,messaging:fr(t)}},e.onMessage=function(e,t){return function(e,t){if(!navigator)throw En.create("only-available-in-window");return e.onMessageHandler=t,function(){e.onMessageHandler=null}}(e=R(e),t)}}));


define('chat_inits',[
	'config/chat',
	'lib/cookies',
	'lib/storage',
	'libs/c3r18y25p16t',
	'lib/i18n!front',
	'log_and_tooltip',
	'libs/firebase.amd'
], function(config, cookies, xv_storage, cryptojs, i18n, log_and_tooltip, Firebase) {
	var FIREBASE_VAPID_KEY = 'BAQGhqmqKGk7riH9fYwONu6rbO4tq9rumN_J-3c-rBp2VtdaPD46elUhs0MSxGPzWmuAQDjsTAh_3-4xaAuauMs';
	var chat_inits_and_prefs = function(change_status_fct)
	{
		this.service_worker_file = config.workers_path + 'js/workers/chat-prive-sw.js';
		this.shared_worker_file = config.workers_path + 'js/workers/chat-prive-shared.js';
		
		this.notif = false;
		this.notif_allowed = true;

		this.serviceWorker = null;
		
		this.sound = false;
		this.blur_images = false;
		this.mini_disabled = 0;
		this.notif_permission_asked = false;
		
		this.status = "Online";
		if ( typeof config.prefs.invisible && config.prefs.invisible ) {
			this.status = "Invisible";
		}

		this.change_status_fct = change_status_fct;
		this.set_timer_away();

		this.notif_asked_permission_done = null;
		this.notif_asked_time = 0;
	};
	
	chat_inits_and_prefs.prototype = {
		
		initKey: function(ignoreCookie) {
			var priv_key = "";
			
			var CryptoJSAesJson = {
				stringify: function (cipherParams) {
					var j = {ct: cipherParams.ciphertext.toString(cryptojs.enc.Base64)};
					if (cipherParams.iv) j.iv = cipherParams.iv.toString();
					if (cipherParams.salt) j.s = cipherParams.salt.toString();
					return JSON.stringify(j);
				},
				parse: function (jsonStr) {
					var j = JSON.parse(jsonStr);
					var cipherParams = cryptojs.lib.CipherParams.create({ciphertext: cryptojs.enc.Base64.parse(j.ct)});
					if (j.iv) cipherParams.iv = cryptojs.enc.Hex.parse(j.iv);
					if (j.s) cipherParams.salt = cryptojs.enc.Hex.parse(j.s);
					return cipherParams;
				}
			};

			var encrypted = cookies.get("chat_data_c");
			if (!ignoreCookie && encrypted) {
				try {
					priv_key = JSON.parse(cryptojs.AES.decrypt(encrypted, config.login_info.id+"", {format: CryptoJSAesJson}).toString(cryptojs.enc.Utf8));
				}
				catch (e) {
					wglog.error("chat_inits::initKey failed to decrypt key", e.message, e);
					priv_key = "";
				}

				if ( priv_key !=  "" ) {
					xv_storage.set("chat-pk", encrypted);
					cookies.setLocal( "chat_data_c" , "", 0, "/", true, "Strict");
				} else {
					cookies.setLocal( "chat_data_c" , encrypted, 2592000*1000, "/", true, "Strict");
				}
			}

			if ( priv_key == "" ) {
				try {
					var encrypted_pk = xv_storage.get("chat-pk");
					if (encrypted_pk) {
						try {
							priv_key = JSON.parse(cryptojs.AES.decrypt(encrypted_pk, config.login_info.id+"", {format: CryptoJSAesJson}).toString(cryptojs.enc.Utf8));
						}
						catch (e) {
							wglog.error("chat_inits::initKey failed to decrypt key");
							priv_key = "";
						}
					}
				} catch (e) {
					wglog.error('chat_inits::initKey Storage get chat-pk exception', e.message );
				}
			}
			
			if ( priv_key == "") {
				return false;
			}
			
			return priv_key;
		},
		
		initNotif: function (inputnotif) {
			if (!("Notification" in window)) {
				wglog.info("chat_inits::initNotif This browser does not support desktop notification");
				this.notif_allowed = false;
				return false;
			}
			
			this.notif_allowed = true;
			this.notif_permission_asked = true;
			
			if (typeof config == 'undefined' || typeof config.prefs == 'undefined') {
				wglog.error('chat_inits::initNotif unable to get prefs');
				return;
			}
			
			if ( Notification.permission === 'denied' || Notification.permission === 'default' ) {
				if ( typeof xv_storage.get('chat_notif_asked') == 'undefined' || xv_storage.get('chat_notif_asked') == 0 ) {
					this.notif_permission_asked = false;
				}
			} else if (this.notif_allowed && typeof xv_storage.get("chat_notification") !== 'undefined' && xv_storage.get("chat_notification") == 1) {
				this.notif = true;
				inputnotif.prop('checked', this.notif);
			}
		},
		
		setNotif: function(notif) {
			this.notif = notif;
			if (notif) {
				xv_storage.set("chat_notification", 1);
			} else {
				xv_storage.set("chat_notification", 0);
			}
		},
		
		initSharedWorker: function( connect_fct, connect_sw_fct, reinit_fct) {
			if( !window.SharedWorker ){
				wglog.info("chat_inits::initSharedWorker Browser doesn't support shared worker");
				this.shared_worker_no_support = true;
				return;
			}
			
			try {
				this.shared_worker = new SharedWorker(this.shared_worker_file);
				
				this.shared_worker.port.start();
				
				this.shared_status = "close";
			} catch (e) {
				wglog.error("chat_inits::initSharedWorker init shared_worker error", e.message);
				this.shared_worker_no_support = true;
				return;
			}
			
			var self = this;
			
			this.shared_worker.port.addEventListener("message", function(e) {
				if ( !e.data.hasOwnProperty("action")) {
					return;
				}
				
				if (e.data.action == "open" && self.shared_status == "close") {
					self.shared_status = "open";
					if (self.serviceWorker) {
						connect_sw_fct();
					} else {
						connect_fct();
					}
				}
				if (e.data.action == "close" && self.shared_status == "open") {
					self.shared_status = "close";
					reinit_fct();
				}
				if (e.data.action == "opened") {
				}
			}, false);
			
			window.addEventListener('unload', function() {
				self.shared_worker.port.postMessage( { "action": "unload" });
			});
			
			document.addEventListener('visibilitychange', function () {
				if ( document.visibilityState == "visible" && typeof self.shared_worker != "undefined" && typeof self.shared_worker.port != "undefined" ) {
					self.shared_worker.port.postMessage( { "action": "focus" } );
				}
			}, false);
			
		},
		
		initServiceWorker: function (connect_fct, connect_sw_fct, serviceWorkerOnMessage, setSwToken) {
			if (!"serviceWorker" in navigator || typeof navigator.serviceWorker === "undefined") {
				wglog.debug("chat_inits::initServiceWorker serviceWorker not available");
				connect_fct();
				return;
			}

			this.firebase_messaging = false;
			if (("Notification" in window) && typeof Notification !== "undefined" && Notification.permission !== "denied") {
				try {
					this.firebase_messaging = Firebase.init(config.firebase).messaging;
					wglog.debug("chat_inits::initServiceWorker FCM init initialized");
				} catch (e) {
					wglog.error("chat_inits::initServiceWorker FCM init failed", e.message);
				}
			}

			var self = this;
			navigator.serviceWorker.register(this.service_worker_file)
				.then(function (registration) {
					self.service_worker_register = true;
					self.serviceWorkerRegistration = registration;

					if (self.notif && self.firebase_messaging) {
						var promise = null;

						if (Notification.permission === 'granted') {
							wglog.debug("chat_inits::initServiceWorker Notification permission already granted");
							promise = Firebase.getToken(self.firebase_messaging, {
								serviceWorkerRegistration: registration,
								vapidKey: FIREBASE_VAPID_KEY
							});
						} else {
							wglog.debug("chat_inits::initServiceWorker Notification permission default or denied");
							promise = Notification.requestPermission()
								.then(function (permission) {
									wglog.debug("chat_inits::initServiceWorker Notification permission:", permission);
									return Firebase.getToken(self.firebase_messaging, {
										serviceWorkerRegistration: registration,
										vapidKey: FIREBASE_VAPID_KEY
									});
								});
						}

						promise.then(function (token) {
								wglog.debug("chat_inits::initServiceWorker FCM token", token);
								setSwToken(token);
							})
							["catch"](function (err) {
								wglog.error("chat_inits::initServiceWorker FCM permission or token request error", err);
								connect_fct();
							});
					}

					if (registration.active) {
						self.serviceWorker = registration.active;
						navigator.serviceWorker.onmessage = function (e) {serviceWorkerOnMessage(e);};
					}

					if (document.visibilityState === "visible" && typeof self.shared_worker !== "undefined" && typeof self.shared_worker.port != "undefined") {
						self.shared_worker.port.postMessage({"action": "focus"});
					}
					connect_sw_fct();
				})
				["catch"](function (err) {
					wglog.error("chat_inits::initServiceWorker FCM registration error", err);
					if (document.visibilityState === "visible") {
						if (typeof self.shared_worker != "undefined" && typeof self.shared_worker.port != "undefined") {
							self.shared_worker.port.postMessage({"action": "focus"});
						}
						connect_fct();
					}
				});
		},

		getFaviconUrl: function(bestSize) {
			const links = document.getElementsByTagName('link'),
				_bestSize = bestSize || 96;

			let currentSizeDiff = Math.abs(_bestSize - 10000),
				currentUrl = '';

			for (let link of links) {
				if (link.rel !== 'icon' && link.rel !== 'shortcut icon' && !link.rel.includes('icon')) {
					continue;
				}

				if (!link.sizes && !currentUrl) {
					currentUrl = link.href;
					continue;
				}

				const linkSize = +link.sizes.value.split('x')[0],
					linkSizeDiff = Math.abs(_bestSize - linkSize);

				if (linkSizeDiff < currentSizeDiff) {
					currentSizeDiff = linkSizeDiff;
					currentUrl = link.href;
				}
			}

			return currentUrl;
		},

		getServiceWorkerConfig: function () {
			return {
				chatUri: window.location.origin + window.location.pathname,
				chatConversationUri: window.location.origin + window.location.pathname + '#conversation_',
				logger: window.wglog,
				title: i18n.__('chat.notification.new_message'),
				options: {
					body: '',
					icon: this.getFaviconUrl(64),
					badge: this.getFaviconUrl(64),
				}
			};
		},

		checkNotifPermissionAsked: function(setSWTokenFct) {

			if (!this.notif_permission_asked && ("Notification" in window) && Notification && Notification.permission !== "granted" && $("#chat-window .chat-title").length > 0) {
				var text_popup = "<h4>" + i18n.__('chat.activate_notification') + "</h4>";
				text_popup += '<p class="chat_popup_buttons"><button id="chat_permission_ask">' + i18n.__('misc.yes') + '</button><button id="chat_permission_not_ask">' + i18n.__('misc.no') + '</button></p>';
				
				log_and_tooltip.popup_open( $("#chat-window .chat-title") , text_popup, {trigger: false, autoclose: false});

				var self = this;

				$( "#chat_permission_ask" ).on("click", function(event) {
					event.stopPropagation();
					log_and_tooltip.popup_close();
					self.notif_permission_asked = true;
					xv_storage.set("chat_notif_asked", 1);
					if ( Notification.permission === 'denied' ) {
						log_and_tooltip.popup_open( $("#chat-window .chat-settings"), "<p>" + i18n.__('chat.infos.notification_refused') + "</p>", {trigger: false} )
						return;
					} else if ( Notification.permission === 'default' )  {
						self.askNotifPermission(setSWTokenFct);
					}
				});
				$( "#chat_permission_not_ask" ).on("click", function(event) {
					event.stopPropagation();
					self.notif_permission_asked = true;
					xv_storage.set("chat_notif_asked", 1);
					log_and_tooltip.popup_close();
				});
			}
		},
		
		askNotifPermission: function(setSWTokenFct) {
			if (!("Notification" in window)) {
				wglog.debug("chat_inits::askNotifPermission askNotifPermission", "Browser don't support Notif");
				return false;
			}
			if (!Notification || Notification.permission == "denied") {
				wglog.debug("chat_inits::askNotifPermission askNotifPermission", "already denied");
				return false;
			}
			if (Notification.permission == "granted") {
				wglog.debug("chat_inits::askNotifPermission askNotifPermission", "already granted");
				return true;
			}
			var self = this;
			if ( Notification.permission === 'default' )  {
				var now = (new Date()).getTime();
				// if notif already asked and didn't do anything since less than 2 min -> display "notif blocked by browser"
				// -> can occurs with the option in chrome "quieter notification prompts"
				if (this.notif_asked_permission_done === false && (now - this.notif_asked_time) < (2*60*1000)) {
					log_and_tooltip.popup_open( $("#chat-window .chat-settings"), "<p>" + i18n.__('chat.infos.notification_refused') + "</p>", {trigger: false} )
				}
				this.notif_asked_permission_done = false;
				this.notif_asked_time = (new Date()).getTime();
				Notification.requestPermission()
					.then(function() {
						self.notif_asked_permission_done = true;
						if (Notification.permission == "granted") {
							wglog.debug("chat_inits::askNotifPermission askNotifPermission", "granted");
							self.setNotif(true);
							setTimeout(function(){self.getTokenFromSW(setSWTokenFct, 2);}, 3000);
							return true;
						}
						return false;
					})
					["catch"](function (err) {
					self.notif_asked_permission_done = true;
					if (Notification.permission === "granted") {
						wglog.error("chat_inits::askNotifPermission failed to get SW token, will retry in 5s.", err);
						self.setNotif(true);
						setTimeout(function(){self.getTokenFromSW(setSWTokenFct, 1);}, 5000);
					} else {
						wglog.error("chat_inits::askNotifPermission Notification init failed.", err);
					}
				});
			}
		},
		
		getTokenFromSW: function(setSWTokenFct, nb_retry) {
			
			if (!("Notification" in window) || Notification.permission !== "granted" || !this.firebase_messaging || !this.serviceWorkerRegistration) {
				return false;
			}
			var self = this;

			Firebase.getToken(this.firebase_messaging, {
				serviceWorkerRegistration: this.serviceWorkerRegistration,
				vapidKey: FIREBASE_VAPID_KEY
			})
				.then(function(token) {
					wglog.debug("chat_inits::getTokenFromSW get SW token : " + token);
					setSWTokenFct(token);
				})
				["catch"](function (err) {
					wglog.error("chat_inits::getTokenFromSW failed.", err);
					if (nb_retry && nb_retry === parseInt(nb_retry) && nb_retry > 0) {
						setTimeout(function(){self.getTokenFromSW(setSWTokenFct, nb_retry - 1);}, 3000);
					}
				});
		},
		
		removeServiceWorker: function () {
			if ("serviceWorker" in navigator) {
				
				navigator.serviceWorker.getRegistrations().then(function (registrations) {
					for (var i in registrations) {
						registrations[i].unregister();
					}
				});
				
			}
			
			this.service_worker_register = false;
		},

        initSettings: function( change_status_fct, emit_change_pref_fct, toggle_home_fct, chat_icon_home, node, setSwTokenFct, removeSwTokenFct, initCreatorMessages) {
			this.change_status_fct = change_status_fct;
			this.emit_change_pref_fct = emit_change_pref_fct;
			this.remove_SW_token_fct = removeSwTokenFct;
			this.init_creator_messages = initCreatorMessages;

			this.settings_list_is_visible = false;
			this.settings_icon = $(".chat-settings");
			this.settings_list = $("#chat-settings-list");
			var self = this;
			
			this.settings_icon.on('click', this.settings_icon_on_click.bind(this));
			$(".chat-settings-list__close").on('click', this.settings_close_on_click.bind(this));

			// Status setting
			if (config.settings_menu_items.status_switch_enabled) {
				$("#chat-setting-status").on('change', '[name="chat-setting-status"]',function (e) {
					switch (this.dataset.value) {
						case "away":
							self.change_status_fct("Away");
							break;
						case "invisible":
							self.change_status_fct("Invisible");
							break;
						case "online":
							self.change_status_fct("Online");
							break;
					}
				});
			}
			
			if (this.status === "Invisible") {
				$("#chat-setting-status-invisible").prop("checked", true);
			} else {
				$("#chat-setting-status-online").prop("checked", true);
			}
			
			// Size/zoom setting
			var zoom = this.get_size();
			this.change_size( zoom, node );
			
			if (config.settings_menu_items.size_switch_enabled) {
				$("#chat-setting-size").on('change', '[name="chat-setting-size"]',function (e) {
					switch (this.dataset.value) {
						case "big":
							self.change_size(2, node);
							break;
						case "medium":
							self.change_size(1, node);
							break;
						case "small":
							self.change_size(0, node);
							break;
					}
				});
			}
			
			// Sound setting
			this.sound_setting = $("#chat-setting-sound");
			
			if (config.settings_menu_items.sound_enabled) {
				this.sound_setting.on('change', this.switch_sound.bind(this));
			}
			
			if (typeof config.prefs.sound !== 'undefined') {
				this.sound = (config.prefs.sound == true);
			} else {
				this.sound = false;
			}
			
			this.sound_setting.prop("checked", this.sound);
			
			// Notification setting.
			this.notif_setting = $("#chat-setting-notification")
			this.notif_setting.prop("checked", this.notif);
			
			if (config.settings_menu_items.notification_enabled) {
				this.notif_setting.on("change", function (event) {
					event.stopPropagation();
					self.switch_notification(setSwTokenFct);
				});
			}
			
			// Color/theme setting
			var color = this.get_messages_color();
			this.change_messages_color( color, node );
			
			if (config.settings_menu_items.color_switch_enabled) {
				$("#chat-setting-theme").on('change', '[name="chat-setting-theme"]',function (event) {
					switch (this.dataset.value) {
						case "color0":
							self.change_messages_color(0, node, event);
							break;
						case "color1":
							self.change_messages_color(1, node, event);
							break;
						case "color2":
							self.change_messages_color(2, node, event);
							break;
						case "color3":
							self.change_messages_color(3, node, event);
							break;
					}
				});
			}
			
			// Home toggler
			chat_icon_home.on('click', function (event) {
				toggle_home_fct(event);
			});
			
			// Mini chat display
			this.mini_chat_disabled_setting = $("#chat-setting-mini-chat");
			
			if (config.settings_menu_items.disable_mini_chat_enabled) {
				this.mini_chat_disabled_setting.on('change', this.deactivate_chat_on_website.bind(this));
			}
			
			if (typeof config.prefs.mini_disabled !== 'undefined') {
				this.mini_disabled = (config.prefs.mini_disabled == true);
			} else {
				this.mini_disabled = false;
			}
			
			// Blur images
			this.blur_images_setting = $("#chat-setting-blur-images");
			
			if (config.settings_menu_items.blur_images_enabled) {
				this.blur_images_setting.on('change', this.switch_blur_image.bind(this));
			}
			
			if (typeof config.prefs.blur_images !== 'undefined') {
				this.blur_images = (config.prefs.blur_images == true);
			} else {
				this.blur_images = false;
			}
		},
		
		settings_close_on_click: function (event) {
			this.settings_list_hide();
		},
		
		settings_icon_on_click: function (event) {
			event.stopPropagation();
			this.settings_list_toggle();
		},
		
		settings_list_on_click_outside: function (event) {
			var target = $(event.target);
			if (target.is('.chat-settings-list') === false && target.parents('.chat-settings-list').length === 0) {
				this.settings_list_hide();
			}
		},
		
		settings_list_show: function () {
			$(document).on('click.settings_click_outside', this.settings_list_on_click_outside.bind(this));
			this.settings_list.show();
			this.settings_icon.addClass('show');
			this.settings_list_is_visible = true;
		},
		
		settings_list_hide: function () {
			$(document).off('click.settings_click_outside');
			this.settings_list.hide();
			this.settings_icon.removeClass('show');
			this.settings_list_is_visible = false;
		},
		
		settings_list_toggle: function () {
			if (this.settings_list_is_visible) {
				this.settings_list_hide();
			} else {
				this.settings_list_show();
			}
		},

		creator_messages_close_on_click: function (event) {
			this.creator_messages_list_hide();
		},

		creator_messages_on_click: function (event) {
			event.stopPropagation();
			this.creator_messages_list_toggle();
		},

		creator_messages_list_on_click_outside: function (event) {
			var target = $(event.target);
			if (target.is('.chat-creator-messages-list') === false && target.parents('.chat-creator-messages-list').length === 0) {
				this.creator_messages_list_hide();
			}
		},

		creator_messages_list_show: function () {
			$(document).on('click.creator_messages_click_outside', this.creator_messages_list_on_click_outside.bind(this));
			this.creator_messages_list.show();
			this.creator_messages_icon.addClass('show');
			this.creator_messages_list_is_visible = true;
		},

		creator_messages_list_hide: function () {
			$(document).off('click.creator_messages_click_outside');
			this.creator_messages_list.hide();
			this.creator_messages_icon.removeClass('show');
			this.creator_messages_list_is_visible = false;
		},

		creator_messages_list_toggle: function () {
			if (this.creator_messages_list_is_visible) {
				this.creator_messages_list_hide();
			} else {
				this.creator_messages_list_show();
			}
		},

		get_size: function() {
			var zoom = 0;
			
			zoom = xv_storage.get("chat-size");
			if ( zoom != 0 && zoom != 1 && zoom != 2 ) {
				return 0;
			}
			return zoom;
		},
		
		change_size: function(zoom, node) {
			this.set_timer_away();
			
			node.find('[name="chat-setting-size"]').prop('checked', false);
			
			node.removeClass("zoom1 zoom2");
			
			if ( zoom == 0 ) {
				this.set_size(0);
				node.find('#chat-setting-size-small').prop('checked', true);
			}
			if ( zoom == 1 ) {
				node.addClass("zoom1");
				this.set_size(1);
				node.find('#chat-setting-size-medium').prop('checked', true);
			}
			if ( zoom == 2 ) {
				node.addClass("zoom2");
				this.set_size(2);
				node.find('#chat-setting-size-big').prop('checked', true);
			}
		},
		
		set_size: function(zoom) {
			xv_storage.set("chat-size", zoom);
		},
		
		get_messages_color: function() {
			if (!config.color_switch_enabled) {
				return 0;
			}
			
			return xv_storage.get("chat-color") || 0;
		},
		
		change_messages_color: function(color, node, event) {
			this.set_timer_away();
			if ( typeof event != "undefined" ) {
				event.stopPropagation();
			}
			
			this.set_messages_color(color);
			
			node.find('[name="chat-setting-theme"]').prop('checked', false);
			node.find('#chat-setting-theme-color' + color).prop('checked', true);
			
			node.removeClass("color1 color2 color3");
			if (color !== 0) {
				node.addClass("color" + color);
			}
		},
		
		set_messages_color: function(color) {
			if (color !== 0 && color !== 1 && color !== 2 && color !== 3) {
				wglog.error("chat_inits::set_messages_color bad color for set_message_color : " + color);
				return;
			}
			xv_storage.set("chat-color", color);
		},
		
		switch_sound:function() {
			this.set_timer_away();
			
			this.sound = !this.sound;
			
			this.emit_change_pref_fct(this.sound ? 1 : 0, this.mini_disabled, this.blur_images);
		},
		
		play_notif: function() {
			if (!this.sound) {
				return;
			}
			var notif = $( '#mess_notif' );
			if (!notif[0]) {
				return;
			}
			notif[0].play();
		},
		
		switch_notification: function(setSwTokenFct) {
			this.set_timer_away();
			
			if ( this.notif === true ) {
				wglog.debug("chat_inits::switch_notification", "emit notif -> false");
				this.setNotif(false);
				this.remove_SW_token_fct();
				return;
			}
			
			if ( !this.notif_allowed || !("Notification" in window) ) {
				this.settings_list.toggle();
				log_and_tooltip.popup_open( $("#chat-window .chat-settings"), "<p>" + i18n.__('chat.infos.no_support_notification') + "</p>" )
				return;
			}
			
			if (Notification.permission === 'denied') {
				this.settings_list.toggle();
				log_and_tooltip.popup_open( $("#chat-window .chat-settings"), "<p>" + i18n.__('chat.infos.notification_refused') + "</p>" )
				return;
			}
			
			if (Notification.permission === 'default') {
				wglog.debug('chat_inits::switch_notification asking for desktop notification permission');
				this.askNotifPermission(setSwTokenFct);
				return;
			}
			
			if ( this.notif === false ) {
				wglog.debug("chat_inits::switch_notification", "emit notif -> true");
				this.setNotif(true);
				this.getTokenFromSW(setSwTokenFct, 2);
				return;
			}
		},
		
		switch_blur_image: function(force_to) {
			this.set_timer_away();
			
			if (typeof force_to === "boolean") {
				this.blur_images = force_to;
				this.blur_images_setting.prop('checked', force_to);
			} else {
				this.blur_images = !this.blur_images;
			}
			
			wglog.debug('chat_inits::switch_blur_image switch blur images ', this.blur_images);
			this.emit_change_pref_fct(this.sound, this.mini_disabled, this.blur_images ? 1 : 0);
		},
		
		deactivate_chat_on_website: function() {
			this.set_timer_away();
			
			this.mini_disabled = !this.mini_disabled;
			
			this.emit_change_pref_fct(this.sound, this.mini_disabled ? 1 : 0, this.blur_images);
		},
		
		set_change_prefs:function(data, reinit_chat_fct) {
			if (typeof data.prefs !== 'undefined') {
				if (typeof data.prefs.mini_disabled !== 'undefined' && data.prefs.mini_disabled != this.mini_disabled) {
					this.mini_disabled = data.prefs.mini_disabled == true;
					this.sound_setting.prop('checked', this.mini_disabled);
					
					if (this.mini_disabled && $("#account-chat-private-container").length === 0 ) {
						reinit_chat_fct();
						$("#chat-window").remove();
					}
				}
				
				if (typeof data.prefs.blur_images !== 'undefined' && data.prefs.blur_images != this.blur_images ) {
					this.blur_images = data.prefs.blur_images == true;
					this.blur_images_setting.prop('checked', this.blur_images);
				}
				
				if (typeof data.prefs.sound !== 'undefined' && data.prefs.sound != this.sound ) {
					this.sound = data.prefs.sound == true;
					this.sound_setting.prop('checked', this.sound);
				}
			}
			
			if (typeof data[config.cookie_name] !== 'undefined') {
				wglog.debug('chat_inits::set_change_prefs set cookie');
				cookies.setLocal( config.cookie_name , data[config.cookie_name], 0, "/");
				
			}
		},
		
		set_timer_away: function() {
			if ( this.status == "Invisible" && this.timer_away == false ) {
				return;
			}
			if ( typeof this.timer_away !== "undefined" && this.timer_away != false ) {
				clearTimeout( this.timer_away );
			}
			if ( this.status == "Invisible" ) {
				this.timer_away = false;
				return;
			} else {
				var self = this;
				this.timer_away = setTimeout(function() {
					self.change_status_fct("Away");
				}, 10*60*1000);
			}
			if ( this.status == "Away" ) {
				this.change_status_fct("Online");
			}
		},
		
	};
	
	return chat_inits_and_prefs;
	
});
define('libs/EventEmitter',[], function () {
	/** @version 5.0.1 */
	/**
	 * Custom-changes:
	 * - Code inserted into define().
	 * - Avoid returning event emitter instance as context default and prefer window.
	 * - setup singleton
	 */

	'use strict';

	var has = Object.prototype.hasOwnProperty
		, prefix = '~'
		, instance = null;

	/**
	 * Constructor to create a storage for our `EE` objects.
	 * An `Events` instance is a plain object whose properties are event names.
	 *
	 * @constructor
	 * @private
	 */
	function Events() {}

	//
	// We try to not inherit from `Object.prototype`. In some engines creating an
	// instance in this way is faster than calling `Object.create(null)` directly.
	// If `Object.create(null)` is not supported we prefix the event names with a
	// character to make sure that the built-in object properties are not
	// overridden or used as an attack vector.
	//
	if (Object.create) {
		Events.prototype = Object.create(null);

		//
		// This hack is needed because the `__proto__` property is still inherited in
		// some old browsers like Android 4, iPhone 5.1, Opera 11 and Safari 5.
		//
		if (!new Events().__proto__) prefix = false;
	}

	/**
	 * Representation of a single event listener.
	 *
	 * @param {Function} fn The listener function.
	 * @param {*} context The context to invoke the listener with.
	 * @param {Boolean} [once=false] Specify if the listener is a one-time listener.
	 * @constructor
	 * @private
	 */
	function EE(fn, context, once) {
		this.fn = fn;
		this.context = context;
		this.once = once || false;
	}

	/**
	 * Add a listener for a given event.
	 *
	 * @param {EventEmitter} emitter Reference to the `EventEmitter` instance.
	 * @param {(String|Symbol)} event The event name.
	 * @param {Function} fn The listener function.
	 * @param {*} context The context to invoke the listener with.
	 * @param {Boolean} once Specify if the listener is a one-time listener.
	 * @returns {EventEmitter}
	 * @private
	 */
	function addListener(emitter, event, fn, context, once) {
		if (typeof fn !== 'function') {
			throw new TypeError('The listener must be a function');
		}

		var listener = new EE(fn, context || window, once)
			, evt = prefix ? prefix + event : event;

		if (!emitter._events[evt]) emitter._events[evt] = listener, emitter._eventsCount++;
		else if (!emitter._events[evt].fn) emitter._events[evt].push(listener);
		else emitter._events[evt] = [emitter._events[evt], listener];

		return emitter;
	}

	/**
	 * Clear event by name.
	 *
	 * @param {EventEmitter} emitter Reference to the `EventEmitter` instance.
	 * @param {(String|Symbol)} evt The Event name.
	 * @private
	 */
	function clearEvent(emitter, evt) {
		if (--emitter._eventsCount === 0) emitter._events = new Events();
		else delete emitter._events[evt];
	}

	/**
	 * Minimal `EventEmitter` interface that is molded against the Node.js
	 * `EventEmitter` interface.
	 *
	 * @constructor
	 * @public
	 */
	function EventEmitter() {
		this._events = new Events();
		this._eventsCount = 0;
	}

	/**
	 * Return an array listing the events for which the emitter has registered
	 * listeners.
	 *
	 * @returns {Array}
	 * @public
	 */
	EventEmitter.prototype.eventNames = function eventNames() {
		var names = []
			, events
			, name;

		if (this._eventsCount === 0) return names;

		for (name in (events = this._events)) {
			if (has.call(events, name)) names.push(prefix ? name.slice(1) : name);
		}

		if (Object.getOwnPropertySymbols) {
			return names.concat(Object.getOwnPropertySymbols(events));
		}

		return names;
	};

	/**
	 * Return the listeners registered for a given event.
	 *
	 * @param {(String|Symbol)} event The event name.
	 * @returns {Array} The registered listeners.
	 * @public
	 */
	EventEmitter.prototype.listeners = function listeners(event) {
		var evt = prefix ? prefix + event : event
			, handlers = this._events[evt];

		if (!handlers) return [];
		if (handlers.fn) return [handlers.fn];

		for (var i = 0, l = handlers.length, ee = new Array(l); i < l; i++) {
			ee[i] = handlers[i].fn;
		}

		return ee;
	};

	/**
	 * Return the number of listeners listening to a given event.
	 *
	 * @param {(String|Symbol)} event The event name.
	 * @returns {Number} The number of listeners.
	 * @public
	 */
	EventEmitter.prototype.listenerCount = function listenerCount(event) {
		var evt = prefix ? prefix + event : event
			, listeners = this._events[evt];

		if (!listeners) return 0;
		if (listeners.fn) return 1;
		return listeners.length;
	};

	/**
	 * Calls each of the listeners registered for a given event.
	 *
	 * @param {(String|Symbol)} event The event name.
	 * @returns {Boolean} `true` if the event had listeners, else `false`.
	 * @public
	 */
	EventEmitter.prototype.emit = function emit(event, a1, a2, a3, a4, a5) {
		var evt = prefix ? prefix + event : event;

		if (!this._events[evt]) return false;

		var listeners = this._events[evt]
			, len = arguments.length
			, args
			, i;

		if (listeners.fn) {
			if (listeners.once) this.removeListener(event, listeners.fn, undefined, true);

			switch (len) {
				case 1: return listeners.fn.call(listeners.context), true;
				case 2: return listeners.fn.call(listeners.context, a1), true;
				case 3: return listeners.fn.call(listeners.context, a1, a2), true;
				case 4: return listeners.fn.call(listeners.context, a1, a2, a3), true;
				case 5: return listeners.fn.call(listeners.context, a1, a2, a3, a4), true;
				case 6: return listeners.fn.call(listeners.context, a1, a2, a3, a4, a5), true;
			}

			for (i = 1, args = new Array(len -1); i < len; i++) {
				args[i - 1] = arguments[i];
			}

			listeners.fn.apply(listeners.context, args);
		} else {
			var length = listeners.length
				, j;

			for (i = 0; i < length; i++) {
				if (listeners[i].once) this.removeListener(event, listeners[i].fn, undefined, true);

				switch (len) {
					case 1: listeners[i].fn.call(listeners[i].context); break;
					case 2: listeners[i].fn.call(listeners[i].context, a1); break;
					case 3: listeners[i].fn.call(listeners[i].context, a1, a2); break;
					case 4: listeners[i].fn.call(listeners[i].context, a1, a2, a3); break;
					default:
						if (!args) for (j = 1, args = new Array(len -1); j < len; j++) {
							args[j - 1] = arguments[j];
						}

						listeners[i].fn.apply(listeners[i].context, args);
				}
			}
		}

		return true;
	};

	/**
	 * Add a listener for a given event.
	 *
	 * @param {(String|Symbol)} event The event name.
	 * @param {Function} fn The listener function.
	 * @param {*} [context=this] The context to invoke the listener with.
	 * @returns {EventEmitter} `this`.
	 * @public
	 */
	EventEmitter.prototype.on = function on(event, fn, context) {
		return addListener(this, event, fn, context, false);
	};

	/**
	 * Add a one-time listener for a given event.
	 *
	 * @param {(String|Symbol)} event The event name.
	 * @param {Function} fn The listener function.
	 * @param {*} [context=this] The context to invoke the listener with.
	 * @returns {EventEmitter} `this`.
	 * @public
	 */
	EventEmitter.prototype.once = function once(event, fn, context) {
		return addListener(this, event, fn, context, true);
	};

	/**
	 * Remove the listeners of a given event.
	 *
	 * @param {(String|Symbol)} event The event name.
	 * @param {Function} fn Only remove the listeners that match this function.
	 * @param {*} context Only remove the listeners that have this context.
	 * @param {Boolean} once Only remove one-time listeners.
	 * @returns {EventEmitter} `this`.
	 * @public
	 */
	EventEmitter.prototype.removeListener = function removeListener(event, fn, context, once) {
		var evt = prefix ? prefix + event : event;

		if (!this._events[evt]) return this;
		if (!fn) {
			clearEvent(this, evt);
			return this;
		}

		var listeners = this._events[evt];

		if (listeners.fn) {
			if (
				listeners.fn === fn &&
				(!once || listeners.once) &&
				(!context || listeners.context === context)
			) {
				clearEvent(this, evt);
			}
		} else {
			for (var i = 0, events = [], length = listeners.length; i < length; i++) {
				if (
					listeners[i].fn !== fn ||
					(once && !listeners[i].once) ||
					(context && listeners[i].context !== context)
				) {
					events.push(listeners[i]);
				}
			}

			//
			// Reset the array, or remove it completely if we have no more listeners.
			//
			if (events.length) this._events[evt] = events.length === 1 ? events[0] : events;
			else clearEvent(this, evt);
		}

		return this;
	};

	/**
	 * Remove all listeners, or those of the specified event.
	 *
	 * @param {(String|Symbol)} [event] The event name.
	 * @returns {EventEmitter} `this`.
	 * @public
	 */
	EventEmitter.prototype.removeAllListeners = function removeAllListeners(event) {
		var evt;

		if (event) {
			evt = prefix ? prefix + event : event;
			if (this._events[evt]) clearEvent(this, evt);
		} else {
			this._events = new Events();
			this._eventsCount = 0;
		}

		return this;
	};

	//
	// Alias methods names because people roll like that.
	//
	EventEmitter.prototype.off = EventEmitter.prototype.removeListener;
	EventEmitter.prototype.addListener = EventEmitter.prototype.on;

	//
	// Expose the prefix.
	//
	EventEmitter.prefixed = prefix;

	//
	// Allow `EventEmitter` to be imported as module namespace.
	//
	EventEmitter.EventEmitter = EventEmitter;

	//
	// Expose the module.
	//
	if ('undefined' !== typeof module) {
		module.exports = EventEmitter;
	}

	EventEmitter.getInstance = function () {
		if (null === instance) {
			instance = new EventEmitter();
		}
		return instance;
	}

	return EventEmitter.getInstance();
});
define('core/CommandMap',[
	'libs/EventEmitter'
], function(
	EventEmitter
) {
	/**
	 * @constructor
	 */
	var CommandMap = function(context, mediatorMap) {
		this.context = context;
		this.mediatorMap = mediatorMap;
		this.eventMap = new Map();
	};

	CommandMap.prototype = {
		createClassFromEvent(eventType, args) {
			var classDef = this.getClassDef(eventType),
				classesDefs = Array.isArray(classDef) ? classDef : [classDef];

			classesDefs.forEach(classDef => {
				new classDef(this.context, this, this.mediatorMap).execute(...args);
			});
		},
		getClassDef: function(eventType) {
			if (!this.eventMap.has(eventType)) {
				throw new Error('No classDef for this eventType :' + eventType);
			}
			return this.eventMap.get(eventType);
		},
		getEventsFromClassDef: function (classDef) {
			var events = [];

			for (let [key, value] of this.eventMap.entries()) {
				if (value === classDef)
					events.push(key);
			}

			return events;
		},
		getEventTypes: function () {
			return Array.from(this.eventMap.keys());
		},
		mapEvent: function(eventType, classDef) {
			if (typeof eventType !== 'string') {
				throw new TypeError('eventType is invalid');
			}

			if (typeof classDef === 'undefined' || classDef === null) {
				throw new TypeError('classDef is invalid');
			}

			var valueToSet = classDef;

			if (this.eventMap.has(eventType)) {
				var existingClassDef = this.eventMap.get(eventType);

				if (existingClassDef === classDef) {
					throw new Error(eventType + ' already exists');
				}

				if (Array.isArray(existingClassDef)) {
					valueToSet = existingClassDef;
				} else {
					valueToSet = [existingClassDef];
				}

				valueToSet.push(classDef);
			}

			this.eventMap.set(eventType, valueToSet);
		},
		registerEvents: function () {
			var eventTypes = this.getEventTypes();
			var self = this;
			for (var eventType of eventTypes) {
				var forClosure = function (eventTypeParam) {
					EventEmitter.on(eventTypeParam, function () { self.createClassFromEvent(eventTypeParam, arguments); });
				}
				forClosure(eventType);
			}
		},
	};

	return CommandMap;
});
define('core/ContextEvent',[], function () {
	var ContextEvent = Object.create(null);

	Object.defineProperties(ContextEvent, {
		STARTUP: {value: 'startup.context', writable: false}
	});

	return ContextEvent;
});
define('core/ViewEvent',[], function () {
	var ViewEvent = Object.create(null);

	Object.defineProperties(ViewEvent, {
		CREATED: {value: 'created.view', writable: false},
		REMOVED: {value: 'removed.view', writable: false},
	});

	return ViewEvent;
});
define('core/MediatorMap',[
	'core/ViewEvent',
	'lib/tools',
	'libs/EventEmitter'
], function(
	ViewEvent,
	tools,
	EventEmitter
) {
	/**
	 * @constructor
	 */
	var MediatorMap = function(context) {
		this.context = context;
		this.eventMap = new Map();
		this.mediatorMap = new Map();
		this.addListeners();
	};

	MediatorMap.prototype = {
		addListeners: function () {
			EventEmitter.on(ViewEvent.CREATED, this.onViewCreated.bind(this));
			EventEmitter.on(ViewEvent.REMOVED, this.onViewRemoved.bind(this));
		},
		createMediator: function (view, mediatorClassDef) {
			var mediator = new mediatorClassDef(view, this.context);
			this.registerEvents(mediatorClassDef, mediator);

			mediator.ready();
		},
		eventMapHas: function (eventType, classDef, methodName) {
			if (!this.eventMap.has(eventType)) {
				return false;
			}

			var value = this.eventMap.get(eventType);

			if (value.length < 1) {
				return false;
			}

			for (var item of value) {
				if (item[0] === classDef && item[1] === methodName) {
					return true;
				}
			}

			return false;
		},
		getEventsFromClassDef: function (classDef) {
			var events = [];

			for (var [key, value] of this.eventMap.entries()) {
				for (var item of value) {
					if (item[0] === classDef) {
						events.push({eventType: key, mediator: item[0], method: item[1]});
					}
				}
			}

			return events;
		},
		mapEvent: function(eventType, classDef, methodName) {
			if (typeof eventType !== 'string') {
				throw new TypeError('eventType is invalid');
			}

			if (typeof classDef === 'undefined' || classDef === null) {
				throw new TypeError('classDef is invalid');
			}

			if (typeof methodName !== 'string') {
				throw new TypeError('methodName is invalid');
			}

			if (typeof classDef.prototype[methodName] !== 'function') {
				throw new TypeError('methodName not found in classDef prototype');
			}

			if (this.eventMapHas(eventType, classDef, methodName)) {
				return;
			}

			var value = this.eventMap.get(eventType) || [];

			value.push([classDef, methodName]);

			this.eventMap.set(eventType, value);
		},
		mapView: function(viewClassDef, mediatorClassDef) {
			if (typeof viewClassDef === 'undefined' || viewClassDef === null) {
				throw new TypeError('viewClassDef is invalid');
			}

			if (typeof mediatorClassDef === 'undefined' || mediatorClassDef === null) {
				throw new TypeError('mediatorClassDef is invalid');
			}

			if (this.mediatorMap.has(viewClassDef)) {
				throw new Error('viewClassDef is already mapped with mediatorClassDef');
			}

			this.mediatorMap.set(viewClassDef.prototype, mediatorClassDef);
		},
		onViewCreated: function (view) {
			var viewPrototype = Object.getPrototypeOf(view),
				mediatorClassDef = this.mediatorMap.get(viewPrototype);

			if ("undefined" === typeof mediatorClassDef) {
				return;
			}

			this.createMediator(view, mediatorClassDef);
		},
		onViewRemoved: function (view) {
			var viewPrototype = Object.getPrototypeOf(view),
				mediatorClassDef = this.mediatorMap.get(viewPrototype);

			if ("undefined" === typeof mediatorClassDef) {
				return;
			}

			tools.walkDOMSubtree(view.getElement(), element => {
				if ("undefined" === typeof element.view) {
					return;
				}

				var viewPrototype = Object.getPrototypeOf(element.view),
					mediatorClassDef = this.mediatorMap.get(viewPrototype);

				if ("undefined" === typeof mediatorClassDef) {
					return;
				}

				this.removeMediator(element.view, mediatorClassDef);
			});
		},
		registerEvents: function (mediatorClassDef, mediatorInstance) {
			var events = this.getEventsFromClassDef(mediatorClassDef);
			events.forEach(event => {
				EventEmitter.on(event.eventType, event.mediator.prototype[event.method], mediatorInstance);
			});
		},
		removeMediator: function (view, mediatorClassDef) {
			this.unregisterEvents(mediatorClassDef, view.mediator);
			// @TODO Move the following lines into Mediator.remove() hook.
			view.mediator.removeListeners();
			delete view.mediator.view;
			delete view.mediator;
			// @TODO Move the following lines into View.remove() hook.
			delete view.getElement().view;
		},
		unregisterEvents: function (mediatorClassDef, mediatorInstance) {
			var events = this.getEventsFromClassDef(mediatorClassDef);
			events.forEach(function (event) {
				EventEmitter.off(event.eventType, event.mediator.prototype[event.method], mediatorInstance);
			});
		},
	};

	return MediatorMap;
});
define('lib/Log',[], function () {
	"use strict";

	var storageKey = 'chat-debug',
		storageDefaultDisplayValue = 0;

	var noop = function() {};
	var undefinedType = "undefined";
	var logMethods = [
		'assert',
		'clear',
		'count',
		'countReset',
		'debug',
		'dir',
		'dirxml',
		'error',
		'group',
		'groupCollapsed',
		'groupEnd',
		'info',
		'log',
		// 'profile',
		// 'profileEnd',
		'table',
		'time',
		'timeEnd',
		'timeLog',
		// 'timeStamp',
		'trace',
		'warn'
	];

	function bindMethod(obj, methodName) {
		var method = obj[methodName];
		if (typeof method.bind === 'function') {
			return method.bind(obj);
		} else {
			return Function.prototype.bind.call(method, obj);
		}
	}

	function realMethod(methodName) {
		if (undefinedType === typeof console) {
			return false;
		} else if (undefined !== console[methodName]) {
			return bindMethod(console, methodName);
		} else {
			return noop;
		}
	}

	function prepareMethodArguments (methodName) {
		var prefix = getPrefixArguments.call(this);
		return [].concat(methodName, prefix);
	}

	function getPrefixArguments() {
		var prefix = this.getPrefix();

		if ('string' === typeof prefix) {
			prefix = [prefix];
		}

		if (!Array.isArray(prefix)) {
			return [];
		}

		return prefix;
	}

	function createLogMethods() {
		var displayLogs = !!this.getDisplay();

		for (var i = 0; i < logMethods.length; i++) {
			var methodName = logMethods[i];

			if (displayLogs) {
				this[methodName] = this.methodFactory.apply(this, prepareMethodArguments.call(this, methodName));
			} else {
				this[methodName] = noop;
			}
		}
	}

	function defaultMethodFactory(methodName) {
		var args = Array.from(arguments),
			method = realMethod(methodName);

		args.shift();

		return method.bind(console, ...args);
	}

	/**
	 * Console log wrapper.
	 *
	 * You can use almost all the default console methods and you can
	 * choose to display logs in console or not.
	 *
	 * @constructor
	 * @example
	 * define('lib/internalLog', function (Log) {
	 * 		Log.info('Generic log');
	 * 		Log.debug('Debug log');
	 * 		Log.error('Error log');
	 * 		Log.warn('Warning log');
	 * 		Log.log('%c%s', 'color: dodgerblue', 'Colored log prefix:');
	 * });
	 */
	var Log = function () {
		var self = this,
			prefix = [];

		/**
		 * Determine if the display value is valid.
		 * @private
		 * @param value
		 * @returns {boolean}
		 */
		function isValidDisplayValue(value) {
			return 0 === value || 1 === value || '0' === value || '1' === value;
		}

		/**
		 * Set the display value.
		 * @private
		 * @param value
		 */
		function persistDisplayValueIfPossible(value) {
			if (undefinedType === typeof window || !storageKey) return;

			try {
				window.localStorage[storageKey] = value;
				return;
			} catch (ignore) {}

			try {
				window.document.cookie =
					encodeURIComponent(storageKey) + "=" + value + ";";
			} catch (ignore) {}
		}

		/**
		 * Get the display value.
		 * @private
		 * @returns {undefined|number}
		 */
		function getPersistedDisplayValue() {
			var storedValue;

			if (undefinedType === typeof window || !storageKey) return;

			try {
				storedValue = window.localStorage[storageKey];
			} catch (ignore) {}

			if (undefinedType === typeof storedValue) {
				try {
					var cookie = window.document.cookie;
					var location = cookie.indexOf(
						encodeURIComponent(storageKey) + "=");
					if (location !== -1) {
						storedValue = /^([^;]+)/.exec(cookie.slice(location))[1];
					}
				} catch (ignore) {}
			}

			if (false === isValidDisplayValue(storedValue)) {
				return undefined;
			}

			return parseInt(storedValue, 10);
		}

		/**
		 * Initialize log display value.
		 */
		function initDisplayValue() {
			var initialDisplayValue,
				query = new URLSearchParams(window.location.search),
				queryValue;

			if (query.has(storageKey)) {
				queryValue = query.get(storageKey);
			}

			if (queryValue && isValidDisplayValue(queryValue)) {
				initialDisplayValue = parseInt(queryValue, 10);
			} else {
				initialDisplayValue = self.getDisplay();
			}

			if (undefinedType === typeof initialDisplayValue) {
				initialDisplayValue = storageDefaultDisplayValue;
			}

			self.setDisplay(initialDisplayValue);
		}

		/**
		 * Factory method used to define log methods (debug, error, info, log).
		 *
		 * You can override this if needed.
		 *
		 * Prefer to bind arguments like this:
		 * <pre>
		 * var originalFactory = Log.methodFactory;
		 * Log.methodFactory = function (methodName) {
		 * 		var method = originalFactory(methodName);
		 * 		return method.bind(console, [add more arguments]);
		 * }
		 * </pre>
		 *
		 * If you want to use this method as a proxy (for example: to send log
		 * messages to a distant server), be aware you will lose stack information
		 * (line:column).
		 *
		 * @type {function(*): *}
		 */
		self.methodFactory = defaultMethodFactory;

		/**
		 * Set the display value (show or hide logs in console).
		 * @param {number} value Zero (hide) or one (show).
		 */
		self.setDisplay = function(value) {
			if (false === isValidDisplayValue(value)) {
				throw new TypeError('"value" parameter must be a number (0, 1)');
			}
			persistDisplayValueIfPossible(value);
		};
		/**
		 * Get the display value (show or hide logs in console).
		 * @return {number}
		 */
		self.getDisplay = function () {
			return getPersistedDisplayValue()
		};

		/**
		 * Get the prefix included before the log.
		 * @return {(String|Array<String>)}
		 */
		self.getPrefix = function () {
			return prefix;
		}

		/**
		 * Set the prefix to include before the log.
		 * @param {(String|Array<String>)} value String as used in console.log().
		 * @example
		 * define('lib/internalLog', function (Log) {
		 * 		Log.setPrefix('Test:');
		 *      // ...
		 *      Log.info('coucou'); // Output: Test: coucou
		 * });
		 */
		self.setPrefix = function (value) {
			if ('string' !== typeof value && !Array.isArray(value)) {
				throw new TypeError('"value" parameter must be a string or an array of strings');
			}
			prefix = value;

			self.recreateLogMethods();
		}

		/**
		 * Set the prefix to include before the log.
		 * @param {String} text String content of the tag.
		 * @param {String} [backgroundColor=black] A CSS color to apply on background (hex, rgb).
		 * @param {String} [textColor=white] A CSS color to apply on background (hex, rgb).
		 * @example
		 * define('lib/internalLog', function (Log) {
		 *   Log.setTagPrefix('Test', 'dodgerblue');
		 *   Log.info('coucou');
		 * });
		 */
		self.setTagPrefix = function (text, backgroundColor, textColor) {
			if ('undefined' !== typeof backgroundColor && 'string' !== typeof backgroundColor) {
				throw new TypeError('"backgroundColor" parameter must be a string or undefined');
			}

			if ('undefined' !== typeof textColor && 'string' !== typeof textColor) {
				throw new TypeError('"textColor" parameter must be a string or undefined');
			}

			if ('undefined' === typeof backgroundColor) {
				backgroundColor = 'black';
			}

			if ('undefined' === typeof textColor) {
				textColor = 'white';
			}

			self.setPrefix([
				'%c%s',
				`background-color: ${backgroundColor}; border-radius: 2px; color: ${textColor}; padding: 2px 4px 1px;`,
				text
			]);
		}

		/**
		 * Recreate log methods.
		 * @return {number}
		 */
		self.recreateLogMethods = function () {
			createLogMethods.call(self);
		}

		initDisplayValue.call(self);
		createLogMethods.call(self);
	}

	return new Log();
});
define('core/Context',[
	'core/CommandMap',
	'core/ContextEvent',
	'core/MediatorMap',
	'lib/Log',
	'libs/EventEmitter',
], function(
	CommandMap,
	ContextEvent,
	MediatorMap,
	Log,
	EventEmitter
) {
	/**
	 * Application context class
	 *
	 * @abstract
	 * @constructor
	 */
	var Context = function(contextElement) {
		if (!(contextElement instanceof HTMLElement)) {
			throw new ReferenceError("contextElement parameter must inherit from HTMLElement");
		}

		/** @var HTMLElement */
		this.contextElement = contextElement;
		/** @var CommandMap */
		this.commandMap = new CommandMap(this);
		/** @var MediatorMap */
		this.mediatorMap = new MediatorMap(this);
		this.startup();
	};

	Context.prototype = {
		/**
		 * Send events on EventEmitter.
		 *
		 * Use this method to trigger events from outside context.
		 *
		 * @param {string} eventName
		 * @param {...*} eventData
		 */
		emit: function(eventName, ...eventData) {
			if ("string" != typeof eventName) {
				throw new TypeError('eventName is invalid');
			}
			EventEmitter.emit(eventName, ...eventData);
		},

		/**
		 * Listen events on EventEmitter.
		 *
		 * Use this method to listen events from outside context.
		 *
		 * @param {string} eventName
		 * @param {function} callback
		 * @param {*=} thisArg
		 */
		on: function(eventName, callback, thisArg) {
			if ("string" != typeof eventName) {
				throw new TypeError('eventName is invalid');
			}

			if ("function" != typeof callback) {
				throw new TypeError('callback is invalid');
			}

			var _callback;
			if (thisArg) {
				_callback = callback.bind(thisArg);
			} else {
				_callback = callback
			}

			EventEmitter.on(eventName, _callback);
		},

		/**
		 * Hook executed at the end of the object constructor.
		 *
		 * You can override this method as needed.
		 *
		 * @example
		 * Object.assign(MyAppContext.prototype, {
		 *   //
		 *   startup: function() {
		 *     // Your code here
		 *     Context.prototype.startup.call(this); // Keep this line
         *   },
		 *   //
         * });
		 */
		startup: function() {
			this.commandMap.registerEvents();
			EventEmitter.emit(ContextEvent.STARTUP, this);
			this.contextElement.dispatchEvent(new CustomEvent('chat-startup'));
		}
	}

	return Context;
});
define('chat/ManagerEvent',[], function () {
	var ManagerEvent = Object.create(null);

	Object.defineProperties(ManagerEvent, {
		MESSAGE_ADDED: {value: 'message_added.manager', writable: false},
		MESSAGE_UPDATED: {value: 'message_updated.manager', writable: false},
		NODE_CREATED: {value: 'node_created.manager', writable: false},
		USER_CONNECTED: {value: 'user_connected.manager', writable: false}
	});

	return ManagerEvent;
});
define('core/Command',[], function() {
	var Command = function(context, commandMap, mediatorMap) {
		this.context = context;
		this.commandMap = commandMap;
		this.mediatorMap = mediatorMap;
	};

	Command.prototype = {
		execute: function () {}
	};

	return Command;
});
define('core/Enum',[], function () {
	function defineEnum(rawMap, ns) {
		if (!rawMap || typeof rawMap !== 'object') {
			throw new TypeError('rawMap must be an object');
		}
		if (typeof ns !== 'string') {
			throw new TypeError('namespace must be a string');
		}

		var e = {};
		for (var k in rawMap) {
			if (rawMap.hasOwnProperty(k)) {
				Object.defineProperty(e, k, {
					value: ns ? rawMap[k] + '.' + ns : rawMap[k],
					writable:   false,
					configurable: false,
					enumerable: true
				});
			}
		}
		return Object.freeze(e);
	}

	function extendEnum(parentEnum, nsChild, extraRawMap) {
		if (!parentEnum || typeof parentEnum !== 'object') {
			throw new TypeError('parentEnum must be a valid enum');
		}
		if (typeof nsChild !== 'string') {
			throw new TypeError('nsChild must be a string');
		}
		if (!extraRawMap || typeof extraRawMap !== 'object') {
			throw new TypeError('extraRawMap must be an object');
		}

		var child = {};
		Object.keys(parentEnum).forEach(function(key) {
			var v = parentEnum[key];
			var idx = v.lastIndexOf('.');
			var raw = (idx >= 0 ? v.slice(0, idx) : v);
			Object.defineProperty(child, key, {
				value: nsChild ? raw + '.' + nsChild : raw,
				writable: false,
				configurable: false,
				enumerable: true
			});
		});

		for (var k2 in extraRawMap) {
			if (extraRawMap.hasOwnProperty(k2)) {
				Object.defineProperty(child, k2, {
					value: nsChild ? extraRawMap[k2] + '.' + nsChild : extraRawMap[k2],
					writable: false,
					configurable: false,
					enumerable: true
				});
			}
		}

		return Object.freeze(child);
	}

    /**
     * Enumerator class
     */
	return {
        /**
         * Create an enumerator object.
         *
         * @param {Object} rawMap - Enumerator new properties
         * @param {string} ns - Enumerator namespace
         *
         * @example
         * ```
         * define([
         *    'core/Enum'
         * ], function (Enum) {
         *    return Enum.define({
         *        ADD_CONTACT: 'add_contact',
         *        ADD_CONTACT_ATTRIBUTE: 'add_contact_attribute',
         *        //
         *    }, 'contact_list_inbox');
         * });
         * ```
         */
		define: defineEnum,
        /**
         * Extends an enumerator object.
         *
         * @param {Enum} parentEnum - Parent enumerator object
         * @param {Object} nsChild - Child enumerator namespace
         * @param {string} extraRawMap - Child enumerator new properties and overrides
         *
         * @example
         * ```
         * define([
         *    'core/Enum',
         *    'features/ContactList/events/ContactListEvent'
         * ], function (Enum, ContactListEvent) {
         *    return Enum.extend(ContactListEvent, 'contact_list_customer', {
         *        CONTACT_ADDED_TO_FOLLOWER_LIST: 'contact_added_to_follower_list',
         *        CONTACT_COSTUMERS_BATCH: 'customers_batch',
         *        // 
         *    });
         * });
         * ```
         */
		extend: extendEnum
	}
});
define('features/ContactList/events/ContactListEvent',[
	'core/Enum'
], function (Enum) {
	return Enum.define({
		ADD_CONTACT: 'add_contact',
		ADD_CONTACT_ATTRIBUTE: 'add_contact_attribute',
		ADD_CONTACT_FROM_SEARCH: 'add_contact_search',
		ADDED_CONTACT_ATTRIBUTE: 'added_contact_attribute',
		ADDED_CONTACT: 'added_contact',
		ALL_IDS_AND_FIRST_CONTACT_SUCCESS: 'all_ids_first_contact_infos',
		CLEAR_CONTACT_LIST: 'clear_contact_list',
		CLEAR_CONTACT_LIST_CONTEXT: 'clear_contact_list_context',
		CONTACT_LIST_CREATED: 'contact_list_created',
		CONTACT_LIST_SORTED: 'list_sorted',
		SET_TAB_CONTACT_LIST: 'set_tab',
		CONTACT_SCORE_SORTED: 'score_sorted',
		CONTACTS: 'contacts',
        CONTACTS_INFO: 'contacts_info',
		CREATE_CONTACT_LIST: 'create_contact_list',
		FOLLOW: 'follow',
		GENERATE_AVATAR: 'generate_avatar',
		GENERATE_AVATAR_REQUEST: 'generated_avatar',
        GET_CONTACTS_INFO: 'get_contacts_info',
		GET_MORE: 'get_more',
		GET_MORE_SUCCESS: 'get_more_success',
		HIDE_CONTACT_LIST: 'hide_contact_list',
		INIT_CONTACT_LIST_FILTERS: 'init_filters_contact_list_button',
		PREPARE_EXPENSES: 'prepare_expenses',
		PREPARED_EXPENSES: 'prepared_expenses',
		REMOVE_CONTACT: 'remove_contact',
		REMOVED_CONTACT: 'removed_contact',
		SET_FILTERS_CONTACT_LIST: 'set_filters_contact_list_button',
		SHOW_CONTACT_LIST: 'show_contact_list',
		SORT_CONTACT_LIST: 'sort_list',
		SORT_CONTACT_SCORE: 'sort_score',
		UPDATED_CONTACT: 'updated_contact',
		UPDATED_CONTACT_VIEW: 'updated_contact_view',
		UPDATE_LIST: 'update_list',
		UNFOLLOW: 'unfollow',
		UNREAD_MESSAGE_BADGE: 'unread_message_badge',
		UNREAD_MESSAGE_BADGE_UPDATED: 'unread_message_badge_updated',
		USER_LOG_ON: 'log_on',
		USER_LOG_OFF: 'log_off'
	}, 'contact_list_inbox');
});
define('features/ContactList/CustomerList/events/CustomerListEvent',[
	'core/Enum',
	'features/ContactList/events/ContactListEvent'
], function (Enum, ContactListEvent) {
	return Enum.extend(ContactListEvent, 'contact_list_customer', {
		ALL_CUSTOMERS_SUCCESS: 'all_customers',
		CONTACT_ADDED_TO_FOLLOWER_LIST: 'contact_added_to_follower_list',
		CONTACT_COSTUMERS_BATCH: 'customers_batch',
		FOLLOWED_BY: 'followed_by',
		REMOVE_CONTACT_FROM_CUSTOMER_LIST: 'remove_from_customers_list',
		UNFOLLOWED_BY: 'unfollowed_by',
	});
});
define('features/ContactList/FollowerList/events/FollowerListEvent',[
	'core/Enum',
	'features/ContactList/events/ContactListEvent'
], function (Enum, ContactListEvent) {
	return Enum.extend(ContactListEvent, 'contact_list_follower', {
		ADD_CONTACT_TO_CUSTOMER_LIST: 'add_to_customers_list',
		ALL_FOLLOWERS_SUCCESS: 'all_followers',
		CONTACT_ADDED_TO_CUSTOMER_LIST: 'contact_added_to_customer_list',
		CONTACT_FOLLOWERS_BATCH: 'customers_batch',
		FOLLOWED_BY: 'followed_by',
		UNFOLLOWED_BY: 'unfollowed_by',
	});
});
define('features/ContactList/SupportList/events/SupportListEvent',[
	'core/Enum',
	'features/ContactList/events/ContactListEvent'
], function (Enum, ContactListEvent) {
	return Enum.extend(ContactListEvent, 'contact_list_support', {
		ALL_SUPPORTS_SUCCESS: 'all_supports'
	});
});
define('features/ContactList/commands/AddContactAttributeCommand',[
	'log_and_tooltip',
	'core/Command',
	'libs/EventEmitter',
	'features/ContactList/events/ContactListEvent',
	'features/ContactList/CustomerList/events/CustomerListEvent',
	'features/ContactList/FollowerList/events/FollowerListEvent',
	'features/ContactList/SupportList/events/SupportListEvent',
], function(
	log_and_tooltip,
	Command,
	EventEmitter,
	ContactListEvent,
	CustomerListEvent,
	FollowerListEvent,
	SupportListEvent,
) {
	var AddContactAttribute = function(context) {
		Command.call(this, context);
	};

	AddContactAttribute.prototype = Object.create(Command.prototype);

	Object.assign(AddContactAttribute.prototype, {
		execute: function (data) {

			var chatContactManager = this.context.chatFriendManager,
				contactData = chatContactManager.friends[data.contactId];

			if (!contactData) {
				wglog.debug('AddContactAttributeCommand', 'contactData missing');
				return;
			}

			// wglog.debug('AddContactAttributeCommand', data);

			var authorized = ["first_timestamp", "interaction", "is_favorite", "last_id_message", "last_id_sender", "last_message", "last_timestamp", "last_read", "load_history", "nb_unread", "new_conv_key_asked"];

			if (authorized.indexOf(data.attrName) === -1) {
				wglog.debug('AddContactAttributeCommand - Attribute not authorized', data.attrName);
				return;
			}

			contactData[data.attrName] = data.attrValue;

			EventEmitter.emit(this.getListEvents(data.listType).ADDED_CONTACT_ATTRIBUTE, data);
		},
		getListEvents: function(listType) {
			if (listType === 'customers') return CustomerListEvent;
			if (listType === 'followers') return FollowerListEvent;
			if (listType === 'supports') return SupportListEvent;

			return ContactListEvent;
		}
	});

	return AddContactAttribute;
});
define('features/ContactList/commands/AddContactCommand',[
	'config/chat',
	'log_and_tooltip',
	'core/Command',
	'libs/EventEmitter',
	'features/ContactList/events/ContactListEvent',
	'features/ContactList/CustomerList/events/CustomerListEvent',
	'features/ContactList/FollowerList/events/FollowerListEvent',
	'features/ContactList/SupportList/events/SupportListEvent',
], function(
	config,
	log_and_tooltip,
	Command,
	EventEmitter,
	ContactListEvent,
	CustomerListEvent,
	FollowerListEvent,
	SupportListEvent
) {
	var AddContact = function(context) {
		Command.call(this, context);
	};

	AddContact.prototype = Object.create(Command.prototype);

	Object.assign(AddContact.prototype, {
		execute: function (contact, source, updateListByBulk) {
			if (!contact || (!contact.id_user && !contact.id_user_xv)) {
				wglog.debug('AddContactCommand', 'friend_info missing');
				return;
			}

			// wglog.debug('AddContactCommand', contact, source);

			if (contact.id_user === null && typeof contact.id_user_xv === "number") {
				contact.id_user = contact.id_user_xv;
			}

			if (!source) source = 'online';

			var chatContactManager = this.context.chatFriendManager,
				userId = chatContactManager.user_id;

			if (contact.id_user === userId) {
				wglog.debug('AddContactCommand', 'not adding the user as friend because contact_id === user_id');
				return;
			}

			var contactListEvent = ContactListEvent,
				contactsIds = chatContactManager.friends_ids,
				supportsIds = chatContactManager.support_ids,
				contactExists = contactsIds.indexOf(contact.id_user) !== -1;

			if (!contactExists) {
				contactsIds.push(contact.id_user);

				if (contact.is_support && supportsIds.indexOf(contact.id_user) === -1) {
					supportsIds.push(contact.id_user);
				}
			}

			if (config.login_info.is_support && contact.is_support) {
				contactListEvent = SupportListEvent;
			}

			if (config.login_info.is_creator) {
				if (!chatContactManager.customers_ids) {
					chatContactManager.customers_ids = [];
				}

				if (!chatContactManager.followers_ids) {
					chatContactManager.followers_ids = [];
				}

				if (contact.is_support) {
					contactListEvent = SupportListEvent;
				} else if (contact.is_customer) {
					contactListEvent = CustomerListEvent;
					if (chatContactManager.customers_ids.indexOf(contact.id_user) === -1) {
						chatContactManager.customers_ids.push(contact.id_user);
					}
				} else {
					contactListEvent = FollowerListEvent;
					if (chatContactManager.followers_ids.indexOf(contact.id_user) === -1 ) {
						chatContactManager.followers_ids.push(contact.id_user);
					}
				}
			}

			chatContactManager.friends[contact.id_user] = contact;

			if (contactListEvent) {
				EventEmitter.emit(contactListEvent.ADDED_CONTACT, contact, source, updateListByBulk);
			}

		}
	});

	return AddContact;
});
define('features/ContactList/commands/AddContactsInfoCommand',[
    'config/chat',
    'log_and_tooltip',
    'core/Command',
    'libs/EventEmitter',
    'features/ContactList/events/ContactListEvent'
], function(
    config,
    log_and_tooltip,
    Command,
    EventEmitter,
    ContactListEvent
) {
    var AddContactsInfo = function(context) {
        Command.call(this, context);
    };

    AddContactsInfo.prototype = Object.create(Command.prototype);

    Object.assign(AddContactsInfo.prototype, {
        execute: function (contacts) {
            for (const contactInfo of contacts.data) {
                EventEmitter.emit(ContactListEvent.ADD_CONTACT, contactInfo, null, true);
            }
            EventEmitter.emit(ContactListEvent.UPDATE_LIST);
        }
    });

    return AddContactsInfo;
});
define('core/Component',[
	'mustache',
	'lib/tools'
], function(
	Mustache,
	tools
) {
	/**
	 * Base class for components.
	 *
	 * It contains properties and methods shared between UI components.
	 *
	 * Mandatory properties to declare in the child class:
	 * - this.template: an HTML string
	 *
	 * Optional overrides:
	 * - addListeners()
	 * - createElement()
	 * - getForcedTemplateParams()
	 *
	 * @abstract
	 * @constructor
	 */
	var Component = function() {
		/** @var {HTMLElement} */
		this.element = null;
		this.elementEventListeners = [];
		this.templateDisabled = this.templateDisabled || false;
		this.createElement();
		this.addListeners();
	};

	Component.prototype = {
		/**
		 * Add listener to a children of the component element.
		 *
		 * @param {(HTMLElement|String)} element - An HTMLElement instance or a CSS selector.
		 * @param {string} eventType - Event type.
		 * @param {function} callback - A function to execute when the event is triggered.
		 * @param {string=} namespace - Optional namespace to group element's different events
		 * @param {object=} thisArg - Optional object to use as `this`.
		 */
		addElementListener: function (element, eventType, callback, namespace, thisArg) {
			if (!this.element) {
				return;
			}
			if ("string" != typeof element && !(element instanceof HTMLElement)) {
				throw new TypeError('element parameter must be a string or an HTMLElement instance');
			}

			/** @var {(NodeListOf|Array)} */
			var elements;

			if ("string" === typeof element) {
				elements = this.element.querySelectorAll(element);
			} else {
				elements = [element];
			}

			if (typeof namespace === 'undefined') {
				namespace = null;
			}

			var _callback = callback;
			if (thisArg) {
				_callback = callback.bind(thisArg);
			}

			elements.forEach(element => {
				var evt = {
					element: element,
					eventType: eventType,
					callback: _callback,
					namespace: namespace
				};
				this.elementEventListeners.push(evt);
				element.addEventListener(evt.eventType, evt.callback);
			});
		},
		/**
		 * Hook executed on constructor and refresh phases.
		 */
		addListeners: function () {
		},
		/**
		 * Transform a literal objet into a string of HTML attributes.
		 *
		 * @param {object} attributes A literal object whose properties will be used as HTML attributes.
		 * @returns {string}
		 */
		attributesToString: function (attributes) {
			var strings = [];

			for (var key in attributes) {
				var value = attributes[key];

				if (typeof value === 'boolean') {
					if (value) {
						strings.push(key);
					}
					continue;
				}
				else if (typeof value.toString !== 'function') {
					continue;
				}

				strings.push(key + '="' + value.toString() + '"');
			}

			return strings.join(' ');
		},
		/**
		 * Create an element from template.
		 * @returns {*}
		 */
		createElementFromTemplate: function () {
			if (this.templateDisabled) {
				return null;
			}
			if (!this.template) {
				throw new Error('Template property is missing, unable to create the element.');
			}

			var params = this.generateTemplateParams(),
				element = Mustache.render(this.template || '', params);

			return tools.string_to_node(element);
		},
		/**
		 * Create the element and save it into `this.element`.
		 */
		createElement: function () {
			this.element = this.createElementFromTemplate();
		},
		/**
		 * Dispatch an event.
		 * @param {string} eventType - A string with the name of the event.
		 */
		dispatchEvent: function (eventType) {
			if (!this.element) {
				return;
			}

			this.element.dispatchEvent(new Event(eventType, {bubbles: true, cancelable: true}));
		},
		/**
		 * Provide params to use in the template on element creation.
		 *
		 * @returns {object}
		 */
		generateTemplateParams: function () {
			var forcedTemplateParams = this.getForcedTemplateParams(),
				params = Object.assign({}, this.options || {}, forcedTemplateParams);

			if ('undefined' !== typeof params.attributes) {
				params.attributes = this.attributesToString(params.attributes);
			}

			return params;
		},
		/**
		 * Get the element.
		 *
		 * @returns {HTMLElement|null}
		 */
		getElement: function () {
			return this.element;
		},
		/**
		 * Get all listeners of one element
		 *
		 * @param {(HTMLElement|String)} element - An HTMLElement instance or a CSS selector.
		 * @returns {array}
		 */
		getElementListeners: function (element) {
			if (!this.element) {
				return [];
			}

			var listeners = [];

			if ("string" === typeof element) {
				element = this.element.querySelector(element);
			}

			for (const index in this.elementEventListeners) {
				if (this.elementEventListeners[index].element !== element) {
					continue;
				}
				listeners.push(this.elementEventListeners[index]);
			}
			return listeners;
		},
		/**
		 * Permanent template parameters you absolutely want.
		 *
		 * @returns {object}
		 */
		getForcedTemplateParams: function () {
			return {};
		},
		/**
		 * Get all listeners of one element
		 *
		 * @param {String} namespace - Namespace of events
		 * @returns {array}
		 */
		getNamespaceListeners: function (namespace) {
			var listeners = [];

			for (const index in this.elementEventListeners) {
				if (this.elementEventListeners[index].namespace !== namespace) {
					continue;
				}
				listeners.push(this.elementEventListeners[index]);
			}
			return listeners;
		},
		/**
		 * Refresh element display.
		 */
		refreshElement: function () {
			if (!this.element) {
				return;
			}

			var newElement = this.createElementFromTemplate();
			this.element.innerHTML = newElement.innerHTML;
			this.addListeners();
			this.dispatchEvent('refresh');
		},
		/**
		 * Remove event listeners linked to children of the component element.
		 *
		 * @param {Array=} eventList - Optional list of elementsListener
		 */
		removeElementListeners: function (eventList) {
			var list = this.elementEventListeners,
				syncElementEventListeners = false,
				indexToRemove = [];

			if (eventList !== 'undefined' && eventList instanceof Array && eventList.length > 0) {
				list = eventList;
				syncElementEventListeners = true;
			}

			for (var index in list) {
				var info = list[index];
				info.element.removeEventListener(info.eventType, info.callback);

				if (!syncElementEventListeners) {
					this.elementEventListeners.splice(parseInt(index), 1);
				} else {
					for (var indexList in this.elementEventListeners) {
						if (this.elementEventListeners[indexList].element !== info.element || this.elementEventListeners[indexList].callback !== info.callback) {
							continue;
						}
						indexToRemove.push(indexList);
					}
				}
			}

			if (indexToRemove.length > 0) {
				for (var i = (indexToRemove.length - 1); i >= 0; i--) {
					this.elementEventListeners.splice(indexToRemove[i], 1);
				}
			}

		},
	}

	return Component;
});
define('core/View',[
	'core/Component',
	'core/ViewEvent',
	'libs/EventEmitter'
], function(
	Component,
	ViewEvent,
	EventEmitter
) {
	/**
	 * View base class.
	 *
	 * @extends Component
	 * @constructor
	 */
	var View = function() {
		Component.call(this);
		this.element.view = this;
		this.mediator = null;
		EventEmitter.emit(ViewEvent.CREATED, this);
	};

	View.prototype = Object.create(Component.prototype);

	Object.assign(View.prototype, {
		/**
		 * Refresh the view element and mediator's listeners.
		 */
		refreshElement: function () {
			Component.prototype.refreshElement.call(this);
			this.mediator.addListeners();
		},
		/**
		 * Hook that perform operations when the view is removed.
		 */
		remove: function () {
			this.removeElementListeners();
			EventEmitter.emit(ViewEvent.REMOVED, this);
		}
	});

	return View;
});

define('text!features/ContactList/views/ContactList.mustache',[],function () { return '<div id="chat-users-{{listType}}" class="chat-users chat-users-list"></div>';});

define('features/ContactList/views/components/SupportsList/SupportsList',[
	'config/chat',
	'core/Component',
], function(
	Config,
	Component
) {

	var CONTACTS_SUPPORT = 'chat-users-support',
		CONTACTS_SUPPORT_SELECTOR = '#' + CONTACTS_SUPPORT,
		CONTACTS_SUPPORT_TOGGLER = 'chat-support-toggler',
		CONTACTS_SUPPORT_TOGGLER_SELECTOR = '#' + CONTACTS_SUPPORT_TOGGLER;

	var SupportsList = function(chatFriendManager, listType) {
		this.templateDisabled = true;
		Component.call(this);

		this.chatFriendManager = chatFriendManager;
		this.listType = listType;
	};

	SupportsList.prototype = Object.create(Component.prototype);

	Object.assign(SupportsList.prototype, {
		appendContactItem: function(contactElt) {
			document.querySelector(CONTACTS_SUPPORT_SELECTOR).append(contactElt);
			this.updateSupportToggler();
		},
		clearContactListSupportHtml: function(updateSupport) {
			if (!updateSupport || this.listType === 'followers') return;

			var supportContacts = document.querySelector(CONTACTS_SUPPORT_SELECTOR);
			if (supportContacts) {
				var allSupports = supportContacts.querySelectorAll('.chat-user');
				if (allSupports) {
					allSupports.forEach(function(element) {
						element.remove();
					});
				}
			}

			var supportContactsHidden = document.querySelector(CONTACTS_SUPPORT_SELECTOR + '-hidden');
			if (supportContactsHidden) {
				var allSupportsHidden = supportContactsHidden.querySelectorAll('.chat-user');
				if (allSupportsHidden) {
					allSupportsHidden.forEach(function(element) {
						element.remove();
					});
				}
			}
		},
		getSupportTogglerUnreadData: function () {
			var data = {
					noUnread: [],
					unread: []
				};

			for (var i = 0, l = this.chatFriendManager.support_ids.length; i < l; i++) {
				var support_id = this.chatFriendManager.support_ids[i];
				if (this.chatFriendManager.friends[support_id].nb_unread) {
					data.unread.push(support_id);
				} else {
					data.noUnread.push(support_id);
				}
			}

			return data;
		},
		hideSupportToggler: function () {
			wglog.debug('SupportListComponent - hideSupport');

			var contactsSupportSelector = document.querySelector(CONTACTS_SUPPORT_SELECTOR);
			if (contactsSupportSelector) {
				contactsSupportSelector.classList.add('is_hidden');
			}

			var contactsSupportTogglerSelector = document.querySelector(CONTACTS_SUPPORT_TOGGLER_SELECTOR);
			if (contactsSupportTogglerSelector) {
				contactsSupportTogglerSelector.classList.add('is_hidden');
			}
		},
		hideSupportTogglerButton: function (noUpdateActive) {
			wglog.debug('SupportListComponent - hideSupportTogglerButton', noUpdateActive);

			var supportList = document.querySelector(CONTACTS_SUPPORT_TOGGLER_SELECTOR + '-list');
			if (supportList) supportList.classList.remove('chat-toggle--show');

			var supportButton = document.querySelector(CONTACTS_SUPPORT_TOGGLER_SELECTOR + '-button');
			if (supportButton) {
				if (!noUpdateActive) {
					supportButton.classList.remove('active');
				}
				supportButton.classList.add('is-hidden');
			}
		},
		moveSupportTogglerContacts: function (ids, isHidden) {
			if (ids.length === 0) return;

			wglog.debug('SupportListComponent - moveSupportTogglerContacts', ids, isHidden);

			var containerId = isHidden ? 'chat-users-support-hidden' : CONTACTS_SUPPORT;
			for (var i = 0, l = ids.length; i < l; i++) {
				var listItem = document.querySelector('#select_friend_li_' + ids[i]);
				if (listItem && listItem.closest('.chat-users').getAttribute('id') !== containerId) {
					var destinationList = document.querySelector('#' + containerId);
					if (!!destinationList) {
						destinationList.append(listItem);
					}
				}
			}
		},
		showSupportToggler: function () {
			wglog.debug('SupportListComponent - showSupport');

			var contactsSupportSelector = document.querySelector(CONTACTS_SUPPORT_SELECTOR);
			if (contactsSupportSelector) {
				contactsSupportSelector.classList.remove('is_hidden');
			}

			var contactsSupportTogglerSelector = document.querySelector(CONTACTS_SUPPORT_TOGGLER_SELECTOR);
			if (contactsSupportTogglerSelector) {
				contactsSupportTogglerSelector.classList.remove('is_hidden');
			}
		},
		showSupportTogglerButton: function () {
			var supportList = document.querySelector(CONTACTS_SUPPORT_TOGGLER_SELECTOR + '-list');
			if (supportList && !supportList.classList.contains('chat-toggle--show')) {
				wglog.debug('SupportListComponent - showSupportTogglerSelector');
				supportList.classList.add('chat-toggle--show');
			}

			var supportButton = document.querySelector(CONTACTS_SUPPORT_TOGGLER_SELECTOR + '-button');
			if (supportButton && supportButton.classList.contains('is-hidden')) {
				wglog.debug('SupportListComponent - showSupportTogglerButton');
				supportButton.classList.remove('is-hidden');
			}
		},
		updateSupportToggler: function () {
			wglog.debug('SupportListComponent - updateSupportToggler');

			if (Config.login_info.is_fan) return;

			var min_support = 1;

			if (this.chatFriendManager.support_ids.length < min_support) return;

			var data = this.getSupportTogglerUnreadData();

			if (data.noUnread.length >= min_support) {
				this.showSupportTogglerButton();
				this.moveSupportTogglerContacts(data.noUnread, true);
				this.moveSupportTogglerContacts(data.unread);
			} else {
				this.hideSupportTogglerButton();
				this.moveSupportTogglerContacts(this.support_ids);
			}
		}
	});

	return SupportsList;

});

define('text!features/ContactList/views/components/ContactListTab/ContactListTab.mustache',[],function () { return '<li class="chat-tabs__item chat-tabs__item--{{listType}}{{#active}} active{{/active}}" data-tab="chat-users-{{listType}}">\n\t<span class="chat-tabs__item-content">\n\t\t<span class="chat-tabs__item-label">\n\t\t\t<span id="total-{{listType}}" class="chat-tabs__item-total-contact">{{total}}</span>\n\t\t\t<span class="chat-tabs__item-text">{{listName}}</span>\n\t\t\t<span id="total-unread-message-{{listType}}" class="chat-tabs__item-total-message is-hidden"></span>\n\t\t</span>\n\t</span>\n</li>';});

define('features/ContactList/views/components/ContactListTab/ContactListTab',[
	'libs/EventEmitter',
	'core/Component',
	'text!features/ContactList/views/components/ContactListTab/ContactListTab.mustache'
], function(
	EventEmitter,
	Component,
	ContactsListTabTpl
) {

	var ContactsListTab = function(options) {
		this.options = Object.assign({}, {
			baseName: "",
			classes: "",
			modifier: "",
			attributes: {}
		}, options);
		this.template = ContactsListTabTpl;
		this.active = this.options.active;
		Component.call(this);
	};

	ContactsListTab.prototype = Object.create(Component.prototype);

	Object.assign(ContactsListTab.prototype, {
		addListeners: function() {
			this.addElementListener(this.element, 'click', this.onClickContactListTab.bind(this));
		},
		contactListActive: function() {
			this.active = true;
			this.element.classList.add('active');
		},
		contactListInactive: function() {
			this.active = false;
			this.element.classList.remove('active');
		},
		onClickContactListTab: function() {
			if (!!this.options.activeContactList && typeof this.options.activeContactList === 'function') {
				this.options.activeContactList();
			}
		},
	});

	return ContactsListTab;

});

define('text!features/ContactList/views/components/Avatar/Avatar.mustache',[],function () { return '<figure class="chat-avatar{{#modifier}} chat-avatar--{{modifier}}{{/modifier}}{{#status}} chat-avatar--{{status}}{{/status}}{{#reminder}} chat-avatar--reminder-{{reminder.status}}{{/reminder}}"{{#reminder}} title="{{reminder.desc}}"{{/reminder}}>\n\t{{#profile_url}}<a href="{{profile_url}}">{{/profile_url}}\n\t{{#is_user_inactive}}<span class="icon-f icf-close"></span>{{/is_user_inactive}}\n\t{{^is_user_inactive}}\n\t\t{{#is_user_not_reviewed}}\n\t\t\t<span class="icon-f icf-handshake" alt="{{review_not_validated}}" title="{{review_not_validated}}"></span>\n\t\t{{/is_user_not_reviewed}}\n\t\t<img src="{{src}}" alt="{{alt}}">\n\t{{/is_user_inactive}}\n\t{{#profile_url}}</a>{{/profile_url}}\n</figure>';});

define('features/ContactList/views/components/Avatar/Avatar',[
	'core/Component',
	'text!features/ContactList/views/components/Avatar/Avatar.mustache'
], function(
	Component,
	AvatarTpl
) {

	var Avatar = function(options) {
		this.options = Object.assign({}, {
			baseName: "",
			classes: "",
			modifier: "",
			attributes: {}
		}, options);
		this.template = AvatarTpl;
		Component.call(this);
	};

	Avatar.prototype = Object.create(Component.prototype);

	Object.assign(Avatar.prototype, {});

	return Avatar;

});

define('text!features/ContactList/views/components/Contact/Contact.mustache',[],function () { return '<div\n\t\tid="select_friend_li_{{#search}}search_{{/search}}{{id_user}}"\n\t\tclass="chat-user{{#type}} chat-user--{{type}}{{/type}}{{#selected}} chat-user--selected{{/selected}}{{#nb_unread}} chat-user--new{{/nb_unread}} user{{id_user}} {{#expenses}}chat-user--expense{{/expenses}}"\n>\n\t<div class="chat-user__avatar" title="{{{status_trad}}}">\n\t\t{{{avatar}}}\n\t</div>\n\t<div class="chat-user__body{{#expenses}} expense expense--chat-user{{/expenses}}">\n\t\t<div class="chat-user__name-wrapper">\n\t\t\t{{#is_support}}<span class="chat-user__prefix-icon icon-f icf-support"></span>{{/is_support}}\n\t\t\t<span class="chat-user__name" title="{{profile_name}}">{{profile_name}}</span>\n\t\t\t{{#is_user_inactive}}<span class="chat-user__inactive">({{inactive_status_text}})</span>{{/is_user_inactive}}\n\t\t\t{{#expenses}}\n\t\t\t\t{{#expenses.has_total}}\n\t\t\t\t\t<span class="expense__total {{ expenses.ranking }}">\n\t\t\t\t\t<strong class="expense__total-amount">{{ expenses.amount_total }}</strong>\n\t\t\t\t</span>\n\t\t\t\t{{/expenses.has_total}}\n\t\t\t{{/expenses}}\n\t\t</div>\n\t\t{{#expenses.subscription_months_total_active}}\n\t\t\t<span class="expense__period">\n\t\t\t\t<span class="expense__month expense__month--active"><strong>{{ expenses.subscription_months_total_active }}</strong> {{ expenses.text_month_active }}</span> / <span class="expense__month expense__month--total"><strong>{{ expenses.subscription_months_total }}</strong> {{ expenses.text_month_total }}</span>\n\t\t\t</span>\n\t\t{{/expenses.subscription_months_total_active}}\n\t\t{{#message}}\n\t\t\t<div class="chat-user__last-message">{{{message.content}}}</div>\n\t\t{{/message}}\n\t</div>\n\t{{#message}}\n\t\t<div class="chat-user__last-message-metas">\n\t\t\t<div class="chat-user__last-message-date"><small>{{message.date}}</small></div>\n\t\t\t{{#tip}}<div class="chat-user__tip"><span class="badge chat-user__badge chat-user__badge--secondary">{{tip.amount}}</span></div>{{/tip}}\n\t\t\t<div class="chat-user__last-message-status">{{#nb_unread}}<span class="badge chat-user__badge">{{nb_unread}}</span>{{/nb_unread}}</div>\n\t\t</div>\n\t{{/message}}\n</div>';});

define('features/ContactList/views/components/Contact/Contact',[
	'core/Component',
	'text!features/ContactList/views/components/Contact/Contact.mustache'
], function(
	Component,
	FriendTpl
) {

	var Friend = function(options) {
		this.options = Object.assign({}, {
			baseName: "",
			classes: "",
			modifier: "",
			attributes: {}
		}, options);
		this.template = FriendTpl;
		Component.call(this);
	};

	Friend.prototype = Object.create(Component.prototype);

	Object.assign(Friend.prototype, {

	});

	return Friend;

});

define('text!features/ContactList/views/components/LoadMore/LoadMore.mustache',[],function () { return '<div class="chat-users-more chat-users chat-users--{{listType}}">\n\t<a href="#" class="chat-btn" id="chat_get_more_friends_link--{{listType}}"><span>{{label}}</span></a>\n\t<div class="chat-users-more-loading chat-users chat-users--{{listType}} chat-users--{{listType}}-loading is-hidden">\n\t\t<svg class="chat-scc chat-scc--spin"><use xlink:href="#scc-message-loader-icon"></use></svg>\n\t\t<p>{{loading}}</p>\n\t</div>\n</div>';});

define('features/ContactList/views/components/LoadMore/LoadMore',[
	'core/Component',
	'text!features/ContactList/views/components/LoadMore/LoadMore.mustache'
], function(
	Component,
	LoadMoreTpl
) {

	var CLASS_HIDDEN = 'is-hidden';

	var LoadMore = function(options) {
		this.options = Object.assign({}, {
			baseName: "",
			classes: "",
			modifier: "",
			attributes: {}
		}, options);
		this.template = LoadMoreTpl;
		Component.call(this);
		this.link = null;
		this.observer = null;
		this.init();
	};

	LoadMore.prototype = Object.create(Component.prototype);

	Object.assign(LoadMore.prototype, {
		connect: function(observer, link) {
			if (!observer) {
				observer = this.observer;
			}
			if (!link) {
				link = this.link;
			}
			observer.observe(link);
		},
		disconnect: function(observer) {
			if (!observer) {
				observer = this.observer;
			}
			observer.disconnect();
		},
		init: function() {
			this.link = this.element.querySelector('#chat_get_more_friends_link--' + this.options.listType);
			this.loader = this.element.querySelector('.chat-users-more-loading');
			this.addElementListener(this.link, 'click', this.loadMore.bind(this));
			this.setupLoadMoreObserver();
		},
		hide: function() {
			this.element.classList.add(CLASS_HIDDEN);
		},
		hideLoading: function() {
			this.link.classList.remove('is-hidden');
			this.loader.classList.add('is-hidden');
		},
		isHidden: function() {
			return this.element.classList.contains(CLASS_HIDDEN);
		},
		loadMore: function() {
			if (!!this.options.loadMore && typeof this.options.loadMore === 'function') {
				this.options.loadMore();
			}
		},
		loading: function() {
			this.link.classList.add('is-hidden');
			this.loader.classList.remove('is-hidden');
		},
		oberserverInteraction: function(entries, observer) {
			var self = this;
			entries.forEach(function(entry) {
				if (entry.isIntersecting) {
					self.disconnect(observer);
					wglog.debug('LoadMore - Trigger -', self.options.listType);
					self.loadMore();
				}
			});
		},
		setupLoadMoreObserver: function() {
			if (!window.IntersectionObserver) {
				return;
			}

			if (!this.observer) {
				this.observer = new IntersectionObserver(this.oberserverInteraction.bind(this), {
					root: this.options.rootObserverElement,
					rootMargin: '0px 0px 150px',
					threshold: 1
				});
			}
		},
		show: function() {
			this.element.classList.remove(CLASS_HIDDEN);
		}
	});

	return LoadMore;

});
define('features/Message/utils/Message',[
	'lib/i18n!front'
], function (
	i18n
) {
	return {
		/**
		 * Get a message meta-information from its message ID.
		 *
		 * @param {string} messageId
		 * @return {object|false}
		 */
		getMetaFromMessageId: function (messageId) {
			if (typeof messageId !== 'string') {
				return false;
			}

			var firstSplit = messageId.split('-');
			if (firstSplit.length !== 3) {
				return false;
			}

			var secondSplit = firstSplit[0].split('_');

			if (secondSplit.length !== 4) {
				return false;
			}

			return {
				senderId: firstSplit[1],
				recipientId: firstSplit[1] === secondSplit[1] ? secondSplit[2] : secondSplit[1],
				uid: firstSplit[2]
			};
		},
		getSpamReportMessage: function (reasons) {
			if (!reasons || (typeof reasons !== "string" && !Array.isArray(reasons))) {
				return i18n.__('chat.spam_report.default_message');
			}

			var r;
			if (typeof reasons === "string") {
				r = [reasons];
			} else {
				r = reasons;
			}

			var i18nReasons = r.map(function (reason) {
				return i18n.__('chat.spam_report.reason.' + reason.toLowerCase());
			})

			return i18n.__('chat.spam_report.message_with_reasons', {'%reasons%': '<b>' + i18n.formatStringList(i18nReasons) + '</b>'});
		}
	};
});
define('core/ModelObject',[
	'lib/storage'
], function (
	Storage
) {
	function setImmutableProperty(instance, propertyName, defaultValue) {
		if (typeof propertyName !== 'string' || !propertyName.length) {
			throw new Error(`The propertyName must be a non-empty string, given: ${propertyName}`);
		}

		Object.defineProperty(instance, propertyName, {value: instance[propertyName] || defaultValue, writable: false});
	}

	/**
	 * Base class for models.
	 * @constructor
	 */
	var ModelObject = function () {
		if (!this.storageKey) {
			throw new Error('The storageKey property must be set before using this constructor');
		}

		setImmutableProperty(this, 'storageKey');
		Object.defineProperty(this, 'STORAGE_NAMESPACE', {value: 'chat', writable: false});

		this.defaultData = {};

		if (this.initialData && this.getAll().length === 0) {
			this.setAll(this.initialData);
		}
	};


	Object.assign(ModelObject.prototype, {
		/**
		 * Get the first entry.
		 * @returns {*|undefined}
		 */
		first: function () {
			var collection = this.getAll();
			return Object.values(collection).shift();
		},
		/**
		 * Get an entry by its index.
		 * @param {(number|string)} key - The entry key
		 * @return {*}
		 */
		get: function (key) {
			if (typeof key === 'undefined') {
				return;
			}

			if (!this.validateKey(key)) {
				throw new TypeError('key must be a number or a string');
			}

			var entries = this.getAll();
			return entries[key];
		},
		/**
		 * Get all entries in the data store.
		 * @returns {object}
		 */
		getAll: function () {
			var existent = Storage.get(this.storageKey, this.STORAGE_NAMESPACE);

			if (!existent) {
				existent = {d: this.defaultData, t: Date.now()};

				Storage.set(this.storageKey, existent, this.STORAGE_NAMESPACE);
			}

			return existent.d;
		},
		/**
		 * Get the last entry.
		 * @returns {*|undefined}
		 */
		last: function () {
			var collection = this.getAll();
			return Object.values(collection).pop();
		},
		/**
		 * Set an entry in the data store.
		 * @param {object} data - Object to insert
		 * @param {(number|string)} key - The entry key to override
		 */
		set: function (data, key) {
			if (!this.validate(data)) {
				wglog.debug('ModelObject::set() invalid data', data);
			}

			var set = this.getAll();

			if (!this.validateKey(key)) {
				throw new TypeError('key must be a number or a string');
			}

			set[key] = data;

			Storage.set(this.storageKey, {d: set, t: Date.now()}, this.STORAGE_NAMESPACE);
		},
		/**
		 * Set multiple entries in the data store.
		 * @param {object} data - An object to insert
		 */
		setAll: function (data) {
			if (typeof data !== 'object') {
				throw new TypeError('data must be an object');
			}

			Storage.set(this.storageKey, {d: data, t: Date.now()}, this.STORAGE_NAMESPACE);
		},
		/**
		 * Unset an entry in the data store.
		 * @param {(number|string)} key - The entry key
		 * @returns {object}
		 */
		unset: function (key) {
			if (typeof key === 'undefined') {
				return;
			}

			if (!this.validateKey(key)) {
				throw new TypeError('key must be a number or a string');
			}

			var set = this.getAll();

			if (!set[key]) {
				return;
			}

			delete set[key];

			Storage.set(this.storageKey, {d: set, t: Date.now()}, this.STORAGE_NAMESPACE);
		},
		/**
		 * Unset all entries in the data store.
		 */
		unsetAll: function () {
			Storage.set(this.storageKey, {d: this.defaultData, t: Date.now()}, this.STORAGE_NAMESPACE);
		},
		/**
		 * Validate an object to insert in the data store.
		 * @param {object} data - Object to validate
		 * @return {boolean}
		 */
		validate: function (data) {
			throw new Error('This method must be overridden.');
		},
		/**
		 * Validate key.
		 * @param key
		 * @return {boolean}
		 */
		validateKey: function (key) {
			return typeof key === 'number' || typeof key === 'string';
		},
		/**
		 * Validate a date formatted as string.
		 * @param {String} date - Date
		 * @return {boolean}
		 */
		validateDateString: function (date) {
			return typeof date === 'string' && !Number.isNaN(Date.parse(date));
		}
	});

	return ModelObject;
});
define('features/Reminder/models/ReminderModel',[
	'core/ModelObject'
], function (
	ModelObject
) {
	/**
	 * @extends ModelObject
	 * @constructor
	 */
	var ReminderModel = function () {
		this.storageKey = 'reminder';
		ModelObject.call(this);
	};

	ReminderModel.prototype = Object.create(ModelObject.prototype);

	Object.assign(ReminderModel.prototype, {
		save: function (entry) {
			this.set(entry, entry.target_id);
		},
		validate: function (data) {
			if (typeof data.reminder_id !== 'number') return false;
			if (typeof data.target_id !== 'number') return false;
			if (typeof data.reminder_description !== 'string') return false;
			if (!this.validateDateString(data.remind_at)) return false;
			if (data.created && !this.validateDateString(data.created)) return false;
			if (data.dismiss_at && !this.validateDateString(data.dismiss_at)) return false;
			if (data.status && typeof data.status !== 'string') return false;

			return true;
		}
	});

	return new ReminderModel();
});
define('features/ContactList/views/ContactListView',[
	'config/chat',
	'core/View',
	'lib/i18n!front',
	'lib/tools',
	'lib/utils',
	'lib/emoji',
	'lib/storage',
	'lib/helpers/popup/contextual_menu',
	'text!features/ContactList/views/ContactList.mustache',
	'features/ContactList/views/components/SupportsList/SupportsList',
	'features/ContactList/views/components/ContactListTab/ContactListTab',
	'features/ContactList/views/components/Avatar/Avatar',
	'features/ContactList/views/components/Contact/Contact',
	'features/ContactList/views/components/LoadMore/LoadMore',
	'features/Message/utils/Message',
	'features/Reminder/models/ReminderModel'
], function(
	Config,
	View,
	i18n,
	tools,
	utils,
	emoji,
	Storage,
	ContextualMenu,
	tplContactList,
	SupportsList,
	ContactListTab,
	Avatar,
	Contact,
	LoadMore,
	MessageUtils,
	ReminderModel
) {

	var CHAT_LOADER = 'chat_loading_overlay',
		CHAT_LOADER_SELECTOR = '#' + CHAT_LOADER,
		CONTACTS_LISTS_WRAPPER = 'chat-users-lists',
		CONTACTS_LISTS_WRAPPER_SELECTOR = '#' + CONTACTS_LISTS_WRAPPER,
		CONTACTS_TABS_WRAPPER = 'chat-sidebar__tabs',
		CONTACTS_TABS_WRAPPER_SELECTOR = '.' + CONTACTS_TABS_WRAPPER,
		CONTACT_CLASS = 'chat-user',
		CONTACT_CLASS_AVATAR = CONTACT_CLASS + '__avatar',
		CONTACT_AVATAR_SELECTOR = '.' + CONTACT_CLASS_AVATAR,
		CONTACT_NEW_MESSAGE_CLASS = CONTACT_CLASS + '--new',
		LOCALSTORAGE_KEY_FILTER = 'chat.contact_list_filter',
		LOCALSTORAGE_KEY_TAB = 'chat.contact_list_tab';

	var LIST_TYPE = 'inbox',
		TOTAL_CONTACT = 'total-' + LIST_TYPE,
		TOTAL_UNREAD_MESSAGE_CONTACT = 'total-unread-message-' + LIST_TYPE;

	var ContactListView = function(result) {
		this.active = null;
		this.created = false;

		this.contactListWrapperElement = null;
		this.contactListTab = null;
		this.contactListTabContainer = null;
		this.deferFn = null;

		this.countContact = null;
		this.countUnread = null;

		this.loadMoreComponent = null;
		this.supportsListComponent = null;

		this.pageCurrent = 1;
		this.pageLast = null;

		this.template = tplContactList;

		View.call(this);

		this.initList(result);
	};

	Object.defineProperties(ContactListView, {
		LOCALSTORAGE_KEY_TAB: {value: LOCALSTORAGE_KEY_TAB, writable: false},
	});

	ContactListView.prototype = Object.create(View.prototype);

	Object.assign(ContactListView.prototype, {
		addListeners: function() {},
		attachContact: function(contactJson, source, updateSupports) {
			if (contactJson.is_support && !updateSupports) return;

			// wglog.debug('ContactListView - attachContact', contactJson, source, updateSupports);

			if (source === 'search') {
				var searchListContainer = document.querySelector('#chat-users-search');
				if (!!searchListContainer) {
					searchListContainer.append(this.generateContactHtml(contactJson, source));
				}
				this.hideLoadMore();
				return;
			}

			this.element.append(this.generateContactHtml(contactJson, source));
		},
		attachContactListTab: function() {
			wglog.debug('ContactListView - attachContactListTab');

			this.contactListTabContainer.prepend(this.contactListTab.getElement());
		},
		clearOldAndNewContactListsHtml: function(newList, oldList) {
			wglog.debug('ContactListView - clearOldAndNewContactListsHtml');

			var allContactLists = this.mediator.getAllContactLists();
			allContactLists[oldList].clearContactListHtml();
			allContactLists[newList].clearContactListHtml();

			this.switchContactListUI(newList, true);
		},
		clearContactList: function() {
			if (this.supportsListComponent) {
				this.supportsListComponent.clearContactListSupportHtml(true);
			}

			this.countContact = null;
			this.countUnread = null;

			if (this.loadMoreComponent) {
				this.loadMoreComponent.disconnect();
				this.loadMoreComponent.getElement().remove();
				this.loadMoreComponent = null;
			}

			this.contactListTab.removeElementListeners();
			this.contactListTab.getElement().remove();
			this.contactListTab = null;

			this.removeElementListeners(this.getNamespaceListeners('contact'));
			this.element.remove();

			this.setFilterContactList(Storage.get(LOCALSTORAGE_KEY_FILTER));
		},
		clearContactListHtml: function() {
			var allContacts = this.element.querySelectorAll('.chat-user');
			if (allContacts.length === 0) {
				return;
			}

			//wglog.debug('ContactListView - clearContactListHtml');

			allContacts.forEach(function(element) {
				element.remove();
			});
		},
		createContactList: function(contacts) {
			wglog.debug('ContactListView - createContactList', this.getListType(), contacts);

			this.contactListWrapperElement = document.querySelector(CONTACTS_LISTS_WRAPPER_SELECTOR);
			if (this.contactListWrapperElement) {
				this.contactListWrapperElement.append(this.element);
			}

			this.mediator.createContactList(contacts, this.getListType());
		},
		createContactListTab: function() {
			// wglog.debug('ContactListView - createContactListTab');

			this.contactListTab = new ContactListTab({
				active: this.active,
				listName: this.getListName(),
				listType: this.getListType(),
				total: this.countContact,
				activeContactList: this.switchContactListUI.bind(this)
			});
			this.attachContactListTab();
		},
		createLinkLoadMoreContact: function() {
			wglog.debug('ContactListView - createLinkLoadMoreContact -', this.getListType());

			this.loadMoreComponent = new LoadMore({
				label: i18n.__('chat.show_more_contacts'),
				listType: this.getListType(),
				loading: i18n.__('loading.loading'),
				loadMore: this.loadMore.bind(this),
				rootObserverElement: this.contactListWrapperElement
			});

			this.contactListWrapperElement.append(this.loadMoreComponent.getElement());

			if (this.active) this.showLoadMore();
			else this.hideLoadMore();
		},
		decreaseContactCount: function() {
			// wglog.debug('ContactListView - decreaseContactCount', this.countContact);

			if (this.countContact <= 0) {
				return;
			}

			this.countContact--;
		},
		formatLastMessageDate: function (timestamp) {
			// wglog.debug('ContactListView - formatLastMessageDate', timestamp);

			if (!timestamp) {
				wglog.debug('ContactListView - formatLastMessageDate : No timestamp');
				return '';
			}

			if (!Number.isInteger(timestamp)) {
				timestamp = parseInt(timestamp);
			}

			var date = new Date(timestamp * 1000),
				diff = Date.now() - date.getTime(),
				todayMidnight = new Date();

			todayMidnight.setHours(0, 0, 0, 0);

			var maxTime = Date.now() - todayMidnight.getTime(),
				formatOptions = {
					hour: 'numeric',
					minute: 'numeric'
				};

			if (diff >= maxTime) {
				formatOptions = {
					year: 'numeric',
					month: 'short',
					day: 'numeric'
				};
			}

			return new Intl.DateTimeFormat(Config.locale, formatOptions).format(date);
		},
		generateAvatarHtml: function(contactJson) {
			// wglog.debug('ContactListView - generateAvatarHtml', contactJson);

			var withProfileLink = false,
				withStatus = true,
				withReminder = Config.login_info.is_support ? ReminderModel.get(contactJson.id_user) : false,
				avatarTplConfig = {
					alt: contactJson.profile_name,
					is_user_inactive: (contactJson.user_status ===  'inactive'),
					is_user_not_reviewed: (!!contactJson.review_status && contactJson.review_status !== 'validated'),
					modifier: '',
					profile_url: (contactJson.is_creator && withProfileLink) ? contactJson.profile_url : false,
					profile_url: false,
					reminder: (!withReminder || !withReminder.remind_at) ? false : {
						status: new Date(withReminder.remind_at) > Date.now() ? 'waiting' : 'ringing',
						desc: withReminder.reminder_description
					},
					review_not_validated: i18n.__('chat.application.not_validated'),
					status: (!!withStatus && !!contactJson.status) ? contactJson.status.toLowerCase() : false,
					src: contactJson.profile_picture
				};

			return new Avatar(avatarTplConfig);
		},
		generateContactHtml: function(contactJson, source, reminder) {
			// wglog.debug('ContactListView - generateContactHtml', contactJson);

			var content = this.getLastMessageWithEmojis(contactJson);
			if (content) {
				contactJson.message = {
					content: content,
					date: this.formatLastMessageDate(contactJson.last_message.t)
				}
				contactJson.user = {
					earnings_label: i18n.__('chat.total_earnings'),
					earnings_amount: 0
				}
			}

			var contact = this.generateContactContentHtml(contactJson, source),
				contactHtml = contact.getElement(),
				avatar = this.generateAvatarHtml(contactJson, reminder),
				avatarHtml = avatar.getElement();

			contactHtml.querySelector('.chat-user__avatar').append(avatarHtml);
			this.addElementListener(contactHtml, 'click', this.onClickContact.bind(this, contactJson.id_user), 'contact');

			return contactHtml;
		},
		generateContactContentHtml: function(contactJson, source) {
			// wglog.debug('ContactListView - generateContactContentHtml', contactJson, source);

			var contactTplConfig = {
				attributes: {},
				class: '',
				expenses: contactJson.expenses_fmt,
				id_user: contactJson.id_user,
				inactive_status_text: i18n.__('chat.status.inactive'),
				is_support: contactJson.is_support,
				is_user_inactive: (contactJson.user_status ===  'inactive'),
				is_user_not_reviewed: (!!contactJson.review_status && contactJson.review_status !== 'validated'),
				message: contactJson.message,
				nb_unread: (contactJson.is_blocked || contactJson.is_ghosted) ? 0 : contactJson.nb_unread,
				profile_name: contactJson.profile_name,
				search: (source === 'search'),
				selected: false,
				status_trad: contactJson.status,
				type: this.getContactType(contactJson)
			}

			if (typeof contactJson.tip_amount === 'string' && +contactJson.tip_created > +contactJson.last_read) {
				contactTplConfig.tip = {
					title: i18n.__('chat.last_tip'),
					amount: new Intl.NumberFormat(config.locale, { style: 'currency', currency: 'USD' }).format(contactJson.tip_amount)
				};
			}

			return new Contact(contactTplConfig);
		},
		generateContactListHtml: function(updateSupport) {
			var allContacts = this.mediator.getAllContactsData();
			wglog.debug('ContactListView - generateContactListHtml - updateSupport', updateSupport, allContacts);

			for (var contact in allContacts) {
				this.attachContact(allContacts[contact], 'online', updateSupport);
			}
		},
		getContactHtml: function(id) {
			return this.element.querySelector('#select_friend_li_' + id);
		},
		getContactTotalId: function() {
			return TOTAL_CONTACT;
		},
		getContactTotalUnread: function() {
			return TOTAL_UNREAD_MESSAGE_CONTACT;
		},
		getContactType: function(contactJson) {
			if (Config.login_info.is_creator && !contactJson.is_support && typeof contactJson.network !== 'undefined') {
				return 'fan-network';
			} else if (Config.login_info.is_creator && !contactJson.is_support && contactJson.is_sheer_user) {
				return 'fan-sheer';
			} else if (Config.login_info.is_support && !contactJson.is_support && !contactJson.is_creator) {
				return 'fan';
			} else if (Config.login_info.is_support && contactJson.is_creator) {
				return 'creator';
			} else if (contactJson.is_support) {
				return 'support';
			}
		},
		getCurrentPage: function() {
			return this.pageCurrent;
		},
		getForcedTemplateParams: function () {
			return {
				listType: this.getListType()
			};
		},
		getLastMessage: function (contactJson) {
			if (!contactJson.last_message
				|| Object.getPrototypeOf(contactJson.last_message) !== Object.prototype
				|| !contactJson.last_message.s
				|| !contactJson.last_message.m
			) {
				wglog.debug('ContactListView - getLastMessage : No last_message entry');
				return '';
			}

			var last_message = contactJson.last_message;
			var keys = undefined;

			if (contactJson.last_message_key && Object.getPrototypeOf(contactJson.last_message_key) == Object.prototype) {
				keys = Object.values(this.mediator.getChatFriendManager().decrypt_conv_key(contactJson.last_message_key));
			}

			if (keys && keys.length && !keys[0]) {
				keys = undefined;
			}

			var message = this.mediator.getMessage(last_message.m, contactJson.id_user, keys);

			try {
				var json = JSON.parse(message);

				if (last_message.y === "c") { // Case: content
					message = this.mediator.getMessageTextVault(json);
				} else if (last_message.y === "fw") {
					message = utils.escapeHtml(json.q);
				} else if (last_message.y === "sr") {
					message = MessageUtils.getSpamReportMessage(json.r);
				} else if (last_message.y === "tip" && json.param['%message%']) { // Start fix - fix some message badly saved
					message = utils.escapeHtml(json.param['%message%']); // End fix
				} else if (json.m) { // Case: quote
					message = utils.escapeHtml(json.m);
				} else if (typeof json.type !== "undefined" && json.type === "upload") { // File uploaded
					message = this.mediator.getMessageTextUpload(json);
				} else {
					message = utils.escapeHtml(message);
				}
			} catch (e) {
				// Normal message case => no error.
				message = utils.escapeHtml(message);
			}

			return message;
		},
		getLastMessageWithEmojis: function (contactJson) {
			if (!contactJson || !contactJson.last_message || !contactJson.last_message.t || ["c","f","fw","sr","sfw"].indexOf(contactJson.last_message.y) < 0) {
				return '';
			}

			var content = this.getLastMessage(contactJson);

			if (content) {
				content = emoji.utf8ToHtml(content);
			}

			if (contactJson.last_message.y === 'fw') {
				content = '<span class="icon-f icf-forward"></span> ' + content;
			}

			return content;
		},
		getListName: function() {
			return i18n.__('chat.inbox');
		},
		getListType: function() {
			return LIST_TYPE;
		},
		handlerTabContactList: function() {
			wglog.debug('ContactListView - handlerTabContactList');
			var allContactLists = this.mediator.getAllContactLists(),
				contactListsKeys = Object.keys(allContactLists);

			if (contactListsKeys.indexOf('init') !== -1 && contactListsKeys.length < 2) {
				wglog.debug('ContactListView - handlerTabContactList - No multiple contact list');
				return;
			}

			for (var list in allContactLists) {
				var currentList = allContactLists[list];

				if (currentList instanceof Set) continue;

				if (currentList.deferFn && typeof currentList.deferFn === 'function'){
					wglog.debug('ContactListView - handlerTabContactList - No multiple contact list');
					currentList.deferFn();
					currentList.deferFn = null;
				}
			}
		},
		hideContactList: function() {
			// wglog.debug('ContactListView - hideContactList');

			this.active = false;
			this.element.classList.add('is-hidden');
		},
		hideLoadMore: function() {
			if (!this.loadMoreComponent || this.loadMoreComponent.isHidden()) {
				return;
			}
			this.loadMoreComponent.disconnect();
			this.loadMoreComponent.hide();
		},
		hideLoader: function() {
			var loader = document.querySelector(CHAT_LOADER_SELECTOR);
			if (!loader || !loader.classList.contains('is-hidden')) {
				return
			}

			// wglog.debug('ContactListView - hideLoader');
			loader.classList.add('is-hidden');
		},
		hideContactListTab: function() {
			// wglog.debug('ContactListView - hideContactListTab');

			if (!this.contactListTab) {
				wglog.debug("ContactListView - hideContactListTab : No contact list tab");
				return;
			}

			this.contactListTab.getElement().classList.add('is-hidden');
		},
		hideUI: function() {
			// wglog.debug('ContactListView - hideUI');

			this.hideContactListTab();
			this.hideContactList();
			if (this.supportsListComponent) {
				this.supportsListComponent.hideSupportTogglerButton(true);
				this.supportsListComponent.hideSupportToggler();
			}
            if (this.loadMoreComponent) {
                this.loadMoreComponent.hide();
            }
		},
		increaseContactCount: function() {
			// wglog.debug('ContactListView - increaseContactCount');

			this.countContact++;
		},
		initList: function(result) {
			wglog.debug('ContactListView - initList:', result);

			this.contactListTabContainer = document.querySelector(CONTACTS_TABS_WRAPPER_SELECTOR);
			if (!this.contactListTabContainer) {
				return;
			}

			this.pageCurrent = 1;

			if (result.contact_count) {
				this.countContact = result.contact_count;
				if (result.contact_count === 0) {
					var noFriendElement = document.createElement('div');
					noFriendElement.classList.add('chat-users__no-friends chat_no_friends');
					noFriendElement.innerText = i18n.__('chat.infos.no_friends');
					this.element.append(noFriendElement);
				}
			}

			this.pageLast = !result.last_page ? 0 : +result.last_page;

			this.setContactListActiveState();
			this.createContactListTab();
			this.createContactList(result.friends_infos);
			this.addListeners();

			this.mediator.initContactListManager(result);

			if (!this.created) {
				this.listCreated();
				if ((this.pageLast && this.pageLast > 1) || (this.getListType() === 'inbox' && this.countContact > 40)) {
					this.createLinkLoadMoreContact();
				}
			}
		},
		listCreated: function() {
			this.created = true;

			var allContactLists = this.mediator.getAllContactLists(),
				listType = this.getListType();

			if (allContactLists.init.has(listType)) allContactLists.init.delete(listType);

			if (allContactLists.init.size === 0) delete allContactLists.init;

            this.mediator.emitContactListCreated();
		},
		loadMore: function() {
			wglog.debug('ContactListView - loadMore -', this.getListType());

			this.loadMoreComponent.loading();
			this.pageCurrent++;

			if (this.pageCurrent <= this.pageLast) {
				this.mediator.loadMore(this.pageCurrent);
			}
		},
		loadMoreCheckAvailability: function() {
			if (this.pageCurrent === this.pageLast && this.loadMoreComponent) {
				this.loadMoreComponent.disconnect();
				this.loadMoreComponent.hide();
			}
		},
		loadMoreNotLastPage: function() {
			return this.pageCurrent < this.pageLast;
		},
		manageNewMessageClass: function(contactIdSelected, nbUnread) {
			// wglog.debug('ContactListView - manageNewMessageClass', contactIdSelected);
			var conversation = document.querySelector("#chat_group_messages_tab_" + contactIdSelected);
			if (!conversation) {
				return;
			}

			var inputs = conversation.querySelectorAll('.chat-message__read-status input'),
				allMessagesRead = true;

			inputs.forEach(function (input) {
				if (allMessagesRead && !input.checked) {
					allMessagesRead = false;
				}
			});

			var contactItemHtml = this.getContactHtml(contactIdSelected);
			if (!contactItemHtml && this.mediator.getContactIsSupport(contactIdSelected)) {
				var supportContainerHtml = document.querySelector('#chat-users-support');
				contactItemHtml = supportContainerHtml.querySelector('#select_friend_li_' + contactIdSelected);
			}
			if (!!contactItemHtml) {
				contactItemHtml.classList[(allMessagesRead || nbUnread === 0) ? 'remove' : 'add'](CONTACT_NEW_MESSAGE_CLASS);
			}
		},
		onClickContact: function(contactId) {
			// wglog.debug('ContactListView - onClickContact', contactId);

			this.mediator.selectContact(contactId);
		},
		refreshAllCounters: function() {
			// wglog.debug('ContactListView - refreshAllCounters');
			if (!Config.login_info.is_creator) {
				return;
			}

			var counters = {
				'contact': {
					'selector': '#' + this.getContactTotalId(),
					'total' : this.countContact
				},
				'unread': {
					'selector': '#' + this.getContactTotalUnread(),
					'total' : this.countUnread
				}
			}

			for (var counter in counters) {
				var currentCounter = counters[counter];
				this.refreshCounter(currentCounter.selector, currentCounter.total);
			}

			this.countUnread = 0;
		},
		refreshCounter: function(counter, total) {
			// wglog.debug('ContactListView - refreshCounter', element, total);

			if (!counter) {
				wglog.debug("ContactListView - refreshCounter : No counter");
				return;
			}

			if (!this.contactListTab) {
				wglog.debug("ContactListView - refreshCounter : No contact list tab");
				return;
			}

			counter = this.contactListTab.getElement().querySelector(counter);
			if (!counter) {
				wglog.debug("ContactListView - refreshCounter : No counter element");
				return;
			}

			if (!total || total < 0) {
				wglog.debug("ContactListView - refreshCounter : No total");
                counter.classList.add('is-hidden');
				return;
			}

			counter.classList[!total ? 'add' : 'remove']('is-hidden');
			counter.textContent = tools.formatNumberCompact(total);
		},
		removeContact: function(contactId) {
			// wglog.debug('ContactListView - removeContact', contactId);
			var contactHtml = this.element.querySelector('#select_friend_li_' + contactId);
			if (!!contactHtml) {
				contactHtml.remove();
			}
			this.refreshAllCounters();
		},
		setContactListActiveState: function() {
			// wglog.debug('ContactListView - setContactListActiveState');

			var listType = this.getListType(),
				isListTypeFollower = listType !== 'customers' && listType !== 'inbox',
				customersListExists = this.mediator.getAllContactLists().init.has('customers') || this.mediator.getAllContactLists().customers,
				tab = Storage.get(LOCALSTORAGE_KEY_TAB) || 'customers';

			Storage.set(LOCALSTORAGE_KEY_TAB, tab);

			if (customersListExists
				&& (isListTypeFollower && tab === 'customers')
				|| (!isListTypeFollower && tab === 'followers')) {
				this.active = false;
				this.element.classList.add('is-hidden');
			} else {
				this.active = true;
			}

			if (this.element.getAttribute('id').indexOf('customers') !== -1) {
				this.element.id = 'chat-users-inbox';
			}
		},
		setFiltersContactListButton: function(actions) {
			var button = document.querySelector('.chat-contact-list-filters.btn--contact-list-filters'),
				classIsInit = 'is-init';

			if (button.classList.contains(classIsInit)) return;

			var generateContextMenuAction = function (menuItem, isActive) {
				return {
					callback: menuItem.callback,
					isActive: isActive,
					label: menuItem.label,
					name: menuItem.name
				};
			};

			var activeFilter = Storage.get(LOCALSTORAGE_KEY_FILTER);
			if (!activeFilter) activeFilter = 'unreads';

			var cm_actions = [];
			for (var action in actions) {
				cm_actions.push(generateContextMenuAction(actions[action], actions[action].name === activeFilter));
			}

			var cm = new ContextualMenu(button, cm_actions, {
				position: {v: 'below', h: 'right'},
				on_open: function () {
					var popup = cm.getPopup();
					popup.children('.x-popup-content').css({borderTopRightRadius: 0});
					popup.find('.contextual-menu').addClass('chat-contact-list-filters-contextual-menu');

					if (popup.width() <= button.offsetWidth) {
						popup.children('.x-popup-content').css({borderTopLeftRadius: 0});
					}

					button.classList.add('btn--contact_list-filters--open');
				},
				on_close: function () {
					button.classList.remove('btn--contact_list-filters--open');
				}
			});

			button.classList.add(classIsInit);
		},
		setFilterContactList: function(filter) {
			if (!filter) return;

			var _filter = filter,
				cm = document.querySelector('.chat-contact-list-filters-contextual-menu');

			if (!cm) return;

			var classIsActive = 'is-active';
			cm.querySelectorAll('button').forEach(function(button) {
				if (button.classList.contains(classIsActive)) button.classList.remove(classIsActive);
				if (button.dataset.action === _filter) button.classList.add(classIsActive);
			});
		},
		setUnreadMessage: function(nbUnread) {
			this.countUnread = +nbUnread;
		},
		setTabContactList: function(listCreated) {
			var tabToSet = Storage.get(LOCALSTORAGE_KEY_TAB),
				allContactLists = this.mediator.getAllContactLists(),
				self = this;

			if (tabToSet && listCreated === tabToSet) {
				if (allContactLists[tabToSet]) {
					this.switchContactListUI(tabToSet);
				}
				else {
					this.deferFn = function() {
						wglog.debug('ContactListView - setTabContactList - defer', listCreated, tabToSet, allContactLists);
						if (allContactLists[tabToSet]) self.switchContactListUI(tabToSet);
					}
				}
			}
		},
		showContactList: function() {
			// wglog.debug('ContactListView - showContactList');

			this.active = true;
			this.element.classList.remove('is-hidden');
		},
		showLoadMore: function() {
			var listIsNotSelected = this.getListType() !== Storage.get(LOCALSTORAGE_KEY_TAB),
				noLoadMore = !this.loadMoreComponent && this.pageCurrent >= this.pageLast

			if (listIsNotSelected || noLoadMore) {
				return;
			}
			this.loadMoreComponent.show();
			this.loadMoreComponent.hideLoading();
			this.loadMoreComponent.connect();
		},
		showContactListTab: function() {
			// wglog.debug('ContactListView - showContactListTab');

			if (!this.contactListTab) {
				wglog.debug("ContactListView - showContactListTab : No contact list tab");
				return;
			}

			this.contactListTab.getElement().classList.remove('is-hidden');
		},
		showUI: function() {
			// wglog.debug('ContactListView - showUI');

			this.showContactListTab();
			this.showContactList();
			if (this.supportsListComponent) {
				this.supportsListComponent.showSupportToggler();
				this.supportsListComponent.showSupportTogglerButton();
			}
            if (this.loadMoreComponent) {
                this.loadMoreComponent.show();
            }
		},
		switchContactListUI: function(tabToSwitch, updateCounter) {
			wglog.debug('ContactListView - switchContactListUI', tabToSwitch);

			var allContactLists = this.mediator.getAllContactLists();
			if (!allContactLists) {
				wglog.debug('ContactListView - switchContactList no contact list');
				return;
			}

			for (var list in allContactLists) {
				var currentContactList = allContactLists[list],
					skip = (currentContactList instanceof Set || currentContactList.getListType() === 'supports');

				if (skip) continue;

				var showList = (!tabToSwitch && list === this.getListType()) || list === tabToSwitch;
				if (showList) {
					Storage.set(LOCALSTORAGE_KEY_TAB, list);
					currentContactList.contactListTab.contactListActive();
					currentContactList.showContactList();
					if (currentContactList.loadMoreComponent && currentContactList.loadMoreNotLastPage()) {
						currentContactList.showLoadMore();
					}
					if (updateCounter) currentContactList.increaseContactCount();
				} else {
					currentContactList.contactListTab.contactListInactive();
					currentContactList.hideContactList();
					if (currentContactList.loadMoreComponent) currentContactList.hideLoadMore();
					if (updateCounter) currentContactList.decreaseContactCount();
				}

				if (updateCounter) {
					currentContactList.refreshAllCounters();
				}
			}
		},
		updateAvatar: function(contactJson, reminder) {
			var newAvatarHtml = this.generateAvatarHtml(contactJson, reminder),
				contactHtml = this.getContactHtml(contactJson.id_user);

			contactHtml.querySelector(CONTACT_AVATAR_SELECTOR).remove();
			contactHtml.prepend(newAvatarHtml.getElement());
		},
        updateCountContact: function(count) {
            if (count > this.countContact) {
                this.countContact = count;
                this.refreshAllCounters();
            }
        },
		updateContactList: function(updateSupport) {
			wglog.debug('ContactListView - updateContactList - updateSupport :', updateSupport, '- listType :', this.getListType());

			this.clearContactListHtml();
			this.generateContactListHtml(updateSupport);
			this.refreshAllCounters();

			if (this.loadMoreComponent && this.loadMoreNotLastPage()) this.showLoadMore();

			this.handlerTabContactList();
		},
		updateContactLogStatus: function(contactId, contactStatus) {
			// wglog.debug('ContactListView - updateContactLogStatus', contactId, contactStatus);

			var contact = this.getContactHtml(contactId);
			if (!contact) {
				wglog.debug('ContactListView - updateContactLogStatus - No contact');
				return;
			}
			contact.querySelector('.chat-user__avatar').setAttribute('title', contactStatus);

			var avatar = contact.querySelector('.chat-avatar');
			if (!avatar) {
				wglog.debug('ContactListView - updateContactLogStatus - No avatar');
			}
			if (contactStatus === 'Online') {
				avatar.classList.remove('chat-avatar--offline');
				avatar.classList.add('chat-avatar--online');
			} else if (contactStatus === 'Offline') {
				avatar.classList.remove('chat-avatar--online');
				avatar.classList.add('chat-avatar--offline');
			}
		},
		updateUnreadMessageBadge: function(contactId, nbUnread) {
			// wglog.debug('ContactListView - updateUnreadMessageBadge');

			var contact = this.element.querySelector('#select_friend_li_' + contactId);

			if (!contact) {
				return;
			}

			var badge = contact.querySelector('.chat-user__badge');

			if (nbUnread > 0) {
                if (!badge) {
                    badge = document.createElement('span');
                    badge.classList.add('badge', 'chat-user__badge');
				    contact.querySelector('.chat-user__last-message-status').append(badge);
                }
				badge.innerText = nbUnread;
			} else if (badge) {
				badge.remove();
			}
		}
	});

	return ContactListView;

});
define('features/ContactList/commands/AllContactsCommand',[
	'log_and_tooltip',
	'libs/EventEmitter',
	'core/Command',
	'features/ContactList/views/ContactListView',
	'features/ContactList/events/ContactListEvent',
], function(
	log_and_tooltip,
	EventEmitter,
	Command,
	ContactListView,
	ContactListEvent
) {
	var AllContacts = function(context) {
		Command.call(this, context);
	};

	AllContacts.prototype = Object.create(Command.prototype);

	Object.assign(AllContacts.prototype, {
		execute: function (result) {
			if (!result) {
				return;
			}

			if (!this.context.manager.contactLists) {
				this.context.manager.contactLists = {};
			}

			var list = this.formatList(result);
			this.context.chatFriendManager.set_friends_id(list.friends_ids);

			if (!this.context.manager.contactLists.inbox) {
				this.createNewList(list);
			} else {
				this.updateList(list);
			}
		},
		createNewList: function(list) {
			wglog.debug('AllContactsCommand create new list', list);
			this.context.manager.contactLists.inbox = new ContactListView(list);
		},
		formatList: function(json) {
			var list = {
				friends_ids: [],
				friends_infos: json.data || [],
				contact_count: json.total || 0,
				last_page: json.lastPage || 1,
				type: 'inbox'
			};

			for (var index in json.data) {
				var contact = json.data[index];
				list.friends_ids.push(contact.id_user);
			}

			return list;
		},
		updateList: function(list) {
			wglog.debug('AllContactsCommand update list', list);
			EventEmitter.emit(ContactListEvent.UPDATE_LIST, list);
		}
	});

	return AllContacts;
});
define('features/ContactList/commands/AllIdsAndContactsCommand',[
	'config/chat',
	'log_and_tooltip',
	'lib/i18n!front',
	'libs/EventEmitter',
	'core/Command',
	'features/ContactList/views/ContactListView',
	'features/ContactList/events/ContactListEvent',
	'features/ContactList/SupportList/events/SupportListEvent'
], function(
	config,
	log_and_tooltip,
	i18n,
	EventEmitter,
	Command,
	ContactListView,
	ContactListEvent,
	SupportListEvent
) {
	var AllIdsAndContacts = function(context) {
		Command.call(this, context);
	};

	AllIdsAndContacts.prototype = Object.create(Command.prototype);

	Object.assign(AllIdsAndContacts.prototype, {
		execute: function (result, ack) {
			if (typeof ack === 'function') ack(true);

			if (!config.login_info.is_creator && !result.source && (!result.friends_ids || !result.first_friends_infos) && (!result.requested_ids || !result.friendlist)) {
				log_and_tooltip.write_error({
					logTitle: 'AllIdsAndContactsCommand Unable get friends',
					message: i18n.__('chat.error.unable_get_friends')
				});
				return false;
			}

			var chatFriendManager = this.context.chatFriendManager,
				list = this.formatList(result);

			if (list.friends_ids instanceof Array) {
				var indexUserId = list.friends_ids.indexOf(chatFriendManager.user_id);
				if (indexUserId > -1) {
					list.friends_ids.splice(indexUserId, 1);
				}
			}

			chatFriendManager.set_friends_id(list.friends_ids);

			if (!this.context.manager.contactLists.inbox) {
				this.createNewList(list, result.supports);
			} else {
				this.updateList(list);
			}
		},
		createNewList: function(list, supports) {
			wglog.debug('AllIdsAndContactsCommand create new list', list);
			if (config.login_info.is_support) {
				EventEmitter.emit(SupportListEvent.ALL_SUPPORTS_SUCCESS, supports);
			}
			this.context.manager.contactLists.inbox = new ContactListView(list);
		},
		filterSupports: function(json) {
			var siteName = config.i18n_website_name,
				supportSheer = [43038153, 43038155, 43038156, 43038158],
				supportPornbox = [42422876];

			json.first_friends_infos.data = json.first_friends_infos.data.filter(function(contact) {
				if ((siteName === 'Pornbox' && supportSheer.indexOf(contact.id_user) === -1) || (siteName === 'Sheer' && supportPornbox.indexOf(contact.id_user) === -1)) {
					return contact;
				}
			});

			json.friends_ids = json.friends_ids.filter(function(id) {
				if ((siteName === 'Pornbox' && supportSheer.indexOf(id) === -1) || (siteName === 'Sheer' && supportPornbox.indexOf(id) === -1)) {
					return id;
				}
			});

			return json;
		},
		formatList: function(_json) {
			var json = this.filterSupports(_json),
				friends_infos = json.first_friends_infos;

            if (json.supports) {
                friends_infos.data = json.supports.data.concat(friends_infos.data);
            }

			return {
				friends_ids: json.friends_ids,
				friends_infos: friends_infos,
				contact_count: json.contact_count || 0,
				last_page: json.first_friends_infos.lastPage,
				type: 'inbox'
			};
		},
		updateList: function(list) {
			wglog.debug('AllIdsAndContactsCommand update list', list);
			EventEmitter.emit(ContactListEvent.UPDATE_LIST, list, 'create');
		}
	});

	return AllIdsAndContacts;
});
define('features/ContactList/commands/ClearContactListCommand',[
	'core/Command'
], function(
	Command
) {
	var ClearContactListCommand = function(context) {
		Command.call(this, context);
	};

	ClearContactListCommand.prototype = Object.create(Command.prototype);

	Object.assign(ClearContactListCommand.prototype, {
		execute: function (listType) {
			this.context.manager.contactLists[listType].remove();
			delete this.context.manager.contactLists[listType];
		},
	});

	return ClearContactListCommand;
});
define('services/SocketConnectionEvent',[], function () {
	var SocketConnectionEvent = Object.create(null);

	Object.defineProperties(SocketConnectionEvent, {
		in: {value: {}, writable: false},
		out: {value: {}, writable: false},
		socketio: {value: {}, writable: false}
	});

	Object.defineProperties(SocketConnectionEvent.in, {
		ANNOUNCEMENT_DELETED: {value: 'announcement_deleted', writable: false},
		ANNOUNCEMENT_FOUND: {value: 'announcement_found', writable: false},
		ANNOUNCEMENT_SAVED: {value: 'announcement_saved', writable: false},
		CHAT_ERROR: {value: 'chat_error', writable: false},
		// CHAT_ERROR_FATAL: {value: 'chat_error_fatal', writable: false},
        CONTACTS_INFO: {value: 'contacts_info', writable: false},
		CUSTOMER_REMOVED_FROM_CUSTOMER_LIST: {value: 'customer_removed_from_customer_list', writable: false},
		// FANS_EXPENSES: {value: 'fans_expenses', writable: false},
		// FILE_URL: {value: 'file_url', writable: false},
		// FILTERED: {value: 'filtered', writable: false},
		FOLLOW: {value: 'follow', writable: false},
		FOLLOWED_BY: {value: 'followed_by', writable: false},
		FOLLOWERS_ADDED_TO_CUSTOMER_LIST: {value: 'follower_added_to_customer_list', writable: false},
		// FORWARD_LIST_FORMAT_UPDATED: {value: 'forward_list_format_updated', writable: false},
		// FRIEND_BLOCKED_BY: {value: 'blocked_by_friend', writable: false},
		// FRIEND_BLOCKING: {value: 'blocking_friend', writable: false},
		// FRIEND_STATUS_CHANGED: {value: 'friend_status_changed', writable: false},
		// GET_ONLINE_FRIENDS: {value: 'get_online_friends', writable: false},
		// GET_PRIV_KEY_ERROR: {value: 'get_priv_key_error', writable: false},
		// GET_XV_USER_LIST_SUCCESS: {value: 'get_xv_user_list_success', writable: false},
		// HEADSHOT_UPDATED: {value: 'headshot_updated', writable: false},
		// IS_TYPING: {value: 'is_typing', writable: false},
		GET_CONTACT_CUSTOMERS_SUCCESS: {value: 'get_customers_list_success', writable: false},
		GET_CONTACT_FOLLOWERS_SUCCESS: {value: 'get_followers_list_success', writable: false},
        GET_SUPPORTS_LIST_SUCCESS: {value: 'get_supports_list_success', writable: false},
		LOG_RESULT: {value: 'log_result', writable: false},
		TARGETS_ESTIMATION: {value: 'targets_estimation_mass_message', writable: false},
		ALL_AUTO_MESSAGE: {value: 'all_auto_message', writable: false},
		ALL_EVENT_AUTO_MESSAGE: {value: 'all_event_auto_message', writable: false},
		AUTO_MESSAGE_EDITED: {value: 'auto_message_edited', writable: false},
		AUTO_MESSAGE_SAVED: {value: 'auto_message_saved', writable: false},
		AUTO_MESSAGE_SWITCHED: {value: 'auto_message_switched', writable: false},
		AUTO_MESSAGE_VAULT_CONTENT_CREATED: {value: 'auto_message_vault_content_created', writable: false},
		ALL_MASS_MESSAGE: {value: 'all_mass_message', writable: false},
		MASS_MESSAGE_CANCELLED: {value: 'mass_message_canceled', writable: false},
		MASS_MESSAGE_SAVED: {value: 'mass_message_saved', writable: false},
		MASS_MESSAGE_CONTENT_CREATED: {value: 'mass_message_content_created', writable: false},
		MASS_MESSAGE_CONTENT_GET: {value: 'mass_message_content_get', writable: false},
		MASS_MESSAGE_CONTENT_FOUND: {value: 'mass_message_content_found', writable: false},
		MASS_MESSAGE_VAULT_CONTENT_CREATED: {value: 'mass_message_vault_content_created', writable: false},
		MASS_MESSAGE_VAULT_CONTENT_GET: {value: 'mass_message_vault_content_get', writable: false},
		MASS_MESSAGE_VAULT_CONTENT_FOUND: {value: 'mass_message_vault_content_found', writable: false},
		REPORT_MESSAGE_ERROR: {value: 'report_message_error', writable: false},
		FAN_REPORT_MESSAGE_ERROR: {value: 'fan_report_message_error', writable: false},
		// MESSAGE_ALL_DELETED: {value: 'message_all_deleted', writable: false},
		// MESSAGE_DELETED: {value: 'message_deleted', writable: false},
		// MESSAGE_EDITED: {value: 'message_edited', writable: false},
		// MESSAGE_FORWARDED: {value: 'message_forwarded', writable: false},
		// MESSAGE_RECEIVED: {value: 'message_received', writable: false},
		MESSAGE_REPORTED: {value: 'message_reported', writable: false},
		FAN_MESSAGE_REPORTED: {value: 'fan_message_reported', writable: false},
		// NAME_UPDATED: {value: 'name_updated', writable: false},
		// NEW_CONVERSATION_KEY: {value: 'new_conversation_key', writable: false},
		// NEW_JWT_TOKEN: {value: 'new_jwt_token', writable: false},
		// READ_DATE_SET: {value: 'read_date_set', writable: false},
		// REGISTER_NEW_USER_FROM_XV_SUCCESS: {value: 'register_new_user_from_xv_success', writable: false},
		REMINDER_ALL_ACTIVE: {value: 'all_active_reminders', writable: false},
		REMINDER_HISTORY: {value: 'reminder_history', writable: false},
		REMINDER_INIT_DATA: {value: 'reminder_init_data', writable: false},
		REMINDER_SAVED: {value: 'reminder_saved', writable: false},
		REMINDER_DISMISSED: {value: 'reminder_dismissed', writable: false},
		SAVE_ANNOUNCEMENT_ERROR: {value: 'save_announcement_error', writable: false},
		// SEARCH_FRIENDS_FOUND: {value: 'found_friends', writable: false},
		// SEND_CONVERSATION: {value: 'send_conversation', writable: false},
		CONTACT_INIT_DATA: {value: 'contact_init_data', writable: false},
		CONTACTS: {value: 'contacts', writable: false},
		// SEND_USERS_INFOS: {value: 'send_users_infos', writable: false},
		SETTING_ADDED: {value: 'added_setting', writable: false},
		// SETTING_GET: {value: 'got_settings', writable: false},
		SETTING_DELETED: {value: 'deleted_setting', writable: false},
		// SET_NB_USERS: {value: 'set_nb_users', writable: false},
		// SET_USER_INFOS: {value: 'setuserinfos', writable: false},
		// STATUS_CHANGED: {value: 'status_changed', writable: false},
		// STOP_TYPING: {value: 'stop_typing', writable: false},
		UNFOLLOW: {value: 'unfollow', writable: false},
		UNFOLLOWED_BY: {value: 'unfollowed_by', writable: false},
		URL_METADATA: {value: 'url_metadata', writable: false},
		// USER_CONNECTED: {value: 'user_connected', writable: false},
		USER_LOG_OFF: {value: 'user_log_off', writable: false},
		USER_LOG_ON: {value: 'user_log_on', writable: false},
		// VAULT_CONTENT_CREATED: {value: 'vault_content_created', writable: false},
		// VAULT_CONTENT_FOUND: {value: 'vault_content_found', writable: false},
		// VAULT_CONTENT_GET: {value: 'vault_content_get', writable: false},
		// XV_FILE_URL: {value: 'xv_file_url', writable: false},
		SETTING_SILENT_PPV_DONE: {value: 'silent_ppv_done', writable: false},
		SETTING_SWITCHED_CREATOR_MANAGER: {value: 'switched_creator_manager', writable: false},
		SEND_SFW_VALIDATION_ERROR: {value: 'send_sfw_validation_error', writable: false},
		SFW_VALIDATION_SENT: {value: 'sfw_validation_sent', writable: false}
	});

	Object.defineProperties(SocketConnectionEvent.out, {
		ADD_FOLLOWER_TO_CUSTOMER_LIST: {value: 'add_follower_to_customer_list', writable: false},
		ADD_SETTING: {value: 'add_setting', writable: false},
		ASK_GROUP_ACCESS: {value: 'ask_group_access', writable: false},
		BAN_USER: {value: 'ban_user', writable: false},
		BLOCK_OR_GHOST_FRIEND: {value: 'block_or_ghost_friend', writable: false},
		CANCEL_MASS_MESSAGE: {value: 'cancel_mass_message', writable: false},
		CHANGE_PREFS: {value: 'change_prefs', writable: false},
		CHANGE_STATUS: {value: 'change_status', writable: false},
		CREATE_NEW_CONV_KEY: {value: 'create_new_conv_key', writable: false},
		CREATE_VAULT_CONTENT: {value: 'create_vault_content', writable: false},
		CRYPT_OLD_CONV: {value: 'crypt_old_conv', writable: false},
		DELETE_ALL_MESSAGES: {value: 'delete_allmessages', writable: false},
		DELETE_ANNOUNCEMENT: {value: 'delete_announcement', writable: false},
		DELETE_FILE: {value: 'delete_file', writable: false},
		DELETE_MESSAGE: {value: 'delete_message', writable: false},
		DELETE_SETTING: {value: 'delete_setting', writable: false},
		DISMISS_REMINDER: {value: 'dismiss_reminder', writable: false},
		EDIT_AUTO_MESSAGE: {value: 'edit_auto_message', writable: false},
		EDIT_MESSAGE: {value: 'edit_message', writable: false},
		FAVORITE_FRIEND: {value: 'favorite_friend', writable: false},
		FORWARD_MESSAGE: {value: 'forward_message', writable: false},
		FORWARD_MESSAGE_TO_FAN_SUPPORT: {value: 'forward_message_to_fan_support', writable: false},
		FORWARDED_MESSAGE_UPDATE_JSON_FORMAT: {value: 'forwarded_message_update_json_format', writable: false},
		GET_ALL_ACTIVE_REMINDERS: {value: 'get_all_active_reminders', writable: false},
		GET_CONTACT_INIT_DATA: {value: 'get_contact_init_data', writable: false},
		GET_ALL_MASS_MESSAGE: {value: 'get_all_mass_message', writable: false},
		GET_ALL_AUTO_MESSAGE: {value: 'get_all_auto_message', writable: false},
		GET_ANNOUNCEMENT: {value: 'get_announcement', writable: false},
		GET_AUTO_MESSAGE_EVENT_LIST: {value: 'get_auto_message_event_lists', writable: false},
		GET_CONTACT_CUSTOMERS: {value: 'get_customers_list', writable: false},
		GET_CONTACT_FOLLOWERS: {value: 'get_followers_list', writable: false},
		GET_CONTACTS: {value: 'get_contacts', writable: false},
        GET_CONTACTS_INFO: {value: 'get_contacts_info', writable: false},
		GET_CONV_KEY: {value: 'get_conv_key', writable: false},
		GET_CONVERSATION_FRIEND: {value: 'get_conversation_friend', writable: false},
		GET_CONVERSATION_FRIEND_PART: {value: 'get_conversation_friend_part', writable: false},
		GET_FANS_EXPENSES: {value: 'get_fans_expenses', writable: false},
		GET_FILE_URL: {value: 'get_file_url', writable: false},
		GET_FILTERED_FRIEND_IDS: {value: 'get_filtered_friend_ids', writable: false},
		GET_FOLLOWERS_LIST: {value: 'get_followers_list', writable: false},
		GET_MORE_FRIENDS: {value: 'get_more_friends', writable: false},
		GET_NB_USERS: {value: 'get_nb_users', writable: false},
		GET_PRIV_KEY: {value: 'get_priv_key', writable: false},
		GET_REMINDER_INIT_DATA: {value: 'get_reminder_init_data', writable: false},
		GET_REMINDER_HISTORY: {value: 'get_reminder_history', writable: false},
		GET_SETTINGS: {value: 'get_settings', writable: false},
        GET_SUPPORTS_LIST: {value: 'get_supports_list', writable: false},
		GET_TARGETS_ESTIMATION_MASS_MESSAGE: {value: 'get_targets_estimation_mass_message', writable: false},
		GET_TOKEN_SEND_FILE: {value: 'get_token_send_file', writable: false},
		GET_URL_METADATA: {value: 'get_url_metadata', writable: false},
		GET_USER_NOTIFS: {value: 'get_user_notifs', writable: false},
		GET_USERS_INFOS: {value: 'get_users_infos', writable: false},
		GET_VAULT_CONTENT: {value: 'get_vault_content', writable: false},
		GET_XV_FILE_URL: {value: 'get_xv_file_url', writable: false},
		GET_XV_USER_LIST: {value: 'get_xv_user_list', writable: false},
		GET_USER_INFOS: {value: 'getuserinfos', writable: false},
		INTERNAL_MESSAGE: {value: 'internal_message', writable: false},
		LEAVE_GROUP: {value: 'leave_group', writable: false},
		LOG: {value: 'log', writable: false},
		MASS_MESSAGE_CREATE_CONTENT: {value: 'mass_message_create_content', writable: false},
		MASS_MESSAGE_GET_CONTENT: {value: 'mass_message_get_content', writable: false},
		MASS_MESSAGE_SEARCH_CONTENT: {value: 'mass_message_search_content', writable: false},
		MASS_MESSAGE_VAULT_CREATE_CONTENT: {value: 'mass_message_vault_create_content', writable: false},
		MASS_MESSAGE_VAULT_GET_CONTENT: {value: 'mass_message_vault_get_content', writable: false},
		MASS_MESSAGE_VAULT_SEARCH_CONTENT: {value: 'mass_message_vault_search_content', writable: false},
		REFRESH_JWT: {value: 'refresh_jwt', writable: false},
		REGISTER_NEW_USER_FROM_XV: {value: 'register_new_user_from_xv', writable: false},
		REMOVE_SW_TOKEN: {value: 'remove_SW_token', writable: false},
		REMOVE_CUSTOMER_FROM_CUSTOMER_LIST: {value: 'remove_customer_from_customer_list', writable: false},
		REPORT_FRIEND: {value: 'report_friend', writable: false},
		REPORT_MESSAGE: {value: 'report_message', writable: false},
		FAN_REPORT_MESSAGE: {value: 'fan_report_message', writable: false},
		SAVE_ANNOUNCEMENT: {value: 'save_announcement', writable: false},
		SAVE_AUTO_MESSAGE: {value: 'save_auto_message', writable: false},
		SAVE_MASS_MESSAGE: {value: 'save_mass_message', writable: false},
		SAVE_REMINDER: {value: 'save_reminder', writable: false},
		SWITCH_AUTO_MESSAGE: {value: 'switch_state_auto_message', writable: false},
		SEARCH_FRIENDS: {value: 'search_friends', writable: false},
		SEARCH_VAULT_CONTENT: {value: 'search_vault_content', writable: false},
		SEND_MESSAGE: {value: 'send_message', writable: false},
		SEND_ONLINE_AND_GET_FRIENDS_ONLINE: {value: 'send_online_and_get_friends_online', writable: false},
		SEND_ONLINE_TO_FRIENDS: {value: 'send_online_to_friends', writable: false},
		SEND_SFW_VALIDATION: {value: 'send_sfw_validation', writable: false},
		SET_READ_DATE: {value: 'set_read_date', writable: false},
		SET_TO_SILENT_PPV: {value: 'silent_ppv', writable: false},
		SW_TOKEN: {value: 'SW_token', writable: false},
		TYPING_START: {value: 'typing_start', writable: false},
		TYPING_STOP: {value: 'typing_stop', writable: false},
		UNBLOCK_OR_UNGHOST_FRIEND: {value: 'unblock_or_unghost_friend', writable: false},
		UNFAVORITE_FRIEND: {value: 'unfavorite_friend', writable: false},
		UPDATE_HEADSHOT: {value: 'update_headshot', writable: false},
		UPDATE_NAME: {value: 'update_name', writable: false},
	});

	Object.defineProperties(SocketConnectionEvent.socketio, {
		CONNECT: {value: 'connect', writable: false},
		DISCONNECT: {value: 'disconnect', writable: false},
		CONNECT_ERROR: {value: 'connect_error', writable: false},
		CONNECT_TIMEOUT: {value: 'connect_timeout', writable: false},
		RECONNECT: {value: 'reconnect', writable: false},
		RECONNECTING: {value: 'reconnecting', writable: false},
		RECONNECT_ERROR: {value: 'reconnect_error', writable: false},
		RECONNECT_FAILED: {value: 'reconnect_failed', writable: false},
		PING: {value: 'ping', writable: false},
		PONG: {value: 'pong', writable: false},
	});

	return SocketConnectionEvent;
});
define('services/SocketConnection',[
	'lib/i18n!front',
	'libs/EventEmitter',
	'libs/socket.io',
	'log_and_tooltip',
	'services/SocketConnectionEvent',
], function(
	i18n,
	EventEmitter,
	io,
	LogAndTooltip,
	SocketConnectionEvent
) {
	// https://socket.io/docs/v2/client-api/#new-managerurl-options
	var SOCKETIO_RECONNECTION = true,
		SOCKETIO_RECONNECTION_ATTEMPTS = 30, //Infinity,
		SOCKETIO_RECONNECTION_DELAY_MS = 500,
		SOCKETIO_RECONNECTION_DELAY_MAX_MS = 5000,
		SOCKETIO_RANDOMIZATION_FACTOR = 0.5,
		SOCKETIO_TIMEOUT_MS = 20000,
		SOCKETIO_TRANSPORTS = ['websocket'];

	var instance = null,
		SocketConnection = function() {
			this.connection = null;
			this.disconnectReason = '';
			this.eventsToForward = [];
		};

	SocketConnection.prototype = {
		addListeners: function () {
			var self = this;

			for (var index in this.eventsToForward) {
				var socketEventName = this.eventsToForward[index][0],
					internalEventName = this.eventsToForward[index][1];

				function forClosure(socketEventName, internalEventName) {
					self.connection.on(socketEventName, function (data, ack) {
						EventEmitter.emit(internalEventName, data, ack);
					});
				}

				forClosure(socketEventName, internalEventName);
			}
		},
		emit: function (eventName, args, ack) {
			this.connection.emit.apply(this.connection, arguments);
		},
		on: function (eventName, callback) {
			this.connection.on.apply(this.connection, arguments);
		},
		forwardIncomingEvent: function (socketConnectionEventName, internalEventName) {
			this.eventsToForward.push([socketConnectionEventName, internalEventName]);
		},
		getConnection: function () {
			return this.connection;
		},
		getDisconnectReason: function () {
			return this.disconnectReason;
		},
		getMaxReconnectionAttempts: function () {
			return SOCKETIO_RECONNECTION_ATTEMPTS;
		},
		getMaxReconnectionDuration: function () {
			return (SOCKETIO_RECONNECTION_ATTEMPTS * SOCKETIO_RECONNECTION_DELAY_MAX_MS) / 1000;
		},
		init: function (host, queryParams) {
			try {
				this.connection = io(window.location.protocol + '//' + host, {
					reconnection: SOCKETIO_RECONNECTION,
					reconnectionAttempts: SOCKETIO_RECONNECTION_ATTEMPTS,
					reconnectionDelay: SOCKETIO_RECONNECTION_DELAY_MS,
					reconnectionDelayMax: SOCKETIO_RECONNECTION_DELAY_MAX_MS,
					randomizationFactor: SOCKETIO_RANDOMIZATION_FACTOR,
					timeout: SOCKETIO_TIMEOUT_MS,
					transports: SOCKETIO_TRANSPORTS,
					query: $.param(queryParams)
				});
				this.connection.on(SocketConnectionEvent.socketio.CONNECT, this.onConnect.bind(this));
				this.connection.on(SocketConnectionEvent.socketio.DISCONNECT, this.onDisconnect.bind(this));
				this.connection.on(SocketConnectionEvent.socketio.CONNECT_ERROR, this.onConnectError.bind(this));
				this.connection.on(SocketConnectionEvent.socketio.CONNECT_TIMEOUT, this.onConnectTimeout.bind(this));
				this.connection.on(SocketConnectionEvent.socketio.RECONNECT, this.onReconnect.bind(this));
				this.connection.on(SocketConnectionEvent.socketio.RECONNECTING, this.onReconnecting.bind(this));
				this.connection.on(SocketConnectionEvent.socketio.RECONNECT_ERROR, this.onReconnectError.bind(this));
				this.connection.on(SocketConnectionEvent.socketio.RECONNECT_FAILED, this.onReconnectFailed.bind(this));
			} catch (e) {
				wglog.custom('SocketConnection', 'error', e);
				LogAndTooltip.write_error({
					logTitle: 'SocketConnection::init socket connection error',
					logMessage: e.message,
					message: i18n.__('chat.error.connection_error'),
					refresh: true,
					source: "socket_connection"
				});
			}
		},
		onConnect: function () {
			wglog.custom('SocketConnection', 'info', 'Connected');
			this.disconnectReason = '';
			this.resetReconnectionProps();
			this.addListeners();
		},
		onDisconnect: function (reason) {
			this.disconnectReason = reason;
			switch(reason) {
				case 'io client disconnect':
					wglog.custom('SocketConnection', 'info', 'Chat manually disconnected');
					break;
				case 'io server disconnect':
					wglog.custom('SocketConnection', 'info', 'Chat disconnected by server');
					break;
				case 'ping timeout':
					wglog.custom('SocketConnection', 'info', 'Chat disconnected due to ping timeout');
					break;
				case 'transport close':
					wglog.custom('SocketConnection', 'info', 'Chat disconnected due to a connection loss (ex: network change/disconnection)');
					break;
				case 'transport error':
					wglog.custom('SocketConnection', 'info', 'Chat disconnected due to a transport error (ex: server killed/reboot');
					break;
				default:
					wglog.custom('SocketConnection', 'info', 'Chat disconnected due to an unknown error');
			}
		},
		onConnectError: function (error) {
			if (this.isReconnecting) {
				return;
			}
			wglog.custom('SocketConnection', 'error', error);
			wglog.custom('SocketConnection', 'error', `Connection error (type: ${error.type})`);
		},
		onConnectTimeout: function () {
			wglog.custom('SocketConnection', 'error', 'Connection timeout');
		},
		onReconnect: function (attempt) {
			this.resetReconnectionProps();
			wglog.custom('SocketConnection', 'info', 'Successful reconnection', `${attempt}/${SOCKETIO_RECONNECTION_ATTEMPTS}`);
		},
		onReconnecting: function (attempt) {
			this.isReconnecting = true;
			wglog.custom('SocketConnection', 'info', 'Reconnecting', `${attempt}/${SOCKETIO_RECONNECTION_ATTEMPTS}`);
		},
		onReconnectError: function (error) {
			if (!this.isReconnecting) {
				return;
			}
			wglog.custom('SocketConnection', 'error', error);
			wglog.custom('SocketConnection', 'error', `Reconnection error (type: ${error.type})`);
		},
		onReconnectFailed: function () {
			wglog.error(`SocketConnection reconnection failed (reason: ${this.disconnectReason})`, '');
			this.resetReconnectionProps();
		},
		resetReconnectionProps: function () {
			this.isReconnecting = false;
		}
	}

	SocketConnection.getInstance = function () {
		if (instance === null) {
			instance = new SocketConnection();
		}

		return instance;
	}

	return SocketConnection.getInstance();
});

define('features/ContactList/commands/CreateContactListCommand',[
	'core/Command',
	'services/SocketConnection',
	'services/SocketConnectionEvent'
], function(
	Command,
	SocketConnection,
	SocketConnectionEvent
) {
	var CreateContactList = function(context) {
		Command.call(this, context);
	};

	CreateContactList.prototype = Object.create(Command.prototype);

	Object.assign(CreateContactList.prototype, {
		execute: function (data) {

			if (!this.context.manager.contactLists) this.context.manager.contactLists = {};

			if (!this.context.manager.contactLists.init) this.context.manager.contactLists.init = new Set();

			this.context.manager.contactLists.init.add('inbox');

			SocketConnection.emit(SocketConnectionEvent.out.GET_CONTACT_INIT_DATA, data);
		},
	});

	return CreateContactList;
});
define('features/ContactList/commands/GenerateAvatarCommand',[
	'config/chat',
	'log_and_tooltip',
	'core/Command',
	'libs/EventEmitter',
	'features/ContactList/events/ContactListEvent',
	'features/ContactList/CustomerList/events/CustomerListEvent',
	'features/ContactList/FollowerList/events/FollowerListEvent',
	'features/ContactList/SupportList/events/SupportListEvent',
], function(
	config,
	log_and_tooltip,
	Command,
	EventEmitter,
	ContactListEvent,
	CustomerListEvent,
	FollowerListEvent,
	SupportListEvent
) {
	var GenerateAvatar = function(context) {
		Command.call(this, context);
	};

	GenerateAvatar.prototype = Object.create(Command.prototype);

	Object.assign(GenerateAvatar.prototype, {
		execute: function (idContact, listType, reminder) {
			if (!idContact) {
				wglog.debug('GenerateAvatarCommand - no id contact');
			}

			if (!listType) {
				wglog.debug('GenerateAvatarCommand - no list type');
			}

			var contactListEvent = this.getListEvents(listType);
			if (contactListEvent) {
				EventEmitter.emit(contactListEvent.GENERATE_AVATAR_REQUEST, idContact, reminder);
			}
		},
		getListEvents: function(listType) {
			if (listType === 'customers') return CustomerListEvent;
			if (listType === 'followers') return FollowerListEvent;
			if (listType === 'supports') return SupportListEvent;

			return ContactListEvent;
		}
	});

	return GenerateAvatar;
});
define('features/ContactList/commands/GetContactsInfoCommand',[
    'core/Command',
    'services/SocketConnection',
    'services/SocketConnectionEvent',
], function(
    Command,
    SocketConnection,
    SocketConnectionEvent
) {
    var GetContactsWithUnreadMessages = function(context) {
        Command.call(this, context);
    };

    GetContactsWithUnreadMessages.prototype = Object.create(Command.prototype);

    Object.assign(GetContactsWithUnreadMessages.prototype, {
        execute: function (ids) {
            SocketConnection.emit(SocketConnectionEvent.out.GET_CONTACTS_INFO, {ids: ids});
        },
    });

    return GetContactsWithUnreadMessages;
});
define('features/ContactList/commands/GetContactsWithUnreadMessagesCommand',[
    'core/Command',
    'features/ContactList/events/ContactListEvent',
    'libs/EventEmitter',
], function(
    Command,
    ContactListEvent,
    EventEmitter
) {
    var GetContactsWithUnreadMessages = function(context) {
        Command.call(this, context);
    };

    GetContactsWithUnreadMessages.prototype = Object.create(Command.prototype);

    Object.assign(GetContactsWithUnreadMessages.prototype, {
        execute: function (data) {
            this.loadedContacts = data.loadedIds;
            var filteredContacts = this.context.manager.unread_message_friends.filter(this.filterExcludeLoadedContactId, this);
            EventEmitter.emit(ContactListEvent.GET_CONTACTS_INFO, filteredContacts);
        },
        filterExcludeLoadedContactId: function(id) {
            return this.loadedContacts.indexOf(id) === -1;
        }
    });

    return GetContactsWithUnreadMessages;
});
define('features/ContactList/commands/GetMoreContactsCommand',[
    'core/Command',
    'services/SocketConnection',
    'services/SocketConnectionEvent',
], function(
    Command,
    SocketConnection,
    SocketConnectionEvent
) {
    var GetMoreContacts = function(context) {
        Command.call(this, context);
    };

    GetMoreContacts.prototype = Object.create(Command.prototype);

    Object.assign(GetMoreContacts.prototype, {
        execute: function (args) {
            if (typeof args === 'undefined' || typeof args.page === 'undefined') {
                throw new Error('No page');
                return;
            }

            SocketConnection.emit(SocketConnectionEvent.out.GET_CONTACTS, args);
        }
    });

    return GetMoreContacts;
});
define('features/ContactList/commands/InitContactListFiltersButtonCommand',[
	'config/chat',
	'core/Command',
	'libs/EventEmitter',
	'lib/storage',
	'lib/i18n!front',
	'features/ContactList/events/ContactListEvent',
	'features/ContactList/CustomerList/events/CustomerListEvent',
	'features/ContactList/FollowerList/events/FollowerListEvent'
], function(
	Config,
	Command,
	EventEmitter,
	Storage,
	i18n,
	ContactListEvent,
	CustomerListEvent,
	FollowerListEvent
) {
	var InitContactListFilterButtonCommand = function(context) {
		Command.call(this, context);
	};

	InitContactListFilterButtonCommand.prototype = Object.create(Command.prototype);

	Object.assign(InitContactListFilterButtonCommand.prototype, {
		emitEvent: function(eventName, data) {
			if (Config.login_info.is_creator) {
				EventEmitter.emit(CustomerListEvent[eventName], data);
				EventEmitter.emit(FollowerListEvent[eventName], data);
			} else {
				EventEmitter.emit(ContactListEvent[eventName], data);
			}
		},
		execute: function () {
			var button = document.querySelector('.chat-contact-list-filters.btn--contact-list-filters');
			if (!button || button.classList.contains('is-init')) {
				return;
			}

			var self = this,
				fnCallback = function(filter) {
					Storage.set('chat.contact_list_filter', filter);
					self.emitEvent('CLEAR_CONTACT_LIST');

					var data = {};
					data.filter = filter;
					if (!Config.login_info.is_creator) {
						data.invisible = self.context.manager.chatInitsAndPrefs.status === "Invisible";
					}
					self.emitEvent('CREATE_CONTACT_LIST', data);
				},
				actions = [{
					callback: fnCallback.bind(self, 'unreads'),
					label: i18n.__('chat.infos.unread_messages'),
					name: 'unreads'
				}, {
					callback: fnCallback.bind(self, 'recent_conversation'),
					label: i18n.__('chat.infos.new_messages'),
					name: 'recent_conversation'
				}, {
					callback: fnCallback.bind(self, 'oldest_conversation'),
					label: i18n.__('chat.infos.oldest_messages'),
					name: 'oldest_conversation'
				}
			];

			this.emitEvent('SET_FILTERS_CONTACT_LIST', actions);
		}
	});

	return InitContactListFilterButtonCommand;
});
define('features/ContactList/commands/PrepareExpensesCommand',[
	'log_and_tooltip',
	'lib/i18n!front',
	'config/chat',
	'core/Command',
	'libs/EventEmitter',
	'features/ContactList/events/ContactListEvent',
	'features/ContactList/CustomerList/events/CustomerListEvent',
	'features/ContactList/FollowerList/events/FollowerListEvent',
], function(
	log_and_tooltip,
	i18n,
	Config,
	Command,
	EventEmitter,
	ContactListEvent,
	CustomerListEvent,
	FollowerListEvent
) {
	var PrepareExpenses = function (context) {
		Command.call(this, context);
	};

	PrepareExpenses.prototype = Object.create(Command.prototype);

	Object.assign(PrepareExpenses.prototype, {
		execute: function (data, expenses) {
			var contact = data.contact,
				listType = data.listType,
				existent = Object.assign({}, contact.expenses),
				contactListEvent = null;

			if (!expenses) {
				expenses = existent;
			}

			if (typeof expenses === 'object') {
				if (!expenses.currency) expenses.currency = 'USD';

				if (!expenses.text_ppd) expenses.text_ppd = i18n.__('chat.label_ppc');
				if (!expenses.text_subs) expenses.text_subs = i18n.__('chat.label_subs');
				if (!expenses.text_tips) expenses.text_tips = i18n.__('chat.label_tips');
				if (!expenses.total_text) expenses.total_text = i18n.__('chat.spent');
				if (!expenses.text_month_active) expenses.text_month_active = i18n.__('chat.months_sub');
				if (!expenses.text_month_total) expenses.text_month_total = i18n.__('chat.months_total');

				if (!expenses.has_ppd) expenses.has_ppd = this.hasAmount(expenses.amount_ppd);
				if (!expenses.has_subs) expenses.has_subs = this.hasAmount(expenses.amount_subs);
				if (!expenses.has_tips) expenses.has_tips = this.hasAmount(expenses.amount_tips);
				if (!expenses.has_total) expenses.has_total = this.hasAmount(expenses.amount_total);

				if (expenses.has_ppd) expenses.amount_ppd = this.formatFloat(expenses.amount_ppd, expenses.currency);
				if (expenses.has_subs) expenses.amount_subs = this.formatFloat(expenses.amount_subs, expenses.currency);
				if (expenses.has_tips) expenses.amount_tips = this.formatFloat(expenses.amount_tips, expenses.currency);
				if (expenses.has_total) expenses.amount_total = this.formatFloat(expenses.amount_total, expenses.currency);
			}
			else {
				expenses = {
					amount_total: expenses,
					currency: 'USD'
				};
				expenses.amount_total = this.formatFloat(expenses.amount_total, expenses.currency);
			}

			contact.expenses_fmt = expenses;

			if (listType === 'inbox') {
				contactListEvent = ContactListEvent;
			} else if (listType === 'customers') {
				contact.is_customer = true;
				contactListEvent = CustomerListEvent;
			} else if (listType === 'followers') {
				contact.is_follower = true;
				contactListEvent = FollowerListEvent;
			}

			if (!!contactListEvent) {
				// wglog.debug('PrepareExpensesCommand', contact);
				EventEmitter.emit(contactListEvent.PREPARED_EXPENSES, contact);
			}
		},
		hasAmount: function(val) {
			if (!val) {
				return false;
			}

			return !!(+val || +val.replace(/\D/g, ''));
		},
		formatFloat: function(value, currency) {
			 if (typeof value !== 'number') {
				throw new TypeError("Value must be a number");
			}

			return new Intl.NumberFormat(Config.locale, { style: 'currency', currency: currency}).format(value);
		},
	});

	return PrepareExpenses;
});
define('features/ContactList/commands/RemoveContactCommand',[
	'log_and_tooltip',
	'core/Command',
	'libs/EventEmitter',
	'features/ContactList/events/ContactListEvent',
	'features/ContactList/CustomerList/events/CustomerListEvent',
	'features/ContactList/FollowerList/events/FollowerListEvent',
], function(
	log_and_tooltip,
	Command,
	EventEmitter,
	ContactListEvent,
	CustomerListEvent,
	FollowerListEvent
) {
	var RemoveContact = function(context) {
		Command.call(this, context);
	};

	RemoveContact.prototype = Object.create(Command.prototype);

	Object.assign(RemoveContact.prototype, {
		execute: function (data) {
			var contact = data.contact;

			if (!contact || !contact.id_user) {
				// wglog.debug('RemoveContactCommand', 'friend_info missing');
				return;
			}

			// wglog.debug('RemoveContactCommand', contact);

			var chatContactManager = this.context.chatFriendManager,
				userId = chatContactManager.user_id;

			if (contact.id_user === userId) {
				// wglog.debug('RemoveContactCommand', 'not removing the user as friend because contact_id === user_id');
				return;
			}

			var contactListEvent = ContactListEvent;
			if (contact.is_customer) contactListEvent = CustomerListEvent;
			if (contact.is_follower) contactListEvent = FollowerListEvent;

			var contactsIds = chatContactManager.friends_ids,
				contactExists = contactsIds.indexOf(contact.id_user) !== -1;

			if (contactExists) {
				var contacts = chatContactManager.friends,
					indexId = contactsIds.indexOf(contact.id_user);

				if (indexId !== -1) {
					contactsIds.splice(indexId, 1);
				}

				var customersIds = chatContactManager.customers_ids,
					followersIds = chatContactManager.followers_ids;

				if (contact.is_customer) {
					var indexIdCustomer = customersIds.indexOf(contact.id_user);
					if (indexIdCustomer !== -1) {
						customersIds.splice(indexIdCustomer, 1);
					}
				}

				if (contact.is_follower) {
					var indexIdFollower = followersIds.indexOf(contact.id_user);
					if (indexIdFollower !== -1) {
						followersIds.splice(indexIdFollower, 1);
					}
				}

				delete contacts[contact.id_user];

				if (chatContactManager.selected_friend === contact.id_user) {
					chatContactManager.close_conversation();
				}
			}

			if (!!contactListEvent) {
				EventEmitter.emit(contactListEvent.REMOVED_CONTACT, data);
			}

		}
	});

	return RemoveContact;
});
define('features/ContactList/commands/RemoveContactFromCustomerListCommand',[
	'log_and_tooltip',
	'libs/EventEmitter',
	'core/Command',
	'services/SocketConnection',
	'services/SocketConnectionEvent'
], function(
	log_and_tooltip,
	EventEmitter,
	Command,
	SocketConnection,
	SocketConnectionEvent
) {
	var RemoveCustomerFromCustomerList = function(context) {
		Command.call(this, context);
	};

	RemoveCustomerFromCustomerList.prototype = Object.create(Command.prototype);

	Object.assign(RemoveCustomerFromCustomerList.prototype, {
		execute: function (idContact) {
			SocketConnection.emit(SocketConnectionEvent.out.REMOVE_CUSTOMER_FROM_CUSTOMER_LIST, {
				customer_id: idContact,
			});
		}
	});

	return RemoveCustomerFromCustomerList;
});
define('features/ContactList/commands/RemoveContactListTabLocalStorageEntryCommand',[
    'log_and_tooltip',
    'core/Command',
    'features/ContactList/views/ContactListView',
    'lib/storage',
], function(
    log_and_tooltip,
    Command,
    ContactListView,
    Storage
) {
    var RemoveCustomerFromCustomerList = function(context) {
        Command.call(this, context);
    };

    RemoveCustomerFromCustomerList.prototype = Object.create(Command.prototype);

    Object.assign(RemoveCustomerFromCustomerList.prototype, {
        execute: function () {
            Storage.remove(ContactListView.LOCALSTORAGE_KEY_TAB);
        }
    });

    return RemoveCustomerFromCustomerList;
});
define('features/ContactList/commands/SortContactListCommand',[
	'log_and_tooltip',
	'core/Command',
	'libs/EventEmitter',
	'features/ContactList/events/ContactListEvent',
	'features/ContactList/CustomerList/events/CustomerListEvent',
	'features/ContactList/FollowerList/events/FollowerListEvent',
	'features/ContactList/SupportList/events/SupportListEvent'
], function(
	log_and_tooltip,
	Command,
	EventEmitter,
	ContactListEvent,
	CustomerListEvent,
	FollowerListEvent,
	SupportListEvent
) {
	var SortContactList = function(context) {
		Command.call(this, context);

		this.filter = null;
	};

	SortContactList.prototype = Object.create(Command.prototype);

	Object.assign(SortContactList.prototype, {
		execute: function (contacts) {
			if (!contacts) wglog.debug('SortContactListCommand', 'No contacts');
			if (!contacts.type ) wglog.debug('SortContactListCommand', 'No contacts type');
			if (!contacts.list) wglog.debug('SortContactListCommand', 'No contacts list');

			var contactListEvent = this.getListEvents(contacts.type),
				sortedContacts = contacts.list.map(function(contact) {
					return contact;
				});
			sortedContacts = sortedContacts.filter(function (contact) {
				return typeof contact !== 'undefined';
			});

			var contactFilter = contacts.filter;
			var sortContact = function (a, b) {
				var recentFirst = (!contactFilter || contactFilter !== 'oldest_conversation'),
					lastMessage = contactFilter === 'last_message';

				// Ordre dcroissant (support en premier)
				if (!a.is_support && b.is_support) return 1;
				if (a.is_support && !b.is_support) return -1;

				// Ordre croissant (score infrieur en premier)
				if (a.sort_score < b.sort_score) return -1;
				if (a.sort_score > b.sort_score) return 1;

				if (lastMessage) {
					// Ordre dcroissant (user avec dernier last message en premier)
					if (!a.last_message.t && b.last_message.t) return 1;
					if (a.last_message.t && !b.last_message.t) return -1;

					if (a.last_message && b.last_message) {
						if (a.last_message.t < b.last_message.t) return recentFirst ? 1 : -1;
						if (a.last_message.t > b.last_message.t) return recentFirst ? -1 : 1;
					}
				} else {
					// Ordre dcroissant (user avec dernire interaction en premier)
					if (!a.interaction && b.interaction) return 1;
					if (a.interaction && !b.interaction) return -1;

					if (a.interaction && b.interaction) {
						if (a.interaction < b.interaction) return recentFirst ? 1 : -1;
						if (a.interaction > b.interaction) return recentFirst ? -1 : 1;
					}
				}

				return 0;
			}
			sortedContacts.sort(sortContact);

			if (!contactListEvent) {
				wglog.debug('SortContactListCommand', 'No event');
				return;
			}

			var datas = {
				type: contacts.type,
				list: sortedContacts
			};

			// wglog.debug('SortContactListCommand - unsorted contacts:', contacts.list);
			// wglog.debug('SortContactListCommand - sorted contacts:', sortedContacts);

			EventEmitter.emit(contactListEvent.CONTACT_LIST_SORTED, datas);
		},
		getListEvents: function(listType) {
			if (listType === 'customers') return CustomerListEvent;
			if (listType === 'followers') return FollowerListEvent;
			if (listType === 'supports') return SupportListEvent;

			return ContactListEvent;
		}
	});

	return SortContactList;
});
define('features/ContactList/commands/SortContactScoreCommand',[
	'config/chat',
	'log_and_tooltip',
	'core/Command',
	'libs/EventEmitter',
	'features/ContactList/events/ContactListEvent',
	'features/ContactList/CustomerList/events/CustomerListEvent',
	'features/ContactList/FollowerList/events/FollowerListEvent',
	'features/ContactList/SupportList/events/SupportListEvent',
	'features/Reminder/models/ReminderModel',
], function(
	Config,
	log_and_tooltip,
	Command,
	EventEmitter,
	ContactListEvent,
	CustomerListEvent,
	FollowerListEvent,
	SupportListEvent,
	ReminderModel
) {
	var SortContactScore = function(context) {
		Command.call(this, context);
	};

	SortContactScore.prototype = Object.create(Command.prototype);

	Object.assign(SortContactScore.prototype, {
		execute: function (datas) {
			if (!datas) wglog.debug('SortContactScoreCommand', 'No datas');
			if (!datas.type) wglog.debug('SortContactScoreCommand', 'No datas type');
			if (!datas.contact) wglog.debug('SortContactScoreCommand', 'No datas contact');

			var contactListEvent = this.getListEvents(datas.type);
			if (!contactListEvent) {
				wglog.debug('SortContactScoreCommand', 'No events');
				return;
			}

			datas.contact.sort_score = this.getFriendsSortScore(datas.contact, datas.filter);

			// wglog.debug('SortContactScoreCommand', datas);
			EventEmitter.emit(contactListEvent.CONTACT_SCORE_SORTED, datas);
		},
		getFriendsSortScore: function(contact, filter) {
			var reminder = Config.login_info.is_support ? ReminderModel.get(contact.id_user) : false;

			if (!contact.status || contact.is_support) contact.status = 'Offline';

			if (contact.status === 'Offline') return this.contactIsOffline(contact, reminder, filter);

			return this.contactIsOnline(contact, reminder, filter);
		},
		getListEvents: function(listType) {
			if (listType === 'customers') return CustomerListEvent;
			if (listType === 'followers') return FollowerListEvent;
			if (listType === 'supports') return SupportListEvent;

			return ContactListEvent;
		},
		contactIsOffline: function(contact, reminder, filter) {
			if (!filter || filter === 'unreads') return this.OfflineUnread(contact, reminder);
			if (filter === 'oldest_conversation' || filter === 'recent_conversation') return this.OfflineOldestRecent(contact, reminder);
			if (filter === 'last_message') return this.OfflineLast(contact, reminder);
		},
		contactIsOnline: function(contact, reminder, filter) {
			if (!filter || filter === 'unreads') return this.OnlineUnread(contact, reminder);
			if (filter === 'oldest_conversation' || filter === 'recent_conversation') return this.OnlineOldestRecent(contact, reminder);
			if (filter === 'last_message') return this.OnlineLast(contact, reminder);
		},

		OfflineUnread: function(contact, reminder) {
			if (!!reminder && new Date().getTime() > new Date(reminder.remind_at).getTime()) {
				// 2 => Offline avec reminder dpass et avec messages non-lus
				if (contact.nb_unread) return 2;
				// 4 => Offline avec reminder dpass et sans messages non-lus
				return 4;
			}

			if (contact.tip_amount) {
				// 6 => Offline avec tip et interaction
				if (contact.interaction) return 6;
				// 8 => Offline avec tip sans interaction
				return 8;
			}

			if (contact.nb_unread) {
				// 10 => Offline sans interaction (par ordre alpha)
				if (contact.interaction) return 10;
				// 12 => Offline avec messages non-lus
				return 12;
			}

			// 14 => Offline sans interaction (par ordre alpha)
			if (contact.interaction) return 14;
			// 16 => Offline avec interaction < 1 semaine (par last interaction)
			return 16;
		},
		OfflineOldestRecent: function(contact, reminder) {
			if (!!reminder && new Date().getTime() > new Date(reminder.remind_at).getTime()) {
				// 2 => Offline avec reminder dpass et avec messages non-lus
				if (contact.interaction) return 2;
				// 4 => Offline avec reminder dpass et sans messages non-lus
				return 4;
			}

			if (contact.tip_amount) {
				// 6 => Offline avec tip et interaction
				if (contact.interaction) return 6;
				// 8 => Offline avec tip sans interaction
				return 8;
			}

			// 10 => Offline sans interaction (par ordre alpha)
			if (contact.interaction) return 10;
			// 12 => Offline avec interaction < 1 semaine (par last interaction)
			return 12;
		},
		OfflineLast: function(contact, reminder) {
			if (!!reminder && new Date().getTime() > new Date(reminder.remind_at).getTime()) {
				// 2 => Offline avec reminder dpass et avec messages non-lus
				if (contact.last_message.t) return 2;
				// 4 => Offline avec reminder dpass et sans messages non-lus
				return 4;
			}

			// 2 => Offline avec messages non-lus
			if (contact.last_message.t) return 6;
			// 4 => Offline sans messages non-lus
			return 8;
		},

		OnlineUnread: function(contact, reminder) {
			if (!!reminder && new Date().getTime() > new Date(reminder.remind_at).getTime()) {
				// 1 => Online avec reminder dpass et avec messages non-lus
				if (contact.nb_unread) return 1;
				// 3 => Online avec reminder dpass et sans messages non-lus
				return 3;
			}

			if (contact.tip_amount) {
				// 5 => Online avec tip et interaction
				if (contact.interaction) return 5;
				// 7 => Online avec tip sans interaction
				return 7;
			}

			if (contact.nb_unread) {
				// 9 => Online sans interaction (par ordre alpha)
				if (contact.interaction) return 9;
				// 11 => Online avec messages non-lus
				return 11;
			}

			// 13 => Online sans interaction (par ordre alpha)
			if (contact.interaction) return 13;
			// 15 => Online avec interaction (par last interaction)
			return 15;
		},
		OnlineOldestRecent: function(contact, reminder) {
			if (!!reminder && new Date().getTime() > new Date(reminder.remind_at).getTime()) {
				// 1 => Online avec reminder dpass et avec messages non-lus
				if (contact.interaction) return 1;
				// 3 => Online avec reminder dpass et sans messages non-lus
				return 3;
			}

			if (contact.tip_amount) {
				// 5 => Online avec tip et interaction
				if (contact.interaction) return 5;
				// 7 => Online avec tip sans interaction
				return 7;
			}

			// 9 => Online sans interaction (par ordre alpha)
			if (contact.interaction) return 9;
			// 11 => Online avec interaction (par last interaction)
			return 11;
		},
		OnlineLast: function(contact, reminder) {
			if (!!reminder && new Date().getTime() > new Date(reminder.remind_at).getTime()) {
				// 1 => Online avec reminder dpass et avec messages non-lus
				if (contact.last_message.t) return 1;
				// 3 => Online avec reminder dpass et sans messages non-lus
				return 3;
			}

			// 5 => Online avec messages non-lus
			if (contact.last_message.t) return 5;
			// 7 => Online sans messages non-lus
			return 7;
		}
	});

	return SortContactScore;
});
define('features/ContactList/commands/UnreadMessageBadgeCommand',[
	'log_and_tooltip',
	'core/Command',
	'libs/EventEmitter',
	'features/ContactList/events/ContactListEvent',
	'features/ContactList/CustomerList/events/CustomerListEvent',
	'features/ContactList/FollowerList/events/FollowerListEvent',
	'features/ContactList/SupportList/events/SupportListEvent'
], function(
	log_and_tooltip,
	Command,
	EventEmitter,
	ContactListEvent,
	CustomerListEvent,
	FollowerListEvent,
	SupportListEvent
) {
	var UnreadMessageBadge = function(context) {
		Command.call(this, context);
	};

	UnreadMessageBadge.prototype = Object.create(Command.prototype);

	Object.assign(UnreadMessageBadge.prototype, {
		execute: function (datas) {

			var contactListEvent = this.getListEvents(datas.type);

			EventEmitter.emit(contactListEvent.UNREAD_MESSAGE_BADGE_UPDATED, {
				id: datas.id,
				nb_unread: datas.nb_unread
			});

		},
		getListEvents: function(listType) {
			if (listType === 'customers') return CustomerListEvent;
			if (listType === 'followers') return FollowerListEvent;
			if (listType === 'supports') return SupportListEvent;

			return ContactListEvent;
		},
	});

	return UnreadMessageBadge;
});
define('core/Mediator',[
	'core/View'
], function(
	View
) {
	var Mediator = function(view, context, mediatorMap) {
		if (!(!!view) || !(view instanceof View)) {
			throw new Error('The view must be an instance of View.');
		}

		this.context = context;
		this.mediatorMap = mediatorMap;
		this.view = view;
		view.mediator = this;
		this.addListeners();
	};

	Mediator.prototype = {
		/**
		 * Hook executed on the construction phase.
		 */
		addListeners: function () {},
		/**
		 * Hook executed after the mediator is instanced and events are registered.
		 */
		ready: function () {},
		/**
		 * Hook executed on the destruction phase.
		 */
		removeListeners: function () {},
	};

	return Mediator;
});
define('features/ContactList/views/ContactListMediator',[
	'config/chat',
	'core/Mediator',
	'libs/EventEmitter',
	'lib/storage',
	'features/ContactList/events/ContactListEvent',
], function(
	Config,
	Mediator,
	EventEmitter,
	Storage,
	ContactListEvent
) {
	var ContactListMediator = function (view, context, mediatorMap) {
		Mediator.call(this, view, context, mediatorMap);
		this.contacts = [];
		this.contactsToSort = [];
	}

	ContactListMediator.prototype = Object.create(Mediator.prototype);

	Object.assign(ContactListMediator.prototype, {
		addContact: function(contactJson, source) {
			// wglog.debug('ContactListMediator - addContact', contactJson, source);
			EventEmitter.emit(this.getFeatureEvents().ADD_CONTACT, contactJson, source, true);
		},
		addContactAttribute: function(id, name, value) {
			// wglog.debug('ContactListMediator - addContactAttribute', id, name, value);
			EventEmitter.emit(this.getFeatureEvents().ADD_CONTACT_ATTRIBUTE, {
				attrName: name,
				attrValue: value,
				contactId: id,
				listType: this.view.getListType()
			});
		},
		addContactFromSearch: function(contactJson) {
			// wglog.debug('ContactListMediator - addContactFromSearch', contactJson);
			this.view.attachContact(contactJson, 'search');
		},
        calculateNbUnreadMessagesSum: function() {
            var contactsWithUnreadMessages = this.context.manager.nb_unread_messages || {},
                sum = 0;

            for (var contactId in contactsWithUnreadMessages) {
                contactId = +contactId;

                if (this.getContactExists(contactId)) {
                    sum += +contactsWithUnreadMessages[contactId];
                }
            }

            return sum;
        },
		clearContactList: function() {
			this.view.clearContactList();

			this.contacts = [];
			this.contactsToSort = [];

			EventEmitter.emit(ContactListEvent.CLEAR_CONTACT_LIST_CONTEXT, this.view.getListType());
		},
		createContactList: function(contacts, listType) {
			// wglog.debug('ContactListMediator - createContactList', contacts, listType);
			this.sortContactScore(contacts, listType);
			EventEmitter.emit(ContactListEvent.INIT_CONTACT_LIST_FILTERS);
		},
        emitContactListCreated: function() {
            wglog.debug('ContactListMediator - emitContactListCreated -', this.view.getListType());
            var data = {
				type: this.view.getListType(),
                loadedIds: this.contacts.map(function(contact) { return contact.id_user; })
            }
            EventEmitter.emit(this.getFeatureEvents().CONTACT_LIST_CREATED, data);
        },
		getAllContactLists: function() {
			return this.getManager().contactLists;
		},
		getAllContactsData: function() {
			return this.contacts;
		},
		getChatFriendManager: function() {
			return this.context.chatFriendManager;
		},
        getContactExists: function(id) {
            var index = this.getContactIndex(id);
            return typeof index === 'number';
        },
		getContactIdFromList: function() {},
		getContactIndex: function(id) {
			for (var index in this.contacts) {
				if (id === this.contacts[index].id_user) {
					return parseInt(index);
				}
			}

			return false;
		},
		getContactIsSupport: function(id) {
			var index = this.getContactIndex(id);
			if (index !== false && typeof index === 'number') {
				return !!this.contacts[index].is_support;
			}
		},
		getManager: function() {
			return this.context.manager;
		},
		getFeatureEvents: function() {
			return ContactListEvent;
		},
		getMessage: function(message, recipientId, keys) {
			return this.getManager().get_real_message(message, recipientId, keys);
		},
		getMessageTextUpload(json) {
			return this.getChatFriendManager().chat_send_file.get_message_text(json);
		},
		getMessageTextVault(json) {
			return this.getChatFriendManager().vault.getMessageText(json.m);
		},
		manageContactListsDisplay: function(toShow) {
			// wglog.debug('ContactListMediator - hideAllContactLists - to Show', toShow);
			var allContactLists = this.getAllContactLists();
			for (var type in allContactLists) {
				if (toShow) {
					allContactLists[type].showUI();
				} else {
					allContactLists[type].hideUI();
				}
			}
		},
		initContactListManager: function(result) {
			// wglog.debug('ContactListMediator - initContactListManager', result);
			this.getManager().initContactListManager(result);
		},
		loadMore: function(nextPage) {
			wglog.debug('ContactListMediator - loadMore');
			EventEmitter.emit(ContactListEvent.GET_MORE, {
				page: nextPage
			});
		},
		onAvatarGenerateRequest: function(contactId, reminder) {
			var index = this.getContactIndex(contactId);
			if (index !== false && typeof index === 'number') {
				// wglog.debug('ContactListMediator - onAvatarGenerateRequest', contactId);
				this.view.updateAvatar(this.contacts[index], reminder);
			}
		},
		onContactAttributeAdded: function(result) {
			// wglog.debug('ContactListMediator - onContactAttributeAdded', result);
			var self = this.getAllContactLists()[result.listType].mediator,
				index = self.getContactIndex(result.contactId),
				contactJson = self.contacts[index];

			if (result.attrName === "interaction") {
				contactJson.interaction = result.attrValue
				contactJson.interaction_off_limit = this.prepareInteractionOffLimit(contactJson);
			}
		},
		onContactAdded: function(contactJson, source, updateListByBulk) {
			// wglog.debug('ContactListMediator - onContactAdded', contactJson, source);
			var updateList = !updateListByBulk;

			if (!this.getContactExists(contactJson.id_user)) {
				this.contacts.push(contactJson);
			} else if (updateList) {
				this.updateList();
			}
		},
		onContactListSorted: function(contacts) {
			wglog.debug('ContactListMediator - onContactListSorted', contacts);
			this.resetContacts();
			this.resetContactsToSort();
			this.prepareAllContacts(contacts);
		},
		onContactRemoved: function(result) {
			// wglog.debug('ContactListMediator - onContactRemoved', result);
			var allContactLists = this.getAllContactLists(),
				self = allContactLists[result.listType].mediator,
				index = self.getContactIndex(result.contact.id_user);

			if (index !== false && typeof index === 'number') {
				self.contacts.splice(index, 1);
				self.view.decreaseContactCount();
				self.view.removeContact(result.contact.id_user);
			}
		},
		onContactScoreSorted: function(result) {
			// wglog.debug('ContactListMediator - onContactScoreSorted', result);
			if (this.contactsToSort.indexOf(result.contact.id_user) === -1) {
				this.contactsToSort.push(result.contact);
			}
		},
		onContactSwitchedToNewList: function(contactIdAndListJson) {
			// wglog.debug('ContactListMediator - onContactSwitchedToNewList', contactIdAndListJson);
			var contactId = this.getContactIdFromList(contactIdAndListJson),
				contact = this.getChatFriendManager().friends[contactId];

			if (!contact) {
				wglog.debug('ContactListMediator - onContactSwitchedToNewList: no contact');
				return;
			}

			var chatFriendManager = this.getChatFriendManager(),
				oldList = 'followers',
				newList = 'customers';

			if (contact.is_customer) {
				oldList = 'customers';
				newList = 'followers';
			}

			//update entries in chat friend manager
			chatFriendManager[newList + '_ids'].push(parseInt(contactId));
			chatFriendManager[oldList + '_ids'].splice(chatFriendManager[oldList + '_ids'].indexOf(contactId), 1);

			contact.is_customer = !contact.is_customer;

			this.view.clearOldAndNewContactListsHtml(newList, oldList);

			//update on each contact list instance
			this.updateContactListAfterSwitch(contact, oldList, newList);

			this.getChatFriendManager().setSwitchContactListBtn(contactId);
		},
		onContactUpdated: function(contactJson) {
			// wglog.debug('ContactListMediator - onContactUpdated', contactJson);

			var supportIds = this.getChatFriendManager().support_ids;
			if (contactJson.is_support && supportIds.indexOf(contactJson.id_user) === -1) {
				supportIds.push(contactJson.id_user);
				contactJson.status = 'Offline';
			}

			this.addContact(contactJson, 'online');

			this.view.hideLoader();
		},
		onFollow: function(contactJson) {
			// wglog.debug('ContactListMediator - onFollow', contactJson);

			this.view.increaseContactCount();
			this.sortContactScore(contactJson.user, 'inbox');
		},
		onFollowedBy: function(contactJson) {
			var contactListType = !!contactJson.user.is_customer ? 'customers' : 'followers';
			if (contactListType !== this.view.getListType()) {
				return;
			}

			// wglog.debug('ContactListMediator - onFollowedBy', contactJson);

			var allContactLists = this.getAllContactLists();
			allContactLists[contactListType].increaseContactCount();
			allContactLists[contactListType].mediator.sortContactScore(contactJson.user, contactListType);
		},
		onHideAllContactLists: function() {
			// wglog.debug('ContactListMediator - onHideAllContactLists');

			this.manageContactListsDisplay(false);
		},
		onShowAllContactLists: function() {
			// wglog.debug('ContactListMediator - onShowAllContactLists');

			this.manageContactListsDisplay(true);
		},
		onUpdatedContactView: function() {},
		onUnfollow: function(contactJson) {
			var index = this.getContactIndex(contactJson.user_id);
			if (index !== false && typeof index === 'number') {
				// wglog.debug('ContactListMediator - onUnfollow', contactJson);
				this.removeContact(this.contacts[index]);
			}
		},
		onUnfollowedBy: function(contactJson) {
			var index = this.getContactIndex(contactJson.user_id);
			if (index !== false && typeof index === 'number') {
				// wglog.debug('ContactListMediator - onUnfollowedBy', contactJson);
				this.removeContact(this.contacts[index]);
			}
		},
		onUnreadMessageBadgeUpdated: function(result) {
			// wglog.debug('ContactListMediator - onUnreadMessageBadgeUpdated', result);

			this.updateUnreadMessageBadge(result.id, result.nb_unread);
		},
		prepareAllContacts: function(contacts) {
			wglog.debug('ContactListMediator - prepareAllContacts', contacts);

			for (var key in contacts.list) {
				var contact = contacts.list[key];
				this.prepareContact(contact, contacts.type);

				if (contact.id_user && !this.getContactExists(contact.id_user) && Object.keys(this.context.manager.nb_unread_messages).indexOf(contact.id_user.toString()) !== -1) {
					this.view.setUnreadMessage(this.context.manager.nb_unread_messages[contact.id_user]);
				}
			}

			// var updateSupports = !Config.login_info.is_support;
			this.view.updateContactList(true);
		},
		prepareContact: function(contactJson, listType) {
			// wglog.debug('ContactListMediator - prepareContact', contactJson, listType);

			if (contactJson.interaction) {
				contactJson.interaction_off_limit = this.prepareInteractionOffLimit(contactJson);
			}

			if (Config.login_info.is_creator && contactJson.expenses && !contactJson.is_support) {
				this.prepareExpenses(contactJson, listType);
			} else {
				this.onContactUpdated(contactJson);
			}
		},
		prepareExpenses: function(contactJson, listType) {
			// wglog.debug('ContactListMediator - prepareExpenses', contactJson, listType);

			EventEmitter.emit(this.getFeatureEvents().PREPARE_EXPENSES, {
				contact: contactJson,
				listType: listType
			});
		},
		prepareInteractionOffLimit: function(contactJson) {
			// wglog.debug('ContactListMediator - prepareInteractionOffLimit', contactJson);

			var date = new Date();
			date.setDate(date.getDate() - 7);
			date.setHours(0, 0, 0, 0);

			return contactJson.interaction < (date.getTime() / 1000);
		},
		removeContact: function(contactJson) {
			// wglog.debug('ContactListMediator - removeContact', contactJson);

			EventEmitter.emit(this.getFeatureEvents().REMOVE_CONTACT, {
				contact: contactJson,
				listType: this.view.getListType()
			});
		},
		resetContacts: function() {
			// wglog.debug('ContactListMediator - resetContacts');

			this.contacts = [];
		},
		resetContactsToSort: function() {
			// wglog.debug('ContactListMediator - resetContactsToSort');

			this.contactsToSort = [];
		},
		selectContact: function(contactId) {
			// wglog.debug('ContactListMediator - selectContact');

			this.getChatFriendManager().select_friend(contactId);
		},
		setContactsId: function(contactIds) {
			// wglog.debug('ContactListMediator - setContactsId', contactIds);

			this.getChatFriendManager().set_friends_id(contactIds);
		},
		setFiltersContactListButton: function(actions) {
			this.view.setFiltersContactListButton(actions);
		},
		setTabContactList: function(data) {
			this.view.setTabContactList(data.type);
		},
		sortContactList: function(listType, filter) {
			// wglog.debug('ContactListMediator - sortContactList', listType);

			var currentContactsIds = new Set(this.contacts.map(function (contact) { return contact.id_user; }));
			var hasCommons = this.contactsToSort.every(function (contact) { return currentContactsIds.has(contact.id_user); });

			if (!hasCommons) {
				var contacts = this.contacts.map(function(contact) {
					return contact;
				});
				this.contactsToSort = this.contactsToSort.concat(contacts);
				this.contacts = [];
			}

			EventEmitter.emit(this.getFeatureEvents().SORT_CONTACT_LIST, {
				list: this.contactsToSort,
				type: listType,
				filter: filter
			});
		},
		sortContactScore: function(contacts, listType) {
			wglog.debug('ContactListMediator - sortContactScore', contacts, listType);

			var filter = Storage.get('chat.contact_list_filter');
			if (!filter) filter = 'unreads';

			var datas = {
				type: listType,
				filter: filter
			};

			if (Object.keys(contacts).indexOf('id_user') !== -1) {
				datas.contact = contacts;
				EventEmitter.emit(this.getFeatureEvents().SORT_CONTACT_SCORE, datas);
			} else {
				var list = contacts.data || contacts;
				for (var contact in list) {
					datas.contact = list[contact];
					EventEmitter.emit(this.getFeatureEvents().SORT_CONTACT_SCORE, datas);
				}
			}

			this.sortContactList(listType, filter);
		},
		updateContactListAfterSwitch: function(contactJson, oldList, newList) {
			wglog.debug('ContactListMediator - updateContactListAfterSwitch', contactJson, oldList, newList);

			var allContactLists = this.getAllContactLists();

			allContactLists[newList].mediator.resetContactsToSort();
			allContactLists[oldList].mediator.resetContactsToSort();

			allContactLists[newList].mediator.contacts.push(contactJson);

			for (var index in allContactLists[oldList].mediator.contacts) {
				if (contactJson.id_user !== allContactLists[oldList].mediator.contacts[index].id_user) {
					continue;
				}
				allContactLists[oldList].mediator.contacts.splice(parseInt(index), 1);
			}

			allContactLists[newList].mediator.updateList();
			allContactLists[oldList].mediator.updateList();
		},
		updateContactLogOffline: function(contactId) {
			// wglog.debug('ContactListMediator - updateContactLogOffline', contactId);

			var index = this.getContactIndex(contactId);
			if (index !== false && typeof index === 'number') {
				this.contacts[index].status = 'Offline';
				this.view.updateContactLogStatus(contactId, 'Offline');
				this.sortContactScore(this.contacts, this.view.getListType());
			}
		},
		updateContactLogOnline: function(contactJson) {
			// wglog.debug('ContactListMediator - updateContactLogOnline', contactJson);

			var index = this.getContactIndex(contactJson.id_user);
			if (index !== false && typeof index === 'number') {
				this.contacts[index].status = 'Online';
				this.view.updateContactLogStatus(contactJson.id_user, 'Online');
				this.sortContactScore(this.contacts, this.view.getListType());
			}
		},
		updateList: function(contacts) {
            var _contacts = {
                type: this.view.getListType(),
                friends_infos: this.contacts.slice()
            };

            _contacts.friends_infos = _contacts.friends_infos.concat((contacts && contacts.friends_infos instanceof Array) ? contacts.friends_infos : []);

			wglog.debug('ContactListMediator - updateList', contacts);

            if (contacts) {
                this.view.updateCountContact(contacts.contact_count);
            }

            this.view.loadMoreCheckAvailability();
			this.sortContactScore(_contacts.friends_infos, _contacts.type);
		},
		updateUnreadMessageBadge: function(id, nbUnread) {
			// wglog.debug('ContactListMediator - updateUnreadMessageBadge', id, nbUnread);

            var unreadMessageSum = this.calculateNbUnreadMessagesSum();
			this.view.setUnreadMessage(unreadMessageSum);
			this.view.refreshAllCounters();

			this.addContactAttribute(id, 'nb_unread', nbUnread);
			this.view.updateUnreadMessageBadge(id, nbUnread);
			this.view.manageNewMessageClass(id, nbUnread);
		}
	});

	return ContactListMediator;
});
define('features/ContactList/ContactListMapper',[
	'config/chat',
	'core/ContextEvent',
	'chat/ManagerEvent',
	'features/ContactList/commands/AddContactAttributeCommand',
	'features/ContactList/commands/AddContactCommand',
	'features/ContactList/commands/AddContactsInfoCommand',
	'features/ContactList/commands/AllContactsCommand',
	'features/ContactList/commands/AllIdsAndContactsCommand',
	'features/ContactList/commands/ClearContactListCommand',
	'features/ContactList/commands/CreateContactListCommand',
	'features/ContactList/commands/GenerateAvatarCommand',
	'features/ContactList/commands/GetContactsInfoCommand',
	'features/ContactList/commands/GetContactsWithUnreadMessagesCommand',
	'features/ContactList/commands/GetMoreContactsCommand',
	'features/ContactList/commands/InitContactListFiltersButtonCommand',
	'features/ContactList/commands/PrepareExpensesCommand',
	'features/ContactList/commands/RemoveContactCommand',
	'features/ContactList/commands/RemoveContactFromCustomerListCommand',
	'features/ContactList/commands/RemoveContactListTabLocalStorageEntryCommand',
	'features/ContactList/commands/SortContactListCommand',
	'features/ContactList/commands/SortContactScoreCommand',
	'features/ContactList/commands/UnreadMessageBadgeCommand',
	'features/ContactList/views/ContactListMediator',
	'features/ContactList/views/ContactListView',
	'features/ContactList/events/ContactListEvent',
	'services/SocketConnection',
	'services/SocketConnectionEvent'
], function(
	Config,
	ContextEvent,
	ManagerEvent,
	AddContactAttributeCommand,
	AddContactCommand,
    AddContactsInfoCommand,
	AllContactsCommand,
	AllIdsAndContactsCommand,
	ClearContactListCommand,
	CreateContactListCommand,
	GenerateAvatarCommand,
    GetContactsInfoCommand,
    GetContactsWithUnreadMessagesCommand,
	GetMoreContactsCommand,
	InitContactListFiltersButtonCommand,
	PrepareExpensesCommand,
	RemoveContactCommand,
	RemoveContactFromCustomerListCommand,
	RemoveContactListTabLocalStorageEntryCommand,
	SortContactListCommand,
	SortContactScoreCommand,
	UnreadMessageBadgeCommand,
	ContactListMediator,
	ContactListView,
	ContactListEvent,
	SocketConnection,
	SocketConnectionEvent
) {
	return function(context) {
		context.commandMap.mapEvent(ContextEvent.STARTUP, RemoveContactListTabLocalStorageEntryCommand);

		context.commandMap.mapEvent(ContactListEvent.ADD_CONTACT, AddContactCommand);
		context.commandMap.mapEvent(ContactListEvent.ADD_CONTACT_ATTRIBUTE, AddContactAttributeCommand);
		context.commandMap.mapEvent(ContactListEvent.ALL_IDS_AND_FIRST_CONTACT_SUCCESS, AllIdsAndContactsCommand);
		context.commandMap.mapEvent(ContactListEvent.CREATE_CONTACT_LIST, CreateContactListCommand);
		context.commandMap.mapEvent(ContactListEvent.CONTACT_LIST_CREATED, GetContactsWithUnreadMessagesCommand);
		context.commandMap.mapEvent(ContactListEvent.CONTACTS, AllContactsCommand);
		context.commandMap.mapEvent(ContactListEvent.CONTACTS_INFO, AddContactsInfoCommand);
		context.commandMap.mapEvent(ContactListEvent.CLEAR_CONTACT_LIST_CONTEXT, ClearContactListCommand);
		context.commandMap.mapEvent(ContactListEvent.GET_CONTACTS_INFO, GetContactsInfoCommand);
		context.commandMap.mapEvent(ContactListEvent.GET_MORE, GetMoreContactsCommand);
		context.commandMap.mapEvent(ContactListEvent.GENERATE_AVATAR, GenerateAvatarCommand);
		context.commandMap.mapEvent(ContactListEvent.INIT_CONTACT_LIST_FILTERS, InitContactListFiltersButtonCommand);
		context.commandMap.mapEvent(ContactListEvent.PREPARE_EXPENSES, PrepareExpensesCommand);
		context.commandMap.mapEvent(ContactListEvent.REMOVE_CONTACT, RemoveContactCommand);
		context.commandMap.mapEvent(ContactListEvent.SORT_CONTACT_LIST, SortContactListCommand);
		context.commandMap.mapEvent(ContactListEvent.SORT_CONTACT_SCORE, SortContactScoreCommand);
		context.commandMap.mapEvent(ContactListEvent.UNREAD_MESSAGE_BADGE, UnreadMessageBadgeCommand);

		context.mediatorMap.mapEvent(ContactListEvent.ADD_CONTACT_FROM_SEARCH, ContactListMediator, 'addContactFromSearch');
		context.mediatorMap.mapEvent(ContactListEvent.ADDED_CONTACT, ContactListMediator, 'onContactAdded');
		context.mediatorMap.mapEvent(ContactListEvent.ADDED_CONTACT_ATTRIBUTE, ContactListMediator, 'onContactAttributeAdded');
		context.mediatorMap.mapEvent(ContactListEvent.CLEAR_CONTACT_LIST, ContactListMediator, 'clearContactList');
		context.mediatorMap.mapEvent(ContactListEvent.CONTACT_LIST_SORTED, ContactListMediator, 'onContactListSorted');
		context.mediatorMap.mapEvent(ContactListEvent.CONTACT_SCORE_SORTED, ContactListMediator, 'onContactScoreSorted');
		context.mediatorMap.mapEvent(ContactListEvent.FOLLOW, ContactListMediator, 'onFollow');
		context.mediatorMap.mapEvent(ContactListEvent.GENERATE_AVATAR_REQUEST, ContactListMediator, 'onAvatarGenerateRequest');
		context.mediatorMap.mapEvent(ContactListEvent.HIDE_CONTACT_LIST, ContactListMediator, 'onHideAllContactLists');
		context.mediatorMap.mapEvent(ContactListEvent.PREPARED_EXPENSES, ContactListMediator, 'onContactUpdated');
		context.mediatorMap.mapEvent(ContactListEvent.REMOVED_CONTACT, ContactListMediator, 'onContactRemoved');
		context.mediatorMap.mapEvent(ContactListEvent.SHOW_CONTACT_LIST, ContactListMediator, 'onShowAllContactLists');
		context.mediatorMap.mapEvent(ContactListEvent.UNFOLLOW, ContactListMediator, 'onUnfollow');
		context.mediatorMap.mapEvent(ContactListEvent.SET_FILTERS_CONTACT_LIST, ContactListMediator, 'setFiltersContactListButton');
		context.mediatorMap.mapEvent(ContactListEvent.UPDATE_LIST, ContactListMediator, 'updateList');
		context.mediatorMap.mapEvent(ContactListEvent.UNREAD_MESSAGE_BADGE_UPDATED, ContactListMediator, 'onUnreadMessageBadgeUpdated');
		context.mediatorMap.mapEvent(ContactListEvent.UPDATED_CONTACT_VIEW, ContactListMediator, 'onUpdatedContactView');
		context.mediatorMap.mapEvent(ContactListEvent.USER_LOG_ON, ContactListMediator, 'updateContactLogOnline');
		context.mediatorMap.mapEvent(ContactListEvent.USER_LOG_OFF, ContactListMediator, 'updateContactLogOffline');

		context.mediatorMap.mapView(ContactListView, ContactListMediator);

		SocketConnection.forwardIncomingEvent(SocketConnectionEvent.in.CONTACTS, ContactListEvent.CONTACTS);
		SocketConnection.forwardIncomingEvent(SocketConnectionEvent.in.CONTACTS_INFO, ContactListEvent.CONTACTS_INFO);
		SocketConnection.forwardIncomingEvent(SocketConnectionEvent.in.FOLLOW, ContactListEvent.FOLLOW);
		SocketConnection.forwardIncomingEvent(SocketConnectionEvent.in.CONTACT_INIT_DATA, ContactListEvent.ALL_IDS_AND_FIRST_CONTACT_SUCCESS);
		SocketConnection.forwardIncomingEvent(SocketConnectionEvent.in.UNFOLLOW, ContactListEvent.UNFOLLOW);
		SocketConnection.forwardIncomingEvent(SocketConnectionEvent.in.USER_LOG_ON, ContactListEvent.USER_LOG_ON);
		SocketConnection.forwardIncomingEvent(SocketConnectionEvent.in.USER_LOG_OFF, ContactListEvent.USER_LOG_OFF);
	};
});
define('features/ContactList/CustomerList/views/CustomerListView',[
	'lib/i18n!front',
	'features/ContactList/views/ContactListView'
], function(
	i18n,
	ContactListView
) {

	var LIST_TYPE = 'customers',
		TOTAL_CONTACT = 'total-' + LIST_TYPE,
		TOTAL_UNREAD_MESSAGE_CONTACT = 'total-unread-message-customers';

	var CustomerListView = function(data) {
		ContactListView.call(this, data);
	};

	CustomerListView.prototype = Object.create(ContactListView.prototype);

	Object.assign(CustomerListView.prototype, {
		attachContactListTab: function() {
			this.contactListTabContainer.prepend(this.contactListTab.getElement());
		},
		getContactTotalId: function() {
			return TOTAL_CONTACT;
		},
		getContactTotalUnread: function() {
			return TOTAL_UNREAD_MESSAGE_CONTACT;
		},
		getListName: function() {
			return i18n.__('chat.friends_costumers');
		},
		getListType: function() {
			return LIST_TYPE;
		}
	});

	return CustomerListView;

});
define('features/ContactList/CustomerList/commands/AllCustomersCommand',[
	'log_and_tooltip',
	'libs/EventEmitter',
	'core/Command',
	'features/ContactList/CustomerList/views/CustomerListView',
	'features/ContactList/CustomerList/events/CustomerListEvent',
    'services/SocketConnection',
    'services/SocketConnectionEvent'
], function(
	log_and_tooltip,
	EventEmitter,
	Command,
	CustomerListView,
	CustomerListEvent,
    SocketConnection,
    SocketConnectionEvent
) {
	var AllCustomers = function(context) {
		Command.call(this, context);
	};

	AllCustomers.prototype = Object.create(Command.prototype);

	Object.assign(AllCustomers.prototype, {
		execute: function (result) {
			if (!this.context.manager.contactLists) {
				this.context.manager.contactLists = {};
			}

			var list = this.formatList(result);
			this.context.chatFriendManager.set_friends_id(list.friends_ids);

			if (!this.context.manager.contactLists.customers) {
				this.createNewList(list);
			} else {
				this.updateList(list);
			}
		},
		createNewList: function(list) {
			wglog.debug('AllCustomersCommand create new list', list);
			this.context.manager.initContactListForCreator();
			this.context.manager.contactLists.customers = new CustomerListView(list);
		},
		formatList: function(json) {
			var list = {
				friends_ids: [],
				friends_infos: json.data || [],
				contact_count: json.total || 0,
				last_page: json.lastPage || 1,
				type: 'customers'
			};

			for (var index in json.data) {
				var contact = json.data[index];
				list.friends_ids.push(contact.id_user);
			}

			return list;
		},
		updateList: function(list) {
			wglog.debug('AllCustomersCommand update list', list);
			EventEmitter.emit(CustomerListEvent.UPDATE_LIST, list);
		}
	});

	return AllCustomers;
});
define('features/ContactList/CustomerList/commands/CreateContactListCustomersCommand',[
	'core/Command',
	'services/SocketConnection',
	'services/SocketConnectionEvent'
], function(
	Command,
	SocketConnection,
	SocketConnectionEvent
) {
	var CreateContactListCustomers = function(context) {
		Command.call(this, context);
	};

	CreateContactListCustomers.prototype = Object.create(Command.prototype);

	Object.assign(CreateContactListCustomers.prototype, {
		execute: function (filter) {
			if (!this.context.manager.contactLists) this.context.manager.contactLists = {};
			if (!this.context.manager.contactLists.init) this.context.manager.contactLists.init = new Set();

			this.context.manager.contactLists.init.add('customers');

			SocketConnection.emit(SocketConnectionEvent.out.GET_CONTACT_CUSTOMERS, filter);
		},
	});

	return CreateContactListCustomers;
});
define('features/ContactList/CustomerList/commands/GetMoreCustomersCommand',[
	'core/Command',
	'services/SocketConnection',
	'services/SocketConnectionEvent',
], function(
	Command,
	SocketConnection,
	SocketConnectionEvent
) {
	var GetMoreCustomers = function(context) {
		Command.call(this, context);
	};

	GetMoreCustomers.prototype = Object.create(Command.prototype);

	Object.assign(GetMoreCustomers.prototype, {
		execute: function (args) {
			if (typeof args === 'undefined' || typeof args.page === 'undefined') {
				throw new Error('No page');
				return;
			}

			SocketConnection.emit(SocketConnectionEvent.out.GET_CONTACT_CUSTOMERS, args);
		}
	});

	return GetMoreCustomers;
});
define('features/ContactList/CustomerList/views/CustomerListMediator',[
	'libs/EventEmitter',
	'features/ContactList/views/ContactListMediator',
	'features/ContactList/CustomerList/events/CustomerListEvent',
], function(
	EventEmitter,
	ContactListMediator,
	CustomerListEvent
) {
	var CustomerListMediator = function (view, context, mediatorMap) {
		ContactListMediator.call(this, view, context, mediatorMap);
	}

	CustomerListMediator.prototype = Object.create(ContactListMediator.prototype);

	Object.assign(CustomerListMediator.prototype, {
		getFeatureEvents: function() {
			return CustomerListEvent;
		},
		getContactIdFromList: function(contactIdJson) {
			return contactIdJson.customer_id;
		},
		loadMore: function(nextPage) {
			wglog.debug('CustomerListMediator - loadMore');
			EventEmitter.emit(CustomerListEvent.GET_MORE, {
				page: nextPage
			});
		}
	});

	return CustomerListMediator;
});
define('features/ContactList/CustomerList/CustomerListMapper',[
	'features/ContactList/commands/AddContactAttributeCommand',
	'features/ContactList/commands/AddContactCommand',
	'features/ContactList/commands/GenerateAvatarCommand',
	'features/ContactList/commands/PrepareExpensesCommand',
	'features/ContactList/commands/RemoveContactCommand',
	'features/ContactList/commands/RemoveContactFromCustomerListCommand',
	'features/ContactList/commands/SortContactListCommand',
	'features/ContactList/commands/SortContactScoreCommand',
	'features/ContactList/CustomerList/commands/AllCustomersCommand',
	'features/ContactList/CustomerList/commands/CreateContactListCustomersCommand',
	'features/ContactList/CustomerList/commands/GetMoreCustomersCommand',
	'features/ContactList/CustomerList/views/CustomerListMediator',
	'features/ContactList/CustomerList/views/CustomerListView',
	'features/ContactList/CustomerList/events/CustomerListEvent',
	'services/SocketConnection',
	'services/SocketConnectionEvent'
], function(
	AddContactAttributeCommand,
	AddContactCommand,
	GenerateAvatarCommand,
	PrepareExpensesCommand,
	RemoveContactCommand,
	RemoveContactFromCustomerListCommand,
	SortContactListCommand,
	SortContactScoreCommand,
	AllCustomersCommand,
	CreateContactListCustomersCommand,
	GetMoreCustomersCommand,
	CustomerListMediator,
	CustomerListView,
	CustomerListEvent,
	SocketConnection,
	SocketConnectionEvent
) {
	return function(context) {
		context.commandMap.mapEvent(CustomerListEvent.ADD_CONTACT, AddContactCommand);
		context.commandMap.mapEvent(CustomerListEvent.ADD_CONTACT_ATTRIBUTE, AddContactAttributeCommand);
		context.commandMap.mapEvent(CustomerListEvent.GET_MORE, GetMoreCustomersCommand);
		context.commandMap.mapEvent(CustomerListEvent.GENERATE_AVATAR, GenerateAvatarCommand);
		context.commandMap.mapEvent(CustomerListEvent.PREPARE_EXPENSES, PrepareExpensesCommand);
		context.commandMap.mapEvent(CustomerListEvent.REMOVE_CONTACT, RemoveContactCommand);
		context.commandMap.mapEvent(CustomerListEvent.REMOVE_CONTACT_FROM_CUSTOMER_LIST, RemoveContactFromCustomerListCommand);
		context.commandMap.mapEvent(CustomerListEvent.SORT_CONTACT_LIST, SortContactListCommand);
		context.commandMap.mapEvent(CustomerListEvent.SORT_CONTACT_SCORE, SortContactScoreCommand);

		context.commandMap.mapEvent(CustomerListEvent.ALL_CUSTOMERS_SUCCESS, AllCustomersCommand);
		context.commandMap.mapEvent(CustomerListEvent.CREATE_CONTACT_LIST, CreateContactListCustomersCommand);

		context.mediatorMap.mapEvent(CustomerListEvent.ADD_CONTACT_FROM_SEARCH, CustomerListMediator, 'addContactFromSearch');
		context.mediatorMap.mapEvent(CustomerListEvent.ADDED_CONTACT, CustomerListMediator, 'onContactAdded');
		context.mediatorMap.mapEvent(CustomerListEvent.ADDED_CONTACT_ATTRIBUTE, CustomerListMediator, 'onContactAttributeAdded');
		context.mediatorMap.mapEvent(CustomerListEvent.CLEAR_CONTACT_LIST, CustomerListMediator, 'clearContactList');
		context.mediatorMap.mapEvent(CustomerListEvent.CONTACT_ADDED_TO_FOLLOWER_LIST, CustomerListMediator, 'onContactSwitchedToNewList');
		context.mediatorMap.mapEvent(CustomerListEvent.CONTACT_LIST_CREATED, CustomerListMediator, 'setTabContactList');
		context.mediatorMap.mapEvent(CustomerListEvent.CONTACT_LIST_SORTED, CustomerListMediator, 'onContactListSorted');
		context.mediatorMap.mapEvent(CustomerListEvent.CONTACT_SCORE_SORTED, CustomerListMediator, 'onContactScoreSorted');
		context.mediatorMap.mapEvent(CustomerListEvent.FOLLOWED_BY, CustomerListMediator, 'onFollowedBy');
		context.mediatorMap.mapEvent(CustomerListEvent.GENERATE_AVATAR_REQUEST, CustomerListMediator, 'onAvatarGenerateRequest');
		context.mediatorMap.mapEvent(CustomerListEvent.HIDE_CONTACT_LIST, CustomerListMediator, 'onHideAllContactLists');
		context.mediatorMap.mapEvent(CustomerListEvent.PREPARED_EXPENSES, CustomerListMediator, 'onContactUpdated');
		context.mediatorMap.mapEvent(CustomerListEvent.REMOVED_CONTACT, CustomerListMediator, 'onContactRemoved');
		context.mediatorMap.mapEvent(CustomerListEvent.SHOW_CONTACT_LIST, CustomerListMediator, 'onShowAllContactLists');
		context.mediatorMap.mapEvent(CustomerListEvent.UNFOLLOWED_BY, CustomerListMediator, 'onUnfollowedBy');
		context.mediatorMap.mapEvent(CustomerListEvent.UNREAD_MESSAGE_BADGE_UPDATED, CustomerListMediator, 'onUnreadMessageBadgeUpdated');
		context.mediatorMap.mapEvent(CustomerListEvent.SET_FILTERS_CONTACT_LIST, CustomerListMediator, 'setFiltersContactListButton');
		context.mediatorMap.mapEvent(CustomerListEvent.UPDATE_LIST, CustomerListMediator, 'updateList');
		context.mediatorMap.mapEvent(CustomerListEvent.UPDATED_CONTACT_VIEW, CustomerListMediator, 'onUpdatedContactView');
		context.mediatorMap.mapEvent(CustomerListEvent.USER_LOG_ON, CustomerListMediator, 'updateContactLogOnline');
		context.mediatorMap.mapEvent(CustomerListEvent.USER_LOG_OFF, CustomerListMediator, 'updateContactLogOffline');

		context.mediatorMap.mapView(CustomerListView, CustomerListMediator);

		SocketConnection.forwardIncomingEvent(SocketConnectionEvent.in.GET_CONTACT_CUSTOMERS_SUCCESS, CustomerListEvent.ALL_CUSTOMERS_SUCCESS);
		SocketConnection.forwardIncomingEvent(SocketConnectionEvent.in.CUSTOMER_REMOVED_FROM_CUSTOMER_LIST, CustomerListEvent.CONTACT_ADDED_TO_FOLLOWER_LIST);
		SocketConnection.forwardIncomingEvent(SocketConnectionEvent.in.FOLLOWED_BY, CustomerListEvent.FOLLOWED_BY);
		SocketConnection.forwardIncomingEvent(SocketConnectionEvent.in.UNFOLLOWED_BY, CustomerListEvent.UNFOLLOWED_BY);
		SocketConnection.forwardIncomingEvent(SocketConnectionEvent.in.USER_LOG_ON, CustomerListEvent.USER_LOG_ON);
		SocketConnection.forwardIncomingEvent(SocketConnectionEvent.in.USER_LOG_OFF, CustomerListEvent.USER_LOG_OFF);
	};
});
define('features/ContactList/commands/AddContactToCustomerListCommand',[
	'log_and_tooltip',
	'libs/EventEmitter',
	'core/Command',
	'services/SocketConnection',
	'services/SocketConnectionEvent'
], function(
	log_and_tooltip,
	EventEmitter,
	Command,
	SocketConnection,
	SocketConnectionEvent
) {
	var AddFollowerToCustomerList = function(context) {
		Command.call(this, context);
	};

	AddFollowerToCustomerList.prototype = Object.create(Command.prototype);

	Object.assign(AddFollowerToCustomerList.prototype, {
		execute: function (idContact) {
			SocketConnection.emit(SocketConnectionEvent.out.ADD_FOLLOWER_TO_CUSTOMER_LIST, {
				follower_id: idContact
			});
		}
	});

	return AddFollowerToCustomerList;
});
define('features/ContactList/FollowerList/views/FollowerListView',[
	'lib/i18n!front',
	'features/ContactList/views/ContactListView'
], function(
	i18n,
	ContactListView
) {

	var LIST_TYPE = 'followers',
		TOTAL_CONTACT = 'total-' + LIST_TYPE,
		TOTAL_UNREAD_MESSAGE_CONTACT = 'total-unread-message-' + LIST_TYPE;

	var FollowerListView = function(data) {
		ContactListView.call(this, data);
	};

	FollowerListView.prototype = Object.create(ContactListView.prototype);

	Object.assign(FollowerListView.prototype, {
		attachContactListTab: function() {
			this.contactListTabContainer.append(this.contactListTab.getElement());
		},
		getContactTotalId: function() {
			return TOTAL_CONTACT;
		},
		getContactTotalUnread: function() {
			return TOTAL_UNREAD_MESSAGE_CONTACT;
		},
		getListName: function() {
			return i18n.__('chat.friends_followers');
		},
		getListType: function() {
			return LIST_TYPE;
		}
	});

	return FollowerListView;

});
define('features/ContactList/FollowerList/commands/AllFollowersCommand',[
	'log_and_tooltip',
	'libs/EventEmitter',
	'core/Command',
	'features/ContactList/FollowerList/views/FollowerListView',
	'features/ContactList/FollowerList/events/FollowerListEvent',
], function(
	log_and_tooltip,
	EventEmitter,
	Command,
	FollowerListView,
	FollowerListEvent
) {
	var AllFollowers = function(context) {
		Command.call(this, context);
	};

	AllFollowers.prototype = Object.create(Command.prototype);

	Object.assign(AllFollowers.prototype, {
		execute: function (result) {
			if (!result) {
				return;
			}

			if (!this.context.manager.contactLists) {
				this.context.manager.contactLists = {};
			}

			var list = this.formatList(result);
			this.context.chatFriendManager.set_friends_id(list.friends_ids);

			if (!this.context.manager.contactLists.followers) {
				this.createNewList(list);
			} else {
				this.updateList(list);
			}
		},
		createNewList: function(list) {
			wglog.debug('AllFollowersCommand create new list', list);
			this.context.manager.contactLists.followers = new FollowerListView(list);
		},
		formatList: function(json) {
			var list = {
				friends_ids: [],
				friends_infos: json.data || [],
				contact_count: json.total || 0,
				last_page: json.lastPage || 1,
				type: 'followers'
			};

			for (var index in json.data) {
				var contact = json.data[index];
				list.friends_ids.push(contact.id_user);
			}

			return list;
		},
		updateList: function(list) {
			wglog.debug('AllFollowersCommand update list', list);
			EventEmitter.emit(FollowerListEvent.UPDATE_LIST, list);
		}
	});

	return AllFollowers;
});
define('features/ContactList/FollowerList/commands/CreateContactListFollowersCommand',[
	'core/Command',
	'services/SocketConnection',
	'services/SocketConnectionEvent',
], function(
	Command,
	SocketConnection,
	SocketConnectionEvent
) {
	var CreateContactListFollowers = function(context) {
		Command.call(this, context);
	};

	CreateContactListFollowers.prototype = Object.create(Command.prototype);

	Object.assign(CreateContactListFollowers.prototype, {
		execute: function (filter) {
			if (!this.context.manager.contactLists) this.context.manager.contactLists = {};
			if (!this.context.manager.contactLists.init) this.context.manager.contactLists.init = new Set();

			this.context.manager.contactLists.init.add('followers');

			SocketConnection.emit(SocketConnectionEvent.out.GET_CONTACT_FOLLOWERS, filter);
		},
	});

	return CreateContactListFollowers;
});
define('features/ContactList/FollowerList/commands/GetMoreFollowersCommand',[
	'core/Command',
	'services/SocketConnection',
	'services/SocketConnectionEvent',
], function(
	Command,
	SocketConnection,
	SocketConnectionEvent
) {
	var getMoreFollowers = function(context) {
		Command.call(this, context);
	};

	getMoreFollowers.prototype = Object.create(Command.prototype);

	Object.assign(getMoreFollowers.prototype, {
		execute: function (args) {
			if (typeof args === 'undefined' || typeof args.page === 'undefined') {
				throw new Error('No page');
				return;
			}

			SocketConnection.emit(SocketConnectionEvent.out.GET_CONTACT_FOLLOWERS, args);
		}
	});

	return getMoreFollowers;
});
define('features/ContactList/FollowerList/views/FollowerListMediator',[
	'libs/EventEmitter',
	'features/ContactList/views/ContactListMediator',
	'features/ContactList/FollowerList/events/FollowerListEvent',
], function(
	EventEmitter,
	ContactListMediator,
	FollowerListEvent
) {
	var FollowerListMediator = function (view, context, mediatorMap) {
		ContactListMediator.call(this, view, context, mediatorMap);
	}

	FollowerListMediator.prototype = Object.create(ContactListMediator.prototype);

	Object.assign(FollowerListMediator.prototype, {
		getFeatureEvents: function() {
			return FollowerListEvent;
		},
		getContactIdFromList: function(contactIdJson) {
			return contactIdJson.follower_id;
		},
		loadMore: function(nextPage) {
			wglog.debug('FollowerListMediator - loadMore');
			EventEmitter.emit(FollowerListEvent.GET_MORE, {
				page: nextPage
			});
		}
	});

	return FollowerListMediator;
});
define('features/ContactList/FollowerList/FollowerListMapper',[
	'features/ContactList/commands/AddContactAttributeCommand',
	'features/ContactList/commands/AddContactCommand',
	'features/ContactList/commands/AddContactToCustomerListCommand',
	'features/ContactList/commands/GenerateAvatarCommand',
	'features/ContactList/commands/PrepareExpensesCommand',
	'features/ContactList/commands/RemoveContactCommand',
	'features/ContactList/commands/SortContactListCommand',
	'features/ContactList/commands/SortContactScoreCommand',
	'features/ContactList/FollowerList/commands/AllFollowersCommand',
	'features/ContactList/FollowerList/commands/CreateContactListFollowersCommand',
	'features/ContactList/FollowerList/commands/GetMoreFollowersCommand',
	'features/ContactList/FollowerList/views/FollowerListMediator',
	'features/ContactList/FollowerList/views/FollowerListView',
	'features/ContactList/FollowerList/events/FollowerListEvent',
	'services/SocketConnection',
	'services/SocketConnectionEvent'
], function(
	AddContactAttributeCommand,
	AddContactCommand,
	AddContactToCustomerListCommand,
	GenerateAvatarCommand,
	PrepareExpensesCommand,
	RemoveContactCommand,
	SortContactListCommand,
	SortContactScoreCommand,
	AllFollowersCommand,
	CreateContactListFollowersCommand,
	GetMoreFollowersCommand,
	FollowerListMediator,
	FollowerListView,
	FollowerListEvent,
	SocketConnection,
	SocketConnectionEvent
) {
	return function(context) {
		context.commandMap.mapEvent(FollowerListEvent.ADD_CONTACT, AddContactCommand);
		context.commandMap.mapEvent(FollowerListEvent.ADD_CONTACT_ATTRIBUTE, AddContactAttributeCommand);
		context.commandMap.mapEvent(FollowerListEvent.ADD_CONTACT_TO_CUSTOMER_LIST, AddContactToCustomerListCommand);
		context.commandMap.mapEvent(FollowerListEvent.GENERATE_AVATAR, GenerateAvatarCommand);
		context.commandMap.mapEvent(FollowerListEvent.GET_MORE, GetMoreFollowersCommand);
		context.commandMap.mapEvent(FollowerListEvent.PREPARE_EXPENSES, PrepareExpensesCommand);
		context.commandMap.mapEvent(FollowerListEvent.REMOVE_CONTACT, RemoveContactCommand);
		context.commandMap.mapEvent(FollowerListEvent.SORT_CONTACT_LIST, SortContactListCommand);
		context.commandMap.mapEvent(FollowerListEvent.SORT_CONTACT_SCORE, SortContactScoreCommand);

		context.commandMap.mapEvent(FollowerListEvent.ALL_FOLLOWERS_SUCCESS, AllFollowersCommand);
		context.commandMap.mapEvent(FollowerListEvent.CREATE_CONTACT_LIST, CreateContactListFollowersCommand);

		context.mediatorMap.mapEvent(FollowerListEvent.ADD_CONTACT_FROM_SEARCH, FollowerListMediator, 'addContactFromSearch');
		context.mediatorMap.mapEvent(FollowerListEvent.ADDED_CONTACT, FollowerListMediator, 'onContactAdded');
		context.mediatorMap.mapEvent(FollowerListEvent.ADDED_CONTACT_ATTRIBUTE, FollowerListMediator, 'onContactAttributeAdded');
		context.mediatorMap.mapEvent(FollowerListEvent.CLEAR_CONTACT_LIST, FollowerListMediator, 'clearContactList');
		context.mediatorMap.mapEvent(FollowerListEvent.CONTACT_ADDED_TO_CUSTOMER_LIST, FollowerListMediator, 'onContactSwitchedToNewList');
		context.mediatorMap.mapEvent(FollowerListEvent.CONTACT_LIST_CREATED, FollowerListMediator, 'setTabContactList');
		context.mediatorMap.mapEvent(FollowerListEvent.CONTACT_LIST_SORTED, FollowerListMediator, 'onContactListSorted');
		context.mediatorMap.mapEvent(FollowerListEvent.CONTACT_SCORE_SORTED, FollowerListMediator, 'onContactScoreSorted');
		context.mediatorMap.mapEvent(FollowerListEvent.FOLLOWED_BY, FollowerListMediator, 'onFollowedBy');
		context.mediatorMap.mapEvent(FollowerListEvent.GENERATE_AVATAR_REQUEST, FollowerListMediator, 'onAvatarGenerateRequest');
		context.mediatorMap.mapEvent(FollowerListEvent.HIDE_CONTACT_LIST, FollowerListMediator, 'onHideAllContactLists');
		context.mediatorMap.mapEvent(FollowerListEvent.PREPARED_EXPENSES, FollowerListMediator, 'onContactUpdated');
		context.mediatorMap.mapEvent(FollowerListEvent.REMOVED_CONTACT, FollowerListMediator, 'onContactRemoved');
		context.mediatorMap.mapEvent(FollowerListEvent.SET_FILTERS_CONTACT_LIST, FollowerListMediator, 'setFiltersContactListButton');
		context.mediatorMap.mapEvent(FollowerListEvent.SHOW_CONTACT_LIST, FollowerListMediator, 'onShowAllContactLists');
		context.mediatorMap.mapEvent(FollowerListEvent.UNFOLLOWED_BY, FollowerListMediator, 'onUnfollowedBy');
		context.mediatorMap.mapEvent(FollowerListEvent.UNREAD_MESSAGE_BADGE_UPDATED, FollowerListMediator, 'onUnreadMessageBadgeUpdated');
		context.mediatorMap.mapEvent(FollowerListEvent.UPDATE_LIST, FollowerListMediator, 'updateList');
		context.mediatorMap.mapEvent(FollowerListEvent.UPDATED_CONTACT_VIEW, FollowerListMediator, 'onUpdatedContactView');
		context.mediatorMap.mapEvent(FollowerListEvent.USER_LOG_ON, FollowerListMediator, 'updateContactLogOnline');
		context.mediatorMap.mapEvent(FollowerListEvent.USER_LOG_OFF, FollowerListMediator, 'updateContactLogOffline');

		context.mediatorMap.mapView(FollowerListView, FollowerListMediator);

		SocketConnection.forwardIncomingEvent(SocketConnectionEvent.in.GET_CONTACT_FOLLOWERS_SUCCESS, FollowerListEvent.ALL_FOLLOWERS_SUCCESS);
		SocketConnection.forwardIncomingEvent(SocketConnectionEvent.in.FOLLOWERS_ADDED_TO_CUSTOMER_LIST, FollowerListEvent.CONTACT_ADDED_TO_CUSTOMER_LIST);
		SocketConnection.forwardIncomingEvent(SocketConnectionEvent.in.FOLLOWED_BY, FollowerListEvent.FOLLOWED_BY);
		SocketConnection.forwardIncomingEvent(SocketConnectionEvent.in.UNFOLLOWED_BY, FollowerListEvent.UNFOLLOWED_BY);
		SocketConnection.forwardIncomingEvent(SocketConnectionEvent.in.USER_LOG_ON, FollowerListEvent.USER_LOG_ON);
		SocketConnection.forwardIncomingEvent(SocketConnectionEvent.in.USER_LOG_OFF, FollowerListEvent.USER_LOG_OFF);
	};
});
define('features/ContactList/SupportList/views/SupportListView',[
	'lib/i18n!front',
	'features/ContactList/views/ContactListView',
	'features/ContactList/views/components/SupportsList/SupportsList'
], function(
	i18n,
	ContactListView,
	SupportsList
) {

	var LIST_TYPE = 'supports';

	var SupportListView = function(data) {
		ContactListView.call(this, data);
	};

	SupportListView.prototype = Object.create(ContactListView.prototype);

	Object.assign(SupportListView.prototype, {
		attachContact: function(contactJson, source, updateSupports) {
			if (contactJson.is_support && !updateSupports) return;

			wglog.debug('SupportListView - attachContact', contactJson, source, updateSupports);
			if (this.supportsListComponent && contactJson.is_support) {
				this.supportsListComponent.appendContactItem(this.generateContactHtml(contactJson, source))
			}
		},
		createContactList: function(contacts) {
			wglog.debug('SupportListView - createContactList', this.getListType(), contacts);
			this.mediator.createContactList(contacts, this.getListType());
		},
		getListType: function() {
			return LIST_TYPE;
		},
		initList: function(result) {
			wglog.debug('SupportListView - initList:', result);

			this.supportsListComponent = new SupportsList(
				this.mediator.getChatFriendManager(),
				this.getListType()
			);

			this.createContactList(result.friends_infos);
		},
		updateContactList: function(updateSupport) {
			wglog.debug('SupportListView - updateContactList - updateSupport :', updateSupport, '- listType :', this.getListType());

			if (this.supportsListComponent) {
				this.supportsListComponent.clearContactListSupportHtml(updateSupport);
			}

			this.generateContactListHtml(updateSupport);

			if (this.supportsListComponent && !this.created) {
				this.listCreated();
			}
		},
	});

	return SupportListView;

});
define('features/ContactList/SupportList/commands/AllSupportsCommand',[
	'config/chat',
	'log_and_tooltip',
	'libs/EventEmitter',
	'core/Command',
	'features/ContactList/SupportList/views/SupportListView'
], function(
	config,
	log_and_tooltip,
	EventEmitter,
	Command,
	SupportListView
) {
	var AllSupports = function(context) {
		Command.call(this, context);
	};

	AllSupports.prototype = Object.create(Command.prototype);

	Object.assign(AllSupports.prototype, {
		execute: function (result) {
			if (!this.context.manager.contactLists) this.context.manager.contactLists = {};

			var list = this.formatList(result);
			this.context.chatFriendManager.set_friends_id(list.friends_ids);

			this.context.manager.contactLists.supports = new SupportListView(list);
			this.context.manager.initContactListForSupport(list.friends_ids);
		},
		filterSupports: function(json) {
			var siteName = config.i18n_website_name,
				supportSheer = [43038153, 43038155, 43038156, 43038158],
				supportPornbox = [42422876];

			json.data = json.data.filter(function(contact) {
				if ((siteName === 'Pornbox' && supportSheer.indexOf(contact.id_user) === -1) || (siteName === 'Sheer' && supportPornbox.indexOf(contact.id_user) === -1)) {
					return contact;
				}
			});

			return json;
		},
		formatList: function(_json) {
			var json = this.filterSupports(_json);
			var list = {
				friends_ids: [],
				friends_infos: json.data || [],
				contact_count: json.total || 0,
				last_page: json.lastPage || 1,
				type: 'supports'
			};

			for (var index in json.data) {
				list.friends_ids.push(json.data[index].id_user);
			}

			return list;
		}
	});

	return AllSupports;
});
define('features/ContactList/SupportList/commands/CreateContactListSupportCommand',[
	'log_and_tooltip',
	'libs/EventEmitter',
	'core/Command',
	'features/ContactList/CustomerList/views/CustomerListView',
	'features/ContactList/CustomerList/events/CustomerListEvent',
	'services/SocketConnection',
	'services/SocketConnectionEvent'
], function(
	log_and_tooltip,
	EventEmitter,
	Command,
	CustomerListView,
	CustomerListEvent,
	SocketConnection,
	SocketConnectionEvent
) {
	var CreateContactListSupports = function(context) {
		Command.call(this, context);
	};

	CreateContactListSupports.prototype = Object.create(Command.prototype);

	Object.assign(CreateContactListSupports.prototype, {
		execute: function () {
			if (!this.context.manager.contactLists) this.context.manager.contactLists = {};
			if (!this.context.manager.contactLists.init) this.context.manager.contactLists.init = new Set();

			this.context.manager.contactLists.init.add('supports');

			SocketConnection.emit(SocketConnectionEvent.out.GET_SUPPORTS_LIST, {});
		}
	});

	return CreateContactListSupports;
});
define('features/ContactList/SupportList/views/SupportListMediator',[
	'libs/EventEmitter',
	'features/ContactList/views/ContactListMediator',
	'features/ContactList/SupportList/events/SupportListEvent',
], function(
	EventEmitter,
	ContactListMediator,
	SupportListEvent
) {
	var SupportListMediator = function (view, context, mediatorMap) {
		ContactListMediator.call(this, view, context, mediatorMap);
	}

	SupportListMediator.prototype = Object.create(ContactListMediator.prototype);

	Object.assign(SupportListMediator.prototype, {
		createContactList: function(contacts, listType) {
			wglog.debug('SupportListMediator - createContactList', contacts, listType);
			this.sortContactScore(contacts, listType);
		},
		getFeatureEvents: function() {
			return SupportListEvent;
		},
	});

	return SupportListMediator;
});
define('features/ContactList/SupportList/SupportListMapper',[
	'features/ContactList/commands/AddContactCommand',
	'features/ContactList/commands/SortContactListCommand',
	'features/ContactList/commands/SortContactScoreCommand',
	'features/ContactList/SupportList/commands/AllSupportsCommand',
	'features/ContactList/SupportList/commands/CreateContactListSupportCommand',
	'features/ContactList/SupportList/views/SupportListMediator',
	'features/ContactList/SupportList/views/SupportListView',
	'features/ContactList/SupportList/events/SupportListEvent',
	'services/SocketConnection',
	'services/SocketConnectionEvent'
], function(
	AddContactCommand,
	SortContactListCommand,
	SortContactScoreCommand,
	AllSupportsCommand,
	CreateContactListSupportCommand,
	SupportListMediator,
	SupportListView,
	SupportListEvent,
	SocketConnection,
	SocketConnectionEvent
) {
	return function(context) {
		context.commandMap.mapEvent(SupportListEvent.ADD_CONTACT, AddContactCommand);
		context.commandMap.mapEvent(SupportListEvent.SORT_CONTACT_LIST, SortContactListCommand);
		context.commandMap.mapEvent(SupportListEvent.SORT_CONTACT_SCORE, SortContactScoreCommand);

		context.commandMap.mapEvent(SupportListEvent.ALL_SUPPORTS_SUCCESS, AllSupportsCommand);
		context.commandMap.mapEvent(SupportListEvent.CREATE_CONTACT_LIST, CreateContactListSupportCommand);

		context.mediatorMap.mapEvent(SupportListEvent.ADDED_CONTACT, SupportListMediator, 'onContactAdded');
		context.mediatorMap.mapEvent(SupportListEvent.ADDED_CONTACT_ATTRIBUTE, SupportListMediator, 'onContactAttributeAdded');
		context.mediatorMap.mapEvent(SupportListEvent.CONTACT_LIST_SORTED, SupportListMediator, 'onContactListSorted');
		context.mediatorMap.mapEvent(SupportListEvent.CONTACT_SCORE_SORTED, SupportListMediator, 'onContactScoreSorted');

		context.mediatorMap.mapView(SupportListView, SupportListMediator);

		SocketConnection.forwardIncomingEvent(SocketConnectionEvent.in.GET_SUPPORTS_LIST_SUCCESS, SupportListEvent.ALL_SUPPORTS_SUCCESS);
	};
});
define('features/CreatorMessages/MassMessage/events/MassMessageEvent',[], function () {

	var MassMessageEvent = Object.create(null),
		NAMESPACE = '.mass_message'

	Object.defineProperties(MassMessageEvent, {
		ADD_CONTENT_SERVICE: {value: 'add_content_service' + NAMESPACE, writable: false},
		ALL_TRANSLATED: {value: 'all_translated' + NAMESPACE, writable: false},
		CANCEL: {value: 'cancel' + NAMESPACE, writable: false},
		CANCELLED: {value: 'cancelled' + NAMESPACE, writable: false},
		CREATE_CONTENT_INSTANCE: {value: 'create-content-instance' + NAMESPACE, writable: false},
		CREATE_VAULT_INSTANCE: {value: 'create-vault-instance' + NAMESPACE, writable: false},
		OPEN: {value: 'open' + NAMESPACE, writable: false},
		OPEN_FROM_LOCAL_STORAGE: {value:'open_from_local_storage' + NAMESPACE, writable: false},
		GET_ALL: {value: 'get_all' + NAMESPACE, writable: false},
		GET_TARGETS_ESTIMATION: {value: 'get_targets_estimation' + NAMESPACE, writable: false},
		READY: {value: 'ready' + NAMESPACE, writable: false},
		LOAD_MORE: {value: 'load_more' + NAMESPACE, writable: false},
		SAVE: {value: 'save' + NAMESPACE, writable: false},
		SAVED: {value: 'saved' + NAMESPACE, writable: false},
		TARGETS_ESTIMATION: {value: 'targets_estimation' + NAMESPACE, writable: false},
		TRANSLATE_ALL: {value: 'translate_all' + NAMESPACE, writable: false},
		MASS_MESSAGE_SENT: {value: 'mass_message_sent' + NAMESPACE, writable: false},
		VAULT_CONTENT_CREATED: {value: 'vault-content-created' + NAMESPACE, writable: false},
		VAULT_GET_CONTENT_PRELOAD: {value: 'get_vault_content_preload' + NAMESPACE, writable: false},
		CONTENT_GET_CONTENT_PRELOAD: {value: 'get_content_preload' + NAMESPACE, writable: false},
		VAULT_CONTENT_ERROR: {value: 'vault-content-create-error' + NAMESPACE, writable: false}
	});

	return MassMessageEvent;
});
define('features/CreatorMessages/AutoMessage/events/AutoMessageEvent',[], function () {

	var AutoMessageEvent = Object.create(null),
		NAMESPACE = '.auto_message';

	Object.defineProperties(AutoMessageEvent, {
		ADD_CONTENT_SERVICE: {value: 'add_content_service' + NAMESPACE, writable: false},
		AUTO_MESSAGE_SENT: {value: 'auto_message_sent' + NAMESPACE, writable: false},
		ALL_EVENT: {value: 'get_event_list' + NAMESPACE, writable: false},
		ALL_TRANSLATED: {value: 'all_translated' + NAMESPACE, writable: false},
		CREATE_CONTENT_INSTANCE: {value: 'create-content-instance' + NAMESPACE, writable: false},
		CREATE_VAULT_INSTANCE: {value: 'create-vault-instance' + NAMESPACE, writable: false},
		EDIT: {value: 'edit' + NAMESPACE, writable: false},
		EDITED: {value: 'edited' + NAMESPACE, writable: false},
		GET_ALL_MESSAGES_DISABLED: {value: 'get_all_messages_disabled' + NAMESPACE, writable: false},
		OPEN: {value: 'open' + NAMESPACE, writable: false},
		OPEN_FROM_LOCAL_STORAGE_EVENTS: {value:'open_from_local_storage' + NAMESPACE, writable: false},
		READY: {value: 'ready' + NAMESPACE, writable: false},
		LOAD_MORE: {value: 'load_more' + NAMESPACE, writable: false},
		SAVE: {value: 'save' + NAMESPACE, writable: false},
		SAVED: {value: 'saved' + NAMESPACE, writable: false},
		SWITCH: {value: 'switch' + NAMESPACE, writable: false},
		SWITCHED: {value: 'switched' + NAMESPACE, writable: false},
		TRANSLATE_ALL: {value: 'translate_all' + NAMESPACE, writable: false},
		VAULT_CONTENT_CREATED: {value: 'vault-content-created' + NAMESPACE, writable: false},
		VAULT_GET_CONTENT_PRELOAD: {value: 'get_vault_content_preload' + NAMESPACE, writable: false},
		CONTENT_GET_CONTENT_PRELOAD: {value: 'get_content_preload' + NAMESPACE, writable: false},
		VAULT_CONTENT_ERROR: {value: 'vault-content-create-error' + NAMESPACE, writable: false}
	});

	return AutoMessageEvent;
});
define('features/Content/views/ContentSelectorView',[
	'core/View',
	// 'text!features/Content/views/ContentSelectorView.mustache',
	'lib/i18n!front',
], function(
	View,
	// tplContentSelector,
	i18n
) {
	var ContentSelectorView = function() {
		// this.template = tplContentSelector;
		// this.uid = Math.random().toString(32).substring(2);
		// View.call(this);
	};

	ContentSelectorView.prototype = Object.create(View.prototype);

	Object.assign(ContentSelectorView.prototype, {
		// addListeners: function () {
		// 	this.addElementListener(this.getButtonId(), 'click', this.onClickButton.bind(this));
		// },
		// getButtonId: function () {
		// 	return 'content-selector-button-' + this.uid;
		// },
		// getFieldId: function () {
		// 	return 'content-selector-field-' + this.uid;
		// },
		// getForcedTemplateParams: function () {
		// 	return {
		// 		buttonId: this.getButtonId(),
		// 		buttonLabel: i18n.__('chat.content_selection_button_label'),
		// 		status: i18n.__('chat.content_selection_status_no_content'),
		// 		fieldId: this.getFieldId()
		// 	};
		// },
		// getValue: function () {
		// 	return this.getElement().querySelector('#' + this.getFieldId()).value;
		// },
		// onClickButton: function () {
		// 	console.log('open popup');
		// }
	});

	return ContentSelectorView;
});
define('features/Content/commands/MassMessageSetContentAsAttachmentService',[
	'config/chat',
	'core/Command',
	'features/Content/views/ContentSelectorView',
	'features/CreatorMessages/MassMessage/events/MassMessageEvent',
	'lib/i18n!front',
	'libs/EventEmitter'
], function(
	Config,
	Command,
	ContentSelectorView,
	MassMessageEvent,
	i18n,
	EventEmitter
) {
	var SetContentAsAttachmentServiceCommand = function(context, commandMap, mediatorMap) {
		Command.call(this, ...arguments);
	};

	SetContentAsAttachmentServiceCommand.prototype = Object.create(Command.prototype);

	Object.assign(SetContentAsAttachmentServiceCommand.prototype, {
		execute: function () {
			EventEmitter.emit(MassMessageEvent.ADD_CONTENT_SERVICE, {
				type: 'content',
				systemName: 'content-' + Math.random().toString(32).substring(2),
				iconId: 'scc-safe-icon',
				label: i18n.__('chat.content'),
				// field: '<div id="chat-mass-message-content">Content</div>',
				view: new ContentSelectorView()
			});
		}
	});

	return SetContentAsAttachmentServiceCommand;
});
define('features/Content/commands/AutoMessageSetContentAsAttachmentService',[
	'config/chat',
	'core/Command',
	'features/Content/views/ContentSelectorView',
	'features/CreatorMessages/AutoMessage/events/AutoMessageEvent',
	'lib/i18n!front',
	'libs/EventEmitter'
], function(
	Config,
	Command,
	ContentSelectorView,
	AutoMessageEvent,
	i18n,
	EventEmitter
) {
	var SetContentAsAttachmentServiceCommand = function(context, commandMap, mediatorMap) {
		Command.call(this, ...arguments);
	};

	SetContentAsAttachmentServiceCommand.prototype = Object.create(Command.prototype);

	Object.assign(SetContentAsAttachmentServiceCommand.prototype, {
		execute: function () {
			EventEmitter.emit(AutoMessageEvent.ADD_CONTENT_SERVICE, {
				type: 'content',
				systemName: 'content-' + Math.random().toString(32).substring(2),
				iconId: 'scc-safe-icon',
				label: i18n.__('chat.content'),
				// field: '<div id="chat-mass-message-content">Content</div>',
				view: new ContentSelectorView()
			});
		}
	});

	return SetContentAsAttachmentServiceCommand;
});
;
define("features/Content/events/ContentEvent", function(){});

define('features/Content/ContentMapper',[
	'features/CreatorMessages/MassMessage/events/MassMessageEvent',
	'features/CreatorMessages/AutoMessage/events/AutoMessageEvent',
	'features/Content/commands/MassMessageSetContentAsAttachmentService',
	'features/Content/commands/AutoMessageSetContentAsAttachmentService',
	'features/Content/events/ContentEvent'
], function(
	MassMessageEvent,
	AutoMessageEvent,
	MassMessageSetContentAsAttachmentServiceCommand,
	AutoMessageSetContentAsAttachmentServiceCommand,
	ContentEvent
) {
	return function(context) {
		//context.commandMap.mapEvent(MassMessageEvent.READY, MassMessageSetContentAsAttachmentServiceCommand);
		//context.commandMap.mapEvent(AutoMessageEvent.READY, AutoMessageSetContentAsAttachmentServiceCommand);
	};
});
define('features/Draft/commands/CreateStore',[
	'core/Command',
], function(
	Command
) {
	var SaveDraft = function(context) {
		Command.call(this, context);
	};

	SaveDraft.prototype = Object.create(Command.prototype);

	Object.assign(SaveDraft.prototype, {
		execute: function () {
			var bIDB = storage.indexedDb && storage.indexedDb.getDbIsSupported();
			if (bIDB) {
				var sDbStoreName = 'draft',
					fnInitStore = function() {
						var aDbStoreIndex = [
							{index: 'r', unique: true},
							{index: 'm', unique: false},
							{index: 't', unique: false}
						];

						storage.indexedDb.getStoreExist({
							store_name: sDbStoreName,
							store_index: aDbStoreIndex,
							callback_store_no_exist: function() {
								storage.indexedDb.storeCreate({
									store_name: sDbStoreName,
									store_index: aDbStoreIndex,
									index_auto_increment: false
								});
							}
						});
					};

				storage.indexedDb.manageTempStackAdd(fnInitStore);
			}
		}
	});

	return SaveDraft;
});
define('features/Draft/commands/DeleteDraft',[
	'core/Command',
], function(
	Command,
) {
	var DeleteDraft = function(context) {
		Command.call(this, context);
		this.storeName = 'draft';
	};

	DeleteDraft.prototype = Object.create(Command.prototype);

	Object.assign(DeleteDraft.prototype, {
		execute: function (idRecipient) {
			var bIDB = storage.indexedDb && storage.indexedDb.getDbIsSupported();
			if (bIDB) {
				var self = this;
				storage.indexedDb.manageTempStackAdd(function() {
					storage.indexedDb.remove(idRecipient, self.storeName);
				}, self.storeName);
			}

		}
	});

	return DeleteDraft;
});
define('features/Draft/commands/GetDraft',[
	'libs/EventEmitter',
	'core/Command'
], function(
	EventEmitter,
	Command,
) {
	var SaveDraft = function(context) {
		Command.call(this, context);
		this.storeName = 'draft';
	};

	SaveDraft.prototype = Object.create(Command.prototype);

	Object.assign(SaveDraft.prototype, {
		execute: function (idRecipient, selector) {
			var bIDB = storage.indexedDb && storage.indexedDb.getDbIsSupported();
			if (bIDB) {
				var self = this;
				storage.indexedDb.manageTempStackAdd(function() {
					storage.indexedDb.get(idRecipient, self.storeName).then(function(result) {
						if (!!result) {
							document.querySelector(selector).innerText = result.m;
						}
					});
				}, self.storeName);
			}

		}
	});

	return SaveDraft;
});
define('features/Draft/commands/SaveDraft',[
	'core/Command',
], function(
	Command
) {
	var SaveDraft = function(context) {
		Command.call(this, context);
		this.storeName = 'draft';
	};

	SaveDraft.prototype = Object.create(Command.prototype);

	Object.assign(SaveDraft.prototype, {
		execute: function (idRecipient, message) {
			var bIDB = storage.indexedDb && storage.indexedDb.getDbIsSupported();
			if (bIDB) {
				var self = this;
				storage.indexedDb.manageTempStackAdd(function() {
					var messageData = {
						r: idRecipient,
						m: message,
						t: Date.now()
					};
					storage.indexedDb.get(idRecipient, self.storeName).then(function(result) {
						if (!result) {
							storage.indexedDb.set(messageData, self.storeName);
						}
						else {
							storage.indexedDb.update(messageData, idRecipient, self.storeName);
						}
					});
				}, self.storeName);
			}

		}
	});

	return SaveDraft;
});
define('features/Draft/events/DraftEvent',[], function () {
	var DraftEvent = Object.create(null);

	Object.defineProperties(DraftEvent, {
		CREATE_STORE: {value: 'create_store.draft', writable: false},
		DELETE: {value: 'delete.draft', writable: false},
		GET: {value: 'get.draft', writable: false},
		SAVE: {value: 'save.draft', writable: false}
	});

	return DraftEvent;
});
define('features/Draft/DraftMapper',[
	'features/Draft/commands/CreateStore',
	'features/Draft/commands/DeleteDraft',
	'features/Draft/commands/GetDraft',
	'features/Draft/commands/SaveDraft',
	'features/Draft/events/DraftEvent',
], function(
	CreateStoreCommand,
	DeleteDraftCommand,
	GetDraftCommand,
	SaveDraftCommand,
	DraftEvent
) {
	return function(context) {
		context.commandMap.mapEvent(DraftEvent.CREATE_STORE, CreateStoreCommand);
		context.commandMap.mapEvent(DraftEvent.DELETE, DeleteDraftCommand);
		context.commandMap.mapEvent(DraftEvent.GET, GetDraftCommand);
		context.commandMap.mapEvent(DraftEvent.SAVE, SaveDraftCommand);
	};
});
define('core/Model',[
	'lib/storage'
], function (
	Storage
) {
	var STORAGE_NAMESPACE = 'chat';

	function setImmutableProperty(instance, propertyName, defaultValue) {
		if (typeof propertyName !== 'string' || !propertyName.length) {
			throw new Error(`The propertyName must be a non-empty string, given: ${propertyName}`);
		}

		Object.defineProperty(instance, propertyName, {value: instance[propertyName] || defaultValue, writable: false});
	}

	/**
	 * Base class for models.
	 * @constructor
	 */
	var Model = function () {
		if (!this.storageKey) {
			throw new Error('The storageKey property must be set before using this constructor');
		}

		setImmutableProperty(this, 'storageKey');

		this.defaultData = [];

		if (this.initialData && this.getAll().length === 0) {
			this.setAll(this.initialData);
		}
	};

	Object.assign(Model.prototype, {
		/**
		 * Get the first entry.
		 * @returns {*|undefined}
		 */
		first: function () {
			return this.defaultData.length > 0 ? this.defaultData[0] : undefined;
		},
		/**
		 * Get an entry by its index.
		 * @return {*}
		 */
		get: function (index) {
			if (typeof index === 'undefined') {
				return;
			}

			if (typeof index !== 'number') {
				throw new TypeError('index must be a number');
			}

			var entries = this.getAll();
			return entries[index];
		},
		/**
		 * Get all entries.
		 * @returns {array}
		 */
		getAll: function () {
			return this.defaultData;
		},
		/**
		 * Get all entries in the data store.
		 * @returns {array}
		 */
		getAllFromStorage: function () {
			var existent = Storage.get(this.storageKey, STORAGE_NAMESPACE);

			if (!existent) {
				existent = {d: this.defaultData, t: Date.now()};

				Storage.set(this.storageKey, existent, STORAGE_NAMESPACE);
			}

			return existent.d;
		},
		/**
		 * Get the last entry.
		 * @returns {*|undefined}
		 */
		last: function () {
			return this.defaultData.length > 0 ? this.defaultData[this.defaultData.length - 1] : undefined;
		},
		/**
		 * Set an entry in the data store.
		 * @param {object} data - Object to insert
		 * @param {number=} index - Index to override
		 */
		set: function (data, index) {
			if (!this.validate(data)) {
				wglog.debug('Model::set() invalid data', data);
                throw new Error('Invalid data');
			}

			var set = this.getAll();

			if (typeof index === 'number') {
				set[index] = data;
			} else {
				set.push(data);
			}

			//Storage.set(this.storageKey, {d: set, t: Date.now()}, STORAGE_NAMESPACE);
		},
		/**
		 * Set multiple entries in the data store.
		 * @param {object[]} data - An array of object to insert
		 */
		setAll: function (data) {
			if (!(data instanceof Array)) {
				throw new TypeError('data must be an array');
			}

			for (var index in data) {
				this.set(data[index]);
			}
		},
		/**
		 * Unset an entry in the data store.
		 * @returns {object}
		 */
		unset: function (index) {
			if (typeof index === 'undefined') {
				return;
			}

			if (typeof index !== 'number') {
				throw new TypeError('index must be a number');
			}

			var set = this.getAll();

			if (!set[index]) {
				return;
			}

			set.splice(index, 1);

			Storage.set(this.storageKey, {d: set, t: Date.now()}, STORAGE_NAMESPACE);
		},
		/**
		 * Unset all entries in the data store.
		 */
		unsetAll: function () {
			this.defaultData = [];
			Storage.set(this.storageKey, {d: this.defaultData, t: Date.now()}, STORAGE_NAMESPACE);
		},
		/**
		 * Validate an object to insert in the data store.
		 * @param {object} data - Object to validate
		 * @return {boolean}
		 */
		validate: function (data) {
			throw new Error('This method must be overridden.');
		},
		/**
		 * Validate a date formatted as string.
		 * @param {String} date - Date
		 * @return {boolean}
		 */
		validateDateString: function (date) {
			return typeof date === 'string' && !Number.isNaN(Date.parse(date));
		}
	});

	return Model;
});
define('features/FanInfo/models/FanInfo',[
	'core/Model'
], function (
	Model
) {
	/**
	 * @extends Model
	 * @constructor
	 */
	var FanInfo = function () {
		this.storageKey = 'fan-info';
		Model.call(this);
	};

	FanInfo.prototype = Object.create(Model.prototype);

	Object.assign(FanInfo.prototype, {
		findByName: function (name) {
			var entries = this.getAll(),
				found;

			for (var entry of entries) {
				if (entry.name === name) {
					found = entry;
					break;
				}
			}

			return found;
		},
		save: function (entry) {
			var entries = this.getAll(),
				indexFound;

			for (var index in entries) {
				if (entry.name === entries[index].name) {
					indexFound = +index;
					break;
				}
			}

			this.set(entry, indexFound);
		},
		validate: function (data) {
			if (!data.name || typeof data.name !== "string") {
				return false;
			}

			if (!data.count || typeof data.count !== "number") {
				return false;
			}

			return true;
		}
	});

	return FanInfo;
});
define('features/FanInfo/commands/DeleteAllFanInfoData',[
	'core/Command',
	'features/FanInfo/models/FanInfo'
], function(
	Command,
	FanInfoModel
) {
	var DeleteAllFanInfo = function(context) {
		Command.call(this, context);
	};

	DeleteAllFanInfo.prototype = Object.create(Command.prototype);

	Object.assign(DeleteAllFanInfo.prototype, {
		execute: function () {
			const fanInfo = new FanInfoModel();
			fanInfo.unsetAll();
		}
	});

	return DeleteAllFanInfo;
});

define('text!features/FanInfo/views/SendMessageModal.mustache',[],function () { return '<form class="{{className}}{{#classes}} {{classes}}{{/classes}}"{{#attributes}} {{{attributes}}}{{/attributes}}>\n\t<div class="{{className}}__fields">\n\t\t<p style="text-align: center;">{{message}}</p>\n\t</div>\n\t<div class="{{className}}__errors"></div>\n\t<div class="{{className}}__actions"></div>\n</form>';});


define('text!ui/ActionButton/ActionButton.mustache',[],function () { return '<button type="button"{{#classes}} class="{{classes}}"{{/classes}}{{#attributes}} {{{attributes}}}{{/attributes}}>\n\t<span>{{{label}}}</span>\n</button>';});


define('text!ui/Processing/Processing.mustache',[],function () { return '<span class="{{classes}}"></span>';});

define('ui/Processing/Processing',[
	'core/Component',
	'text!ui/Processing/Processing.mustache',
	'lib/tools'
], function(
	Component,
	tplProcessing,
	tools
) {
	var DEFAULT_OPTIONS = {
			state: 'processing'
		},
		DEFAULT_STATES = {
			error: {icon: null, message: 'Error'},
			processing: {icon: {name: 'scc-message-loader-icon', spin: true, type: 'svg'}, message: null},
			success: {icon: null, message: 'Success'}
		};

	var BASE_CLASS_NAME = 'chat-ui-processing',
		ALIGN_CENTER = BASE_CLASS_NAME + '--align-center',
		HIDDEN = BASE_CLASS_NAME + '--hidden',
		ICON = BASE_CLASS_NAME + '__icon',
		MESSAGE = BASE_CLASS_NAME + '__message';

	/**
	 * @extends Component
	 * @constructor
	 * @param {object} states
	 * @param {object} options
	 * @param {string} options.state Default state to display
	 */
	var Processing = function(states, options) {
		this.template = tplProcessing;
		this.options = Object.assign({}, DEFAULT_OPTIONS, options);
		this.states = Object.assign({}, DEFAULT_STATES, states);
		Component.call(this);
		this.reset();
	};

	Processing.prototype = Object.create(Component.prototype);

	Object.assign(Processing.prototype, {
		_generateIcon: function (state) {
			var icon;

			if (state.icon.type === 'svg') {
				icon = this._generateSvgIcon(state);
			}

			return icon;
		},
		_generateMessage: function (message) {
			return tools.string_to_node(`<p class="${MESSAGE}">${message}</p>`);
		},
		_generateSvgIcon: function (state) {
			var classes = [ICON, 'chat-scc'];
			if (state.icon.spin) {
				classes.push('chat-scc--spin');
			}
			return tools.string_to_node(`<svg class="${classes.join(' ')}"><use xlink:href="#${state.icon.name}" /></svg>`);
		},
		_removeState: function () {
			if (this.currentState) {
				this.element.classList.remove(this.currentState);
			}

			var icon = this.element.querySelector('.' + ICON);
			if (icon) {
				icon.parentNode.removeChild(icon);
			}

			var message = this.element.querySelector('.' + MESSAGE);
			if (message) {
				message.parentNode.removeChild(message);
			}
		},
		_setState: function (stateName, message) {
			var _messageElement,
				state = this.states[stateName];

			if (state.icon) {
				var icon = this._generateIcon(state);
				this.element.append(icon);
			}

			if (message) {
				_messageElement = this._generateMessage(message);
			} else if (state.message) {
				_messageElement = this._generateMessage(state.message);
			}

			if (_messageElement) {
				this.element.append(_messageElement);
			}

			this.currentState = stateName;
			this.element.classList.add(this.currentState);
		},
		getForcedTemplateParams: function () {
			return {
				classes: `${BASE_CLASS_NAME} ${ALIGN_CENTER}`,
			};
		},
		hide: function () {
			this.element.classList.add(HIDDEN);
		},
		reset: function () {
			this.hide();
			this.selectState(this.options.state);
		},
		selectState: function (stateName, message) {
			if (this.states.hasOwnProperty(stateName) === false) {
				return;
			}

			this._removeState();
			this._setState(stateName, message);
		},
		show: function () {
			this.element.classList.remove(HIDDEN);
		}
	});

	return Processing;
});
define('ui/ActionButton/ActionButton',[
	'text!ui/ActionButton/ActionButton.mustache',
	'core/Component',
	'ui/Processing/Processing'
], function(
	tplActionButton,
	Component,
	Processing
) {
	const BASE_CLASS_NAME = 'chat-ui-action-button';

	const THEME_GRADIENT = 'gradient',
		THEME_RED = 'red',
		THEME_TRANSPARENT_GRAY = 'transparent-gray',
		THEME_TRANSPARENT_GREEN = 'transparent-green',
		THEME_TRANSPARENT_PINK = 'transparent-pink',
		THEME_WHITE = 'white';

	const DEFAULT_OPTIONS = {
		classes: "",
		attributes: {},
		mini: false,
		round: false,
		shadow: false,
		color: THEME_WHITE
	};

	const STATE_ACTIVE = 'active',
		STATES = [STATE_ACTIVE];

	const ActionButton = function(actionType, options) {
		if (!(!!actionType) || 'string' !== typeof actionType) {
			throw new TypeError('actionType is invalid');
		}

		this.actionType = actionType;
		this.options = Object.assign({}, DEFAULT_OPTIONS, options);
		this.template = tplActionButton;
		Component.call(this);
	};

	Object.defineProperties(ActionButton, {
		STATE_ACTIVE: {value: STATE_ACTIVE, writable: false},
		THEME_GRADIENT: {value: THEME_GRADIENT, writable: false},
		THEME_RED: {value: THEME_RED, writable: false},
		THEME_TRANSPARENT_GRAY: {value: THEME_TRANSPARENT_GRAY, writable: false},
		THEME_TRANSPARENT_GREEN: {value: THEME_TRANSPARENT_GREEN, writable: false},
		THEME_TRANSPARENT_PINK: {value: THEME_TRANSPARENT_PINK, writable: false},
		THEME_WHITE: {value: THEME_WHITE, writable: false}
	});

	ActionButton.prototype = Object.create(Component.prototype);

	Object.assign(ActionButton.prototype, {
		disable: function () {
			this.element.setAttribute('disabled', '');
			if (this.options.disabledLabel) {
				this.element.querySelector('span').innerText = this.options.disabledLabel;
			}
		},
		enable: function () {
			this.element.removeAttribute('disabled');
			if (this.options.disabledLabel) {
				this.element.querySelector('span').innerText = this.options.label;
			}
		},
		getForcedTemplateParams: function () {
			const classes = this.options.classes.split(' '),
				params = {};

			classes.push(BASE_CLASS_NAME);

			if (this.options.color) {
				classes.push(`${BASE_CLASS_NAME}--` + this.options.color);
			}
			if (this.options.mini) {
				classes.push(`${BASE_CLASS_NAME}--mini`);
			}
			if (this.options.round) {
				classes.push(`${BASE_CLASS_NAME}--round`);
			}
			if (this.options.shadow) {
				classes.push(`${BASE_CLASS_NAME}--shadow`);
			}

			params.classes = classes.join(' ');

			return params;
		},
		processing: function (enabled) {
			if (typeof enabled === 'boolean' && !enabled && this._processing) {
				this._processing.hide();
			} else {
				this._processing = new Processing();
				this.element.append(this._processing.getElement());
				this._processing.show();
			}
		},
		setState: function (state) {
			if (!state) {
				this.element.classList.remove(...STATES);
				return;
			}

			if (STATES.indexOf(state) < 0) {
				return;
			}

			this.element.classList.add(state);
		}
	});

	return ActionButton;
});

define('text!ui/ButtonGroup/ButtonGroup.mustache',[],function () { return '<div class="chat-ui-button-group{{#classes}} {{{classes}}}{{/classes}}"{{#attributes}} {{{attributes}}}{{/attributes}}></div>';});

define('ui/ButtonGroup/ButtonGroup',[
    'config/chat',
    'core/Component',
    'text!ui/ButtonGroup/ButtonGroup.mustache'
], function(
    Config,
    Component,
    tplButtonGroup
) {
    var BASE_CLASS_NAME = 'chat-ui-media-grid';
    /**
     * @extends Component
     * @constructor
     */
    var ButtonGroup = function(buttons, options) {
        this.template = tplButtonGroup;
        this.buttons = buttons;
        this.options = Object.assign({}, {
            attributes: [],
            classes: ""
        }, options);
        Component.call(this);
    };

    ButtonGroup.prototype = Object.create(Component.prototype);

    Object.assign(ButtonGroup.prototype, {
        addButtonsToElement: function() {
            for (var i = 0; i < this.buttons.length; i++) {
                this.element.appendChild(this.buttons[i]);
            }
        },
        createElement: function() {
            Component.prototype.createElement.call(this);
            this.addButtonsToElement();
        }
    });

    return ButtonGroup;
});

define('text!ui/Form/Form.mustache',[],function () { return '<div class="{{className}}">\n\t{{#title}}\n\t\t<h2 class="{{className}}__title">{{title}}</h2>\n\t{{/title}}\n\t<form class="{{className}}__form{{#classes}} {{classes}}{{/classes}}"{{#attributes}} {{{attributes}}}{{/attributes}}>\n\t\t<div class="{{className}}__errors"></div>\n\t\t<div class="{{className}}__fields"></div>\n\t\t<div class="{{actionsClasses}}"></div>\n\t</form>\n</div>\n';});

define('ui/FormField/Field',[
	'core/Component',
	'lib/tools'
], function(
	Component,
	Tools
) {
	/**
	 * Base class for form fields.
	 *
	 * @abstract
	 * @constructor
	 */
	var Field = function() {
		Component.call(this);
	};


	Field.prototype = Object.create(Component.prototype);

	Object.assign(Field.prototype, {
		/**
		 * Set the field on disabled state.
		 *
		 * @return {void}
		 */
		disable: function () {
			var field = this.getField();
			field.setAttribute('disabled', '');
			field.classList.add('disabled');
		},
		/**
		 * Set the field on enabled state.
		 *
		 * @return {void}
		 */
		enable: function () {
			var field = this.getField();
			field.removeAttribute('disabled');
			field.classList.remove('disabled');
		},
		/**
		 * Returns the field element (input, select, textarea).
		 *
		 * @return {HTMLElement}
		 */
		getField: function () {
			throw new Error('This method must be overridden.');
		},
		/**
		 * Returns the field value.
		 *
		 * @return {void}
		 */
		getValue: function () {
			throw new Error('This method must be overridden.');
		},
		/**
		 * Prepares and normalizes field options.
		 *
		 * @important Currently, this method moves certain top-level options (such as `placeholder`)
		 * into the `attributes` object. In the future, these options should be declared
		 * directly under `options.attributes`.
		 *
		 * @param {Object} [options={}] - The specific options provided.
		 * @param {Object} [defaultOptions={}] - The default options.
		 * @returns {Object} A consolidated configuration object.
		 */
		prepareOptions: function (options, defaultOptions) {
			var mergedOptions = Tools.deepMerge({attributes: {}}, defaultOptions || {});
			mergedOptions = Tools.deepMerge(mergedOptions, options || {});

			if (!mergedOptions.attributes.placeholder && typeof mergedOptions.placeholder === 'string') {
				mergedOptions.attributes.placeholder = mergedOptions.placeholder;
				delete mergedOptions.placeholder;
			}

			return mergedOptions;
		},
		/**
		 * Remove the error state of the field and the error message.
		 *
		 * @return {void}
		 */
		removeError: function () {
			throw new Error('This method must be overridden.');
		},
		/**
		 * Set the error state of the field and the error message.
		 *
		 * @param {string} message The error message to display.
		 *
		 * @return {void}
		 */
		setError: function (message) {
			throw new Error('This method must be overridden.');
		},
		/**
		 * Set the field value.
		 *
		 * @param {*} value The field value.
		 *
		 * @return {void}
		 */
		setValue: function (value) {
			throw new Error('This method must be overridden.');
		}
	});

	return Field;
});
define('ui/Form/Form',[
	'core/Component',
	'lib/i18n!front',
	'lib/tools',
	'ui/ActionButton/ActionButton',
	'ui/ButtonGroup/ButtonGroup',
	'text!ui/Form/Form.mustache',
	'ui/FormField/Field'
], function(
	Component,
	i18n,
	tools,
	ActionButton,
	ButtonGroup,
	tplForm,
	Field
) {
	var BASE_CLASS_NAME = 'chat-ui-form',
		ACTIONS_SELECTOR = `.${BASE_CLASS_NAME}__actions`,
		ERRORS_SELECTOR = `.${BASE_CLASS_NAME}__errors`,
		FIELDS_SELECTOR = `.${BASE_CLASS_NAME}__fields`;

	var DEFAULT_OPTIONS = {
		classes: '',
		attributes: {},
		actionsCenter: true
	};

	/**
	 * Base class for forms.
	 *
	 * @extends Component
	 *
	 * @param {object} options
	 * @param {boolean} options.actionsCenter Align actions at center.
	 * @param {object} options.attributes An object describing attributes to set on the form root element.
	 * @param {string} options.classes A list of classes to append to the form class attribute.
	 * @param {string} options.title The form title.
	 *
	 * @constructor
	 */
	var Form = function(options) {
		this.options = Object.assign({}, DEFAULT_OPTIONS, options);
		this.template = this.template || tplForm;
		this.actions = [];
		this.fields = [];
		Component.call(this);
	};

	Form.prototype = Object.create(Component.prototype);

	Object.assign(Form.prototype, {
		/**
		 * Append an action button to the form.
		 *
		 * @param {ActionButton} action
		 */
		appendActionButton: function (action) {
			if (!action || !(action instanceof ActionButton)) {
				throw new TypeError('action must implement ActionButton');
			}

			this.actions.push(action);
			this.element.querySelector(ACTIONS_SELECTOR).appendChild(action.getElement());
		},
		/**
		 * Append an action button group to the form.
		 *
		 * @param {ButtonGroup} group
		 */
		appendActionButtonGroup: function (group) {
			if (!group || !(group instanceof ButtonGroup)) {
				throw new TypeError('action must implement ButtonGroup');
			}

			this.element.querySelector(ACTIONS_SELECTOR).appendChild(group.getElement());
		},
		/**
		 * Append a field to the form.
		 *
		 * @param {Field} field
		 */
		appendField: function (field) {
			if (!field || !(field instanceof Field)) {
				throw new TypeError('field must implement Field');
			}

			this.fields.push(field);
			this.element.querySelector(FIELDS_SELECTOR).appendChild(field.getElement());
		},
		createElement: function () {
			Component.prototype.createElement.call(this);
			this.formElement = this.element.querySelector('form');
		},
		/**
		 * Disable all fields and actions in the form.
		 */
		disable: function () {
			this.fields.forEach(function (field) {
				field.disable();
			});
			this.actions.forEach(function (action) {
				action.disable();
			});
		},
		/**
		 * Enable all fields and actions in the form.
		 */
		enable: function () {
			this.fields.forEach(function (field) {
				field.enable();
			});
			this.actions.forEach(function (action) {
				action.enable();
			});
		},
		/**
		 * Get the actions' parent element.
		 *
		 * @return {HTMLElement}
		 */
		getActionsElement: function () {
			return this.element.querySelector(ACTIONS_SELECTOR)
		},
		getForcedTemplateParams: function () {
			var params = {
				actionsClasses: `${BASE_CLASS_NAME}__actions`,
				className: BASE_CLASS_NAME,
				title: this.options.title || ''
			};

			if (this.options && this.options.actionsCenter) {
				params.actionsClasses += ` ${BASE_CLASS_NAME}__actions--center`;
			}

			return params;
		},
		getFormElement: function () {
			return this.formElement;
		},
		/**
		 * Hide the form error message.
		 */
		hideError: function () {
			this.element.querySelectorAll(`${ERRORS_SELECTOR} p`).forEach(function (element) {
				element.parentNode.removeChild(element);
			});
		},
		/**
		 * Show the form error message.
		 *
		 * @param {string} message Message to display into the error.
		 */
		showError: function (message) {
			this.element.querySelector(ERRORS_SELECTOR).innerHTML += `<p>${message}</p>`;
		},
	});

	return Form;
});
define('ui/Modal/Modal',[
	'config/chat',
	'log_and_tooltip'
], function(
	Config,
	LogAndTooltip
) {
	var BASE_CLASS_NAME = 'chat-ui-modal';

	var DEFAULT_OPTIONS = {
		autoOpen: true,
		closable: true,
		dontCloseExistingModal: false
	};

	/**
	 * @constructor
	 */
	var Modal = function(element, options) {
		this.element = element;
		this.modal = null;
		this.options = Object.assign({}, DEFAULT_OPTIONS, options || {});

		if (this.options.autoOpen) {
			this.open();
		}
	};

	Object.defineProperty(Modal, 'BASE_CLASS_NAME', {value: BASE_CLASS_NAME, writable: false});

	Object.assign(Modal.prototype, {
		open: function () {
			this.modal = LogAndTooltip.modal(this.element, this.options, this.options.dontCloseExistingModal);
			this.modal.container.closest('.x-body').addClass(Modal.BASE_CLASS_NAME);
		},
		close: function () {
			LogAndTooltip.overlay_close();
		},
		hide: function () {
			this.modal.hide();
		},
		show: function () {
			this.modal.show();
		},
		getElement: function () {
			return this.modal.container;
		}
	});

	return Modal;
});
define('features/FanInfo/views/SendMessageModalView',[
	'config/chat',
	'text!features/FanInfo/views/SendMessageModal.mustache',
	'lib/i18n!front',
	'lib/tools',
	'ui/ActionButton/ActionButton',
	'ui/Form/Form',
	'ui/Modal/Modal'
], function(
	Config,
	tplSendMessageModal,
	i18n,
	tools,
	ActionButton,
	Form,
	Modal
) {
	var CHAT_SEND_BUTTON_SELECTOR = '#chat-send-btn';

	var SendMessageModalView = function(username) {
		this.username = username;
		this.modal = null;
		this.template = tplSendMessageModal;
		Form.call(this);
		this.initModal();
	};

	SendMessageModalView.prototype = Object.create(Form.prototype);

	Object.assign(SendMessageModalView.prototype, {
		addListeners: function () {
			this.addElementListener(this.cancel.getElement(), 'click', this.onClickCancel, 'send-message-modal', this);
			this.addElementListener(this.confirm.getElement(), 'click', this.onClickConfirm, 'send-message-modal', this);
		},
		createElement: function () {
			Form.prototype.createElement.call(this);

			var p = this.element.querySelector('p');
			p.innerHTML = p.innerHTML.replace(this.username, '<br>' + this.username);



			this.cancel = new ActionButton('cancel', {
				label: i18n.__('misc.cancel'),
			});
			this.appendActionButton(this.cancel);
		},
		getForcedTemplateParams: function () {
			var params = Form.prototype.getForcedTemplateParams();
			params.message = i18n.__('chat.fan_support_info', {'%username%': this.username});
			return params;
		},
		initModal: function () {
			this.modal = new Modal(this.element);
		},
		onClickCancel: function (event) {
			this.modal.close();
		},
		onClickConfirm: function (event) {
			this.modal.close();
			var sendButton = document.querySelector(CHAT_SEND_BUTTON_SELECTOR);
			if (!sendButton) {
				wglog.error('SendMessageModalView::onClickConfirm', 'Unable to send message');
			}
			sendButton.click();
		}
	});

	return SendMessageModalView;
});
define('features/FanInfo/commands/OpenSendMessageModal',[
	'core/Command',
	'features/FanInfo/views/SendMessageModalView'
], function(
	Command,
	SendMessageModalView
) {
	var OpenSendMessageModal = function(context) {
		Command.call(this, context);
	};

	OpenSendMessageModal.prototype = Object.create(Command.prototype);

	Object.assign(OpenSendMessageModal.prototype, {
		execute: function (friendName) {
			new SendMessageModalView(friendName);
		}
	});

	return OpenSendMessageModal;
});
define('features/FanInfo/events/FanInfoEvent',[], function () {
	var FanInfoEvent = Object.create(null);

	Object.defineProperties(FanInfoEvent, {
		OPEN_SEND_MESSAGE_MODAL: {value: 'open_send_message_modal.fan_info', writable: false}
	});

	return FanInfoEvent;
});
define('features/FanInfo/FanInfoMapper',[
	'config/chat',
	'core/ContextEvent',
	'features/FanInfo/commands/DeleteAllFanInfoData',
	'features/FanInfo/commands/OpenSendMessageModal',
	'features/FanInfo/events/FanInfoEvent'
], function(
	Config,
	ContextEvent,
	DeleteAllFanInfoDataCommand,
	OpenSendMessageModalCommand,
	FanInfoEvent
) {
	return function(context) {
		if (!Config.login_info.is_fan) {
			return;
		}

		context.commandMap.mapEvent(ContextEvent.STARTUP, DeleteAllFanInfoDataCommand);

		context.commandMap.mapEvent(FanInfoEvent.OPEN_SEND_MESSAGE_MODAL, OpenSendMessageModalCommand);
	};
});

define('text!lib/helpers/overlay/slider/track.mustache',[],function () { return '<div class="{{classes.carousel}}">\n\t<div class="{{classes.viewport}}">\n\t\t<div class="{{classes.track}}"></div>\n\t</div>\n\t<div class="{{classes.nav}}">\n\t\t<div class="{{classes.navPrev}}"><span class="icon-f icf-slider-left"></span></div>\n\t\t<div class="{{classes.navNext}}"><span class="icon-f icf-slider-right"></span></div>\n\t</div>\n</div>\n';});


define('text!lib/helpers/overlay/slider/slide.mustache',[],function () { return '<div class="{{classes}}">{{{content}}}</div>';});


define('text!lib/helpers/overlay/slider/slide_audio.mustache',[],function () { return '<audio controls preload class="{{contentClasses}}" crossorigin="anonymous">\n    <source src="{{src}}" type="{{mimeType}}"/>\n</audio>';});


define('text!lib/helpers/overlay/slider/slide_image.mustache',[],function () { return '<img src="{{src}}" alt="{{alt}}" class="{{contentClasses}}">';});


define('text!lib/helpers/overlay/slider/slide_video.mustache',[],function () { return '<video controls preload class="{{contentClasses}}" crossorigin="anonymous">\n\t{{#sources}}\n\t<source src="{{src}}" type="{{mimeType}}" label="{{resolution}}"/>\n\t{{/sources}}\n\t{{^sources}}\n\t<source src="{{src}}" type="{{mimeType}}"/>\n\t{{/sources}}\n</video>';});

define('lib/helpers/overlay/slider',[
	'lib/helpers/overlay',
	'text!lib/helpers/overlay/slider/track.mustache',
	'text!lib/helpers/overlay/slider/slide.mustache',
	'text!lib/helpers/overlay/slider/slide_audio.mustache',
	'text!lib/helpers/overlay/slider/slide_image.mustache',
	'text!lib/helpers/overlay/slider/slide_video.mustache',
	'mustache'
], function (
	overlay,
	tpl_track,
	tpl_slide,
	tpl_slide_audio,
	tpl_slide_image,
	tpl_slide_video,
	Mustache
) {
	var EVENT_NAMESPACES = {
		slider: 'slider'
	};
	var OVERLAY_CLASSES = {
		body: 'x-body',
		close: 'x-close',
		footer: 'x-footer',
		header: 'x-header',
	};
	var SLIDE_CLASSES = {
		slide: 'x-slide',
		content: 'x-slide-content',
		loader: 'x-slide-loader',
		audioContent: 'x-slide-audio',
		imageContent: 'x-slide-image',
		videoContent: 'x-slide-video',
	}
	var SLIDE_TYPES = {
		audio: 'audio',
		image: 'image',
		video: 'video'
	}
	var SLIDER_CLASSES = {
		carousel: 'x-carousel',
		nav: 'x-nav',
		navBtnHidden: 'x-nav-hidden',
		navNext: 'x-nav-next',
		navPrev: 'x-nav-prev',
		slider: 'x-slider',
		track: 'x-track',
		viewport: 'x-viewport',
	};
	var THUMBS_CLASSES = {
		activeThumb: 'active',
		thumb: 'x-thumb',
		thumbs: 'x-thumbs',
		thumbsTrack: 'x-thumbs-track',
		thumbsTrackCentered: 'centered',
	};
	var VIDEO_RESOLUTIONS = {
		'4k': {width: 3840, height: 2160},
		'1080p': {width: 1920, height: 1080},
		'hd': {width: 1280, height: 720},
		'vga': {width: 853, height: 480},
		'web': {width: 423, height: 243},
		'upload': {width: 0, height: 0},
	};
	var DEFAULT_OPTIONS = {
		closable: true,
		close_action: 'close',
		close_on_escape: true,
		close_on_click_outside: true,
		draggingThreshold: .2,
		draggingEasing: 'ease-out',
		loop: false,
		popbody_click_dontclose: false,
		selected: 0,
		thumbs: true
	};

	/**
	 * Slider
	 *
	 * @param container {HTMLElement}
	 * @param content {HTMLElement|HTMLElement[]}
	 * @param options {Object=} Overlay options + properties below:
	 * @param options.closable {boolean} Default: true.
	 * @param options.close_action {string} Default: 'close'.
	 * @param options.close_on_escape {boolean} Default: true.
	 * @param options.close_on_click_outside {boolean} Default: true.
	 * @param options.draggingThreshold {number} Float between 0 and 1. Default: 0.2.
	 * @param options.draggingEasing {string} Default: 'ease-out'.
	 * @param options.loop {boolean} Default: false.
	 * @param options.popbody_click_dontclose {boolean} Default: false.
	 * @param options.selected {number} Selected index to display on open. Default: 0.
	 * @param options.thumbs {boolean} Default: true.
	 * @constructor
	 */
	var Slider = function (container, content, options) {
		this.options = Object.assign({}, DEFAULT_OPTIONS, options || {});
		this.isDragging = false;
		this.pointerOriginX = null;
		this.slideWidth = 0;
		this.slides = [];
		this.thumbs = null;
		this.track = null;
		this.tplTrack = tpl_track;

		this.closeExisting();

		overlay.call(this, $(container), this.options.closable, this.options.close_action);
		this.replaceCloseButton();
		this.setClosable(this.options.closable, this.options.close_on_escape, this.options.close_on_click_outside, this.options.popbody_click_dontclose);
		this.setContent(content);
		if (!this.slides.length) {
			wglog.debug('Slider::constructor no slides', 'No slides to display');
			this.close();
			return;
		}
		this.alterNode();
		this.goTo(this.options.selected);
		this.addListeners();
	};
	Slider.prototype = Object.create(overlay.prototype);
	Object.assign(Slider.prototype, {
		addListeners: function () {
			$('body').on(`keyup.${EVENT_NAMESPACES.slider}`, this.onKeyUpDirection.bind(this));
			$(window).on(`resize.${EVENT_NAMESPACES.slider}`, this.onResize.bind(this));

			if (this.slides.length === 1) {
				return this;
			}

			this.node.find(`.${SLIDER_CLASSES.navNext}`).on(`click.${EVENT_NAMESPACES.slider}`, this.onClickNavNext.bind(this));
			this.node.find(`.${SLIDER_CLASSES.navPrev}`).on(`click.${EVENT_NAMESPACES.slider}`, this.onClickNavPrev.bind(this));

			this.track.on(`mousedown.${EVENT_NAMESPACES.slider}`, this.onPointerDown.bind(this));
			this.track.on(`mousemove.${EVENT_NAMESPACES.slider}`, this.onPointerMove.bind(this));
			this.track.on(`mouseup.${EVENT_NAMESPACES.slider}`, this.onPointerUp.bind(this));

			this.track.on(`touchstart.${EVENT_NAMESPACES.slider}`, this.onPointerDown.bind(this));
			this.track.on(`touchmove.${EVENT_NAMESPACES.slider}`, this.onPointerMove.bind(this));
			this.track.on(`touchend.${EVENT_NAMESPACES.slider}`, this.onPointerUp.bind(this));

			return this;
		},
		alterNode: function () {
			this.node.append(`<div class="${OVERLAY_CLASSES.header}"></div>`);
			this.node.find(`.${OVERLAY_CLASSES.header}`).append(this.node.find(`.${OVERLAY_CLASSES.close}`));
			this.node.append(this.node.find(`.${SLIDER_CLASSES.carousel}`));
			this.node.append(`<div class="${OVERLAY_CLASSES.footer}"></div>`);
			this.node.addClass(SLIDER_CLASSES.slider);
			this.node.find(`.${OVERLAY_CLASSES.body}`).remove();
			if (this.options.thumbs && this.slides.length > 1) {
				this.thumbs = new Thumbs(this);
			}
			return this;
		},
		close: function () {
			overlay.prototype.close.call(this);
			this.removeListeners();
			return this;
		},
		closeExisting: function () {
			$(`.${SLIDER_CLASSES.slider} .${OVERLAY_CLASSES.close}`).click();
		},
		createSlides: function (content) {
			if (!(content instanceof Array) && !(content instanceof HTMLElement)) {
				wglog.debug('Slider::createSlides bad content', 'Content must inherit from HTMLElement or an array of objects inheriting from HTMLElement');
				return;
			}

			if (content instanceof HTMLElement) {
				content = [content];
			}

			var slides = [];

			for (const index in content) {
				if (!(content[index] instanceof HTMLElement)) {
					wglog.debug('Slider::createSlides bad content', 'Content in array must inherit from HTMLElement, provided:', content[index]);
					return;
				}

				const slide = SlideFactory.create(content[index]);

				if (!slide) {
					continue;
				}

				if (slide.type === SLIDE_TYPES.video) {
					slides.unshift(slide);
				} else {
					slides.push(slide);
				}
			}

			return slides;
		},
		generateContent: function () {
			var content = $(Mustache.render(this.tplTrack, {
				classes: SLIDER_CLASSES
			}));

			this.track = content.find(`.${SLIDER_CLASSES.track}`);
			this.track.append(...this.getSlidesToShow());
			this.track[0].style.setProperty('--n', this.slides.length);
			if (this.options.draggingEasing !== DEFAULT_OPTIONS.draggingEasing) {
				this.track[0].style.setProperty('--e', this.options.draggingEasing);
			}

			return content;
		},
		getSlidesToShow: function () {
			var slides = []

			for (var slide of this.slides) {
				slides.push(slide.getElement());
			}

			return slides;
		},
		goTo: function (index) {
			if (typeof index !== 'number') {
				index = 0;
			}

			if (this.options.loop) {
				if (index < this.selected && index < 0) {
					index = this.slides.length - 1;
				}
				if (index > this.selected && index >= this.slides.length) {
					index = 0;
				}
			} else {
				if (index < this.selected && index < 0) {
					index = 0;
				}
				if (index > this.selected && index >= this.slides.length) {
					index = this.slides.length - 1;
				}
			}

			if (!this.options.loop || this.slides.length === 1) {
				this.node.find(`.${SLIDER_CLASSES.navPrev}`).toggleClass(SLIDER_CLASSES.navBtnHidden, index === 0);
				this.node.find(`.${SLIDER_CLASSES.navNext}`).toggleClass(SLIDER_CLASSES.navBtnHidden, index === this.slides.length - 1);
			}

			if (this.selected) {
				this.slides[this.selected].pause();
			}

			this.selected = index;
			this.track[0].style.setProperty('--i', this.selected);

			if (this.thumbs) {
				this.thumbs.select(index);
			}

			return this;
		},
		next: function () {
			this.goTo(this.selected + 1);
			return this;
		},
		onClickNavNext: function (event) {
			event.preventDefault();
			this.next();
		},
		onClickNavPrev: function (event) {
			event.preventDefault();
			this.prev();
		},
		onClickBody: function (event) {
			if (this.options.close_on_click_outside) {
				return overlay.prototype.onClickBody.call(this, event);
			}
		},
		onKeyUpDirection: function (event) {
			var prevented = event.originalEvent && event.originalEvent.defaultPrevented;

			if (!prevented && self.open && event.which === 37) {
				this.prev();
			} else if (!prevented && self.open && event.which === 39) {
				this.next();
			}
		},
		onPointerDown: function (event) {
			this.pointerOriginX = event.clientX;
			this.isDragging = true;
		},
		onPointerMove: function (event) {
			event.preventDefault();

			if (this.isDragging) {
				this.track[0].style.setProperty('--tx', `${Math.round(event.clientX - this.pointerOriginX)}px`);
			}
		},
		onPointerUp: function (event) {
			if(this.isDragging && typeof this.pointerOriginX === 'number') {
				var deltaX = event.clientX - this.pointerOriginX,
					deltaXSign = Math.sign(deltaX),
					triggerFactor = +(deltaXSign * deltaX / this.slideWidth).toFixed(2);

				if ((this.selected > 0 || deltaXSign < 0) && (this.selected < this.slides.length - 1 || deltaXSign > 0) && triggerFactor > this.options.draggingThreshold) {
					this.goTo(this.selected - deltaXSign);
					triggerFactor = 1 - triggerFactor;
				}

				this.track[0].style.setProperty('--tx', '0px');
				this.track[0].style.setProperty('--f', triggerFactor);

				this.isDragging = false;
				this.pointerOriginX = null;
			}
		},
		onResize: function () {
			this.resetSlideWidth();
		},
		prev: function () {
			this.goTo(this.selected - 1);
			return this;
		},
		replaceCloseButton: function () {
			this.node.find(`.${OVERLAY_CLASSES.close}`).html(`<span class="icon-f icf-slider-close"></span>`);
		},
		removeListeners: function () {
			this.node.find(`.${SLIDER_CLASSES.navNext}`).off(`.${EVENT_NAMESPACES.slider}`);
			this.node.find(`.${SLIDER_CLASSES.navPrev}`).off(`.${EVENT_NAMESPACES.slider}`);
			this.track.off(`.${EVENT_NAMESPACES.slider}`);
			$('body').off(`.${EVENT_NAMESPACES.slider}`);
			return this;
		},
		resetSlideWidth: function () {
			if (this.slides.length) {
				this.slideWidth = this.slides[0].element.offsetWidth;
			}

			return this;
		},
		setContent: function (content) {
			this.slides = this.createSlides(content);
			this.container.html(this.generateContent());
			return this;
		},
		show: function () {
			overlay.prototype.show.call(this);
			this.resetSlideWidth();
			return this;
		},
	});

	var Slide = function (meta) {
		this.alt = '';
		this.classes = SLIDE_CLASSES.slide;
		this.element = null;
		this.src = meta.src;
		this.thumb = meta.thumb;
		this.tplSlide = tpl_slide;
		this.type = meta.type;

		this.createElement();
	};
	Object.assign(Slide.prototype, {
		addListenersOnContent: function () {
			wglog.debug('Slide::addListenersOnContent method not overridden', 'You must override this method', this);
		},
		createElement: function () {
			var fakeParent = document.createElement('div');
			fakeParent.innerHTML = Mustache.render(this.tplSlide, {classes: this.classes, content: this.getLoaderContent() + this.getContent()});
			this.element = fakeParent.firstChild;
			this.addListenersOnContent();
		},
		getAlt: function () {
			return this.alt;
		},
		getContent: function () {
			if (!this.tplContent) {
				wglog.debug('Slide::getContent tplContent is empty', 'You must provide a template before to call the Slide constructor', this);
				return '';
			}
			return Mustache.render(this.tplContent, this);
		},
		getElement: function () {
			return this.element;
		},
		getLoaderContent: function () {
			return `<div class="${SLIDE_CLASSES.loader}"><svg class="chat-scc chat-scc--spin"><use xlink:href="#scc-message-loader-icon-2"/></svg></div>`;
		},
		getMediaElement: function () {
			if (!this.mediaSelector) {
				wglog.debug('Slide::addListenersOnContent mediaSelector undefined', 'You must define this slide mediaSelector property', this);
				return;
			}

			if (!this.mediaElement) {
				this.mediaElement = this.element.querySelector(this.mediaSelector);
			}

			return this.mediaElement;
		},
		getThumbSrc: function () {
			return this.thumb || this.src;
		},
		onLoad: function () {
			var loader = this.element.querySelector('.' + SLIDE_CLASSES.loader);

			if (loader) {
				loader.remove();
			}
		},
		pause: function () {
		}
	});

	var SlideFactory = {
		create: function (content, index) {
			const meta = this.getContentMeta(content, index);

			switch (meta.type) {
				case 'audio':
					return new AudioSlide(meta);
				case 'image':
					return new ImageSlide(meta);
				case 'video':
					return new VideoSlide(meta);
				default:
					wglog.debug('SlideFactory::create unknown content type', 'Provided: ', content);
			}
		},
		getContentMeta: function (content) {
			const meta = {
				type: '',
				src: content.src || content.href
			};

			if (meta.src.match(/(^data:audio\/)|(\.(mp3|wav|ogg|aac|mp4)(([?#]).*)?$)/i)) {
				meta.thumb = '';
				meta.type = SLIDE_TYPES.audio;
			}

			if (meta.src.match(/(^data:image\/)|(\.(jpe?g|gif|png|bmp|webp|svg)(([?#]).*)?$)/i)) {
				meta.thumb = content.dataset.lightboxThumb || content.src || content.href || '';
				meta.type = SLIDE_TYPES.image;
			}

			if ((extension = meta.src.match(/\.(mp4|mov|ogv|webm)(([?#]).*)?$/i))) {
				meta.mimeType = 'video/' + (extension[1] === 'ogv' ? 'ogg' : extension[1])
				meta.thumb = content.dataset.lightboxThumb || '';
				meta.type = SLIDE_TYPES.video;
				meta.sources = [];

				if (content.dataset.sources) {
					var sources = JSON.parse(content.dataset.sources || '{}');
					if (sources && Object.values(sources).length > 0) {
						for (var resolution in sources) {
							meta.sources.push({
								resolution: resolution,
								src: sources[resolution]
							});
						}
					}
				} else {
					meta.sources.push({
						resolution: 'web',
						src: meta.src
					})
				}
			}

			return meta;
		}
	};

	var AudioSlide = function (meta) {
		this.contentClasses = `${SLIDE_CLASSES.content} ${SLIDE_CLASSES.audioContent}`;
		this.mediaSelector = 'audio';
		this.tplContent = tpl_slide_audio;
		Slide.call(this, meta);
	};
	AudioSlide.prototype = Object.create(Slide.prototype);
	Object.assign(AudioSlide.prototype, {
		addListenersOnContent: function (element) {
			var audio = this.getMediaElement();

			if (!audio) {
				return;
			}

			audio.addEventListener('load', this.onLoad.bind(this));
		}
	});

	var ImageSlide = function (meta) {
		this.contentClasses = `${SLIDE_CLASSES.content} ${SLIDE_CLASSES.imageContent}`;
		this.mediaSelector = 'img';
		this.tplContent = tpl_slide_image;
		Slide.call(this, meta);
	};
	ImageSlide.prototype = Object.create(Slide.prototype);
	Object.assign(ImageSlide.prototype, {
		addListenersOnContent: function (element) {
			var image = this.getMediaElement();

			if (!image) {
				return;
			}

			image.addEventListener('load', this.onLoad.bind(this));
		}
	});

	var VideoSlide = function (meta) {
		this.contentClasses = `${SLIDE_CLASSES.content} ${SLIDE_CLASSES.videoContent}`;
		this.mediaSelector = 'video';
		this.mimeType = meta.mimeType;
		this.sources = this.sortSources(meta.sources);
		this.tplContent = tpl_slide_video;
		Slide.call(this, meta);
	};
	VideoSlide.prototype = Object.create(Slide.prototype);
	Object.assign(VideoSlide.prototype, {
		addListenersOnContent: function () {
			var video = this.getMediaElement();

			if (!video) {
				return;
			}

			video.addEventListener('error', function (event) {
				wglog.error('VideoSlide::addListenersOnContent unable to load video', 'Video URL: ' + video.src);
			});
			video.addEventListener('canplay', this.onLoad.bind(this));
		},
		createElement: function () {
			Slide.prototype.createElement.call(this);
			var video = this.getMediaElement();

			if (!video) {
				return;
			}

			video.src = this.getBestSource().src;
			video.load();
		},
		getBestSource: function () {
			var windowWidth = window.innerWidth,
				windowHeight = window.innerHeight,
				resolutionOrder = Object.keys(VIDEO_RESOLUTIONS),
				bestResKey = resolutionOrder.find(function (key) {
					var res = VIDEO_RESOLUTIONS[key];
					return windowWidth >= res.width && windowHeight >= res.height;
				}) || resolutionOrder[0];

			var source = this.sources.find(function (s) { return s.resolution === bestResKey; });

			if (source) {
				return source;
			}

			var target = VIDEO_RESOLUTIONS[bestResKey];
			source = this.sources.reduce(function (best, _source) {
				var res = VIDEO_RESOLUTIONS[_source.resolution];
				if (!res) {
					return best;
				}
				var diff = Math.abs(res.width - target.width) + Math.abs(res.height - target.height);
				return !best || diff < best.diff ? { s: _source, diff: diff } : best;
			}, null).s;

			return source || this.sources[0];
		},
		pause: function() {
			var video = this.getMediaElement();

			if (!video) {
				return;
			}

			video.pause();
		},
		sortSources: function (sources) {
			var resolutionOrder = Object.keys(VIDEO_RESOLUTIONS).reduce((map, resolution, index) => {
				map[resolution] = index;
				return map;
			}, {});

			return sources.sort((a, b) => {
				var resolutionA = resolutionOrder[a.resolution],
					resolutionB = resolutionOrder[b.resolution],
					indexA = (resolutionA !== null && resolutionA !== undefined) ? resolutionA : Infinity,
					indexB = (resolutionB !== null && resolutionB !== undefined) ? resolutionB : Infinity;
				return indexA - indexB;
			});
		},
	});

	var Thumbs = function (slider) {
		this.slider = slider;
		this.tplThumb = `<button class="{{classes}}"><img src="{{src}}" alt="{{alt}}" onerror="this.style.display='none'" /></button>`;
		this.tplThumbs = `<div class="${THUMBS_CLASSES.thumbs}"><div class="${THUMBS_CLASSES.thumbsTrack}"></div></div>`;
		this.create();
	}
	Object.assign(Thumbs.prototype, {
		create: function () {
			this.element = $(Mustache.render(this.tplThumbs));
			this.track = this.element.find(`.${THUMBS_CLASSES.thumbsTrack}`);
			this.track.addClass(THUMBS_CLASSES.thumbsTrackCentered);
			this.track[0].style.setProperty('--n', this.slider.slides.length);

			for (var slide of this.slider.slides) {
				this.track.append(Mustache.render(this.tplThumb, {
					src: slide.getThumbSrc(),
					alt: slide.getAlt(),
					classes: `${THUMBS_CLASSES.thumb} ${THUMBS_CLASSES.thumb}-${slide.type}`
				}));
			}

			this.slider.node.find(`.${OVERLAY_CLASSES.footer}`).append(this.element);
			this.element.on('click', `.${THUMBS_CLASSES.thumb}`, this.onThumbClick.bind(this));
			this.select(this.slider.selected);
		},
		onThumbClick: function (event) {
			event.preventDefault();
			this.slider.goTo($(event.currentTarget).index());
		},
		select: function (index) {
			this.element.find(`.${THUMBS_CLASSES.thumb}`).removeClass(THUMBS_CLASSES.activeThumb).eq(index).addClass(THUMBS_CLASSES.activeThumb);
			this.track[0].style.setProperty('--i', index);
		}
	});

	return Slider;
});
define('features/Lightbox/Lightbox',[
	'config/chat',
	'lib/helpers/overlay/slider'
], function(
	Config,
	Slider
) {
	var CONTAINER_SELECTOR = '.chat-external-overlay-container',
		DATASET_NAME = 'lightbox';

	var DEFAULT_OPTIONS = {
		container: CONTAINER_SELECTOR
	};

	/**
	 * Lightbox
	 *
	 * @param item {HTMLElement}
	 * @param options {Object=} Options for the lightbox lib + customs (see below).
	 * @param options.container {string=} CSS selector used to select the lightbox container, default: CONTAINER_SELECTOR.
	 * @param options.selector {string=} CSS selector used to select items, default: value item[data-lightbox] attribute.
	 * @constructor
	 */
	var Lightbox = function(item, options) {
		this.options = Object.assign({}, DEFAULT_OPTIONS, options || {});
		this.container = this.prepareContainer();
		this.items = this.prepareItems(item);

		this.create();
	};

	Object.assign(Lightbox.prototype, {
		create: function () {
			if (!this.container) {
				wglog.debug('Lightbox::create container not found', 'Unable to create a lightbox without container');
				return;
			}

			this.slider = new Slider(this.container, this.items, this.options);
		},
		hasSlidesToDisplay: function () {
			return this.slider.slides.length > 0;
		},
		prepareContainer: function () {
			if (typeof this.options.container === 'string') {
				return document.querySelector(this.options.container);
			}
		},
		prepareItems: function (item) {
			var selector = '';

			if (this.options.selector && typeof options.selector === 'string') {
				selector = this.options.selector;
			} else if (item.dataset && item.dataset.hasOwnProperty(DATASET_NAME) && item.dataset[DATASET_NAME]) {
				selector = `[data-${DATASET_NAME}="${item.dataset[DATASET_NAME]}"]`;
			}

			var items = [];

			if (selector) {
				items = Array.from(document.querySelectorAll(selector));
			} else {
				items.push(item);
			}

			this.options.selected = Math.max(0, items.indexOf(item));

			return items;
		},
		show: function () {
			if (this.hasSlidesToDisplay()) {
				this.slider.show();
			} else {
				wglog.debug('Lightbox::show no slides to display', 'The slider has no slides to display');
			}
		}
	});

	var getValidItem = function (item) {
		if (item.dataset && item.dataset[DATASET_NAME]) {
			return item;
		}

		var closest = typeof item.closest === 'function' ? item.closest(`[data-${DATASET_NAME}]`) : undefined;
		if (closest) {
			return closest;
		}
	};

	return {
		create: function (item, options) {
			var validItem = getValidItem(item);

			if (!validItem) {
				return null;
			}

			return new Lightbox(validItem, options);
		}
	};
});
define('features/Lightbox/commands/InitLightbox',[
	'core/Command',
	'features/Lightbox/Lightbox'
], function(
	Command,
	Lightbox,
) {
	var CONVERSATION_CONTAINER_SELECTOR = '.chat-messages';

	var InitLightbox = function(context) {
		Command.call(this, context);
	};

	InitLightbox.prototype = Object.create(Command.prototype);

	Object.assign(InitLightbox.prototype, {
		execute: function () {
			var convContainer = document.querySelector(CONVERSATION_CONTAINER_SELECTOR);

			if (!convContainer) {
				convContainer = document.body;
			}

			convContainer.addEventListener('click', this.onConvContainerClick);
		},
		onConvContainerClick: function (event) {
			if (!event || event.defaultPrevented) {
				return;
			}

			var lightbox = Lightbox.create(event.target);

			if (!lightbox || !lightbox.hasSlidesToDisplay()) {
				return;
			}

			event.preventDefault();

			lightbox.show();
		}
	});

	return InitLightbox;
});
define('features/Lightbox/LightboxMapper',[
	'config/chat',
	'chat/ManagerEvent',
	'features/Lightbox/commands/InitLightbox'
], function(
	Config,
	ManagerEvent,
	InitLightboxCommand
) {
	return function(context) {
		context.commandMap.mapEvent(ManagerEvent.NODE_CREATED, InitLightboxCommand);
	};
});
define('features/CreatorMessages/commands/InitCreatorMessagesButton',[
    'core/Command',
    'features/CreatorMessages/AutoMessage/events/AutoMessageEvent',
    'features/CreatorMessages/MassMessage/events/MassMessageEvent',
    'lib/helpers/popup/contextual_menu',
    'lib/i18n!front'
], function(
    Command,
    AutoMessageEvent,
    MassMessageEvent,
    ContextualMenu,
    i18n
) {
    var InitCreatorMessagesButton = function(context) {
        Command.call(this, context);
    };

    InitCreatorMessagesButton.prototype = Object.create(Command.prototype);

    Object.assign(InitCreatorMessagesButton.prototype, {
        execute: function () {
            var button = document.querySelector('.chat-creator-messages.btn--creator-messages'),
                cm_actions = [],
                self = this;

            if (!button) {
                return;
            }

            cm_actions.push({
                name: 'creator-messages-mass-message',
                label: '<span class="chat-creator-messages-icon chat-creator-messages-icon--mass-message"></span> ' + i18n.__('chat.mass_message'),
                callback: function () {
                    self.context.emit(MassMessageEvent.OPEN);
                }
            });

            cm_actions.push({
                name: 'creator-messages-auto-message',
                label: '<span class="chat-creator-messages-icon chat-creator-messages-icon--auto-message"></span> ' + i18n.__('chat.auto_message'),
                callback: function () {
                    self.context.emit(AutoMessageEvent.OPEN);
                }
            });

            var cm = new ContextualMenu(button, cm_actions, {
                position: {v: 'below', h: 'right'},
                on_open: function () {
                    var popup = cm.getPopup();
                    popup.children('.x-popup-content').css({borderTopRightRadius: 0});
                    popup.find('.contextual-menu').addClass('chat-creator-messages-contextual-menu');

                    if (popup.width() <= button.offsetWidth) {
                        popup.children('.x-popup-content').css({borderTopLeftRadius: 0});
                    }

                    button.classList.add('btn--creator-messages--open');
                },
                on_close: function () {
                    button.classList.remove('btn--creator-messages--open');
                }
            });
        },
    });

    return InitCreatorMessagesButton;
});
define('features/CreatorMessages/CreatorMessagesMapper',[
    'config/chat',
    'chat/ManagerEvent',
    'features/CreatorMessages/commands/InitCreatorMessagesButton'
], function(
    Config,
    ManagerEvent,
    InitCreatorMessagesButtonCommand
) {
    return function(context) {
        if (!Config.login_info.is_creator) {
            return;
        }

        context.commandMap.mapEvent(ManagerEvent.NODE_CREATED, InitCreatorMessagesButtonCommand);
    };
});
define('features/CreatorMessages/MassMessage/commands/CancelMassMessage',[
	'core/Command',
	'services/SocketConnection',
	'services/SocketConnectionEvent',
], function(
	Command,
	SocketConnection,
	SocketConnectionEvent
) {
	var CancelMassMessageCommand = function(context) {
		Command.call(this, context);
	};

	CancelMassMessageCommand.prototype = Object.create(Command.prototype);

	Object.assign(CancelMassMessageCommand.prototype, {
		execute: function (args) {
			if (typeof args === 'undefined' || typeof args.mass_message_id === 'undefined') {
				throw new Error('No mass message id');
				return;
			}
			SocketConnection.emit(SocketConnectionEvent.out.CANCEL_MASS_MESSAGE, args);
		}
	});

	return CancelMassMessageCommand;
});

define('text!chat/attachment/form_button.mustache',[],function () { return '<button type="button" class="btn btn--flat chat-message-form__action chat-message-form__action--default chat-message-form__action--attachment" title="{{{ trad.attachment }}}" data-toggle="#chat-attachment">\n\t<svg class="chat-scc"><use xlink:href="#scc-attachment-icon"></use></svg>\n\t<span>{{{ trad.attachment }}}</span>\n</button>';});


define('text!chat/attachment/form_fields.mustache',[],function () { return '<div id="{{messageFormFieldsId}}" class="chat-toggle">\n\t{{#maxSize}}\n\t\t<p class="chat-file-size-limit">{{maxSize}}</p>\n\t{{/maxSize}}\n\t{{#showTabs}}\n\t<ul class="chat-tabs chat-tabs--attachment">\n\t\t{{#services}}\n\t\t\t<li class="chat-tabs__item{{#isActive}} active{{/isActive}}" data-toggle="#chat-{{key}}" data-group="attachment-tabs" data-service="{{key}}">\n\t\t\t\t<svg class="chat-scc"><use xlink:href="#{{icon}}"></use></svg>\n\t\t\t\t<span>{{label}}</span>\n\t\t\t</li>\n\t\t{{/services}}\n\t</ul>\n\t{{/showTabs}}\n\n\t{{#services}}\n\t\t<div id="chat-{{key}}" class="chat-toggle{{#isActive}} chat-toggle--show{{/isActive}}">\n\t\t\t{{{field}}}\n\t\t</div>\n\t{{/services}}\n\n\t{{{priceField}}}\n</div>';});


define('text!ui/Modal/ConfirmModal.mustache',[],function () { return '<div class="{{className}}">\n\t{{#title}}\n\t<div class="{{className}}__header">\n\t\t<h2 class="{{className}}__title">{{title}}</h2>\n\t</div>\n\t{{/title}}\n\t<form class="chat-ui-form">\n\t\t{{#message}}\n\t\t<p class="chat-ui-form__message">{{{message}}}</p>\n\t\t{{/message}}\n\t\t<div class="chat-ui-form__actions chat-ui-form__actions--center">\n            {{#buttons}}\n                <button type="button" class="chat-ui-action-button--{{type}} chat-ui-action-button chat-ui-action-button--{{buttonVariant}}">\n                    <span>{{label}}</span>\n                </button>\n            {{/buttons}}\n\t\t</div>\n\t</form>\n</div>';});

define('ui/Modal/ConfirmModal',[
	'lib/i18n!front',
	'lib/tools',
	'mustache',
	'text!ui/Modal/ConfirmModal.mustache',
	'ui/Modal/Modal'
], function(
	i18n,
	tools,
	Mustache,
	tplConfirmModal,
	Modal
) {
	var DEFAULT_OPTIONS = {
		dontCloseExistingModal: true,
		autoOpen: true,
		closable: false,
		showNoButton: true,
		invertButtons: false,
		title: i18n.__('misc.please_confirm'),
		popup: {
			no: i18n.__('misc.cancel'),
			ok: i18n.__('misc.yes')
		},
		onNo: null,
		onOk: null
	};

	var ConfirmModal = function(message, options) {
		this.template = tplConfirmModal;
		this.options = Object.assign({}, DEFAULT_OPTIONS, options || {});

		var _element = this.generateElement(message);

		Modal.call(this, _element, this.options);

		this.addListeners();
	};

	ConfirmModal.prototype = Object.create(Modal.prototype);

	Object.assign(ConfirmModal.prototype, {
		addListeners: function () {
			this.modal.container.on('click.confirm-modal', '.chat-ui-action-button--ok', this.onClickOk.bind(this));
			if (this.options.showNoButton) {
				this.modal.container.on('click.confirm-modal', '.chat-ui-action-button--no', this.onClickNo.bind(this));
			}
		},
		generateElement: function (message) {
			var buttons = [{type: 'ok', buttonVariant: 'gradient', label: this.options.popup.ok}];

			if (this.options.showNoButton) {
				var method = this.options.invertButtons ? 'unshift' : 'push';
				buttons[method]({type: 'no', buttonVariant: 'white', label: this.options.popup.no});
			}

			var params = {
				className: 'chat-ui-confirm-modal',
				title: this.options.title,
				message: message.replaceAll('\r\n', '<br>'),
				buttons: buttons
			};

			return tools.string_to_node(Mustache.render(this.template, params));
		},
		open: function () {
			Modal.prototype.open.call(this);
			this.modal.container.closest('.x-body').addClass(Modal.BASE_CLASS_NAME + '--width-auto');
		},
		onClickOk: function () {
			if (this.options.onOk) {
				this.options.onOk();
			}
			this.modal.close();
		},
		onClickNo: function () {
			if (this.options.onNo) {
				this.options.onNo();
			}
			this.modal.close();
		},
	});

	return ConfirmModal;
});
define('chat/attachment/attachment_manager',[
	'mustache',
	'config/chat',
	'lib/i18n!front',
	'text!chat/attachment/form_button.mustache',
	'text!chat/attachment/form_fields.mustache',
	'ui/Modal/ConfirmModal'
], function(
	Mustache,
	config,
	i18n,
	tpl_button,
	tpl_fields,
	ConfirmModal
) {
	var instance = null;

	var ATTACHMENT_KEY_LOCAL_UPLOAD = 'local';
	var ATTACHMENT_KEY_CONTENT = 'content';
	var ATTACHMENT_KEY_VAULT = 'vault';
	var ATTACHMENT_VIEW_HIDDEN = 'hidden';
	var ATTACHMENT_VIEW_VISIBLE = 'visible';

	/**
	 * Manage all attachment related stuff (message form fields, local file upload, vault)
	 * @constructor
	 */
	var AttachmentManager = function() {
		if (instance !== null) {
			wglog.error("AttachmentManager::constructor", "Can not instantiate more than one instance, use AttachmentManager.getInstance();");
		}

		this.activeService = "";
		this.defaultService = "";
		this.messageFormFieldsId = "chat-attachment";
		this.services = new Map();
		this.state = ATTACHMENT_VIEW_HIDDEN;
	}

	AttachmentManager.prototype = {
		addMessageFormFieldsListeners: function () {
			if (this.services.has(ATTACHMENT_KEY_LOCAL_UPLOAD)) {
				var dz = $('#chat-files').prop('dropzone');
				if (!dz) {
					return false;
				}
				dz.on('addedfile', this.onLocalUploadChange.bind(this));
				dz.on('removedfile', this.onLocalUploadChange.bind(this));
			}
			if (this.services.has(ATTACHMENT_KEY_CONTENT)) {
				$(document).on('change.attachment-price', '.chat-content__content-selector', this.onVaultContentSelectorChange.bind(this));
			}
			if (this.services.has(ATTACHMENT_KEY_VAULT)) {
				$(document).on('change.attachment-price', '.chat-vault__content-selector', this.onVaultContentSelectorChange.bind(this));
			}
			$('[data-toggle="#chat-attachment"]').on('click.attachment-btn', this.onAttachmentBtnClick.bind(this));
			$('[data-group="attachment-tabs"]').on('click.attachment-tabs', this.onAttachmentTabClick.bind(this));
		},
		isForActiveServiceSendMessage: function () {
			var contentService = this.services.get(ATTACHMENT_KEY_CONTENT);

			if (config.login_info.is_creator && this.activeService === ATTACHMENT_KEY_LOCAL_UPLOAD && contentService && contentService.isVisible) {
				return contentService.instance.canProcess();
			}

			var vaultService = this.services.get(ATTACHMENT_KEY_VAULT);

			if (config.login_info.is_creator && this.activeService === ATTACHMENT_KEY_LOCAL_UPLOAD && vaultService && vaultService.isVisible) {
				return vaultService.instance.canProcess();
			}

			var service = this.services.get(this.activeService);
			if (typeof service.instance.canProcess === 'function') {
				return service.instance.canProcess();
			}

			return false;
		},
		activeServiceSendMessage: function (friendId) {
			var vaultService = this.services.get(ATTACHMENT_KEY_VAULT);

			if (config.login_info.is_creator && this.activeService === ATTACHMENT_KEY_LOCAL_UPLOAD && vaultService && vaultService.isVisible) {
				vaultService.instance.createContent();
				return;
			}

			var service = this.services.get(this.activeService);

			if (typeof friendId === 'object' && friendId.length) {
				for (var index in friendId) {
					service.instance.add_to_conversation(friendId[index]);
				}
			}
			else {
				service.instance.add_to_conversation(friendId);
			}

			if (this.activeService === ATTACHMENT_KEY_VAULT) {
				service.instance.emptyDropzone();
				service.instance.clearMessageFormFields();
			}
		},
		displayPriceWrapper: function (isVaultPriceFieldVisible) {
			var contentPriceWrapperVisible = false,
				contentService = this.services.get(ATTACHMENT_KEY_CONTENT),
				vaultPriceWrapperVisible = isVaultPriceFieldVisible || false,
				vaultService = this.services.get(ATTACHMENT_KEY_VAULT);

			if (typeof visible === "undefined") {
				switch (this.activeService) {
					case ATTACHMENT_KEY_LOCAL_UPLOAD:
						var dz = $('#chat-files').prop('dropzone');
						contentPriceWrapperVisible = false;
						vaultPriceWrapperVisible = dz ? !!dz.files.length : false;
						break;
					case ATTACHMENT_KEY_CONTENT:
						contentPriceWrapperVisible = contentService.instance.hasContentSelected;
						vaultPriceWrapperVisible = false;
						break;
					case ATTACHMENT_KEY_VAULT:
						contentPriceWrapperVisible = false;
						vaultPriceWrapperVisible = this.services.get(ATTACHMENT_KEY_VAULT).instance.hasContentSelected;
						break;
					default:
						visible = false;
				}
			}

			if (this.friendManager) {
				var friend = this.friendManager.friends[this.friendManager.selected_friend];
				if (friend && (friend.is_support || friend.is_creator)) {
					contentPriceWrapperVisible = false;
					vaultPriceWrapperVisible = false;
				}
			}

			if (contentService) {
				if (contentPriceWrapperVisible) {
					contentService.instance.showPriceWrapper();
				} else {
					contentService.instance.hidePriceWrapper();
				}

			}

			if (vaultService) {
				if (vaultPriceWrapperVisible) {
					vaultService.instance.showPriceWrapper();
				} else {
					vaultService.instance.hidePriceWrapper();
				}
			}
		},
		emptyAttachmentFields: function () {
			if (this.services.has(ATTACHMENT_KEY_LOCAL_UPLOAD)) {
				this.services.get(ATTACHMENT_KEY_LOCAL_UPLOAD).instance.dropzone.dropzoneInstance.removeAllFiles();
			}
			if (this.services.has(ATTACHMENT_KEY_CONTENT)) {
				this.services.get(ATTACHMENT_KEY_CONTENT).instance.clearMessageFormFields(true);
			}
			if (this.services.has(ATTACHMENT_KEY_VAULT)) {
				this.services.get(ATTACHMENT_KEY_VAULT).instance.clearMessageFormFields(true);
			}
		},
		getMessageFormButton: function () {
			if (!this.hasServices()) {
				return '';
			}

			return Mustache.render(tpl_button, {trad: {attachment: i18n.__('chat.attachment')}});
		},
		getDefaultService: function () {
			if (!this.defaultService) {
				var [key] = this.services.keys();
				this.defaultService = key;
			}

			return this.defaultService;
		},
		getMessageFormFields: function () {
			if (!this.hasServices()) {
				return '';
			}

			var hasContent = this.services.has(ATTACHMENT_KEY_CONTENT),
				hasVault = this.services.has(ATTACHMENT_KEY_VAULT),
				params = {
				messageFormFieldsId: this.messageFormFieldsId,
				showTabs: this.services.size > 1,
				services: Array.from(this.services, function (item) {
					item[1].key = item[0];
					item[1].field = item[1].instance.get_field();
					return item[1]
				}),
				priceField: (hasVault ? this.services.get(ATTACHMENT_KEY_VAULT).instance.getPriceField() : '') + (hasContent ? this.services.get(ATTACHMENT_KEY_CONTENT).instance.getPriceField() : ''),
				maxSize: i18n.__('upload-size-limit', {"%limit%": config.login_info.is_creator ? '30GB' : '500MB'})
			};

			return Mustache.render(tpl_fields, params);
		},
		hide: function () {
			if (this.state !== ATTACHMENT_VIEW_HIDDEN) {
				$('[data-toggle="#chat-attachment"]').click();
				if (this.services.has(ATTACHMENT_KEY_CONTENT)) {
					this.services.get(ATTACHMENT_KEY_CONTENT).instance.clearMessageFormFields(true);
				}
				if (this.services.has(ATTACHMENT_KEY_VAULT)) {
					this.services.get(ATTACHMENT_KEY_VAULT).instance.clearMessageFormFields(true);
				}
			}
		},
		hasServices: function () {
			return this.services.size > 0;
		},
		hasToShowCloseAttachmentModal: function () {
			if (this.activeService === ATTACHMENT_KEY_LOCAL_UPLOAD) {
				return this.services.get(ATTACHMENT_KEY_LOCAL_UPLOAD).instance.dropzone.hasFiles();
			}

			if (this.activeService === ATTACHMENT_KEY_CONTENT) {
				return this.services.get(ATTACHMENT_KEY_CONTENT).instance.hasContentSelected;
			}

			if (this.activeService === ATTACHMENT_KEY_VAULT) {
				return this.services.get(ATTACHMENT_KEY_VAULT).instance.hasContentSelected;
			}

			return false;
		},
		isVisible: function () {
			return this.state === ATTACHMENT_VIEW_VISIBLE;
		},
		onAttachmentBtnClick: function (event) {
			var button = event.currentTarget,
				attachmentIsDisplayed = this.state === ATTACHMENT_VIEW_VISIBLE;

			if (attachmentIsDisplayed && this.hasToShowCloseAttachmentModal()) {
				var self = this;
				this.showCloseAttachmentModal(function () {
					self.toggleAttachmentButtonIcon(!attachmentIsDisplayed);
					self.emptyAttachmentFields();
					self.toggleAttachmentButtonIcon(!attachmentIsDisplayed);
					self.state = attachmentIsDisplayed ? ATTACHMENT_VIEW_HIDDEN : ATTACHMENT_VIEW_VISIBLE;
					$('.chat-tabs--attachment [data-service="' + self.getDefaultService() + '"]').click();

					// @TODO Find a better solution
					var toggler = $(button);
					toggler.toggleClass('active');
					$(toggler.data('toggle')).toggleClass('chat-toggle--show');
				});
				event.stopPropagation();
				return;
			}

			this.displayPriceWrapper();
			this.toggleAttachmentButtonIcon(!attachmentIsDisplayed);
			this.state = attachmentIsDisplayed ? ATTACHMENT_VIEW_HIDDEN : ATTACHMENT_VIEW_VISIBLE;
			$('.chat-tabs--attachment [data-service="' + this.getDefaultService() + '"]').click();
		},
		onAttachmentTabClick: function (event) {
			var dataset = event.currentTarget.dataset;

			if (dataset && dataset.service && this.services.has(dataset.service)) {
				this.setActiveService(dataset.service);
			}
		},
		onLocalUploadChange: function (event) {
			var hasFiles = !!$('#chat-files').prop('dropzone').files.length;
			this.displayPriceWrapper(hasFiles);
		},
		onVaultContentSelectorChange: function (event) {
			this.displayPriceWrapper();
		},
		setActiveService: function (serviceKey) {
			this.activeService = serviceKey;

			this.services.forEach((value, key) => value.isActive = key === serviceKey);

			this.displayPriceWrapper();
		},
		setFriendManager: function (friendManager) {
			this.friendManager = friendManager;
		},
		setService: function (key, service) {
			if (typeof key !== 'string') {
				throw new TypeError('AttachmentManager::setService, key must be a string');
			}
			if (typeof service === 'undefined') {
				throw new TypeError('AttachmentManager::setService' + ` (service: ${key})` + ', service is undefined');
			}
			if (typeof service.label !== 'string') {
				throw new TypeError('AttachmentManager::setService' + ` (service: ${key})` + ', service.label must be a string');
			}
			if (typeof service.icon !== 'string') {
				throw new TypeError('AttachmentManager::setService' + ` (service: ${key})` + ', service.icon must be the ID of an icon from icon sprite');
			}
			if (typeof service.isActive !== 'undefined' && typeof service.isActive !== 'boolean') {
				throw new TypeError('AttachmentManager::setService' + ` (service: ${key})` + ', service.isActive must be a boolean');
			}
			if (typeof service.isDefault !== 'undefined' && typeof service.isDefault !== 'boolean') {
				throw new TypeError('AttachmentManager::setService' + ` (service: ${key})` + ', service.isDefault must be a boolean');
			}
			if (typeof service.instance !== 'object') {
				throw new TypeError('AttachmentManager::setService' + ` (service: ${key})` + ', service.instance must be an object');
			}
			var prototype = Object.getPrototypeOf(service.instance);
			if (typeof prototype.add_to_conversation !== 'function') {
				throw new Error('AttachmentManager::setService' + ` (service: ${key})` + ', service.instance must have an add_to_conversation method');
			}
			if (typeof prototype.get_field !== 'function') {
				throw new Error('AttachmentManager::setService' + ` (service: ${key})` + ', service.instance must have a get_field method');
			}

			if (service.icon[0] === "#") {
				service.icon = service.icon.substring(1);
			}

			this.services.set(key, service);

			if (service.isActive) {
				this.setActiveService(key);
			}
			if (service.isDefault) {
				this.defaultService = key;
			}
		},
		setVisibleServices: function (visibleServices) {
			if (!visibleServices instanceof Array) {
				throw new TypeError('AttachmentManager::refreshMessageFormFields, visibleServices must be an array of strings containing service keys');
			}

			var visibleServicesCount = 0;
			this.services.forEach((value, key) => {
				if (visibleServices.indexOf(key) >= 0) {
					$('.chat-tabs--attachment [data-service="' + key + '"]').show();
					value.isVisible = true;
					visibleServicesCount++;
				} else {
					if (key === this.activeService) {
						$('.chat-tabs--attachment [data-service="' + visibleServices[0] + '"]').click();
					}
					$('.chat-tabs--attachment [data-service="' + key + '"]').hide();
					value.isVisible = false;
				}
			});

			if (visibleServicesCount > 1) {
				$('.chat-tabs--attachment').show();
			} else {
				$('.chat-tabs--attachment').hide();
			}
		},
		addExtraFileType: function(fileType) {
			if (this.services.has(ATTACHMENT_KEY_LOCAL_UPLOAD)) {
				var uploadService = this.services.get(ATTACHMENT_KEY_LOCAL_UPLOAD);
				uploadService.instance.extensions.text.push(fileType);
				var acceptedFiles = uploadService.instance.dropzone.dropzoneInstance.options.acceptedFiles;
				if (acceptedFiles.indexOf('.' + fileType) === -1) {
					uploadService.instance.dropzone.dropzoneInstance.options.acceptedFiles += ',.' + fileType;
				}
			}
		},
		removeExtraFileType: function(fileType) {
			if (this.services.has(ATTACHMENT_KEY_LOCAL_UPLOAD)) {
				var uploadService = this.services.get(ATTACHMENT_KEY_LOCAL_UPLOAD);
				uploadService.instance.extensions.text.splice(uploadService.instance.extensions.text.indexOf(fileType), 1);
				var acceptedFiles = uploadService.instance.dropzone.dropzoneInstance.options.acceptedFiles;
				if (acceptedFiles.indexOf('.' + fileType) > -1) {
					const re = new RegExp('(^\\.' + fileType + ',|,\\.' + fileType + ')');
					uploadService.instance.dropzone.dropzoneInstance.options.acceptedFiles = acceptedFiles.replace(re, '');
				}
			}
		},
		setVisibleServicesAll: function () {
			this.setVisibleServices(Array.from(this.services.keys()));
		},
		show: function () {
			if (this.state !== ATTACHMENT_VIEW_VISIBLE) {
				$('.chat-message-form__action--attachment').click();
			}
		},
		showCloseAttachmentModal: function (onOkCallback, onNoCallback) {
			var vaultService = this.services.get(ATTACHMENT_KEY_VAULT);
			new ConfirmModal('', {
				title: i18n.__(vaultService && vaultService.isVisible ? 'chat.attachment.close_notice_title_creator' : 'chat.attachment.close_notice_title'),
				popup: {ok: i18n.__('misc.remove'), no: i18n.__('misc.cancel')},
				onOk: onOkCallback,
				onNo: onNoCallback
			});
		},
		toggleAttachmentButtonIcon: function (showCloseIcon) {
			var icon = $('.chat-message-form__action--attachment .chat-scc use');
			icon.attr('xlink:href', showCloseIcon ? '#scc-message-attachment-close-icon' : '#scc-message-attachment-icon');
		}
	}

	AttachmentManager.getInstance = function () {
		if (instance === null) {
			instance = new AttachmentManager();
		}

		return instance;
	}

	return AttachmentManager.getInstance();
});

define('text!chat/dropzone/field.mustache',[],function () { return '<div id="{{id}}" class="{{classes}}" data-token="{{token}}"></div>';});

define('chat/dropzone/dropzone',[
	'config/chat',
	'lib/i18n!front',
	'mustache',
	'text!chat/dropzone/field.mustache'
], function (
	config,
	i18n,
	Mustache,
	tpl_field
) {

	/**
	 * Dropzone
	 *
	 * @param options.id {String} String to set in dropzone field id attribute.
	 * @param options.token {String} String to set in dropzone field data-token attribute.
	 * @param options.classes {String[]} (optional) Class names to set in dropzone field class attribute.
	 * @param options.extensions {Object} (optional) Used by switchFileExt method, it let you define file types for each file extensions.
	 * @param options.extensions.audio {String[]} Array containing all extensions for audio files handled by this dropzone instance, for example: ['mp3', 'ogg'].
	 *
	 * @constructor
	 */
	var Dropzone = function (options) {
		if (!this.validateOptions(options)) {
			return;
		}

		this.available = false;
		this.dropzoneInstance = null;
		this.field_id = options.id;
		this.field_selector = '#' + this.field_id;
		this.field_classes = ['dropzone', 'dropzone-light', 'chat-dropzone'].concat(options.classes || []);
		this.field_token = options.token;
		this.addedFiles = {};
	}

	Dropzone.prototype.emit = function (eventName) {
		this.getInstance().emit(eventName);
	}

	Dropzone.prototype.getContainer = function () {
		return $(this.field_selector);
	}

	Dropzone.prototype.getFieldHtml = function () {
		return Mustache.render(tpl_field, {
			id: this.field_id,
			classes: this.field_classes.join(' '),
			token: this.field_token
		});
	}

	Dropzone.prototype.getFileIndex = function (file) {
		return this.getInstance().files.indexOf(file);
	}

	/**
	 * Get file type based on its mime-type.
	 * @param mimeType
	 * @returns {string}
	 */
	Dropzone.prototype.getFileMainType = function (mimeType) {
		if (typeof mimeType !== "string") {
			wglog.error('Dropzone::getFileMainType', "mimeType argument must be a string");
			return "";
		}

		var customTypes = {
				"application/vnd.ms-excel": 'excel',
				"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet": 'excel',
				"text/csv": 'excel',
				"application/msword": 'word',
				"application/vnd.openxmlformats-officedocument.wordprocessingml.document": 'word',
				"application/pdf": 'text',
			},
			mainType = mimeType.substring(0, mimeType.indexOf("/"));

		return customTypes[mimeType] || mainType;
	}

	Dropzone.prototype.getInstance = function () {
		if (!this.dropzoneInstance) {
			wglog.error('Dropzone::getInstance', 'dropzone instance is undefined, you should execute init() before');
			return undefined;
		}
		return this.dropzoneInstance;
	}

	Dropzone.prototype.hasFiles = function () {
		return this.dropzoneInstance.files.length > 0;
	}

	Dropzone.prototype.init = function () {
		if ($(this.field_selector).length === 0) {
			throw new Error('Dropzone::init, add dropzone html field before init');
		}
		config.file_upload.init(this.field_selector);
		this.dropzoneInstance = $(this.field_selector)[0].dropzone;
		if (!this.dropzoneInstance) {
			return false;
		}
		this.available = true;
		this.dropzoneInstance.on('addedfile', (file) => {

			function hashCode(filename) {
				var hash;
				for (var i = 0, h = 0; i < filename.length; i++) {
					hash = Math.imul(31, h) + filename.charCodeAt(i) | 0;
				}
				return hash;
			}
			var key = hashCode(file.upload.filename) * file.upload.total;

			if (!!this.addedFiles[key]) {
				file.previewElement.remove();
				this.removeFile(file);
			}
			else {
				this.addedFiles[key] = { state: 'added' }
			}
		});
		this.dropzoneInstance.on('addedfiles', (files) => {
			for (var i = 0, l = files.length; i < l; i++) {
				$(files[i].previewElement).addClass(this.getFileMainType(files[i].type));
			}
		});
		this.dropzoneInstance.on('reset', this.resetAddedFiles.bind(this));
		this.dropzoneInstance.on('close', this.resetAddedFiles.bind(this));
		return this;
	}

	Dropzone.prototype.on = function (event, callback) {
		this.dropzoneInstance.on(event, callback);
		return this;
	}

	Dropzone.prototype.resetAddedFiles = function() {
		this.addedFiles = {};
	}

	Dropzone.prototype.removeAllFiles = function () {
		this.getInstance().removeAllFiles();
	}

	Dropzone.prototype.removeFile = function (file) {
		var dz = this.getInstance();
		return dz.files.splice(dz.files.indexOf(file), 1);
	}

	Dropzone.prototype.replaceFile = function (index, file) {
		this.getInstance().files[index] = file;
	}

	Dropzone.prototype.setOptions = function (options) {
		var dz = this.getInstance();
		if (!dz) {
			return false;
		}
		dz.options = Object.assign(dz.options, options);
		return this;
	}

	Dropzone.prototype.validateOptions = function (options) {
		if (typeof options == "undefined") {
			wglog.error('Error validateOptions: options must be defined');
			return false;
		}
		if (typeof options.id != "string") {
			wglog.error('Error validateOptions: options.id must be a string');
			return false;
		}
		if (typeof options.token != "string") {
			wglog.error('Error validateOptions: options.token must be a string');
			return false;
		}
		if (typeof options.classes != "undefined" && !(options instanceof Array)) {
			wglog.error('Error validateOptions: options.classes must be an array');
			return false;
		}
		if (typeof options.classes != "undefined" && (options instanceof Array)) {
			for (var i = 0, l = options.classes.length; i < l; i++) {
				if (typeof options.classes[i] != "string") {
					wglog.error('Error validateOptions: one of options.classes item is not a string');
					return false;
				}
			}
		}

		return true;
	}

	return Dropzone;
});
define('chat/scroll_conversation/scroll_conversation',[], function() {
	var instance = null;

	/**
	 * Scroll conversations utility class.
	 *
	 * @constructor
	 */
	var ScrollConversation = function() {
		if (instance !== null) {
			wglog.error("ScrollConversation::constructor", "Can not instantiate more than one instance, use ScrollConversation.getInstance();");
		}
	}

	ScrollConversation.prototype = {
		/**
		 * Scroll a conversation down to the bottom.
		 *
		 * When to scroll down a conversation ?
		 * - on conversation load with no unread message
		 * - on adding a temp message to the conversation (file upload message, vault message)
		 * - on receiving a new message to the conversation (all types)
		 *
		 * @param friendId {Number|String}
		 * @param scrollTopHeight {Number}
		 */
		down: function (friendId, scrollTopHeight) {
			var $conversation = $("#chat_group_messages_tab_" + friendId);

			if (!$conversation.length) {
				wglog.debug('ScrollConversation::down', 'No conversation found with id: ' + friendId);
				return;
			}

			var newScrollTopValue;

			if (typeof scrollTopHeight === "number") {
				newScrollTopValue = scrollTopHeight;
			} else {
				newScrollTopValue = parseInt($conversation[0].scrollHeight);
			}

			$conversation.scrollTop(newScrollTopValue);
		},

		downOrToFirstUnreadMarker: function (friendId) {
			if (this.getMarker(friendId).length) {
				this.toFirstUnreadMarker(friendId);
			} else {
				this.down(friendId);
			}
		},

		getMarker: function (friendId) {
			return $("#chat_group_messages_tab_" + friendId + ' .chat-messages__first-unread-message-marker');
		},

		getElementPosition: function (element) {
			var $element = $(element);
			var $parent = $element.parent();

			if (!$element.length) {
				return false;
			}

			var position = {};

			if ($parent.length) {
				var parentPos = $parent.get(0).getBoundingClientRect(),
					childPos = $element.get(0).getBoundingClientRect();

				position.top = childPos.top - parentPos.top;
				position.left = childPos.left - parentPos.left;
			} else {
				var childPos = $element.get(0).getBoundingClientRect();
				position.top = childPos.top;
				position.left = childPos.left;
			}

			return position;
		},

		getScrollTop: function(friendId) {
			return parseInt($("#chat_group_messages_tab_" + friendId).prop('scrollTop'));
		},

		isDown: function(friendId) {
			var $conversation = $("#chat_group_messages_tab_" + friendId);

			if (!$conversation.length) {
				wglog.debug('ScrollConversation::isDown', 'No conversation found with id: ' + friendId);
				return false;
			}
			var messagesContainerHtml = $conversation[0];

			return (Math.abs(messagesContainerHtml.scrollHeight - messagesContainerHtml.scrollTop - messagesContainerHtml.clientHeight) < 10);
		},

		/**
		 * Scroll a conversation down to the first unread message marker.
		 *
		 * When to scroll down to unread message marker ?
		 * - on conversation load with unread messages
		 *
		 * @param friendId
		 */
		toFirstUnreadMarker: function (friendId) {
			var $conversation = $("#chat_group_messages_tab_" + friendId);

			if (!$conversation.length) {
				wglog.debug('ScrollConversation::toFirstUnreadMarker', 'No conversation found with friendId: ' + friendId);
				return;
			}

			var $marker = this.getMarker(friendId);

			if (!$marker.length) {
				wglog.debug('ScrollConversation::scrollToFirstUnread', 'No marker found.');
				return;
			}

			var messagePositionTop = $marker[0].offsetTop || "0",
			    displayPositionTop = this.getElementPosition($marker.first().parents('.chat-message__display')).top || "0",
			    listItemPositionTop = this.getElementPosition($marker.first().parents('.chat-message')).top || "0",
			    height = parseInt(messagePositionTop) + parseInt(displayPositionTop) + parseInt(listItemPositionTop) - 16;
			this.down(friendId, height)
		},

		toMessage: function (messageId, highlight) {
			var $message = $(messageId);

			if (!$message.length) {
				wglog.debug('ScrollConversation::toMessage', 'No conversation found with messageId: ' + messageId);
				return;
			}

			if (highlight) {
				$message.find('.chat-message__message').addClass('chat-message__message--highlight');
				setTimeout(function () {
					$message.find('.chat-message__message').removeClass('chat-message__message--highlight');
				}, 2000);
			}

			$message.get(0).scrollIntoView();
		}
	}

	ScrollConversation.getInstance = function () {
		if (instance === null) {
			instance = new ScrollConversation();
		}

		return instance;
	}

	return ScrollConversation.getInstance();
});

define('text!chat/content/form.mustache',[],function () { return '<div class="chat-content-form">\n\t<h2>{{search_label}}</h2>\n\t{{{search_form}}}\n</div>';});


define('text!chat/content/form_fields.mustache',[],function () { return '<div id="{{vaultId}}" class="chat-vault">\n\t<div class="chat-vault__content-selector chat-content-field">\n\t\t<button class="chat-content-field__button btn btn--flat" id="{{vaultContentSelectionButtonId}}" type="button">{{buttonLabel}}</button>\n\t\t<span class="chat-content-field__selected">{{status}}</span>\n\t\t<input type="hidden" id="{{vaultContentIdFieldId}}">\n\t</div>\n\t{{#display_price_fields}}\n\t<div id="{{vaultContentPriceWrapperId}}" class="chat-vault__field-group input-group">\n\t\t<div class="input-group-prepend">\n\t\t\t<span class="input-group-text">$</span>\n\t\t</div>\n\t\t<input type="text" id="{{vaultContentPriceFieldId}}" inputmode="decimal" pattern="[0-9]*([,\\.][0-9]+)?" class="chat-vault__field chat-vault__field--price form-control" placeholder="Price">\n\t</div>\n\t{{/display_price_fields}}\n</div>\n';});


define('text!chat/content/form_fields_price.mustache',[],function () { return '<div id="{{vaultContentPriceWrapperId}}" class="chat-vault__field-group input-group">\n\t<div class="input-group-prepend">\n\t\t<span class="input-group-text">$</span>\n\t</div>\n\t<input type="text" id="{{vaultContentPriceFieldId}}" inputmode="decimal" pattern="[0-9]*([\\.][0-9]+)?" class="chat-vault__field chat-vault__field--price form-control" placeholder="{{ price }}">\n</div>';});


define('text!chat/content/message.mustache',[],function () { return '<div class="chat-content{{#classes}} {{classes}}{{/classes}}"{{#id}} id="{{id}}"{{/id}}>\n\t<div class="chat-content__thumb-wrapper{{#gallery_id}} chat-content__thumb-wrapper--gallery{{/gallery_id}}">\n\t{{#paidLabel}}\n\t\t<span class="chat-content__paid-tag{{#isPaid}} chat-content__paid-tag--active{{/isPaid}}">\n\t\t\t<svg class="chat-scc"><use xlink:href="#scc-dollar-icon-2"></use></svg>\n\t\t\t<span class="chat-content__paid-tag-label">{{paidLabel}}</span>\n\t\t</span>\n\t{{/paidLabel}}\n\t{{^galleryVisible}}\n\t\t{{#mediaType}}\n\t\t\t<span class="chat-content__file">\n\t\t\t\t{{#isImage}}<i class="fa fa-picture-o"></i>{{/isImage}}\n\t\t\t\t{{#isVideo}}<i class="fa fa-play"></i>{{#duration}} <span class="chat-content__duration">{{duration}}</span>{{/duration}}{{/isVideo}}\n\t\t\t</span>\n\t\t{{/mediaType}}\n\t{{/galleryVisible}}\n\t{{#thumb_url}}\n\t\t<img class="chat-content__thumb" src="{{thumb_url}}" alt="">\n\t{{/thumb_url}}\n\t{{#gallery_id}}<div class="chat-content__gallery">{{/gallery_id}}\n\t{{#galleryVisible}}\n\t\t<a\n\t\t\tclass="chat-content__gallery-item chat-content__gallery-item--{{type}}"\n\t\t\thref="{{url}}"\n\t\t\tdata-lightbox="{{gallery_id}}"\n\t\t\tdata-lightbox-thumb="{{thumb_url}}"\n\t\t\ttarget="_blank"\n\t\t\tdownload="{{filename}}"\n\t\t\t{{#more}} data-more="{{more}}"{{/more}}\n\t\t>\n\t\t\t<img src="{{thumb_url}}" alt="{{filename}}" onerror="this.style.display=\'none\'" />\n\t\t\t{{#file_video}}<span class="chat-content__file"><i class="fa fa-play"></i>{{#file_duration}} <span class="chat-content__duration">{{file_duration}}</span>{{/file_duration}}</span>{{/file_video}}\n\t\t</a>\n\t{{/galleryVisible}}\n\t{{#gallery_id}}</div>{{/gallery_id}}\n\t{{#galleryInvisible}}\n\t\t<a\n\t\t\tclass="chat-content__gallery-item chat-content__gallery-item--hidden"\n\t\t\thref="{{url}}"\n\t\t\tdata-lightbox="{{gallery_id}}"\n\t\t\tdata-lightbox-thumb="{{thumb_url}}"\n\t\t\ttarget="_blank"\n\t\t\tdownload="{{filename}}"\n\t\t>\n\t\t</a>\n\t{{/galleryInvisible}}\n\t</div>\n\t{{#showContentInner}}\n\t\t<div class="chat-content__inner">\n\t\t{{#showButton}}\n\t\t\t{{#link}}\n\t\t\t\t{{#label}}\n\t\t\t\t\t<a class="chat-content__button {{#deleted}} chat-content__button--deleted {{/deleted}}{{#disabled}} chat-content__button--disabled {{/disabled}}chat-btn{{#discount}} chat-content__button--discount{{/discount}}" target="_blank" {{#url}}href="{{url}}"{{/url}}>\n\t\t\t\t\t\t{{#discount}}<span class="chat-content__button-discount"><svg class="chat-scc"><use xlink:href="#scc-star-icon"></use></svg>{{discount}}</span>{{/discount}}\n\t\t\t\t\t\t{{label}}\n\t\t\t\t\t</a>\n\t\t\t\t{{/label}}\n\t\t\t{{/link}}\n\t\t\t{{^link}}\n\t\t\t\t<span class="chat-content__button {{#deleted}} chat-content__button--deleted {{/deleted}}{{#disabled}} chat-content__button--disabled {{/disabled}}chat-btn{{#discount}} chat-content__button--discount{{/discount}}">\n\t\t\t\t\t{{#discount}}<span class="chat-content__button-discount"><svg class="chat-scc"><use xlink:href="#scc-star-icon"></use></svg>{{discount}}</span>{{/discount}}\n\t\t\t\t\t{{label}}\n\t\t\t\t</span>\n\t\t\t{{/link}}\n\t\t\t{{#linkSubscribe}}\n\t\t\t\t<a class="chat-content__button chat-btn" target="_blank" {{#url}}href="{{url}}"{{/url}}>{{label}}</a>\n\t\t\t{{/linkSubscribe}}\n\t\t{{/showButton}}\n\t\t{{#title}}\n\t\t\t<div class="chat-content__title">{{{title}}}</div>\n\t\t{{/title}}\n\t\t{{#message}}\n\t\t\t<p class="chat-content__message">{{{message}}}</p>\n\t\t{{/message}}\n\t\t</div>\n\t{{/showContentInner}}\n</div>\n';});


define('text!chat/content/message_row.mustache',[],function () { return '<div class="chat-content-row">\n    <a href="{{edit_url}}" class="chat-content-row__anchor"{{#id}} id="{{id}}"{{/id}}>\n        <div class="chat-content-row__picture">\n            {{#thumb_url}}\n                <img class="chat-content-row__thumb" src="{{thumb_url}}" alt="" onerror="this.style.display=\'none\'" >\n            {{/thumb_url}}\n            {{#galleryVisible}}\n                <img class="chat-content-row__thumb" src="{{thumb_url}}" alt="{{filename}}" onerror="this.style.display=\'none\'" />\n            {{/galleryVisible}}\n        </div>\n        <div class="chat-content-row__body">\n            <div class="chat-content-row__title">{{{contentName}}}</div>\n            {{#hasMedias}}\n                <div class="chat-content-row__meta">\n                    {{#nbPhotos}}<div class="chat-content-row__meta-item">{{nbPhotosString}}</div>{{/nbPhotos}}\n                    {{#nbVideos}}<div class="chat-content-row__meta-item">{{nbVideosString}}</div>{{/nbVideos}}\n                </div>\n            {{/hasMedias}}\n        </div>\n    </a>\n    {{#message}}\n        <p class="chat-content-row__message">{{{message}}}</p>\n    {{/message}}\n</div>';});


define('text!chat/content/search_form.mustache',[],function () { return '<form id="{{contentSearchFormId}}" class="chat-content-form__search-form">\n\t<div class="chat-form-group">\n\t\t<input type="text" name="name" class="chat-content-form__field chat-content-form__field--search" id="{{contentSearchNameFieldId}}" placeholder="{{name_label}}">\n        <div class="chat-content-form__loader"><svg class="chat-scc chat-scc--spin"><use xlink:href="#scc-message-loader-icon" /></svg></div>\n\t</div>\n</form>\n\n<div id="{{contentSearchResultsId}}" class="chat-content-form__search-results">\n    <div class="chat-content-search">\n        <ul class="chat-content-search__results">{{{results}}}</ul>\n        <ul class="chat-content-search__meta">\n            <li class="chat-content-search__count">{{results_count}}</li>\n            <li><div class="chat-content-search__loader"><svg class="chat-scc chat-scc--spin"><use xlink:href="#scc-message-loader-icon" /></svg></div></li>\n        </ul>\n    </div>\n</div>';});


define('text!chat/content/search_results.mustache',[],function () { return '<li class="chat-media-item" data-content-id="{{content_id}}">\n    <div class="chat-media-item__thumb"{{#thumbnail.url}} style="--chat-media-item-thumb-bg-img: url({{thumbnail.url}})"{{/thumbnail.url}}></div>\n    <div class="chat-media-item__body">\n        <div class="chat-media-item__title">{{name}}</div>\n        <ul class="chat-media-item__meta">\n            {{#nb_texts}}<li>{{nb_texts}}</li>{{/nb_texts}}\n            {{#nb_photos}}<li>{{nb_photos}}</li>{{/nb_photos}}\n            {{#nb_videos}}<li>{{nb_videos}}</li>{{/nb_videos}}\n            {{#has_no_media}}<li>{{noMedia}}</li>{{/has_no_media}}\n            {{#release_date}}<li>{{release_date}}</li>{{/release_date}}\n            {{#total_files_size_humanize}}<li>{{total_files_size_humanize}}</li>{{/total_files_size_humanize}}\n        </ul>\n    </div>\n</li>\n';});

define('chat/content/content',[
    'log_and_tooltip',
    'mustache',
    'config/chat',
    'chat/attachment/attachment_manager',
    'chat/dropzone/dropzone',
    'chat/scroll_conversation/scroll_conversation',
    'lib/emoji',
    'lib/i18n!front',
    'lib/tools',
    'lib/utils',
    'libs/EventEmitter',
    'text!./form.mustache',
    'text!./form_fields.mustache',
    'text!./form_fields_price.mustache',
    'text!./message.mustache',
    'text!./message_row.mustache',
    'text!./search_form.mustache',
    'text!./search_results.mustache'
], function(
    LogAndTooltip,
    Mustache,
    config,
    AttachmentManager,
    Dropzone,
    ScrollConversation,
    emoji,
    i18n,
    tools,
    utils,
    EventEmitter,
    tpl_form,
    tpl_form_fields,
    tpl_form_fields_price,
    tpl_message,
    tpl_message_row,
    tpl_search_form,
    tpl_search_results
) {
    "use strict";

    var CONTENT_CREATION_TIME = {
        thresholdGb: 3,
        factorSecByGb: 9,
        calculateDuration: function (sizeGb) {
            return sizeGb * this.factorSecByGb;
        }
    };

    var SELECTORS = {
        searchButton:        '.chat-content__button',
        searchResults:       '.chat-content-search__results',
        searchResultsCount:  '.chat-content-search__count'
    };

    /**
     * Manage all vault related stuff (message form fields, content search)
     * @constructor
     */
    var Content = function(options) {
        var constructorName = this.constructor.name.toLowerCase();
        this.uid = Math.random().toString(32).substring(2);
        this.options = Object.assign(
            {socketEventType: 'content'},
            {
                contentSearchFormId: `chat-${constructorName}-search-form-${this.uid}`,
                contentSearchNameFieldId: `chat-${constructorName}-search-name-${this.uid}`,
                contentSearchResultsId: `chat-${constructorName}-search-results-${this.uid}`,
                dropzoneFieldId: 'chat-files',
                messageTextareaId: 'chat-textarea-message',
                vaultContentIdFieldId: `chat-${constructorName}-id-${this.uid}`,
                vaultContentPriceWrapperId: `chat-${constructorName}-price-wrapper-${this.uid}`,
                vaultContentPriceFieldId: `chat-${constructorName}-price-${this.uid}`,
                vaultContentSelectionButtonId: `chat-${constructorName}-select-${this.uid}`,
                vaultId: `chat-${constructorName}-${this.uid}`,
                vaultType: Content.TYPE_CONVERSATION,
            },
            options
        );
        this.i18nCustom = this.generateI18nCustomStrings();

        this.MEDIA_TYPE_TEXT = 'text';
        this.MEDIA_TYPE_IMAGE = 'image';
        this.MEDIA_TYPE_VIDEO_ONLY = 'only_video';
        this.MEDIA_TYPE_VIDEO = 'video';
        this.MEDIA_TYPES = [
            this.MEDIA_TYPE_IMAGE,
            this.MEDIA_TYPE_VIDEO_ONLY,
            this.MEDIA_TYPE_VIDEO
        ];

        this.PRELOAD_PREFIX = 'preload-';

        this.SEARCH_CONTENT_TIMEOUT = 500;
        this.SEARCH_IDLE = 'idle';
        this.SEARCH_LOADED = 'loaded';
        this.SEARCH_LOADING = 'loading';
        
        this.types = [
            {internal: this.MEDIA_TYPE_TEXT, label: i18n.__('chat.vault.content_type.text_only')},
            {internal: this.MEDIA_TYPE_IMAGE, label: i18n.__('chat.vault.content_type.photo_only')},
            {internal: this.MEDIA_TYPE_VIDEO_ONLY, label: i18n.__('chat.vault.content_type.video_only')},
            {internal: this.MEDIA_TYPE_VIDEO, label: i18n.__('chat.vault.content_type.video_photos')}
        ];

        this.html = Mustache.render(tpl_form, {
            search_label: i18n.__('chat.search_content'),
            search_form: Mustache.render(tpl_search_form, {
                contentSearchFormId: this.options.contentSearchFormId,
                contentSearchNameFieldId: this.options.contentSearchNameFieldId,
                contentSearchResultsId: this.options.contentSearchResultsId,
                name_label: i18n.__('chat.vault.filter_by_name'),
                results:'<li class="chat-content-search__waiting">' + i18n.__("chat.vault.waiting_for_results") + '</li>',
                results_count: i18n.__('chat.vault.count_results', {'%count%': 0}),
                submit_label: i18n.__('chat.button_search_friends'),
            })
        });

        this.contents = new Map();
        this.prices = {};
        this.hasContentSelected = false;
        this.selectedFriendIdProvider = null;
        this.messageFormActivation = null;
        this.messageEncrypter = null;
        this.messageProvider = null;

        this.socket = null;
        this.socketEvents = {
            CONTENT_CREATED: 'content_created',
            CONTENT_GET: 'content_get',
            CONTENT_FOUND: 'content_found',
            CREATE_CONTENT: 'create_content',
            CREATE_CONTENT_ERROR: 'content-content-create-error',
            CREATE_CONTENT_MASS_MESSAGE_ERROR: 'content-content-create-error.mass_message',
            CREATE_CONTENT_AUTO_MESSAGE_ERROR: 'content-content-create-error.auto_message',
            CREATOR_MESSAGE_CREATE_CONTENT: 'creator_message_content_create_content',
            DRAFT_DELETE: 'delete.draft',
            GET_CONTENT: 'get_content',
            GET_CONTENT_PRELOAD_MASS: 'get_content_preload.mass_message',
            GET_CONTENT_PRELOAD_AUTO: 'get_content_preload.auto_message',
            SEARCH_CONTENT: 'search_content',
            SEND_MESSAGE: 'send_message',
        };

        this.state = this.SEARCH_IDLE;
        this.searchItemsPerPage = 50;

        this.addListeners();
    }

    Object.defineProperties(Content, {
        TYPE_CONVERSATION: {value: 'conv', writable: false},
        TYPE_CREATOR_MESSAGES_MASS: {value: 'creator_messages_mass', writable: false},
        TYPE_CREATOR_MESSAGES_AUTO: {value: 'creator_messages_auto', writable: false}
    });

    Content.prototype = {
        addListeners: function () {
            $(document).on('click.chat-vault-select-' + this.uid, '#' + this.options.vaultContentSelectionButtonId, this.onChatVaultSelectClick.bind(this));
        },
        addStatContentViews: function(message) {
            var message_container = message.closest('.chat-message__id'),
                feature_event = !!message_container.data('mm') ? 'update_stats_mass_message' : 'update_stats_auto_message',
                data_stats = { stats: 'content_views' };

            if (feature_event === 'update_stats_mass_message') {
                data_stats.mass_message_id = parseInt(message_container.data('mm'));
            } else if (feature_event === 'update_stats_auto_message') {
                data_stats.auto_message_id = parseInt(message_container.data('am'));
            }

            var self = this;
            message.find(SELECTORS.searchButton).on('click', function() {
                self.socket.emit(feature_event, data_stats);
            });
        },
        removeListeners: function () {
            var doc = $(document);
            doc.off('click.chat-vault-select-' + this.uid);
            doc.off('submit.search-vault-content-' + this.uid);
            doc.off('keyup.search-vault-content-' + this.uid);
            doc.off('change.vault-type-filter-' + this.uid);
            doc.off('click.vault-content-media-item-' + this.uid);
            if (!this.socket) {
                return;
            }
            this.socket.off(this.socketEvents.CONTENT_CREATED, this.onSocketVaultContentCreated);
            this.socket.off(this.socketEvents.CONTENT_GET, this.onSocketVaultContentGet);
            this.socket.off(this.socketEvents.CONTENT_FOUND, this.onSocketVaultContentFound);
            this.socket.off("chat_error", this.onSocketChatError);
            delete this.onSocketChatError;
            delete this.onSocketVaultContentFound;
            delete this.onSocketVaultContentGet;
            delete this.onSocketVaultContentCreated;
        },
        detach: function () {
            this.removeListeners();
            this.selectedFriendIdProvider = null;
            this.messageFormActivation = null;
            this.messageEncrypter = null;
            this.messageProvider = null;
        },
        // camel case format is required by attachment manager
        add_to_conversation: function (friendId, contentId) {
            if (!this.isPriceValid()) {
                return;
            }

            var messageData = this.getMessageData(friendId, contentId);

            if (messageData) {
                this.messageFormDeactivated = true;
                this.setMessageFormActivationDisabledState(true);
                this.socket.emit(this.socketEvents.SEND_MESSAGE, messageData);
                EventEmitter.emit(this.socketEvents.DRAFT_DELETE, this.selectedFriendIdProvider());
            }
        },
        addContentSearchListeners: function () {
            var doc = $(document);

            this.onSocketVaultContentFound = this.onSocketVaultContentFound.bind(this);
            this.socket.on(this.socketEvents.CONTENT_FOUND, this.onSocketVaultContentFound);

            doc.on('submit.search-vault-content-' + this.uid, '#' + this.options.contentSearchFormId, this.onSearchContentSubmit.bind(this));
            doc.on('keyup.search-vault-content-' + this.uid, '#' + this.options.contentSearchFormId, this.onSearchContentKeyup.bind(this));
            doc.on('change.vault-type-filter-' + this.uid, '#' + this.options.contentSearchFormId + ' [id^=vault-type-filter]', this.onSearchContentChange.bind(this));
            doc.on('click.vault-content-media-item-' + this.uid, '#' + this.options.contentSearchResultsId + ' .chat-media-item', this.onSearchResultClick.bind(this));
        },

        removeContentSearchListeners: function () {
            var doc = $(document);
            doc.off('submit.search-vault-content-' + this.uid);
            doc.off('keyup.search-vault-content-' + this.uid);
            doc.off('change.vault-type-filter-' + this.uid);
            doc.off('click.vault-content-media-item-' + this.uid);
            this.socket.off(this.socketEvents.CONTENT_FOUND, this.onSocketVaultContentFound);
        },
        preserveScrollDownOnImageLoad: function (message) {
            message.data('preserveScrollDownOnImageLoad', true);
        },
        canProcess: function () {
            var dropzone = this.getDropzone();

            if (!dropzone || !dropzone.files) {
                return;
            }

            var files = dropzone.files.filter(file => file.status === "success"),
                type = this.determineVaultContentType(files);

            return type !== "";
        },
        clearMessageFormFields: function (cancelUploads) {
            this.hasContentSelected = false;
            this.emptyDropzone(cancelUploads);
            $('#' + this.options.vaultContentSelectionButtonId + ' + .chat-content-field__selected').text(i18n.__('chat.no_content_selected'));
            $('#' + this.options.vaultContentIdFieldId).val(null);
            $('#' + this.options.vaultContentPriceFieldId).val(null);
            this.emptyMessageForm();
            this.triggerContentSelectorChangeEvent();
            LogAndTooltip.popup_close();
        },
        createContent: function () {
            if (!this.isVaultReady() || !this.isPriceValid()) {
                return;
            }

            this.setMessageFormActivationDisabledState(true, this.tryCreateContent.bind(this));
            this.messageFormDeactivated = true;
        },
        tryCreateContent: function () {
            var data = this.getCreateContentData();

            if (data) {
                this.creationTimeWarningSetup();
                this.socket.emit(this.socketEvents.CREATE_CONTENT, data);
            }
        },
        creationTimeWarningSetup: function () {
            var dropzone = this.getDropzone();

            if (!dropzone || !dropzone.files || !dropzone.files.length) {
                return;
            }

            var files = dropzone.files.filter(file => file.status === "success");

            if (files.length === 0) {
                return;
            }

            var oneGb = 1024 * 1024 * 1024,
                totalSizeInGb = files.reduce((acc, file) => acc + file.size, 0) / oneGb;

            if (totalSizeInGb < CONTENT_CREATION_TIME.thresholdGb) {
                return;
            }

            this.creationTimeWarningDisplay(totalSizeInGb);
        },
        creationTimeWarningGetMessage: function (duration) {
            var formattedDuration = tools.formatDuration(duration);
            return i18n.__('chat.vault.creation_time_remaining', {'%duration%': formattedDuration});
        },
        creationTimeWarningDisplay: function (totalSizeInGb) {
            var durationApproximation = CONTENT_CREATION_TIME.calculateDuration(totalSizeInGb),
                contentId = 'chat-vault-creation-time-warning',
                contentMessage = this.creationTimeWarningGetMessage(durationApproximation),
                content = '<span id="' + contentId + '">' + contentMessage + '</span>';

            this.creationTimeWarningDuration = durationApproximation;

            LogAndTooltip.popup_open($('#chat-send-btn'), content, {
                autoclose: false,
                closebtn: true,
                offset: {above: 8},
                position: {v: 'above', h: 'right'},
                relative_to: $('.chat-window__overlay-container')
            });

            var self = this;

            if (this.creationTimeWarningInterval) {
                clearInterval(this.creationTimeWarningInterval);
            }

            this.creationTimeWarningInterval = setInterval(function () {
                if (!self.creationTimeWarningDuration) {
                    LogAndTooltip.popup_close();
                    clearInterval(self.creationTimeWarningInterval);
                    self.creationTimeWarningInterval = null;
                    return;
                }

                var warning = $('#' + contentId);

                if (!warning.length) {
                    return;
                }

                self.creationTimeWarningDuration--;
                warning.text(self.creationTimeWarningGetMessage(self.creationTimeWarningDuration));
            }, 1000);
        },
        /**
         * This method tries to determine the vault content type based on dropzone files array given.
         *
         * Rules:
         * - 1 video + x images = this.MEDIA_TYPE_VIDEO
         * - x photos = this.MEDIA_TYPE_IMAGE
         * - x videos = this.MEDIA_TYPE_VIDEO_ONLY
         *
         * @param files
         * @returns {string}
         */
        determineVaultContentType: function (files) {
            var counts = {};

            files.forEach((file) => {
                var main = file.type.split('/')[0];
                counts[main] = (counts[main] || 0) + 1;
            });

            var types = Object.keys(counts);
            var first = types[0];

            if (types.length === 1 && this.MEDIA_TYPES.indexOf(first) > -1) {
                return first === this.MEDIA_TYPE_VIDEO ? this.MEDIA_TYPE_VIDEO_ONLY : first;
            } else if (counts[this.MEDIA_TYPE_VIDEO] === 1 && counts[this.MEDIA_TYPE_IMAGE]) {
                return this.MEDIA_TYPE_VIDEO;
            }

            return "";
        },
        displayLoader: function () {
            if (this.state === this.SEARCH_LOADING) {
                return;
            }

            $('#' + this.options.contentSearchResultsId + ' .chat-content-search').addClass('chat-content-search--loading');
            $('#' + this.options.contentSearchResultsId).prev().addClass('chat-content-form__search-form--loading');

            this.state = this.SEARCH_LOADING;
        },
        displayResults: function (data) {
            if (this.lastResultIntersectionObserver) {
                this.lastResultIntersectionObserver.disconnect();
            }

            this.contentSearchPage = data.page;
            var results = this.prepareResults(data.result),
                resultsWrapper = $('#' + this.options.contentSearchResultsId),
                resultsList = resultsWrapper.find(SELECTORS.searchResults),
                self = this;

            resultsWrapper.find('.chat-content-search').removeClass('chat-content-search--loading');
            resultsWrapper.prev().removeClass('chat-content-form__search-form--loading');

            if (this.contentSearchPage === 1) {
                resultsList.empty();

                if (results.length === 0) {
                    resultsList.append('<li class="chat-content-search__waiting">' + i18n.__('chat.no_results') + '</li>');
                    resultsWrapper.find(SELECTORS.searchResultsCount).text(i18n.__('chat.vault.count_results', {"%count%": 0}));
                    return;
                }
            }

            results.map(function (result) {
                resultsList.append(Mustache.render(tpl_search_results, result));
            });

            if (data.hasOwnProperty('total')) {
                var resultsCount = i18n.__(data.total === 1 ? 'chat.vault.one_result' : 'chat.vault.count_results', {"%count%": data.total});
                resultsWrapper.find(SELECTORS.searchResultsCount).text(resultsCount);
            }

            if (results.length >= this.searchItemsPerPage) {
                this.lastResultIntersectionObserver = new IntersectionObserver(function (entries, observer) {
                    entries.forEach(function (entry) {
                        if (entry.isIntersecting) {
                            observer.unobserve(entry.target);
                            self.searchContentEmit(resultsWrapper.prev().get(0), self.contentSearchPage+1);
                        }
                    });
                }, {
                    root: resultsWrapper.find(SELECTORS.searchResults).get(0),
                    rootMargin: '0px 0px 600px 0px',
                    threshold: 0
                });

                this.lastResultIntersectionObserver.observe(resultsWrapper.find('.chat-media-item').last().get(0));
            }

            this.state = this.SEARCH_LOADED;
        },
        emptyDropzone: function (cancelUploads) {
            var dropzone = this.getDropzone();

            dropzone.removeAllFiles(cancelUploads);
            dropzone.emit("reset");
        },
        fillMessageFormFields: function (data) {
            this._originalFillMessageFormFields(data);
        },
        _originalFillMessageFormFields: function (data) {
            this.hasContentSelected = !!data.content_id;
            $('#' + this.options.vaultContentSelectionButtonId + ' + .chat-content-field__selected').text(data.name);
            $('#' + this.options.vaultContentIdFieldId).val(data.content_id);
            $('#' + this.options.vaultContentPriceFieldId).val(data.buy_button.price || "");
            this.setMessageFormTextareaValue(data);
            this.triggerContentSelectorChangeEvent();
        },
        formatDate: function (timestamp) {
            var date = new Date(timestamp * 1000);
            return new Intl.DateTimeFormat(config.local).format(date);
        },
        generateI18nCustomStrings: function () {
            return {
                contentSelectorButtonLabel: i18n.__('chat.content.select_a_content')
            }
        },
        getContentSelector: function () {
            return $('#' + this.options.vaultId +' .chat-vault__content-selector');
        },
        getCreateContentData: function () {
            var dropzone = this.getDropzone();

            if (!dropzone || !dropzone.files) {
                return;
            }

            var files = dropzone.files.filter(file => file.status === "success"),
                type = this.determineVaultContentType(files),
                self = this;

            if (!type) {
                wglog.error('Content::getCreateContentData', 'unable to determine content type to create');
                LogAndTooltip.write_error({
                    logTitle: 'Content::getCreateContentData Bad content type',
                    message: "Unable to create a content with this file. Please:<ul><li>add only photos to create a photo only content;</li><li>add only videos to create a content for each video;</li><li>add a video and photos to create a video+photo content.</li></ul>",
                    closable: true,
                    on_close: function () {
                        self.setMessageFormActivationDisabledState(false);
                    }
                });
                this.setMessageFormActivationDisabledState(false);
                return;
            }

            return {
                type: type,
                price: +$('#' + this.options.vaultContentPriceFieldId).val(),
                uploads: files.map(file => file.upload.uuid)
            };
        },
        getDropzone: function () {
            return $('#' + this.options.dropzoneFieldId).prop('dropzone');
        },
        // camel case format is required by attachment manager
        get_field: function (displayPrice) {
            var params = {
                vaultContentIdFieldId: this.options.vaultContentIdFieldId,
                vaultContentPriceWrapperId: this.options.vaultContentPriceWrapperId,
                vaultContentPriceFieldId: this.options.vaultContentPriceFieldId,
                vaultContentSelectionButtonId: this.options.vaultContentSelectionButtonId,
                vaultId: this.options.vaultId,
                buttonLabel: this.i18nCustom.contentSelectorButtonLabel,
                display_price_fields: displayPrice || false,
                status: i18n.__('chat.no_content_selected')
            };
            return Mustache.render(tpl_form_fields, params);
        },
        getMessageData: function (friendId, contentId) {
            friendId = friendId || false;
            contentId = contentId || $('#' + this.options.vaultContentIdFieldId).val();

            if (!contentId) {
                wglog.error('Content::getMessageData', 'contentId not defined or unknown');
                return;
            }

            var price = +$('#' + this.options.vaultContentPriceFieldId).val();

            var message_json = {c: contentId};
            var message = this.messageProvider();
            if (message) {
                message_json.m = message;
            }
            var message_encrypted = this.messageEncrypter(JSON.stringify(message_json), "make it clear");

            var data = Object.assign({
                'message': message_encrypted,
                'is_content': true,
                'is_vault': false,
                'content_id': contentId,
                'price': price
            }, this.getMessageDataOverrides());

            if (friendId) {
                data.recipient_id = friendId;
            }

            return data;
        },
        getMessageDataOverrides: function () {
            return {};
        },
        getMessageHtml: function (params, style) {
            var options = Object.assign({
                classes: "",
                thumb_url: "",
                disabled: true,
                link: {
                    label: i18n.__("chat.vault.getting_infos"),
                    url: "",
                },
                message: '',
                showContentInner: true
            }, params);

            var tpl = tpl_message;

            if (style && style === 'row') {
                tpl = tpl_message_row;
            }

            return Mustache.render(tpl, options);
        },
        getMessageText: function (message) {
            return '<svg class="chat-scc chat-scc--content"><use xlink:href="#scc-message-icon"></use></svg> ' + (message ? utils.escapeHtml(message) : i18n.__('chat.vault.checkout_post'));
        },
        getPriceField: function () {
            if (!config.login_info.is_creator) {
                return "";
            }

            return Mustache.render(tpl_form_fields_price, {
                vaultContentPriceWrapperId: this.options.vaultContentPriceWrapperId,
                vaultContentPriceFieldId: this.options.vaultContentPriceFieldId,
                'price': i18n.__('chat.vault.price', {
                    '%price_min%': config.file_upload.ppc.min.toString(),
                    '%price_max%': config.file_upload.ppc.max.toString()
                })
            });
        },
        getTempContent: function (message, title, tempIdPrefix) {
            title = utils.escapeHtml(title || "");
            message = utils.escapeHtml(message || "");

            var tempId = (tempIdPrefix ? tempIdPrefix + "-" : "id-") + Math.random().toString(32).substring(2);
            var html = this.getMessageHtml({
                classes: "chat-content--loading-" + tempId,
                title: title,
                message: emoji.utf8ToHtml(message).replace(new RegExp('\n', 'g'), '<br>')
            });

            return {html: html, id: tempId};
        },
        getTempContentHtml: function (json, info, tempIdPrefix, style) {
            if (info) {
                info.message_other_classes = "chat-message--content" + (typeof style === 'string' ? '-' + style : '');
            }

            var tempContent = this.getTempContent(json.m, json.t, tempIdPrefix);
            var fanId = config.login_info.is_creator && info ? info.friend_id : undefined;
            var massMessageId = info ? info.id_mass_message : undefined;
            var autoMessageId = info ? info.id_auto_message : undefined;
            var messageId = info ? info.message_id : undefined;

            this.requestContent([{id: json.c, temp_id: tempContent.id}], fanId, massMessageId, autoMessageId, messageId);

            return tempContent.html;
        },
        getPrivateText: function () {
            wglog.error('Content::getPrivateText', 'override this method');
            return '';
        },
        getText: function () {
            wglog.error('Content::getText', 'override this method');
            return '';
        },
        getTitle: function () {
            wglog.error('Content::getTitle', 'override this method');
            return '';
        },
        isConversationVault: function () {
            return this.options.vaultType === Content.TYPE_CONVERSATION;
        },
        isCreatorMessageVault: function () {
            return (this.options.vaultType === Content.TYPE_CREATOR_MESSAGES_MASS) || (this.options.vaultType === Content.TYPE_CREATOR_MESSAGES_AUTO);
        },
        isPriceValid: function() {
            var price = $('#' + this.options.vaultContentPriceFieldId).val();

            if ((price === '' || price === '0' || price === 0) || (price >= config.file_upload.ppc.min && price <= config.file_upload.ppc.max)) {
                return true;
            }

            wglog.error('Content::isPriceValid', 'price is invalid');
            LogAndTooltip.write_error({logTitle: 'Content::isPriceValid price is invalid', message: '<p>' + i18n.__('chat.vault.price_error', {
                    '%price_min%': config.file_upload.ppc.min.toString(),
                    '%price_max%': config.file_upload.ppc.max.toString(),
                })+'</p>', closable: true});
            return false;

        },
        isVaultReady: function () {
            if (!this.socket) {
                wglog.error('Content::isVaultReady', 'socket undefined');
                return false;
            }
            if (this.socket.disconnected) {
                wglog.error('Content::isVaultReady', 'socket disconnected');
                return false;
            }
            if (typeof this.messageFormActivation !== "function") {
                wglog.error('Content::isVaultReady', 'messageFormActivation is not a function');
                return false;
            }
            if (typeof this.messageEncrypter !== "function") {
                wglog.error('Content::isVaultReady', 'messageEncrypter is not a function');
                return false;
            }
            if (typeof this.messageProvider !== "function") {
                wglog.error('Content::isVaultReady', 'messageProvider is not a function');
                return false;
            }
            if (typeof this.emptyMessageForm !== "function") {
                wglog.error('Content::isVaultReady', 'emptyMessageForm is not a function');
                return false;
            }
            if (typeof this.selectedFriendIdProvider !== "function") {
                wglog.error('Content::isVaultReady', 'selectedFriendIdProvider is not a function');
                return false;
            }

            return true;
        },
        creatorMessageCreateContent: function (message_params) {
            var data = this.getCreateContentData(),
                title = this.getTitle();

            if (!data) {
                return;
            }

            if (title) {
                data.title = title;
            }

            if (typeof message_params !== 'undefined') {
                data.message_params = message_params;
            }

            this.socket.emit(this.socketEvents.CREATOR_MESSAGE_CREATE_CONTENT, data);
        },
        creatorMessageCreateTextContent: function () {
            var text = this.getPrivateText();

            if (!text) {
                wglog.error('Content::massMessageCreateTextContent', 'No text found.');
                return;
            }

            var data = {
                type: this.MEDIA_TYPE_TEXT,
                price: +$('#' + this.options.vaultContentPriceFieldId).val(),
                uploads: [],
                title: this.getTitle(),
                description: text
            };

            this.socket.emit(this.socketEvents.CREATOR_MESSAGE_CREATE_CONTENT, data);
        },
        creatorMessageGetMessageFromBackEndResponse: function (data) {
            var ids = [];
            if (typeof data.result.content_ids !== "undefined") {
                ids = Array.isArray(data.result.content_ids) ? data.result.content_ids : [data.result.content_ids];
            } else if (data.contents) {
                ids = Array.isArray(data.contents.ids) ? data.contents.ids : [data.contents.ids];
            }

            return this.creatorMessageGetMessage(ids.pop());
        },
        creatorMessageGetMessage: function (contentId) {
            contentId = contentId || $('#' + this.options.vaultContentIdFieldId).val();

            if (!contentId) {
                wglog.error('Content::massMessageGetMessage', 'contentId not defined or unknown');
                return;
            }

            var price = +$('#' + this.options.vaultContentPriceFieldId).val();

            var message_json = {c: contentId},
                text = this.getText(),
                title = this.getTitle();

            if (text) {
                message_json.m = text;
            }
            if (title) {
                message_json.t = title;
            }

            var data = {
                'message': this.messageEncrypter(JSON.stringify(message_json), "make it clear"),
                'is_content': true,
                'is_vault': true,
                'content_id': contentId
            };

            if (price) {
                data.price = price;
            }

            return data;
        },

        prepareMessageHtmlParamsError: function (params, labelI18n) {
            params.link.label = i18n.__(labelI18n || 'error');
            params.link.disabled = true;
            return params;
        },

        prepareMessageHtmlParams: function (content, temp) {
            var base       = this.buildMessageBaseParams(content, temp);
            var params     = base.params;
            var hasTitle   = base.hasTitle;
            var hasMessage = base.hasMessage;

            if (!content) {
                wglog.error('Content::prepareMessageHtmlParams', 'content is undefined');
                return this.prepareMessageHtmlParamsError(params);
            }

            this.buildMessageMediaParams(params, content);
            this.buildMessageMediaCountParams(params, content);
            this.buildMessagePaidParams(params, content);
            this.buildMessageEditParams(params, content);

            var processingParams = this.buildMessageProcessingParams(params, content);
            if (processingParams) {
                return processingParams;
            }

            if (content.has_access && content.media_type !== this.MEDIA_TYPE_TEXT && !params.hasMedias) {
                wglog.error('Content::prepareMessageHtmlParams', 'The content is accessible but there is no photo or video urls.', content);
                return this.prepareMessageHtmlParamsError(params, 'chat.vault.content_unavailable');
            }

            var linkParams = this.buildMessageLinkParams(params, content);
            if (linkParams) {
                return linkParams;
            }

            this.buildMessageGalleryParams(params, content);
            this.buildMessageAccessRestrictionsParams(params, content);

            params.showContentInner = params.showButton || hasTitle || hasMessage;
            return params;
        },

        buildMessageBaseParams: function (content, temp) {
            var params = {
                classes: "",
                id: config.login_info.is_fan ? `content-${config.login_info.id}-${content.content_id}` : "",
                thumb_url: "",
                link: { disabled: false, label: "", url: "" },
                title:   temp.find('.chat-content__title').html()   || "",
                message: temp.find('.chat-content__message').html() || "",
                contentName: content.name,
                showButton:   true,
                showContentInner: false
            };
            return {
                params:     params,
                hasTitle:   !!params.title,
                hasMessage: !!params.message
            };
        },

        buildMessageMediaParams: function (params, content) {
            if (content.hasOwnProperty('thumbnail') && content.thumbnail.url) {
                params.thumb_url = content.thumbnail.url;
            } else {
                params.classes += " chat-content--no-thumb";
            }

            if (content.media_type === 'image' || content.media_type === 'only_image') {
                params.mediaType = true;
                params.isImage = true;
            }
            else if (
                (content.media_type === 'video' || content.media_type === 'only_video') &&
                content.duration > 0
            ) {
                params.mediaType = true;
                params.isVideo = true;
                params.duration = tools.format_duration(content.duration * 1000);
            }

            params.classes += " chat-content--" + content.media_type;
        },

        buildMessageMediaCountParams: function (params, content) {
            var hasImages = (content.hasOwnProperty('nb_photos') && content.nb_photos) || (content.chat_files.hasOwnProperty('photos'));
            var hasVideo  = (content.hasOwnProperty('nb_videos') && content.nb_videos) || (content.chat_files.hasOwnProperty('video'));

            params.nbPhotos = 0;
            params.nbVideos = 0;
            params.nbPhotosString = "";
            params.nbVideosString = "";
            params.hasMedias = false;

            if (hasImages) {
                params.nbPhotos = content.nb_photos || Object.values(content.chat_files.photos || {}).length;
                params.nbPhotosString = i18n.plural('chat.vault.one_photo', 'chat.vault.count_photos', params.nbPhotos, "%count%");
                params.hasMedias = true;
            }

            if (hasVideo) {
                params.nbVideos = content.nb_videos || Object.values(content.chat_files.video || {}).length;
                params.nbVideosString = i18n.plural('chat.vault.one_video', 'chat.vault.count_videos', params.nbVideos, "%count%");
                params.hasMedias = true;
            }
        },

        buildMessagePaidParams: function (params, content) {
            if (config.login_info.is_creator && content.hasOwnProperty('paid') && content.hasOwnProperty('fan_price')) {
                params.isPaid = !!content.paid;
                if (content.fan_price) {
                    var disp = content.buy_button && content.buy_button.display_price;
                    if (content.paid) {
                        params.paidLabel = i18n.__('chat.vault.bought_by_fan', { '%price%': disp });
                    } else {
                        params.paidLabel = i18n.__('chat.vault.not_bought_by_fan', { '%price%': disp });
                    }
                } else {
                    params.paidLabel = false;
                }
            }
        },

        buildMessageEditParams: function (params, content) {
            if (content.edit_url) {
                params.edit_url = content.edit_url;
            }
        },

        buildMessageProcessingParams: function (params, content) {
            if (content.processing && content.paid) {
                params.link.label = i18n.__('chat.vault.processing');
                params.link.disabled = true;
                return params;
            }
            if (content.has_access && content.processing && params.nbPhotos) {
                content.processing = false;
            }
        },

        buildMessageLinkParams: function (params, content) {
            if (content.media_type === this.MEDIA_TYPE_TEXT) {
                params.showButton = false;
                return;
            }

            var isMassMessageRelated = content.buy_button &&
                content.buy_button.url.indexOf('mass_message_id') > -1;

            var pageUrl = isMassMessageRelated ? content.buy_button.url : (content.post_page_url || "");

            if (content.price_mode) {
                content.price_mode = content.price_mode.split(',');
            }

            if (content.has_access) {
                params.classes += " chat-content--has-access";
                params.link.label = i18n.__('chat.vault.view_content');
                params.link.url = pageUrl;
                if (config.login_info.is_fan && content.buy_button && content.buy_button.discount) {
                    params.discount = content.buy_button.discount;
                }
                return;
            }

            if (content.buy_button && content.buy_button.display_price) {
                var disp = content.buy_button.display_price,
                    price = parseInt(content.buy_button.price, 10) || 0;

                if (price > 0) {
                    params.link.label = i18n.__('chat.vault.buy_for', { '%price%': disp });
                    params.link.url   = content.buy_button.url || "";
                    if (config.login_info.is_fan && content.buy_button && content.buy_button.discount) {
                        params.discount = content.buy_button.discount;
                    }
                    return;
                }
            }

            if (content.subscription_button && content.subscription_button.subscription_price && content.is_post_page_available) {
                if (content.price_mode.length === 1) params.link.label = false;

                if (!params.linkSubscribe) params.linkSubscribe = {};
                params.linkSubscribe.label = i18n.__('chat.subscribe_price', {'%price%': content.subscription_button.subscription_price});
                params.linkSubscribe.url = content.subscription_button.profile_url;
                return;
            }

            wglog.error('Content::prepareMessageHtmlParams', 'Impossible to retrieve content: the back-end should set content.has_access to true.', content);
            return this.prepareMessageHtmlParamsError(params);
        },

        buildMessageGalleryParams: function (params, content) {
            if (!content.has_access) {
                return;
            }
            var cf = content.chat_files || {},
                visible = [], invisible = [], video, extra;

            if (cf.video && Object.keys(cf.video).length) {
                if (cf.video['1080p']) { video = cf.video['1080p']; }
                else if (cf.video.web) { video = cf.video.web; }
                else if (cf.video.upload) { video = cf.video.upload; }
                else if (cf.video.master) { video = cf.video.master; }
                else { video = cf.video[Object.keys(cf.video)[0]]; }
                video.file_video    = true;
                video.file_duration = params.duration;
                visible.push(video);
            }

            visible = visible.concat(Object.values(cf.photos || {}));

            if (visible.length > 4) {
                extra = visible.length - 4;
                invisible = visible.splice(4, extra);
                visible[3].more = '+' + extra;
            }

            params.showButton = (visible.length === 0);
            params.thumb_url = '';
            params.gallery_id = visible.length ? 'id-' + Math.random().toString(32).substring(2) + '-' + content.content_id : false;
            params.galleryVisible = visible;
            params.galleryInvisible = invisible;
        },

        buildMessageAccessRestrictionsParams: function (params, content) {
            if (config.login_info.is_fan && !content.has_access && !content.is_preview_allowed) {
                params.classes += " chat-content--locked";
            }
        },

        onChatVaultSelectClick: function () {
            var modal = LogAndTooltip.modal(this.html, {closable: true, scrollTo: false}, false),
                self = this;

            modal.body.addClass('chat-vault-modal');
            modal.onClose = function () {
                self.removeContentSearchListeners();
                if (self.lastResultIntersectionObserver) {
                    self.lastResultIntersectionObserver.disconnect();
                    self.lastResultIntersectionObserver = null;
                }
            }

            this.last_search = null;
            this.addContentSearchListeners();
            modal.body.find('.chat-content-form__field--search').focus();
            this.contentSearchPage = 1;
            this.searchContentEmit(modal.body.find('form').get(0));
        },
        onSearchContentChange: function (event) {
            var filters = $('#' + this.options.contentSearchFormId + ' [id^=vault-type-filter]');
            if (filters.length === 1 && filters[0] === event.target && event.target.checked) {
                event.target.checked = false;
            }
        },
        onSearchContentKeyup: function (event) {
            if (event.key === 'Enter' || event.keyCode === 13) {
                return;
            }

            var form = $(event.target).parents('form').get(0);

            if (!form) {
                wglog.error('Content::onSearchContentKeyup', 'Form not found');
                return;
            }

            this.setSearchContentTimeout(form);
        },
        onSearchContentSubmit: function (event) {
            event.preventDefault();

            this.searchContentEmit(event.target);
        },
        onSearchResultClick: function (event) {
            var id = $(event.currentTarget).data('contentId').toString();

            this.fillMessageFormFields(this.contents.get(+id));
            LogAndTooltip.close_last_overlay();
        },
        onSocketChatError: function (data) {
            if (!data.code) {
                return;
            }

            var code = data.code;
            if (typeof code === "number") {
                code = code.toString();
            }

            if (data.source && typeof data.source.indexOf === 'function' && data.source.indexOf('mass_message_vault') > -1) {
                if (this.options.vaultType === 'creator_messages_mass') {
                    EventEmitter.emit(this.socketEvents.CREATE_CONTENT_MASS_MESSAGE_ERROR, data);
                }
                if (this.options.vaultType === 'creator_messages_auto') {
                    EventEmitter.emit(this.socketEvents.CREATE_CONTENT_AUTO_MESSAGE_ERROR, data);
                }
            }
            else {
                if (["60013", "60014"].indexOf(code) > -1 || code.indexOf("613") === 0 || code.indexOf("614") === 0 || code.indexOf("615") === 0) {
                    this.setMessageFormActivationDisabledState(false);
                }
            }
        },
        onSocketVaultContentCreated: function (data) {
            if (typeof data.result === "undefined" && typeof data.contents === "undefined") {
                wglog.error('Content::onSocketVaultContentCreated', 'No contents found');
                return;
            }

            var ids = [];
            if (typeof data.result.content_ids !== "undefined") {
                ids = data.result.content_ids;
            } else if (data.contents) {
                ids = data.contents.ids;
            }

            var selectedFriendId = this.selectedFriendIdProvider();
            for (var index in ids) {
                this.add_to_conversation(selectedFriendId, ids[index]);
            }

            this.emptyDropzone();
            this.clearMessageFormFields();
        },
        onSocketVaultContentGet: function (data) {
            this.registerContents(data.contents);

            if (!data.source) {
                return;
            }
            if (data.source !== this.options.vaultType && data.source !== (this.PRELOAD_PREFIX + this.options.vaultType)) {
                return;
            }

            if (this.isConversationVault()) {
                this.replaceConversationTempContent(data.contents);
            } else if (this.isCreatorMessageVault()) {
                if (data.source === (this.PRELOAD_PREFIX + this.options.vaultType)) {
                    if (this.options.vaultType === 'creator_messages_mass') {
                        EventEmitter.emit(this.socketEvents.GET_CONTENT_PRELOAD_MASS, data.contents);
                    }
                    if (this.options.vaultType === 'creator_messages_auto') {
                        EventEmitter.emit(this.socketEvents.GET_CONTENT_PRELOAD_AUTO, data.contents);
                    }
                }
                else {
                    this.replaceMassMessageTempContent(data.contents);
                }
            }
        },
        onSocketVaultContentFound: function (data) {
            if (typeof data === "string" && data === "error") {
                wglog.error('Content::onSocketVaultContentFound Error during search', 'Error during search', data);
                LogAndTooltip.write_error('Content::onSocketVaultContentFound', 'Error during search');
                this.displayResults([]);
            } else {
                this.registerContents(data.result);
                this.displayResults(data);
            }
        },
        prepareResults: function (results) {
            for (var id in results) {
                if (!results[id].chat_files) {
                    continue;
                }

                var item = results[id],
                    nb_texts = 0,
                    nb_photos = 0,
                    nb_videos = 0;

                var files = [];

                if (item.chat_files.video) {
                    var file = null;

                    for (var resolution in item.chat_files.video) {
                        if (!file) {
                            file = Object.assign({}, item.chat_files.video[resolution]);
                            delete file.resolution;
                            delete file.url;
                            file.urls = {};
                        }

                        file.urls[resolution] = item.chat_files.video[resolution].url;
                    }

                    files.push(file);
                }

                if (item.chat_files.photos) {
                    for (var f in item.chat_files.photos) {
                        files.push(item.chat_files.photos[f]);
                    }
                }

                if (!item.chat_files.video && !item.chat_files.photos) {
                    files = Object.values(item.chat_files);
                }

                for (var fileId in files) {
                    if (files[fileId].type === "text") nb_texts++;
                    if (files[fileId].type === "image") nb_photos++;
                    if (files[fileId].type === "video") nb_videos++;
                }

                item.nb_texts = nb_texts ? i18n.plural('chat.vault.one_text', 'chat.vault.count_texts', nb_texts, "%count%") : '';
                item.nb_photos = nb_photos ? i18n.plural('chat.vault.one_photo', 'chat.vault.count_photos', nb_photos, "%count%") : '';
                item.nb_videos = nb_videos ? i18n.plural('chat.vault.one_video', 'chat.vault.count_videos', nb_videos, "%count%") : '';
                item.has_no_media = false;

                if ((item.media_type === this.MEDIA_TYPE_VIDEO || item.media_type === this.MEDIA_TYPE_VIDEO_ONLY) && Object.values(item.chat_files.video || {}).length === 0) {
                    item.has_no_media = true;
                }
                else if (item.media_type === this.MEDIA_TYPE_IMAGE && Object.values(item.chat_files.photos || {}).length === 0) {
                    item.has_no_media = true;
                }

                results[id] = item;
            }

            return Object.values(results);
        },
        refreshMessage: function (data) {
            if (!data || !data.id || !data.content || !data.content.content_id) {
                return;
            }

            var userId = data.id,
                contentId = data.content.content_id,
                existingContent = $(`#content-${userId}-${contentId}`);

            if (!existingContent.length) {
                return;
            }

            this.replaceConversationExistingContent(data.content, existingContent);
        },
        registerContents: function (contents) {
            for (var index in contents) {
                var content = contents[index],
                    content_id = +content.content_id;

                if (this.contents.has(content_id) === false) {
                    this.contents.set(content_id, content);
                }
            }
        },
        replaceConversationExistingContent: function (content, existing) {
            var idConv = existing.closest('.chat-tab-container').prop('id');

            if (this.chatFriendManager) {
                var userId = +idConv.split('_').pop(),
                    friendInfo = this.chatFriendManager.friends[userId],
                    contentId = +content.content_id;
                if (friendInfo && friendInfo.xvideosContext && friendInfo.xvideosContext.bought_scenes[contentId]) {
                    content.paid = true;
                }
            }

            var	params = this.prepareMessageHtmlParams(content, existing),
                message = existing.closest('.chat-message__id--content'),
                contextMenu = message.find('.chat-message__action--context-menu').prop('contextMenu');

            var matches = existing.closest('.chat-message').prop('class').match(/chat-message--content-(.*)/),
                style = (matches ? matches[1] : '');

            if (contextMenu && content.edit_url) {
                contextMenu.setAction({
                    name: 'edit_content',
                    before: 'remove',
                    label: '<svg class="chat-scc"><use xlink:href="#scc-edit-message"></use></svg>' + i18n.__('misc.actions.edit_content'),
                    callback: function () {
                        window.open(content.edit_url, '_blank').focus();
                    }
                });
            }

            message.removeClass('chat-message-temp')
                .find('.chat-message__actions').show()
                .siblings('.chat-message__delivery-status').hide();

            var newContent = $(this.getMessageHtml(params, style));
            if (content.has_access && content.chat_files && content.chat_files.hasOwnProperty('video')) {
                var sources = {};
                for (var resolution in content.chat_files.video) {
                    sources[resolution] = content.chat_files.video[resolution].url;
                }
                var videoItem = newContent.find('.chat-content__gallery .chat-content__gallery-item').get(0);
                if (videoItem) {
                    videoItem.dataset.sources = JSON.stringify(sources);
                }
            }
            existing.replaceWith(newContent);
            newContent.find('.chat-content__gallery-item:not(.chat-content__gallery-item--hidden) img').on('load', function () {
                $(this).parent().css({backgroundImage: 'none'});
            });

            if (newContent.find(SELECTORS.searchButton).length && (!!newContent.closest('.chat-message__id').data('mm') || !!newContent.closest('.chat-message__id').data('am'))) {
                this.addStatContentViews(newContent);
            }

            var friend_id;
            if (idConv) {
                friend_id = idConv.replace(/^\D+/g, '');
            }
            var thumb = newContent.find('.chat-content__thumb, .chat-content__gallery-item img');

            if (!!friend_id && !!thumb.length && message.data('preserveScrollDownOnImageLoad')) {
                if (thumb.prop('complete')) {
                    ScrollConversation.down(friend_id);
                } else {
                    thumb.on('load', function () {
                        var scrollTop = ScrollConversation.getScrollTop(friend_id) + this.height;
                        ScrollConversation.down(friend_id, scrollTop);
                    });
                }
                message.data('preserveScrollDownOnImageLoad', false);
            } else if (!!friend_id && !!thumb.length && ScrollConversation.getMarker(friend_id).length) {
                thumb.on('load', function () {
                    ScrollConversation.toFirstUnreadMarker(friend_id);
                });
            }
        },
        replaceConversationTempContent: function (data) {
            for (var id in data) {
                var content = data[id];
                this.contents.set(+content.content_id, content);

                var tempId = utils.sanitizeId(content.temp_id || id),
                    temp = $('.chat-content--loading-' + tempId);

                if (temp.length === 0) {
                    continue;
                }

                this.replaceConversationExistingContent(content, temp);
            }

            this.setMessageFormActivationDisabledState(false);
        },
        replaceMassMessageTempContent: function (data) {
            for (var id in data) {
                var content = data[id];
                this.contents.set(id, content);
                var tempId = utils.sanitizeId(content.temp_id || id);

                var temp = $('#' + tempId);
                if (!temp.length) {
                    return;
                }

                var prependHtml = '<svg class="chat-scc"><use xlink:href="#scc-safe-icon"></use></svg>';

                temp
                    .html('')
                    .text(content.name)
                    .prepend(prependHtml)
                    .removeAttr('id');
            }
        },
        requestContent: function (contents, fanId, massMessageId, autoMessageId, messageId) {
            if (Array.isArray(contents) === false) {
                wglog.debug('Content::requestContent', 'contents must be an array');
                return;
            }

            for (var index in contents) {
                var content = contents[index];

                if (typeof content.id !== "string" && typeof content.id !== "number") {
                    wglog.debug('Content::requestContent', 'the content id must be a string or number, given: ' + content.id);
                    return;
                }
                if (typeof content.temp_id !== "string") {
                    wglog.debug('Content::requestContent', 'the content temp_id must be a string, given: ' + content.temp_id);
                    return;
                }
            }

            this.socket.emit(this.socketEvents.GET_CONTENT, {
                fan_id: fanId,
                contents: contents,
                mass_message_id: massMessageId,
                auto_message_id: autoMessageId,
                message_id: messageId,
                source: this.options.vaultType
            });
        },
        preloadContents: function (contents) {
            if (Array.isArray(contents) === false) {
                wglog.debug('Content::requestContent', 'contents must be an array');
                return;
            }

            for (var index in contents) {
                var content = contents[index];

                if (typeof content.id !== "string" && typeof content.id !== "number") {
                    wglog.debug('Content::preloadContents', 'the content id must be a string or number, given: ' + content.id);
                    return;
                }
            }

            this.socket.emit(this.socketEvents.GET_CONTENT, {contents: contents, source: this.PRELOAD_PREFIX + this.options.vaultType});
        },
        searchContentEmit: function (form, page) {
            if (!this.isVaultReady()) {
                return;
            }

            var formData = new FormData(form);

            if (formData.length === 0) {
                wglog.debug('Content::searchContentEmit', 'No data to send for search request');
                return;
            }

            var name = (formData.get('name') || "").trim();

            if (name === this.last_search && page === this.contentSearchPage) {
                wglog.debug('Content::searchContentEmit', 'input value equals last search, no need to emit');
                return;
            }

            this.last_search = name;

            this.socket.emit(this.socketEvents.SEARCH_CONTENT, {
                name: name,
                page: page || 1,
                itemsPerPage: this.searchItemsPerPage
            });

            this.displayLoader();
        },
        setGetPrivateText: function (callback) {
            if (typeof callback === 'function') {
                this.getPrivateText = callback;
            }
        },
        setGetText: function (callback) {
            if (typeof callback === 'function') {
                this.getText = callback;
            }
        },
        setGetTitle: function (callback) {
            if (typeof callback === 'function') {
                this.getTitle = callback;
            }
        },
        setDropzoneActivation: function (isDisabled) {
            if (typeof isDisabled !== "boolean") {
                isDisabled = false;
            }
            $('#' + this.options.dropzoneFieldId + ' .dz-remove')[isDisabled ? 'addClass' : 'removeClass']("dz-link-disabled");
            this.getDropzone()[isDisabled ? 'disable' : 'enable']();
        },
        setEmptyMessageForm: function (callback) {
            if (typeof callback === "function") {
                this.emptyMessageForm = callback;
            }
        },
        setChatFriendManager: function (friendManager) {
            this.chatFriendManager = friendManager;
        },
        setMessageEncrypter: function (callback) {
            if (typeof callback === "function") {
                this.messageEncrypter = callback;
            }
        },
        setMessageFormActivation: function (callback) {
            if (typeof callback === "function") {
                this.messageFormActivation = callback;
            }
        },
        setMessageFormActivationDisabledState: function (isDisabled, dropzoneQueueCompleteCallback) {
            if (typeof this.messageFormDeactivated === 'boolean' && !this.messageFormDeactivated) {
                return;
            }

            if (typeof isDisabled !== "boolean") {
                isDisabled = false;
            }

            if (isDisabled && dropzoneQueueCompleteCallback) {
                var dropzone = this.getDropzone(),
                    self = this;

                if (dropzone.files.filter(file => file.status === "uploading").length) {
                    function _onQueueComplete() {
                        dropzone.off('queuecomplete', _onQueueComplete);
                        self.setDropzoneActivation(isDisabled);
                        dropzoneQueueCompleteCallback();
                    }
                    dropzone.on('queuecomplete', _onQueueComplete);
                } else {
                    self.setDropzoneActivation(isDisabled);
                    dropzoneQueueCompleteCallback();
                }
            } else {
                this.setDropzoneActivation(isDisabled);
            }

            this.messageFormActivation(isDisabled, 'chat.error.please_wait');
            $('#' + this.options.vaultContentPriceFieldId).closest('.chat-message-form').find('.chat-vault__field--price').prop('disabled', isDisabled);

            if (this.messageFormDeactivated && !isDisabled) {
                this.messageFormDeactivated = false;
            }
        },
        setMessageFormTextareaValue: function (data) {
            var value = data.description,
                textarea = data.media_type === 'text' ? $('#chat-mass-message-vault-text').find('textarea') : $('#' + this.options.messageTextareaId),
                emojioneArea = textarea.prop('emojioneArea');

            if (emojioneArea) {
                emojioneArea.setText(value);
                value = emojioneArea.getText();
            }

            textarea.val(value);
        },
        setMessageProvider: function (callback) {
            if (typeof callback === "function") {
                this.messageProvider = callback;
            }
        },
        setSearchContentTimeout: function (form) {
            if (this.searchContentTimeoutId) {
                clearTimeout(this.searchContentTimeoutId);
            }

            this.searchContentTimeoutId = setTimeout(() => {
                this.searchContentEmit(form);
            }, this.SEARCH_CONTENT_TIMEOUT);
        },
        setSelectedFriendIdProvider: function (callback) {
            if (typeof callback === "function") {
                this.selectedFriendIdProvider = callback;
            }
        },
        setSocket: function (socket) {
            this.socket = socket;
            this.onSocketChatError = this.onSocketChatError.bind(this);
            this.socket.on("chat_error", this.onSocketChatError);

            if (this.isConversationVault()) {
                this.onSocketVaultContentGet = this.onSocketVaultContentGet.bind(this);
                this.socket.on(this.socketEvents.CONTENT_GET, this.onSocketVaultContentGet);

                this.onSocketVaultContentCreated = this.onSocketVaultContentCreated.bind(this);
                this.socket.on(this.socketEvents.CONTENT_CREATED, this.onSocketVaultContentCreated);
            }
            if (this.isCreatorMessageVault()) {
                this.onSocketVaultContentGet = this.onSocketVaultContentGet.bind(this);
                this.socket.on(this.socketEvents.CONTENT_GET, this.onSocketVaultContentGet);
            }
        },
        triggerContentSelectorChangeEvent: function () {
            var target = $('#' + this.options.vaultId +' .chat-vault__content-selector');
            target.trigger(jQuery.Event('change', {
                bubbles: true,
                currentTarget: target.get(0),
                detail: {hasContentSelected: this.hasContentSelected},
                target: target.get(0)
            }));
        },

        hidePriceWrapper: function () {
            $('#' + this.options.vaultContentPriceWrapperId).hide();
        },
        showPriceWrapper: function () {
            $('#' + this.options.vaultContentPriceWrapperId).show();
        }
    }
    Content.prototype.constructor = Content;

    return Content;
});
define('features/CreatorMessages/MassMessage/commands/CreateContentInstance',[
	'chat/content/content',
	'config/chat',
	'core/Command',
	'lib/i18n!front',
	'services/SocketConnection',
	'services/SocketConnectionEvent',
], function(
	Content,
	Config,
	Command,
	i18n,
	SocketConnection,
	SocketConnectionEvent
) {
	var CreateContentInstanceCommand = function(context, commandMap, mediatorMap) {
		Command.call(this, ...arguments);
	};

	CreateContentInstanceCommand.prototype = Object.create(Command.prototype);

	Object.assign(CreateContentInstanceCommand.prototype, {
		execute: function (mediatorInstance) {
			var content = new Content({
				contentSearchFormId: 'chat-creator-messages-content-search-form',
				contentSearchNameFieldId: 'chat-creator-messages-content-search-name',
				contentSearchResultsId: 'chat-creator-messages-content-search-results',
				dropzoneFieldId: 'chat-creator-messages-files',
				messageTextareaId: 'chat-creator-messages-textarea-message',
				vaultContentIdFieldId: 'chat-creator-messages-content-content-id',
				vaultContentPriceFieldId: 'chat-creator-messages-price',
				vaultContentSelectionButtonId: 'chat-creator-messages-content-select',
				vaultId: 'chat-creator-messages-content',
				vaultType: Content.TYPE_CREATOR_MESSAGES_MASS
			});

			content.setSocket(SocketConnection.connection);
			content.setMessageFormActivation(this.context.chatFriendManager.setMessageFormState.bind(this.context.chat_friend_manager));
			content.setEmptyMessageForm(this.context.manager.empty_message_form.bind(this.context.manager));
			content.setMessageEncrypter(this.context.manager.make_real_message.bind(this.context.manager));
			content.setSelectedFriendIdProvider(() => this.context.chatFriendManager.selected_friend);

			mediatorInstance.addContent(content);
		}
	});

	return CreateContentInstanceCommand;
});
define('chat/content/vault',[
    './content',
    'lib/i18n!front',
], function (
    Content,
    i18n
) {
    var Vault = function (options) {
        options = Object.assign({}, options, {socketEventType: 'vault'});
        Content.call(this, options);

        this.socketEvents.CONTENT_CREATED = 'vault_content_created';
        this.socketEvents.CONTENT_GET = 'vault_content_get';
        this.socketEvents.CONTENT_FOUND = 'vault_content_found';
        this.socketEvents.CREATE_CONTENT = 'create_vault_content';
        this.socketEvents.CREATE_CONTENT_ERROR = 'vault-content-create-error';
        this.socketEvents.CREATE_CONTENT_MASS_MESSAGE_ERROR = 'vault-content-create-error.mass_message';
        this.socketEvents.CREATE_CONTENT_AUTO_MESSAGE_ERROR = 'vault-content-create-error.auto_message';
        this.socketEvents.CREATOR_MESSAGE_CREATE_CONTENT = 'creator_message_vault_create_content';
        this.socketEvents.GET_CONTENT = 'get_vault_content';
        this.socketEvents.GET_CONTENT_PRELOAD_MASS = 'get_vault_content_preload.mass_message';
        this.socketEvents.GET_CONTENT_PRELOAD_AUTO = 'get_vault_content_preload.auto_message';
        this.socketEvents.SEARCH_CONTENT = 'search_vault_content';
    };

    Vault.prototype = Object.create(Content.prototype);
    Vault.prototype.constructor = Vault;
    Object.setPrototypeOf(Vault, Content);

    Vault.prototype.generateI18nCustomStrings = function () {
        var strings = Content.prototype.generateI18nCustomStrings.call(this);

        strings.contentSelectorButtonLabel = i18n.__('chat.vault.select_in_vault');

        return strings;
    }
    Vault.prototype.getMessageDataOverrides = function () {
        return {is_vault: true};
    }

    return Vault;
});

define('features/CreatorMessages/MassMessage/commands/CreateVaultInstance',[
	'chat/content/vault',
	'config/chat',
	'core/Command',
	'lib/i18n!front',
	'services/SocketConnection',
	'services/SocketConnectionEvent',
], function(
	Vault,
	Config,
	Command,
	i18n,
	SocketConnection,
	SocketConnectionEvent
) {
	var CreateVaultInstanceCommand = function(context, commandMap, mediatorMap) {
		Command.call(this, ...arguments);
	};

	CreateVaultInstanceCommand.prototype = Object.create(Command.prototype);

	Object.assign(CreateVaultInstanceCommand.prototype, {
		execute: function (mediatorInstance) {
			var vault = new Vault({
				contentSearchFormId: 'chat-creator-messages-content-search-form',
				contentSearchNameFieldId: 'chat-creator-messages-content-search-name',
				contentSearchResultsId: 'chat-creator-messages-content-search-results',
				dropzoneFieldId: 'chat-creator-messages-files',
				messageTextareaId: 'chat-creator-messages-textarea-message',
				vaultContentIdFieldId: 'chat-creator-messages-vault-content-id',
				vaultContentPriceFieldId: 'chat-creator-messages-price',
				vaultContentSelectionButtonId: 'chat-creator-messages-vault-select',
				vaultId: 'chat-creator-messages-vault',
				vaultType: Vault.TYPE_CREATOR_MESSAGES_MASS
			});

			vault.socketEvents.CONTENT_CREATED = SocketConnectionEvent.in.MASS_MESSAGE_VAULT_CONTENT_CREATED;
			vault.socketEvents.CREATE_CONTENT = SocketConnectionEvent.out.MASS_MESSAGE_VAULT_CREATE_CONTENT;

			vault.setSocket(SocketConnection.connection);
			vault.setMessageFormActivation(this.context.chatFriendManager.setMessageFormState.bind(this.context.chat_friend_manager));
			vault.setEmptyMessageForm(this.context.manager.empty_message_form.bind(this.context.manager));
			vault.setMessageEncrypter(this.context.manager.make_real_message.bind(this.context.manager));
			vault.setSelectedFriendIdProvider(() => this.context.chatFriendManager.selected_friend);

			mediatorInstance.addVault(vault);
		}
	});

	return CreateVaultInstanceCommand;
});
define('features/CreatorMessages/MassMessage/commands/GetTargetsEstimationMassMessage',[
	'core/Command',
	'services/SocketConnection',
	'services/SocketConnectionEvent',
], function(
	Command,
	SocketConnection,
	SocketConnectionEvent
) {
	var GetTargetsEstimationMassMessageCommand = function(context) {
		Command.call(this, context);
	};

	GetTargetsEstimationMassMessageCommand.prototype = Object.create(Command.prototype);

	Object.assign(GetTargetsEstimationMassMessageCommand.prototype, {
		execute: function (args) {
			if (typeof args === 'undefined' || typeof args.rules === 'undefined') {
				throw new Error('No rules');
				return;
			}
			SocketConnection.emit(SocketConnectionEvent.out.GET_TARGETS_ESTIMATION_MASS_MESSAGE, args);
		}
	});

	return GetTargetsEstimationMassMessageCommand;
});
define('features/CreatorMessages/MassMessage/commands/LoadMoreMassMessage',[
	'core/Command',
	'services/SocketConnection',
	'services/SocketConnectionEvent'
], function(
	Command,
	SocketConnection,
	SocketConnectionEvent
) {
	var LoadMoreMassMessageCommand = function(context) {
		Command.call(this, context);
	};

	LoadMoreMassMessageCommand.prototype = Object.create(Command.prototype);

	Object.assign(LoadMoreMassMessageCommand.prototype, {
		execute: function (args) {
			if (typeof args === 'undefined' || typeof args.page === 'undefined') {
				throw new Error('No page to load');
				return;
			}
			SocketConnection.emit(SocketConnectionEvent.out.GET_ALL_MASS_MESSAGE, args);
		}
	});

	return LoadMoreMassMessageCommand;
});
/** @license
 * RequireJS plugin for loading JSON files
 * - depends on Text plugin and it was HEAVILY "inspired" by it as well.
 * Author: Miller Medeiros
 * Version: 0.4.0 (2014/04/10)
 * Released under the MIT license
 */
define('json',['text'], function(text){

	var CACHE_BUST_QUERY_PARAM = 'bust',
		CACHE_BUST_FLAG = '!bust',
		jsonParse = (typeof JSON !== 'undefined' && typeof JSON.parse === 'function')? JSON.parse : function(val){
			return eval('('+ val +')'); //quick and dirty
		},
		buildMap = {};

	function cacheBust(url){
		url = url.replace(CACHE_BUST_FLAG, '');
		url += (url.indexOf('?') < 0)? '?' : '&';
		return url + CACHE_BUST_QUERY_PARAM +'='+ Math.round(2147483647 * Math.random());
	}

	//API
	return {

		load : function(name, req, onLoad, config) {
			if (( config.isBuild && (config.inlineJSON === false || name.indexOf(CACHE_BUST_QUERY_PARAM +'=') !== -1)) || (req.toUrl(name).indexOf('empty:') === 0)) {
				//avoid inlining cache busted JSON or if inlineJSON:false
				//and don't inline files marked as empty!
				onLoad(null);
			} else {
				text.get(req.toUrl(name), function(data){
						var parsed;
						if (config.isBuild) {
							buildMap[name] = data;
							onLoad(data);
						} else {
							try {
								parsed = jsonParse(data);
							} catch (e) {
								onLoad.error(e);
							}
							onLoad(parsed);
						}
					},
					onLoad.error, {
						accept: 'application/json'
					}
				);
			}
		},

		normalize : function (name, normalize) {
			// used normalize to avoid caching references to a "cache busted" request
			if (name.indexOf(CACHE_BUST_FLAG) !== -1) {
				name = cacheBust(name);
			}
			// resolve any relative paths
			return normalize(name);
		},

		//write method based on RequireJS official text plugin by James Burke
		//https://github.com/jrburke/requirejs/blob/master/text.js
		write : function(pluginName, moduleName, write){
			if(moduleName in buildMap){
				var content = buildMap[moduleName];
				write('define("'+ pluginName +'!'+ moduleName +'", function(){ return '+ content +';});\n');
			}
		}

	};
});

define("json!features/CreatorMessages/data/ContactsListData.json", function(){ return [
  {
    "value": "available",
    "rule": "all_available_users",
    "labelI18nKey": "chat.contacts_list.all_groups"
  },
  {
    "value": "followers",
    "rule": "all_followers",
    "labelI18nKey": "chat.contacts_list.all_followers"
  },
  {
    "value": "recent-followers",
    "rule": "recent_followers",
    "labelI18nKey": "chat.contacts_list.new_followers"
  },
  {
    "value": "customers",
    "rule": "all_customers",
    "labelI18nKey": "chat.contacts_list.all_customers"
  },
  {
    "value": "recent-customers",
    "rule": "recent_customers",
    "labelI18nKey": "chat.contacts_list.new_customers"
  },
  {
    "value": "active-members",
    "rule": "all_active_members",
    "labelI18nKey": "chat.contacts_list.all_active_members"
  },
  {
    "value": "past-members",
    "rule": "all_past_members",
    "labelI18nKey": "chat.contacts_list.all_old_members"
  },
  {
    "value": "ppv-buyers",
    "rule": "all_ppv_buyers",
    "labelI18nKey": "chat.contacts_list.all_ppv_buyers"
  },
  {
    "value": "tip-buyers",
    "rule": "all_tip_buyers",
    "labelI18nKey": "chat.contacts_list.all_tip_buyers"
  }
];});

define('features/CreatorMessages/models/CreatorMessagesContactModel',[
	'core/Model',
	'json!features/CreatorMessages/data/ContactsListData.json'
], function (
	Model,
	ContactData
) {
	/**
	 * @extends Model
	 * @constructor
	 */
	var CreatorMessagesContactModel = function () {
		this.initialData = ContactData;
		this.storageKey = 'mass-message-contact';
		Model.call(this);
	};

	CreatorMessagesContactModel.prototype = Object.create(Model.prototype);

	Object.assign(CreatorMessagesContactModel.prototype, {
		validate: function (data) {
			if (!data.value || typeof data.value !== "string") {
				return false;
			}
			if (!data.rule || typeof data.rule !== "string") {
				return false;
			}
			if (!data.labelI18nKey || typeof data.labelI18nKey !== "string") {
				return false;
			}

			return true;
		}
	});

	return CreatorMessagesContactModel;
});

define('text!features/CreatorMessages/views/CreatorMessages.mustache',[],function () { return '<form class="{{className}}">\n\t{{#beta}}\n\t\t<p class="{{className}}__beta">{{{beta}}}</p>\n\t{{/beta}}\n\t<div class="{{className}}__header">\n\t\t<button class="btn chat-btn--creator-messages chat-btn--creator-messages-back-to-form-step chat-btn--creator-messages-back is-hidden" type="button" title="{{back}}"></button>\n\t\t<button class="btn chat-btn--creator-messages chat-btn--creator-messages-back-to-form-fields chat-btn--creator-messages-back is-hidden" type="button" title="{{back}}"></button>\n\t\t<button class="btn chat-btn--creator-messages chat-btn--creator-message-back-to-list chat-btn--creator-messages-back is-hidden" type="button" title="{{back}}"></button>\n\t\t{{#title}}\n\t\t\t<div class="{{className}}__title">\n\t\t\t\t<h2 class="{{className}}__title-text">{{title}}</h2>\n\t\t\t\t<i class="fa fa-question-circle {{className}}__title-icon"></i>\n\t\t\t</div>\n\t\t{{/title}}\n\t\t<button class="btn chat-btn--creator-messages chat-btn chat-btn--creator-messages-stats btn--creator-messages-stats" type="button" title="{{statsMessages}}">\n\t\t\t<i class="fa fa-line-chart" aria-hidden="true"></i>\n\t\t\t{{statsMessages}}\n\t\t</button>\n\t\t<button class="btn chat-btn chat-btn--creator-messages chat-btn--creator-messages-new btn--creator-messages-new is-hidden" type="button">{{newMessage}}</button>\n\t</div>\n\n\t<div class="{{className}}__list is-hidden">\n\t\t<div id="messages-list-placeholder"></div>\n\t</div>\n\n\t<div class="{{className}}__form">\n\n\t\t{{#hasContactsList}}\n\t\t<fieldset>\n\t\t\t<legend>{{legendContactsList}}</legend>\n\t\t\t<div id="contacts-list-placeholder"></div>\n\t\t</fieldset>\n\t\t{{/hasContactsList}}\n\n\t\t{{#hasEventsList}}\n\t\t\t<fieldset>\n\t\t\t\t<legend>{{legendEventsList}}</legend>\n\t\t\t\t<div id="events-placeholder"></div>\n\t\t\t</fieldset>\n\t\t{{/hasEventsList}}\n\n\t\t<fieldset>\n\t\t\t<legend>{{messageTitle}}</legend>\n\t\t\t<div id="title-placeholder"></div>\n\t\t\t{{#hasDynamicVar}}\n\t\t\t\t<div id="dynamic-var-placeholder"></div>\n\t\t\t{{/hasDynamicVar}}\n\t\t\t<div class="chat-creator-messages-message-wrapper">\n\t\t\t\t<div id="chat-creator-messages-toggle-attachment" class="chat-toggle chat-ui-form-field">\n\t\t\t\t\t<div id="attachment-placeholder"></div>\n\t\t\t\t\t<p class="chat-creator-messages-chat-file-size-limit chat-file-size-limit">{{maxSize}}</p>\n\t\t\t\t</div>\n\t\t\t\t<div id="message-placeholder"></div>\n\t\t\t</div>\n\t\t</fieldset>\n\n\t\t<div class="chat-form-actions chat-form-actions--flex">\n\t\t\t<div class="col--left">\n\t\t\t\t{{#hasPrice}}\n\t\t\t\t<div class="chat-form-actions__price">\n\t\t\t\t\t<button class="chat-btn chat-btn--creator-messages chat-btn--creator-messages-price round neutral mini" type="button" title="{{priceLabel}}">\n\t\t\t\t\t\t<svg class="chat-scc"><use xlink:href="#scc-creator-messages-price-icon"></use></svg>\n\t\t\t\t\t</button>\n\t\t\t\t\t<div class="{{className}}__price is-hidden">\n\t\t\t\t\t\t<div id="chat-creator-messages-toggle-price" class="chat-ui-form-field">\n\t\t\t\t\t\t\t<div id="price-placeholder"></div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t{{/hasPrice}}\n\t\t\t\t<button data-toggle="#chat-creator-messages-toggle-attachment" class="chat-btn chat-btn--creator-messages chat-btn--creator-messages-attachment neutral mini" type="button" title="{{attachmentLabel}}">\n\t\t\t\t\t<svg class="chat-scc"><use xlink:href="#scc-message-attachment-icon"></use></svg>\n\t\t\t\t</button>\n\t\t\t</div>\n\t\t\t{{#hasContactsList}}\n\t\t\t<div class="col--right">\n\t\t\t\t<div class="chat-form-actions__delay">\n\t\t\t\t\t<button class="chat-btn chat-btn--creator-messages chat-btn--creator-messages-delay right round neutral mini" type="button" title="{{delayLabel}}">\n\t\t\t\t\t\t<svg class="chat-scc"><use xlink:href="#scc-creator-messages-delay-icon"></use></svg>\n\t\t\t\t\t</button>\n\t\t\t\t\t<div class="{{className}}__delay is-hidden">\n\t\t\t\t\t\t<div id="chat-creator-messages-toggle-delay" class="chat-ui-form-field">\n\t\t\t\t\t\t\t<div id="delay-placeholder"></div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t{{/hasContactsList}}\n\t\t\t<button class="chat-btn chat-btn--creator-messages chat-btn--creator-messages-save mini" type="button">{{saveLabel}}</button>\n\t\t</div>\n\t</div>\n</form>\n';});


define('text!features/CreatorMessages/views/components/DynamicVar/DynamicVar.mustache',[],function () { return '<div class="dynamic-var">\n\t<p class="dynamic-var__label">{{ label }}</p>\n\t<div class="dynamic-var__buttons-wrapper"></div>\n</div>';});

define('features/CreatorMessages/views/components/DynamicVar/DynamicVar',[
	'core/Component',
	'text!features/CreatorMessages/views/components/DynamicVar/DynamicVar.mustache',
	'lib/tools',
	'lib/i18n!front',
	'lib/storage',
	'ui/ActionButton/ActionButton',
], function(
	Component,
	tplDynamicVar,
	tools,
	i18n,
	Storage,
	ActionButton
) {
	var DynamicVar = function(options) {
		this.template = tplDynamicVar;
		this.options = Object.assign({}, {}, options);
		Component.call(this);
		this.selection = null;
		this.initButtons();
	};

	DynamicVar.prototype = Object.create(Component.prototype);

	Object.assign(DynamicVar.prototype, {
		initButtons: function() {
			var nickname = new ActionButton('nickname', {
					label: i18n.__('chat.dynamic_var.nickname'),
					color: ActionButton.THEME_GRADIENT,
					attributes: {
						'data-action': 'nickname'
					}
				}),
				btnNickname = nickname.getElement();
			this.addElementListener(btnNickname, 'click', this.onClickDynamicVar.bind(this));
			this.element.querySelector('.dynamic-var__buttons-wrapper').append(btnNickname);
		},
		manageCustomEventsEmojione: function(element) {
			if (!$) {
				return;
			}
			$(element.getEmojioneArea()).find('.emojionearea-editor').off('blur');
		},
		onClickDynamicVar: function(event) {
			var variable = event.currentTarget.dataset.action;

			if (variable === 'nickname') {
				variable = '%nickname%';
			} else {
				variable = null;
			}

			this.contentEditable.focus();

			var selection = window.getSelection();
			var range = selection.getRangeAt(0);
			var textNode = document.createTextNode(variable);

			range.deleteContents();
			range.insertNode(textNode);
			range.setStartAfter(textNode);
			range.collapse(true);

			selection.removeAllRanges();
			selection.addRange(range);
		},
		setContainer: function(element) {
			this.contentEditable = element.getElement().closest('fieldset').querySelector('.emojionearea-editor');
			if (this.contentEditable.getAttribute('class').indexOf('emojione') !== -1) {
				this.manageCustomEventsEmojione(element);
			}
		}
	});

	return DynamicVar;
});

define('text!features/CreatorMessages/views/components/MessagesList/MessagesList.mustache',[],function () { return '<ul class="{{#componentName}}{{componentName}}{{/componentName}}"{{#attributes}} {{{attributes}}}{{/attributes}}>\n\t{{^hasMessages}}<li class="{{componentName}}__item {{componentName}}__item--no-messages {{componentName}}__item--text">{{noMessage}}</li>{{/hasMessages}}\n</ul>';});


define('text!features/CreatorMessages/views/components/MessagesList/MessagesListItem.mustache',[],function () { return '<li class="{{componentName}}__item">\n\t<div class="{{componentName}}__message is-not-init" data-id-{{#status}}mass{{/status}}{{#event}}auto{{/event}}-message="{{id}}">\n\t\t<div class="{{componentName}}__content">\n\t\t\t<div class="col--left">\n\t\t\t\t<div class="{{componentName}}__content-top">\n\t\t\t\t\t{{#isBundle}}\n\t\t\t\t\t\t<div class="{{componentName}}__message-bundle messages-bundle">\n\t\t\t\t\t\t\t<ul class="messages-bundle__list">\n\t\t\t\t\t\t\t\t{{#messagesTranslated}}\n\t\t\t\t\t\t\t\t\t{{#isVault}}\n\t\t\t\t\t\t\t\t\t\t{{#vaultIds}}\n\t\t\t\t\t\t\t\t\t\t\t<p class="{{componentName}}__message-preview {{componentName}}__message-preview--content" {{#vaultIds}}data-id-vault="{{vaultIds}}"{{/vaultIds}}><svg class="chat-scc chat-scc--spin"><use xlink:href="#scc-message-loader-icon" /></svg> {{tempMessage}}</p>\n\t\t\t\t\t\t\t\t\t\t{{/vaultIds}}\n\t\t\t\t\t\t\t\t\t{{/isVault}}\n\t\t\t\t\t\t\t\t\t{{^isVault}}\n\t\t\t\t\t\t\t\t\t\t<p{{#tempId}} id="{{tempId}}"{{/tempId}} class="{{componentName}}__message-preview">{{#tempId}}{{tempMessage}}{{/tempId}}{{^tempId}}{{message}}{{/tempId}}</p>\n\t\t\t\t\t\t\t\t\t{{/isVault}}\n\t\t\t\t\t\t\t\t{{/messagesTranslated}}\n\t\t\t\t\t\t\t</ul>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t{{/isBundle}}\n\t\t\t\t\t{{^isBundle}}\n\t\t\t\t\t\t{{#messagesTranslated}}\n\t\t\t\t\t\t\t{{#isVault}}\n\t\t\t\t\t\t\t\t{{#vaultIds}}\n\t\t\t\t\t\t\t\t\t<p class="{{componentName}}__message-preview {{componentName}}__message-preview--content" {{#vaultIds}}data-id-vault="{{vaultIds}}"{{/vaultIds}}><svg class="chat-scc chat-scc--spin"><use xlink:href="#scc-message-loader-icon" /></svg> {{tempMessage}}</p>\n\t\t\t\t\t\t\t\t{{/vaultIds}}\n\t\t\t\t\t\t\t{{/isVault}}\n\t\t\t\t\t\t\t{{^isVault}}\n\t\t\t\t\t\t\t\t<p{{#tempId}} id="{{tempId}}"{{/tempId}} class="{{componentName}}__message-preview">{{#tempId}}{{tempMessage}}{{/tempId}}{{^tempId}}{{message}}{{/tempId}}</p>\n\t\t\t\t\t\t\t{{/isVault}}\n\t\t\t\t\t\t{{/messagesTranslated}}\n\t\t\t\t\t{{/isBundle}}\n\t\t\t\t</div>\n\t\t\t\t{{#status}}\n\t\t\t\t\t{{^isCompleted}}\n\t\t\t\t\t\t<p class="{{componentName}}__message-status {{componentName}}__message-status--{{status}}">{{statusLabel}}</p>\n\t\t\t\t\t{{/isCompleted}}\n\t\t\t\t{{/status}}\n\t\t\t\t{{#rulesTranslated}}\n\t\t\t\t\t<p class="{{componentName}}__message-recipients">{{rulesLabel}} : {{rulesTranslated}}</p>\n\t\t\t\t{{/rulesTranslated}}\n\t\t\t\t{{#eventTranslated}}\n\t\t\t\t\t<p class="{{componentName}}__message-recipients">{{eventLabel}} : {{eventTranslated}}{{#param}} (${{param}}){{/param}}</p>\n\t\t\t\t{{/eventTranslated}}\n\t\t\t\t{{#stats}}\n\t\t\t\t\t<p class="{{componentName}}__message-sent">{{sentStatLabel}}: <strong>{{message_sent}}</strong> / {{message_total}}</p>\n\t\t\t\t\t<p class="{{componentName}}__message-sale">{{totalStatLabel}}: <strong>${{purchase_total}}</strong></p>\n\t\t\t\t\t<p class="{{componentName}}__message-purchased">{{countStatLabel}}: <b>{{purchase_count}}</b></p>\n\t\t\t\t{{/stats}}\n\t\t\t</div>\n\t\t\t<div class="col--right">\n\t\t\t\t<p class="{{componentName}}__message-time">{{timeLabel}} : <strong>{{created}}</strong></p>\n\t\t\t</div>\n\t\t</div>\n\t\t<div class="{{componentName}}__infos">\n\t\t\t{{#stats}}\n\t\t\t\t<div class="col--stats">\n\t\t\t\t\t<ul class="{{componentName}}__stats">\n\t\t\t\t\t\t<li class="{{componentName}}__stat {{componentName}}__stat--viewed">{{viewStatLabel}}: <strong>{{message_viewed}}</strong></li>\n\t\t\t\t\t\t<li class="{{componentName}}__stat {{componentName}}__stat--answered">{{answerStatLabel}}: <strong>{{message_answered}}</strong></li>\n\t\t\t\t\t\t<li class="{{componentName}}__stat {{componentName}}__stat--clicked">{{clickStatLabel}}: <strong>{{link_clicked}}</strong></li>\n\t\t\t\t\t\t<li class="{{componentName}}__stat {{componentName}}__stat--content-views is-hidden">{{contentViewsStatLabel}}: <strong>{{content_views}}</strong></li>\n\t\t\t\t\t</ul>\n\t\t\t\t</div>\n\t\t\t{{/stats}}\n\t\t\t<div class="col--menu">\n\t\t\t\t<ul class="{{componentName}}__menu">\n\t\t\t\t\t{{#isDuplicable}}\n\t\t\t\t\t\t<li class="{{componentName}}__menu-item {{componentName}}__menu-item--duplicate">\n\t\t\t\t\t\t\t<button class="{{componentName}}__btn {{componentName}}__btn--duplicate" type="button">\n\t\t\t\t\t\t\t\t<svg class="chat-scc chat-scc--creator-messages-duplicate"><use xlink:href="#scc-creator-messages-duplicate-icon"></use></svg>\n\t\t\t\t\t\t\t\t{{duplicate}}\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</li>\n\t\t\t\t\t{{/isDuplicable}}\n\t\t\t\t\t{{#isCancelable}}\n\t\t\t\t\t\t<li class="{{componentName}}__menu-item {{componentName}}__menu-item--cancel">\n\t\t\t\t\t\t\t<button class="{{componentName}}__btn {{componentName}}__btn--cancel" type="button">\n\t\t\t\t\t\t\t\t<svg class="chat-scc chat-scc--creator-messages-cancel"><use xlink:href="#scc-creator-messages-cancel-icon"></use></svg>\n\t\t\t\t\t\t\t\t{{cancel}}\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</li>\n\t\t\t\t\t{{/isCancelable}}\n\t\t\t\t\t{{#isEditable}}\n\t\t\t\t\t\t<li class="{{componentName}}__menu-item {{componentName}}__menu-item--edit">\n\t\t\t\t\t\t\t<button class="{{componentName}}__btn {{componentName}}__btn--edit" type="button">\n\t\t\t\t\t\t\t\t<svg class="chat-scc chat-scc--creator-messages-edit"><use xlink:href="#scc-edit-message"></use></svg>\n\t\t\t\t\t\t\t\t{{edit}}\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</li>\n\t\t\t\t\t{{/isEditable}}\n\t\t\t\t\t{{#isSwitchable}}\n\t\t\t\t\t\t<li class="{{componentName}}__menu-item {{componentName}}__menu-item--switch">\n\t\t\t\t\t\t\t<div class="{{componentName}}__toggle-wrapper">\n\t\t\t\t\t\t\t\t<div class="chat-ui-form-field-toggle{{#isActive}} is-active{{/isActive}}">\n\t\t\t\t\t\t\t\t\t<p class="chat-ui-toggle-label">{{autoMessageEnableLabel}}</p>\n\t\t\t\t\t\t\t\t\t<label class="chat-ui-toggle">\n\t\t\t\t\t\t\t\t\t\t<input type="checkbox" class="chat-ui-toggle__input"{{#isActive}} checked{{/isActive}}/>\n\t\t\t\t\t\t\t\t\t\t<span class="chat-ui-toggle__slider"></span>\n\t\t\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</li>\n\t\t\t\t\t{{/isSwitchable}}\n\t\t\t\t</ul>\n\t\t\t</div>\n\t\t</div>\n\t</div>\n</li>';});

define('features/CreatorMessages/views/components/MessagesList/MessagesListItem',[
	'core/Component',
	'text!features/CreatorMessages/views/components/MessagesList/MessagesListItem.mustache',
	'lib/i18n!front'
], function(
	Component,
	tplMessagesListItem,
	i18n
) {
	var MessagesListItem = function(options) {
		this.options = Object.assign({}, {
			classes: "",
			modifier: "",
			attributes: {}
		}, options);
		this.template = tplMessagesListItem;
		Component.call(this);
	};

	MessagesListItem.prototype = Object.create(Component.prototype);

	Object.assign(MessagesListItem.prototype, {
		getForcedTemplateParams: function () {
			return {
				tempMessage: i18n.__('chat.message_list_item.temp_message'),
				rulesLabel: i18n.__('chat.mass_message_recipients'),
				eventLabel: i18n.__('chat.auto_message_event'),
				autoMessageEnableLabel: i18n.__('chat.auto_message.state_enable'),
				moreLabel: i18n.__('chat.more'),
				duplicate: i18n.__('chat.mass_message_duplicate'),
				cancel: i18n.__('misc.cancel'),
				edit: i18n.__('misc.actions.edit')
			};
		}
	});

	return MessagesListItem;
});
define('features/CreatorMessages/views/components/MessagesList/MessagesList',[
	'core/Component',
	'text!features/CreatorMessages/views/components/MessagesList/MessagesList.mustache',
	'features/CreatorMessages/views/components/MessagesList/MessagesListItem',
	'lib/i18n!front',
], function(
	Component,
	tplMessagesList,
	MessagesListItem,
	i18n
) {
	var MessagesList = function(options) {
		this.options = Object.assign({}, {
			classes: "",
			modifier: "",
			attributes: {}
		}, options);
		this.template = tplMessagesList;
		this.componentName = null;
		this.currentPage = null;
		this.lastPage = null;
		Component.call(this);
	};

	MessagesList.prototype = Object.create(Component.prototype);

	Object.assign(MessagesList.prototype, {
		appendMessage: function(messageJson, isNewMessage) {
			var messageHtml = this.createMessage(messageJson);
			if (isNewMessage) {
				this.element.insertBefore(messageHtml, this.element.firstChild);
			}
			else {
				this.element.appendChild(messageHtml);
			}

			var noMessageHtml = this.element.querySelector('.messages-list__item--no-messages');
			if (noMessageHtml !== null) {
				noMessageHtml.remove();
			}

			return messageHtml;
		},
		createMessage: function(messageJson) {
			var vaultIds = [];

			for (var index in messageJson.messages_translated) {
				if (typeof messageJson.messages_translated[index].content_id !== 'undefined' && parseInt(messageJson.messages_translated[index].content_id) > 0) {
					vaultIds.push(parseInt(messageJson.messages_translated[index].content_id));
				}
			}

			var messageData = {
				componentName: this.componentName,
				created: messageJson.created,
				timeLabel: messageJson.delay_send_date ? i18n.__('chat.mass_message.scheduled_date') : i18n.__('chat.mass_message.creation_date'),
				id: messageJson.id,
				isActive: false,
				isBundle: messageJson.messages_translated.length > 1,
				isDuplicable: false,
				isEditable: false,
				isSwitchable: false,
				isVault: vaultIds.length > 0,
				messagesTranslated: messageJson.messages_translated,
				stats: messageJson.stats,
				vaultIds: vaultIds,
				sentStatLabel: i18n.__('chat.mass_message_stats.message_sent'),
				viewStatLabel: i18n.__('chat.mass_message_stats.message_viewed'),
				clickStatLabel: i18n.__('chat.mass_message_stats.link_clicked'),
				answerStatLabel: i18n.__('chat.mass_message_stats.message_answered'),
				countStatLabel: i18n.__('chat.mass_message_stats.purchase_count'),
				totalStatLabel: i18n.__('chat.mass_message_stats.purchase_total'),
				contentViewsStatLabel: i18n.__('chat.mass_message_stats.content_views')
			};

			if (typeof messageJson.rules !== 'undefined') {
				var status = this.getFormatedStatus(messageJson.status);
				messageJson.status = messageJson.status.trim();
				messageData.isCancelable = status === 'pending';
				messageData.isCompleted = status === 'completed';
				messageData.isDuplicable = true;
				messageData.rulesTranslated = messageJson.rules_translated;
				messageData.status = status;
				messageData.statusLabel = i18n.__('chat.mass_message_status.' + status);
			}

			if (typeof messageJson.event !== 'undefined') {
				messageData.event = messageJson.event;
				messageData.param = messageJson.param;
				messageData.eventTranslated = messageJson.event_translated;
				messageData.isActive = messageJson.is_active;
				messageData.isEditable = true;
				messageData.isSwitchable = true;
			}

			return new MessagesListItem(messageData).getElement();
		},
		getCurrentPage: function() {
			return this.currentPage;
		},
		getFormatedStatus: function(statusFromApi) {
			var status = {
				canceled: 'canceled',
				executed: 'completed',
				executing: 'running',
				error: 'error',
				pending: 'pending'
			}
			return status[statusFromApi];
		},
		initLoadMore: function(callbackLoad) {
			if (this.lastPage <= this.currentPage) {
				return;
			}
			var messagesListElt = this.element,
				loadMoreElt = document.createElement('li'),
				componentName = this.componentName,
				classes = [componentName + '__item', componentName + '__item--load-more', componentName + '__item--text'];

			loadMoreElt.classList.add(...classes);
			loadMoreElt.innerText = i18n.__('chat.show_more');
			messagesListElt.append(loadMoreElt);

			this.loadMoreObserver = new IntersectionObserver(function(entries, observer) {
				entries.forEach(function(entry){
					if (entry.isIntersecting && typeof callbackLoad === 'function') {
						loadMoreElt.remove();
						callbackLoad();
					}
				});
			}, {
				root: messagesListElt,
				rootMargin: '0px 0px 50px',
				threshold: 1
			});
			this.loadMoreObserver.observe(loadMoreElt);
		},
		removeMessage: function(selector) {
			this.getElement().querySelector(selector).remove();
		},
		setComponentName: function(name) {
			this.componentName = name;
		},
		setCurrentPage: function(page) {
			this.currentPage = page;
		},
		setLastPage: function(page) {
			this.lastPage = page;
		},
		setMessageCanceled: function(messageJson) {
			var messageHtml = this.getElement().querySelector('[data-id-mass-message="'+ messageJson.id +'"]');
			messageHtml.querySelector('.messages-list__menu-item--cancel').remove();
			this.setMessageStatus(messageHtml, messageJson.status);
		},
		setMessageStatus: function(messageHtml, newStatus) {
			var classStatus = 'messages-list__message-status',
				status = messageHtml.querySelector('.' + classStatus),
				statusClasses = status.className.split(' '),
				classToReplace = '';
			for (var indexClass in statusClasses) {
				if (statusClasses[indexClass] === (classStatus)) {
					continue;
				}
				classToReplace = statusClasses[indexClass];
			}
			status.classList.replace(classToReplace, (classStatus + '--' + newStatus));
			status.innerText = i18n.__('chat.mass_message_status.' + newStatus);
		},
		setMessageSent: function(idMassMessage) {
			var classBase = '.messages-list__',
				messageHtml = this.getElement().querySelector('[data-id-mass-message="'+ idMassMessage +'"]');
			if (messageHtml !== null) {
				if (messageHtml.querySelector(classBase + 'message-status') !== null) {
					messageHtml.querySelector(classBase + 'message-status').remove();
				}
				if (messageHtml.querySelector(classBase + 'menu-item--cancel') !== null) {
					messageHtml.querySelector(classBase + 'menu-item--cancel').remove();
				}
			}
		}
	});

	return MessagesList;
});

define('text!ui/FormTabs/FormTabs.mustache',[],function () { return '<div{{#classes}} class="{{{classes}}}"{{/classes}}{{#attributes}} {{{attributes}}}{{/attributes}}>\n\t{{#showTabs}}\n\t\t<ul class="chat-tabs chat-tabs--attachment">\n\t\t\t{{#tabs}}\n\t\t\t\t<li class="chat-tabs__item{{#isActive}} active{{/isActive}}" data-toggle="#chat-{{systemName}}" data-group="form-tabs-{{formTabsId}}" data-name="{{systemName}}">\n\t\t\t\t\t<svg class="chat-scc"><use xlink:href="#{{iconId}}"></use></svg>\n\t\t\t\t\t<span>{{label}}</span>\n\t\t\t\t</li>\n\t\t\t{{/tabs}}\n\t\t</ul>\n\t{{/showTabs}}\n\n\t{{#tabs}}\n\t\t<div id="chat-{{systemName}}" class="chat-toggle{{#isActive}} chat-toggle--show{{/isActive}}">\n\t\t\t{{{field}}}\n\t\t</div>\n\t{{/tabs}}\n</div>';});

define('ui/FormTabs/FormTabs',[
	'config/chat',
	'core/Component',
	'text!ui/FormTabs/FormTabs.mustache'
], function(
	Config,
	Component,
	tplFormTabs
) {
	/**
	 * @extends Component
	 * @constructor
	 */
	var FormTabs = function(options) {
		this.template = tplFormTabs;
		this.selected = "";
		this.options = Object.assign({}, {
			attributes: [],
			classes: "",
			priceField: null,
			showTabs: false,
			systemName: "",
			tabs: [],
		}, options);
		Component.call(this);
	};

	FormTabs.prototype = Object.create(Component.prototype);

	Object.assign(FormTabs.prototype, {
		addListeners: function () {
			this.addElementListener('[data-toggle]', 'click', this.onTabClick.bind(this));
		},
		/**
		 * Add a tab to the view
		 *
		 * @param {object} tabInfos
		 * @param {string} tabInfos.field
		 * @param {string} tabInfos.iconId
		 * @param {boolean} tabInfos.isActive
		 * @param {string} tabInfos.label
		 * @param {string} tabInfos.systemName
		 * @param {string} tabInfos.tabId
		 * @param {number=} tabInfos.position
		 */
		addTab: function (tabInfos) {
			this.registerTab(tabInfos);
			this.refreshElement();
		},
		getForcedTemplateParams: function () {
			return {formTabsId: 'id-' + Math.random().toString(32).substring(2)};
		},
		getSelectedTabName: function () {
			return this.selected;
		},
		getSelectedTabElement: function () {
			return this.getElement().querySelector('[data-toggle="#chat-' + this.selected + '"]');
		},
		onTabClick: function (event) {
			var target = event.target,
				tab = target.dataset && target.dataset.toggle ? target : target.closest('[data-toggle]');
			this.selected = tab.dataset.name;
		},
		selectTab: function (systemName) {
			var evt = new MouseEvent('click', {
				bubbles: true,
				cancelable: true,
				view: window
			});
			this.element.querySelector(`[data-name="${systemName}"]`).dispatchEvent(evt);
		},
		selectTabByIndex: function (index) {
			index = +index || 0;
			this.selectTab(this.options.tabs[index].systemName);
		},
		registerTab: function (tabInfos) {
			if (tabInfos.isActive) {
				this.options.tabs.forEach(function (tab) {
					tab.isActive = false;
				});
				this.selected = tabInfos.systemName;
			}

			if ("undefined" != typeof tabInfos.position) {
				this.options.tabs.splice(tabInfos.position, 0, tabInfos);
			} else {
				this.options.tabs.push(tabInfos);
			}

			this.options.showTabs = this.options.tabs.length > 1;
		},
		resetTabs: function () {
			if (!this.options.tabs.length) {
				return;
			}

			var defaultTab = this.options.tabs.filter(function (tab) { return !!tab.isActive; }).pop();

			if (defaultTab) {
				this.selectTab(defaultTab.systemName);
				return;
			}

			this.selectTab(this.options.tabs[0].systemName);
		}
	});

	return FormTabs;
});
define('ui/Popover/Popover',[
    'config/chat',
    'lib/helpers/popup'
], function(
    Config,
    Popup
) {
    var BASE_CLASS_NAME = 'chat-ui-popover';

    var DEFAULT_OPTIONS = {
        closable: false,
        trigger: null
    };

    /**
     * @constructor
     */
    var Popover = function(anchorElement, content, options) {
        this.anchorElement = anchorElement;
        this.content = content;
        this.popup = null;
        this.options = Object.assign({}, DEFAULT_OPTIONS, options || {});
    };

    Object.assign(Popover.prototype, {
        open: function () {
            this.popup = new Popup(this.anchorElement, this.content, this.options);
            this.popup.open();
            this.popup.getPopup().addClass(BASE_CLASS_NAME);
        },
        close: function () {
            if (!this.popup) {
                return;
            }
            this.popup.delete();
        },
        hide: function () {
            if (!this.popup) {
                return;
            }
            this.popup.hide();
        },
        show: function () {
            if (!this.popup) {
                return;
            }
            this.popup.show();
        }
    });

    return Popover;
});

define('text!ui/FormField/Input/Input.mustache',[],function () { return '<div class="chat-ui-form-field chat-ui-input">\n\t{{#label}}<label class="chat-ui-form-field__label"{{labelFor}} for="{{labelFor}}"{{labelFor}}>{{label}}</label>{{/label}}\n\t{{#prepend}}<div class="chat-ui-input-group">{{/prepend}}\n\t\t{{#prepend}}\n\t\t<div class="chat-ui-input__prepend">\n\t\t\t<span>{{prepend}}</span>\n\t\t</div>\n\t\t{{/prepend}}\n\t\t<input type="{{type}}" class="chat-ui-input__input{{#classes}} {{classes}}{{/classes}}"{{#attributes}} {{{attributes}}}{{/attributes}} />\n\t{{#prepend}}</div>{{/prepend}}\n\t{{#description}}<p class="chat-ui-form-field__description">{{description}}</p>{{/description}}\n</div>';});

define('ui/FormField/Input/Input',[
	'lib/tools',
	'ui/FormField/Field',
	'ui/Popover/Popover',
	'text!ui/FormField/Input/Input.mustache'
], function(
	tools,
	Field,
	Popover,
	tplInput
) {
	/**
	 * Input form field.
	 *
	 * @extends Field
	 *
	 * @param {Object} options
	 * @param {Object} options.attributes An object to transform as input attributes.
	 * @param {String} options.classes A list of classes to append to the input class attribute.
	 * @param {String} options.description Add a description to display below the input.
	 * @param {String} options.label Add a label to display above the input.
	 * @param {String} options.labelFor The input ID attribute value.
	 * @param {String} options.prepend Add a string to display before the input.
	 * @param {Boolean} options.errorPopover Display error message into a popover (default: false).
	 *
	 * @constructor
	 */
	var Input = function(options) {
		this.options = this.prepareOptions(options, {errorPopover: false});
		this.template = this.template || tplInput;
		Field.call(this);
	};

	Input.prototype = Object.create(Field.prototype);

	Object.assign(Input.prototype, {
		getField: function () {
			var input = this.element.querySelector('input');

			if (!input) {
				throw new Error('Input not found');
			}

			return input;
		},
		getValue: function () {
			return this.getField().value || this.getField().dataset.value;
		},
		removeError: function () {
			this.element.querySelectorAll('.chat-ui-input__input').forEach(function (element) {
				element.classList.remove('chat-ui-input__input--error');
			});

			if (this.options.errorPopover && this.errorPopover) {
				this.errorPopover.close();
			} else {
				var message = this.element.querySelector('.chat-ui-form-field__error-message');

				if (!message) {
					return;
				}

				this.element.removeChild(message);
			}
			this.error = false;
		},
		setError: function (message) {
			if (this.error) {
				return;
			}

			this.error = true;
			this.element.querySelectorAll('.chat-ui-input__input').forEach(function (element) {
				element.classList.add('chat-ui-input__input--error');
			});

			if (!message) {
				return;
			}

			var errorMessage = tools.string_to_node(`<p class="chat-ui-form-field__error-message">${message}</p>`);

			if (this.options.errorPopover) {
				this.errorPopover = new Popover(
					this.element.querySelector('.chat-ui-input__input'),
					errorMessage,
					{
						autoclose: false,
						fade: false,
						position: {v: 'above', h: 'left'}
					}
				);
				this.errorPopover.open();
			} else {
				this.getField().before(errorMessage);
			}
		},
		setValue: function (value) {
			this.getField().value = value;
			this.getField().dataset.value = value;
		}
	});

	return Input;
});
define('lib/emojionearea',[], function() {
	var DEFAULT_OPTIONS = {
		hideSource: true,
		useInternalCDN: true,
		sprite: true,
		autocomplete: false,
		textcomplete: {
			maxCount: 12
		},
		attributes: {
			spellcheck: true,
			autocomplete: 'on',
			autocorrect: 'on'
		}
	}

	return {
		installOn: function (element, emojioneAreaOptions) {
			if (typeof $ !== 'function' || typeof $.fn !== 'object') {
				throw new Error('jQuery not found');
			}

			if (typeof $.fn.emojioneArea !== 'function') {
				throw new Error('emojioneArea not found');
			}

			var jQueryObject = $(element),
				opts = $.extend({}, DEFAULT_OPTIONS, emojioneAreaOptions);

			return jQueryObject.emojioneArea(opts);
		}
	};
});

define('text!ui/FormField/Textarea/Textarea.mustache',[],function () { return '<div class="chat-ui-form-field chat-ui-textarea">\n\t{{#label}}<label class="chat-ui-form-field__label"{{labelFor}} for="{{labelFor}}"{{labelFor}}>{{label}}</label>{{/label}}\n\t<textarea class="chat-ui-textarea__textarea" {{#attributes}} {{{attributes}}}{{/attributes}}></textarea>\n</div>';});

define('ui/FormField/Textarea/Textarea',[
	'lib/emojionearea',
	'lib/i18n!front',
	'lib/tools',
	'ui/FormField/Field',
	'text!ui/FormField/Textarea/Textarea.mustache'
], function(
	EmojioneArea,
	i18n,
	tools,
	Field,
	tplTextarea
) {
	/**
	 * Textarea form field component with emoji support
	 *
	 * @extends Field
	 * @param {Object} options - Field options
	 * @param {Object} [options.attributes={}] An object to transform as textarea attributes.
	 * @param {String} [options.placeholder="Message"] - (deprecated) Placeholder text to insert. Please, set it directly as attribute.
	 * @param {Number} [options.rows=1] - (deprecated) Number of rows to display. Please, set it directly as attribute.
	 * @param {Boolean} [options.withEmoji=true] - Enable emoji support.
	 * @constructor
	 */
	var Textarea = function(options) {
		this.options = this.prepareOptions(options, {
			placeholder: i18n.__('chat.textarea_message_placeholder'),
			withEmoji: true,
			attributes: {
				rows: 1,
				resize: 'none'
			}
		});
		this.template = tplTextarea;
		this.error = false;
		Field.call(this);

		if (this.options.value) {
			this.setValue(this.options.value)
		}
	};

	Textarea.prototype = Object.create(Field.prototype);

	Object.assign(Textarea.prototype, {
		createElement: function () {
			Field.prototype.createElement.call(this);

			if (!this.options.withEmoji) {
				return;
			}

			var textarea = this.getTextarea();

			if (textarea) {
				EmojioneArea.installOn(textarea);
			}
		},
		disable: function () {
			if (this.options.withEmoji) {
				this.getTextarea().emojioneArea.disable();
			} else {
				Field.prototype.disable.call(this);
			}
		},
		enable: function () {
			if (this.options.withEmoji) {
				this.getTextarea().emojioneArea.enable();
			} else {
				Field.prototype.enable.call(this);
			}
		},
		getField: function () {
			if (this.options.withEmoji) {
				return this.getEmojioneArea();
			} else {
				return this.getTextarea();
			}
		},
		getEmojioneArea: function () {
			return this.element.querySelector('.emojionearea');
		},
		getTextarea: function () {
			var textarea = this.element.querySelector('textarea');

			if (!textarea) {
				throw new Error('Textarea not found');
			}

			return textarea;
		},
		getValue: function () {
			var textarea = this.getTextarea();

			var value = (textarea.value || "").trim();

			if (!this.options.withEmoji) {
				return value;
			}

			var emojioneArea = textarea.emojioneArea;

			if (emojioneArea) {
				value = emojioneArea.getText();
			}

			return value;
		},
		/**
		 * @extends Field.prototype.prepareOptions
		 * @param {Object} [options={}] - The specific options provided by the user.
		 * @param {Object} [defaultOptions={}] - The default options.
		 * @returns {Object} A consolidated configuration object.
		 */
		prepareOptions: function (options, defaultOptions) {
			var mergedOptions = Field.prototype.prepareOptions.call(this, options, defaultOptions);

			if (typeof mergedOptions.rows === 'number' || typeof mergedOptions.rows === 'string') {
				mergedOptions.attributes.rows = +mergedOptions.rows;
				delete mergedOptions.rows;
			}

			if (typeof mergedOptions.attributes.resize === 'string' && mergedOptions.attributes.resize !== 'none') {
				mergedOptions.attributes.style = (mergedOptions.attributes.style || "") + ` resize: ${mergedOptions.attributes.resize};`;
				delete mergedOptions.attributes.resize;
			}

			return mergedOptions;
		},
		removeError: function () {
			this.element.querySelectorAll('.chat-ui-textarea__textarea').forEach(function (element) {
				element.classList.remove('chat-ui-textarea__textarea--error');
			});

			var message = this.element.querySelector('.chat-ui-form-field__error-message');

			if (!message) {
				return;
			}

			this.element.removeChild(message);
			this.error = false;
		},
		setError: function (message) {
			if (this.error) {
				return;
			}

			this.error = true;
			this.element.querySelectorAll('.chat-ui-textarea__textarea').forEach(function (element) {
				element.classList.add('chat-ui-textarea__textarea--error');
			});

			if (!message) {
				return;
			}

			var errorMessage = tools.string_to_node(`<p class="chat-ui-form-field__error-message">${message}</p>`);
			this.getTextarea().before(errorMessage);
		},
		setValue: function (value) {
			var textarea = this.getTextarea();
			textarea.value = value;
			textarea.innerText = value;

			if (textarea.emojioneArea) {
				textarea.emojioneArea.setText(value);
			}
		}
	});

	return Textarea;
});
define('features/CreatorMessages/views/CreatorMessagesView',[
	'chat/dropzone/dropzone',
	'config/chat',
	'core/View',
	'text!features/CreatorMessages/views/CreatorMessages.mustache',
	'lib/i18n!front',
	'lib/tools',
	'log_and_tooltip',
	'features/CreatorMessages/views/components/DynamicVar/DynamicVar',
	'features/CreatorMessages/views/components/MessagesList/MessagesList',
	'ui/FormTabs/FormTabs',
	'ui/FormField/Input/Input',
	'ui/FormField/Textarea/Textarea',
	'ui/Modal/ConfirmModal'
], function(
	Dropzone,
	Config,
	View,
	tplCreatorMessages,
	i18n,
	tools,
	LogAndTooltip,
	DynamicVar,
	MessagesList,
	FormTabs,
	Input,
	Textarea,
	ConfirmModal
) {
	var MESSAGE_WRAPPER_SELECTOR = '.chat-creator-messages-message-wrapper',
		CREATOR_MESSAGE_TITLE = '.chat-creator-messages__title',
		CREATOR_MESSAGE_TITLE_TEXT = '.chat-creator-messages__title-text',
		CREATOR_MESSAGE_TITLE_ICON = '.chat-creator-messages__title-icon',
		ATTACHMENT_BUTTON_SELECTOR = '.chat-btn--creator-messages-attachment',
		BACK_BUTTON_TO_FORM_SELECTOR = '.chat-btn--creator-messages-back-to-form-step',
		NEW_BUTTON_SELECTOR = '.chat-btn--creator-messages-new',
		PRICE_BUTTON_SELECTOR = '.chat-btn--creator-messages-price',
		DELAY_BUTTON_SELECTOR = '.chat-btn--creator-messages-delay',
		SAVE_BUTTON_SELECTOR = '.chat-btn--creator-messages-save',
		STATS_BUTTON_SELECTOR = '.chat-btn--creator-messages-stats',
		LIST_SECTION_ELEMENTS = [NEW_BUTTON_SELECTOR, '.chat-creator-messages__list', BACK_BUTTON_TO_FORM_SELECTOR],
		FORM_SECTION_ELEMENTS = [STATS_BUTTON_SELECTOR, '.chat-creator-messages__form', SAVE_BUTTON_SELECTOR],
		FORM_ERROR_CLASS = 'chat-creator-messages__error',
		VAULT_TEXT_ENABLED = false;

	var CreatorMessagesView = function(contacts) {
		this.contactsData = contacts;
		this.contactsList = null;
		this.content = null;
		this.contentSystemName = null;
		this.changeEvent = null;
		this.currentList = null;
		this.delay = null;
		this.duration = null;
		this.dynamicVar = null;
		this.dz = null;
		this.eventsList = null;
		this.messagesLists = {};
		this.message = null;
		this.modal = null;
		this.price = null;
		this.template = tplCreatorMessages;
		this.title = null;
		this.vault = null;
		this.vaultSystemName = null;
		View.call(this);
		this.mediator.emitCreateContentInstance();
		this.mediator.emitCreateVaultInstance();
		this.initModal();
	};

	CreatorMessagesView.prototype = Object.create(View.prototype);

	Object.assign(CreatorMessagesView.prototype, {
		addListeners: function () {
			this.addElementListener(CREATOR_MESSAGE_TITLE_ICON, 'click', this.onClickTitleIconMessageIcon.bind(this));
			this.addElementListener(SAVE_BUTTON_SELECTOR, 'click', this.onClickSaveButton.bind(this));
			this.addElementListener(NEW_BUTTON_SELECTOR, 'click', this.onClickCreateMessage.bind(this));
			this.addElementListener(STATS_BUTTON_SELECTOR, 'click', this.onClickStatsMessage.bind(this));
			this.addElementListener(PRICE_BUTTON_SELECTOR, 'click', this.onClickPriceButton.bind(this));
			this.addElementListener(BACK_BUTTON_TO_FORM_SELECTOR, 'click', this.onClickCreateMessage.bind(this));
			this.addElementListener(ATTACHMENT_BUTTON_SELECTOR, 'click', this.onClickAttachmentButton.bind(this));
		},
		addListenersMessageList:function() {
			var element = this.getElement(),
				classNotInit = 'is-not-init',
				messages = element.querySelectorAll('.messages-list__message.' + classNotInit);

			for (var index in messages) {
				if (typeof messages[index].tagName === 'undefined') {
					return;
				}

				this.addListenersMessageListFeature(messages[index], classNotInit);
			}
		},
		addListenersMessageListFeature: function() {},
		addMessagesList: function(listName, list) {
			this.messagesLists[listName] = list;
		},
		addContent: function (content) {
			var self = this,
				tabInfo = {
					type: 'selector',
					systemName: 'creator-messages-content-selector',
					iconId: 'scc-safe-icon',
					label: i18n.__('chat.content'),
					field: '<div id="chat-creator-messages-content">Content</div>', // @TODO This is a placeholder, update the html to make it more obvious
					fieldId: 'chat-creator-messages-content'
				};

			this.content = content;
			this.content.fillMessageFormFields = function (data) {
				self.content._originalFillMessageFormFields(data);
				var priceToggler = document.querySelector('[data-toggle="#chat-creator-messages-toggle-price"]');
				if (data.buy_button && data.buy_button.price && priceToggler && priceToggler.classList.contains('active') === false) {
					priceToggler.click();
				}
			};
			this.content.setMessageProvider(this.getMessage.bind(this));
			this.contentSystemName = tabInfo.systemName;

			this.getFormTabs().addTab(tabInfo);
		},
		addVault: function (vault) {
			var self = this,
				tabInfo = {
					type: 'selector',
					systemName: 'creator-messages-vault-selector',
					iconId: 'scc-safe-icon',
					label: i18n.__('chat.vault'),
					field: '<div id="chat-creator-messages-vault">Vault</div>', // @TODO This is a placeholder, update the html to make it more obvious
					fieldId: 'chat-creator-messages-vault',
					position: 2
				};

			this.vault = vault;
			this.vault.fillMessageFormFields = function (data) {
				self.vault._originalFillMessageFormFields(data);
				var priceToggler = document.querySelector('[data-toggle="#chat-creator-messages-toggle-price"]');
				if (data.buy_button && data.buy_button.price && priceToggler && priceToggler.classList.contains('active') === false) {
					priceToggler.click();
				}
			};
			this.vault.setMessageProvider(this.getMessage.bind(this));
			this.vaultSystemName = tabInfo.systemName;

			this.getFormTabs().addTab(tabInfo);
		},
		checkRuleAvailability: function () {},
		checkRulesAvailabilities: function () {},
		createElement: function () {
			View.prototype.createElement.call(this);

			/*this.title = new Input({
				attributes: {
					type: 'text',
					id: 'chat-creator-messages-title',
					placeholder: i18n.__('misc.title')
				}
			});
			this.title.getElement().classList.add('is-hidden');
			tools.replaceElement(this.element.querySelector('#title-placeholder'), this.title.getElement());*/

			this.message = new Textarea({ rows: 5, attributes: { id: 'chat-creator-messages-message' }});
			tools.replaceElement(this.element.querySelector('#message-placeholder'), this.message.getElement());

			this.formTabs = new FormTabs();
			tools.replaceElement(this.element.querySelector('#attachment-placeholder'), this.formTabs.getElement());
			this.formTabs.getElement().addEventListener('refresh', this.onRefreshFormTabs.bind(this));

			if (VAULT_TEXT_ENABLED) {
				var tabInfo = {
					type: 'text',
					systemName: 'mass-message-vault-text',
					iconId: 'scc-safe-icon',
					label: i18n.__('chat.text'),
					field: '',
					fieldId: 'chat-mass-message-vault-text',
					position: 1
				};
				this.formTabs.addTab(tabInfo);
			}

			this.price = new Input({
				type: 'text',
				attributes: {
					id: 'chat-creator-messages-price',
					inputmode: 'decimal',
					pattern: '[0-9]*([\.][0-9]+)?',
					placeholder: i18n.__('chat.vault.price', {
						'%price_min%': Config.file_upload.ppc.min.toString(),
						'%price_max%': Config.file_upload.ppc.max.toString()
					})
				},
				prepend: '$',
				errorPopover: true
			});
			tools.replaceElement(this.element.querySelector('#price-placeholder'), this.price.getElement());
		},
		createError: function() {
			var message_wrapper = this.getElement().querySelector(MESSAGE_WRAPPER_SELECTOR),
				error = document.createElement('div');

			error.classList.add(FORM_ERROR_CLASS);
			message_wrapper.parentNode.append(error);

			return error;
		},
		createMessage: function() {
			this.element.querySelector(CREATOR_MESSAGE_TITLE_TEXT).innerText = this.getNewMessageTitle();
			this.element.querySelector(CREATOR_MESSAGE_TITLE_ICON).classList.remove('is-hidden');
			this.toggleDisplay(LIST_SECTION_ELEMENTS, FORM_SECTION_ELEMENTS);
			this.messagePreviewUI(false);
		},
		createOrGetVaultContent: function (featureName) {
			if (this.formTabs.getSelectedTabName() === "creator-messages-content-selector") {
				return this.content.creatorMessageGetMessage();
			} else if (this.formTabs.getSelectedTabName() === "creator-messages-vault-selector") {
				return this.vault.creatorMessageGetMessage();
			} else if (this.formTabs.getSelectedTabName() === "creator-messages-vault-text") {
				this.vault.creatorMessageCreateTextContent(featureName);
			} else if (this.vault.canProcess()) {
				this.vault.creatorMessageCreateContent(featureName);
			}
		},
		disableFormButton: function(isDisabled, selector) {
			var button = document.querySelector(selector);
			if (button === null) {
				return;
			}
			button.disabled = isDisabled;
			if (isDisabled) {
				button.classList.add('is-disabled');
			}
			else {
				button.classList.remove('is-disabled');
			}
		},
		disableMessageForm: function(isDisabled) {
			this.disableMessageWrapper(isDisabled);

			var buttons = [ATTACHMENT_BUTTON_SELECTOR, DELAY_BUTTON_SELECTOR, PRICE_BUTTON_SELECTOR, SAVE_BUTTON_SELECTOR];
			for (var index in buttons) {
				this.disableFormButton(isDisabled, buttons[index]);
			}
		},
		disableMessageWrapper: function(isDisabled) {
			var message_wrapper = this.getElement().querySelector(MESSAGE_WRAPPER_SELECTOR);
			if (isDisabled) {
				message_wrapper.classList.add('is-disabled');
			}
			else {
				message_wrapper.classList.remove('is-disabled');
			}
		},
		disableSaveButton: function (isDisabled) {
			this.disableFormButton(isDisabled, SAVE_BUTTON_SELECTOR);
		},
		emptyAttachmentFields: function () {
			this.dz.getInstance().removeAllFiles();
			this.vault.clearMessageFormFields(true);
			this.content.clearMessageFormFields(true);
		},
		emptyFormFields: function () {
			this.setPrice('');
			this.setMessage('');
			this.setTitle('');
			this.emptyPriceButton();
			this.emptyAttachmentFields();
			this.vault.clearMessageFormFields(true);
			this.content.clearMessageFormFields();

			if (VAULT_TEXT_ENABLED) {
				this.setVaultText('');
			}
		},
		emptyPriceButton: function() {
			var btn = this.element.querySelector(PRICE_BUTTON_SELECTOR);
			btn.innerHTML = '<svg class="chat-scc"><use xlink:href="#scc-creator-messages-price-icon"></use></svg>';
			btn.classList.remove('has-price');
		},
		getCurrentList: function() {
			return this.currentList;
		},
		getDelaySendDate: function() {
			return false;
		},
		getFeatureName: function() {},
		getFeatureTitle: function() {},
		getFormTabs: function () {
			return this.formTabs;
		},
		getForcedTemplateParams: function () {
			return {
				beta: this.isBeta(),
				hasContactsList: this.hasContactsList(),
				hasDynamicVar: this.hasDynamicVar(),
				hasEventsList: this.hasEventsList(),
				hasPrice: this.hasPrice(),
				className: 'chat-creator-messages',
				title: this.getNewMessageTitle(),
				back: i18n.__('chat.back'),
				newMessage: i18n.__('chat.new_message'),
				statsMessages: i18n.__('chat.mass_message_stats'),
				legendContactsList: i18n.__('chat.mass_message_recipients'),
				legendEventsList: i18n.__('chat.auto_message_events'),
				messageTitle: i18n.__('chat.message'),
				attachmentLabel: i18n.__('chat.attachment'),
				delayLabel: i18n.__('chat.send_delay'),
				priceLabel: i18n.__('chat.set_price_to_message'),
				saveLabel: i18n.__('chat.message_send'),
				maxSize: i18n.__('upload-size-limit', {"%limit%": Config.login_info.is_creator ? '30GB' : '500MB'})
			};
		},
		getGuide: function() {},
		getIsValidPrice: function(price) {
			if (typeof price === 'undefined' || isNaN(price)) {
				return false;
			}
			price = parseFloat(price);
			return !(price < Config.file_upload.ppc.min || price > Config.file_upload.ppc.max);
		},
		getMessagesLists: function() {
			return this.messagesLists;
		},
		getMessagesList: function(listName) {
			return this.messagesLists[listName];
		},
		getMessagesListTitle: function() {},
		getMessageData: function(featureName) {
			var data = undefined;

			if (this.isTogglerActive('chat-creator-messages-toggle-attachment')) {
				var contentData = this.createOrGetVaultContent(featureName);
				if (contentData) {
					data = this.prepareMessageData(contentData);
				}
			} else {
				data = this.prepareMessageData();
			}

			return data;
		},
		getMessage: function () {
			return this.message.getValue();
		},
		getNewMessageTitle: function() {},
		getNoMessagesLabel: function() {},
		getPrice: function () {
			return +this.price.getValue();
		},
		getTitle: function () {
			//return this.title.getValue();
			return '';
		},
		hasContactsList: function() {
			return false;
		},
		hasDynamicVar: function() {
			return false;
		},
		hasEventsList: function() {
			return false;
		},
		hasPrice: function() {
			return false;
		},
		hasToShowCloseAttachmentModal: function () {
			if (this.formTabs.getSelectedTabName() === "creator-messages-content-selector") {
				return this.content.hasContentSelected;
			}

			if (this.formTabs.getSelectedTabName() === "creator-messages-vault-selector") {
				return this.vault.hasContentSelected;
			}

			return this.vault.canProcess();
		},
		initContent: function () {
			tools.replaceElement('#chat-creator-messages-content', tools.string_to_node(this.content.get_field(false)));

			var self = this;
			this.content.setGetText(function () {
				return self.message.getValue();
			});
			this.content.setGetTitle(function () {
				return self.getTitle();
			});
		},
		initDropzone: function () {
			this.dz = new Dropzone({
				id: 'chat-creator-messages-files',
				token: Config.file_upload.token['chat-mass-message-files']
			});
			tools.replaceElement('#chat-creator-messages-files', tools.string_to_node(this.dz.getFieldHtml()));
			this.dz.init();
		},
		initDynamicVar: function (container) {
			if (!this.hasDynamicVar()) {
				return;
			}

			this.dynamicVar = new DynamicVar({
				label: i18n.__('chat.dynamic_var.label')
			});
			tools.replaceElement('#dynamic-var-placeholder', this.dynamicVar.getElement());
			this.dynamicVar.setContainer(this.message);
		},
		initLoadMore: function(callbackLoad, listName) {
			this.callbackLoadMore = callbackLoad;
			this.messagesLists[listName].initLoadMore(this.callbackLoadMore);
		},
		initMessagesList(data, listName) {
			var componentName = 'messages-list',
				hasMessages = data.total > 0;

			this.addMessagesList(listName, new MessagesList({
				attributes: {
					'data-list': listName
				},
				componentName: componentName,
				noMessage: this.getNoMessagesLabel(),
				hasMessages: hasMessages
			}));

			this.messagesLists[listName].setComponentName(componentName);

			if (hasMessages) {
				this.messagesLists[listName].setCurrentPage(data.currentPage);
				this.messagesLists[listName].setLastPage(data.lastPage);
			}

			if (this.element.querySelectorAll('#messages-list-placeholder').length > 0) {
				tools.replaceElement(this.element.querySelector('#messages-list-placeholder'), this.messagesLists[listName].getElement());
			}
			else {
				document.querySelector('.messages-list').parentNode.append(this.messagesLists[listName].getElement());
			}

			this.setCurrentList(listName);
		},
		initModal: function() {
			this.modal = LogAndTooltip.modal(this.element, { closable: true });
			this.modal.close_node.one('click', this.remove.bind(this));
			this.modal.container
				.closest('.x-body')
				.addClass('chat-creator-messages-popup');

			this.initDropzone();
			this.initContent();
			this.initVault();
			this.initDynamicVar(this.modal.container[0]);
		},
		initVault: function () {
			tools.replaceElement('#chat-creator-messages-vault', tools.string_to_node(this.vault.get_field(false)));

			if (VAULT_TEXT_ENABLED) {
				this.vaultText = new Textarea({rows: 5, placeholder: 'Private message'});
				this.element.querySelector('#chat-creator-messages-vault-text').appendChild(this.vaultText.getElement());
			}

			var self = this;
			this.vault.setGetText(function () {
				return self.message.getValue();
			});

			this.vault.setGetPrivateText(function () {
				if (VAULT_TEXT_ENABLED) {
					return self.vaultText.getValue();
				}
			});
			this.vault.setGetTitle(function () {
				return self.getTitle();
			});
		},
		isBeta: function() {
			return false;
		},
		isTogglerActive: function (id) {
			var toggler = document.querySelector(`[data-toggle="#${id}"]`);
			return toggler && toggler.classList.contains('active');
		},
		messagePreviewUI: function() {},
		messageSaved: function() {
			this.emptyFormFields();
			this.getElement().querySelector(SAVE_BUTTON_SELECTOR).innerText = i18n.__('save');
			this.disableMessageForm(false);
		},
		onClickAttachmentButton: function (event) {
			var button = event.currentTarget,
				attachmentIsDisplayed = button.classList.contains('active');

			if (attachmentIsDisplayed && this.hasToShowCloseAttachmentModal() && !this.changeEvent) {
				var self = this;
				this.showCloseAttachmentModal(function () {
					self.toggleAttachmentButtonIcon(!attachmentIsDisplayed);
					self.toggleTitleFieldDisplay(undefined, attachmentIsDisplayed);
					self.emptyAttachmentFields();
					self.getFormTabs().resetTabs();

					// @TODO Find a better solution
					var toggler = $(button);
					toggler.toggleClass('active');
					$(toggler.data('toggle')).toggleClass('chat-toggle--show');
				});
				event.stopPropagation();
				return;
			}

			this.toggleAttachmentButtonIcon(!attachmentIsDisplayed);
			this.toggleTitleFieldDisplay(undefined, attachmentIsDisplayed);

			this.changeEvent = false;
		},
		onClickCreateMessage: function() {
			this.createMessage();
		},
		onClickSaveButton: function () {
			if (this.validateForm() === false) {
				return;
			}

			var error = this.getElement().querySelector('.' + FORM_ERROR_CLASS);
			if (error) {
				error.remove();
			}

			this.getElement().querySelector(SAVE_BUTTON_SELECTOR).innerText = i18n.__('chat.error.please_wait');
			this.disableMessageForm(true);

			var messageData = this.getMessageData(this.getFeatureName());
			if (messageData) {
				this.saveMessage(messageData);
			}
		},
		onClickTitleIconMessageIcon: function(event) {
			var content = `<div class="header"><span>${i18n.__('chat.information')}</span></div><div class="content"><ul>${this.getGuide()}</ul></div>`,
				modal = LogAndTooltip.modal(content, {
					closable: true
				}, false);

			modal.container
				.closest('.x-body')
				.addClass('chat-ui-modal-info');
		},
		onClickAttachmentTabsItem: function (event) {
			var currentTab = event.currentTarget,
				classAction = currentTab.dataset.name.indexOf('creator-messages') !== -1 ? 'add' : 'remove';

			this.toggleTitleFieldDisplay(currentTab);
			this.getElement().querySelector('.chat-file-size-limit').classList[classAction]('is-hidden');
		},
		onClickPriceButton: function () {},
		onClickStatsMessage: function() {
			this.element.querySelector(CREATOR_MESSAGE_TITLE_TEXT).innerText = this.getMessagesListTitle();
			this.element.querySelector(CREATOR_MESSAGE_TITLE_ICON).classList.add('is-hidden');
			this.emptyFormFields();
			this.toggleDisplay(FORM_SECTION_ELEMENTS, LIST_SECTION_ELEMENTS);
			this.onClickStatsMessageFeature();
		},
		onClickStatsMessageFeature: function() {},
		onRefreshFormTabs: function () {
			this.addElementListener('.chat-tabs__item', 'click', this.onClickAttachmentTabsItem.bind(this));
		},
		onVaultContentCreated: function (result) {
			var message = this.vault.creatorMessageGetMessageFromBackEndResponse(result);
			var messageData = this.prepareMessageData(message);

			if (messageData) {
				this.mediator.emitSaveMessage(messageData);
				this.emptyFormFields();
			}
		},
		onVaultContentError: function(result) {
			var error = this.getElement().querySelector('.' + FORM_ERROR_CLASS);
			if (!error) {
				error = this.createError();
			}
			error.innerHTML ='<p>' + i18n.__(result.message) + ' <span>(' + result.code + ')</span></p>';

			this.getElement().querySelector(SAVE_BUTTON_SELECTOR).innerText = i18n.__('save');
			this.disableMessageForm(false);
		},
		onVaultContentPreloaded: function(result) {
			this.updateMessagesWithVaultOrContent(result);
		},
		openAttachments: function (activeTabName) {
			var attachmentButton = this.element.querySelector(ATTACHMENT_BUTTON_SELECTOR);

			if (!attachmentButton || attachmentButton.classList.contains('active')) {
				return;
			}

			var activeTab;

			if (typeof activeTabName === "string") {
				activeTab = this.element.querySelector(`.chat-tabs--attachment .chat-tabs__item[data-name="${activeTabName}"]`);
			}

			if (activeTab) {
				activeTab.click();
			}

			attachmentButton.click();
		},
		openCancelConfirmation: function(callbackOnOk) {
			var modal = LogAndTooltip.modal(i18n.__('chat.mass_message_confirm_cancel'), {
				type: 'confirm',
				text_ok: i18n.__('misc.cancel'),
				text_cancel: i18n.__('misc.not_cancel'),
				on_ok: callbackOnOk,
			}, false);

			modal.container
				.closest('.x-body')
				.addClass('chat-creator-messages-cancel');
		},
		prepareMessageData: function () {},
		prepareMessageForMessagesList: function (messages) {
			for (var i = 0, l = messages.messages_translated.length; i < l; i++) {
				var message = messages.messages_translated[i];

				if (message.hasOwnProperty('is_content') === false) {
					continue;
				}

				if (message.is_vault) {
					this.preloadVaultData([{id: message.content_id}]);
				} else {
					this.preloadContentData([{id: message.content_id}]);
				}
			}

			return messages;
		},
		remove: function () {
			delete this.callbackLoadMore;
			this.content.detach();
			delete this.content;
			this.vault.detach();
			delete this.vault;
			LogAndTooltip.overlay_close();
			this.removeFeature();
			this.dz.dropzoneInstance.destroy();
			View.prototype.remove.call(this);
		},
		removeFeature: function() {},
		preloadVaultData: function (contents) {
			this.vault.preloadContents(contents);
		},
		preloadContentData: function (contents) {
			this.content.preloadContents(contents);
		},
		savePrice: function() {},
		saveMessage: function() {},
		setCurrentList: function(listName) {
			if (this.currentList === listName) {
				return;
			}
			this.currentList = listName;
		},
		setMessage: function(message) {
			this.message.setValue(message);
		},
		setVaultText: function(message) {
			this.vaultText.setValue(message);
		},
		setTitle: function(title) {
			if (this.title !== null) {
				this.title.setValue(title);
			}
		},
		setPrice: function(price) {
			this.price.setValue(price);
		},
		showCloseAttachmentModal: function (onOkCallback, onNoCallback) {
			new ConfirmModal('', {
				title: i18n.__('chat.attachment.close_notice_title_creator'),
				onOk: onOkCallback,
				onNo: onNoCallback
			});
		},
		toggleDisplay: function(elementsToHide, elementsToShow) {
			if (elementsToHide.length) {
				for (var hide in elementsToHide) {
					this.element.querySelector(elementsToHide[hide]).classList.add('is-hidden');
				}
			}
			if (elementsToShow.length) {
				for (var show in elementsToShow) {
					this.element.querySelector(elementsToShow[show]).classList.remove('is-hidden');
				}
			}
		},
		toggleFieldDisplay: function (button, show) {
			function click() {
				var evt = new MouseEvent('click', {
					bubbles: true,
					cancelable: true,
					view: window
				});
				button.dispatchEvent(evt);
			}

			if (show && !button.classList.contains('active')) {
				click();
			} else if (!show && button.classList.contains('active')) {
				click();
			}
		},
		toggleAttachmentButtonIcon: function (showCloseIcon) {
			var icon = this.element.querySelector(ATTACHMENT_BUTTON_SELECTOR + ' .chat-scc use');
			icon.setAttribute('xlink:href', showCloseIcon ? '#scc-message-attachment-close-icon' : '#scc-message-attachment-icon');
		},
		toggleAttachmentFieldDisplay: function (show) {
			var attachmentButton = this.element.querySelector(ATTACHMENT_BUTTON_SELECTOR);
			this.toggleFieldDisplay(attachmentButton, show);
		},
		togglePriceFieldDisplay: function (show) {
			var priceButton = this.element.querySelector(PRICE_BUTTON_SELECTOR);
			this.toggleFieldDisplay(priceButton, show);
		},
		toggleTitleFieldDisplay: function (hide) {
			return;

			var titleField = this.title.getElement().querySelector('#chat-creator-messages-title');

			if (!titleField) {
				return;
			}

			if (typeof hide === 'boolean' && hide) {
				titleField.parentNode.classList.add('is-hidden');
				return;
			}

			titleField.parentNode.classList.remove('is-hidden');
		},
		updateMessagesWithVaultOrContent: function(vaultItems) {
			for (var index in vaultItems) {
				var listName = this.getCurrentList(),
					messages = this.messagesLists[listName].getElement().querySelectorAll('.messages-list__message-preview--content[data-id-vault="' + index + '"]');

				messages.forEach(function(message) {
					var name = 'Vault',
						classMessage = '.messages-list';
					if (vaultItems[index].hasOwnProperty('name')) {
						name = tools.escape(vaultItems[index].name.toString());
						if (vaultItems[index].media_type === 'text') {
							name = tools.escape(vaultItems[index].description);
							var title = tools.escape(vaultItems[index].name.toString());
							if (title) {
								name = title;
							}
						}
					}
					var duplicateBtn = message.closest(classMessage + '__item').querySelector(classMessage + '__menu-item--duplicate');
					if (!!duplicateBtn) {
						duplicateBtn.remove();
					}
					message.innerHTML = '<svg class="chat-scc"><use xlink:href="#scc-safe-icon"></use></svg>' + name;
					message.closest(classMessage + '__message').querySelector(classMessage + '__stat--content-views').classList.remove('is-hidden');
				});
			}
		},
		updateMessagesList: function(messages, isNewMessage, listName) {
			for (var index in messages) {
				var message = this.prepareMessageForMessagesList(messages[index]);
				this.updateMessagesListFeature(message);
				this.messagesLists[listName].appendMessage(message, isNewMessage);
			}
			if (isNewMessage) {
				this.toggleDisplay(
					FORM_SECTION_ELEMENTS,
					LIST_SECTION_ELEMENTS
				);
			}
			this.addListenersMessageList();
			this.initLoadMore(this.mediator.onLoadMoreMessageList.bind(this.mediator, listName), listName);
		},
		updateMessagesListFeature: function() {},
		updateMessageSentInMessageList: function(idMessage) {
			this.messagesLists[this.getCurrentList()].setMessageSent(idMessage);
		},
		validateForm: function () {}
	});

	return CreatorMessagesView;
});

define('text!features/CreatorMessages/MassMessage/views/components/DelayInputGroup/DelayInputGroup.mustache',[],function () { return '<div class="chat-ui-form-field chat-ui-form-field--inline-group">\n\t{{#label}}<label class="chat-ui-form-field__label">{{label}}</label>{{/label}}\n\t<div class="chat-ui-input-group">\n\t\t<!--<div class="chat-ui-input__prepend">\n\t\t\t<span><svg class="chat-scc"><use xlink:href="#scc-delay-message"></use></svg></span>\n\t\t</div>-->\n\n\t\t<div class="chat-ui-input__input chat-ui-input__input--radio-button">\n\t\t\t<input type="radio"{{#now}} checked="checked"{{/now}} id="delay-now" name="delay" value="now" />\n\t\t\t<label for="delay-now">{{labelNow}}</label>\n\t\t</div>\n\t\t<div class="chat-ui-input__input chat-ui-input__input--radio-button">\n\t\t\t<input type="radio"{{^now}} checked="checked"{{/now}} id="delay-later" name="delay" value="later" />\n\t\t\t<label for="delay-later">{{labelLater}}</label>\n\t\t</div>\n\t</div>\n\t<input id="delay-later-date" type="datetime-local" class="chat-ui-input__input chat-ui-input__input--disabled-hidden" {{#now}} disabled{{/now}} value="{{delayDate}}" min="{{minDelayDate}}"/>\n</div>';});

define('features/CreatorMessages/MassMessage/views/components/DelayInputGroup/DelayInputGroup',[
	'core/Component',
	'text!features/CreatorMessages/MassMessage/views/components/DelayInputGroup/DelayInputGroup.mustache',
	'lib/tools'
], function(
	Component,
	tplDelayInputGroup,
	tools
) {
	var DEFAULT_OPTIONS = {
		label: '',
		now: true,
		delayDate: '', // private, DO NOT USE, it will be overridden in constructor.
		minDelayDate: '',
		isoDelayDate: ''
	};
	/**
	 * @extends Component
	 * @constructor
	 * @param {object} options
	 * @param {string} options.label - Field label displayed above.
	 * @param {boolean} options.now - If true, the field value will be "now", even if an isoDelayDate is provided.
	 * @param {boolean} options.isoDelayDate - Datetime string compatible with de the Date object.
	 */
	var DelayInputGroup = function(options) {
		this.template = tplDelayInputGroup;
		this.options = Object.assign({}, DEFAULT_OPTIONS, options);
		this.isLaterDateInputVisible = false;
		if (!this.options.minDelayDate) {
			this.options.minDelayDate = this.convertToLocaleISODate();
		}
		if (this.options.isoDelayDate) {
			this.options.minDelayDate = this.convertToLocaleISODate(this.options.isoDelayDate);
		} else {
			this.options.delayDate = this.options.minDelayDate;
		}
		Component.call(this);
	};

	DelayInputGroup.prototype = Object.create(Component.prototype);

	Object.assign(DelayInputGroup.prototype, {
		addListeners: function () {
			var self = this;
			this.element.querySelectorAll('[name="delay"]').forEach(function (element) {
				element.addEventListener('input', self.onDelayChange.bind(self));
			});
		},
		convertToLocaleISODate: function (dateString) {
			var date = typeof dateString === 'string' ? new Date(dateString) : new Date();
			return tools.dateToLocaleISOString(date).slice(0, 16);
		},
		disableDelayLaterDateInput: function (isActive) {
			if (isActive && !this.isLaterDateInputVisible) {
				this.dispatchEvent('before-enable-delay-later-date');

				this.element.querySelector('#delay-later-date').removeAttribute('disabled');
				this.isLaterDateInputVisible = true;

				this.dispatchEvent('enable-delay-later-date');
			} else if (!isActive && this.isLaterDateInputVisible) {
				this.dispatchEvent('before-disable-delay-later-date');

				this.element.querySelector('#delay-later-date').setAttribute('disabled', null);
				this.isLaterDateInputVisible = false;

				this.dispatchEvent('disable-delay-later-date');
			}
		},
		getDateInput: function () {
			var input = this.element.querySelector('[type="datetime-local"]');

			if (!input) {
				throw new Error('Datetime-local input not found');
			}

			return input;
		},
		getUTCValueWithTimezone: function () {
			var value = this.getValue();

			if (!value) {
				return null;
			}

			return new Date(value).toISOString();
		},
		getValue: function () {
			if (this.element.querySelector('[name="delay"][value="now"]').checked) {
				return '';
			}

			var dateInput = this.element.querySelector('#delay-later-date'),
				value = dateInput.value;

			if (this.isAnteriorDateValue(value)) {
				value = this.options.minDelayDate;
			}

			return value;
		},
		isAnteriorDateValue: function (value) {
			var minDate = new Date(this.options.minDelayDate),
				date = new Date(value);

			return date < minDate;
		},
		onDelayChange: function (event) {
			var isActive = event.target.value === "later";

			this.disableDelayLaterDateInput(isActive);
		},
		setValue: function (value) {
			var dateInput = this.getDateInput();

			if (typeof value === 'undefined' || value === null || value === '' || this.isAnteriorDateValue(value)) {
				value = this.options.minDelayDate;
			}

			dateInput.value = this.convertToLocaleISODate(value);
			dateInput.dispatchEvent(new Event('change', {bubbles: true, cancelable: true}));
		}
	});

	return DelayInputGroup;
});

define('text!features/CreatorMessages/views/components/ListCheckbox/ListCheckbox.mustache',[],function () { return '<div>\n\t{{#infoLimitation}}<p class="{{baseName}}__info {{baseName}}__info--box">{{infoLimitation}}</p>{{/infoLimitation}}\n\t<ul class="{{baseName}}{{#classes}} {{classes}}{{/classes}}"{{#attributes}} {{{attributes}}}"{{/attributes}}>\n\t\t{{#checkboxes}}\n\t\t\t<li class="{{baseName}}__item">\n\t\t\t\t<input class="chat-ui-input--checkbox input--{{baseName}}" type="checkbox" id="{{baseName}}-{{value}}" name="{{baseName}}" value="{{value}}" data-rule="{{rule}}"{{#disabled}} disabled{{/disabled}}>\n\t\t\t\t<label class="chat-ui-label label--{{baseName}}" for="{{baseName}}-{{value}}">{{label}}</label>\n\t\t\t</li>\n\t\t{{/checkboxes}}\n\t</ul>\n\t<p class="{{baseName}}__info {{baseName}}__info--small">{{info}}</p>\n\t<div class="{{baseName}}__estimation is-hidden">\n\t\t<p>{{estimation}} : <span class="{{baseName}}__estimation-loading">{{loading}}</span><strong class="{{baseName}}__estimation-number"></strong></p>\n\t\t<button class="{{baseName}}__estimation-button chat-ui-action-button chat-ui-action-button--gradient is-hidden"><span class="icon-f icf-eye"></span>{{recipientsList}}</button>\n\t</div>\n</div>';});

define('features/CreatorMessages/views/components/ListCheckbox/ListCheckbox',[
	'core/Component',
	'text!features/CreatorMessages/views/components/ListCheckbox/ListCheckbox.mustache',
	'lib/tools',
	'lib/i18n!front',
	'log_and_tooltip',
	'features/CreatorMessages/models/CreatorMessagesContactModel'
], function(
	Component,
	tplListCheckbox,
	tools,
	i18n,
	LogAndTooltip,
	MassMessageContactModel
) {
	var BASE_NAME = 'creator-messages-list',
		ERROR_CLASS_NAME = BASE_NAME + '--error',
		ERROR_MESSAGE_CLASS_NAME = BASE_NAME + '-error-message',
		ERROR_MESSAGE_SELECTOR = '.' + ERROR_MESSAGE_CLASS_NAME,
		ESTIMATION_HIDDEN_CLASS_NAME = 'is-hidden',
		ESTIMATION_SELECTOR = '.' + BASE_NAME + '__estimation',
		ESTIMATION_SELECTOR_LOADER = '.' + BASE_NAME + '__estimation-loading',
		ESTIMATION_SELECTOR_NUMBER = '.' + BASE_NAME + '__estimation-number',
		ESTIMATION_SELECTOR_BUTTON = '.' + BASE_NAME + '__estimation-button',
		INPUTS_SELECTOR = '.input--' + BASE_NAME,
		LIST_SELECTOR = '.' + BASE_NAME;

	var ListCheckbox = function(options) {
		this.options = Object.assign({}, {
			baseName: BASE_NAME,
			classes: "",
			modifier: "",
			attributes: {}
		}, options);
		this.template = tplListCheckbox;
		this.error = false;
		Component.call(this);
		this.list = this.getElement().querySelector(LIST_SELECTOR);
		this.inputs = this.getElement().querySelectorAll(INPUTS_SELECTOR);
		this.estimation = this.getElement().querySelector(ESTIMATION_SELECTOR);
		this.estimationTotal = null;
		this.contactsList = null;
	};

	ListCheckbox.prototype = Object.create(Component.prototype);

	Object.assign(ListCheckbox.prototype, {
		changeInput: function(event) {
			var inputs = Array.from(this.inputs),
				checked = false;

			for (var input in inputs) {
				if (inputs[input].checked !== checked) {
					checked = true;
					break;
				}
			}

			if (!checked) {
				this.hideEstimation();
				return
			}

			var allAvailableValue = 'available';
			if (event.target.value === allAvailableValue) {
				for (var input in inputs) {
					inputs[input].checked = inputs[input].value === event.target.value;
				}
			}
			else {
				for (var input in inputs) {
					if (inputs[input].value === allAvailableValue) {
						inputs[input].checked = inputs[input].value !== allAvailableValue;
					}
				}
			}

			this.removeError();
		},
		disable: function() {
			this.inputs.forEach(function(element) {
				element.disabled = true;
			});
		},
		disableItems: function (rules) {
			for (var input in this.inputs) {
				if (rules.indexOf(input.dataset.rule) === -1) {
					continue;
				}
				input.setAttribute('disabled', '');
			}
		},
		enable: function() {
			this.inputs.forEach(function(element) {
				element.disabled = false;
			});
		},
		getEstimationTotal: function() {
			return this.estimationTotal;
		},
		getList: function() {
			var list = '';
			for (var index in this.contactsList) {
				list += `<li>${this.contactsList[index]}</li>`;
			}
			return list;
		},
		getRules: function() {
			var checkboxes = this.getElement().querySelectorAll('input');
			if (checkboxes.length === 0) {
				throw new Error('No input checkbox for the rules');
			}

			var rules = [];
			checkboxes.forEach(function(element) {
				if (!element.checked) {
					return;
				}
				rules.push(element.dataset.rule);
			});
			return rules;
		},
		hideEstimation: function() {
			this.estimation.classList.add(ESTIMATION_HIDDEN_CLASS_NAME);
		},
		onClickEstimationButton: function(event) {
			event.preventDefault();
			var content = `<div class="header"><span>${i18n.__('chat.mass_message_recipients')}</span></div><div class="content"><ul>${this.getList()}</ul></div>`,
				modal = LogAndTooltip.modal(content, {
					closable: true,
					noOverlayExtended: true
				}, false);

			modal.container
				.closest('.x-body')[0]
				.classList.add('chat-mass-message-recipients-popup');
		},
		removeError: function () {
			this.list.classList.remove(ERROR_CLASS_NAME);

			var message = document.querySelector(ERROR_MESSAGE_SELECTOR);

			if (!message) {
				return;
			}

			message.parentNode.removeChild(message);

			this.error = false;
		},
		removeLoader: function() {
			var loader = this.getElement().querySelector(ESTIMATION_SELECTOR_LOADER);
			if (loader) {
				loader.remove();
			}
		},
		reset: function() {
			this.inputs.forEach(function(input) {
				input.checked = false;
			});
		},
		setContactsList: function(contactsList) {
			this.contactsList = contactsList;

			this.removeElementListeners('contactslist');
			this.addElementListener(this.getElement().querySelector(ESTIMATION_SELECTOR_BUTTON), 'click', this.onClickEstimationButton, 'contactslist', this);
		},
		setError: function (message) {
			if (this.error) {
				return;
			}

			this.list.classList.add(ERROR_CLASS_NAME);
			this.error = true;

			if (!message) {
				return;
			}

			var errorMessage = tools.string_to_node(`<p class="${ERROR_MESSAGE_CLASS_NAME}">${message}</p>`);
			this.list.parentNode.prepend(errorMessage);
		},
		setRules: function(rules) {
			var checkboxes = this.getElement().querySelectorAll('input');
			if (checkboxes.length === 0) {
				throw new Error('No input checkbox for the rules');
			}

			checkboxes.forEach(function(element) {
				for (var ruleIndex in rules) {
					if (element.dataset.rule === rules[ruleIndex]) {
						element.checked = true;
					}
				}
			});
		},
		showEstimation: function() {
			this.estimation.classList.remove(ESTIMATION_HIDDEN_CLASS_NAME);
		},
		updateEstimation: function(total, rules, contactsList) {

			if (contactsList) {
				this.getElement().querySelector(ESTIMATION_SELECTOR_BUTTON).classList.remove('is-hidden');
				this.setContactsList(contactsList);
			}

			if (total) {
				this.estimationTotal = total;
				this.getElement().querySelector(ESTIMATION_SELECTOR_NUMBER).innerText = this.estimationTotal;
				this.showEstimation();
				return this.estimationTotal === 0;
			}

			if (rules) {
				var targets = '',
					contact = new MassMessageContactModel(),
					listContact = contact.getAll(),
					index = 0;

				for (var indexRule in rules) {
					for (var indexContact in listContact) {
						if (rules[indexRule] === listContact[indexContact].rule) {
							if (index > 0) {
								targets += ', ';
							}
							targets += i18n.__(listContact[indexContact].labelI18nKey);
						}
					}
					index++;
				}

				this.getElement().querySelector(ESTIMATION_SELECTOR_NUMBER).innerText = i18n.__('chat.mass_message_too_soon', {
					'%targets%': targets
				});
				this.showEstimation();

				return true;
			}
		}
	});

	return ListCheckbox;
});
define('features/Message/commands/ReportMessage',[
	'config/chat',
	'core/Command',
	'services/SocketConnection',
	'services/SocketConnectionEvent',
], function(
	Config,
	Command,
	SocketConnection,
	SocketConnectionEvent
) {
	var ReportMessageCommand = function(context, commandMap, mediatorMap) {
		Command.call(this, ...arguments);
	};

	Object.defineProperties(ReportMessageCommand, {
		AUTO_BLOCK: {value: 'AUTO_BLOCK', writable: false},
		AUTO_REPORT: {value: 'AUTO_REPORT', writable: false},
		FAN_REPORT: {value: 'FAN_REPORT', writable: false}
	});

	ReportMessageCommand.prototype = Object.create(Command.prototype);

	Object.assign(ReportMessageCommand.prototype, {
		execute: function (data) {
			SocketConnection.emit(SocketConnectionEvent.out.REPORT_MESSAGE, data);
		}
	});

	return ReportMessageCommand;
});
define('features/Message/events/MessageEvent',[], function () {
	var MessageEvent = Object.create(null);

	Object.defineProperties(MessageEvent, {
		CHECK_FOR_URL_IN_MESSAGE: {value: 'check_for_url_in_message.message', writable: false},
		FORWARD_MESSAGE_TO_FAN_SUPPORT: {value: 'forward_message_to_fan_support.message', writable: false},
		FAN_MESSAGE_REPORTED: {value: 'fan_reported.message', writable: false},
		MESSAGE_REPORTED: {value: 'reported.message', writable: false},
		REPLACE_URL_IN_MESSAGE: {value: 'replace_url_in_message.message', writable: false},
		REPORT: {value: 'report.message', writable: false},
		FAN_REPORT: {value: 'fan_report.message', writable: false},
		REPORT_ERROR: {value: 'report_error.message', writable: false},
		FAN_REPORT_ERROR: {value: 'fan_report_error.message', writable: false},
		REPORT_OPEN_FORM: {value: 'report_open_form.message', writable: false},
		FAN_REPORT_OPEN_FORM: {value: 'fan_report_open_form.message', writable: false},
		REQUEST_URL_METADATA: {value: 'request_url_metadata.message', writable: false},
		SEND_SFW_VALIDATION: {value: 'send_sfw_validation.message', writable: false},
		SEND_SFW_VALIDATION_ERROR: {value: 'send_sfw_validation_error.message', writable: false},
		SFW_VALIDATION_SENT: {value: 'sfw_validation_sent.message', writable: false},
		SILENT_PPV: {value: 'silent_ppv.message', writable: false}
	});

	return MessageEvent;
});
define('features/Message/directives/AutoBlockAndReport',[
	'features/Message/commands/ReportMessage',
	'features/Message/events/MessageEvent',
	'libs/EventEmitter'
], function(
	ReportMessageCommand,
	MessageEvent,
	EventEmitter
) {
	/**
	 * Classe contenant des lments de logique qui ne sont pas propre  un autre type de classe existant
	 * (View, Mediator, Command ou Model).
	 *
	 * @constructor
	 */
	var AutoBlockAndReport = function() {
		this.blockWords = [];
		this.reportWords = [];
		this.lastBlockingWord = '';
	};

	Object.assign(AutoBlockAndReport.prototype, {
		_addWords: function (array, words) {
			for (var word of words) {
				if (array.indexOf(word) === -1) {
					array.push(word);
				}
			}
		},
		_cleanMessage: function (message) {
			message = message.toLowerCase();
			message = message.replace(/'s/g, "s");
			message = message.replace(/_/g, " ");
			message = message.replace(/-/g, " ");
			//message = message.replace(/\./g, " ");
			return message;
		},
		_emitReport: function (type, creatorWebsiteUserId, message) {
			EventEmitter.emit(MessageEvent.REPORT, {type: type, creatorWebsiteUserId: creatorWebsiteUserId, message: message});
		},
		_hasBlockWords: function (message) {
			if (this.blockWords.length === 0) {
				return false;
			}

			for (var i in this.blockWords) {
				if (message.indexOf(this.blockWords[i].toLowerCase()) > -1) {
					this.lastBlockingWord = this.blockWords[i];
					return true;
				}
			}

			return false;
		},
		_hasReportWords: function (message) {
			if (this.reportWords.length === 0) {
				return false;
			}

			var report = false;
			var words, pos, new_pos, match;

			for (var i in this.reportWords) {
				words = this.reportWords[i].split("*");
				pos = 0;

				if (typeof words.length == "undefined" || words.length === 0) {
					continue;
				}

				match = 0;
				for (var j= 0; j < words.length; j++) {
					new_pos = message.indexOf(words[j].toLowerCase(), pos);
					if (new_pos === -1) {
						continue;
					}
					match++;
					pos = new_pos;
				}

				if (match === words.length) {
					report = true;
					break;
				}
			}

			return report;
		},
		addBlockWords: function (words) {
			this._addWords(this.blockWords, words);
		},
		addReportWords: function (words) {
			this._addWords(this.reportWords, words);
		},
		checkAutoBlock: function(message, creatorWebsiteUserId) {
			if (this._hasBlockWords(message)) {
				this._emitReport(ReportMessageCommand.AUTO_BLOCK, creatorWebsiteUserId, message);
				return false;
			}

			return true;
		},
		checkAutoBlockAndAutoReport: function(message, creatorWebsiteUserId) {
			if (this.checkAutoBlock(message, creatorWebsiteUserId)) {
				this.checkAutoReport(message, creatorWebsiteUserId);

				return true;
			}

			return false;
		},
		checkAutoReport: function(message, creatorWebsiteUserId) {
			var cleanedMessage = this._cleanMessage(message);

			if (this._hasReportWords(cleanedMessage)) {
				this._emitReport(ReportMessageCommand.AUTO_REPORT, creatorWebsiteUserId, message);
			}

			return true;
		},
		getLastBlockingWord: function () {
			return this.lastBlockingWord;
		},
	});

	return AutoBlockAndReport;
});
define('features/Message/ReportMessage',[
	'features/Message/directives/AutoBlockAndReport'
], function(
	AutoBlockAndReport
) {
	/**
	 * Classe "interface/api" pour communiquer avec le reste du chat en mode synchrone (sans passer par des events).
	 *
	 * @constructor
	 */
	var ReportMessage = function() {
		this._autoBlockAndReport = new AutoBlockAndReport();
	};

	Object.assign(ReportMessage.prototype, {
		addAutoBlockWords: function (words) {
			this._autoBlockAndReport.addBlockWords(words);
		},
		addAutoReportWords: function (words) {
			this._autoBlockAndReport.addReportWords(words);
		},
		checkAutoBlock: function(message, userId) {
			return this._autoBlockAndReport.checkAutoBlock(message, userId);
		},
		checkAutoBlockAndAutoReport: function(message, userId) {
			return this._autoBlockAndReport.checkAutoBlockAndAutoReport(message, userId);
		},
		getLastAutoBlockingWord: function () {
			return this._autoBlockAndReport.getLastBlockingWord();
		}
	});

	return new ReportMessage();
});
define('features/CreatorMessages/MassMessage/views/MassMessageView',[
	'config/chat',
	'features/CreatorMessages/views/CreatorMessagesView',
	'features/CreatorMessages/MassMessage/views/components/DelayInputGroup/DelayInputGroup',
	'features/CreatorMessages/views/components/ListCheckbox/ListCheckbox',
	'features/Message/ReportMessage',
	'ui/FormField/Input/Input',
	'lib/i18n!front',
	'lib/tools',
], function(
	Config,
	CreatorMessagesView,
	DelayInputGroup,
	ListCheckbox,
	ReportMessage,
	Input,
	i18n,
	tools
) {

	var FEATURE_NAME = 'mass_message',
		KEY_I18N = 'chat.' + FEATURE_NAME,
		CREATOR_MESSAGE_TITLE_TEXT = '.chat-creator-messages__title-text',
		CREATOR_MESSAGE_TITLE_ICON = '.chat-creator-messages__title-icon',
		BACK_BUTTON_TO_LIST = '.chat-btn--creator-message-back-to-list',
		ATTACHMENT_BUTTON_SELECTOR = '.chat-btn--creator-messages-attachment',
		DELAY_BUTTON_SELECTOR = '.chat-btn--creator-messages-delay',
		PRICE_BUTTON_SELECTOR = '.chat-btn--creator-messages-price',
		DELAY_FIELD_SECTION_ELEMENTS = '.chat-creator-messages__delay',
		SAVE_BUTTON_SELECTOR = '.chat-btn--creator-messages-save',
		PRICE_FIELD_SECTION_ELEMENTS = '.chat-creator-messages__price',
		VAULT_TEXT_ACTIVE_TOGGLER_BUTTON_SELECTOR = '#chat-creator-message-toggle-attachment.chat-toggle--show [data-name="mass-message-vault-text"].active';

	var MassMessageView = function (contacts) {
		CreatorMessagesView.call(this, contacts);
	}

	MassMessageView.prototype = Object.create(CreatorMessagesView.prototype);

	Object.assign(MassMessageView.prototype, {
		addListeners: function() {
			CreatorMessagesView.prototype.addListeners.call(this);
			this.addElementListener(BACK_BUTTON_TO_LIST, 'click', this.onClickStatsMessage.bind(this));
			this.addElementListener(DELAY_BUTTON_SELECTOR, 'click', this.onClickDelayButton.bind(this));
		},
		addListenersMessageListFeature: function(message, classToRemove) {
			var titleMessage = message.querySelector('.messages-list__message-preview'),
				btnCancel = message.querySelector('.messages-list__menu-item--cancel'),
				btnDuplicate = message.querySelector('.messages-list__menu-item--duplicate');

			if (titleMessage) {
				this.addElementListener(titleMessage, 'click', this.onClickTitleMassMessage.bind(this));
			}

			if (btnCancel) {
				this.addElementListener(btnCancel, 'click', this.onClickCancelMessage.bind(this));
			}

			if (btnDuplicate) {
				this.addElementListener(btnDuplicate, 'click', this.onClickDuplicateMessage.bind(this));
			}

			message.classList.remove(classToRemove);
		},
		checkRuleAvailability: function (rule, timestampInSeconds) {
			const timestampToFind = timestampInSeconds || Math.floor(Date.now() / 1000),
				unavailabilities = Config.mmRulesUnavailabilities || {},
				unavailabilitiesKeys = Object.keys(unavailabilities);

			if (!unavailabilitiesKeys.length) {
				return true;
			}

			const dateToFind = new Date(timestampToFind * 1000);

			for (const timestamp of unavailabilitiesKeys) {
				const date = new Date(timestamp * 1000);

				if (date.getDate() === dateToFind.getDate()) {
					return unavailabilities[timestamp].indexOf(rule) === -1;
				}
			}

			return true;
		},
		checkRulesAvailabilities: function () {
			if (!this.delay) {
				return;
			}

			var element = this.delay.getDateInput();

			if (isNaN(element.valueAsNumber)) {
				return;
			}

			const timestampInSeconds = element.valueAsNumber / 1000,
				checkboxes = this.contactsList.getElement().querySelectorAll('input');

			for (const checkbox of checkboxes) {
				checkbox.checked = false;
				checkbox.disabled = !this.checkRuleAvailability(checkbox.dataset.rule, timestampInSeconds);
			}
		},
		createElement: function() {
			CreatorMessagesView.prototype.createElement.call(this);

			var self = this;

			this.contactsList = new ListCheckbox({
				checkboxes: this.contactsData.map(function (item) { return {
					value: item.value,
					rule: item.rule,
					label: item.labelI18nKey.indexOf('new') > -1 ? i18n.__(item.labelI18nKey) + ' *' : i18n.__(item.labelI18nKey),
					disabled: !self.checkRuleAvailability(item.rule)
				}}),
				estimation: i18n.__('chat.mass_message_estimation'),
				loading: i18n.__('loading.loading'),
				hasInfo: true,
				info: '* ' + i18n.__('chat.contacts_list.new_info'),
				hasEstimation: true,
				infoLimitation: i18n.__('chat.contacts_list.limitation_info'),
				recipientsList: i18n.__('chat.mass_message_view_recipients')
			});
			tools.replaceElement(this.element.querySelector('#contacts-list-placeholder'), this.contactsList.getElement());

			this.delay = new DelayInputGroup({
				'labelNow': i18n.__('chat.mass_message_delay_now'),
				'labelLater': i18n.__('chat.mass_message_delay_later')
			});
			var delayElement = this.delay.getElement();
			tools.replaceElement(this.element.querySelector('#delay-placeholder'), delayElement);
			this.delay.addElementListener(delayElement, 'disable-delay-later-date', this.onDisableDelayLaterDate, 'mass-message-view', this);
			this.delay.addElementListener(delayElement, 'enable-delay-later-date', this.onEnableDelayLaterDate, 'mass-message-view', this);
			this.delay.addElementListener('#delay-later-date', 'change', this.onChangeDelayLaterDate, 'mass-message-view', this);
		},
		duplicateMessageData: function(idMessage, save) {
			this.onClickCreateMessage();
			this.fillMessage(this.mediator.getMessageData(idMessage, this.getCurrentList()), save);
		},
		emptyFormFields: function() {
			CreatorMessagesView.prototype.emptyFormFields.call(this);

			this.contactsList.reset();
			this.contactsList.hideEstimation();
			this.setDelaySendDate('');
			this.emptySendDelayButton();
		},
		emptySendDelayButton: function() {
			var btn = this.element.querySelector(DELAY_BUTTON_SELECTOR);
			btn.innerHTML = '<svg class="chat-scc"><use xlink:href="#scc-creator-messages-delay-icon"></use></svg>';
			btn.classList.remove('has-delay');
		},
		fillMessage: function(messageJson, save) {
			if (!(messageJson.rules instanceof Array) || messageJson.rules.length === 0) {
				throw new Error('Unable to duplicate a mass message without rules');
			}

			var price = null;
			this.setRules(messageJson.rules);
			if (this.contactsList.getEstimationTotal() === null) {
				this.mediator.updateTargetsEstimation();
			}

			if (messageJson.messages_translated.length > 1) {
				throw new Error('Unable to duplicate more than one mass message');
			}

			for (var index in messageJson.messages_translated) {
				var message = messageJson.messages_translated[index];

				if (typeof message.message === "string") {
					this.setMessage(message.message);
				}

				if (!message.is_content) {
					this.toggleAttachmentFieldDisplay(false);
					continue;
				}

				var contentType = message.is_vault ? 'vault' : 'content',
					content = this[contentType].contents.get(+message.content_id);

				if (!!content) {
					this[contentType].fillMessageFormFields(content);

					var isTypeText = !!((message.is_vault || message.is_content) && content.media_type === 'text');
					if (isTypeText) {
						this.formTabs.selectTab('creator-messages-vault-text');
					} else if (message.is_vault) {
						this.formTabs.selectTab(this.vaultSystemName);
					} else {
						this.formTabs.selectTab(this.contentSystemName);
					}

					this.toggleAttachmentFieldDisplay(true);
				}

				if (typeof message.price === "number") {
					this.setPrice(message.price);
					this.togglePriceFieldDisplay(message.price > 0);
				}
			}

			if (typeof messageJson.price === "number" && messageJson.price) {
				this.setPrice(messageJson.price);
				this.togglePriceFieldDisplay(true);
			}

			if (!save) {
				this.element.querySelector(CREATOR_MESSAGE_TITLE_TEXT).innerText = i18n.__('chat.mass_message');
				this.element.querySelector(CREATOR_MESSAGE_TITLE_ICON).classList.add('is-hidden');
				this.element.querySelector(BACK_BUTTON_TO_LIST).classList.remove('is-hidden');
				this.messagePreviewUI(true, price);
			}
		},
		getContactsList: function() {
			return this.contactsList;
		},
		getDelaySendDate: function () {
			return this.delay.getUTCValueWithTimezone();
		},
		getFeatureName: function() {
			return FEATURE_NAME;
		},
		getFeatureTitle: function() {
			return i18n.__(KEY_I18N);
		},
		getGuide: function() {
			var list = '';
			for (var i = 1; i < 6; i++) {
				list += `<li>${i18n.__('chat.mass_message.guide_' + i, {
					'%tool%' : `<em>${i18n.__('chat.mass_message')}</em>`,
					'%bold%': '<strong>', '%boldend%': '</strong>'
				})}</li>`;
			}
			return list
		},
		getMessagesListTitle: function() {
			return i18n.__('chat.' + this.getFeatureName() + '_campaign_history');
		},
		getNewMessageTitle: function () {
			return i18n.__(KEY_I18N + '_new');
		},
		getNoMessagesLabel: function() {
			return i18n.__(KEY_I18N + '_no_message');
		},
		getRules: function () {
			return this.contactsList.getRules();
		},
		hasContactsList: function() {
			return true;
		},
		hasDynamicVar: function() {
			return true;
		},
		hasPrice: function() {
			return true;
		},
		initModal: function() {
			CreatorMessagesView.prototype.initModal.call(this);

			this.modal.container.closest('.x-body').addClass('chat-mass-message-popup');
		},
		isBeta: function() {
			// return i18n.__('chat.beta.information_message').replace('\n', '<br>');
			return false;
		},
		messagePreviewUI: function(isPreview, price) {
			if (isPreview) {
				var elements = [ATTACHMENT_BUTTON_SELECTOR, DELAY_BUTTON_SELECTOR, SAVE_BUTTON_SELECTOR];
				if (typeof price !== 'undefined') {
					elements.push(PRICE_BUTTON_SELECTOR);
				}
				for (var index in elements) {
					this.element.querySelector(elements[index]).classList.add('is-hidden');
				}
				this.contactsList.disable();
				this.price.disable();
				this.message.disable();
			}
			else {
				this.toggleAttachmentFieldDisplay(false);
				var elements = [PRICE_BUTTON_SELECTOR, ATTACHMENT_BUTTON_SELECTOR, DELAY_BUTTON_SELECTOR, SAVE_BUTTON_SELECTOR];
				for (var index in elements) {
					this.element.querySelector(elements[index]).classList.remove('is-hidden');
				}
				this.contactsList.enable();
				this.checkRulesAvailabilities();
				this.price.enable();
				this.message.enable();
			}
		},
		prepareMessageData: function (messageFromVault) {
			var price = (isNaN(this.getPrice()) || this.getPrice() === 0) ? null : this.getPrice(),
				msg = '';

			if (!!messageFromVault) {
				if (!!price) {
					messageFromVault.price = price;
				}
				msg = JSON.stringify(messageFromVault);
			}
			else {
				msg = this.mediator.context.manager.make_real_message(this.getMessage());
			}

			return {
				'messages': [msg],
				'price': price,
				'delay_send_date': this.getDelaySendDate(),
				'rules': this.getRules()
			};
		},
		onChangeDelayLaterDate: function (event) {
			if (isNaN(event.target.valueAsNumber)) {
				return;
			}

			const timestampInSeconds = event.target.valueAsNumber / 1000,
				checkboxes = this.contactsList.getElement().querySelectorAll('input');

			for (const checkbox of checkboxes) {
				checkbox.checked = false;
				checkbox.disabled = !this.checkRuleAvailability(checkbox.dataset.rule, timestampInSeconds);
			}
			this.checkRulesAvailabilities();
		},
		onClickCancelMessage: function(event) {
			event.preventDefault();
			var data = {
					mass_message_id: parseInt(event.target.closest('.messages-list__message').dataset.idMassMessage)
				},
				self = this,
				callbackOnOk = function() {
					self.mediator.emitCancelMessage(data);
				}
			this.openCancelConfirmation(callbackOnOk);
		},
		onClickDelayButton: function () {
			var self = this;
			this.toggleDisplay([DELAY_BUTTON_SELECTOR], [DELAY_FIELD_SECTION_ELEMENTS]);
			this.addElementListener('input#delay-later-date', 'keydown', function(event) {
				if (event.key !== 'Enter') {
					return;
				}
				self.saveDelay();
			}, 'delay');
			this.addElementListener(this.element, 'click', function (event) {
				if (document.querySelector('.chat-form-actions__delay').contains(event.target)) {
					return;
				}
				self.saveDelay();
			}, 'delay');
		},
		onClickDuplicateMessage: function(event) {
			event.preventDefault();
			this.duplicateMessageData(parseInt(event.target.closest('.messages-list__message').dataset.idMassMessage), true);
		},
		onClickPriceButton: function () {
			var self = this,
				mobile = window.matchMedia("(max-width: 767px)").matches,
				hasDelay = document.querySelector(DELAY_BUTTON_SELECTOR).classList.contains('has-delay'),
				elementToHide = (mobile && hasDelay) ? [PRICE_BUTTON_SELECTOR, DELAY_BUTTON_SELECTOR] : [PRICE_BUTTON_SELECTOR];
			this.toggleDisplay(elementToHide, [PRICE_FIELD_SECTION_ELEMENTS]);
			this.addElementListener(this.element, 'click', function (event) {
				if (document.querySelector('.chat-form-actions__price').contains(event.target)) {
					return;
				}
				self.savePrice();
			}, 'price');
			this.addElementListener('input#chat-creator-messages-price', 'keydown', function(event) {
				if (event.key !== 'Enter') {
					return;
				}
				self.savePrice();
			}, 'price');
		},
		onClickStatsMessageFeature: function() {
			this.element.querySelector(BACK_BUTTON_TO_LIST).classList.add('is-hidden');
		},
		onClickTitleMassMessage: function(event) {
			event.preventDefault();
			this.duplicateMessageData(parseInt(event.target.closest('.messages-list__message').dataset.idMassMessage), false);
		},
		onDisableDelayLaterDate: function() {
			this.element.querySelector(SAVE_BUTTON_SELECTOR).innerText = i18n.__('chat.message_send');
		},
		onEnableDelayLaterDate: function() {
			this.element.querySelector(SAVE_BUTTON_SELECTOR).innerText = i18n.__('chat.save');
		},
		removeFeature: function() {
			delete this.delay;
		},
		saveDelay: function() {
			var value = this.delay.getValue(),
				btn = this.element.querySelector(DELAY_BUTTON_SELECTOR);

			if (value !== '') {
				function datetimeLocal(datetime) {
					var dt = new Date(datetime),
						options = {
							year: 'numeric',
							month: 'long',
							day: 'numeric',
							hour: 'numeric',
							minute: 'numeric',
							second: 'numeric'
						}
					return dt.toLocaleDateString(Config.locale, options);
				}
				btn.innerHTML = datetimeLocal(value);
				btn.classList.add('has-delay');
			}
			else {
				this.emptySendDelayButton();
			}

			this.toggleDisplay([DELAY_FIELD_SECTION_ELEMENTS], [DELAY_BUTTON_SELECTOR]);
			this.removeElementListeners(this.getNamespaceListeners('delay'));
			this.delay.setValue(value);
			this.mediator.updateTargetsEstimation(true);
		},
		savePrice: function() {
			var price = this.price.getField().value,
				isValidPrice = this.getIsValidPrice(price);

			if (!isValidPrice) {
				this.price.setError(i18n.__('chat.vault.price_error', {
					'%price_min%': Config.file_upload.ppc.min.toString(),
					'%price_max%': Config.file_upload.ppc.max.toString(),
				}));
				return;
			}

			this.price.removeError();
			this.setPrice(price);

			var mobile = window.matchMedia("(max-width: 767px)").matches,
				hasDelay = document.querySelector(DELAY_BUTTON_SELECTOR).classList.contains('has-delay'),
				elementsToShow = (mobile && hasDelay) ? [PRICE_BUTTON_SELECTOR, DELAY_BUTTON_SELECTOR] : [PRICE_BUTTON_SELECTOR];

			if (price === '') {
				this.emptyPriceButton();
				this.toggleDisplay([PRICE_FIELD_SECTION_ELEMENTS], elementsToShow);
				this.removeElementListeners(this.getNamespaceListeners('price'));
				return;
			}

			var isVaultTextTogglerButtonActive = !!document.querySelector(VAULT_TEXT_ACTIVE_TOGGLER_BUTTON_SELECTOR),
				btn = this.element.querySelector(PRICE_BUTTON_SELECTOR);

			btn.innerHTML = '$' + price;
			btn.classList.add('has-price');
			this.toggleDisplay([PRICE_FIELD_SECTION_ELEMENTS], elementsToShow);
			this.removeElementListeners(this.getNamespaceListeners('price'));
			if (!isVaultTextTogglerButtonActive) {
				this.openAttachments('mass-message-vault-text');
			}
		},
		saveMessage: function(messageData) {
			if (typeof messageData === 'undefined') {
				return;
			}
			this.mediator.emitSaveMessage(messageData);
		},
		setDelaySendDate: function (date) {
			return this.delay.setValue(date);
		},
		setRules: function(rules) {
			this.contactsList.setRules(rules);
		},
		validateForm: function () {
			if (this.contactsList.getEstimationTotal() === null) {
				this.mediator.updateTargetsEstimation();
			}

			var rules = this.getRules();
			if (!rules.length) {
				this.contactsList.setError(i18n.__('chat.contact_list.target_required'));
				return false;
			} else {
				this.contactsList.removeError();
			}

			/*var attachmentIsDisplayed = this.getElement().querySelector('[data-toggle="#chat-creator-messages-toggle-attachment"]').classList.contains('active'),
				attachmentIsContent = attachmentIsDisplayed && this.getElement().querySelector('.chat-tabs__item.active').dataset.name === 'creator-messages-content-selector';

			var title = this.getTitle();
			if (attachmentIsContent && !title.length) {
				this.title.setError(i18n.__('chat.mass_message.title_required'));
				return false;
			} else {
				if (this.title !== null) {
					this.title.removeError();
				}
			}*/

			var message = this.getMessage();
			if (!message.length) {
				this.message.setError(i18n.__('chat.mass_message.message_required'));
				return false;
			} else {
				this.message.removeError();
			}

			if (!ReportMessage.checkAutoBlock(message, Config.login_info.id)) {
				this.message.setError(i18n.__('chat.error.blocking_word_in_message', {'%word%': ReportMessage.getLastAutoBlockingWord()}));
				return false;
			}

			if (!this.getIsValidPrice(this.price.getField().value)) {
				this.price.setError(i18n.__('chat.vault.price_error', {
					'%price_min%': Config.file_upload.ppc.min.toString(),
					'%price_max%': Config.file_upload.ppc.max.toString(),
				}));
				return false;
			}
			else {
				this.price.removeError();
			}

			return true;
		}
	});

	return MassMessageView;

});
define('features/CreatorMessages/MassMessage/commands/OpenMassMessage',[
	'lib/storage',
	'core/Command',
	'services/SocketConnection',
	'services/SocketConnectionEvent',
	'features/CreatorMessages/models/CreatorMessagesContactModel',
	'features/CreatorMessages/MassMessage/events/MassMessageEvent',
	'features/CreatorMessages/MassMessage/views/MassMessageView',
	'libs/EventEmitter',
], function(
	Storage,
	Command,
	SocketConnection,
	SocketConnectionEvent,
	CreatorMessagesContactModel,
	MassMessageEvent,
	MassMessageView,
	EventEmitter
) {
	var OpenMassMessageCommand = function(context) {
		Command.call(this, context);
		this.massMessagesStored = null;
	};

	OpenMassMessageCommand.prototype = Object.create(Command.prototype);

	Object.assign(OpenMassMessageCommand.prototype, {
		areDataValid: function() {
			this.massMessagesStored = Storage.get('chat_mass_messages');
			if (
				this.massMessagesStored === null
				|| typeof this.massMessagesStored === 'undefined'
				|| typeof this.massMessagesStored.d === 'undefined'
				|| typeof this.massMessagesStored.t === 'undefined'
				|| typeof this.massMessagesStored.d.data === 'undefined'
				|| this.massMessagesStored.d.data.length < 1
				|| (this.massMessagesStored.t + (1000 * 60 * 30)) < Date.now()
			) {
				wglog.debug('OpenMassMessageCommand::areDataValid massMessagesStored invalid', this.massMessagesStored);
				return false;
			}
			return true;
		},
		execute: function () {
			var contact = new CreatorMessagesContactModel();
			new MassMessageView(contact.getAll());
			this.emitEvent();
		},
		emitEvent: function() {
			if (this.areDataValid()) {
				EventEmitter.emit(MassMessageEvent.OPEN_FROM_LOCAL_STORAGE, this.massMessagesStored.d);
				return;
			}

			SocketConnection.emit(SocketConnectionEvent.out.GET_ALL_MASS_MESSAGE, {
				page: 1
			});
		}
	});

	return OpenMassMessageCommand;
});
define('features/CreatorMessages/MassMessage/commands/SaveMassMessage',[
	'core/Command',
	'services/SocketConnection',
	'services/SocketConnectionEvent',
], function(
	Command,
	SocketConnection,
	SocketConnectionEvent
) {
	var SaveMassMessageCommand = function(context) {
		Command.call(this, context);
	};

	SaveMassMessageCommand.prototype = Object.create(Command.prototype);

	Object.assign(SaveMassMessageCommand.prototype, {
		execute: function (args) {
			SocketConnection.emit(SocketConnectionEvent.out.SAVE_MASS_MESSAGE, args);
		}
	});

	return SaveMassMessageCommand;
});
define('features/CreatorMessages/MassMessage/commands/TranslateAllMassMessages',[
	'libs/EventEmitter',
	'lib/i18n!front',
	'core/Command',
	'features/CreatorMessages/MassMessage/events/MassMessageEvent',
], function(
	EventEmitter,
	i18n,
	Command,
	MassMessageEvent
) {
	var TranslateAllMassMessagesCommand = function(context) {
		Command.call(this, context);
	};

	TranslateAllMassMessagesCommand.prototype = Object.create(Command.prototype);

	Object.assign(TranslateAllMassMessagesCommand.prototype, {
		execute: function (result) {
			var updatedResult;

			if (typeof result.data === 'undefined') {
				updatedResult = {};
				updatedResult.data = [];
				if (typeof result.source !== "undefined") {
					updatedResult.source = result.source;
				}
				if (typeof result.feature !== "undefined") {
					updatedResult.feature = result.feature;
				}
				updatedResult.data.push(this.translateMessages(result));
			}
			else {
				for (var id in result.data) {
					result.data[id] = this.translateMessages(result.data[id]);
				}
				updatedResult = result;
			}

			if (typeof updatedResult.currentPage === 'undefined') {
				updatedResult.currentPage = 1;
			}

			EventEmitter.emit(MassMessageEvent.ALL_TRANSLATED, updatedResult);
		},
		translateMessages: function (messages) {
			var translated_rules = [];

			for (var rule in messages.rules) {
				translated_rules.push(i18n.__('chat.contacts_list.' + messages.rules[rule]));
			}

			messages.rules_translated = translated_rules.join(', ');
			messages.messages_translated = [];

			var indexes = Object.keys(messages.messages);
			for (var index in indexes) {
				var message_formated = {},
					message_object_or_string = messages.messages[indexes[index]];

				try {
					var message_object = JSON.parse(message_object_or_string);
					message_object.message = this.context.manager.get_real_message(message_object.message);
					var message_message = JSON.parse(message_object.message);
					message_object.message = message_message.t || message_message.m;
					message_formated = message_object;
				} catch (e) {
					if (typeof message_object_or_string === 'string') {
						message_formated.message = this.context.manager.get_real_message(message_object_or_string);
					}
				}

				messages.messages_translated.push(message_formated);
			}

			return messages;
		}
	});

	return TranslateAllMassMessagesCommand;
});
define('features/CreatorMessages/views/CreatorMessagesMediator',[
	'core/Mediator',
	'libs/EventEmitter',
], function(
	Mediator,
	EventEmitter
) {
	var CreatorMessagesMediator = function (view, context, mediatorMap) {
		Mediator.call(this, view, context, mediatorMap);
		this.messagesLists = {};
	}

	CreatorMessagesMediator.prototype = Object.create(Mediator.prototype);

	Object.assign(CreatorMessagesMediator.prototype, {
		addContent: function (content) {
			this.view.addContent(content);
		},
		addListeners: function() {},
		addVault: function (vault) {
			this.view.addVault(vault);
		},
		emitCreateContentInstance: function () {
			EventEmitter.emit(this.getEventsFeature().CREATE_CONTENT_INSTANCE, this);
		},
		emitCreateVaultInstance: function () {
			EventEmitter.emit(this.getEventsFeature().CREATE_VAULT_INSTANCE, this);
		},
		emitLoadMoreMessageList: function() {},
		emitSaveMessage: function(message) {
			EventEmitter.emit(this.getEventsFeature().SAVE, message);
		},
		getEventsFeature: function() {},
		getMessageData: function(id, listName) {
			if (this.messagesLists === {}) {
				return;
			}
			for (var index in this.messagesLists[listName].data) {
				if (this.messagesLists[listName].data[index].id === id) {
					return this.messagesLists[listName].data[index];
				}
			}
		},
		onAddContentService: function (tabInfo) {
			this.view.getFormTabs().addTab(tabInfo);
		},
		onAllMessage: function(result) {
			this.updateMessagesList(result);
		},
		onLoadMoreMessageList: function(listName) {
			this.messagesLists[listName].currentPage = this.view.getMessagesList(listName).getCurrentPage() + 1;
			this.view.getMessagesList(listName).setCurrentPage(this.messagesLists[listName].currentPage);
			this.emitLoadMoreMessageList(listName);
		},
		onMessageCanceled: function(result) {
			for (var message in this.messagesList.data) {
				if (this.messagesList.data[message].id !== result.id) {
					continue;
				}
				this.messagesList.data[message].status = result.status;
			}
			this.view.getMessagesList().setMessageCanceled(result);
			this.saveMessageState();
		},
		onMessageSaved: function(result) {
			result.source = 'new_message';
			EventEmitter.emit(this.getEventsFeature().TRANSLATE_ALL, result);
			this.view.messageSaved();
		},
		onMessageSent: function(result) {
			this.view.updateMessageSentInMessageList(result);
		},
		onVaultContentCreated: function (message) {
			this.view.onVaultContentCreated(message);
		},
		onVaultContentError: function (result) {
			this.view.onVaultContentError(result);
		},
		onVaultContentPreloaded: function(result) {
			this.view.onVaultContentPreloaded(result);
		},
		ready: function () {
			EventEmitter.emit(this.getEventsFeature().READY, this.view);
		},
		saveMessageState: function() {},
		updateMessagesList: function(result) {
			if (typeof result === 'undefined') {
				throw new Error('No data');
				return;
			}
			var listName = result.feature,
				isNewMessage = result.source === 'new_message',
				listIdMessagesAdded = [],
				messagesToAdd = [];

			if (typeof result.is_active !== 'undefined') {
				listName += (result.is_active || result.is_active === 1) ? '_active' : '_disabled';
			}

			if (Object.keys(this.view.getMessagesLists()).indexOf(listName) === -1) {
				if (typeof this.messagesLists[listName] === 'undefined') {
					this.messagesLists[listName] = result;
					this.view.initMessagesList(this.messagesLists[listName], listName);
				}
			}

			for (var index in this.messagesLists[listName].data) {
				var messageAdded = this.messagesLists[listName].data[index];
				if (listIdMessagesAdded.indexOf(messageAdded.id) !== -1) {
					continue;
				}
				if (isNewMessage) {
					listIdMessagesAdded.unshift(messageAdded.id);
				}
				else {
					listIdMessagesAdded.push(messageAdded.id);
				}
			}

			for (var indexResult in result.data) {
				var message = result.data[indexResult];
				if (listIdMessagesAdded.indexOf(message.id) === -1) {
					if (isNewMessage) {
						this.messagesLists[listName].data.unshift(message);
					}
					else {
						this.messagesLists[listName].data.push(message);
					}
				}

				if (isNewMessage) {
					messagesToAdd.unshift(message);
				}
				else {
					messagesToAdd.push(message);
				}
			}

			this.view.updateMessagesList(messagesToAdd, isNewMessage, listName);
			this.saveMessageState();
		}
	});

	return CreatorMessagesMediator;
});
define('features/CreatorMessages/MassMessage/views/MassMessageMediator',[
	'config/chat',
	'lib/storage',
	'features/CreatorMessages/views/CreatorMessagesMediator',
	'features/CreatorMessages/MassMessage/events/MassMessageEvent',
	'libs/EventEmitter',
], function(
	Config,
	Storage,
	CreatorMessagesMediator,
	MassMessageEvent,
	EventEmitter
) {
	var FEATURE_NAME = 'mass_message',
		NO_LOCAL_STORAGE = true;

	var MassMessageMediator = function (view, context, mediatorMap) {
		CreatorMessagesMediator.call(this, view, context, mediatorMap);
		this.targetsEstimation = {};
	}

	MassMessageMediator.prototype = Object.create(CreatorMessagesMediator.prototype);

	Object.assign(MassMessageMediator.prototype, {
		addListeners: function() {
			this.view.addElementListener('.input--creator-messages-list', 'change', this.onChangeTarget.bind(this));
		},
		emitCancelMessage: function (data) {
			EventEmitter.emit(MassMessageEvent.CANCEL, data);
		},
		emitLoadMoreMessageList: function(listName) {
			EventEmitter.emit(MassMessageEvent.LOAD_MORE, {
				page: this.messagesLists[listName].currentPage
			});
		},
		emitUpdateTargetsEstimation: function(rules) {
			EventEmitter.emit(MassMessageEvent.GET_TARGETS_ESTIMATION, {
				rules: rules,
				delay_send_date: this.view.getDelaySendDate()
			});
		},
		getEventsFeature: function() {
			return MassMessageEvent;
		},
		onChangeTarget: function(event) {
			this.view.getContactsList().changeInput(event);
			this.updateTargetsEstimation();
		},
		onMessageSaved: function(result) {
			result.source = 'new_message';
			if (Config.mmRulesUnavailabilities !== false && result.mm_rules_unavailabilities) {
				for (const timestamp in result.mm_rules_unavailabilities) {
					if (Config.mmRulesUnavailabilities[timestamp]) {
						Config.mmRulesUnavailabilities[timestamp] = Array.from(new Set(Config.mmRulesUnavailabilities[timestamp].concat(result.mm_rules_unavailabilities[timestamp])));
					} else {
						Config.mmRulesUnavailabilities[timestamp] = result.mm_rules_unavailabilities[timestamp];
					}
				}
			}
			EventEmitter.emit(MassMessageEvent.TRANSLATE_ALL, result);
			this.view.messageSaved();
		},
		onTargetsEstimation: function(result) {
			this.view.getContactsList().removeLoader();

			var keyRule,
				args = [];

			if (typeof result.rules !== 'undefined' && result.total !== 'no-cache') {
				keyRule = result.rules.join('_');
				args = [result.total, null];
			}

			if (typeof result.bad_rules !== 'undefined' || result.total === 'no-cache') {
				var param;
				if (typeof result.bad_rules !== 'undefined') {
					keyRule = result.bad_rules.join('_');
					param = result.bad_rules;
				}
				if (result.total === 'no-cache') {
					keyRule = result.rules;
					param = result.rules;
				}
				args = [null, param];
			}

			if (result.contacts) {
				args.push(result.contacts);
			}

			if (!this.targetsEstimation[keyRule]) {
				this.targetsEstimation[keyRule] = result.total ? result.total : 'no-cache';
			}

			if (args.length > 0) {
				this.view.disableSaveButton(this.view.getContactsList().updateEstimation(...args));
			}
		},
		saveMessageState: function() {
			if (NO_LOCAL_STORAGE) {
				return;
			}

			var storageKey = 'chat_' + FEATURE_NAME;
			if (Storage.get(storageKey)) {
				Storage.remove(storageKey);
			}
			Storage.set(storageKey, {
				d: this.messagesLists,
				t: Date.now()
			});
		},
		updateTargetsEstimation: function(noCache) {
			var rules = this.view.getRules();
			if (rules.length === 0) {
				return;
			}

			var keyRule = rules.join('_');
			if (typeof this.targetsEstimation[keyRule] === 'undefined' || this.view.getDelaySendDate() !== null || !!noCache) {
				this.emitUpdateTargetsEstimation(rules);
			}
			else {
				this.onTargetsEstimation({
					rules: rules,
					total: this.targetsEstimation[keyRule]
				});
			}
		},
	});

	return MassMessageMediator;
});
define('features/CreatorMessages/MassMessage/MassMessageMapper',[
	'config/chat',
	'features/CreatorMessages/MassMessage/commands/CancelMassMessage',
	'features/CreatorMessages/MassMessage/commands/CreateContentInstance',
	'features/CreatorMessages/MassMessage/commands/CreateVaultInstance',
	'features/CreatorMessages/MassMessage/commands/GetTargetsEstimationMassMessage',
	'features/CreatorMessages/MassMessage/commands/LoadMoreMassMessage',
	'features/CreatorMessages/MassMessage/commands/OpenMassMessage',
	'features/CreatorMessages/MassMessage/commands/SaveMassMessage',
	'features/CreatorMessages/MassMessage/commands/TranslateAllMassMessages',
	'features/CreatorMessages/MassMessage/events/MassMessageEvent',
	'features/CreatorMessages/MassMessage/views/MassMessageMediator',
	'features/CreatorMessages/MassMessage/views/MassMessageView',
	'services/SocketConnection',
	'services/SocketConnectionEvent'
], function(
	Config,
	CancelMassMessageCommand,
	CreateContentInstanceCommand,
	CreateVaultInstanceCommand,
	GetTargetsEstimationMassMessageCommand,
	LoadMoreMassMessageCommand,
	OpenMassMessageCommand,
	SaveMassMessageCommand,
	TranslateAllMassMessagesCommand,
	MassMessageEvent,
	MassMessageMediator,
	MassMessageView,
	SocketConnection,
	SocketConnectionEvent,
) {
	return function(context) {
		if (!Config.login_info.is_creator) {
			return;
		}

		context.commandMap.mapEvent(MassMessageEvent.CREATE_CONTENT_INSTANCE, CreateContentInstanceCommand);
		context.commandMap.mapEvent(MassMessageEvent.CREATE_VAULT_INSTANCE, CreateVaultInstanceCommand);

		context.commandMap.mapEvent(MassMessageEvent.CANCEL, CancelMassMessageCommand);
		context.commandMap.mapEvent(MassMessageEvent.GET_TARGETS_ESTIMATION, GetTargetsEstimationMassMessageCommand);
		context.commandMap.mapEvent(MassMessageEvent.OPEN, OpenMassMessageCommand);
		context.commandMap.mapEvent(MassMessageEvent.LOAD_MORE, LoadMoreMassMessageCommand);
		context.commandMap.mapEvent(MassMessageEvent.SAVE, SaveMassMessageCommand);
		context.commandMap.mapEvent(MassMessageEvent.TRANSLATE_ALL, TranslateAllMassMessagesCommand);

		context.mediatorMap.mapEvent(MassMessageEvent.ALL_TRANSLATED, MassMessageMediator, 'onAllMessage');
		context.mediatorMap.mapEvent(MassMessageEvent.OPEN_FROM_LOCAL_STORAGE, MassMessageMediator, 'onAllMessage');
		context.mediatorMap.mapEvent(MassMessageEvent.CANCELLED, MassMessageMediator, 'onMessageCanceled');
		context.mediatorMap.mapEvent(MassMessageEvent.SAVED, MassMessageMediator, 'onMessageSaved');
		context.mediatorMap.mapEvent(MassMessageEvent.TARGETS_ESTIMATION, MassMessageMediator, 'onTargetsEstimation');
		context.mediatorMap.mapEvent(MassMessageEvent.MASS_MESSAGE_SENT, MassMessageMediator, 'onMessageSent');
		context.mediatorMap.mapEvent(MassMessageEvent.ADD_CONTENT_SERVICE, MassMessageMediator, 'onAddContentService');
		context.mediatorMap.mapEvent(MassMessageEvent.VAULT_CONTENT_CREATED, MassMessageMediator, 'onVaultContentCreated');
		context.mediatorMap.mapEvent(MassMessageEvent.VAULT_GET_CONTENT_PRELOAD, MassMessageMediator, 'onVaultContentPreloaded');
		context.mediatorMap.mapEvent(MassMessageEvent.CONTENT_GET_CONTENT_PRELOAD, MassMessageMediator, 'onVaultContentPreloaded');
		context.mediatorMap.mapEvent(MassMessageEvent.VAULT_CONTENT_ERROR, MassMessageMediator, 'onVaultContentError');

		context.mediatorMap.mapView(MassMessageView, MassMessageMediator);

		SocketConnection.forwardIncomingEvent(SocketConnectionEvent.in.ALL_MASS_MESSAGE, MassMessageEvent.TRANSLATE_ALL);
		SocketConnection.forwardIncomingEvent(SocketConnectionEvent.in.MASS_MESSAGE_CANCELLED, MassMessageEvent.CANCELLED);
		SocketConnection.forwardIncomingEvent(SocketConnectionEvent.in.MASS_MESSAGE_SAVED, MassMessageEvent.SAVED);
		SocketConnection.forwardIncomingEvent(SocketConnectionEvent.in.TARGETS_ESTIMATION, MassMessageEvent.TARGETS_ESTIMATION);
		SocketConnection.forwardIncomingEvent(SocketConnectionEvent.in.MASS_MESSAGE_VAULT_CONTENT_CREATED, MassMessageEvent.VAULT_CONTENT_CREATED);
	};
});
define('features/CreatorMessages/AutoMessage/commands/CreateContentInstance',[
	'chat/content/content',
	'config/chat',
	'core/Command',
	'lib/i18n!front',
	'services/SocketConnection',
	'services/SocketConnectionEvent',
], function(
	Content,
	Config,
	Command,
	i18n,
	SocketConnection,
	SocketConnectionEvent
) {
	var CreateContentInstanceCommand = function(context, commandMap, mediatorMap) {
		Command.call(this, ...arguments);
	};

	CreateContentInstanceCommand.prototype = Object.create(Command.prototype);

	Object.assign(CreateContentInstanceCommand.prototype, {
		execute: function (mediatorInstance) {
			var content = new Content({
				contentSearchFormId: 'chat-creator-messages-search-form',
				contentSearchNameFieldId: 'chat-creator-messages-content-search-name',
				contentSearchResultsId: 'chat-creator-messages-content-search-results',
				dropzoneFieldId: 'chat-creator-messages-files',
				messageTextareaId: 'chat-creator-messages-textarea-message',
				vaultContentIdFieldId: 'chat-creator-messages-content-content-id',
				vaultContentPriceFieldId: 'chat-creator-messages-price',
				vaultContentSelectionButtonId: 'chat-creator-messages-content-select',
				vaultId: 'chat-creator-messages-content',
				vaultType: Content.TYPE_CREATOR_MESSAGES_AUTO
			});

			content.setSocket(SocketConnection.connection);
			content.setMessageFormActivation(this.context.chatFriendManager.setMessageFormState.bind(this.context.chat_friend_manager));
			content.setEmptyMessageForm(this.context.manager.empty_message_form.bind(this.context.manager));
			content.setMessageEncrypter(this.context.manager.make_real_message.bind(this.context.manager));
			content.setSelectedFriendIdProvider(() => this.context.chatFriendManager.selected_friend);

			mediatorInstance.addContent(content);
		}
	});

	return CreateContentInstanceCommand;
});
define('features/CreatorMessages/AutoMessage/commands/CreateVaultInstance',[
	'chat/content/vault',
	'config/chat',
	'core/Command',
	'lib/i18n!front',
	'services/SocketConnection',
	'services/SocketConnectionEvent',
], function(
	Vault,
	Config,
	Command,
	i18n,
	SocketConnection,
	SocketConnectionEvent
) {
	var CreateVaultInstanceCommand = function(context, commandMap, mediatorMap) {
		Command.call(this, ...arguments);
	};

	CreateVaultInstanceCommand.prototype = Object.create(Command.prototype);

	Object.assign(CreateVaultInstanceCommand.prototype, {
		execute: function (mediatorInstance) {
			var vault = new Vault({
				contentSearchFormId: 'chat-creator-messages-content-search-form',
				contentSearchNameFieldId: 'chat-creator-messages-content-search-name',
				contentSearchResultsId: 'chat-creator-messages-content-search-results',
				dropzoneFieldId: 'chat-creator-messages-files',
				messageTextareaId: 'chat-creator-messages-textarea-message',
				vaultContentIdFieldId: 'chat-creator-messages-vault-content-id',
				vaultContentPriceFieldId: 'chat-creator-messages-price',
				vaultContentSelectionButtonId: 'chat-creator-messages-vault-select',
				vaultId: 'chat-creator-messages-vault',
				vaultType: Vault.TYPE_CREATOR_MESSAGES_AUTO
			});

			vault.socketEvents.CONTENT_CREATED = SocketConnectionEvent.in.MASS_MESSAGE_VAULT_CONTENT_CREATED;
			vault.socketEvents.CREATE_CONTENT = SocketConnectionEvent.out.MASS_MESSAGE_VAULT_CREATE_CONTENT;

			vault.setSocket(SocketConnection.connection);
			vault.setMessageFormActivation(this.context.chatFriendManager.setMessageFormState.bind(this.context.chat_friend_manager));
			vault.setEmptyMessageForm(this.context.manager.empty_message_form.bind(this.context.manager));
			vault.setMessageEncrypter(this.context.manager.make_real_message.bind(this.context.manager));
			vault.setSelectedFriendIdProvider(() => this.context.chatFriendManager.selected_friend);

			mediatorInstance.addVault(vault);
		}
	});

	return CreateVaultInstanceCommand;
});
define('features/CreatorMessages/AutoMessage/commands/EditAutoMessage',[
	'core/Command',
	'services/SocketConnection',
	'services/SocketConnectionEvent',
], function(
	Command,
	SocketConnection,
	SocketConnectionEvent
) {
	var EditAutoMessageCommand = function(context) {
		Command.call(this, context);
	};

	EditAutoMessageCommand.prototype = Object.create(Command.prototype);

	Object.assign(EditAutoMessageCommand.prototype, {
		execute: function (args) {
			SocketConnection.emit(SocketConnectionEvent.out.EDIT_AUTO_MESSAGE, args);
		}
	});

	return EditAutoMessageCommand;
});
define('features/CreatorMessages/AutoMessage/commands/GetListMessagesDisabled',[
	'core/Command',
	'services/SocketConnection',
	'services/SocketConnectionEvent'
], function(
	Command,
	SocketConnection,
	SocketConnectionEvent
) {
	var GetListMessagesDisabledCommand = function(context) {
		Command.call(this, context);
		this.massMessagesStored = null;
	};

	GetListMessagesDisabledCommand.prototype = Object.create(Command.prototype);

	Object.assign(GetListMessagesDisabledCommand.prototype, {
		execute: function () {
			SocketConnection.emit(SocketConnectionEvent.out.GET_ALL_AUTO_MESSAGE, {
				is_active: 0,
				page: 1
			});
		},
	});

	return GetListMessagesDisabledCommand;
});
define('features/CreatorMessages/AutoMessage/commands/LoadMoreAutoMessage',[
	'core/Command',
	'services/SocketConnection',
	'services/SocketConnectionEvent'
], function(
	Command,
	SocketConnection,
	SocketConnectionEvent
) {
	var LoadMoreAutoMessageCommand = function(context) {
		Command.call(this, context);
	};

	LoadMoreAutoMessageCommand.prototype = Object.create(Command.prototype);

	Object.assign(LoadMoreAutoMessageCommand.prototype, {
		execute: function (args) {
			if (typeof args === 'undefined' || typeof args.page === 'undefined') {
				throw new Error('No page to load');
				return;
			}
			SocketConnection.emit(SocketConnectionEvent.out.GET_ALL_AUTO_MESSAGE, args);
		}
	});

	return LoadMoreAutoMessageCommand;
});

define('text!ui/FormField/Select/Select.mustache',[],function () { return '<div class="chat-ui-form-field {{baseClassName}}">\n\t{{#label}}<label class="chat-ui-form-field__label">{{label}}</label>{{/label}}\n\t<select{{#classes}} class="{{classes}}"{{/classes}}{{#attributes}} {{{attributes}}}{{/attributes}}>\n\t\t{{#options}}<option value="{{value}}"{{#hidden}} selected disabled style="display: none"{{/hidden}}>{{label}}</option>{{/options}}\n\t</select>\n\t<div class="{{buttonClasses}}"></div>\n\t<ul class="{{optionsClasses}}"></ul>\n</div>';});

define('ui/FormField/Select/Select',[
	'lib/tools',
	'!ui/FormField/Field',
	'text!ui/FormField/Select/Select.mustache'
], function(
	tools,
	Field,
	tplSelect,
) {
	// CSS CLASS NAMES
	var BASE = 'chat-ui-select',
		SELECT = BASE + '__select',
		SELECT_ERROR = SELECT + '--error',
		BUTTON = BASE + '__button',
		BUTTON_ERROR = BUTTON + '--error',
		BUTTON_DISABLED = BUTTON + '--disabled',
		BUTTON_FOCUSED = BUTTON + '--focused',
		BUTTON_HIDDEN = BUTTON + '--hidden',
		BUTTON_PLACEHOLDER = BUTTON + '-placeholder',
		LIST = BASE + '__list',
		LIST_HIDDEN = LIST + '--hidden',
		OPTION = BASE + '__option',
		OPTION_SELECTED = OPTION + '--selected',
		ERROR_MESSAGE = 'chat-ui-form-field__error-message';

	/**
	 * Select form field.
	 *
	 * @extends Field
	 *
	 * @param {object} options Options to customize the component.
	 * @param {string=} options.modifier A string.
	 * @param {string=} options.classes Class names to apply on the top level element.
	 * @param {array=} options.options An array of options {value: "", label: ""}.
	 * @param {object=} options.attributes Attributes to apply ont the top level element.
	 * @param {string=} options.placeholder String to display when no option is selected.
	 * @constructor
	 */
	var Select = function (options) {
		this.options = Object.assign({}, {
			classes: SELECT,
			modifier: "",
			attributes: {},
			options: [],
			placeholder: ''
		}, options);
		if (this.options.placeholder) {
			this.options.options.unshift({value: "", label: this.options.placeholder, hidden: true});
		}
		this.template = tplSelect;
		this.error = false;
		Field.call(this);
		this.select = this.getElement().querySelector('.' + SELECT);
		this.button = this.getElement().querySelector('.' + BUTTON);
		this.buttonHasEvent = false;
		this.list = this.getElement().querySelector('.' + LIST);
		this.init();
	};

	Select.prototype = Object.create(Field.prototype);

	Object.assign(Select.prototype, {
		close: function (elt) {
			if (elt !== this.button) {
				this.button.classList.remove(BUTTON_FOCUSED);
			}
		},
		disable: function () {
			this.button.setAttribute('disabled', '');
			this.button.classList.add('disabled');
			this.select.setAttribute('disabled', '');
			this.select.classList.add('disabled');
		},
		enable: function () {
			this.button.removeAttribute('disabled');
			this.button.classList.remove('disabled');
			this.select.removeAttribute('disabled');
			this.select.classList.remove('disabled');
		},
		getElementSelected: function () {
			return this.button;
		},
		getForcedTemplateParams: function () {
			return {
				baseClassName: BASE,
				selectClasses: `${SELECT}`,
				buttonClasses: BUTTON,
				optionsClasses: `${LIST} ${LIST_HIDDEN}`
			};
		},
		getValue: function () {
			return this.select.value;
		},
		init: function () {
			this.select.addEventListener('change', this.onSelectChange.bind(this));
			this.initButton();
			this.initList();
		},
		initButton: function () {
			var buttonLabel = '';
			if (this.options.placeholder) {
				buttonLabel = `<span class="${BUTTON_PLACEHOLDER}">${this.options.placeholder}</span>`;
			} else {
				buttonLabel = this.select.options[this.select.selectedIndex].innerHTML;
			}
			this.button.innerHTML = buttonLabel;

			if (this.buttonHasEvent) {
				return;
			}

			this.addElementListener(this.button, 'click', this.onClickSelect, 'select', this);
			this.buttonHasEvent = true;
		},
		initList: function () {
			for (var i = 0; i < this.select.length; i++) {
				if (this.select.options[i].selected && this.select.options[i].disabled) {
					continue;
				}
				var option = this.select.options[i],
					selectOption = tools.string_to_node(`<li class="${OPTION}" data-value="${option.value}"></li>`);

				selectOption.innerHTML = option.innerHTML;

				if (this.select.options[this.select.selectedIndex].value === option.value) {
					selectOption.classList.add(OPTION_SELECTED);
				}
				this.addElementListener(selectOption, 'click', this.onClickSelectOption, 'select', this);
				this.list.appendChild(selectOption);
			}
		},
		onClickSelect: function (event) {
			event.stopPropagation();
			this.close();
			if (this.select.disable === true) {
				return;
			}
			this.list.classList.toggle(LIST_HIDDEN);
			this.button.classList.toggle(BUTTON_FOCUSED);
			if (this.error) {
				this.removeError();
			}
		},
		onClickSelectOption: function (event) {
			this.selectOption(event.target.dataset.value);
			this.button.click();
			if (this.error) {
				this.removeError();
			}
		},
		onSelectChange: function (event) {
			this.selectOption(event.target.value);
			this.button.innerHTML = event.target.value;
			if (this.error) {
				this.removeError();
			}
		},
		removeError: function () {
			this.button.classList.remove(BUTTON_ERROR);
			this.select.classList.remove(SELECT_ERROR);
			var message = document.querySelector('.' + ERROR_MESSAGE);
			if (!message) {
				return;
			}
			message.parentNode.removeChild(message);
			this.error = false;
		},
		resetList: function() {
			var options = this.list.querySelectorAll('.' + OPTION);
			options.forEach(function(option) {
				if (option.classList.contains(OPTION_SELECTED)) {
					option.classList.remove(OPTION_SELECTED);
				}
			});
		},
		resetSelect: function() {
			this.select.selectedIndex = 0;
			this.resetList();
			this.close();
		},
		selectOption: function (value) {
			var elt = this.list.querySelector(`[data-value="${value}"]`);

			if (!elt) {
				wglog.error('Select::selectOption', 'Element not found');
			}

			for (var i = 0; i < this.select.length; i++) {
				if (this.select.options[i].innerHTML === elt.innerHTML) {
					this.select.selectedIndex = i;
					this.button.innerHTML = elt.innerHTML;
					var alreadySelected = elt.parentNode.getElementsByClassName(OPTION_SELECTED);
					for (var j = 0; j < alreadySelected.length; j++) {
						alreadySelected[j].classList.remove(OPTION_SELECTED);
					}
					elt.classList.add(OPTION_SELECTED);
					break;
				}
			}
		},
		setError: function (message) {
			if (this.error) {
				return;
			}
			this.select.classList.add(SELECT_ERROR);
			this.button.classList.add(BUTTON_ERROR);
			this.error = true;
			if (!message) {
				return;
			}
			var errorMessage = tools.string_to_node(`<p class="${ERROR_MESSAGE}">${message}</p>`);
			this.getElement().append(errorMessage);
		},
		setValue: function (value) {
			this.getElement().querySelector('.' + OPTION + '[data-value="' + value + '"]').click();
			this.button.click();
		}
	});

	return Select;
});
define('features/CreatorMessages/AutoMessage/views/AutoMessageView',[
	'config/chat',
	'lib/i18n!front',
	'features/CreatorMessages/views/CreatorMessagesView',
	'features/Message/ReportMessage',
	'ui/FormField/Input/Input',
	'ui/FormField/Select/Select',
	'lib/tools',
], function(
	Config,
	i18n,
	CreatorMessagesView,
	ReportMessage,
	Input,
	Select,
	tools
) {

	var FEATURE_NAME = 'auto_message',
		KEY_I18N = 'chat.' + FEATURE_NAME,
		CREATOR_MESSAGE_TITLE = '.chat-creator-messages__title-text',
		NEED_A_PARAM = ['tip_greater_than','x_amount_spent'],
		PRICE_BUTTON_SELECTOR = '.chat-btn--creator-messages-price',
		PRICE_FIELD_SECTION_ELEMENTS = '.chat-creator-messages__price',
		VAULT_TEXT_ACTIVE_TOGGLER_BUTTON_SELECTOR = '#chat-creator-message-toggle-attachment.chat-toggle--show [data-name="mass-message-vault-text"].active',
		WARNING_EVENT_EXISTS = 'creator-messages-list__info',
		SELECTOR_WARNING_EVENT_EXISTS = '.' + WARNING_EVENT_EXISTS,
		SAVE_BUTTON_SELECTOR = '.chat-btn--creator-messages-save';

	var AutoMessageView = function (contacts) {
		CreatorMessagesView.call(this, contacts);
		this.idAutoMessageEdit = null;
		this.observer = null;
		this.param = null;
		this.eventsList = null;
	}

	AutoMessageView.prototype = Object.create(CreatorMessagesView.prototype);

	Object.assign(AutoMessageView.prototype, {
		addListenersMessageListFeature: function(message, classToRemove) {
			var titleMessage = message.querySelector('.messages-list__message-preview'),
				btnSwitchState = message.querySelector('.chat-ui-toggle__input'),
				btnEdit = message.querySelector('.messages-list__btn--edit');

			if (titleMessage) {
				this.addElementListener(titleMessage, 'click', this.onClickEditMessage.bind(this));
			}
			if (btnEdit) {
				this.addElementListener(btnEdit, 'click', this.onClickEditMessage.bind(this));
			}
			if (btnSwitchState) {
				this.addElementListener(btnSwitchState, 'change', this.onSwitchState.bind(this));
			}
			message.classList.remove(classToRemove);
		},
		addEventsListMutationObserver: function() {
			var self = this,
				observerCallback = function(mutationList, observer) {
					for (var mutation of mutationList) {
						if (mutation.type !== 'childList') {
							return;
						}
						self.onChangeSelect();
					}
				};

			this.observer = new MutationObserver(observerCallback);
			this.observer.observe(this.eventsList.getElementSelected(), {
				childList: true
			});
		},
		createEventsList: function(eventsList) {
			if (!!this.eventsList) {
				return;
			}

			var options = [];
			for (var index in eventsList) {
				options.push({
					label: i18n.__(KEY_I18N + '.' + eventsList[index]),
					value: eventsList[index]
				});
			}

			this.eventsList = new Select({
				attributes: {
					id: 'auto-message-events',
				},
				options: options,
				placeholder: i18n.__('chat.auto_message_event')
			});

			var eventsPlaceholder = this.element.querySelector('#events-placeholder');
			if (!(!!eventsPlaceholder)) {
				wglog.debug('AutoMessageView::createEventsList No events placeholder', eventsPlaceholder);
			} else {
				tools.replaceElement(eventsPlaceholder, this.eventsList.getElement());
				this.addEventsListMutationObserver();
			}
		},
		createMessage: function() {
			CreatorMessagesView.prototype.createMessage.call(this);

			this.removeEventsListMutationObserver();
			this.eventsList.initButton();
			this.eventsList.resetSelect();
			this.addEventsListMutationObserver();
			this.toggleWarningEventExists(false);
			this.toggleAttachmentFieldDisplay(false);

			this.getElement().querySelector(SAVE_BUTTON_SELECTOR).innerText = i18n.__('save');
		},
		createParamField: function(value) {
			if (NEED_A_PARAM.indexOf(value) === -1) {
				return;
			}

			var placeholder = document.createElement('div');
			placeholder.setAttribute('id','param-field-placeholder');
			this.eventsList.getElement().parentNode.append(placeholder);

			this.param = new Input({
				type: 'number',
				attributes: {
					id: 'chat-creator-events-param',
					inputmode: 'decimal',
					pattern: '[0-9]*([\.][0-9]+)?',
					placeholder: i18n.__(KEY_I18N + '.amount')
				},
				prepend: '$'
			});
			tools.replaceElement(this.element.querySelector('#param-field-placeholder'), this.param.getElement());
		},
		editMessage: function(idMessage) {
			this.idAutoMessageEdit = idMessage;
			this.createMessage();
			this.setEditMessage(this.mediator.getMessageData(this.idAutoMessageEdit, this.getCurrentList()));
		},
		emptyFormFields: function() {
			CreatorMessagesView.prototype.emptyFormFields.call(this);

			this.idAutoMessageEdit = null;
			this.eventsList.enable();
			this.removeParamField();
		},
		getEvent: function() {
			return this.eventsList.getValue();
		},
		getEditTitle: function() {
			return i18n.__(KEY_I18N + '_edit');
		},
		getFeatureName: function() {
			return FEATURE_NAME;
		},
		getFeatureTitle: function() {
			return i18n.__(KEY_I18N);
		},
		getGuide: function() {
			return '<li>No guide</li>';
		},
		getMessagesListTitle: function() {
			return this.getFeatureTitle();
		},
		getNewMessageTitle: function () {
			return i18n.__(KEY_I18N + '_new');
		},
		getNoMessagesLabel: function() {
			return i18n.__(KEY_I18N + '_no_message');
		},
		getParam: function() {
			if (this.param === null) {
				return null;
			}
			return +this.param.getValue();
		},
		hasDynamicVar: function() {
			return true;
		},
		hasEventsList: function() {
			return true;
		},
		hasPrice: function() {
			return true;
		},
		initMessagesList(data, listName) {
			CreatorMessagesView.prototype.initMessagesList.call(this, ...arguments);

			var currentListName = this.getCurrentList(),
				messagesListElt = this.messagesLists[currentListName].getElement(),
				isActiveMessagesList = currentListName === 'auto_message_active',
				buttonClass = 'btn chat-btn--creator-messages chat-btn--creator-messages-switch-messages-list btn--creator-messages-switch-messages-list',
				buttonLabel = i18n.__('chat.auto_message.switch_button', {'%state%' : isActiveMessagesList ? i18n.__('chat.auto_message.state_disable') : i18n.__('chat.auto_message.state_active')}),
				buttonElt = tools.string_to_node(`<button type="button" class="${buttonClass}" data-list="${isActiveMessagesList ? 'auto_message_disabled': 'auto_message_active'}">${buttonLabel}</button>`),
				keyMessagesList = Object.keys(this.messagesLists),
				self = this;

			if (keyMessagesList.length > 1) {
				for (var index in keyMessagesList) {
					if (keyMessagesList[index] === currentListName) {
						continue;
					}
					this.messagesLists[keyMessagesList[index]].getElement().classList.add('is-hidden');
				}
			}

			messagesListElt.parentNode.insertBefore(buttonElt, messagesListElt);

			this.addElementListener(buttonElt, 'click', function(event) {
				self.onClickSwitchMessagesList(event);
			});
		},
		initModal: function() {
			CreatorMessagesView.prototype.initModal.call(this);

			this.modal.container.closest('.x-body').addClass('chat-auto-message-popup');
		},
		initPriceField: function() {
			this.price = new Input({
				type: 'text',
				attributes: {
					id: 'chat-creator-messages-price',
					inputmode: 'decimal',
					pattern: '[0-9]*([\.][0-9]+)?',
					placeholder: i18n.__('chat.vault.price', {
						'%price_min%': Config.file_upload.ppc.min.toString(),
						'%price_max%': Config.file_upload.ppc.max.toString()
					})
				},
				prepend: '$'
			});
			tools.replaceElement(this.element.querySelector('#price-placeholder'), this.price.getElement());
		},
		onChangeSelect: function() {
			this.changeEvent = true;

			var eventValue = this.eventsList.getValue(),
				existingAutoMessage = this.mediator.getMessagesDataByEvent(eventValue);

			if (existingAutoMessage) {
				this.toggleWarningEventExists(true);

				if (existingAutoMessage.param) {
					this.paramVal = existingAutoMessage.param;
				}

				var priceAutoMessage = null;

				for (var index in existingAutoMessage.messages_translated) {
					var currentMessage = existingAutoMessage.messages_translated[index];

					this.setAutoMessage(currentMessage);

					if (typeof currentMessage.price === "number" && currentMessage.price !== priceAutoMessage) {
						priceAutoMessage = currentMessage.price;
					}
				}

				if (priceAutoMessage && this.getIsValidPrice(priceAutoMessage)) {
					this.setPrice(priceAutoMessage);
					this.togglePriceFieldDisplay(true);
				}
				else {
					this.emptyPriceButton();
				}

				this.getElement().querySelector(SAVE_BUTTON_SELECTOR).innerText = i18n.__('misc.update');
			}
			else {
				this.toggleWarningEventExists(false);
				this.emptyFormFields();
				this.toggleAttachmentFieldDisplay(false);

				this.getElement().querySelector(SAVE_BUTTON_SELECTOR).innerText = i18n.__('save');
			}

			if (NEED_A_PARAM.indexOf(eventValue) === -1) {
				this.removeParamField();
				return;
			}

			if (typeof this.param === 'undefined' || this.param === null) {
				this.createParamField(eventValue);
			}

			if (typeof this.paramVal === 'undefined' || this.paramVal === null) {
				this.setParam(i18n.__(KEY_I18N + '.amount'));
				return;
			}

			this.setParam(this.paramVal);
			delete this.paramVal;
		},
		onClickEditMessage: function(event) {
			event.preventDefault();
			this.editMessage(parseInt(event.target.closest('.messages-list__message').dataset.idAutoMessage));
		},
		onClickPriceButton: function() {
			this.toggleDisplay([PRICE_BUTTON_SELECTOR], [PRICE_FIELD_SECTION_ELEMENTS]);
			var self = this;
			this.addElementListener(this.element, 'click', function (event) {
				if (document.querySelector('.chat-form-actions__price').contains(event.target)) {
					return;
				}
				self.savePrice();
			}, 'price');
			this.addElementListener('input#chat-creator-messages-price', 'keydown', function(event) {
				if (event.key !== 'Enter') {
					return;
				}
				self.savePrice();
			}, 'price');
		},
		onClickSwitchMessagesList: function(event) {
			var listToShow = event.target.dataset.list,
				messagesListsElt = document.querySelectorAll('.messages-list'),
				messagesListsButton = document.querySelectorAll('.btn--creator-messages-switch-messages-list'),
				isFound = false;

			messagesListsElt.forEach(function(list) {
				if (list.dataset.list === listToShow) {
					isFound = true;
				}
			});

			if (isFound) {
				messagesListsElt.forEach(function(list) {
					list.classList.toggle('is-hidden');
				});
			}
			else {
				this.mediator.emitGetAllMessagesDisabled();
			}

			messagesListsButton.forEach(function(button) {
				button.classList.toggle('is-hidden');
			});

			this.setCurrentList(listToShow);
		},
		onSwitchState: function(event) {
			event.preventDefault();
			this.switchMessageState(event.target.closest('.messages-list__message'), event.target.checked);

		},
		onMessageSwitched: function(id, isEnable) {
			var messagesListElt = this.messagesLists[this.getCurrentList()].getElement(),
				message = messagesListElt.querySelector('[data-id-auto-message="' + id + '"'),
				currentState = message.querySelector('.chat-ui-toggle__input').checked;

			if (currentState !== isEnable) {
				message.querySelector('.chat-ui-toggle__input').checked = isEnable;
			}
		},
		prepareMessageData: function (messageFromVault) {
			var price = (isNaN(this.getPrice()) || this.getPrice() === 0) ? null : this.getPrice(),
				msg = '';

			if (!!messageFromVault) {
				if (!!price) {
					messageFromVault.price = price;
				}
				msg = JSON.stringify(messageFromVault);
			}
			else {
				msg = this.mediator.context.manager.make_real_message(this.getMessage());
			}

			var data =  {
				'messages': [msg],
				'price': price,
				'event': this.getEvent()
			};

			var param = this.getParam();
			if (param !== null) {
				data.param = param;
			}
			return data;
		},
		removeEventsListMutationObserver: function() {
			this.observer.disconnect();
		},
		removeFeature: function() {
			delete this.eventsList;
		},
		removeParamField: function() {
			if (typeof this.param === 'undefined' || this.param === null) {
				return;
			}

			this.param.getElement().remove();
			delete this.param;
		},
		savePrice: function() {
			var price = this.price.getField().value,
				isValidPrice = this.getIsValidPrice(price);

			if (!isValidPrice) {
				this.price.setError(i18n.__('chat.vault.price_error', {
					'%price_min%': Config.file_upload.ppc.min.toString(),
					'%price_max%': Config.file_upload.ppc.max.toString(),
				}));
				return;
			}

			this.price.removeError();
			this.setPrice(price);

			var mobile = window.matchMedia("(max-width: 767px)").matches,
				elementsToShow = mobile ? [PRICE_BUTTON_SELECTOR] : [PRICE_BUTTON_SELECTOR];

			if (price === '') {
				this.emptyPriceButton();
				this.toggleDisplay([PRICE_FIELD_SECTION_ELEMENTS], elementsToShow);
				this.removeElementListeners(this.getNamespaceListeners('price'));
				return;
			}

			var isVaultTextTogglerButtonActive = !!document.querySelector(VAULT_TEXT_ACTIVE_TOGGLER_BUTTON_SELECTOR),
				btn = this.element.querySelector(PRICE_BUTTON_SELECTOR);

			btn.innerHTML = '$' + price;
			btn.classList.add('has-price');
			this.toggleDisplay([PRICE_FIELD_SECTION_ELEMENTS], elementsToShow);
			this.removeElementListeners(this.getNamespaceListeners('price'));
			if (!isVaultTextTogglerButtonActive) {
				this.openAttachments('mass-message-vault-text');
			}
		},
		saveMessage: function(messageData) {
			if (messageData) {
				if (this.idAutoMessageEdit === null) {
					this.mediator.emitSaveMessage(messageData);
				}
				else {
					messageData.auto_message_id = this.idAutoMessageEdit;
					var messageElt = this.messagesLists[this.getCurrentList()].getElement().querySelector('[data-id-auto-message="' + this.idAutoMessageEdit + '"]');
					messageElt.querySelector('.chat-ui-form-field-toggle').classList.toggle('is-active');
					messageElt.querySelector('.chat-ui-toggle__input').checked = false;
					this.mediator.emitEditMessage(messageData);
					this.idAutoMessageEdit = null;
					this.eventsList.enable();
				}
			}
		},
		setAutoMessage: function(message) {
			if (typeof message.message === "string") {
				this.setMessage(message.message);
			}

			if (!message.is_content) {
				this.toggleAttachmentFieldDisplay(false);
				return;
			}

			var contentType = message.is_vault ? 'vault' : 'content',
				content = this[contentType].contents.get(+message.content_id);

			if (content) {
				this[contentType].fillMessageFormFields(content);

				var isTypeText = !!((message.is_vault || message.is_content) && content.media_type === 'text');
				if (isTypeText) {
					this.formTabs.selectTab('creator-messages-vault-text');
				} else if (message.is_vault) {
					this.formTabs.selectTab(this.vaultSystemName);
				} else {
					this.formTabs.selectTab(this.contentSystemName);
				}

				this.toggleAttachmentFieldDisplay(true);
			}
		},
		setEditMessage: function(messageJson) {
			this.element.querySelector(CREATOR_MESSAGE_TITLE).innerText = this.getEditTitle();

			this.eventsList.disable();
			this.eventsList.setValue(messageJson.event);

			if (typeof messageJson.param !== 'undefined') {
				this.paramVal = messageJson.param;
			}

			if (messageJson.messages_translated.length > 1) {
				throw new Error('Unable to edit more than one auto message');
			}

			for (var index in messageJson.messages_translated) {
				this.setAutoMessage(messageJson.messages_translated[index]);
			}

			if (typeof messageJson.price === "number" && messageJson.price) {
				this.setPrice(messageJson.price);
				this.togglePriceFieldDisplay(true);
			}
		},
		setParam: function(val) {
			this.param.setValue(val);
		},
		switchMessageState: function(messageElt, isChecked) {
			this.mediator.switchMessageState(parseInt(messageElt.dataset.idAutoMessage), isChecked);
			messageElt.querySelector('.chat-ui-form-field-toggle').classList.toggle('is-active');
		},
		toggleWarningEventExists: function(show) {
			var warningEventExistsElt = this.getElement().querySelector(SELECTOR_WARNING_EVENT_EXISTS);
			if (warningEventExistsElt) {
				warningEventExistsElt.classList[show ? 'remove' : 'add']('is-hidden');
				return;
			}
			if (!show) {
				return;
			}
			var warning = document.createElement('p');
			warning.setAttribute('class',WARNING_EVENT_EXISTS + ' ' + WARNING_EVENT_EXISTS + '--box');
			warning.innerText = i18n.__('chat.auto_message_event_exists');
			this.eventsList.getElement().closest('fieldset').appendChild(warning);
		},
		updateMessagesListFeature: function(message) {
			if (message.feature !== 'auto_message' || message.source !== 'new_message') {
				return;
			}

			var messages = this.mediator.updateMessagesDataByEvent(message.event, this.getCurrentList());
			for (var index in messages) {
				if (messages[index].id === message.id) {
					continue;
				}
				this.messagesLists['auto_message_active'].removeMessage('[data-id-auto-message="' + messages[index].id + '"]');
				if (typeof this.messagesLists['auto_message_disabled'] !== 'undefined') {
					var newMessage = this.messagesLists['auto_message_disabled'].appendMessage(messages[index], true);
					newMessage.querySelector('.chat-ui-form-field-toggle').classList.toggle('is-active');
					newMessage.querySelector('.chat-ui-toggle__input').checked = false;
				}
			}

		},
		validateForm: function () {
			var event = this.eventsList.getValue();
			if (!event.length) {
				this.eventsList.setError(i18n.__('chat.contact_list.target_required'));
				return false;
			} else {
				this.eventsList.removeError();
			}

			/*var attachmentIsDisplayed = this.getElement().querySelector('[data-toggle="#chat-creator-messages-toggle-attachment"]').classList.contains('active'),
				attachmentIsContent = attachmentIsDisplayed && this.getElement().querySelector('.chat-tabs__item.active').dataset.name === 'creator-messages-content-selector';

			var title = this.getTitle();
			if (attachmentIsContent && !title.length) {
				this.title.setError(i18n.__('chat.mass_message.title_required'));
				return false;
			} else {
				if (this.title !== null) {
					this.title.removeError();
				}
			}*/

			var message = this.getMessage();
			if (!message.length) {
				this.message.setError(i18n.__('chat.mass_message.message_required'));
				return false;
			} else {
				this.message.removeError();
			}

			if (!ReportMessage.checkAutoBlock(message, Config.login_info.id)) {
				this.message.setError(i18n.__('chat.error.blocking_word_in_message', {'%word%': ReportMessage.getLastAutoBlockingWord()}));
				return false;
			}

			if (!this.getIsValidPrice(this.price.getField().value)) {
				this.price.setError(i18n.__('chat.vault.price_error', {
					'%price_min%': Config.file_upload.ppc.min.toString(),
					'%price_max%': Config.file_upload.ppc.max.toString(),
				}));
				return false;
			}
			else {
				this.price.removeError();
			}

			return true;
		}
	});

	return AutoMessageView;

});
define('features/CreatorMessages/AutoMessage/commands/OpenAutoMessage',[
	'lib/storage',
	'core/Command',
	'services/SocketConnection',
	'services/SocketConnectionEvent',
	'features/CreatorMessages/models/CreatorMessagesContactModel',
	'features/CreatorMessages/AutoMessage/events/AutoMessageEvent',
	'features/CreatorMessages/AutoMessage/views/AutoMessageView',
	'libs/EventEmitter',
], function(
	Storage,
	Command,
	SocketConnection,
	SocketConnectionEvent,
	CreatorMessagesContactModel,
	AutoMessageEvent,
	AutoMessageView,
	EventEmitter
) {
	var OpenAutoMessageCommand = function(context) {
		Command.call(this, context);
		this.autoMessagesStored = null;
		this.autoMessagesEventsStored = null;
	};

	OpenAutoMessageCommand.prototype = Object.create(Command.prototype);

	Object.assign(OpenAutoMessageCommand.prototype, {
		areDataEventsValid: function() {
			this.autoMessagesEventsStored = Storage.get('chat_auto_message_events');
			if (
				this.autoMessagesEventsStored === null
				|| typeof this.autoMessagesEventsStored === 'undefined'
				|| typeof this.autoMessagesEventsStored.d === 'undefined'
				|| typeof this.autoMessagesEventsStored.t === 'undefined'
				|| this.autoMessagesEventsStored.d.length < 1
				|| (this.autoMessagesEventsStored.t + (1000 * 60 * 30)) < Date.now()
			) {
				wglog.debug('OpenAutoMessageCommand::areDataValid autoMessagesEventsStored invalid', this.autoMessagesEventsStored);
				return false;
			}
			return true;
		},
		execute: function () {
			var contact = new CreatorMessagesContactModel();
			this.autoMessagesStored = Storage.get('chat_auto_messages');
			this.autoMessagesEventsStored = Storage.get('chat_auto_message_events');
			new AutoMessageView(contact.getAll());
			this.emitEvent();
		},
		emitEvent: function() {
			if (this.areDataEventsValid()) {
				wglog.debug('OpenAutoMessageCommand::emitEvent get events from local storage', this.autoMessagesEventsStored);
				EventEmitter.emit(AutoMessageEvent.OPEN_FROM_LOCAL_STORAGE_EVENTS, this.autoMessagesEventsStored);
			} else {
				wglog.debug('OpenAutoMessageCommand::emitEvent call to get events');
				SocketConnection.emit(SocketConnectionEvent.out.GET_AUTO_MESSAGE_EVENT_LIST, {});
			}
			SocketConnection.emit(SocketConnectionEvent.out.GET_ALL_AUTO_MESSAGE, {
				page: 1
			});
		}
	});

	return OpenAutoMessageCommand;
});
define('features/CreatorMessages/AutoMessage/commands/SaveAutoMessage',[
	'core/Command',
	'services/SocketConnection',
	'services/SocketConnectionEvent',
], function(
	Command,
	SocketConnection,
	SocketConnectionEvent
) {
	var SaveAutoMessageCommand = function(context) {
		Command.call(this, context);
	};

	SaveAutoMessageCommand.prototype = Object.create(Command.prototype);

	Object.assign(SaveAutoMessageCommand.prototype, {
		execute: function (args) {
			SocketConnection.emit(SocketConnectionEvent.out.SAVE_AUTO_MESSAGE, args);
		}
	});

	return SaveAutoMessageCommand;
});
define('features/CreatorMessages/AutoMessage/commands/SwitchAutoMessage',[
	'core/Command',
	'services/SocketConnection',
	'services/SocketConnectionEvent',
], function(
	Command,
	SocketConnection,
	SocketConnectionEvent
) {
	var SwitchAutoMessageCommand = function(context) {
		Command.call(this, context);
	};

	SwitchAutoMessageCommand.prototype = Object.create(Command.prototype);

	Object.assign(SwitchAutoMessageCommand.prototype, {
		execute: function (args) {
			SocketConnection.emit(SocketConnectionEvent.out.SWITCH_AUTO_MESSAGE, args);
		}
	});

	return SwitchAutoMessageCommand;
});
define('features/CreatorMessages/AutoMessage/commands/TranslateAllAutoMessages',[
	'libs/EventEmitter',
	'lib/i18n!front',
	'core/Command',
	'features/CreatorMessages/AutoMessage/events/AutoMessageEvent',
], function(
	EventEmitter,
	i18n,
	Command,
	AutoMessageEvent
) {
	var TranslateAllAutoMessagesCommand = function(context) {
		Command.call(this, context);
	};

	TranslateAllAutoMessagesCommand.prototype = Object.create(Command.prototype);

	Object.assign(TranslateAllAutoMessagesCommand.prototype, {
		execute: function (result) {
			var updatedResult;

			if (typeof result.data === 'undefined') {
				updatedResult = {};
				updatedResult.data = [];
				if (typeof result.source !== "undefined") {
					updatedResult.source = result.source;
				}
				if (typeof result.feature !== "undefined") {
					updatedResult.feature = result.feature;
				}
				if (typeof result.is_active !== "undefined") {
					updatedResult.is_active = result.is_active;
				}
				updatedResult.data.push(this.translateMessages(result));
			}
			else {
				for (var id in result.data) {
					result.data[id] = this.translateMessages(result.data[id]);
				}
				updatedResult = result;
			}

			if (typeof updatedResult.currentPage === 'undefined') {
				updatedResult.currentPage = 1;
			}

			EventEmitter.emit(AutoMessageEvent.ALL_TRANSLATED, updatedResult);
		},
		translateMessages: function (messages) {

			messages.event_translated = i18n.__('chat.auto_message.' + messages.event);
			messages.messages_translated = [];

			var indexes = Object.keys(messages.messages);
			for (var index in indexes) {
				var message_formated = {},
					message_object_or_string = messages.messages[indexes[index]];

				try {
					var message_object = JSON.parse(message_object_or_string);
					message_object.message = this.context.manager.get_real_message(message_object.message);
					var message_message = JSON.parse(message_object.message);
					message_object.message = message_message.t || message_message.m;
					message_formated = message_object;
				} catch (e) {
					if (typeof message_object_or_string === 'string') {
						message_formated.message = this.context.manager.get_real_message(message_object_or_string);
					}
				}

				messages.messages_translated.push(message_formated);
			}

			return messages;
		}
	});

	return TranslateAllAutoMessagesCommand;
});
define('features/CreatorMessages/AutoMessage/views/AutoMessageMediator',[
	'lib/storage',
	'features/CreatorMessages/views/CreatorMessagesMediator',
	'features/CreatorMessages/AutoMessage/events/AutoMessageEvent',
	'libs/EventEmitter',
], function(
	Storage,
	CreatorMessagesMediator,
	AutoMessageEvent,
	EventEmitter
) {
	var FEATURE_NAME = 'auto_message';

	var AutoMessageMediator = function (view, context, mediatorMap) {
		CreatorMessagesMediator.call(this, view, context, mediatorMap);
	}

	AutoMessageMediator.prototype = Object.create(CreatorMessagesMediator.prototype);

	Object.assign(AutoMessageMediator.prototype, {
		emitEditMessage: function(message) {
			EventEmitter.emit(AutoMessageEvent.EDIT, message);
		},
		emitGetAllMessagesDisabled: function() {
			EventEmitter.emit(AutoMessageEvent.GET_ALL_MESSAGES_DISABLED);
		},
		emitLoadMoreMessageList: function(listName) {
			EventEmitter.emit(AutoMessageEvent.LOAD_MORE, {
				page: this.messagesLists[listName].currentPage,
				is_active: (listName === 'auto_message_disabled') ? 0 : 1
			});
		},
		getEventsFeature: function() {
			return AutoMessageEvent;
		},
		getMessagesDataByEvent: function(event, listName) {
			if (this.messagesLists === {}) {
				return;
			}
			if (typeof listName === 'undefined') {
				listName = 'auto_message_active';
			}
			var messages = [];
			for (var index in this.messagesLists[listName].data) {
				if (this.messagesLists[listName].data[index].event === event) {
					return this.messagesLists[listName].data[index];
				}
			}

			return false;
		},
		onAllEvent: function(result) {
			var events = !!result.d ? result.d : result.event_list;
			this.saveEventsState(events);
			this.view.createEventsList(events);
		},
		onMessageEdited: function(result) {
			result.source = 'new_message';
			EventEmitter.emit(AutoMessageEvent.TRANSLATE_ALL, result);
			this.view.messageSaved();
		},
		onMessageSwitched: function(result) {
			this.view.onMessageSwitched(result.id, result.is_active);
		},
		saveEventsState: function(eventsList) {
			var storageKey = 'chat_' + FEATURE_NAME + '_events';
			if (Storage.get(storageKey)) {
				Storage.remove(storageKey);
			}
			Storage.set(storageKey, {
				d: eventsList,
				t: Date.now()
			});
		},
		switchMessageState: function(idMessage, isChecked) {
			EventEmitter.emit(AutoMessageEvent.SWITCH, {
				'auto_message_id': idMessage,
				'active': isChecked ? 1 : 0
			});
		},
		updateMessagesDataByEvent: function(event, listName) {
			if (this.messagesLists === {}) {
				return;
			}
			var messages = [];
			for (var index in this.messagesLists[listName].data) {
				if (this.messagesLists[listName].data[index].event === event) {
					messages.push(this.messagesLists[listName].data[index]);
				}
			}
			return messages;
		},
	});

	return AutoMessageMediator;
});
define('features/CreatorMessages/AutoMessage/AutoMessageMapper',[
	'config/chat',
	'features/CreatorMessages/AutoMessage/commands/CreateContentInstance',
	'features/CreatorMessages/AutoMessage/commands/CreateVaultInstance',
	'features/CreatorMessages/AutoMessage/commands/EditAutoMessage',
	'features/CreatorMessages/AutoMessage/commands/GetListMessagesDisabled',
	'features/CreatorMessages/AutoMessage/commands/LoadMoreAutoMessage',
	'features/CreatorMessages/AutoMessage/commands/OpenAutoMessage',
	'features/CreatorMessages/AutoMessage/commands/SaveAutoMessage',
	'features/CreatorMessages/AutoMessage/commands/SwitchAutoMessage',
	'features/CreatorMessages/AutoMessage/commands/TranslateAllAutoMessages',
	'features/CreatorMessages/AutoMessage/events/AutoMessageEvent',
	'features/CreatorMessages/AutoMessage/views/AutoMessageMediator',
	'features/CreatorMessages/AutoMessage/views/AutoMessageView',
	'services/SocketConnection',
	'services/SocketConnectionEvent'
], function(
	Config,
	CreateContentInstanceCommand,
	CreateVaultInstanceCommand,
	EditAutoMessageCommand,
	GetListMessagesDisabledCommand,
	LoadMoreAutoMessageCommand,
	OpenAutoMessageCommand,
	SaveAutoMessageCommand,
	SwitchAutoMessageCommand,
	TranslateAllAutoMessagesCommand,
	AutoMessageEvent,
	AutoMessageMediator,
	AutoMessageView,
	SocketConnection,
	SocketConnectionEvent,
) {
	return function(context) {
		if (!Config.login_info.is_creator) {
			return;
		}

		context.commandMap.mapEvent(AutoMessageEvent.CREATE_CONTENT_INSTANCE, CreateContentInstanceCommand);
		context.commandMap.mapEvent(AutoMessageEvent.CREATE_VAULT_INSTANCE, CreateVaultInstanceCommand);

		context.commandMap.mapEvent(AutoMessageEvent.EDIT, EditAutoMessageCommand);
		context.commandMap.mapEvent(AutoMessageEvent.GET_ALL_MESSAGES_DISABLED, GetListMessagesDisabledCommand);
		context.commandMap.mapEvent(AutoMessageEvent.LOAD_MORE, LoadMoreAutoMessageCommand);
		context.commandMap.mapEvent(AutoMessageEvent.OPEN, OpenAutoMessageCommand);
		context.commandMap.mapEvent(AutoMessageEvent.SAVE, SaveAutoMessageCommand);
		context.commandMap.mapEvent(AutoMessageEvent.SWITCH, SwitchAutoMessageCommand);
		context.commandMap.mapEvent(AutoMessageEvent.TRANSLATE_ALL, TranslateAllAutoMessagesCommand);

		context.mediatorMap.mapEvent(AutoMessageEvent.ALL_EVENT, AutoMessageMediator, 'onAllEvent');
		context.mediatorMap.mapEvent(AutoMessageEvent.OPEN_FROM_LOCAL_STORAGE_EVENTS, AutoMessageMediator, 'onAllEvent');
		context.mediatorMap.mapEvent(AutoMessageEvent.ALL_TRANSLATED, AutoMessageMediator, 'onAllMessage');
		context.mediatorMap.mapEvent(AutoMessageEvent.EDITED, AutoMessageMediator, 'onMessageEdited');
		context.mediatorMap.mapEvent(AutoMessageEvent.SAVED, AutoMessageMediator, 'onMessageSaved');
		context.mediatorMap.mapEvent(AutoMessageEvent.SWITCHED, AutoMessageMediator, 'onMessageSwitched');
		context.mediatorMap.mapEvent(AutoMessageEvent.ADD_CONTENT_SERVICE, AutoMessageMediator, 'onAddContentService');
		context.mediatorMap.mapEvent(AutoMessageEvent.VAULT_CONTENT_CREATED, AutoMessageMediator, 'onVaultContentCreated');
		context.mediatorMap.mapEvent(AutoMessageEvent.VAULT_GET_CONTENT_PRELOAD, AutoMessageMediator, 'onVaultContentPreloaded');
		context.mediatorMap.mapEvent(AutoMessageEvent.CONTENT_GET_CONTENT_PRELOAD, AutoMessageMediator, 'onVaultContentPreloaded');
		context.mediatorMap.mapEvent(AutoMessageEvent.VAULT_CONTENT_ERROR, AutoMessageMediator, 'onVaultContentError');

		context.mediatorMap.mapView(AutoMessageView, AutoMessageMediator);

		SocketConnection.forwardIncomingEvent(SocketConnectionEvent.in.ALL_EVENT_AUTO_MESSAGE, AutoMessageEvent.ALL_EVENT);
		SocketConnection.forwardIncomingEvent(SocketConnectionEvent.in.ALL_AUTO_MESSAGE, AutoMessageEvent.TRANSLATE_ALL);
		SocketConnection.forwardIncomingEvent(SocketConnectionEvent.in.AUTO_MESSAGE_EDITED, AutoMessageEvent.EDITED);
		SocketConnection.forwardIncomingEvent(SocketConnectionEvent.in.AUTO_MESSAGE_SAVED, AutoMessageEvent.SAVED);
		SocketConnection.forwardIncomingEvent(SocketConnectionEvent.in.AUTO_MESSAGE_SWITCHED, AutoMessageEvent.SWITCHED);
		SocketConnection.forwardIncomingEvent(SocketConnectionEvent.in.AUTO_MESSAGE_VAULT_CONTENT_CREATED, AutoMessageEvent.VAULT_CONTENT_CREATED);
	};
});
define('features/Message/commands/CheckForUrlInMessage',[
	'core/Command',
	'features/Message/events/MessageEvent',
	'lib/utils',
	'libs/EventEmitter',
], function(
	Command,
	MessageEvent,
	utils,
	EventEmitter
) {
	var CheckForUrlInMessage = function(context) {
		Command.call(this, context);
	};

	CheckForUrlInMessage.prototype = Object.create(Command.prototype);

	Object.assign(CheckForUrlInMessage.prototype, {
		checkUrlsInElement: function (message, element) {
			var	urlMatches = element.innerHTML.match(/(?:^|[^"'])(https?:\/\/[^\s<"]+)/gm);

			if (!urlMatches) {
				return;
			}

			var uniqueUrls = {};
			var cleanUrls = urlMatches.map(function(item) {
				var trimmed = utils.decodeHTMLEntities(item).trim();
                trimmed = trimmed.replace(/,$/, '');
				return trimmed.substring(trimmed.indexOf('http'));
			});
			var urls = cleanUrls.filter(function(item) {
				if (!uniqueUrls[item]) {
					uniqueUrls[item] = true;
					return true;
				}
				return false;
			});

			var friendId = +message.closest('.chat-tab-container').id.replace('chat_messages_tab_', '');

			EventEmitter.emit(MessageEvent.REQUEST_URL_METADATA, urls, message.id, friendId, +message.dataset.mm, +message.dataset.am);
		},
		execute: function (message) {
			var elements = message.querySelectorAll('.chat-message__message > :not(.chat-message__metas)');

			if (!elements.length) {
				return;
			}

			var self = this;
			elements.forEach(function(element) {
				self.checkUrlsInElement(message, element);
			});
		}
	});

	return CheckForUrlInMessage;
});
define('features/Message/utils/ForwardMessage',[
	'lib/emoji',
	'lib/utils'
], function (
	emoji,
	utils
) {
	return {
		/**
		 * Get a message ready to be forwarded.
		 *
		 * @param {string} messageId
		 */
		getMessageToForward: function (messageId) {
			var message = $('#chat_message_' + messageId);

			try {
				var output = emoji.htmlToUtf8(utils.escape(message.data('mc')));
			} catch (e) {
			}

			if (!!output === false) {
				return undefined;
			}

			return {
				'message': output,
				'message_id': messageId,
				'sender_id': message.data('s'),
				'recipient_id': message.data('r'),
				'type': message.data('y'),
				'uid': message.data('u'),
				'timestamp': message.data('t')
			};
		},
		/**
		 * Get an array of messages to be forwarded.
		 *
		 * @param {array} messageIds
		 */
		getMessagesToForward: function (messageIds) {
			var messages = [];
			for (var messageId of messageIds) {
				var message = this.getMessageToForward(messageId);

				if (message) {
					messages.push(message);
				}
			}
			return messages;
		}
	};
});
define('features/Message/commands/ForwardMessageToFanSupport',[
	'core/Command',
	'features/Message/utils/ForwardMessage',
	'services/SocketConnection',
	'services/SocketConnectionEvent',
], function(
	Command,
	ForwardMessageUtils,
	SocketConnection,
	SocketConnectionEvent
) {
	var ForwardMessageToFanSupport = function(context) {
		Command.call(this, context);
	};

	ForwardMessageToFanSupport.prototype = Object.create(Command.prototype);

	Object.assign(ForwardMessageToFanSupport.prototype, {
		execute: function (messageId, fanId) {
			var message = ForwardMessageUtils.getMessageToForward(messageId);

			if (!message) {
				return;
			}

			SocketConnection.emit(SocketConnectionEvent.out.FORWARD_MESSAGE_TO_FAN_SUPPORT, {
				"messages": [message],
				"sender_id": fanId
			});
		}
	});

	return ForwardMessageToFanSupport;
});
define('features/Message/commands/MessageAdded',[
	'core/Command',
	'features/Message/events/MessageEvent',
	'libs/EventEmitter',
], function(
	Command,
	MessageEvent,
	EventEmitter
) {
	var MessageAdded = function(context) {
		Command.call(this, context);
	};

	MessageAdded.prototype = Object.create(Command.prototype);

	Object.assign(MessageAdded.prototype, {
		execute: function (message) {
			var m = message.classList.contains('chat-message__id') ? message : message.querySelector('.chat-message__id');

			if (!m) {
				return;
			}

			EventEmitter.emit(MessageEvent.CHECK_FOR_URL_IN_MESSAGE, m);
		}
	});

	return MessageAdded;
});
define('features/Message/commands/MessageUpdated',[
	'core/Command',
	'features/Message/events/MessageEvent',
	'libs/EventEmitter',
], function(
	Command,
	MessageEvent,
	EventEmitter
) {
	var MessageUpdated = function(context) {
		Command.call(this, context);
	};

	MessageUpdated.prototype = Object.create(Command.prototype);

	Object.assign(MessageUpdated.prototype, {
		execute: function (message) {
			var m = message.classList.contains('chat-message__id') ? message : message.querySelector('.chat-message__id');

			if (!m) {
				return;
			}

			EventEmitter.emit(MessageEvent.CHECK_FOR_URL_IN_MESSAGE, m);
		}
	});

	return MessageUpdated;
});

define('text!features/Message/views/ReportFormSuccess.mustache',[],function () { return '<div class="report-success">\n\t<p class="report-success__message">{{message}}</p>\n\t<button class="report-success__close">{{close}}</button>\n</div>';});


define('text!ui/FormField/Input/Checkbox.mustache',[],function () { return '<div class="chat-ui-form-field chat-ui-input chat-ui-input--checkbox">\n    {{#prepend}}<div class="chat-ui-input-group">{{/prepend}}\n    {{#prepend}}\n        <div class="chat-ui-input__prepend">\n            <span>{{prepend}}</span>\n        </div>\n    {{/prepend}}\n    <input type="{{type}}" class="chat-ui-input__checkbox{{#classes}} {{classes}}{{/classes}}"{{#attributes}} {{{attributes}}}{{/attributes}} />\n    {{#label}}<label class="chat-ui-form-field__inline-label"{{labelFor}} for="{{labelFor}}"{{labelFor}}>{{label}}</label>{{/label}}\n    {{#prepend}}</div>{{/prepend}}\n    {{#description}}<p class="chat-ui-form-field__description">{{description}}</p>{{/description}}\n</div>';});

define('ui/FormField/Input/Checkbox',[
    'lib/tools',
    'ui/FormField/Input/Input',
    'text!ui/FormField/Input/Checkbox.mustache'
], function(
    tools,
    Input,
    tplCheckbox
) {
    /**
     * Checkbox form field.
     *
     * @extends Input
     *
     * @constructor
     */
    var Checkbox = function(options) {
        options.type = 'checkbox';
        this.template = tplCheckbox;
        Input.call(this, options);
    };

    Checkbox.prototype = Object.create(Input.prototype);

    Object.assign(Checkbox.prototype, {
        addListeners: function () {
            this.addElementListener(this.getElement().querySelector('input'), 'change', this.onChange, '', this);
        },
        onChange: function() {
            var error = this.getElement().querySelector('.chat-ui-form-field__error-message');
            if (error) {
                error.classList.toggle('is-hidden');
            }
        }
    });

    return Checkbox;
});
define('features/Message/views/ReportFormView',[
	'config/chat',
	'core/View',
	'text!features/Message/views/ReportFormSuccess.mustache',
	'lib/i18n!front',
	'lib/tools',
	'mustache',
	'ui/ActionButton/ActionButton',
	'ui/Form/Form',
	'ui/FormField/Input/Checkbox',
	'ui/FormField/Select/Select',
	'ui/FormField/Textarea/Textarea',
	'ui/Modal/ConfirmModal',
	'ui/Modal/Modal'
], function(
	Config,
	View,
	tplReportFormSuccess,
	i18n,
	Tools,
	Mustache,
	ActionButton,
	Form,
	Checkbox,
	Select,
	Textarea,
	ConfirmModal,
	Modal
) {
	var DEFAULT_FORM_OPTIONS = {
		title: i18n.__('chat.report_message'),
	};

	var REPORT_EXPLANATION_MIN_CHAR_LENGTH = 10,
		REPORT_REASONS = [
			{value: 'spammer', label: i18n.__('report_form.spammer')},
			{value: 'underage', label: i18n.__('report_form.underage')},
			{value: 'child_pornography', label: i18n.__('report_form.child_pornography')},
			{value: 'other', label: i18n.__('report_form.other')}
		],
		REPORT_TYPE = 'FAN_REPORT';

	var ReportFormView = function (message, creatorWebsiteUserId, massMessageId, options) {
		this.templateDisabled = true;
		this.actionCancel = null;
		this.actionReport = null;
		this.dataCreatorWebsiteUserId = creatorWebsiteUserId;
		this.dataMessage = message;
		this.dataMassMessageId = massMessageId;
		this.fieldExplanation = null;
		this.fieldReason = null;
		this.form = null;
		this.formOptions = Object.assign({}, DEFAULT_FORM_OPTIONS, options || {});
		this.formModal = null;

		View.call(this);
	};

	ReportFormView.prototype = Object.create(View.prototype);

	Object.assign(ReportFormView.prototype, {
		addListeners: function () {
			this.addElementListener(this.actionCancel.getElement(), 'click', this.onClickActionCancel, 'report-form', this);
			this.addElementListener(this.actionReport.getElement(), 'click', this.onClickActionReport, 'report-form', this);
		},
		createActionCancel: function () {
			this.actionCancel = new ActionButton('cancel', {
				label: i18n.__('misc.cancel')
			});
			this.form.appendActionButton(this.actionCancel);
		},
		createActionReport: function () {
			this.actionReport = new ActionButton('report', {
				color: ActionButton.THEME_GRADIENT,
				label: i18n.__('report_form.report')
			});
			this.form.appendActionButton(this.actionReport);
		},
		createElement: function () {
			this.createForm();
			this.createFormModal();
			this.element = this.formModal.getElement();
		},
		createFieldExplanation: function () {
			this.fieldExplanation = new Textarea({
				rows: 5,
				label: i18n.__('report_form.details'),
				attributes: {id: 'chat-report-message-form-comment'},
				placeholder: i18n.__('report_form.give_details'),
				withEmoji: false
			});
			this.form.appendField(this.fieldExplanation);
		},
		createFieldRgpd: function() {
			this.fieldRgpd = new Checkbox({
				attributes: {
					id: 'report_info',
					name: 'report_info',
					checked: false,
				},
				label: i18n.__('chat.report_message_info'),
				labelFor: 'report_info'
			});
			this.form.appendField(this.fieldRgpd);
		},
		createFieldReason: function () {
			this.fieldReason = new Select({
				options: this.getReportReasons(),
				label: i18n.__('report_form.reason')
			});
			this.form.appendField(this.fieldReason);
		},
		createForm: function () {
			this.form = new Form(this.formOptions);
			this.createFieldReason();
			this.createFieldExplanation();
			this.createFieldRgpd();
			this.createActionReport();
			this.createActionCancel();
		},
		createFormModal: function () {
			this.formModal = new Modal(this.form.getElement());
		},
		disable: function () {
			this.form.disable();
			this.actionReport.processing();
		},
		enable: function () {
			this.actionReport.processing(false);
			this.form.enable();
		},
		getReportReasons: function () {
			return REPORT_REASONS;
		},
		getValuesForReport: function () {
			return {
				type: REPORT_TYPE,
				creatorWebsiteUserId: this.dataCreatorWebsiteUserId,
				message: this.dataMessage,
				massMessageId: this.dataMassMessageId,
				explanation: `Reason: ${this.fieldReason.getValue()}\r\nDetails: ${this.fieldExplanation.getValue()}`
			};
		},
		onClickActionCancel: function (event) {
			this.formModal.close();
		},
		onClickActionReport: function (event) {
			if (!this.validateForm()) {
				return;
			}

			this.disable();
			this.reportMessage();
		},
		reportMessage: function () {
			this.form.hideError();
			var values = this.getValuesForReport();
			this.mediator.reportMessage(values);
		},
		showReportError: function (data) {
			if (data.field === 'type') {
				this.fieldReason.setError(i18n.__('report_form.invalid_reason'));
			}

			if (data.field === 'explanation') {
				this.fieldExplanation.setError(i18n.__('report_form.enter_reason', {"%nb_chars%": `${REPORT_EXPLANATION_MIN_CHAR_LENGTH}`}));
			}

			if (data.message) {
				this.form.showError(i18n.__(data.message, data.params || {}) + (data.code ? `(${data.code})` : ''));
			}

			this.enable();
		},
		showReportSuccess: function (data) {
			this.formModal.close();
			new ConfirmModal(
				i18n.__('report_form.thanks'),
				{
					dontCloseExistingModal: false,
					popup: {
						ok: i18n.__('misc.close')
					},
					showNoButton: false,
					title: i18n.__('report_form.confirmation_title')
				}
			);
		},
		validateForm: function () {
			var reasonValue = this.fieldReason.getValue();
			if (!reasonValue || !this.validateReason(reasonValue)) {
				this.fieldReason.setError(i18n.__('report_form.invalid_reason'));
				return false;
			} else {
				this.fieldReason.removeError();
			}
			var explanationValue = this.fieldExplanation.getValue();

			if (explanationValue.length < REPORT_EXPLANATION_MIN_CHAR_LENGTH) {
				this.fieldExplanation.setError(i18n.__('report_form.enter_reason', {"%nb_chars%": `${REPORT_EXPLANATION_MIN_CHAR_LENGTH}`}));
				return false;
			} else {
				this.fieldExplanation.removeError();
			}

			var rgpdAgreement = this.fieldRgpd.getElement().querySelector('input').checked;
			if (!rgpdAgreement) {
				this.fieldRgpd.setError(i18n.__('report_form.please_confirm_decrypted'));
				return false;
			}

			return true;
		},
		validateReason: function (reasonValue) {
			var result = false;

			for (var reason of this.getReportReasons()) {
				if (reason.value === reasonValue) {
					result = true;
					break;
				}
			}

			return result;
		}
	});

	return ReportFormView;
});
define('features/Message/commands/OpenReportForm',[
	'core/Command',
	'features/Message/views/ReportFormView'
], function(
	Command,
	ReportFormView,
) {
	var OpenReportFormCommand = function(context) {
		Command.call(this, context);
	};

	OpenReportFormCommand.prototype = Object.create(Command.prototype);

	Object.assign(OpenReportFormCommand.prototype, {
		execute: function (data) {
			new ReportFormView(data.message, data.idUser, data.massMessageId);
		}
	});

	return OpenReportFormCommand;
});
define('features/Message/views/FanReportFormView',[
	'./ReportFormView',
	'core/View',
	'lib/i18n!front',
], function(
	ReportFormView,
	View,
	i18n
) {
	var DEFAULT_FORM_OPTIONS = {
		title: i18n.__('chat.report_message'),
	};

	var REPORT_REASONS = [
			{value: 'copyright', label: i18n.__('report_form.copyright')},
			{value: 'consent', label: i18n.__('report_form.consent')},
			{value: 'stolen', label: i18n.__('report_form.stolen')},
			{value: 'content', label: i18n.__('report_form.content')},
			{value: 'spammer', label: i18n.__('report_form.spammer')},
			{value: 'underage', label: i18n.__('report_form.underage')},
			{value: 'child_pornography', label: i18n.__('report_form.child_pornography')},
			{value: 'other', label: i18n.__('report_form.other')}
		],
		REPORT_TYPE = 'CREATOR_REPORT';

	var FanReportFormView = function (fanWebsiteUserId, reportedMessageId, options) {
		this.templateDisabled = true;
		this.actionCancel = null;
		this.actionReport = null;
		this.dataFanWebsiteUserId = fanWebsiteUserId;
		this.reportedMessageId= reportedMessageId;
		this.fieldExplanation = null;
		this.fieldReason = null;
		this.form = null;
		this.formOptions = Object.assign({}, DEFAULT_FORM_OPTIONS, options || {});
		this.formModal = null;

		View.call(this);
	};

	FanReportFormView.prototype = Object.create(View.prototype);
	Object.assign(FanReportFormView.prototype, ReportFormView.prototype);
	Object.assign(FanReportFormView.prototype, {
		getValuesForReport: function () {
			return {
				type: REPORT_TYPE,
				fanWebsiteUserId: this.dataFanWebsiteUserId,
				reportedMessageId: this.reportedMessageId,
				reason: this.fieldReason.getValue(),
				details: this.fieldExplanation.getValue()
			};
		},
		getReportReasons: function () {
			return REPORT_REASONS;
		},
	});

	return FanReportFormView;
});
define('features/Message/commands/OpenFanReportForm',[
	'core/Command',
	'features/Message/views/FanReportFormView'
], function(
	Command,
	FanReportFormView,
) {
	var OpenFanReportFormCommand = function(context) {
		Command.call(this, context);
	};

	OpenFanReportFormCommand.prototype = Object.create(Command.prototype);

	Object.assign(OpenFanReportFormCommand.prototype, {
		execute: function (data) {
			new FanReportFormView(data.idUser, data.messageId);
		}
	});

	return OpenFanReportFormCommand;
});
define('features/Message/commands/FanReportMessage',[
	'config/chat',
	'core/Command',
	'services/SocketConnection',
	'services/SocketConnectionEvent',
], function(
	Config,
	Command,
	SocketConnection,
	SocketConnectionEvent
) {
	var ReportMessageCommand = function(context, commandMap, mediatorMap) {
		Command.call(this, ...arguments);
	};

	Object.defineProperties(ReportMessageCommand, {
		AUTO_BLOCK: {value: 'AUTO_BLOCK', writable: false},
		AUTO_REPORT: {value: 'AUTO_REPORT', writable: false},
		FAN_REPORT: {value: 'FAN_REPORT', writable: false}
	});

	ReportMessageCommand.prototype = Object.create(Command.prototype);

	Object.assign(ReportMessageCommand.prototype, {
		execute: function (data) {
			SocketConnection.emit(SocketConnectionEvent.out.FAN_REPORT_MESSAGE, data);
		}
	});

	return ReportMessageCommand;
});

define('features/Message/utils/LinkPreview',[
	'chat/scroll_conversation/scroll_conversation',
	'config/chat',
	'lib/tools',
	'lib/utils',
	'mustache',
], function(
	ScrollConversation,
	Config,
	Tools,
	Utils,
	Mustache
) {
	var LINK_PREVIEW_TYPE_BRAND = 'brand';
	var LINK_PREVIEW_TYPE_CREATOR = 'creator';
	var LINK_PREVIEW_TYPE_IMAGE = 'image';
	var LINK_PREVIEW_TYPE_SCENE = 'scene';
	var LINK_PREVIEW_TYPE_VIDEO = 'video';

	LinkPreview = function (url, info, chatFriendManager) {
		this.url = url;
		this.title = info.title;
		this.link = info.link;
		this.thumbnail = info.thumbnail;
		this.type = info.type;
		this.chatFriendManager = chatFriendManager;
	}
	LinkPreview.LINK_PREVIEW_TYPE_SCENE = LINK_PREVIEW_TYPE_SCENE;
	Object.assign(LinkPreview.prototype, {
		elementHasPreviousSibling: function (element, testerCallback) {
			var sibling = element.previousSibling,
				hasPreviousSibling = false;

			while (sibling) {
				if (testerCallback(sibling)) {
					hasPreviousSibling = true;
					break;
				} else if (sibling.nodeType === 1 && sibling.tagName === 'BR') {
					hasPreviousSibling = true;
					break;
				}
				sibling = sibling.previousSibling;
			}

			return hasPreviousSibling;
		},
		generatePlaceholderReplacementNode: function (data) {
			const avatar = this.chatFriendManager.generate_avatar_html({src: data.img.src, modifier: 'big'});
			return Tools.string_to_node(avatar);
		},
		getPreviewHtml: function (placeholderId) {
			return Mustache.render(this.getTemplate(), {
				title: this.title,
				url: this.link,
				placeholderId: placeholderId
			});
		},
		getTemplate: function () {
			return '<div class="chat-preview-link">' +
				'<div class="chat-preview-link__preloader preloader"></div>' +
				'<a class="chat-preview-link__avatar" href="{{url}}" target="_blank"><span id="{{placeholderId}}"></span></a>' +
				'<a class="chat-preview-link__title chat-btn mini" href="{{url}}" target="_blank">{{title}}</a>' +
				'</div>';
		},
        getLinkEscaped: function () {
            return Utils.escapeHtml(this.link);
        },
		hasBrSibling: function (sibling) {
			return sibling.nodeType === 1 && sibling.tagName === 'BR';
		},
		hasTextSibling: function (sibling) {
			return sibling.nodeType === 3 && (sibling.nodeValue || '').trim().length;
		},
		onMediaLoad: function (event, data) {
			var scrollDown2 = ScrollConversation.isDown(data.friendId),
				replacementNode = this.generatePlaceholderReplacementNode(data),
				preloader = data.media.parentNode;

			document.getElementById(data.placeholderId).replaceWith(replacementNode);
			preloader.parentNode.removeChild(preloader);

			if (data.friendId === this.chatFriendManager.selected_friend && (data.scrollDown || scrollDown2) ) {
				ScrollConversation.down(data.friendId);
			}
		},
		replaceInMessage: function (message) {
			var friendId = +message.closest('.chat-tab-container__list').id.replace('chat_group_messages_tab_', ''),
				paragraph = message.querySelector('.chat-message__message');

			this.replaceUrlWithContent(paragraph, friendId, message);

			var previewElements = paragraph.querySelectorAll('.chat-preview-link');

			for (var j = 0; j < previewElements.length; j++) {
				var previewElement = previewElements[j];

				if (previewElement.classList.contains('chat-preview-link--has-previous-br-sibling') ||
					previewElement.classList.contains('chat-preview-link--has-previous-text-sibling')) {
					continue;
				}

				if (this.elementHasPreviousSibling(previewElement, this.hasBrSibling)) {
					previewElement.classList.add('chat-preview-link--has-previous-br-sibling');
				}
				if (this.elementHasPreviousSibling(previewElement, this.hasTextSibling)) {
					previewElement.classList.add('chat-preview-link--has-previous-text-sibling');
				}
			}
		},
		replacePlaceholderWithLink: function (placeholderId) {
			var self = this;
			document.querySelectorAll(`#${placeholderId}`).forEach(function (item) {
				const preview = item.closest('.chat-preview-link');
				const a = document.createElement("a");
				a.href = self.getLinkEscaped();
				a.textContent = self.getLinkEscaped();
				a.setAttribute('target', '_blank');
				preview.replaceWith(a);
			});
		},
		replaceUrlWithContent: function (paragraph, friendId, message) {
			var self = this;

			Tools.replace_text_in_node_recursive(paragraph, this.url, function () {
				var scrollDown = ScrollConversation.isDown(friendId),
					placeholderId = 'id-' + Math.random().toString(32).substring(2),
					img = new Image(),
					preview = Tools.string_to_node(self.getPreviewHtml(placeholderId));

				img.setAttribute('src', self.thumbnail);
				preview.querySelector('.preloader').append(img);
				img.addEventListener(
					'load',
					function (event) {
						self.onMediaLoad(event, {
							friendId: friendId,
							media: img,
							placeholderId: placeholderId,
							message: message,
							scrollDown: scrollDown
						});
					},
				);
				img.addEventListener('error', function (data) {
					wglog.error('LinkPreview.replaceUrlInMessage() image load error', data);
					self.replacePlaceholderWithLink(placeholderId);
				});

				return preview;
			});
		}
	});
	LinkPreview.create = function (url, info, chatFriendManager, vault) {
		switch (info.type) {
			case LINK_PREVIEW_TYPE_BRAND:
			case LINK_PREVIEW_TYPE_CREATOR:
				return new LinkPreview(url, info, chatFriendManager);
			case LINK_PREVIEW_TYPE_IMAGE:
				return new ImageLinkPreview(url, info, chatFriendManager);
			case LINK_PREVIEW_TYPE_VIDEO:
				return new VideoLinkPreview(url, info, chatFriendManager);
			case LINK_PREVIEW_TYPE_SCENE:
				return new SceneLinkPreview(url, info, vault);
		}
	};

	var ImageLinkPreview = function (url, info, chatFriendManager) {
		LinkPreview.call(this, url, info, chatFriendManager);
		this.link = info.link || url;
		this.thumbnail = info.thumbnail || url;
	};
	ImageLinkPreview.prototype = Object.create(LinkPreview.prototype);
	Object.assign(ImageLinkPreview.prototype, {
		generatePlaceholderReplacementNode: function (data) {
			const img = `<img src="${data.media.src}" alt=""/>`;
			return Tools.string_to_node(img);
		},
		getTemplate: function () {
			return '<div class="chat-preview-link">' +
				'<div class="chat-preview-link__preloader preloader"></div>' +
				'<a class="chat-preview-link__thumb" href="{{url}}" target="_blank"><span id="{{placeholderId}}"></span></a>' +
				'</div>';
		}
	});

	var VideoLinkPreview = function (url, info, chatFriendManager) {
		LinkPreview.call(this, url, info, chatFriendManager);
		this.link = info.link || url;
		this.thumbnail = info.thumbnail || url;
	};
	VideoLinkPreview.prototype = Object.create(LinkPreview.prototype);
	Object.assign(VideoLinkPreview.prototype, {
		generatePlaceholderReplacementNode: function (data) {
			const video = `<video controls><source src="${data.media.src}"></video>`;
			return Tools.string_to_node(video);
		},
		getTemplate: function () {
			return '<div class="chat-preview-link">' +
				'<div class="chat-preview-link__preloader preloader"></div>' +
				'<div class="chat-preview-link__thumb"><span id="{{placeholderId}}"></span></div>' +
				'</div>';
		},
		replaceUrlWithContent: function (paragraph, friendId, message) {
			var self = this;

			Tools.replace_text_in_node_recursive(paragraph, this.url, function () {
				var scrollDown = ScrollConversation.isDown(friendId),
					placeholderId = 'id-' + Math.random().toString(32).substring(2),
					video = document.createElement("video"),
					preview = Tools.string_to_node(self.getPreviewHtml(placeholderId));

				video.setAttribute('src', self.url);
				preview.querySelector('.preloader').append(video);
				video.addEventListener(
					'canplay',
					function (event) {
						self.onMediaLoad(event, {
							friendId: friendId,
							media: video,
							placeholderId: placeholderId,
							message: message,
							scrollDown: scrollDown
						});
					},
				);
				video.addEventListener('error', function (data) {
					wglog.error('LinkPreview.replaceUrlInMessage() video load error', data);
					self.replacePlaceholderWithLink(placeholderId);
				});

				return preview;
			});
		}
	});

	var SceneLinkPreview = function (url, info, vault) {
		LinkPreview.call(this, url, info, null);
		this.content = info.content;
		this.vault = vault;
	};
	SceneLinkPreview.prototype = Object.create(LinkPreview.prototype);
	Object.assign(SceneLinkPreview.prototype, {
		generatePlaceholderReplacementNode: function (data) {
			return data.img;
		},
		getTemplate: function () {
			return '<div class="chat-preview-link">' +
				'<div class="chat-preview-link__preloader preloader"></div>' +
				'<a class="chat-preview-link__thumb" href="{{url}}" target="_blank"><span id="{{placeholderId}}"></span></a>' +
				'<a class="chat-preview-link__title chat-btn mini" href="{{url}}" target="_blank">{{title}}</a>' +
				'</div>';
		},
		removeExtraBrSiblings: function (element) {
			var sibling = element.nextSibling;
			var brCount = 0;

			while (sibling) {
				if (sibling.nodeType === 1 && sibling.tagName === 'BR') {
					brCount++;
					if (brCount > 1) {
						brCount++;
						sibling.remove();
					}
				}

				if (brCount === 2) {
					break;
				}

				sibling = sibling.nextSibling;
			}
		},
		replaceInMessage: function (message) {
			if (this.content) {
				this.setupContent(message);
			} else {
				LinkPreview.prototype.replaceInMessage.call(this, message);
			}
		},
		setupContent: function (message) {
			var tempIds = [],
				tempContent = this.vault.getTempContent(),
				messageContainer = message.querySelector('.chat-message__message');

			messageContainer.classList.add('chat-message__message--with-content-link-preview');
			tempIds.push(tempContent.id);
			Tools.replace_text_in_node_recursive(messageContainer, this.url, tempContent.html);

			for (var i = 0; i < tempIds.length; i++) {
				var content = Object.assign({temp_id: tempIds[i]}, this.content),
					wrappedContent = {};
				wrappedContent[content.content_id] = content;
				this.vault.replaceConversationTempContent(wrappedContent);
			}

			var contentElements = messageContainer.querySelectorAll('.chat-content');

			for (var j = 0; j < contentElements.length; j++) {
				var contentElement = contentElements[j];

				if (contentElement.classList.contains('chat-content--has-previous-br-sibling') ||
					contentElement.classList.contains('chat-content--has-previous-text-sibling')) {
					continue;
				}

				this.removeExtraBrSiblings(contentElement);

				if (this.elementHasPreviousSibling(contentElement, this.hasBrSibling)) {
					contentElement.classList.add('chat-content--has-previous-br-sibling');
				}
				if (this.elementHasPreviousSibling(contentElement, this.hasTextSibling)) {
					contentElement.classList.add('chat-content--has-previous-text-sibling');
				}
			}
		}
	});

	return LinkPreview;
});
define('features/Message/commands/ReplaceUrlInMessage',[
	'core/Command',
	'features/Message/utils/LinkPreview',
	'lib/tools',
    'lib/utils'
], function(
	Command,
	LinkPreview,
	Tools,
    Utils
) {
	var MESSAGE_INNER_SELECTOR = '.chat-message__message';

	var ReplaceUrlInMessage = function(context) {
		Command.call(this, context);
	};

	ReplaceUrlInMessage.prototype = Object.create(Command.prototype);

	Object.assign(ReplaceUrlInMessage.prototype, {
		execute: function (response) {
			var data = response.urls,
				urls = Object.keys(data);

			if (!urls.length) {
				return;
			}

			var messageId = response.messageId,
				message = document.getElementById(messageId);

			if (!message) {
				wglog.error('ReplaceUrlInMessage::execute no message', 'No message found for id: ' + messageId);
				return;
			}

			for (var url in data) {
				var info = data[url];

				if (info === false || info.hasOwnProperty('error')) {
					continue;
				}

                var urlEscaped = Utils.escapeHtml(url);

				if (info.type === 'link') {
					Tools.replace_text_in_node_recursive(message.querySelector('.chat-message__message'), url, '<a href="' + (info.link || urlEscaped) + '" target="_blank">' + urlEscaped + '</a>');
					continue;
				}

				var linkPreview = LinkPreview.create(url, info, this.context.chatFriendManager, this.context.manager.vault);

				if (!linkPreview) {
					Tools.replace_text_in_node_recursive(message.querySelector('.chat-message__message'), url, '<a href="' + (info.link || urlEscaped) + '" target="_blank">' + urlEscaped + '</a>');
					continue;
				}

				linkPreview.replaceInMessage(message);
			}

			var event = new CustomEvent('url-in-message-replaced', {
				bubbles: true,
				cancelable: true,
				detail: {
					message: message,
					links: message.querySelectorAll('.chat-message__message a')
				}
			});
			message.dispatchEvent(event);
		},

		generateTrackingUrl: function (url, queryParams) {
			var _url = new URL(url);

			for (var prop in queryParams) {
				if (!queryParams[prop]) {
					continue;
				}

				_url.searchParams.set(prop, queryParams[prop]);
			}

			return _url.toString();
		},

		updateInfoForTracking: function (info, queryParams) {
			if (info.type !== LinkPreview.LINK_PREVIEW_TYPE_SCENE) {
				return;
			}

			info.content.buy_button.url = this.generateTrackingUrl(info.content.buy_button.url, queryParams);
		}
	});

	return ReplaceUrlInMessage;
});
define('features/Message/commands/RequestUrlMetadata',[
	'core/Command',
	'services/SocketConnection',
	'services/SocketConnectionEvent',
], function(
	Command,
	SocketConnection,
	SocketConnectionEvent
) {
	var RequestUrlMetadata = function(context) {
		Command.call(this, context);
	};

	RequestUrlMetadata.prototype = Object.create(Command.prototype);

	Object.assign(RequestUrlMetadata.prototype, {
		execute: function (urls, messageId, friendId, massMessageId, autoMessageId) {
			var params = {
				"friendId": friendId,
				"messageId": messageId,
				"urls": urls
			};
			if (massMessageId) {
				params.massMessageId = massMessageId;
			}
			if (autoMessageId) {
				params.autoMessageId = autoMessageId;
			}
			SocketConnection.emit(SocketConnectionEvent.out.GET_URL_METADATA, params);
		}
	});

	return RequestUrlMetadata;
});
define('features/Message/commands/SendSFWValidation',[
    'config/chat',
    'core/Command',
    'services/SocketConnection',
    'services/SocketConnectionEvent',
], function(
    Config,
    Command,
    SocketConnection,
    SocketConnectionEvent
) {
    var SendSFWValidationCommand = function(context, commandMap, mediatorMap) {
        Command.call(this, ...arguments);
    };

    SendSFWValidationCommand.prototype = Object.create(Command.prototype);

    Object.assign(SendSFWValidationCommand.prototype, {
        execute: function (data) {
            SocketConnection.emit(SocketConnectionEvent.out.SEND_SFW_VALIDATION, data);
        }
    });

    return SendSFWValidationCommand;
});
define('features/Message/commands/SetToSilentPpv',[
	'core/Command',
	'services/SocketConnection',
	'services/SocketConnectionEvent',
], function(
	Command,
	SocketConnection,
	SocketConnectionEvent
) {
	var SetToSilentPpv = function(context) {
		Command.call(this, context);
	};

	SetToSilentPpv.prototype = Object.create(Command.prototype);

	Object.assign(SetToSilentPpv.prototype, {
		execute: function (friendId) {
			var params = {
				"creatorWebsiteUserId": friendId,
			};
			SocketConnection.emit(SocketConnectionEvent.out.SET_TO_SILENT_PPV, params);
		}
	});

	return SetToSilentPpv;
});
define('features/Message/views/FanReportFormMediator',[
	'core/Mediator',
	'features/Message/events/MessageEvent',
	'libs/EventEmitter'
], function(
	Mediator,
	MessageEvent,
	EventEmitter
) {
	var FanReportFormMediator = function (view, context, mediatorMap) {
		Mediator.call(this, view, context, mediatorMap);
	}

	FanReportFormMediator.prototype = Object.create(Mediator.prototype);

	Object.assign(FanReportFormMediator.prototype, {
		reportMessage: function (data) {
			EventEmitter.emit(MessageEvent.FAN_REPORT, data);
		},
		onReportError: function (data) {
			this.view.showReportError(data);
		},
		onReportSuccess: function (data) {
			this.view.showReportSuccess(data);
		}
	});

	return FanReportFormMediator;
});
define('features/Message/views/ReportFormMediator',[
	'core/Mediator',
	'features/Message/events/MessageEvent',
	'libs/EventEmitter'
], function(
	Mediator,
	MessageEvent,
	EventEmitter
) {
	var ReportFormMediator = function (view, context, mediatorMap) {
		Mediator.call(this, view, context, mediatorMap);
	}

	ReportFormMediator.prototype = Object.create(Mediator.prototype);

	Object.assign(ReportFormMediator.prototype, {
		reportMessage: function (data) {
			EventEmitter.emit(MessageEvent.REPORT, data);
		},
		onReportError: function (data) {
			this.view.showReportError(data);
		},
		onReportSuccess: function (data) {
			this.view.showReportSuccess(data);
		}
	});

	return ReportFormMediator;
});
define('features/Message/views/SFWFormMediator',[
    'core/Mediator',
    'features/Message/events/MessageEvent',
    'libs/EventEmitter'
], function(
    Mediator,
    MessageEvent,
    EventEmitter
) {
    var SFWFormMediator = function (view, context, mediatorMap) {
        Mediator.call(this, view, context, mediatorMap);
    }

    SFWFormMediator.prototype = Object.create(Mediator.prototype);

    Object.assign(SFWFormMediator.prototype, {
        onValidationError: function (data) {
            if (!data.viewId || data.viewId !== this.view.id) {
                return;
            }

            this.view.showValidationError(data);
        },
        onValidationSuccess: function (data) {
            if (!data.viewId || data.viewId !== this.view.id) {
                return;
            }

            this.view.showValidationSuccess(data);
        },
        sendSFWValidation: function (data) {
            EventEmitter.emit(MessageEvent.SEND_SFW_VALIDATION, data);
        }
    });

    return SFWFormMediator;
});
define('ui/FormField/Paragraph',[
    'lib/tools',
    'ui/FormField/Field'
], function(
    tools,
    Field
) {
    /**
     * Paragraph form field.
     *
     * @extends Field
     *
     * @constructor
     */
    var Paragraph = function(text) {
        this.text = text;
        this.template = '<p class="chat-ui-form-field-paragraph">{{{content}}}</p>';
        Field.call(this);
    };

    Paragraph.prototype = Object.create(Field.prototype);

    Object.assign(Paragraph.prototype, {
        getField: function () {
            var paragraph = this.element.querySelector('p');

            if (!paragraph) {
                throw new Error('Paragraph not found');
            }

            return paragraph;
        },
        getForcedTemplateParams: function () {
            return {content: this.text};
        },
        getValue: function () {
        },
        removeError: function () {
        },
        setError: function (message) {
        },
        setValue: function (text) {
            this.getField().innerHTML = text;
        }
    });

    return Paragraph;
});
define('features/Message/views/SFWFormView',[
    'config/chat',
    'core/View',
    'lib/i18n!front',
    'lib/tools',
    'mustache',
    'ui/ActionButton/ActionButton',
    'ui/ButtonGroup/ButtonGroup',
    'ui/Form/Form',
    'ui/FormField/Paragraph',
], function(
    Config,
    View,
    i18n,
    Tools,
    Mustache,
    ActionButton,
    ButtonGroup,
    Form,
    Paragraph
) {

    var SUCCESS_MESSAGE_CLASS_NAME = 'chat-message-sfw-form__validation-success';

    var SFWFormView = function (message, sfwValue, isSupport) {
        this.id = 'id-' + Math.random().toString(32).substring(2);
        this.templateDisabled = true;
        this.message = message;
        this.dataSfwValue = sfwValue;
        this.isSupport = isSupport;
        this.actionNSFW = null;
        this.actionSFW = null;
        this.form = null;
        this.formOptions = {};
        this.formModal = null;

        View.call(this);
    };

    SFWFormView.prototype = Object.create(View.prototype);

    Object.assign(SFWFormView.prototype, {
        addListeners: function () {
            if (!this.isSupport) {
                return;
            }

            this.addElementListener(this.actionNSFW.getElement(), 'click', this.onClickActionNSFW, 'sfw-form', this);
            this.addElementListener(this.actionSFW.getElement(), 'click', this.onClickActionSFW, 'sfw-form', this);
        },
        createActionNSFW: function () {
            this.actionNSFW = new ActionButton('no', {
                color: ActionButton.THEME_TRANSPARENT_PINK,
                label: ' NSFW'
            });
        },
        createActionSFW: function () {
            this.actionSFW = new ActionButton('yes', {
                color: ActionButton.THEME_TRANSPARENT_GREEN,
                label: ' SFW'
            });
        },
        createActionsGroup: function () {
            const group = new ButtonGroup(this.getActionsElementsArray());
            this.form.appendActionButtonGroup(group);
        },
        createResult: function () {
            let resultString = '';

            if (typeof this.dataSfwValue === 'boolean') {
                const answer = this.dataSfwValue ? 'SFW' : 'NSFW';
                resultString = i18n.__('chat.sfw_content_validation.answer', {'%answer%': `<b>${answer}</b>`}, "Manager's answer is: %answer%");
            } else {
                resultString = i18n.__('chat.sfw_content_validation.waiting', {}, "Waiting for manager's validation");
            }
            const result = new Paragraph('<i>' + resultString + '</i>');
            this.form.appendField(result);
        },
        createElement: function () {
            this.createForm();

            if (this.isSupport) {
                this.toggleActions();
            }
        },
        createForm: function () {
            this.form = new Form(this.formOptions);
            this.form.getElement().classList.add('chat-message-sfw-form');
            if (this.isSupport) {
                this.createActionSFW();
                this.createActionNSFW();
                this.createActionsGroup();
            } else {
                this.createResult();
                this.getActionsElement().remove();
            }
            this.element = this.form.getElement();
        },
        disable: function () {
            this.form.disable();
        },
        enable: function () {
            this.form.enable();
        },
        getActionsElement: function () {
            return this.form.getElement().querySelector('.chat-ui-form__actions');
        },
        getActionsElementsArray: function () {
            return [this.actionSFW.getElement(), this.actionNSFW.getElement()];
        },
        onClickActionNSFW: function (event) {
            this.sendSfwValue(false);
        },
        onClickActionSFW: function (event) {
            this.sendSfwValue(true);
        },
        removeSuccessMessage: function () {
            const existent = this.form.getElement().querySelector(`.${SUCCESS_MESSAGE_CLASS_NAME}`);

            if (existent) {
                existent.remove();
            }
        },
        sendSfwValue: function (value) {
            this.removeSuccessMessage();
            this.disable();
            this.toggleActions(value);

            const message = this.message.find('.chat-message__id');
            const data = {
                viewId: this.id,
                content_id: message.data('sfwcid'),
                creator_id: message.data('s'),
                message: message.data('m'),
                message_id: message.data('id'),
                sfw_value: +value,
            };
            this.mediator.sendSFWValidation(data);
        },
        showSuccessMessage: function () {
            const paragraph = document.createElement('p');
            paragraph.classList.add('chat-ui-form-field-paragraph', SUCCESS_MESSAGE_CLASS_NAME);
            paragraph.textContent = i18n.__('chat.sfw_content_validation.success', {}, 'Validation saved!');
            this.getActionsElement().before(paragraph);
        },
        showValidationError: function (data) {
            if (data.message) {
                this.form.showError(i18n.__(data.message, data.params || {}) + (data.code ? `(${data.code})` : ''));
            }

            this.enable();
        },
        showValidationSuccess: function (data) {
            this.enable();
            this.showSuccessMessage();
        },
        toggleActions: function (value) {
            const _value = typeof value === 'boolean' ? value : this.dataSfwValue;

            if (_value === undefined || _value === null) {
                return;
            }

            if (_value) {
                this.actionNSFW.setState(null);
                this.actionSFW.setState(ActionButton.STATE_ACTIVE);
            } else {
                this.actionNSFW.setState(ActionButton.STATE_ACTIVE);
                this.actionSFW.setState(null);
            }
        }
    });

    return SFWFormView;
});
define('features/Message/MessageMapper',[
	'chat/ManagerEvent',
	'features/Message/commands/CheckForUrlInMessage',
	'features/Message/commands/ForwardMessageToFanSupport',
	'features/Message/commands/MessageAdded',
	'features/Message/commands/MessageUpdated',
	'features/Message/commands/OpenReportForm',
	'features/Message/commands/OpenFanReportForm',
	'features/Message/commands/ReportMessage',
	'features/Message/commands/FanReportMessage',
	'features/Message/commands/ReplaceUrlInMessage',
	'features/Message/commands/RequestUrlMetadata',
	'features/Message/commands/SendSFWValidation',
	'features/Message/commands/SetToSilentPpv',
	'features/Message/events/MessageEvent',
	'features/Message/views/FanReportFormMediator',
	'features/Message/views/FanReportFormView',
	'features/Message/views/ReportFormMediator',
	'features/Message/views/ReportFormView',
	'features/Message/views/SFWFormMediator',
	'features/Message/views/SFWFormView',
	'services/SocketConnection',
	'services/SocketConnectionEvent'
], function(
	ManagerEvent,
	CheckForUrlInMessageCommand,
	ForwardMessageToFanSupportCommand,
	MessageAddedCommand,
	MessageUpdatedCommand,
	OpenReportFormCommand,
	OpenFanReportFormCommand,
	ReportMessageCommand,
	FanReportMessageCommand,
	ReplaceUrlInMessageCommand,
	RequestUrlMetadataCommand,
	SendSFWValidationCommand,
	SetToSilentPpvCommand,
	MessageEvent,
	FanReportFormMediator,
	FanReportFormView,
	ReportFormMediator,
	ReportFormView,
	SFWFormMediator,
	SFWFormView,
	SocketConnection,
	SocketConnectionEvent
) {
	return function(context) {
		context.commandMap.mapEvent(ManagerEvent.MESSAGE_ADDED, MessageAddedCommand);
		context.commandMap.mapEvent(ManagerEvent.MESSAGE_UPDATED, MessageUpdatedCommand);

		context.commandMap.mapEvent(MessageEvent.REPORT_OPEN_FORM, OpenReportFormCommand);
		context.commandMap.mapEvent(MessageEvent.FAN_REPORT_OPEN_FORM, OpenFanReportFormCommand);
		context.commandMap.mapEvent(MessageEvent.REPORT, ReportMessageCommand);
		context.commandMap.mapEvent(MessageEvent.FAN_REPORT, FanReportMessageCommand);
		context.commandMap.mapEvent(MessageEvent.CHECK_FOR_URL_IN_MESSAGE, CheckForUrlInMessageCommand);
		context.commandMap.mapEvent(MessageEvent.FORWARD_MESSAGE_TO_FAN_SUPPORT, ForwardMessageToFanSupportCommand);
		context.commandMap.mapEvent(MessageEvent.REPLACE_URL_IN_MESSAGE, ReplaceUrlInMessageCommand);
		context.commandMap.mapEvent(MessageEvent.REQUEST_URL_METADATA, RequestUrlMetadataCommand);
		context.commandMap.mapEvent(MessageEvent.SEND_SFW_VALIDATION, SendSFWValidationCommand);
		context.commandMap.mapEvent(MessageEvent.SILENT_PPV, SetToSilentPpvCommand);

		context.mediatorMap.mapEvent(MessageEvent.MESSAGE_REPORTED, ReportFormMediator, 'onReportSuccess');
		context.mediatorMap.mapEvent(MessageEvent.FAN_MESSAGE_REPORTED, FanReportFormMediator, 'onReportSuccess');
		context.mediatorMap.mapEvent(MessageEvent.REPORT_ERROR, ReportFormMediator, 'onReportError');
		context.mediatorMap.mapEvent(MessageEvent.FAN_REPORT_ERROR, FanReportFormMediator, 'onReportError');
		context.mediatorMap.mapEvent(MessageEvent.SEND_SFW_VALIDATION_ERROR, SFWFormMediator, 'onValidationError');
		context.mediatorMap.mapEvent(MessageEvent.SFW_VALIDATION_SENT, SFWFormMediator, 'onValidationSuccess');

		context.mediatorMap.mapView(ReportFormView, ReportFormMediator);
		context.mediatorMap.mapView(FanReportFormView, FanReportFormMediator);
		context.mediatorMap.mapView(SFWFormView, SFWFormMediator);

		SocketConnection.forwardIncomingEvent(SocketConnectionEvent.in.MESSAGE_REPORTED, MessageEvent.MESSAGE_REPORTED);
		SocketConnection.forwardIncomingEvent(SocketConnectionEvent.in.FAN_MESSAGE_REPORTED, MessageEvent.FAN_MESSAGE_REPORTED);
		SocketConnection.forwardIncomingEvent(SocketConnectionEvent.in.REPORT_MESSAGE_ERROR, MessageEvent.REPORT_ERROR);
		SocketConnection.forwardIncomingEvent(SocketConnectionEvent.in.FAN_REPORT_MESSAGE_ERROR, MessageEvent.FAN_REPORT_ERROR);
		SocketConnection.forwardIncomingEvent(SocketConnectionEvent.in.URL_METADATA, MessageEvent.REPLACE_URL_IN_MESSAGE);
		SocketConnection.forwardIncomingEvent(SocketConnectionEvent.in.SEND_SFW_VALIDATION_ERROR, MessageEvent.SEND_SFW_VALIDATION_ERROR);
		SocketConnection.forwardIncomingEvent(SocketConnectionEvent.in.SFW_VALIDATION_SENT, MessageEvent.SFW_VALIDATION_SENT);
	};
});
define('features/PageSession/commands/KeepSessionAlive',[
	'core/Command'
], function(
	Command,
) {
	var REFRESH_INTERVAL = 30 * 60 * 1000, // 30min
		REFRESH_URL = '/chat/keep-alive';

	var KeepSessionAlive = function(context) {
		Command.call(this, context);
	};

	KeepSessionAlive.prototype = Object.create(Command.prototype);

	Object.assign(KeepSessionAlive.prototype, {
		execute: function () {
			setInterval(function() {
				fetch(REFRESH_URL, {method: 'GET', credentials: 'include'})
					.then(function (response) {
						if (response.status !== 200) {
							wglog.error('KeepSessionAlive error', 'Response not ok', response);
							return;
						}

						wglog.debug('KeepSessionAlive', 'Website session lifetime extended');
					})
					.catch(function (error) {
						wglog.error('KeepSessionAlive fetch error', 'Request to server failed', error);
					});
			}, REFRESH_INTERVAL);
		}
	});

	return KeepSessionAlive;
});
define('features/PageSession/PageSessionMapper',[
	'features/PageSession/commands/KeepSessionAlive',
	'core/ContextEvent'
], function(
	KeepSessionAliveCommand,
	ContextEvent
) {
	return function(context) {
		context.commandMap.mapEvent(ContextEvent.STARTUP, KeepSessionAliveCommand);
	};
});

define('text!features/Reminder/views/Reminder.mustache',[],function () { return '<div class="chat-message-header-banner chat-message-header__reminder chat-reminder {{#reminder}}is-{{reminder.status}}{{/reminder}}">\n\t<div class="chat-reminder-wrapper">\n\t\t<div class="chat-reminder-content">\n\t\t\t<p class="chat-reminder-desc"><span class="icon-f icf-bell"></span> <strong class="{{remainingTimeClass}}">{{reminder.relative_remind_at}}</strong>{{#reminder.reminder_description}} - {{reminder.reminder_description}}{{/reminder.reminder_description}}</p>\n\t\t</div>\n\t\t<div class="chat-reminder-loader">\n\t\t\t<svg class="chat-scc chat-scc--spin"><use xlink:href="#scc-message-loader-icon-2" /></svg>\n\t\t</div>\n\t\t<div class="chat-reminder-controls">\n\t\t\t<button type="button" class="chat-reminder-btn" id="{{editButtonId}}" title="{{label.edit}}"><svg class="chat-scc"><use xlink:href="#scc-edit-message"></use></svg></button>\n\t\t\t<button type="button" class="chat-reminder-btn" id="{{dismissButtonId}}" title="{{label.dismiss}}"><span class="icon-f icf-bin"></span></button>\n\t\t</div>\n\t</div>\n</div>';});

define('features/Reminder/views/ReminderView',[
	'core/View',
	'text!features/Reminder/views/Reminder.mustache',
	'lib/i18n!front',
	'lib/tools',
], function(
	View,
	tplReminder,
	i18n,
	tools
) {
	var DISMISS_BUTTON_ID = 'reminder-dismiss',
		DISMISS_BUTTON_SELECTOR = '#' + DISMISS_BUTTON_ID,
		EDIT_BUTTON_ID = 'reminder-edit',
		EDIT_BUTTON_SELECTOR = '#' + EDIT_BUTTON_ID,
		REMAINING_TIME_CLASS_NAME = 'chat-reminder__remaining-time',
		REMAINING_TIME_SELECTOR = '.' + REMAINING_TIME_CLASS_NAME,
		CONTROLS_CLASS_NAME = 'chat-reminder-controls',
		CONTROLS_SELECTOR = '.' + CONTROLS_CLASS_NAME,
		LOADER_CLASS_NAME = 'chat-reminder-loader',
		LOADER_SELECTOR = '.' + LOADER_CLASS_NAME;

	var STATE_RINGING = 'ringing',
		STATE_WAITING = 'waiting';

	var ONE_DAY_IN_MILLISECONDS = 24 * 60 * 60 * 1000;

	var DEFAULT_OPTIONS = {};

	var ReminderView = function(parent, reminder, options) {
		this.parent = parent;
		this.reminder = reminder;
		this.options = Object.assign({}, DEFAULT_OPTIONS, options);
		this.template = tplReminder;
		this.controlsDisplayed = true;
		View.call(this);
	};

	ReminderView.prototype = Object.create(View.prototype);

	Object.assign(ReminderView.prototype, {
		addListeners: function () {
			this.addElementListener(DISMISS_BUTTON_SELECTOR, 'click', this.onClickDismiss, 'reminder', this);
			this.addElementListener(EDIT_BUTTON_SELECTOR, 'click', this.onClickEdit, 'reminder', this);
		},
		createElement: function () {
			View.prototype.createElement.call(this);
			this.parent.append(this.element);
			this.setupRemainingTimeRefresh();
		},
		getForcedTemplateParams: function () {
			var now = new Date().getTime(),
				remind_timestamp = new Date(this.reminder.remind_at).getTime(),
				params = {
					reminder: this.reminder,
					dismissButtonId: DISMISS_BUTTON_ID,
					editButtonId: EDIT_BUTTON_ID,
					remainingTimeClass: REMAINING_TIME_CLASS_NAME,
					label: {
						dismiss: i18n.__('misc.actions.remove'),
						edit: i18n.__('misc.actions.edit')
					}
				};

			params.reminder.relative_remind_at = tools.format_timestamp_relative(remind_timestamp, true);
			params.reminder.status = remind_timestamp > now ? STATE_WAITING : STATE_RINGING;

			return params;
		},
		hideControls: function () {
			this.getElement().querySelector(CONTROLS_SELECTOR).style.display = 'none';
			this.controlsDisplayed = false;
		},
		hideLoader: function () {
			this.getElement().querySelector(LOADER_SELECTOR).removeAttribute('style');
		},
		onClickDismiss: function (event) {
			this.toggleControls();
			this.mediator.emitDismissReminder(this.reminder);
		},
		onClickEdit: function (event) {
			this.mediator.emitEditReminder(this.reminder);
		},
		remainingTimeIntervalHandler: function() {
			var now = Date.now(),
				remindAt = new Date(this.reminder.remind_at).getTime();

			if (now >= remindAt) {
				this.stopRemainingTimeRefresh();
				this.mediator.emitReminderRinging(this.reminder);
			} else {
				this.getElement().querySelector(REMAINING_TIME_SELECTOR).innerText = tools.format_timestamp_relative(remindAt, true);
			}
		},
		remove: function (reminderData) {
			if (!reminderData || !reminderData.target_id || reminderData.target_id !== this.reminder.target_id) {
				return;
			}

			View.prototype.remove.call(this);
		},
		setupRemainingTimeRefresh: function() {
			var now = Date.now(),
				remindAt = new Date(this.reminder.remind_at).getTime(),
				isTimeoutAvailable = remindAt > now && remindAt < (now + ONE_DAY_IN_MILLISECONDS);

			if (isTimeoutAvailable) {
				this.remainingTimeInterval = setInterval(this.remainingTimeIntervalHandler.bind(this), 1000);
			}
		},
		showControls: function () {
			this.getElement().querySelector(CONTROLS_SELECTOR).removeAttribute('style');
			this.controlsDisplayed = true;
		},
		showLoader: function () {
			this.getElement().querySelector(LOADER_SELECTOR).style.display = 'block';
		},
		stopRemainingTimeRefresh: function() {
			if (this.remainingTimeInterval === null) {
				return;
			}
			clearInterval(this.remainingTimeInterval);
			this.remainingTimeInterval = null;
		},
		toggleControls: function () {
			if (this.controlsDisplayed) {
				this.hideControls();
				this.showLoader();
			} else {
				this.hideLoader();
				this.showControls();
			}
		}
	});

	return ReminderView;
});
define('features/Reminder/commands/DisplayReminderInMessageHeader',[
	'core/Command',
	'features/Reminder/models/ReminderModel',
	'features/Reminder/views/ReminderView',
], function(
	Command,
	ReminderModel,
	ReminderView
) {
	var DisplayReminderInMessageHeader = function(context) {
		Command.call(this, context);
	};

	DisplayReminderInMessageHeader.prototype = Object.create(Command.prototype);

	Object.assign(DisplayReminderInMessageHeader.prototype, {
		execute: function (messageHeader, userId) {
			if (!messageHeader || !(messageHeader instanceof HTMLElement)) {
				throw new TypeError('messageHeader is not an HTML element');
			}

			if (typeof userId !== 'number') {
				throw new TypeError('userId is not a number');
			}

			var reminder = ReminderModel.get(userId);

			if (!reminder) {
				return;
			}

			new ReminderView(messageHeader, reminder);
		}
	});

	return DisplayReminderInMessageHeader;
});
define('features/Reminder/commands/DismissReminder',[
	'core/Command',
	'services/SocketConnection',
	'services/SocketConnectionEvent'
], function(
	Command,
	SocketConnection,
	SocketConnectionEvent
) {
	var DismissReminder = function(context) {
		Command.call(this, context);
	};

	DismissReminder.prototype = Object.create(Command.prototype);

	Object.assign(DismissReminder.prototype, {
		execute: function (reminder) {
			if (!reminder || !reminder.reminder_id) {
				return;
			}

			SocketConnection.emit(SocketConnectionEvent.out.DISMISS_REMINDER, {reminder_id: reminder.reminder_id});
		}
	});

	return DismissReminder;
});
define('features/Reminder/events/ReminderEvent',[], function () {
	var ReminderEvent = Object.create(null);

	Object.defineProperties(ReminderEvent, {
		ACTIVE_REMINDERS_RECEIVED: {value: 'active_reminders_received.reminder', writable: false},
		CONTEXT_MENU_OPEN_FORM: {value: 'context_menu_open_form.reminder', writable: false},
		CONTEXT_MENU_DISMISS: {value: 'context_menu_dismiss.reminder', writable: false},
		DISMISS: {value: 'dismiss.reminder', writable: false},
		DISMISSED: {value: 'dismissed.reminder', writable: false},
		GET_ACTIVE_REMINDERS: {value: 'get_active_reminders.reminder', writable: false},
        GET_CONTACTS_WITH_REMINDERS: {value: 'get_contacts_with_reminders.reminder', writable: false},
		GET_INIT_DATA: {value: 'get_init_data.reminder', writable: false},
		GET_REMINDER_HISTORY: {value: 'get_reminder_history.reminder', writable: false},
		HISTORY_RECEIVED: {value: 'history_received.reminder', writable: false},
		INIT_DATA_RECEIVED: {value: 'init_data_received.reminder', writable: false},
		OPEN_FORM: {value: 'open_form.reminder', writable: false},
		RINGING: {value: 'ringing.reminder', writable: false},
		SAVE: {value: 'save.reminder', writable: false},
		SAVED: {value: 'saved.reminder', writable: false},
		UPDATE_FRIEND_DISPLAY: {value: 'update_friend_display.reminder', writable: false},
		UPDATE_FRIEND_CONTEXT_MENU: {value: 'update_friend_context_menu.reminder', writable: false}
	});

	return ReminderEvent;
});
define('features/Reminder/commands/DismissReminderByFriendId',[
	'core/Command',
	'features/Reminder/events/ReminderEvent',
	'features/Reminder/models/ReminderModel'
], function(
	Command,
	ReminderEvent,
	ReminderModel
) {
	var DismissReminderByFriendId = function(context) {
		Command.call(this, context);
	};

	DismissReminderByFriendId.prototype = Object.create(Command.prototype);

	Object.assign(DismissReminderByFriendId.prototype, {
		execute: function (friendId) {
			if (typeof friendId !== 'number' || !friendId) {
				return;
			}

			var reminder = ReminderModel.get(friendId);

			if (!reminder) {
				return;
			}

			this.context.emit(ReminderEvent.DISMISS, reminder);
		}
	});

	return DismissReminderByFriendId;
});
define('features/Reminder/commands/FriendCreated',[
	'core/Command',
	'features/Reminder/events/ReminderEvent',
	'features/Reminder/models/ReminderModel',
], function(
	Command,
	ReminderEvent,
	ReminderModel
) {
	var FriendCreated = function(context) {
		Command.call(this, context);
	};

	FriendCreated.prototype = Object.create(Command.prototype);

	Object.assign(FriendCreated.prototype, {
		execute: function (friendElement, friendInfo) {
			var reminder = ReminderModel.get(friendInfo.id_user);

			this.context.emit(ReminderEvent.UPDATE_FRIEND_CONTEXT_MENU, friendElement, friendInfo);
			this.context.emit(ReminderEvent.UPDATE_FRIEND_DISPLAY, friendInfo.id_user, reminder);
		}
	});

	return FriendCreated;
});
define('features/Reminder/commands/FriendUpdated',[
	'features/Reminder/commands/FriendCreated'
], function(
	FriendCreated
) {
	var FriendUpdated = function(context) {
		FriendCreated.call(this, context);
	};

	FriendUpdated.prototype = Object.create(FriendCreated.prototype);

	return FriendUpdated;
});
define('features/Reminder/commands/GetActiveReminders',[
	'core/Command',
	'services/SocketConnection',
	'services/SocketConnectionEvent',
], function(
	Command,
	SocketConnection,
	SocketConnectionEvent
) {
	var GetActiveReminders = function(context) {
		Command.call(this, context);
	};

	GetActiveReminders.prototype = Object.create(Command.prototype);

	Object.assign(GetActiveReminders.prototype, {
		execute: function (args) {
			SocketConnection.emit(SocketConnectionEvent.out.GET_ALL_ACTIVE_REMINDERS, args);
		}
	});

	return GetActiveReminders;
});
define('features/Reminder/commands/GetReminderHistory',[
	'core/Command',
	'services/SocketConnection',
	'services/SocketConnectionEvent',
], function(
	Command,
	SocketConnection,
	SocketConnectionEvent
) {
	var GetHistory = function(context) {
		Command.call(this, context);
	};

	GetHistory.prototype = Object.create(Command.prototype);

	Object.assign(GetHistory.prototype, {
		execute: function (page, targetId) {
			var data = {};

			if (typeof page === 'number') {
				data.page = page;
			}
			if (typeof targetId === 'number') {
				data.targetId = targetId;
			}

			SocketConnection.emit(SocketConnectionEvent.out.GET_REMINDER_HISTORY, data);
		}
	});

	return GetHistory;
});
define('features/Reminder/commands/GetInitData',[
	'core/Command',
	'services/SocketConnection',
	'services/SocketConnectionEvent',
], function(
	Command,
	SocketConnection,
	SocketConnectionEvent
) {
	var GetInitData = function(context) {
		Command.call(this, context);
	};

	GetInitData.prototype = Object.create(Command.prototype);

	Object.assign(GetInitData.prototype, {
		execute: function (args) {
			SocketConnection.emit(SocketConnectionEvent.out.GET_REMINDER_INIT_DATA, args);
		}
	});

	return GetInitData;
});
define('features/Reminder/models/ReminderHistoryModel',[
	'core/ModelObject',
	'features/Reminder/models/ReminderModel',
], function (
	ModelObject,
	ReminderModel
) {
	/**
	 * @extends ModelObject
	 * @constructor
	 */
	var ReminderHistoryModel = function () {
		this.storageKey = 'reminder-history';
		ModelObject.call(this);
	};

	ReminderHistoryModel.prototype = Object.create(ModelObject.prototype);

	Object.assign(ReminderHistoryModel.prototype, {
		save: function (reminder) {
			this.set(reminder, reminder.target_id);
		},
		validate: function (reminder) {
			return ReminderModel.validate(reminder);
		}
	});

	return new ReminderHistoryModel();
});
define('features/Reminder/commands/HistoryReceived',[
	'core/Command',
	'features/Reminder/events/ReminderEvent',
	'features/Reminder/models/ReminderHistoryModel'
], function(
	Command,
	ReminderEvent,
	ReminderHistoryModel
) {
	var HistoryReceived = function(context) {
		Command.call(this, context);
	};

	HistoryReceived.prototype = Object.create(Command.prototype);

	Object.assign(HistoryReceived.prototype, {
		execute: function (historyData) {
			this.registerOldReminders(historyData.data);
		},
		registerOldReminders: function (reminders) {
			for (var reminder of reminders) {
				ReminderHistoryModel.save(reminder);
			}
		},
		requestNextPage: function (lastPage, currentPage, targetId) {
			var _currentPage = currentPage || 1;

			if (currentPage === lastPage) {
				return;
			}

			this.context.emit(ReminderEvent.GET_REMINDER_HISTORY, _currentPage + 1, targetId);
		},
	});

	return HistoryReceived;
});
define('features/Reminder/commands/InitDataReceived',[
	'core/Command',
	'features/Reminder/events/ReminderEvent'
], function(
	Command,
	ReminderEvent
) {
	var InitDataReceived = function(context) {
		Command.call(this, context);
	};

	InitDataReceived.prototype = Object.create(Command.prototype);

	Object.assign(InitDataReceived.prototype, {
		execute: function (initData) {
			this.context.emit(ReminderEvent.ACTIVE_REMINDERS_RECEIVED, initData.activeReminders);
			this.context.emit(ReminderEvent.HISTORY_RECEIVED, initData.history);
		}
	});

	return InitDataReceived;
});
define('features/Reminder/views/ReminderFormView',[
	'core/View',
	'lib/i18n!front',
	'lib/tools',
	'ui/ActionButton/ActionButton',
	'ui/Form/Form',
	'ui/FormField/Input/Input',
	'ui/FormField/Textarea/Textarea'
], function(
	View,
	i18n,
	tools,
	ActionButton,
	Form,
	Input,
	Textarea
) {
	var ReminderFormView = function(userId, reminder, formOptions) {
		this.templateDisabled = true;
		this.form = null;
		this.modal = null;
		this.userId = userId;
		this.reminder = reminder;
		this.formOptions = formOptions;

		View.call(this);
	};

	ReminderFormView.prototype = Object.create(View.prototype);

	Object.assign(ReminderFormView.prototype, {
		addListeners: function () {
			this.addElementListener(this.cancel.getElement(), 'click', this.onClickCancel, 'reminder-modal', this);
			this.addElementListener(this.save.getElement(), 'click', this.onClickSave, 'reminder-modal', this);
		},
		close: function () {
			if (this.modal) {
				this.modal.close();
			}
		},
		createActionCancel: function() {
			this.cancel = new ActionButton('cancel', {
				label: i18n.__('misc.cancel')
			});
			return this.cancel;
		},
		createActionSave: function() {
			this.save = new ActionButton('save', {
				disabledLabel: i18n.__('chat.error.please_wait'),
				label: i18n.__(this.reminder ? 'misc.actions.edit' : 'misc.actions.add'),
				color: ActionButton.THEME_GRADIENT
			});
			return this.save;
		},
		createElement: function () {
			this.createForm();
			this.element = this.form.getElement();
		},
		createFieldAtDate: function () {
			var at_min = (new Date()).toDatetimeString();

			this.at = new Input({
				type: 'datetime-local',
				attributes: {
					required: true,
					name: 'reminder_date',
					min: at_min,
					value: this.reminder ? this.reminder.remind_at : at_min
				},
				label: i18n.__('misc.date')
			});

			return this.at;
		},
		createFieldDescription: function () {
			this.description = new Textarea({
				rows: 5,
				attributes: {
					required: true,
					placeholder: i18n.__('chat.reminder_description_placeholder'),
					name: 'reminder_description',
				},
				withEmoji: false,
				label: i18n.__('misc.description')
			});

			return this.description;
		},
		createForm: function () {
			this.form = new Form(this.formOptions);

			this.form.appendField(this.createFieldAtDate());
			this.form.appendField(this.createFieldDescription());
			this.form.appendActionButton(this.createActionSave());
			this.form.appendActionButton(this.createActionCancel());

			this.description.setValue(this.reminder ? this.reminder.reminder_description : '');
		},
		getModalPageMeta: function () {
			return {
				shortTitle: i18n.__(this.reminder ? 'misc.actions.edit' : 'misc.actions.add'),
				title: i18n.__(this.reminder ? 'chat.menu.edit_reminder' : 'chat.menu.add_reminder'),
			};
		},
		onClickCancel: function (event) {
			this.close();
		},
		onClickSave: function (event) {
			var formData = new FormData(this.form.getFormElement()),
				values = Object.fromEntries(formData);

			if (typeof values.reminder_date !== "string" || !values.reminder_date.match(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}$/)) {
				this.at.setError(i18n.__('chat.vault.invalid_value'));
				return;
			}

			if (typeof values.reminder_description !== "string") {
				this.description.setError(i18n.__('chat.vault.invalid_value'));
				return;
			}

			values.website_user_target_id = this.userId;
			values.reminder_date = values.reminder_date.replace('T', ' ');

			if (this.reminder && this.reminder.reminder_id) {
				values.reminder_id = this.reminder.reminder_id;
			}

			this.form.disable();
			this.mediator.saveReminder(values);
		}
	});

	return ReminderFormView;
});

define('text!features/Reminder/views/ReminderHistory.mustache',[],function () { return '<ul class="{{className}}">\n{{#reminders}}\n\t<li class="{{className}}__item">\n\t\t{{#reminder_description}}\n\t\t\t<div class="{{className}}__title">{{reminder_description}}</div>\n\t\t{{/reminder_description}}\n\t\t<div class="{{className}}__body">\n\t\t\tCreated on: {{created}}<br>\n\t\t\tReminder on: {{remind_at}}<br>\n\t\t\tDismissed on: {{dismiss_at}}<br>\n\t\t\tStatus: {{status}}\n\t\t</div>\n\t</li>\n{{/reminders}}\n{{#loading}}\n\t<li class="{{className}}__item {{className}}__item--message {{className}}__load-more">{{loading}}\n{{/loading}}\n{{#noHistory}}\n\t<li class="{{className}}__item {{className}}__item--message">{{noHistory}}\n{{/noHistory}}\n</ul>';});

define('features/Reminder/views/ReminderHistoryView',[
	'core/View',
	'text!features/Reminder/views/ReminderHistory.mustache',
	'lib/i18n!front'
], function(
	View,
	tplReminderForm,
	i18n
) {
	var BASE_CLASS_NAME = 'chat-reminder-history',
		LOAD_MORE_SELECTOR = '.' + BASE_CLASS_NAME + '__load-more';

	var DEFAULT_OPTIONS = {};

	var ReminderHistoryView = function(targetId, reminders, options) {
		this.targetId = targetId;
		this.reminders = reminders || [];
		this.hasNextPage = true;
		this.isWaitingForUpdate = false;
		this.nextPage = 1;
		this.options = Object.assign({}, DEFAULT_OPTIONS, options);
		this.template = tplReminderForm;
		View.call(this);
	};

	ReminderHistoryView.prototype = Object.create(View.prototype);

	Object.assign(ReminderHistoryView.prototype, {
		addLoadMoreObserver: function () {
			var loadMoreElement = this.getElement().querySelector(LOAD_MORE_SELECTOR);

			if (!loadMoreElement) {
				return;
			}

			this.loadMoreObserver = new IntersectionObserver(this.callbackLoadMoreObserver.bind(this), {
				root: this.getElement(),
				rootMargin: '100px 0px 0px 0px',
				threshold: 1
			});
			this.loadMoreObserver.observe(loadMoreElement);
		},
		addListeners: function() {
			this.addLoadMoreObserver();
		},
		callbackLoadMoreObserver: function (entries, observer) {
			var self = this;
			entries.forEach(function(entry){
				if (entry.isIntersecting) {
					observer.disconnect();
					self.loadMoreReminders();
				}
			});


		},
		createElement: function () {
			View.prototype.createElement.call(this);
		},
		getForcedTemplateParams: function () {
			return {
				className: 'chat-reminder-history',
				noHistory: !this.hasNextPage && !this.reminders.length ? i18n.__('chat.reminder.no_history') : null,
				loading: this.hasNextPage ? i18n.__('loading.loading') : null,
				reminders: this.reminders
			};
		},
		getModalPageMeta: function () {
			return {
				title: i18n.__('chat.history'),
				shortTitle: i18n.__('chat.history'),
			};
		},
		loadMoreReminders: function () {
			if (!this.hasNextPage || this.isWaitingForUpdate) {
				return;
			}

			this.mediator.getReminderHistory(this.nextPage, this.targetId);
			this.isWaitingForUpdate = true;
		},
		onMediatorReady: function () {
			if (this.reminders.length === 0) {
				this.loadMoreReminders();
			}
		},
		remove: function () {
			this.removeLoadMoreObserver();
			View.prototype.remove.call(this);
		},
		removeLoadMoreObserver: function () {
			if (!this.loadMoreObserver) {
				return;
			}

			var loadMoreElement = this.getElement().querySelector(LOAD_MORE_SELECTOR);

			if (!loadMoreElement) {
				return;
			}

			this.loadMoreObserver.unobserve(loadMoreElement);
		},
		updateReminders: function (history) {
			if (!!history.targetId === false) {
				return;
			}

			if (history.total === 0) {
				this.hasNextPage = false;
			} else {
				this.hasNextPage = history.currentPage < history.lastPage;
				this.reminders = this.reminders.concat(history.data);
			}

			if (this.hasNextPage) {
				this.nextPage++;
			}

			this.refreshElement();
			this.isWaitingForUpdate = false;
		}
	});

	return ReminderHistoryView;
});
define('ui/Modal/ModalPage',[], function() {
	/**
	 * @constructor
	 */
	var ModalPage = function(view, options) {
		this.view = view;
		this.title = options.title;
		this.navButton = {
			icon: options.navButtonIcon,
			label: options.navButtonLabel
		};
		this.id = options.id;
	};

	return ModalPage;
});

define('text!ui/Modal/PagedModal.mustache',[],function () { return '<div class="{{className}}">\n\t<div class="{{className}}__header">\n\t\t<button class="{{className}}__back" type="button" title="{{back}}"></button>\n\t\t{{#title}}<h2 class="{{className}}__title">{{title}}</h2>{{/title}}\n\t</div>\n</div>\n';});

define('ui/Modal/PagedModal',[
	'config/chat',
	'lib/i18n!front',
	'lib/tools',
	'mustache',
	'ui/ActionButton/ActionButton',
	'ui/Modal/Modal',
	'text!ui/Modal/PagedModal.mustache',
], function(
	Config,
	i18n,
	tools,
	Mustache,
	ActionButton,
	Modal,
	tplPagedModal
) {
	var BASE_CLASS_NAME = 'chat-ui-paged-modal',
		BACK_BUTTON_CLASS_NAME = BASE_CLASS_NAME + '__back',
		HEADER_BUTTON_CLASS_NAME = BASE_CLASS_NAME + '__header',
		NAV_BUTTON_CLASS_NAME = BASE_CLASS_NAME + '__nav-button',
		PAGE_CLASS_NAME = BASE_CLASS_NAME + '__page',
		TITLE_CLASS_NAME = BASE_CLASS_NAME + '__title',
		VISIBLE_MODIFIER = '--visible';

	/**
	 * @constructor
	 */
	var PagedModal = function(pages, options) {
		this.pages = pages;
		this.template = tplPagedModal;
		Modal.call(this, this.createElementWithPages(pages), options);
	};

	PagedModal.prototype = Object.create(Modal.prototype);

	Object.assign(PagedModal.prototype, {
		addListeners: function (element) {
			var self = this;
			element.querySelector(`.${BACK_BUTTON_CLASS_NAME}`).addEventListener('click', this.onClickBackButton.bind(this));
			element.querySelectorAll(`.${NAV_BUTTON_CLASS_NAME}`).forEach(function (button) {
				button.addEventListener('click', self.onClickNavButton.bind(self));
			});
		},
		appendNavButtonToElement: function (element, page) {
			var navButton = new ActionButton(page.id, {
				classes: NAV_BUTTON_CLASS_NAME,
				attributes: {'data-target': page.id},
				label: `${page.navButton.icon} ${page.navButton.label}`
			});
			element.querySelector(`.${HEADER_BUTTON_CLASS_NAME}`).appendChild(navButton.getElement());
		},
		appendPageToElement: function (element, page) {
			var pageWrapper = document.createElement('div');
			pageWrapper.classList.add(BASE_CLASS_NAME + '__page');
			pageWrapper.id = page.id;
			pageWrapper.appendChild(page.view.getElement());
			element.appendChild(pageWrapper);
			page.view.modal = this;
		},
		createElement: function (pages) {
			var params = {
					back: i18n.__('chat.back'),
					className: 'chat-ui-paged-modal',
					pages: pages,
					title: pages[0].title
				};

			return tools.string_to_node(Mustache.render(this.template, params));
		},
		createElementWithPages: function (pages) {
			var element = this.createElement(pages);

			for (var page of pages) {
				var isFirstPage = page === pages[0];

				page.hasBackButton = !isFirstPage;

				this.appendNavButtonToElement(element, page);
				this.appendPageToElement(element, page);
			}

			this.addListeners(element);
			this.displayPage(pages[0], element);

			return element;
		},
		displayPage: function (page, element) {
			var _element = element || this.element;

			_element.querySelector(`.${BACK_BUTTON_CLASS_NAME}`).classList[(page.hasBackButton ? 'add' : 'remove')](BACK_BUTTON_CLASS_NAME + VISIBLE_MODIFIER);
			_element.querySelectorAll(`.${NAV_BUTTON_CLASS_NAME}`).forEach(function (button) {
				button.classList.add(NAV_BUTTON_CLASS_NAME + VISIBLE_MODIFIER);
			});
			_element.querySelector(`[data-target="${page.id}"]`).classList.remove(NAV_BUTTON_CLASS_NAME + VISIBLE_MODIFIER);
			_element.querySelectorAll(`.${PAGE_CLASS_NAME}`).forEach(function (page) {
				page.classList.remove(PAGE_CLASS_NAME + VISIBLE_MODIFIER);
			});
			_element.querySelector(`#${page.id}`).classList.add(PAGE_CLASS_NAME + VISIBLE_MODIFIER);

			_element.querySelector(`.${TITLE_CLASS_NAME}`).innerText = page.title;
		},
		onClickBackButton: function (event) {
			this.displayPage(this.pages[0]);
		},
		onClickNavButton: function (event) {
			var targetId = event.currentTarget.dataset.target;

			for (var index in this.pages) {
				var page = this.pages[index];

				if (page.id === targetId) {
					this.displayPage(page);
					break;
				}
			}
		}
	});

	return PagedModal;
});
define('features/Reminder/commands/OpenForm',[
	'core/Command',
	'features/Reminder/models/ReminderHistoryModel',
	'features/Reminder/models/ReminderModel',
	'features/Reminder/views/ReminderFormView',
	'features/Reminder/views/ReminderHistoryView',
	'ui/Modal/ModalPage',
	'ui/Modal/PagedModal'
], function(
	Command,
	ReminderHistoryModel,
	ReminderModel,
	ReminderFormView,
	ReminderHistoryView,
	ModalPage,
	PagedModal
) {
	var OpenForm = function(context) {
		Command.call(this, context);
		this.massMessagesStored = null;
	};

	OpenForm.prototype = Object.create(Command.prototype);

	Object.assign(OpenForm.prototype, {
		createFormModalPage: function (userId) {
			var reminder = ReminderModel.get(userId),
				view = new ReminderFormView(userId, reminder);

			return new ModalPage(
				view,
				{
					id: 'reminder-form',
					navButtonIcon: `<i class="icon-f icf-bell" aria-hidden="true"></i>`,
					navButtonLabel: view.getModalPageMeta().shortTitle,
					title: view.getModalPageMeta().title
				}
			);
		},
		createHistoryModalPage: function (userId) {
			var view = new ReminderHistoryView(userId, []);

			return new ModalPage(
				view,
				{
					id: 'reminder-history',
					navButtonIcon: `<i class="icon-f icf-history" aria-hidden="true"></i>`,
					navButtonLabel: view.getModalPageMeta().shortTitle,
					title: view.getModalPageMeta().title
				}
			);
		},
		execute: function (userId) {
			if (typeof userId !== "number") {
				throw new TypeError('userId must be an number');
			}

			var pages = [
					this.createFormModalPage(userId),
					this.createHistoryModalPage(userId)
				];

			new PagedModal(pages);
		}
	});

	return OpenForm;
});
define('features/Reminder/commands/RegisterActiveReminders',[
	'core/Command',
	'features/Reminder/events/ReminderEvent',
	'features/Reminder/models/ReminderModel',
    'libs/EventEmitter',
], function(
	Command,
	ReminderEvent,
	ReminderModel,
    EventEmitter
) {
	var RegisterActiveReminders = function(context) {
		Command.call(this, context);
	};

	RegisterActiveReminders.prototype = Object.create(Command.prototype);

	Object.assign(RegisterActiveReminders.prototype, {
		execute: function (reminders) {
			var _reminders = reminders.data;

			if (_reminders && _reminders.length === 0) {
				return;
			}

			var usersInfosToGet = [];

			for (var key in _reminders) {
				var reminder = _reminders[key];

				if (!this.context.chatFriendManager.friends.hasOwnProperty(reminder.target_id)) {
					usersInfosToGet.push(reminder.target_id);
				}

				ReminderModel.save(reminder);
				this.context.emit(ReminderEvent.UPDATE_FRIEND_DISPLAY, reminder.target_id, reminder);
			}

			if (usersInfosToGet.length > 0) {
                EventEmitter.emit(ReminderEvent.GET_CONTACTS_WITH_REMINDERS, usersInfosToGet);
			}
		}
	});

	return RegisterActiveReminders;
});
define('features/Reminder/commands/ReminderDismissed',[
	'core/Command',
	'features/Reminder/events/ReminderEvent',
	'features/Reminder/models/ReminderHistoryModel',
	'features/Reminder/models/ReminderModel'
], function(
	Command,
	ReminderEvent,
	ReminderHistoryModel,
	ReminderModel
) {
	var ReminderDismissed = function(context) {
		Command.call(this, context);
	};

	ReminderDismissed.prototype = Object.create(Command.prototype);

	Object.assign(ReminderDismissed.prototype, {
		execute: function (reminderData) {
			var friendId = reminderData.target_id;
			ReminderModel.unset(friendId);
			ReminderHistoryModel.save(reminderData);
			this.context.emit(ReminderEvent.UPDATE_FRIEND_DISPLAY, friendId);
		}
	});

	return ReminderDismissed;
});
define('features/Reminder/commands/ReminderSaved',[
	'core/Command',
	'features/Reminder/events/ReminderEvent',
	'features/Reminder/models/ReminderModel'
], function(
	Command,
	ReminderEvent,
	ReminderModel
) {
	var ReminderSaved = function(context) {
		Command.call(this, context);
	};

	ReminderSaved.prototype = Object.create(Command.prototype);

	Object.assign(ReminderSaved.prototype, {
		execute: function (reminderData) {
			ReminderModel.save(reminderData);
			this.context.emit(ReminderEvent.UPDATE_FRIEND_DISPLAY, reminderData.target_id, reminderData);
		}
	});

	return ReminderSaved;
});
define('features/Reminder/commands/SaveReminder',[
	'core/Command',
	'services/SocketConnection',
	'services/SocketConnectionEvent',
], function(
	Command,
	SocketConnection,
	SocketConnectionEvent
) {
	var CreateReminder = function(context) {
		Command.call(this, context);
	};

	CreateReminder.prototype = Object.create(Command.prototype);

	Object.assign(CreateReminder.prototype, {
		execute: function (reminderData) {
			SocketConnection.emit(SocketConnectionEvent.out.SAVE_REMINDER, reminderData);
		}
	});

	return CreateReminder;
});
define('features/Reminder/commands/UpdateFriendContextMenuAction',[
	'core/Command',
	'features/Reminder/events/ReminderEvent',
	'features/Reminder/models/ReminderModel',
	'lib/i18n!front'
], function(
	Command,
	ReminderEvent,
	ReminderModel,
	i18n
) {
	var ACTION_ADD = 'add-reminder',
		ACTION_DISMISS = 'dismiss-reminder',
		ACTION_EDIT = 'edit-reminder',
		ACTIONS = [ACTION_ADD, ACTION_DISMISS, ACTION_EDIT];

	var UpdateFriendContextMenuAction = function(context) {
		Command.call(this, context);
	};

	UpdateFriendContextMenuAction.prototype = Object.create(Command.prototype);

	Object.assign(UpdateFriendContextMenuAction.prototype, {
		callbackContextMenuOpenForm: function(targetId) {
			this.context.emit(ReminderEvent.CONTEXT_MENU_OPEN_FORM, targetId);
		},
		callbackContextMenuDismiss: function(targetId) {
			this.context.emit(ReminderEvent.CONTEXT_MENU_DISMISS, targetId);
		},
		execute: function (friendElement, friendInfo) {
			if (!friendElement.contextMenu) {
				return;
			}

			this.removeExistingActions(friendElement.contextMenu);
			this.insertActions(friendElement.contextMenu, friendInfo.id_user);
		},
		insertActions: function (contextMenu, targetId) {
			var reminder = ReminderModel.get(targetId);

			if (reminder) {
				contextMenu.setAction({
					name: ACTION_EDIT,
					label: '<span class="icon-f icf-bell"></span>' + i18n.__('chat.menu.edit_reminder'),
					callback: this.callbackContextMenuOpenForm.bind(this, targetId)
				});
				contextMenu.setAction({
					name: ACTION_DISMISS,
					label: '<span class="icon-f icf-bin"></span>' + i18n.__('chat.menu.dismiss_reminder'),
					callback: this.callbackContextMenuDismiss.bind(this, targetId)
				});
			} else {
				contextMenu.setAction({
					name: ACTION_ADD,
					label: '<span class="icon-f icf-bell"></span>' + i18n.__('chat.menu.add_reminder'),
					callback: this.callbackContextMenuOpenForm.bind(this, targetId)
				});
			}
		},
		removeExistingActions: function (contextMenu) {
			ACTIONS.forEach(function (actionName) {
				var action = contextMenu.getAction(actionName);
				if (action) {
					contextMenu.removeAction(actionName);
				}
			});
		}
	});

	return UpdateFriendContextMenuAction;
});
define('features/Reminder/commands/UpdateFriendDisplay',[
	'core/Command',
	'features/Reminder/events/ReminderEvent'
], function(
	Command,
	ReminderEvent
) {
	var UpdateFriendDisplay = function(context) {
		Command.call(this, context);
	};

	UpdateFriendDisplay.prototype = Object.create(Command.prototype);

	Object.assign(UpdateFriendDisplay.prototype, {
		execute: function (friendId) {
			if (!this.context.chatFriendManager.friends[friendId]) {
				return;
			}

			var listTypeAndEvents = this.context.manager.getContactListTypeAndEvents(friendId);
			this.context.emit(listTypeAndEvents.events.UPDATE_LIST, false, 'update');

			this.context.chatFriendManager.update_conversation_header(friendId);
			this.updateFriendContextMenu(friendId);
		},
		updateFriendContextMenu: function (friendId) {
			var element = document.querySelector("#select_friend_li_" + friendId);

			if (!element || !element.contextMenu) {
				return;
			}

			this.context.emit(ReminderEvent.UPDATE_FRIEND_CONTEXT_MENU, element, this.context.chatFriendManager.friends[friendId]);
		}
	});

	return UpdateFriendDisplay;
});
define('features/Reminder/commands/UpdateReminderMessageHeaderAction',[
	'core/Command',
	'features/Reminder/models/ReminderModel',
	'lib/i18n!front'
], function(
	Command,
	ReminderModel,
	i18n
) {
	var UpdateReminderMessageHeaderAction = function(context) {
		Command.call(this, context);
	};

	UpdateReminderMessageHeaderAction.prototype = Object.create(Command.prototype);

	Object.assign(UpdateReminderMessageHeaderAction.prototype, {
		execute: function (messageHeader, userId) {
			var actionElement = messageHeader.querySelector('.chat-message-header-reminder .chat-friend-menu__text');

			if (!actionElement) {
				return;
			}

			var reminder = ReminderModel.get(userId);

			if (!reminder) {
				return;
			}

			actionElement.innerText = i18n.__('chat.menu.edit_reminder');
		}
	});

	return UpdateReminderMessageHeaderAction;
});
define('features/Reminder/commands/UnsetAllRemindersData',[
	'core/Command',
	'features/Reminder/events/ReminderEvent',
	'features/Reminder/models/ReminderModel'
], function(
	Command,
	ReminderEvent,
	ReminderModel
) {
	var InitializeFeature = function(context) {
		Command.call(this, context);
	};

	InitializeFeature.prototype = Object.create(Command.prototype);

	Object.assign(InitializeFeature.prototype, {
		execute: function () {
			ReminderModel.unsetAll();
		}
	});

	return InitializeFeature;
});
define('features/Reminder/views/ReminderMediator',[
	'core/Mediator',
	'features/Reminder/events/ReminderEvent'
], function(
	Mediator,
	ReminderEvent
) {
	var ReminderMediator = function(view, context, mediatorMap) {
		Mediator.call(this, view, context, mediatorMap);
	};

	ReminderMediator.prototype = Object.create(Mediator.prototype);

	Object.assign(ReminderMediator.prototype, {
		emitDismissReminder: function (reminder) {
			this.context.emit(ReminderEvent.DISMISS, reminder);
		},
		emitEditReminder: function (reminder) {
			this.context.emit(ReminderEvent.OPEN_FORM, reminder.target_id);
		},
		emitReminderRinging: function (reminder) {
			this.context.emit(ReminderEvent.UPDATE_FRIEND_DISPLAY, reminder.target_id, reminder);
		},
		onReminderDismissed: function (reminderData) {
			this.view.remove(reminderData);
		},
		onSaveReminder: function (reminder) {
			if (reminder.website_user_target_id === this.view.reminder.target_id) {
				this.view.toggleControls();
			}
		},
		onReminderSaved: function (reminder) {
			if (reminder.target_id === this.view.reminder.target_id) {
				this.view.toggleControls();
			}
		}
	});

	return ReminderMediator;
});
define('features/Reminder/views/ReminderFormMediator',[
	'core/Mediator',
	'features/Reminder/events/ReminderEvent'
], function(
	Mediator,
	ReminderEvent
) {
	var ReminderFormMediator = function(view, context, mediatorMap) {
		Mediator.call(this, view, context, mediatorMap);
	};

	ReminderFormMediator.prototype = Object.create(Mediator.prototype);

	Object.assign(ReminderFormMediator.prototype, {
		onReminderSaved: function () {
			this.view.close();
		},
		saveReminder: function (data) {
			this.context.emit(ReminderEvent.SAVE, data);
		}
	});

	return ReminderFormMediator;
});
define('features/Reminder/views/ReminderHistoryMediator',[
	'core/Mediator',
	'features/Reminder/events/ReminderEvent'
], function(
	Mediator,
	ReminderEvent
) {
	var ReminderHistoryMediator = function(view, context, mediatorMap) {
		Mediator.call(this, view, context, mediatorMap);
	};

	ReminderHistoryMediator.prototype = Object.create(Mediator.prototype);

	Object.assign(ReminderHistoryMediator.prototype, {
		onHistoryReceived: function (history) {
			this.view.updateReminders(history);
		},
		getReminderHistory: function (page, targetId) {
			this.context.emit(ReminderEvent.GET_REMINDER_HISTORY, page, targetId);
		},
		ready: function () {
			this.view.onMediatorReady();
		}
	});

	return ReminderHistoryMediator;
});
define('FriendManagerEvent',[], function () {
	var FriendManagerEvent = Object.create(null);

	Object.defineProperties(FriendManagerEvent, {
		FRIEND_CREATED: {value: 'friend_created.friend_manager', writable: false},
		FRIEND_UPDATED: {value: 'friend_updated.friend_manager', writable: false},
		HEADER_MESSAGE_CREATED: {value: 'header_message_created.friend_manager', writable: false}
	});

	return FriendManagerEvent;
});
define('features/Reminder/ReminderMapper',[
	'config/chat',
	'core/ContextEvent',
	'features/Reminder/commands/DisplayReminderInMessageHeader',
	'features/Reminder/commands/DismissReminder',
	'features/Reminder/commands/DismissReminderByFriendId',
	'features/Reminder/commands/FriendCreated',
	'features/Reminder/commands/FriendUpdated',
	'features/Reminder/commands/GetActiveReminders',
	'features/Reminder/commands/GetReminderHistory',
	'features/Reminder/commands/GetInitData',
	'features/Reminder/commands/HistoryReceived',
	'features/Reminder/commands/InitDataReceived',
	'features/Reminder/commands/OpenForm',
	'features/Reminder/commands/RegisterActiveReminders',
	'features/Reminder/commands/ReminderDismissed',
	'features/Reminder/commands/ReminderSaved',
	'features/Reminder/commands/SaveReminder',
	'features/Reminder/commands/UpdateFriendContextMenuAction',
	'features/Reminder/commands/UpdateFriendDisplay',
	'features/Reminder/commands/UpdateReminderMessageHeaderAction',
	'features/Reminder/commands/UnsetAllRemindersData',
	'features/Reminder/events/ReminderEvent',
	'features/Reminder/views/ReminderMediator',
	'features/Reminder/views/ReminderView',
	'features/Reminder/views/ReminderFormMediator',
	'features/Reminder/views/ReminderFormView',
	'features/Reminder/views/ReminderHistoryMediator',
	'features/Reminder/views/ReminderHistoryView',
	'FriendManagerEvent',
	'services/SocketConnection',
	'services/SocketConnectionEvent'
], function(
	Config,
	ContextEvent,
	DisplayReminderInMessageHeaderCommand,
	DismissReminderCommand,
	DismissReminderByFriendIdCommand,
	FriendCreatedCommand,
	FriendUpdatedCommand,
	GetActiveRemindersCommand,
	GetReminderHistoryCommand,
	GetInitDataCommand,
	HistoryReceivedCommand,
	InitDataReceivedCommand,
	OpenFormCommand,
	RegisterActiveRemindersCommand,
	ReminderDismissedCommand,
	ReminderSavedCommand,
	SaveReminderCommand,
	UpdateFriendContextMenuActionCommand,
	UpdateFriendDisplayCommand,
	UpdateReminderMessageHeaderActionCommand,
	UnsetAllRemindersDataCommand,
	ReminderEvent,
	ReminderMediator,
	ReminderView,
	ReminderFormMediator,
	ReminderFormView,
	ReminderHistoryMediator,
	ReminderHistoryView,
	FriendManagerEvent,
	SocketConnection,
	SocketConnectionEvent
) {
	return function(context) {
		if (!Config.login_info.is_support) {
			return;
		}

		context.commandMap.mapEvent(ContextEvent.STARTUP, UnsetAllRemindersDataCommand);

		context.commandMap.mapEvent(FriendManagerEvent.HEADER_MESSAGE_CREATED, DisplayReminderInMessageHeaderCommand);
		context.commandMap.mapEvent(FriendManagerEvent.HEADER_MESSAGE_CREATED, UpdateReminderMessageHeaderActionCommand);
		context.commandMap.mapEvent(FriendManagerEvent.FRIEND_CREATED, FriendCreatedCommand);
		context.commandMap.mapEvent(FriendManagerEvent.FRIEND_UPDATED, FriendUpdatedCommand);

		context.commandMap.mapEvent(ReminderEvent.ACTIVE_REMINDERS_RECEIVED, RegisterActiveRemindersCommand);
		context.commandMap.mapEvent(ReminderEvent.CONTEXT_MENU_OPEN_FORM, OpenFormCommand);
		context.commandMap.mapEvent(ReminderEvent.CONTEXT_MENU_DISMISS, DismissReminderByFriendIdCommand);
		context.commandMap.mapEvent(ReminderEvent.DISMISS, DismissReminderCommand);
		context.commandMap.mapEvent(ReminderEvent.DISMISSED, ReminderDismissedCommand);
		context.commandMap.mapEvent(ReminderEvent.GET_INIT_DATA, GetInitDataCommand);
		context.commandMap.mapEvent(ReminderEvent.HISTORY_RECEIVED, HistoryReceivedCommand);
		context.commandMap.mapEvent(ReminderEvent.INIT_DATA_RECEIVED, InitDataReceivedCommand);
		context.commandMap.mapEvent(ReminderEvent.GET_ACTIVE_REMINDERS, GetActiveRemindersCommand);
		context.commandMap.mapEvent(ReminderEvent.GET_REMINDER_HISTORY, GetReminderHistoryCommand);
		context.commandMap.mapEvent(ReminderEvent.OPEN_FORM, OpenFormCommand);
		context.commandMap.mapEvent(ReminderEvent.SAVE, SaveReminderCommand);
		context.commandMap.mapEvent(ReminderEvent.SAVED, ReminderSavedCommand);
		context.commandMap.mapEvent(ReminderEvent.UPDATE_FRIEND_DISPLAY, UpdateFriendDisplayCommand);
		context.commandMap.mapEvent(ReminderEvent.UPDATE_FRIEND_CONTEXT_MENU, UpdateFriendContextMenuActionCommand);

		context.mediatorMap.mapEvent(ReminderEvent.DISMISSED, ReminderMediator, 'onReminderDismissed');
		context.mediatorMap.mapEvent(ReminderEvent.SAVE, ReminderMediator, 'onSaveReminder');

		context.mediatorMap.mapEvent(ReminderEvent.SAVED, ReminderFormMediator, 'onReminderSaved');

		context.mediatorMap.mapEvent(ReminderEvent.HISTORY_RECEIVED, ReminderHistoryMediator, 'onHistoryReceived');

		context.mediatorMap.mapView(ReminderFormView, ReminderFormMediator);
		context.mediatorMap.mapView(ReminderHistoryView, ReminderHistoryMediator);
		context.mediatorMap.mapView(ReminderView, ReminderMediator);

		SocketConnection.forwardIncomingEvent(SocketConnectionEvent.in.REMINDER_ALL_ACTIVE, ReminderEvent.ACTIVE_REMINDERS_RECEIVED);
		SocketConnection.forwardIncomingEvent(SocketConnectionEvent.in.REMINDER_HISTORY, ReminderEvent.HISTORY_RECEIVED);
		SocketConnection.forwardIncomingEvent(SocketConnectionEvent.in.REMINDER_INIT_DATA, ReminderEvent.INIT_DATA_RECEIVED);
		SocketConnection.forwardIncomingEvent(SocketConnectionEvent.in.REMINDER_DISMISSED, ReminderEvent.DISMISSED);
		SocketConnection.forwardIncomingEvent(SocketConnectionEvent.in.REMINDER_SAVED, ReminderEvent.SAVED);
	};
});
define('features/Settings/commands/CreatorManagerSwitched',[
	'core/Command'
], function(
	Command
) {
	var CreatorManager = function(context) {
		Command.call(this, context);
	};

	CreatorManager.prototype = Object.create(Command.prototype);

	Object.assign(CreatorManager.prototype, {
		execute: function (data) {
			this.context.chatFriendManager.friends[data.id_user].is_handle_by_manager = data.state;
			if (this.context.chatFriendManager.get_selected_friend_id() === data.id_user) {
				this.context.chatFriendManager.manage_user_creator_account_managed(data.state);
			}
		}
	});

	return CreatorManager;
});
define('features/Settings/commands/SettingAdded',[
	'core/Command',
	'services/SocketConnection',
	'services/SocketConnectionEvent'
], function(
	Command,
	SocketConnection,
	SocketConnectionEvent
) {
	var SettingAdded = function(context) {
		Command.call(this, context);
	};

	SettingAdded.prototype = Object.create(Command.prototype);

	Object.assign(SettingAdded.prototype, {
		execute: function (data) {
			if (data.setting_name === 'silent_auto_publish_ppv') {
				this.context.manager.manage_setting_silent_ppv(true);
			}
			if (data.setting_name === 'is_handle_by_manager') {
				this.context.manager.manage_setting_manager(true);
			}
		}
	});

	return SettingAdded;
});
define('features/Settings/commands/SettingDeleted',[
	'core/Command',
	'services/SocketConnection',
	'services/SocketConnectionEvent'
], function(
	Command
) {
	var SettingDeleted = function(context) {
		Command.call(this, context);
	};

	SettingDeleted.prototype = Object.create(Command.prototype);

	Object.assign(SettingDeleted.prototype, {
		execute: function (data) {
			if (data.setting_name === 'is_silent_ppv') {
				this.context.manager.manage_setting_silent_ppv(false);
			}
			if (data.setting_name === 'is_handle_by_manager') {
				this.context.manager.manage_setting_manager(false);
			}
		}
	});

	return SettingDeleted;
});
define('features/Settings/commands/SilentPPVDone',[
	'core/Command',
	'lib/i18n!front'
], function(
	Command,
	i18n
) {
	var SilentPPV = function(context) {
		Command.call(this, context);
	};

	SilentPPV.prototype = Object.create(Command.prototype);

	Object.assign(SilentPPV.prototype, {
		execute: function (data) {
			var friend_infos = this.context.chatFriendManager.get_friend_infos(data.user_id);
			friend_infos.is_silent_ppv = !friend_infos.is_silent_ppv;

			this.context.manager.setting_silent_ppv_update_cm(data.user_id);
		}
	});

	return SilentPPV;
});
define('features/Settings/commands/SwitchSetting',[
	'core/Command',
	'services/SocketConnection',
	'services/SocketConnectionEvent'
], function(
	Command,
	SocketConnection,
	SocketConnectionEvent
) {
	var SwitchSetting = function(context) {
		Command.call(this, context);
	};

	SwitchSetting.prototype = Object.create(Command.prototype);

	Object.assign(SwitchSetting.prototype, {
		execute: function (event) {
			var currentTarget = event.currentTarget,
				settingId = currentTarget.id,
				settingEventName = currentTarget.checked ? SocketConnectionEvent.out.ADD_SETTING : SocketConnectionEvent.out.DELETE_SETTING,
				settingName = null,
				settingData = {};

			if (settingId === 'chat-setting-silent-ppv') {
				settingName = 'silent_auto_publish_ppv';
			} else if (settingId === 'chat-setting-manager') {
				settingName = 'is_handle_by_manager';
			} else {
				return;
			}

			settingData.setting_name = settingName;

			if (settingEventName === 'add_setting') {
				settingData.setting_value = {};
				settingData.setting_value[settingName] = 'true';
			}

			SocketConnection.emit(settingEventName, settingData);
		}
	});

	return SwitchSetting;
});
define('features/Settings/events/SettingsEvent',[], function () {
	var SettingEvent = Object.create(null);

	Object.defineProperties(SettingEvent, {
		SWITCH_SETTING: {value: 'switch.setting', writable: false},
		SETTING_ADDED: {value: 'added.setting', writable: false},
		SETTING_DELETED: {value: 'deleted.setting', writable: false},
		CREATOR_MANAGER: {value: 'creator_manager.setting', writable: false},
		CREATOR_MANAGER_SWITCHED: {value: 'creator_manager_switched.setting', writable: false},
		SILENT_PPV: {value: 'silent_ppv.setting', writable: false},
		SILENT_PPV_DONE: {value: 'silent_ppv_done.setting', writable: false},
	});

	return SettingEvent;
});
define('features/Settings/SettingsMapper',[
	'chat/ManagerEvent',
	'features/Settings/commands/CreatorManagerSwitched',
	'features/Settings/commands/SettingAdded',
	'features/Settings/commands/SettingDeleted',
	'features/Settings/commands/SilentPPVDone',
	'features/Settings/commands/SwitchSetting',
	'features/Settings/events/SettingsEvent',
	'services/SocketConnection',
	'services/SocketConnectionEvent'
], function(
	ManagerEvent,
	CreatorManagerSwitchedCommand,
	SettingAddedCommand,
	SettingDeletedCommand,
	SilentPPVDoneCommand,
	SwitchSettingCommand,
	SettingsEvent,
	SocketConnection,
	SocketConnectionEvent
) {
	return function(context) {
		context.commandMap.mapEvent(SettingsEvent.SWITCH_SETTING, SwitchSettingCommand);
		context.commandMap.mapEvent(SettingsEvent.CREATOR_MANAGER_SWITCHED, CreatorManagerSwitchedCommand);
		context.commandMap.mapEvent(SettingsEvent.SILENT_PPV_DONE, SilentPPVDoneCommand);
		context.commandMap.mapEvent(SettingsEvent.SETTING_ADDED, SettingAddedCommand);
		context.commandMap.mapEvent(SettingsEvent.SETTING_DELETED, SettingDeletedCommand);

		SocketConnection.forwardIncomingEvent(SocketConnectionEvent.in.SETTING_ADDED, SettingsEvent.SETTING_ADDED);
		SocketConnection.forwardIncomingEvent(SocketConnectionEvent.in.SETTING_DELETED, SettingsEvent.SETTING_DELETED);
		SocketConnection.forwardIncomingEvent(SocketConnectionEvent.in.SETTING_SILENT_PPV_DONE, SettingsEvent.SILENT_PPV_DONE);
		SocketConnection.forwardIncomingEvent(SocketConnectionEvent.in.SETTING_SWITCHED_CREATOR_MANAGER, SettingsEvent.CREATOR_MANAGER_SWITCHED);
	};
});
define('features/Studio/views/StudioSelectorView',[
    'config/chat',
    'core/View',
    'lib/helpers/popup/contextual_menu'
], function(
    Config,
    View,
    ContextMenu
) {
    var BUTTON_CLASS_NAME = 'chat-sidebar__studio-selector',
        BUTTON_CLASS_NAME_SELECTOR = '.' + BUTTON_CLASS_NAME,
        BUTTON_HAS_UNREAD_CLASS_NAME = 'chat-sidebar__studio-selector--has-unread',
        BUTTON_OPEN_CLASS_NAME = 'chat-sidebar__studio-selector--context-menu-open',
        PARENT_SELECTOR = '.chat-sidebar__username-wrapper',
        USERNAME_SELECTOR = '.chat-sidebar__username';
    var StudioSelectorView = function(studios) {
        // Be careful with this one. Here `studios` is passed by reference from manager. So any modifications on here
        // impact manager.studios too.
        this.studios = studios;
        this.template = '<button class="{{buttonClassName}}"><svg class="chat-sidebar__settings-down chat-scc"><use xlink:href="#scc-down-icon"></use></svg></button>';

        this.removeExistent();
        View.call(this);
    };

    StudioSelectorView.prototype = Object.create(View.prototype);

    Object.assign(StudioSelectorView.prototype, {
        addListeners: function () {
        },
        createContextMenu: function () {
            var cmActions = this.generateContextMenuActions();

            if (cmActions.unread) {
                this.element.classList.add(BUTTON_HAS_UNREAD_CLASS_NAME)
            }

            var self = this;

            this.contextMenu = new ContextMenu(this.element, cmActions.actions, {
                position: {v: 'below', h: 'left'},
                offset: {below: -3},
                on_open: function () {
                    var popup = self.contextMenu.getPopup(),
                        contentSelector = '.x-popup-content';

                    popup.children(contentSelector).css({borderTopLeftRadius: 0});

                    if (popup.width() <= self.element.clientWidth) {
                        popup.children(contentSelector).css({borderTopRightRadius: 0});
                    }

                    self.element.classList.add(BUTTON_OPEN_CLASS_NAME);
                },
                on_close: function () {
                    self.element.classList.remove(BUTTON_OPEN_CLASS_NAME);
                }
            })
        },
        createElement: function () {
            View.prototype.createElement.call(this);

            var parent = this.getParentElement(),
                username = this.getUsernameElement();

            if (parent && username) {
                this.element.prepend(username);
                parent.append(this.element);
            }

            this.createContextMenu();
        },
        generateContextMenuAction: function (studio) {
            var self = this;
            return {
                name: 'load-user-' + studio.website_user_id,
                label: studio.name + (studio.nb_unread_messages_sum ? ' <span class="chat-badge chat-studio-selector-button__badge">' + studio.nb_unread_messages_sum + '</span>' : ''),
                callback: (function (websiteUserId) {
                    return function () {
                        self.mediator.emitLoadStudio(websiteUserId);
                    };
                })(studio.website_user_id)
            };
        },
        generateContextMenuActions: function () {
            var actions = [],
                unread = 0;

            for (var studio_website_user_id in this.studios) {
                if (+studio_website_user_id === +Config.login_info.id) {
                    continue;
                }

                var studio = this.studios[studio_website_user_id];
                unread += studio.nb_unread_messages_sum;

                actions.push(this.generateContextMenuAction(studio));
            }
            return {actions: actions, unread: unread};
        },
        getForcedTemplateParams: function () {
            return {buttonClassName: BUTTON_CLASS_NAME};
        },
        getParentElement: function () {
            return document.querySelector(PARENT_SELECTOR);
        },
        getUsernameElement: function () {
            return document.querySelector(USERNAME_SELECTOR);
        },
        incrementStudioUnread: function (websiteUserId) {
            if (!(!!this.studios[websiteUserId]) || +Config.login_info.id === +websiteUserId) {
                return;
            }

            this.studios[websiteUserId].nb_unread_messages_sum++;

            if (!this.contextMenu) {
                return;
            }

            this.contextMenu.setAction(this.generateContextMenuAction(this.studios[websiteUserId]));

            this.element.classList.add(BUTTON_HAS_UNREAD_CLASS_NAME);
        },
        removeExistent: function () {
            var existent = document.querySelector(BUTTON_CLASS_NAME_SELECTOR),
                parent = this.getParentElement(),
                username = this.getUsernameElement();

            if (existent && parent && username) {
                parent.prepend(username);
                existent.remove();
            }
        }
    });

    return StudioSelectorView;
});
define('features/Studio/commands/InitSelector',[
    'core/Command',
    'features/Studio/views/StudioSelectorView'
], function(
    Command,
    StudioSelectorView
) {
    var InitSelector = function(context) {
        Command.call(this, context);
    };

    InitSelector.prototype = Object.create(Command.prototype);

    Object.assign(InitSelector.prototype, {
        execute: function (studios) {
            new StudioSelectorView(studios);
        }
    });

    return InitSelector;
});
define('features/Studio/events/StudioEvent',[], function () {
    var StudioEvent = Object.create(null);

    Object.defineProperties(StudioEvent, {
        INCREMENT_STUDIO_UNREAD: {value: 'increment_studio_unread.draft', writable: false},
        INIT_SELECTOR: {value: 'init_selector.draft', writable: false},
        LOAD_STUDIO: {value: 'load_studio.draft', writable: false},
    });

    return StudioEvent;
});
define('features/Studio/views/StudioSelectorMediator',[
    'config/chat',
    'core/Mediator',
    'features/Studio/events/StudioEvent'
], function(
    Config,
    Mediator,
    StudioEvent
) {
    var StudioSelectorMediator = function(view, context, mediatorMap) {
        Mediator.call(this, view, context, mediatorMap);
    };

    StudioSelectorMediator.prototype = Object.create(Mediator.prototype);

    Object.assign(StudioSelectorMediator.prototype, {
        emitLoadStudio: function (websiteUserId) {
            this.context.emit(StudioEvent.LOAD_STUDIO, websiteUserId);
        },
        onIncrementStudioUnread: function (websiteUserId) {
            this.view.incrementStudioUnread(websiteUserId);
        }
    });

    return StudioSelectorMediator;
});
define('features/Studio/StudioMapper',[
    'features/Studio/commands/InitSelector',
    'features/Studio/events/StudioEvent',
    'features/Studio/views/StudioSelectorMediator',
    'features/Studio/views/StudioSelectorView',
], function(
    InitSelectorCommand,
    StudioEvent,
    StudioSelectorMediator,
    StudioSelectorView
) {
    return function(context) {
        context.commandMap.mapEvent(StudioEvent.INIT_SELECTOR, InitSelectorCommand);

        context.mediatorMap.mapEvent(StudioEvent.INCREMENT_STUDIO_UNREAD, StudioSelectorMediator, 'onIncrementStudioUnread');

        context.mediatorMap.mapView(StudioSelectorView, StudioSelectorMediator);
    };
});
define('features/SupportAnnouncement/models/SupportAnnouncementModel',[
    'core/Model'
], function (
    Model
) {
    /**
     * @extends Model
     * @constructor
     */
    var SupportAnnouncementModel = function () {
        this.storageKey = 'supportAnnouncement';
        Model.call(this);
    };

    SupportAnnouncementModel.prototype = Object.create(Model.prototype);

    Object.assign(SupportAnnouncementModel.prototype, {
        save: function (entry) {
            this.set(entry, 0);
        },
        validate: function (data) {
            if (typeof data.content !== "string") return false;
            if (!(data.display_to_all === 0 || data.display_to_all === 1)) return false;
            if (!this.validateDateString(data.end_date)) return false;
            if (typeof data.id !== "number" || data.id < 1) return false;
            if (typeof data.title !== "string" || !data.title.length) return false;

            return true;
        }
    });

    return new SupportAnnouncementModel();
});
define('features/SupportAnnouncement/commands/AnnouncementDeleted',[
    'core/Command',
    'features/SupportAnnouncement/models/SupportAnnouncementModel',
], function(
    Command,
    SupportAnnouncementModel
) {
    var AnnouncementDeleted = function(context) {
        Command.call(this, context);
    };

    AnnouncementDeleted.prototype = Object.create(Command.prototype);

    Object.assign(AnnouncementDeleted.prototype, {
        execute: function () {
            SupportAnnouncementModel.unsetAll();
        }
    });

    return AnnouncementDeleted;
});
define('features/SupportAnnouncement/events/SupportAnnouncementEvent',[], function () {
    var SupportAnnouncementEvent = Object.create(null);

    Object.defineProperties(SupportAnnouncementEvent, {
        ANNOUNCEMENT_DELETED: {value: 'announcement_deleted.support_announcement', writable: false},
        ANNOUNCEMENT_FOUND: {value: 'announcement_found.support_announcement', writable: false},
        ANNOUNCEMENT_SAVED: {value: 'announcement_saved.support_announcement', writable: false},
        CLOSE_FORM: {value: 'close_form.support_announcement', writable: false},
        DELETE_ANNOUNCEMENT: {value: 'delete_announcement.support_announcement', writable: false},
        GET_ANNOUNCEMENT: {value: 'get_announcement.support_announcement', writable: false},
        OPEN_FORM: {value: 'open_form.support_announcement', writable: false},
        SAVE_ANNOUNCEMENT: {value: 'save_announcement.support_announcement', writable: false},
        SAVE_ANNOUNCEMENT_ERROR: {value: 'save_announcement_error.support_announcement', writable: false},
    });

    return SupportAnnouncementEvent;
});

define('text!window_message.mustache',[],function () { return '<div class="chat-alert{{#message_type}} chat-alert--{{message_type}}{{/message_type}}{{#dismissible}} chat-alert--dismissible{{/dismissible}}" role="alert">\n\t{{{message}}}\n\t{{#dismissible}}<button type="button" class="btn-close" aria-label="Close"></button>{{/dismissible}}\n\t{{#action_label}}\n\t\t<button type="button" class="btn btn--flat btn-action{{#message_type}} btn-action--{{message_type}}{{/message_type}}">\n\t\t\t{{#action_icon}}<span class="icon-f {{action_icon}} icf-2x"></span> {{/action_icon}}\n\t\t\t{{action_label}}\n\t\t</button>\n\t{{/action_label}}\n</div>';});

define('chat_window_message',[
	'mustache',
	'text!window_message.mustache'
], function(Mustache, tpl_window_message) {
	
	var window_message_default_options = {
		message: '',
		message_type: 'info',
		dismissible: false
	};
	
	var window_message = function (message, options) {
		this.options = Object.assign({}, window_message_default_options, options);
		this.options.message = message;
		this.element = null;
		this.html = null;
		
		this.prepareHtml();
		this.show();
	}
	
	window_message.prototype = {
		prepareHtml: function () {
			this.html = Mustache.render(tpl_window_message, this.options);
		},
		show: function () {
			this.element = $(this.html);
			this.element.on('click', '.btn-close', this.remove.bind(this));

			if (!!this.options.action) {
				this.element.on('click', '.btn-action', this.options.action.bind(this));
			}

			$('.chat-window__message').append(this.element);
		},
		hide: function () {
			this.element.detach();
		},
		remove: function () {
			this.element.remove();
		}
	};
	
	var messages = [];
	var window_message_manager = {
		add: function (message, options) {

			for (var index in messages) {
				if (messages[index].options.message_type === options.message_type) {
					return;
				}
			}

			messages.push(new window_message(message, options));
		},
		
		clear: function () {
			while (messages.length) {
				messages[0].remove();
				messages.splice(0, 1);
			}
		},

		delete: function(index) {
			messages[index].remove();
			messages.splice(index, 1);
		},

		getAll: function() {
			return messages;
		}
	};
	
	return window_message_manager;
});

define('text!features/SupportAnnouncement/views/Announcement.mustache',[],function () { return '<p class="{{classes}} text-center"><strong>{{title}}</strong>{{#content}} <button type="button" class="{{showMoreClass}}">{{showMore}}</button>{{/content}}</p>';});

define('features/SupportAnnouncement/views/AnnouncementView',[
    'chat_window_message',
    'core/View',
    'text!features/SupportAnnouncement/views/Announcement.mustache',
    'lib/i18n!front',
    'lib/utils',
    'ui/Modal/Modal'
], function(
    ChatWindowMessage,
    View,
    template,
    i18n,
    utils,
    Modal
) {
    var PARENT_ID = 'chat-window-announcement';

    var BASE_CLASS_NAME = 'chat-support-announcement',
        SEE_MORE_CLASS_NAME = 'chat-support-announcement__see-more',
        SEE_MORE_SELECTOR = '.' + SEE_MORE_CLASS_NAME;

    var AnnouncementView = function(announcement) {
        this.announcement = announcement;
        this.template = template;
        this.removeExistent();
        View.call(this);
        this.addElementToDOM();
    };

    AnnouncementView.prototype = Object.create(View.prototype);

    Object.assign(AnnouncementView.prototype, {
        addElementToDOM: function() {
            document.getElementById(PARENT_ID).appendChild(this.element);
        },
        addListeners: function() {
            this.addElementListener(SEE_MORE_SELECTOR, 'click', this.onClickShowMore, 'announcement_view', this);
        },
        getForcedTemplateParams: function() {
            return Object.assign({}, this.announcement, {
                classes: `${BASE_CLASS_NAME} chat-alert`,
                showMore: i18n.__('chat.show_more_details'),
                showMoreClass: `${SEE_MORE_CLASS_NAME} chat-alert__button`
            });
        },
        onClickShowMore: function () {
            this.showContentModal();
        },
        removeExistent: function () {
            document.getElementById(PARENT_ID).innerHTML = '';
        },
        showContentModal: function() {
            var content = `<p>${utils.escapeHtml(this.announcement.content).replaceAll('\n', '<br>')}</p>`;
            new Modal(content, {
                title: utils.escapeHtml(this.announcement.title),
                closeable: true,
            });
        }
    });

    return AnnouncementView;
});
define('features/SupportAnnouncement/commands/AnnouncementReceived',[
    'config/chat',
    'core/Command',
    'features/SupportAnnouncement/events/SupportAnnouncementEvent',
    'features/SupportAnnouncement/models/SupportAnnouncementModel',
    'features/SupportAnnouncement/views/AnnouncementView',
], function(
    Config,
    Command,
    SupportAnnouncementEvent,
    SupportAnnouncementModel,
    AnnouncementView
) {
    var AnnouncementReceived = function(context) {
        Command.call(this, context);
    };

    AnnouncementReceived.prototype = Object.create(Command.prototype);

    Object.assign(AnnouncementReceived.prototype, {
        execute: function (data) {
            wglog.log('AnnouncementReceived::execute', 'received announcement data:', data);
            var announcement = this.getAnnouncementFromData(data);

            if (!announcement) {
                return;
            }

            this.saveAnnouncement(announcement);
            this.showAnnouncement(announcement);
        },

        getAnnouncementFromData: function(data) {
            if (!data || !data.announcement) {
                return null;
            }

            var announcement = data.announcement;

            if (!announcement.display_to_all && !Config.login_info.is_support && !Config.login_info.is_creator) {
                return null;
            }

            return announcement;
        },

        saveAnnouncement: function (announcement) {
            SupportAnnouncementModel.set(announcement);
        },

        showAnnouncement: function (announcement) {
            new AnnouncementView(announcement);

            var gmtDate = new Date(announcement.end_date + 'Z'),
                nowLocal = new Date(),
                diffMs = gmtDate.getTime() - nowLocal.getTime(),
                self = this;

            setTimeout(function () {
                self.context.emit(SupportAnnouncementEvent.ANNOUNCEMENT_DELETED);
            }, diffMs);
        }
    });

    return AnnouncementReceived;
});
define('features/SupportAnnouncement/commands/CloseForm',[
    'core/Command',
], function(
    Command,
) {
    var CloseForm = function(context) {
        Command.call(this, context);
    };

    CloseForm.prototype = Object.create(Command.prototype);

    Object.assign(CloseForm.prototype, {
        execute: function () {
            //@TODO complete
        }
    });

    return CloseForm;
});
define('features/SupportAnnouncement/commands/DeleteAnnouncement',[
    'core/Command',
    'services/SocketConnection',
    'services/SocketConnectionEvent'
], function(
    Command,
    SocketConnection,
    SocketConnectionEvent
) {
    var DeleteAnnouncement = function(context) {
        Command.call(this, context);
    };

    DeleteAnnouncement.prototype = Object.create(Command.prototype);

    Object.assign(DeleteAnnouncement.prototype, {
        execute: function (announcementId) {
            SocketConnection.emit(SocketConnectionEvent.out.DELETE_ANNOUNCEMENT, {id: announcementId});
        }
    });

    return DeleteAnnouncement;
});
define('features/SupportAnnouncement/commands/GetAnnouncement',[
    'core/Command',
    'services/SocketConnection',
    'services/SocketConnectionEvent'
], function(
    Command,
    SocketConnection,
    SocketConnectionEvent
) {
    var GetAnnouncement = function(context) {
        Command.call(this, context);
    };

    GetAnnouncement.prototype = Object.create(Command.prototype);

    Object.assign(GetAnnouncement.prototype, {
        execute: function () {
            SocketConnection.emit(SocketConnectionEvent.out.GET_ANNOUNCEMENT);
        }
    });

    return GetAnnouncement;
});
define('features/SupportAnnouncement/views/AnnouncementFormView',[
    'core/View',
    'lib/i18n!front',
    'ui/ActionButton/ActionButton',
    'ui/Form/Form',
    'ui/FormField/Input/Input',
    'ui/FormField/Input/Checkbox',
    'ui/FormField/Textarea/Textarea',
    'ui/Modal/ConfirmModal',
    'ui/Modal/Modal'
], function(
    View,
    i18n,
    ActionButton,
    Form,
    Input,
    Checkbox,
    Textarea,
    ConfirmModal,
    Modal
) {
    var AnnouncementFormView = function(announcement) {
        this.templateDisabled = true;
        this.announcement = announcement || {};
        this.actionCancel = null;
        this.actionDelete = null;
        this.actionSave = null;
        this.fieldContent = null;
        this.fieldDisplayToAll = null;
        this.fieldEndDate = null;
        this.fieldTitle = null;
        this.form = null;
        this.formModal = null;
        this.pendingModal = null;

        View.call(this);
    };

    AnnouncementFormView.prototype = Object.create(View.prototype);

    Object.assign(AnnouncementFormView.prototype, {
        askForConfirmation: function () {
            new ConfirmModal(
                i18n.__('chat.announcement.ask_confirmation_on_save'),
                {
                    invertButtons: true,
                    onOk: this.onClickConfirmationOk.bind(this),
                    onNo: this.onClickConfirmationNo.bind(this)
                }
            );
        },
        addListeners: function () {
            if (this.actionCancel) {
                this.addElementListener(this.actionCancel.getElement(), 'click', this.onClickActionCancel, 'report-form', this);
            }
            if (this.actionDelete) {
                this.addElementListener(this.actionDelete.getElement(), 'click', this.onClickActionDelete, 'report-form', this);
            }
            this.addElementListener(this.actionSave.getElement(), 'click', this.onClickActionSave, 'report-form', this);
        },
        createActionCancel: function () {
            this.actionCancel = new ActionButton('cancel', {
                label: i18n.__('misc.cancel')
            });
            return this.actionCancel;
        },
        createActionDelete: function () {
            this.actionDelete = new ActionButton('delete', {
                color: ActionButton.THEME_RED,
                label: i18n.__('misc.delete')
            });
            return this.actionDelete;
        },
        createActionSave: function () {
            this.actionSave = new ActionButton('save', {
                color: ActionButton.THEME_GRADIENT,
                label: i18n.__('misc.save')
            });
            return this.actionSave;
        },
        createElement: function() {
            this.form = this.createForm();
            this.formModal = this.createModal();
            this.element = this.formModal.getElement();
        },
        createFieldContent: function() {
            this.fieldContent = new Textarea({
                attributes: {
                    name: 'content',
                    rows: 5,
                    resize: 'vertical'
                },
                label: i18n.__('chat.message'),
                withEmoji: false,
            });
            return this.fieldContent;
        },
        createFieldDisplayToAll: function() {
            this.fieldDisplayToAll = new Checkbox({
                attributes: {
                    id: 'announcement-display-to-all',
                    name: 'display_to_all',
                    checked: !!this.announcement.display_to_all,
                },
                label: i18n.__('chat.support_announcement.display_to_all'),
                labelFor: 'announcement-display-to-all'
            });
            return this.fieldDisplayToAll;
        },
        createFieldEndDate: function() {
            var minDate = this.getMinDate();

            this.fieldEndDate = new Input({
                type: 'datetime-local',
                attributes: {
                    name: 'end_date',
                    min: minDate,
                    value: this.announcement.end_date ? this.formatDateLocaleFieldString(this.announcement.end_date) : minDate
                },
                label: i18n.__('misc.end_date'),
            });
            return this.fieldEndDate;
        },
        createFieldTitle: function() {
            this.fieldTitle = new Input({
                type: 'text',
                attributes: {
                    name: 'title',
                    placeholder: i18n.__('misc.title'),
                    value: this.announcement.title || ''
                },
                label: i18n.__('misc.title'),
            });
            return this.fieldTitle;
        },
        createForm: function() {
            var form = new Form({
                title: i18n.__('chat.announcement')
            });

            form.appendField(this.createFieldTitle());
            form.appendField(this.createFieldContent());
            form.appendField(this.createFieldEndDate());
            // form.appendField(this.createFieldDisplayToAll());
            if (typeof this.announcement.title === 'string') {
                form.appendActionButton(this.createActionDelete());
            } else {
                form.appendActionButton(this.createActionCancel());
            }
            form.appendActionButton(this.createActionSave());

            this.fieldContent.setValue(this.announcement.content || '');

            return form;
        },
        createModal: function() {
            return new Modal(this.form.getElement());
        },
        displayError: function (error) {
            this.removeErrors();

            if (error && error.code) {
                this.displayErrorByCode(error);
            } else {
                this.form.showError(i18n.__('chat.error.unexpected_error'));
                wglog.debug('AnnonuncementFormView::displayError error:', error);
                wglog.error('AnnouncementFormView::displayError unexpected error received', '');
            }

            this.pendingModal.close();
            this.formModal.show();
        },
        displayErrorByCode: function (error) {
            switch (error.code) {
                case 66803: // Invalid parameter title
                    this.fieldTitle.setError(i18n.__('chat.vault.invalid_value'));
                    break;
                case 66804: // Invalid parameter content
                    this.fieldContent.setError(i18n.__('chat.vault.invalid_value'));
                    break;
                case 66805: // Invalid parameter end date
                    this.fieldEndDate.setError(i18n.__('chat.vault.invalid_value'));
                    break;
                case 66806: // Failed
                    this.form.showError(i18n.__(error.message, error.params));
                    break;
                default:
                    wglog.debug('AnnonuncementFormView::displayErrorByCode error:', error);
                    wglog.error('AnnouncementFormView::displayErrorByCode unexpected error received', '');
                    this.form.showError(i18n.__('chat.error.unexpected_error') + ` (${error.code})`);
            }
        },
        formatDateServerString: function (date) {
            var localDate = new Date(date),
                iso = localDate.toISOString(),
                [datePart, timePart] = iso.split('T'),
                time = timePart.split('.')[0];
            return `${datePart} ${time}`;
        },
        formatDateLocaleFieldString: function(date) {
            var utcDate = new Date(date.replace(' ', 'T') + 'Z'),
                year = utcDate.getFullYear(),
                month = String(utcDate.getMonth() + 1).padStart(2, '0'),
                day = String(utcDate.getDate()).padStart(2, '0'),
                hours = String(utcDate.getHours()).padStart(2, '0'),
                minutes = String(utcDate.getMinutes()).padStart(2, '0');

            return `${year}-${month}-${day}T${hours}:${minutes}`;
        },
        getFormData: function() {
            var formData = new FormData(this.form.getFormElement()),
                entries = Object.fromEntries(formData);

            if (this.announcement.id) {
                entries.id = this.announcement.id;
            }

            if (entries.hasOwnProperty('end_date')) {
                entries.end_date = this.formatDateServerString(entries.end_date);
            }

            if (entries.hasOwnProperty('display_to_all')) {
                entries.display_to_all = 1;
            }

            return entries;
        },
        getMinDate: function () {
            var date = new Date();
            date.setDate(date.getDate() + 1);
            date.setHours(12, 0, 0, 0);
            return date.toDatetimeString();
        },
        removeErrors: function() {
            this.fieldTitle.removeError();
            this.fieldContent.removeError();
            this.fieldEndDate.removeError();
            this.form.hideError();
        },
        onClickActionCancel: function (event) {
            this.formModal.close();
        },
        onClickActionDelete: function (event) {
            this.mediator.emitDeleteAnnouncement(this.announcement.id);
        },
        onClickActionSave: function (event) {
            if (this.validateForm()) {
                this.formModal.hide();
                this.askForConfirmation();
            }
        },
        onClickConfirmationNo: function (event) {
            this.formModal.show();
        },
        onClickConfirmationOk: function (event) {
            this.showPendingModal();
            this.saveAnnouncement();
        },
        showPendingModal: function () {
            this.pendingModal = new Modal(
                `<p class="text-center" style="margin-bottom: 1.5em; color: var(--scc-secondary); font-weight: bold">${i18n.__('misc.saving')}</p>`,
                {closable: false}
            );
        },
        closeAllModal: function () {
            if (this.formModal) {
                this.formModal.close();
            }
            if (this.pendingModal) {
                this.pendingModal.close();
            }
        },
        saveAnnouncement: function () {
            this.mediator.emitSaveAnnouncement(this.getFormData());
        },
        validateForm: function () {
            var data = this.getFormData(),
                result = true;

            if (typeof data.title !== "string" || data.title.length === 0) {
                this.fieldTitle.setError(i18n.__('chat.vault.invalid_value'));
                result = false;
            }

            if (typeof data.content !== "undefined" && typeof data.content !== "string") {
                this.fieldContent.setError(i18n.__('chat.vault.invalid_value'));
                result = false;
            }

            if (typeof data.end_date !== "string" || !data.end_date.match(/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$/)) {
                this.fieldEndDate.setError(i18n.__('chat.vault.invalid_value'));
                return;
            }

            return result;
        }
    });

    return AnnouncementFormView;
});
define('features/SupportAnnouncement/commands/OpenForm',[
    'core/Command',
    'features/SupportAnnouncement/models/SupportAnnouncementModel',
    'features/SupportAnnouncement/views/AnnouncementFormView',
], function(
    Command,
    SupportAnnouncementModel,
    AnnouncementFormView
) {
    var OpenForm = function(context) {
        Command.call(this, context);
    };

    OpenForm.prototype = Object.create(Command.prototype);

    Object.assign(OpenForm.prototype, {
        execute: function () {
            new AnnouncementFormView(SupportAnnouncementModel.last());
        }
    });

    return OpenForm;
});
define('features/SupportAnnouncement/commands/SaveAnnouncement',[
    'core/Command',
    'services/SocketConnection',
    'services/SocketConnectionEvent'
], function(
    Command,
    SocketConnection,
    SocketConnectionEvent
) {
    var SaveAnnouncement = function(context) {
        Command.call(this, context);
    };

    SaveAnnouncement.prototype = Object.create(Command.prototype);

    Object.assign(SaveAnnouncement.prototype, {
        execute: function (data) {
            SocketConnection.emit(SocketConnectionEvent.out.SAVE_ANNOUNCEMENT, data);
        }
    });

    return SaveAnnouncement;
});

define('text!features/SupportAnnouncement/views/SidebarButton.mustache',[],function () { return '<div id="{{wrapperId}}" class="chat-sidebar__header-action-wrapper">\n    <button type="button" class="btn btn--flat chat-sidebar__header-action chat-sidebar__header-action--support-announcement" title="{{buttonTitle}}"></button>\n</div>';});

define('features/SupportAnnouncement/views/SidebarButtonView',[
    'core/View',
    'text!features/SupportAnnouncement/views/SidebarButton.mustache',
    'lib/i18n!front'
], function(
    View,
    template,
    i18n
) {
    var WRAPPER_ID = 'support-announcement-button-wrapper';

    var PARENT_SELECTOR = '.chat-sidebar__top';

    var EVENT_NAMESPACE = 'support-announcement-sidebar-button';

    var SidebarButtonView = function() {
        this.template = template;
        View.call(this);
    };

    SidebarButtonView.prototype = Object.create(View.prototype);

    Object.assign(SidebarButtonView.prototype, {
        addListeners: function() {
            this.addElementListener('button', 'click', this.handleClick, EVENT_NAMESPACE, this);
        },
        createElement: function () {
            View.prototype.createElement.call(this);

            var parent = this.getParentElement();

            if (parent) {
                parent.append(this.element);
            }
        },
        getForcedTemplateParams: function () {
            return {
                buttonTitle: i18n.__('chat.announcement'),
                wrapperId: WRAPPER_ID,
            };
        },
        getParentElement: function () {
            return document.querySelector(PARENT_SELECTOR);
        },
        handleClick: function (event) {
            this.mediator.openForm();
        }
    });

    return SidebarButtonView;
});
define('features/SupportAnnouncement/commands/SetupSidebarButton',[
    'config/chat',
    'core/Command',
    'features/SupportAnnouncement/views/SidebarButtonView',
], function(
    Config,
    Command,
    SidebarButtonView
) {
    var ALLOWED_USERS = [42275621, 43038155, 43405136];

    var SetupSidebarButton = function(context) {
        Command.call(this, context);
    };

    SetupSidebarButton.prototype = Object.create(Command.prototype);

    Object.assign(SetupSidebarButton.prototype, {
        execute: function () {
            if (ALLOWED_USERS.indexOf(+Config.login_info.id) === -1) {
                return;
            }

            new SidebarButtonView();
        }
    });

    return SetupSidebarButton;
});
define('features/SupportAnnouncement/views/AnnouncementFormMediator',[
    'core/Mediator',
    'features/SupportAnnouncement/events/SupportAnnouncementEvent'
], function(
    Mediator,
    SupportAnnouncementEvent
) {
    var AnnouncementFormMediator = function(view, context, mediatorMap) {
        Mediator.call(this, view, context, mediatorMap);
    };

    AnnouncementFormMediator.prototype = Object.create(Mediator.prototype);

    Object.assign(AnnouncementFormMediator.prototype, {
        onAnnouncementDeleted: function () {
            this.view.closeAllModal();
        },
        onAnnouncementSaved: function () {
            this.view.closeAllModal();
        },
        onSaveAnnouncementError: function (error) {
            this.view.displayError(error);
        },
        emitDeleteAnnouncement: function (announcementId) {
            this.context.emit(SupportAnnouncementEvent.DELETE_ANNOUNCEMENT, announcementId);
        },
        emitSaveAnnouncement: function (data) {
            this.context.emit(SupportAnnouncementEvent.SAVE_ANNOUNCEMENT, data);
        }
    });

    return AnnouncementFormMediator;
});
define('features/SupportAnnouncement/views/AnnouncementMediator',[
    'core/Mediator',
    'features/SupportAnnouncement/events/SupportAnnouncementEvent'
], function(
    Mediator,
    SupportAnnouncementEvent
) {
    var AnnouncementMediator = function(view, context, mediatorMap) {
        Mediator.call(this, view, context, mediatorMap);
    };

    AnnouncementMediator.prototype = Object.create(Mediator.prototype);

    Object.assign(AnnouncementMediator.prototype, {
        onAnnouncementDeleted: function () {
            this.view.removeExistent();
        },
    });

    return AnnouncementMediator;
});
define('features/SupportAnnouncement/views/SidebarButtonMediator',[
    'core/Mediator',
    'features/SupportAnnouncement/events/SupportAnnouncementEvent'
], function(
    Mediator,
    SupportAnnouncementEvent
) {
    var SidebarButtonMediator = function(view, context, mediatorMap) {
        Mediator.call(this, view, context, mediatorMap);
    };

    SidebarButtonMediator.prototype = Object.create(Mediator.prototype);

    Object.assign(SidebarButtonMediator.prototype, {
        openForm: function () {
            this.context.emit(SupportAnnouncementEvent.OPEN_FORM);
        }
    });

    return SidebarButtonMediator;
});
define('features/SupportAnnouncement/SupportAnnouncementMapper',[
    'chat/ManagerEvent',
    'features/SupportAnnouncement/commands/AnnouncementDeleted',
    'features/SupportAnnouncement/commands/AnnouncementReceived',
    'features/SupportAnnouncement/commands/CloseForm',
    'features/SupportAnnouncement/commands/DeleteAnnouncement',
    'features/SupportAnnouncement/commands/GetAnnouncement',
    'features/SupportAnnouncement/commands/OpenForm',
    'features/SupportAnnouncement/commands/SaveAnnouncement',
    'features/SupportAnnouncement/commands/SetupSidebarButton',
    'features/SupportAnnouncement/events/SupportAnnouncementEvent',
    'features/SupportAnnouncement/views/AnnouncementFormMediator',
    'features/SupportAnnouncement/views/AnnouncementFormView',
    'features/SupportAnnouncement/views/AnnouncementMediator',
    'features/SupportAnnouncement/views/AnnouncementView',
    'features/SupportAnnouncement/views/SidebarButtonMediator',
    'features/SupportAnnouncement/views/SidebarButtonView',
    'services/SocketConnection',
    'services/SocketConnectionEvent'

], function(
    ManagerEvent,
    AnnouncementDeletedCommand,
    AnnouncementReceivedCommand,
    CloseFormCommand,
    DeleteAnnouncementCommand,
    GetAnnouncementCommand,
    OpenFormCommand,
    SaveAnnouncementCommand,
    SetupSidebarButtonCommand,
    SupportAnnouncementEvent,
    AnnouncementFormMediator,
    AnnouncementFormView,
    AnnouncementMediator,
    AnnouncementView,
    SidebarButtonMediator,
    SidebarButtonView,
    SocketConnection,
    SocketConnectionEvent
) {
    return function(context) {
        context.commandMap.mapEvent(ManagerEvent.NODE_CREATED, SetupSidebarButtonCommand);
        context.commandMap.mapEvent(ManagerEvent.USER_CONNECTED, GetAnnouncementCommand);

        context.commandMap.mapEvent(SupportAnnouncementEvent.ANNOUNCEMENT_DELETED, AnnouncementDeletedCommand);
        context.commandMap.mapEvent(SupportAnnouncementEvent.ANNOUNCEMENT_FOUND, AnnouncementReceivedCommand);
        context.commandMap.mapEvent(SupportAnnouncementEvent.ANNOUNCEMENT_SAVED, AnnouncementReceivedCommand);
        context.commandMap.mapEvent(SupportAnnouncementEvent.CLOSE_FORM, CloseFormCommand);
        context.commandMap.mapEvent(SupportAnnouncementEvent.DELETE_ANNOUNCEMENT, DeleteAnnouncementCommand);
        context.commandMap.mapEvent(SupportAnnouncementEvent.OPEN_FORM, OpenFormCommand);
        context.commandMap.mapEvent(SupportAnnouncementEvent.SAVE_ANNOUNCEMENT, SaveAnnouncementCommand);

        context.mediatorMap.mapEvent(SupportAnnouncementEvent.ANNOUNCEMENT_DELETED, AnnouncementMediator, 'onAnnouncementDeleted');
        context.mediatorMap.mapEvent(SupportAnnouncementEvent.ANNOUNCEMENT_DELETED, AnnouncementFormMediator, 'onAnnouncementDeleted');
        context.mediatorMap.mapEvent(SupportAnnouncementEvent.ANNOUNCEMENT_SAVED, AnnouncementFormMediator, 'onAnnouncementSaved');
        context.mediatorMap.mapEvent(SupportAnnouncementEvent.SAVE_ANNOUNCEMENT_ERROR, AnnouncementFormMediator, 'onSaveAnnouncementError');

        context.mediatorMap.mapView(AnnouncementView, AnnouncementMediator);
        context.mediatorMap.mapView(AnnouncementFormView, AnnouncementFormMediator);
        context.mediatorMap.mapView(SidebarButtonView, SidebarButtonMediator);

        SocketConnection.forwardIncomingEvent(SocketConnectionEvent.in.ANNOUNCEMENT_DELETED, SupportAnnouncementEvent.ANNOUNCEMENT_DELETED);
        SocketConnection.forwardIncomingEvent(SocketConnectionEvent.in.ANNOUNCEMENT_FOUND, SupportAnnouncementEvent.ANNOUNCEMENT_FOUND);
        SocketConnection.forwardIncomingEvent(SocketConnectionEvent.in.ANNOUNCEMENT_SAVED, SupportAnnouncementEvent.ANNOUNCEMENT_SAVED);
        SocketConnection.forwardIncomingEvent(SocketConnectionEvent.in.SAVE_ANNOUNCEMENT_ERROR, SupportAnnouncementEvent.SAVE_ANNOUNCEMENT_ERROR);
    };
});
define('features/Uploader/commands/MassMessageSetUploaderAsAttachmentService',[
	'config/chat',
	'core/Command',
	'features/CreatorMessages/MassMessage/events/MassMessageEvent',
	'lib/i18n!front',
	'libs/EventEmitter'
], function(
	Config,
	Command,
	MassMessageEvent,
	i18n,
	EventEmitter
) {
	var SetUploaderAsAttachmentServiceCommand = function(context, commandMap, mediatorMap) {
		Command.call(this, ...arguments);
	};

	SetUploaderAsAttachmentServiceCommand.prototype = Object.create(Command.prototype);

	Object.assign(SetUploaderAsAttachmentServiceCommand.prototype, {
		execute: function () {
			EventEmitter.emit(MassMessageEvent.ADD_CONTENT_SERVICE, {
				isActive: true,
				systemName: 'uploader-' + Math.random().toString(32).substring(2),
				iconId: 'scc-file-sharing-icon',
				label: i18n.__('chat.local_file'),
				field: '<div id="chat-creator-messages-files">Uploader</div>',
				position: 0
			});
		}
	});

	return SetUploaderAsAttachmentServiceCommand;
});
define('features/Uploader/commands/AutoMessageSetUploaderAsAttachmentService',[
	'config/chat',
	'core/Command',
	'features/CreatorMessages/AutoMessage/events/AutoMessageEvent',
	'lib/i18n!front',
	'libs/EventEmitter'
], function(
	Config,
	Command,
	AutoMessageEvent,
	i18n,
	EventEmitter
) {
	var SetUploaderAsAttachmentServiceCommand = function(context, commandMap, mediatorMap) {
		Command.call(this, ...arguments);
	};

	SetUploaderAsAttachmentServiceCommand.prototype = Object.create(Command.prototype);

	Object.assign(SetUploaderAsAttachmentServiceCommand.prototype, {
		execute: function () {
			EventEmitter.emit(AutoMessageEvent.ADD_CONTENT_SERVICE, {
				isActive: true,
				systemName: 'uploader-' + Math.random().toString(32).substring(2),
				iconId: 'scc-file-sharing-icon',
				label: i18n.__('chat.local_file'),
				field: '<div id="chat-creator-messages-files">Uploader</div>',
				position: 0
			});
		}
	});

	return SetUploaderAsAttachmentServiceCommand;
});
define('features/Uploader/UploaderMapper',[
	'features/CreatorMessages/MassMessage/events/MassMessageEvent',
	'features/CreatorMessages/AutoMessage/events/AutoMessageEvent',
	'features/Uploader/commands/MassMessageSetUploaderAsAttachmentService',
	'features/Uploader/commands/AutoMessageSetUploaderAsAttachmentService'
], function(
	MassMessageEvent,
	AutoMessageEvent,
	MassMessageSetUploaderAsAttachmentServiceCommand,
	AutoMessageSetUploaderAsAttachmentServiceCommand
) {
	return function(context) {
		context.commandMap.mapEvent(MassMessageEvent.READY, MassMessageSetUploaderAsAttachmentServiceCommand);
		context.commandMap.mapEvent(AutoMessageEvent.READY, AutoMessageSetUploaderAsAttachmentServiceCommand);
	};
});
define('features/initFeatures',[
    'config/chat',
    'features/ContactList/ContactListMapper',
    'features/ContactList/events/ContactListEvent',
    'features/ContactList/CustomerList/CustomerListMapper',
    'features/ContactList/FollowerList/FollowerListMapper',
    'features/ContactList/SupportList/SupportListMapper',
    'features/Content/ContentMapper',
    'features/Draft/DraftMapper',
    'features/FanInfo/FanInfoMapper',
    'features/Lightbox/LightboxMapper',
    'features/CreatorMessages/CreatorMessagesMapper',
    'features/CreatorMessages/MassMessage/MassMessageMapper',
    'features/CreatorMessages/AutoMessage/AutoMessageMapper',
    'features/Message/MessageMapper',
    'features/PageSession/PageSessionMapper',
    'features/Reminder/ReminderMapper',
    'features/Reminder/events/ReminderEvent',
    'features/Settings/SettingsMapper',
    'features/Studio/StudioMapper',
    'features/SupportAnnouncement/SupportAnnouncementMapper',
    'features/Uploader/UploaderMapper',
    'libs/EventEmitter',
], function(
    Config,
    ContactListMapper,
    ContactListEvent,
    CustomerListMapper,
    FollowerListMapper,
	SupportListMapper,
    ContentMapper,
    DraftMapper,
    FanInfoMapper,
    LightboxMapper,
    CreatorMessagesMapper,
    MassMessageMapper,
    AutoMessageMapper,
    MessageMapper,
    PageSessionMapper,
    ReminderMapper,
    ReminderEvent,
    SettingsMapper,
    StudioMapper,
    SupportAnnouncementMapper,
    UploaderMapper,
    EventEmitter
) {
    /**
     * Add listeners to link features between themselves.
     */
    function addEventListeners() {
        if (Config.login_info.is_support) {
            EventEmitter.on(ContactListEvent.CONTACT_LIST_CREATED, function () {
                EventEmitter.emit(ReminderEvent.GET_ACTIVE_REMINDERS);
            });
            EventEmitter.on(ReminderEvent.GET_CONTACTS_WITH_REMINDERS, function (data) {
                EventEmitter.emit(ContactListEvent.GET_CONTACTS_INFO, data);
            });
        }
    }

    function initMappers(context) {
        new ContactListMapper(context);
        new CustomerListMapper(context);
        new FollowerListMapper(context);
        new SupportListMapper(context);
        new ContentMapper(context);
        new DraftMapper(context);
        new FanInfoMapper(context);
        new LightboxMapper(context);
        new CreatorMessagesMapper(context);
        new MassMessageMapper(context);
        new AutoMessageMapper(context);
        new MessageMapper(context);
        new PageSessionMapper(context);
        new ReminderMapper(context);
        new SettingsMapper(context);
        new StudioMapper(context);
        new SupportAnnouncementMapper(context);
        new UploaderMapper(context);
    }

    return function (context) {
        initMappers(context);
        addEventListeners();
    }
});
define('ChatContext',[
	'core/Context',
    'features/initFeatures'
], function(
	Context,
    initFeatures
) {
	/**
	 * @extends Context
	 * @constructor
	 */
	var ChatContext = function() {
		var contextElement = document.getElementById('account-chat-private-container');
		Context.call(this, contextElement);

		this.manager = null;
		this.chatFriendManager = null;
	};

	ChatContext.prototype = Object.create(Context.prototype);

	Object.assign(ChatContext.prototype, {
		startup: function() {
            initFeatures(this);

			Context.prototype.startup.call(this);
		},
		setManager: function(manager) {
			this.manager = manager;
		},
		setChatFriendManager: function(friendManager) {
			this.chatFriendManager = friendManager;
		}
	});

	return ChatContext;
});

define('text!chat/header_feature/header_feature.mustache',[],function () { return '<div class="chat-feature-header {{feature}}">\n\t<div class="chat-feature-header__body">\n\t\t<div class="chat-feature-header__top">\n\t\t\t<button class="chat-feature-header__back btn btn--flat" type="button" id="chat-message-header-button">\n\t\t\t\t<span>{{ button_back }}</span>\n\t\t\t</button>\n\t\t\t<div class="chat-feature-header__user-info-wrapper">\n\t\t\t\t<div class="chat-feature-header__profile-wrapper">\n\t\t\t\t\t<div class="chat-feature-header__name-wrapper">\n\t\t\t\t\t\t<span class="chat-feature-header__name">{{ title }}</span>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t\t{{#select_contacts}}\n\t\t\t{{#multiple}}\n\t\t\t<div class="chat-feature-header__bottom">\n\t\t\t\t<div class="chat-feature-header__options">\n\t\t\t\t\t<div class="chat-feature-header__option chat-feature-header__option--all">\n\t\t\t\t\t\t<input type="radio" class="chat-feature-header__input chat-feature-header__input--all" name="contact_options" id="all-subs" value="all" checked>\n\t\t\t\t\t\t<label class="chat-feature-header__label" for="all-subs">{{ option_all }}<span class="chat-feature-header__nb-all">{{ nb_contacts }}</span></label>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="chat-feature-header__option chat-feature-header__option--spe">\n\t\t\t\t\t\t<input type="radio" class="chat-feature-header__input chat-feature-header__input--spe" name="contact_options" id="spe-subs" value="specific">\n\t\t\t\t\t\t<label class="chat-feature-header__label" for="spe-subs">{{ option_spe }}</label>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t{{/multiple}}\n\t\t{{/select_contacts}}\n\t</div>\n</div>';});

define('chat/header_feature/header_feature_manager',[
	'mustache',
	'text!chat/header_feature/header_feature.mustache'
], function(Mustache, tpl_header_feature) {
	var instance = null,
		HeaderFeatureManager = function() {
			this.$node = null;
			this.$header = null;
			this.sClassFeature = null;
		};

	HeaderFeatureManager.prototype = {

		init: function($node, sClass, oParams) {
			this.$node = $node;
			this.sClassFeature = sClass;
			this.$header = $(Mustache.render(tpl_header_feature, oParams));
		},

		getClassHeader: function() {
			return this.sClassFeature;
		},

		getHeader: function() {
			return this.$header;
		},

		clearChatWindow: function($node) {
			if (this.$node === null) {
				this.$node = $node;
			}
			if (this.$node.find('.chat-message-header').length) {
				this.$node.find('.chat-message-header').hide();
			}
			if (this.$header !== null) {
				this.$header.hide();
			}
			$('.chat-tab-container').hide();
		},

		clearTabs: function() {
			var sClassHeader = 'chat-window--header-message',
				sClassForm = 'chat-window--form-message';

			if (this.$node.hasClass(sClassHeader)) {
				this.$node.removeClass(sClassHeader);
			}
			if (this.$node.hasClass(sClassForm)) {
				this.$node.removeClass(sClassForm);
			}
			this.$node.find('.chat-window__message').empty();
			this.$header.hide();
		},

		setFocusBackHandler: function(fnClick) {
			var self = this;
			if (typeof fnClick === 'function') {
				this.$header.find('.chat-feature-header__back').on('click', function(event) {
					fnClick(event);
					self.clearTabs();
				});
			}
		},

		setFocusOptionHandler: function(fnOption) {
			if (typeof fnOption === 'function') {
				this.$header.find('.chat-feature-header__option').on('click', function(event) {
					fnOption(event);
				});
			}
		}
	}

	HeaderFeatureManager.getInstance = function () {
		if (instance === null) {
			instance = new HeaderFeatureManager();
		}
		return instance;
	}

	return HeaderFeatureManager.getInstance();
});

define('text!chat/select_contacts/select_contact.mustache',[],function () { return '<div class="chat-select-contact" data-id="{{id_user}}">\n\t<input type="checkbox" id="user_{{id_user}}" class="chat-select-contact__input" disabled>\n\t<label for="user_{{id_user}}" class="chat-select-contact__label">\n\t\t<div class="chat-user__avatar" title="{{{status_trad}}}">\n\t\t\t{{{avatar}}}\n\t\t</div>\n\t\t<div class="chat-user__body">\n\t\t\t<div class="chat-user__name-wrapper">\n\t\t\t\t<span class="chat-user__name" title="{{profile_name}}">{{profile_name}}</span>\n\t\t\t</div>\n\t\t\t{{#expenses}}\n\t\t\t\t{{#expenses.has_total}}\n\t\t\t\t<div class="chat-user__expense-wrapper">\n\t\t\t\t\t<span class="expense__total {{ expenses.ranking }}">\n\t\t\t\t\t\t<strong class="expense__total-amount">{{ expenses.amount_total }}</strong>\n\t\t\t\t\t\t{{#expenses.subscription_months_total_active}}\n\t\t\t\t\t\t<span class="expense__period">\n\t\t\t\t\t\t\t<span class="expense__month expense__month--active"><strong>{{ expenses.subscription_months_total_active }}</strong> {{ expenses.text_month_active }}</span> / <span class="expense__month expense__month--total"><strong>{{ expenses.subscription_months_total }}</strong> {{ expenses.text_month_total }}</span>\n\t\t\t\t\t\t</span>\n\t\t\t\t\t\t{{/expenses.subscription_months_total_active}}\n\t\t\t\t\t</span>\n\t\t\t\t</div>\n\t\t\t\t{{/expenses.has_total}}\n\t\t\t{{/expenses}}\n\t\t</div>\n\t</label>\n</div>';});

define('chat/select_contacts/select_contacts',[
	'mustache',
	'lib/i18n!front',
	'chat/attachment/attachment_manager',
	'chat/header_feature/header_feature_manager',
	'text!chat/select_contacts/select_contact.mustache'
], function(
	Mustache,
    i18n,
	attachment_manager,
	header_feature_manager,
	tpl_select_contact
) {
    var instance = null;

    var SelectContacts = function() {
        this.$node = null;
        this.chatFriendManager = null;
        this.$SelectContactsTab = null;

        this.multipleSelect = true;

		this.aContactsId = null;
		this.aContactsInfos = null;
		this.aContactsIdFiltered = null;
		this.aContactsIdSelected = null;

		this.bIsInit = false;

		this.fnCallbackHide = null;

		this.sNameId = 'select-contacts';

        this.subs_filter = null;
    };

    SelectContacts.prototype = {
		configure: function(node, friend_manager, subs_filter, multiple, button_back, title, option_spe, option_all) {
			this.bIsInit = true;
			this.chatFriendManager = friend_manager;
            this.$node = node;
            this.multipleSelect = multiple !== undefined ? multiple : true;
            this.subs_filter = subs_filter || this.filterContactsAll;

			if (this.aContactsIdFiltered !== null) {
				this.setContactsId(this.aContactsIdFiltered);
			}

			this.setInterface(button_back, title, option_spe, option_all);
        },

		setInterface: function(button_back, title, option_spe, option_all) {
			var aContactsLoadedIds = this.getContactsLoadedIds();

			if (this.multipleSelect && this.aContactsId.length > aContactsLoadedIds.length) {
				//this.chatFriendManager.get_more_friends(this.sNameId);
				console.log('Refacto contact list - get_more_friends');
				return;
			}

			if (this.aContactsInfos === null) {
				this.aContactsInfos = this.getAvailableContacts(this.getAllContactsInfos(this.aContactsId));

				if (this.aContactsInfos.length === 0) {
					return;
				}

				this.aContactsInfos.sort(function (a, b) {
					if (a.profile_name.toLowerCase() < b.profile_name.toLowerCase()) {
						return -1;
					}
					if (a.profile_name.toLowerCase() > b.profile_name.toLowerCase()) {
						return 1;
					}
					return 0;
				});
			}

			if (this.multipleSelect) {
				this.aContactsIdSelected = this.getAllContactsId(this.aContactsInfos);
			}

			var $header = header_feature_manager.getHeader();

			if ($header !== null && this.$node.find('.' + header_feature_manager.getClassHeader()).length) {
				$header.show();
			}
			else {
				//RENDER HEADER
				if ($header === null) {
					var nb_contacts = 0;
					if (this.aContactsIdSelected === null) {
						nb_contacts = 1;
					}
					else {
						if (this.aContactsIdSelected.length > 1000) {
							nb_contacts = '+1k'
						}
						else {
							nb_contacts = parseInt(this.aContactsIdSelected.length);
						}
					}
					header_feature_manager.init(this.$node, this.sNameId, {
						feature: this.sNameId,
						button_back: button_back === undefined ? i18n.__('chat.button_return_friends') : button_back,
						title: title === undefined ? i18n.__('chat.mass_message_new') : title,
						select_contacts: true,
						multiple: this.multipleSelect,
						option_spe: option_spe === undefined ? i18n.__('chat.mass_message_specific') : option_spe,
						option_all: option_all === undefined ? i18n.__('chat.mass_message_all') : option_all,
						nb_contacts: nb_contacts
					});
					header_feature_manager.setFocusBackHandler(this.focusBack.bind(this));
					if (this.multipleSelect) {
						header_feature_manager.setFocusOptionHandler(this.focusOption.bind(this));
					}
					$header = header_feature_manager.getHeader();
				}

				//NO HEADER
				if (this.$node.find('.' + header_feature_manager.getClassHeader()).length === 0) {
					this.$node.find('.chat-header-messages').append($header);
					$header.show();
				}
			}

			if (this.$SelectContactsTab !== null && this.$node.find('.' + header_feature_manager.getClassHeader()).length) {
				this.$SelectContactsTab.show();
			}
			else {
				if (this.$SelectContactsTab === null) {
					this.$SelectContactsTab = $('<div class="chat-select-contacts-tab"></div>');
				}
				if (this.$node.find('.chat-select-contacts-tab').length === 0) {
					this.$node.find('.chat-messages').append(this.$SelectContactsTab);
				}

				for (var key in this.aContactsInfos) {
					if (this.chatFriendManager.get_selected_friend_id() === this.aContactsInfos[key].id_user) {
						continue;
					}
					var $friend = $(Mustache.render(tpl_select_contact, this.aContactsInfos[key]));
					this.$SelectContactsTab.append($friend);
				}
			}

			if ($header.find('.chat-feature-header__bottom').length) {
				if (this.multipleSelect) {
					$header.find('.chat-feature-header__option--all input').prop('checked', true);
					$header.find('.chat-feature-header__nb-spe').text(0);
				} else {
					$header.find('.chat-feature-header__option--spe input').prop('checked', true);
					$header.find('.chat-feature-header__nb-spe').text(0);
				}
			}

			if (!this.multipleSelect) {
				var self = this,
					$input = this.$SelectContactsTab.find('.chat-select-contact__input');
				$input.prop('disabled', false);
				$input.on('change', function (event) {
					self.focusContact(event);
				});
			}

			attachment_manager.setVisibleServices(this.getAttachementState().services);
			attachment_manager.hide();
		},
		setContactsId: function(subs) {
			this.aContactsId = [];
			for (var id in subs) {
				if (this.aContactsId.indexOf(parseInt(subs[id])) !== - 1) {
					continue;
				}
				this.aContactsId.push(parseInt(subs[id]));
			}
		},
		setFilteredIds: function(aIdsFiltered) {
			this.aContactsIdFiltered = aIdsFiltered;
		},
		setCallbackHide : function(fn) {
			if (typeof fn === 'function') {
				this.fnCallbackHide = fn;
			}
		},

		getIsInit: function() {
			return this.bIsInit;
		},
		getContactsSelected: function() {
			return this.aContactsIdSelected;
		},
		getAllContactsId: function(subs) {
			var allSubs = [];
			for (var sub in subs) {
				allSubs.push(parseInt(subs[sub].id_user));
			}
			return allSubs;
		},
		getAllContactsInfos: function(subs) {
			var allSubs = [];
			for (var id in subs) {
				var friend = this.chatFriendManager.get_friend_infos(subs[id]);
				if (!friend) {
					continue;
				}
				allSubs.push(friend);
			}
			return allSubs;
		},
		getAvailableContacts: function(subsInfos) {
            return subsInfos.filter(this.subs_filter);
		},
		getContactsLoadedIds: function() {
			var ids;
			if(this.aContactsIdFiltered !== null) {
				ids = Object.keys(this.chatFriendManager.get_friends())
					.map(function (id) { return id.toString(); })
					.filter(function (id) { return this.aContactsIdFiltered.indexOf(id) !== -1; }, this);

			}
			else {
				ids = this.getAllContactsId(this.chatFriendManager.get_friends());
			}
			return ids;
		},
		getAttachementState: function() {
			var services = {},
				bVaultIsPresent,
				nbUserService,
				bUseVault;

			for (var friend in this.aContactsInfos) {
				var serviceSub = this.chatFriendManager.get_attachment_visible_services(this.aContactsInfos[friend]);

				if (typeof bVaultIsPresent === 'undefined' && serviceSub.length > 1 && serviceSub.indexOf('vault') !== -1) {
					bVaultIsPresent = true;
				}

				for (var service in serviceSub) {
					if (typeof services[serviceSub[service]] === 'undefined') {
						services[serviceSub[service]] = 0;
					}
					services[serviceSub[service]]++;
				}
			}

			for (var service in services) {
				if (typeof nbUserService === 'undefined') {
					nbUserService = services[service];
				}
				bUseVault = services[service] === nbUserService;
			}

			return {
				'vault_service': bVaultIsPresent,
				'vault_available': bUseVault,
				'services': Object.keys(services),
			};

		},

		filterContactsAll: function(subInfos) {
            return !subInfos.blocked && !subInfos.is_support && !subInfos.is_blocked && !subInfos.is_user_inactive;
        },

		focusBack: function(event) {
			event.preventDefault;
			this.aContactsIdSelected = null;
			this.hideSelectContact();
		},
		focusOption: function(event) {
			event.preventDefault();

			var $CurrentOption = $(event.currentTarget),
				$CurrentInput = $CurrentOption.find('input'),
				bOptionAllSubs = $CurrentInput.prop('id') === 'all-subs',
				sClassNbSubsSelected = 'chat-' + this.sNameId + '-header__nb-spe',
				$nbSubsSelected = $CurrentOption.find('.' + sClassNbSubsSelected),
				$subs = this.$SelectContactsTab.find('.chat-select-contact__input'),
				self = this;

			$CurrentInput.prop('checked', true);
			if (bOptionAllSubs) {
				this.aContactsIdSelected = this.getAllContactsId(this.aContactsInfos);
				$subs.prop({
					'checked': !bOptionAllSubs,
					'disabled': bOptionAllSubs
				});
				$subs.off('change');
				var $chatMassMessageNbSpe = $('.' + sClassNbSubsSelected);
				if ($chatMassMessageNbSpe.length > 0) {
					$chatMassMessageNbSpe.remove();
				}
			}
			else {
				this.aContactsIdSelected = [];
				$subs.prop('disabled', false);
				$subs.on('change', function(event) {
					self.focusContact(event);
				});
				if ($nbSubsSelected.length === 0) {
					$('<span class="' + sClassNbSubsSelected + '"></span>').appendTo($CurrentOption.find('.chat-' + this.sNameId + '-header__label'));
					$('.' + sClassNbSubsSelected).text(this.aContactsIdSelected.length > 1000 ? '+1k': this.aContactsIdSelected.length);
				}
			}
		},
		focusContact: function(event) {
			var $header = header_feature_manager.getHeader(),
				recipientId = parseInt($(event.currentTarget).closest('.chat-select-contact').attr('data-id'));

			if (this.aContactsIdSelected === null) {
				this.aContactsIdSelected = [];
			}
			if (this.aContactsIdSelected.indexOf(recipientId) === -1) {
                if (!this.multipleSelect) {
                    this.$SelectContactsTab.find(`.chat-select-contact__input[id!="user_${recipientId}"]`).prop('checked', false);
                    this.aContactsIdSelected = [];
                }
				this.aContactsIdSelected.push(recipientId);
			} else {
				this.aContactsIdSelected.splice(this.aContactsIdSelected.indexOf(recipientId), 1);
			}

			if ($header.find('.chat-feature-header__bottom').length) {
				if ($header.find('.chat-feature-header__nb-spe').length === 0) {
					$header.find('.chat-feature-header__option--spe .chat-feature-header__label').append('<span class="chat-feature-header__nb-spe"></span>');
				}
				$header.find('.chat-feature-header__nb-spe').text(this.aContactsIdSelected.length > 1000 ? '+1k' : this.aContactsIdSelected.length);
			}
		},

        hideSelectContact: function() {
			this.aContactsIdSelected = [];
			if (header_feature_manager.getHeader() !== null && this.$node && this.$node.find('.' + header_feature_manager.getClassHeader()).length) {
				header_feature_manager.getHeader().hide();
			}

            if (!(!!this.$SelectContactsTab) || !this.$SelectContactsTab.find) {
				return;
			}

			var $subs = this.$SelectContactsTab.find('.chat-select-contact__input');
			$subs.prop({
				'checked': false,
				'disabled': true
			});
			$subs.off('change');
			this.$SelectContactsTab.hide();

			if (typeof this.fnCallbackHide === 'function') {
				this.fnCallbackHide();
			}
        }
    };

    SelectContacts.getInstance = function () {
        if (instance === null) {
            instance = new SelectContacts();
        }

        return instance;
    }

    return SelectContacts.getInstance();
});

define('text!chat/select_messages/select_messages_actions.mustache',[],function () { return '<div id="select-messages-actions">\n    <button id="select-messages-forward" class="btn chat-btn"><span class="icon-f icf-forward"></span><span class="chat-btn-text"> {{trad.forward}}</span></button>\n</div>';});

define('chat/select_messages/select_messages',[
    'config/chat',
    'mustache',
    'lib/i18n!front',
    'chat/select_contacts/select_contacts',
    'chat/header_feature/header_feature_manager',
    'text!chat/select_messages/select_messages_actions.mustache'
], function(
    config,
    Mustache,
    i18n,
    select_contacts,
    header_feature_manager,
    tpl_select_message_actions
) {
    var instance = null;

    var SelectMessages = function() {
        this.selecting = false;
        this.selectedIds = [];
        this.messageTab = null;
        this.forwardFunc = null;
        this.forwardEndFunc = null;

        this.selectingForwardRecipient = false;

        this.node = null;
        this.chatFriendManager = null;
    };

    SelectMessages.prototype = {
        init: function(node, chatFriendManager) {
            this.node = node;
            this.chatFriendManager = chatFriendManager;
        },
        isSelecting: function() {
            return this.selecting;
        },
        getSelectedIds: function() {
            this.sortSelectedIds();
            return this.selectedIds;
        },
        startSelection: function(messageId) {
            this.selecting = true;
            this.selectingForwardRecipient = false;

            // Make all messages selectable
            this.messageTab = document.getElementById('chat_message_' + messageId).closest('.chat-tab-container');

            var messages =  this.messageTab.querySelectorAll(".chat-message__id");
            messages = Array.from(messages);
            for (var index in messages) {
				var contextMenuBtn = messages[index].querySelector('.chat-message__action--context-menu');

				if (!contextMenuBtn) {
					continue;
				}

	            contextMenuBtn.setAttribute('disabled','disabled');
                messages[index].classList.add('chat-message__selectable');
                messages[index].addEventListener('click', this.onSelectableMessageClick);
            }

            // Action bar render
            document.querySelector('.chat-message-form').style.display = "none";
            var actions = document.querySelector('.chat-messages-actions');
            actions.innerHTML = Mustache.render(tpl_select_message_actions, {
                trad: {
                    forward: i18n.__('chat.forward'),
                }
            });
            actions.style.display = "block";

            // Register buttons events
            document.getElementById('select-messages-forward').addEventListener('click', this.onForwardButtonClick);

            // Disable conversation contextual menu
            document.querySelector('#chat_friend_menu_switch').disabled = true;
        },
        stopSelection: function() {
            for (var id in this.selectedIds) {
                var selected = document.getElementById('chat_message_' + this.selectedIds[id]);
                selected.classList.remove('chat-message__selected');
                selected.removeEventListener('click', this.onSelectableMessageClick);
            }
            this.selectedIds = [];
            if (this.messageTab) {
                var selectables = this.messageTab.querySelectorAll('.chat-message__selectable');
                selectables = Array.from(selectables);
                for (var index in selectables) {
	                var contextMenuBtn = selectables[index].querySelector('.chat-message__action--context-menu');

	                if (!contextMenuBtn) {
		                continue;
	                }

                    selectables[index].classList.remove('chat-message__selectable');
	                contextMenuBtn.removeAttribute('disabled');
                    selectables[index].removeEventListener('click', this.onSelectableMessageClick);
                }
                this.messageTab = null;
            }
            document.querySelector('.chat-message-form').style.display = "block";
            document.querySelector('.chat-messages-actions').style.display = "none";
            var self = this;
            setTimeout(function() {
                self.selecting = false;
            }, 100);

	        // Enable conversation contextual menu
	        document.querySelector('#chat_friend_menu_switch').disabled = false;
        },
        addToSelection: function(messageId) {
            if (!this.selecting) {
                this.startSelection(messageId);
            }
            if (!this.isInSelected(messageId)) {
                this.selectedIds.push(messageId);
            }
            var chatMessage = document.getElementById('chat_message_' + messageId);
            chatMessage.classList.replace('chat-message__selectable', 'chat-message__selected');
        },
        removeFromSelection: function(messageId) {
            var selectedMessageIndex = this.getSelectedMessageIndex(messageId);
            if (selectedMessageIndex !== false) {
                this.selectedIds.splice(selectedMessageIndex, 1);
                document.getElementById('chat_message_' + messageId).classList.replace('chat-message__selected', 'chat-message__selectable');
            }

            if (this.selectedIds.length === 0) {
                this.stopSelection();
            }
        },
        toggleSelection: function(messageId) {
            if (this.isInSelected(messageId)) {
                this.removeFromSelection(messageId);
            } else {
                this.addToSelection(messageId);
            }
        },
        getSelectedMessageIndex: function(messageId) {
            var selectedMessageIndex = this.selectedIds.indexOf(messageId);
            if (selectedMessageIndex > -1) {
                return selectedMessageIndex;
            } else {
                return false;
            }
        },
        isInSelected: function(messageId) {
            return this.selectedIds.indexOf(messageId) > -1
        },
        sortSelectedIds: function() {
            this.selectedIds.sort(function(a, b) {
                var timeA = document.getElementById('chat_message_' + a).querySelector('.chat-message__message>.chat-message__metas time').dataset.timestamp;
                var timeB = document.getElementById('chat_message_' + b).querySelector('.chat-message__message>.chat-message__metas time').dataset.timestamp;

                return parseInt(timeA) - parseInt(timeB);
            });
        },
        // Customizable functions for events
        setForwardHandler: function(forwardFunc) {
            this.forwardFunc = forwardFunc;
        },
        setForwardEndHandler: function(forwardEndFunc) {
            this.forwardEndFunc = forwardEndFunc;
        },
        // Events, this = event target, instance = SelectMessages
        onSelectableMessageClick: function() {
            instance.toggleSelection(this.id.replace(/^chat_message_/, ''));
        },
        onForwardButtonClick: function() {
            instance.selectingForwardRecipient = !instance.selectingForwardRecipient;

            var fnFilter = function(contact) {
                return contact.is_support && contact.id_user !== 43038155 && ((config.login_info.is_support && !config.login_info.is_manager) || (config.login_info.is_manager && contact.id_user !== 43038153));
            };

            if (instance.selectingForwardRecipient) {
                header_feature_manager.clearChatWindow(instance.node);
                select_contacts.configure(
                    instance.node,
                    instance.chatFriendManager,
                    fnFilter,
                    false,
                    i18n.__('chat.button_return_conversation'),
                    i18n.__('chat.forward')
                );
                header_feature_manager.setFocusBackHandler(instance.focusBack.bind(instance));
            }
            else {
                var supportId = select_contacts.getContactsSelected();
                if (supportId === null) {
                    instance.focusBack();
                    return;
                }
                if (supportId.length === 0) {
                    instance.selectingForwardRecipient = true;
                    instance.focusBack();
                    return;
                }

                instance.forwardFunc(instance.getSelectedIds(), supportId[0]);
                if (select_contacts.getIsInit()) {
                    select_contacts.hideSelectContact();
                }
                instance.focusBack();
            }
        },
        focusBack: function() {
            if (!this.selecting) {
                return;
            }
            this.stopSelection();
            document.querySelector('.chat-message-header').style.display = '';
            document.querySelector('#chat_messages_tab_' + this.chatFriendManager.selected_friend).style.display = '';
        },
    };


    SelectMessages.getInstance = function () {
        if (instance === null) {
            instance = new SelectMessages();
        }

        return instance;
    }

    return SelectMessages.getInstance();
});
define('chat/upload/upload',[
	'config/chat',
	'lib/i18n!front',
	'lib/utils',
	'log_and_tooltip'
], function(
	config,
	i18n,
	utils,
	log_and_tooltip
) {
	var worker_crypt_path = config.workers_path + "js/workers/chat-prive-crypt-worker.js";
	var worker_decrypt_path = config.workers_path + "js/workers/chat-prive-decrypt-worker.js";

	/**
	 * Local file uploader base class.
	 * @constructor
	 */
	var Upload = function() {
		this.extensions = {
			audios: ['mp3'],
			documents: ['xls', 'xlsx', 'doc', 'docx', 'txt', 'csv', 'pdf'],
			images: ['gif', 'jpg', 'jpeg', 'png', 'webp'],
			videos: ['mp4', 'mpeg4', 'webm']
		};
		this.files = {};
		this.file_max_size_megabytes = 150;
		this.is_browser_compatible = this.resolve_browser_compatibility();
		this.socket = null;
		this.thumb_max_width = 150;
		this.thumb_max_height = 100;
		this.worker_crypt = null;
		this.worker_decrypt = null;
		this.display_message_required_keys = [];

		if (this.is_browser_compatible) {
			this.worker_crypt = new Worker(worker_crypt_path);
			this.worker_crypt.addEventListener("message", this.on_worker_crypt_message.bind(this));
			this.worker_decrypt = new Worker(worker_decrypt_path);
			this.worker_decrypt.addEventListener("message", this.on_worker_decrypt_message.bind(this));
		}
	}

	Upload.prototype = {
		add_to_conversation: function() {},

		preserveScrollDownOnImageLoad: function (message) {
			message.data('preserveScrollDownOnImageLoad', true);
		},

		alter_message_actions: function(actions, message) {},

		auto_scale: function (element) {
			if (!element) {
				return;
			}

			if (element instanceof HTMLImageElement || element instanceof HTMLVideoElement) {
				$(window).on('resize', this.scale_element.bind(this, element));
			}
		},

		calculate_aspect_ratio_fit: function(src_width, src_height, max_width, max_height) {
			var ratio = Math.min(max_width / src_width, max_height / src_height);
			return { width: src_width*ratio, height: src_height*ratio };
		},

		can_display_message: function (json) {
			for (var i = 0, l = this.display_message_required_keys.length; i < l; i++) {
				var key = this.display_message_required_keys[i],
					keys = Object.keys(json);

				if (keys.indexOf(key) === -1) {
					return false;
				}
			}

			return true;
		},

		/**
		 * Callback executed after a file has been encrypted.
		 */
		file_encrypted: function (data) {},

		/**
		 * Callback executed after a file has been decrypted.
		 */
		file_decrypted: function (data) {},

		/**
		 * Callback executed after a file thumb has been decrypted.
		 */
		file_thumb_decrypted: function (data) {},

		/**
		 * Generate a thumbnail image from an Image element.
		 */
		generate_image_thumb: function (data_uri, on_success, on_error) {
			if (typeof data_uri !== "string") {
				wglog.error("file_launch_crypt", "data_uri must be a string");
				return;
			}

			if (typeof on_success !== "function") {
				wglog.error("file_launch_crypt", "on_success must be a function");
				return;
			}

			var self = this;
			var img = $(new Image());
			img.attr("src", data_uri);
			img.attr("crossOrigin", "anonymous");
			img.on("error", function () {
				if (typeof on_error === "function") {
					on_error();
				}
				$(this).remove();
			});
			img.on("load", function () {
				var thumb = self.generate_thumb(this);
				on_success(thumb);
				$(this).remove();
			});
		},

		/**
		 * Generate a thumbnail image from aa Video element.
		 */
		generate_video_thumb: function (data_uri, on_success, on_error) {
			if (typeof data_uri !== "string") {
				wglog.error("file_launch_crypt", "data_uri must be a string");
				return;
			}

			if (typeof on_success !== "function") {
				wglog.error("file_launch_crypt", "on_success must be a function");
				return;
			}

			var count = 0;
			var self = this;
			var vid = $(document.createElement("VIDEO"));
			vid.attr("preload", "metadata");
			vid.attr("src", data_uri);
			vid.attr("crossOrigin", "anonymous");
			vid.on("error", function () {
				if (typeof on_error === "function") {
					on_error();
				}
				$(this).remove();
			});
			vid.on("canplay", function () {
				if (count === 1) {
					vid.off("canplay");
					var thumb = self.generate_thumb(this, {width: this.videoWidth, height: this.videoHeight});
					on_success(thumb);
					$(this).remove();
				}
				count++;
				// Set currentTime force the video to be buffered and canplay event will be sent again
				this.currentTime = 0.0;
			});
		},

		/**
		 * Generate a thumbnail image.
		 *
		 * @param element An HTMLElement (e.g. an image or a video)
		 * @param options {Object} Options to override
		 * @param options.max_width {number} Default: this.thumb_max_width.
		 * @param options.max_height {number} Default: this.thumb_max_height.
		 * @param options.width {number} Default: element.width.
		 * @param options.height {number} Default: element.height.
		 * @param options.mime_type {string} Default: image/png.
		 * @return {string} A data-uri string.
		 */
		generate_thumb: function (element, options) {
			var canvas = document.createElement('canvas');
			var canvas_2d = canvas.getContext("2d");

			var _options = Object.assign({
				max_width: this.thumb_max_width,
				max_height: this.thumb_max_height,
				width: element.width,
				height: element.height,
				mime_type: "image/png"
			}, options);

			canvas.width = _options.width;
			canvas.height = _options.height;

			if (_options.width > _options.max_width || _options.height > _options.max_height) {
				if ((_options.width / _options.max_width) > (_options.height / _options.max_height)) {
					canvas.width = _options.max_width;
					canvas.height = Math.round(canvas.width * _options.height / _options.width);
				} else {
					canvas.height = _options.max_height;
					canvas.width = Math.round(canvas.height * _options.width / _options.height);
				}
			}

			canvas_2d.drawImage(element, 0, 0, canvas.width, canvas.height);

			return canvas.toDataURL(_options.mime_type);
		},

		/**
		 * Get html string for the upload field.
		 */
		get_field: function() {
			return '<input type="file" id="chat-files" name="chat-files" accept="' + this.get_input_accepted_ext() + '" />';
		},

		/**
		 * Allowed extensions list formatted for an input field.
		 */
		get_input_accepted_ext: function() {
			var ext = [];
			for (const type in this.extensions) {
				for (var i = 0, l = this.extensions[type].length; i < l; i++) {
					ext.push('.' + this.extensions[type][i]);
				}
			}
			return ext.join(',');
		},

		/**
		 * Get a html representation of a file message.
		 */
		get_message_html: function(info, message_json) {
			return "html";
		},

		/**
		 * Get a string representation of a file message.
		 */
		get_message_text: function(message) {
			var filename = message.original_filename || message.filename || '';
			var icon = this.switch_file_type(filename, {
				audio: '<svg class="chat-scc"><use xlink:href="#scc-audio-icon"></use></svg> ',
				text: '<svg class="chat-scc"><use xlink:href="#scc-file-icon"></use></svg> ',
				word: '<svg class="chat-scc"><use xlink:href="#scc-word-icon"></use></svg> ',
				excel: '<svg class="chat-scc"><use xlink:href="#scc-excel-icon"></use></svg> ',
				image: '<svg class="chat-scc"><use xlink:href="#scc-image-icon"></use></svg> ',
				video: '<svg class="chat-scc"><use xlink:href="#scc-video-icon"></use></svg> ',
				default: '<svg class="chat-scc"><use xlink:href="#scc-file-icon"></use></svg> '
			});

			var msgText = utils.escapeHtml(message.text);

			return icon + (msgText || i18n.__('chat.file'));
		},

		init_socket: function(socket) {
			this.socket = socket;
		},

		is_compatible: function() {
			return this.is_browser_compatible;
		},

		make_link_decrypt_file: function() {},

		make_link_download_thumb: function() {},

		make_link_download: function() {},

		on_worker_crypt_message: function (event) {
			if (typeof event.data.type === "undefined" || event.data.type !== "crypt") {
				return;
			}

			if (typeof event.data.error !== "undefined" && event.data.error === true) {
				wglog.error("File crypt failed.", 'File crypt failed.', event.data);
				this.on_worker_crypt_message_error(event);
				log_and_tooltip.write_error({logTitle: 'Upload::on_worker_crypt_message File crypt failed', message: i18n.__('misc.error_please_retry'), closable: false});
			} else if (typeof event.data.contentCrypted !== "undefined") {
				this.file_encrypted(event.data);
			}
		},

		on_worker_crypt_message_error: function (event) {},

		on_worker_decrypt_message: function (event) {
			if (typeof event.data.type === "undefined" || event.data.type !== "decrypt") {
				return;
			}

			if (typeof event.data.error !== "undefined" && event.data.error === true) {
				wglog.error("File decrypt failed.", event.data);

				if (typeof event.data.id_div_message != "undefined") {
					if (typeof event.data.thumb == "undefined" || !event.data.thumb) {
						$("#" + event.data.id_div_message + " .chat_message").html(i18n.__("misc.error_please_retry"));
					} else {
						if (typeof event.data.key === "undefined"
							|| typeof event.data.recipient_id == "undefined"
							|| typeof event.data.id_div_message == "undefined"
							|| typeof event.data.message_obj == "undefined"
						) {
							$("#" + event.data.id_div_message + " .chat_message").html(i18n.__("misc.error_please_retry"));
						} else {
							this.make_link_decrypt_file(
								event.data.message_obj,
								event.data.recipient_id,
								event.data.id_div_message,
								event.data.key,
								event.data.timestamp
							);
						}
					}
				} else {
					log_and_tooltip.write_error({logTitle: 'Upload::on_worker_decrypt_message File decrypt failed', message: i18n.__('misc.error_please_retry'), closable: false});
				}
			} else {
				if (event.data.thumb) {
					this.file_thumb_decrypted(event.data);
				} else {
					this.file_decrypted(event.data);
				}
			}
		},

		resolve_browser_compatibility: function () {
			try {
				if (typeof File == "undefined" || !File) {
					return false;
				}

				if (typeof window.Worker == "undefined" || !window.Worker || typeof Worker == "undefined") {
					return false;
				}
			} catch (e) {
				return false;
			}

			return true;
		},

		scale_element: function (element) {
			if (!(element instanceof HTMLImageElement || element instanceof HTMLVideoElement)) {
				return;
			}

			var chat_window = $('#chat-window'),
				is_video = element instanceof HTMLVideoElement;
			var elementHeight = is_video ? element.videoHeight : element.naturalHeight,
				elementWidth = is_video ? element.videoWidth : element.naturalWidth;
			var max_height = chat_window.height() * this.max_height_percent,
				max_width = chat_window.width() * this.max_width_percent,
				dimensions = {width: elementWidth, height: elementHeight};

			if (elementWidth > max_width || elementHeight > max_height) {
				dimensions = this.calculate_aspect_ratio_fit(elementWidth, elementHeight, max_width, max_height);
			}

			$(element).height(dimensions.height);
			$(element).width(dimensions.width);
		},

		send_file: function (socket, id_user, id_recipient, file) {},

		clearMessageFormFields: function () {},
		/**
		 * Return the right value according the file type
		 * @param filename {string} A file name, a path
		 * @param options {Object}
		 * @param options.default {*} Returned value for default file.
		 * @param options.audio {*} Returned value for audio file.
		 * @param options.document {*} Returned value for document file.
		 * @param options.image {*} Returned value for image file.
		 * @param options.video {*} Returned value for video file.
		 * @return {*}
		 */
		switch_file_type: function (filename, options) {
			if (typeof filename !== "string") {
				wglog.error("switch_file_type", "filename is undefined or empty");
				return;
			}

			if (typeof options === "undefined") {
				wglog.error("switch_file_type", "options is undefined");
				return;
			}

			var ext = filename.split('.').pop();

			if (options.audio && this.extensions.audios && this.extensions.audios.indexOf(ext) >= 0) {
				return options.audio;
			} else if (options.image && this.extensions.images && this.extensions.images.indexOf(ext) >= 0) {
				return options.image;
			} else if (options.word && this.extensions.word && this.extensions.word.indexOf(ext) >= 0) {
				return options.word;
			} else if (options.excel && this.extensions.excel && this.extensions.excel.indexOf(ext) >= 0) {
				return options.excel;
			} else if (options.text && this.extensions.text && this.extensions.text.indexOf(ext) >= 0) {
				return options.text;
			} else if (options.video && this.extensions.videos && this.extensions.videos.indexOf(ext) >= 0) {
				return options.video;
			} else {
				return options.default || undefined;
			}
		}
	}

	return Upload;
});

define('text!chat/upload/upload_file_display.mustache',[],function () { return '{{#thumb_url}}<img src="{{{thumb_url}}}" />{{/thumb_url}}\n';});


define('text!chat/upload/upload_file_placeholder.mustache',[],function () { return '<div class="chat-content">\n    <div class="chat-content__thumb-wrapper chat-content__thumb-wrapper--gallery">\n        <div class="chat-content__gallery">\n        {{#galleryVisible}}\n            <a\n                class="chat-content__gallery-item chat-content__gallery-item--{{type}}"\n                href="{{url}}"\n                data-lightbox="{{galleryId}}"\n                target="_blank"\n                {{#more}} data-more="{{more}}"{{/more}}\n            >\n                {{#displayName}}\n                    <span class="chat-content__gallery-item-tag chat-content__gallery-item-tag--truncated chat-content__gallery-item-tag--top chat-content__gallery-item-tag--foreground">{{displayName}}</span>\n                {{/displayName}}\n                <span\n                    class="chat-upload-temp chat-upload-temp--{{modifier}}"\n                    {{#uuid}}data-uuid="{{uuid}}"{{/uuid}}\n                    {{#tid}}data-tid="{{tid}}"{{/tid}}\n                    {{#name}}data-name="{{name}}"{{/name}}\n                    {{#originalName}}data-original-name="{{originalName}}"{{/originalName}}\n                    {{#ext}}data-ext="{{ext}}"{{/ext}}\n                    {{#thumb}}data-thumb="{{thumb}}"{{/thumb}}\n                    {{#timestamp}}data-timestamp="{{timestamp}}"{{/timestamp}}\n                ></span>\n            </a>\n        {{/galleryVisible}}\n        </div>\n        {{#galleryInvisible}}\n            <a\n                class="chat-content__gallery-item chat-content__gallery-item--hidden"\n                href="{{url}}"\n                data-lightbox="{{galleryId}}"\n                target="_blank"\n                download="{{filename}}"\n            >\n                <span\n                    class="chat-upload-temp chat-upload-temp--{{modifier}}"\n                    {{#uuid}}data-uuid="{{uuid}}"{{/uuid}}\n                ></span>\n            </a>\n        {{/galleryInvisible}}\n    </div>\n    {{#text}}\n    <div class="chat-content__inner">\n        <p>{{text}}</p>\n    </div>\n    {{/text}}\n</div>\n\n';});

define('chat/upload/upload_default',[
	'config/chat',
	'log_and_tooltip',
	'chat/scroll_conversation/scroll_conversation',
	'chat/upload/upload',
	'lib/cookies',
	'lib/helpers/overlay',
	'lib/i18n!front',
	'lib/tools',
	'lib/utils',
	'mustache',
	'text!chat/upload/upload_file_display.mustache',
	'text!chat/upload/upload_file_placeholder.mustache'
], function (
	config,
	log_and_tooltip,
	scroll_conversation,
	upload,
	cookies,
	overlay,
	i18n,
	tools,
	utils,
	Mustache,
	tpl_file_display,
	tpl_file_placeholder
) {
	var name = "default";

	var upload_default = function (
		make_real_message_fct,
		get_last_conv_key_fct,
		message_for_upload_progress_bar_fct,
		format_timestamp_fct,
		format_timestamp_relative_fct,
		chat_init_prefs
	) {
		upload.call(this);

		this.allowedTypes = ['png', 'jpg', 'jpeg', 'gif', 'mp4', 'avi', 'mkv'];
		this.extensions = {"images": ['png', 'jpg', 'jpeg', 'gif'], "videos": ['mp4', 'avi', 'mkv']};
		this.file_max_size_megabytes = 150;
		this.chat_init_prefs = chat_init_prefs;
		this.make_real_message_fct = make_real_message_fct;
		this.get_last_conv_key_fct = get_last_conv_key_fct;
		this.message_for_upload_progress_bar_fct = message_for_upload_progress_bar_fct;
		this.format_timestamp_fct = format_timestamp_fct;
		this.format_timestamp_relative_fct = format_timestamp_relative_fct;
		this.preloader = $("#chat-photos-preloader");
		this.display_message_required_keys = ["type", "filename", "extension", "thumb", "size", "original_filename"];
		this.temp_modifier = name;
		this.expire_time_min = 4 * 24 * 3600 * 1000;
	};

	upload_default.prototype = Object.create(upload.prototype);

	upload_default.prototype.init = function() {
		$('#chat-window').on('message-added', this.on_message_added.bind(this));
	}

	upload_default.prototype.init_input_file = function() {
		if (this.allowedTypes.length > 0) {
			$("#chat-file").attr("accept", "." + this.allowedTypes.join(',.'));
		}

		$("#chat-send-file").on("click", function(event) {
			$("#chat-file").click();
		});

		var self = this;
		$("#chat-file").on("change", function(event) {
			var files = $(this)[0].files;

			if ( typeof files == "undefined" || typeof files == "undefined" || typeof files[0] == "undefined") {
				return;
			}

			var file = files[0];

			var popup_options = {};
			popup_options.position = { v: 'above', h: 'right', trigger: false };

			var filename = self.sanitize_filename(file.name);

			var text_popup = '<p>' + i18n.__('chat.confirm_send_file', {"%filename%": filename}) + "</p>";
			text_popup += '<p id="chat_popup_buttons"><button id="chat_popup_send_file_send">' + i18n.__('misc.OK') + '</button><button id="chat_popup_send_file_cancel">' + i18n.__('misc.cancel') + '</button></p>';

			log_and_tooltip.popup_open( $("#chat-send-file") , text_popup,popup_options );

			$( "#chat_popup_send_file_send" ).on("click", function() {
				log_and_tooltip.popup_close();

				//prevent double click
				if ( filename == self.last_file_uploaded.filename && self.chat_friend_manager.selected_friend == self.last_file_uploaded.friend
					&& typeof self.last_file_uploaded.timestamp == "number" && ((new Date()).getTime() - self.last_file_uploaded.timestamp < 2000) ) {
					return;
				}
				self.last_file_uploaded.filename = filename;
				self.last_file_uploaded.friend = self.chat_friend_manager.selected_friend;
				self.last_file_uploaded.timestamp =  (new Date()).getTime();

				self.send_file(self.socket_connection, self.id_user, self.chat_friend_manager.selected_friend, file);
			});
			$( "#chat_popup_send_file_cancel" ).on("click", function() {
				log_and_tooltip.popup_close();
			});

		});
	}
	upload_default.prototype.init_drag_drop = function() {
		var uploader = null;

		if (this.is_compatible()) {
			uploader = document.getElementById('chat-drag-file');
		}

		if (uploader) {
			var self = this;
			if (uploader) {
				uploader.addEventListener("dragenter", function (e) {
					e.preventDefault();
					e.stopPropagation();
					if (!self.chat_friend_manager.selected_friend || $(".chat-window").hasClass("chat-window--home")) {
						return;
					}
					$("#chat-drag-file-overlay").show();
				});
				uploader.addEventListener("dragover", function (e) {
					e.preventDefault();
					e.stopPropagation();
					if (!self.chat_friend_manager.selected_friend || $(".chat-window").hasClass("chat-window--home")) {
						return;
					}
				});
				uploader.addEventListener("dragleave", function (e) {
					e.preventDefault();
					e.stopPropagation();
					if (!self.chat_friend_manager.selected_friend || $(".chat-window").hasClass("chat-window--home")) {
						return;
					}
				});
				uploader.addEventListener("dragend", function (e) {
					e.preventDefault();
					e.stopPropagation();
					if (!self.chat_friend_manager.selected_friend || $(".chat-window").hasClass("chat-window--home")) {
						return;
					}
				});
				uploader.addEventListener("dragexit", function (e) {
					e.preventDefault();
					e.stopPropagation();
					if (!self.chat_friend_manager.selected_friend || $(".chat-window").hasClass("chat-window--home")) {
						return;
					}
					$("#chat-drag-file-overlay").hide();
				});
				uploader.addEventListener("drop", function (e) {
					e.preventDefault();
					e.stopPropagation();
					if (!self.chat_friend_manager.selected_friend || $(".chat-window").hasClass("chat-window--home")) {
						return;
					}
					$("#chat-drag-file-overlay").hide();
					if (typeof e.dataTransfer != "undefined" && typeof e.dataTransfer.files != "undefined" && e.dataTransfer.files.length > 0) {
						self.send_file(self.socket, self.id_user, self.chat_friend_manager.selected_friend, e.dataTransfer.files[0]);
					}

				});
			}
		}
	}

	upload_default.prototype.init_socket = function(socket) {
		upload.prototype.init_socket.call(this, socket);

		this.socket.on("get_token_send_file", this.get_token_send_file.bind(this));
		this.socket.on("xv_file_url", this.xv_file_url.bind(this));

		this.socket.init_send_file = true;
	}

	upload_default.prototype.on_worker_crypt_message = function (event) {
		upload.prototype.on_worker_crypt_message.call(this, event);

		if (typeof event.data.type !== "undefined"
			&& event.data.type === "progress"
			&& typeof event.data.pourcent !== "undefined"
			&& typeof event.data.id_file !== "undefined"
			&& typeof event.data.id_recipient !== "undefined"
		) {
			self.progress_bar_pourcent(event.data.id_file, event.data.pourcent);
		}
	}

	/**
	 * Send data to upload server.
	 * @param data
	 */
	upload_default.prototype.file_encrypted = function (data) {
		if (!data.id_file || !data.contentCrypted) {
			wglog.error("file_encrypted", "encrypt failed");
			this.popup_error_please_retry();
			return;
		}

		if (!data.contentCryptedThumb) {
			data.contentCryptedThumb = "";
		}

		var self = this;
		var xhr = new XMLHttpRequest();

		xhr.open('POST', window.location.protocol + '//' + config.server_upload + '/chat_ajax/upload_file');

		xhr.addEventListener('load', function() {
			try {
				var response = JSON.parse(xhr.response);
			} catch (e) {
				self.progress_bar_delete(data.id_file);
				self.popup_error_please_retry();
				wglog.error("ajax upload", e.message);
				return;
			}

			if (!response || !response.result || !response.file_id || !response.filename || !response.recipient || !response.extension || typeof response.thumb != "boolean" || !response.original_filename) {
				self.progress_bar_delete(data.id_file);
				var overlayCrypted = overlay.get($('body > .chat-external-overlay-container'), true, 'hide');
				overlayCrypted.setContent(i18n.__("misc.error_please_retry")).show();
				return;
			}

			var size = 0;
			if ( typeof self.files[response.file_id] == "object" && typeof self.files[response.file_id]['size'] == "number") {
				size = self.files[response.file_id]['size'];
			}

			var message_obj = {
				"type": "upload",
				"filename" : response.filename,
				"extension" : response.extension,
				"thumb" : response.thumb,
				"size" : size,
				"original_filename": response.original_filename
			};

			self.progress_bar_delete(data.id_file);

			var crypted_message = self.make_real_message_fct( JSON.stringify(message_obj), response.recipient );

			self.socket.emit("send_message", {
				'message': crypted_message,
				'recipient_id': response.recipient,
				'is_file': true
			});

			delete self.files[response.file_id];
		});

		xhr.upload.addEventListener('progress', function(e) {
			var pourcent = Math.round( e.loaded * 100 / e.total );
			self.progress_bar_pourcent(data.id_file, pourcent, i18n.__("chat.file_uploading"));
		});

		xhr.addEventListener('error', function(e) {
			wglog.error("upload XHR ERROR", e);

			self.progress_bar_delete(data.id_file);
			self.popup_error_please_retry();
			return;
		});

		var form = new FormData();
		form.append('token', this.files[data.id_file]['token']);
		form.append('file_id', data.id_file);
		form.append('file', data.contentCrypted);
		form.append('file_thumb', data.contentCryptedThumb);
		form.append('check_cookie', cookies.get( config.cookie_name ));
		xhr.send(form);
	}

	upload_default.prototype.on_worker_crypt_message_error = function (event) {
		if ( typeof event.data.id_file != "undefined" ) {
			this.progress_bar_delete(event.data.id_file);
		}
	}

	upload_default.prototype.check_for_upload = function(msg_obj, message, user_id, recipient_id, id_div_message, key, not_read, timestamp) {
		var message_obj;
		try {
			message_obj = JSON.parse(message);
		} catch (e) {
			return;
		}

		if ( typeof message_obj.type != "string" || message_obj.type != "upload" ) {
			return;
		}

		if (typeof message_obj.filename != "string" || typeof message_obj.extension != "string" || typeof message_obj.thumb != "boolean"
			|| typeof message_obj.size != "number" || typeof message_obj.original_filename != "string") {
			wglog.error("message type upload with bad data", message_obj);
			//remplacer le message par une erreur ?
			return;
		}

		if (  (new Date()).getTime() > ( (timestamp + this.upload_expire_time) *1000 )  ) {
			//expired
			msg_obj.find('.chat_message_report').html('{"type":"upload","verif":"file uploaded in chat", "file_broken": true}');
			var message = '<div class="upload_image_div"><div class="icon-f icf-file-broken"></div>' + i18n.__("chat.file_expired") + '</div>';
			msg_obj.find('.chat_message').html( message );
			msg_obj.find('.chat_message').css("text-align","center");
			return;
		}

		if (!this.is_compatible()) {
			msg_obj.find('.chat_message').html(   i18n.__("chat.file_friend_sent") + " " + i18n.__('misc.device_not_compatible') );
			return;
		}

		if (message_obj.thumb) {
			msg_obj.find('.chat_message_report').html('{"type":"upload","verif":"file uploaded in chat"}');
			msg_obj.find('.chat_message').html( this.progress_bar_create_html(id_div_message, $("#" + id_div_message + " .chat_message"), i18n.__("chat.file_loading")) );
			this.load_thumb(message_obj, recipient_id, id_div_message, key, timestamp);
		} else {
			this.make_link_decrypt_file(message_obj, recipient_id, id_div_message, key, timestamp, msg_obj);
		}
	}

	upload_default.prototype.make_link_decrypt_file = function(message_obj, recipient_id, id_div_message, key, timestamp, msg_obj) {

		var container;
		if ( typeof msg_obj !== "undefined" ) {
			container = msg_obj.find(".chat_message");
			msg_obj.find('.chat_message_report').html('{"type":"upload","verif":"file uploaded in chat"}');
		} else {
			container = $("#" + id_div_message + " .chat_message");
			$("#" + id_div_message + " .chat_message_report").html('{"type":"upload","verif":"file uploaded in chat"}');
		}

		var self = this;
		var message_load = '<div class="upload_image_div"><a>' + i18n.__( "chat.file_load") + '</a>';

		if (  (new Date()).getTime() < ( (timestamp + this.upload_expire_time) *1000 )  ) {
			var expire_in = tools.formatDuration( (timestamp + this.upload_expire_time) - ((new Date()).getTime() / 1000) );
			message_load += "<div>" + i18n.__( "chat.file_expire_in", {"%duration%": expire_in }) + "</div></div>";
		}

		container.html( message_load );
		container.find("a").on("click", function(event) {
			$("#" + id_div_message + " .chat_message").html('');
			self.get_file(message_obj, recipient_id, id_div_message, key, timestamp, false);
		});
	}

	upload_default.prototype.make_link_download_thumb = function(id_div_message, message_obj, content, container) {
		container.append('<div class="chat-upload-download"><div>' + tools.formatFileSize(message_obj.size) + '</div><span class="icon-f icf-download" title="' + i18n.__('misc.download') + '"></span></div>');

		var self = this;
		container.find(".chat-upload-download span").on("click", function(event) {
			event.preventDefault();

			$(this).parent().parent().find("span.icf-download").toggle();
			var self_link = $(this);
			setTimeout(function() {
				self_link.parent().parent().find("span.icf-download").show();
			},1000);

			var blob = self.data_uri_to_blob(content);
			self.save_file_on_disk(blob, message_obj.filename);
		});
	}

	upload_default.prototype.make_link_download = function(id_div_message, message_obj, content, cant_display) {
		var self = this;
		var message = "<span><a>" + i18n.__("chat.file_download", {"%size%": tools.formatFileSize(message_obj.size)}) + "</a></span>";
		if (cant_display) {
			message = "<span>" + i18n.__("chat.file_unable_display", {"%start_link%": "<a>", "%end_link%": "</a>", "%size%": tools.formatFileSize(message_obj.size) }) + "</span>";
		}
		message = "<div class='upload_image_div'>" + message + '<span style="display:none;" class="chat-icon-home icon-f icf-spinner icf-anim-pulse"></span>' + "</div>";

		$("#" + id_div_message + " .chat_message").html( message );
		$("#" + id_div_message + " .chat_message_report").html('{"type":"upload","verif":"file uploaded in chat"}');
		$("#" + id_div_message + " .chat_message a").on("click", function(event) {
			event.preventDefault();

			$(this).parent().parent().find("span").toggle();
			var self_link = $(this);
			setTimeout(function() {
				self_link.parent().parent().find("span").toggle();
			},3000);

			var blob = self.data_uri_to_blob(content);
			self.save_file_on_disk(blob, message_obj.filename);
		});

	}

	upload_default.prototype.data_uri_to_blob = function (dataURI) {
		// convert base64/URLEncoded data component to raw binary data held in a string
		var byteString;
		if (dataURI.split(',')[0].indexOf('base64') >= 0)
			byteString = atob(dataURI.split(',')[1]);
		else
			byteString = unescape(dataURI.split(',')[1]);

		// separate out the mime component
		var mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];

		// write the bytes of the string to a typed array
		var ia = new Uint8Array(byteString.length);
		for (var i = 0; i < byteString.length; i++) {
			ia[i] = byteString.charCodeAt(i);
		}

		return new Blob([ia], {type:mimeString});
	}

	upload_default.prototype.save_file_on_disk = function (blobOrFile, filename) {
		if ( window.navigator && window.navigator.msSaveBlob ) {
			window.navigator.msSaveBlob(blobOrFile, filename);
		} else {
			var element = document.createElement('a');
			element.setAttribute('href', URL.createObjectURL(blobOrFile));
			element.setAttribute('download', filename);
			element.style.display = 'none';
			document.body.appendChild(element);
			element.click();
			document.body.removeChild(element);
		}
	}

	upload_default.prototype.popup_error = function(text_content) {
		var text_popup = '<p>' + text_content + "</p>";
		var popup_options = {};
		popup_options.position = { v: 'above', h: 'right' };
		popup_options.trigger = false;

		log_and_tooltip.popup_open( $("#chat-send-file") , text_popup, popup_options);
	}
	upload_default.prototype.popup_error_file_bad_type = function() {
		this.popup_error(i18n.__('chat.send_file_bad_type', {"%types%": this.allowedTypes.join(', ')}));
	}

	upload_default.prototype.popup_error_please_retry = function() {
		this.popup_error(i18n.__('misc.error_please_retry'));
	}

	upload_default.prototype.progress_bar_get_id = function(id) {
		return "progress_bar_id_" + id;
	};

	upload_default.prototype.progress_bar_create_html = function(id, container, text, background) {
		if (!background) {
			background = container.css("background-color");
		}

		var style= 'style="background-color: ' + background + ';"';

		var progress_bar = '<div class="chat_progress_bar" id="' + this.progress_bar_get_id(id) + '"><div class="progress" ' + style + '>';
		progress_bar += '<div class="progress_bar">';
		progress_bar += '</div>';
		progress_bar += '<div class="progress_bar_text">' + text;
		progress_bar += '</div>';
		progress_bar += '</div></div>';

		return progress_bar;
	};

	upload_default.prototype.progress_bar_create = function(id, container, text, background) {
		if ( $("#" + this.progress_bar_get_id(id)).length > 0 ) {
			return;
		}

		container.append(this.progress_bar_create_html(id, container, text, background));
	};

	upload_default.prototype.progress_bar_create_message = function(id, container, text, background, id_recipient) {
		if ( $("#" + this.progress_bar_get_id(id)).length > 0 ) {
			return;
		}

		var html = this.progress_bar_create_html(id, container, text, background);
		this.message_for_upload_progress_bar_fct(id, html, id_recipient);
	};

	upload_default.prototype.progress_bar_pourcent = function(id, pourcent, text) {
		if ( $("#" + this.progress_bar_get_id(id)).length === 0 ) {
			return;
		}

		$("#" + this.progress_bar_get_id(id) + " .progress_bar").width(pourcent + "%");
		if (typeof text !== "undefined") {
			$("#" + this.progress_bar_get_id(id) + " .progress_bar_text").html(text);
		}
		$("#" + this.progress_bar_get_id(id)).show();
	};

	upload_default.prototype.progress_bar_delete = function(id) {
		$("#" + this.progress_bar_get_id(id)).remove();

		if ( $("#chat_message_upload_bar_" + id).length > 0 ) {
			$("#chat_message_upload_bar_" + id).closest("li").remove();
		}
	};

	upload_default.prototype.send_file = function (socket, id_user, id_recipient, file) {
		if ( file.size > (this.file_max_size_megabytes * 1024 *1024) ) {
			var self = this;
			setTimeout(function() {
				self.popup_error(i18n.__('upload.cant_start_check_file_size_and_internet_connection', {"%max_size%": self.file_max_size_megabytes + i18n.__('units.file_size_megabytes')}));
			}, 200);
			return;
		}

		var filename = this.sanitize_filename(file.name);
		var imgType = filename.split('.');
		imgType = imgType[imgType.length - 1].toLowerCase();
		if (this.allowedTypes.indexOf(imgType) == -1) {
			setTimeout(this.popup_error_file_bad_type.bind(this), 200);
			return;
		}

		var file_temp_id = filename.replace(/\./g,'_').replace(/[\s()]/g,'_') + "_" + (new Date()).getTime() + "_" + id_recipient;

		this.files[file_temp_id] = {};
		this.files[file_temp_id]['file'] = file;
		this.files[file_temp_id]['size'] = file.size;

		if ( !this.socket ) {
			this.init_socket(socket);
		}

		this.socket.emit("get_token_send_file", {id_file: file_temp_id, filename: filename, id_recipient: id_recipient });
	}

	upload_default.prototype.sanitize_filename = function(filename) {
		return filename.replace(/[\/<>"'= ]/g, "_");
	}

	upload_default.prototype.get_token_send_file = function(data) {
		if ( typeof data.token === "undefined" || typeof data.id_file === "undefined" || typeof this.files[data.id_file] === "undefined" || typeof data.id_recipient === "undefined" ) {
			this.popup_error_file_bad_type();
			wglog.error("get_token_send_file", "don't find file");
			return;
		}

		this.files[data.id_file]['token'] = data.token;

		var reader = new FileReader();
		reader.token_send_file_data = data;
		reader.addEventListener('load', this.on_reader_load.bind(this));
		reader.readAsDataURL(this.files[data.id_file]['file']);
	}

	upload_default.prototype.on_reader_load = function (e) {
		var mime_type = e.target.result.substring(e.target.result.indexOf(":")+1, e.target.result.indexOf(";"));
		var file_type = mime_type.substring(0, mime_type.indexOf("/"));

		if ( file_type != "image" && file_type != "video" ) {
			this.popup_error_file_bad_type();
			wglog.error("on_reader_load", "load failed");
			return;
		}

		var content = e.target.result;
		var self = this;

		if (file_type == "image") {
			generate_thumb = this.generate_image_thumb.bind(this);
		} else if (file_type == "video") {
			generate_thumb = this.generate_video_thumb.bind(this);
		}

		if (generate_thumb) {
			generate_thumb(
				content,
				function (thumb) {self.file_launch_crypt(e.target.token_send_file_data, content, thumb);},
				function (default_thumb) {self.file_launch_crypt(e.target.token_send_file_data, content, null);}
			);
		}
	}

	upload_default.prototype.file_launch_crypt = function (data, content, thumb) {
		var conv_key = this.get_last_conv_key_fct(data.id_recipient);
		if (conv_key == "") {
			this.popup_error(i18n.__('error.internal_err_please_reload'));
			wglog.error("file_launch_crypt", "no conv key found");
			return;
		}

		var down = scroll_conversation.isDown(data.id_recipient);

		this.progress_bar_create_message(
			data.id_file,
			$("#chat_messages_tab_" + data.id_recipient),
			i18n.__("chat.file_encryting"),
			$(".chat-messenger").css("background-color"), data.id_recipient
		);

		if (down) {
			scroll_conversation.down(data.id_recipient);
		}

		this.worker_crypt.postMessage({ content: content, thumb: thumb, key: conv_key, id_file: data.id_file, id_recipient: data.id_recipient });
	}

	upload_default.prototype.get_field = function () {
		return '<div id="chat-send-file" class="d-none icon-f icf-image"></div>';
	}

	upload_default.prototype.get_message_html = function (info, message_json, timestamp) {
		message_json.tid = 'id-' + Math.random().toString(32).slice(2);

		var params = {
			galleryId: 'id-' + Math.random().toString(32).substring(2),
			galleryVisible: [{
				tid: message_json.tid,
				displayName: message_json.filename.indexOf('.pdf') > -1 ? message_json.filename : '',
				name: message_json.filename,
				ext: message_json.extension,
				thumb: message_json.thumb,
				timestamp: timestamp,
				modifier: this.temp_modifier,
				type: this.switch_file_type(message_json.original_filename, {
					default: 'file',
					image: 'image',
					video: 'video'
				})
			}],
			galleryInvisible: [],
			text: null
		};

		if (message_json.text) {
			params.text = message_json.text;
		}

		return Mustache.render(tpl_file_placeholder, params);
	}

	upload_default.prototype.on_message_added = function (e) {
		var elt = $(e.target).find('.chat-upload-temp--' + this.temp_modifier),
			filename = elt.data('name') + elt.data('ext');

		if (filename) {
			var fileNames = {};
			fileNames[elt.data('tid')] = filename;
			this.socket.emit("get_xv_file_url", {file_names: fileNames});
		}
	}

	upload_default.prototype.xv_file_url = function (data) {
		for (var tid in data.urls) {
			this.replace_placeholder(tid, data.urls[tid]);
		}
	}

	upload_default.prototype.get_file_view = function (placeholder, tid, url) {
		var name = placeholder.data('name'),
			ext = placeholder.data('ext'),
			filename = placeholder.data('original-name'),
			has_thumb = placeholder.data('thumb'),
			thumb_url = "";

		var parent = placeholder.parent();
		parent.attr({
			href: url,
			download: filename
		});

		if (has_thumb) {
			thumb_url = url.replace(name + ext, name + '_thumb.png');
		}

		return $(Mustache.render(tpl_file_display, {thumb_url: thumb_url}));
	}

	upload_default.prototype.get_file_expired_view = function (placeholder) {
		placeholder
			.closest(".chat-message__id")
			.removeClass("chat-message__id--file-shared-loading")
		placeholder.closest('.chat-message__message').find('.chat-message__metas').remove();
		return $(`<span class="chat-content__gallery-item-tag">${i18n.__('chat.file_expired')}</span>`);
	}

	upload_default.prototype.replace_placeholder = function (tid, url) {
		var placeholder = $('span[data-tid="' + tid + '"]'),
			has_expired = Date.now() > (+placeholder.data('timestamp') * 1000 + this.expire_time_min),
			replacement;

		if (has_expired) {
			var $a = placeholder.closest('a'),
				$div = $('<div>').html($a.html()).attr('class', $a.attr('class'));
			$a.replaceWith($div);
			placeholder = $('span[data-tid="' + tid + '"]');
			replacement = this.get_file_expired_view(placeholder);
		} else {
			replacement = this.get_file_view(placeholder, tid, url);
		}

		replacement.filter('img').on('error', function () { $(this).hide(); });
		replacement.filter('img').on('load', function () { $(this).parent().css({backgroundImage: 'none'}); });

		var message = placeholder.closest(".chat-message__id");
		message
			.removeClass("chat-message__id--file-shared-loading");

		message.find('.chat-message__delivery-status').hide();
		var actionContextMenu = message.find('.chat-message__action--context-menu');
		if (has_expired && actionContextMenu.length && actionContextMenu.get(0).contextMenu) {
			actionContextMenu.get(0).contextMenu.removeAction("download");
		}

		message.find('.chat-message__actions').removeAttr('style');

		if (placeholder.closest('.chat-message__id').data('preserveScrollDownOnImageLoad')) {
			var thumb = replacement.find('img'),
				friend_id = +placeholder.closest('.chat-tab-container').attr('id').slice(18);

			if (thumb.prop('complete')) {
				scroll_conversation.down(friend_id);
			} else {
				thumb.on('load', function () {
					scroll_conversation.down(friend_id, scroll_conversation.getScrollTop(friend_id) + this.height);
				});
			}
			placeholder.data('preserveScrollDownOnImageLoad', false);
		}

		placeholder
			.parents(".chat-message-temp")
			.removeClass("chat-message-temp");
		placeholder
			.replaceWith(replacement);

		var message_report = message.find('.chat_message_report');
		var message_report_text = message_report.html() + ' - ' + url;
		message_report.html(message_report_text);
	}

	upload_default.prototype.set_optional_click_listener_on_file_link = function (link) {
		if (window.URL && link.length) {
			var url = new URL(link.attr('href'));
			var filename = url.pathname.split('/').pop();
			var self = this;

			var cb = this.switch_file_type(filename, {
				default: function () {
					link.on('click', self.on_file_link_click.bind(self));
				},
				video: function () {
					var vid = $(document.createElement("VIDEO"));
					vid.attr("preload", "metadata");
					vid.attr("src", link.attr('href'));
					vid.on("canplay", function () {
						link.on('click', self.on_file_link_click.bind(self));
					});
				}
			});

			cb();
		}
	}

	upload_default.prototype.on_file_link_click = function (e) {
		var src = e.target.href,
			filename = src.split('/').pop();

		if (filename.indexOf('?') > 0) {
			filename = filename.substr(0, filename.indexOf('?'));
		}

		var ext = filename.split('.').pop();

		if (['mp3', 'gif', 'jpeg', 'jpg', 'png', 'mp4', 'webm'].indexOf(ext) < 0) {
			return;
		}

		e.preventDefault();

		var media = this.switch_file_type(filename, {
			audio: () => {
				var audio = document.createElement('audio');
				audio.src = src;
				audio.controls = true;
				return audio;
			},
			image: () => {
				var image = new Image();
				image.src = src;
				return image;
			},
			video: () => {
				var video = document.createElement('video');
				video.src = src;
				video.controls = true;
				return video;
			}
		})();

		var sizeable = media instanceof HTMLImageElement || media instanceof HTMLVideoElement;
		var playable = media instanceof HTMLAudioElement || media instanceof HTMLVideoElement;

		if (sizeable) {
			this.auto_scale(media);
		}

		var _overlay = overlay.get($('body > .chat-external-overlay-container'), true, 'close');
		_overlay.addClass('x-overlay-file-upload' + this.switch_file_type(filename, {audio: '-audio', image: '-image', video: '-video'}));
		_overlay.setContent($(media));
		_overlay.setClosable(true, true, false);
		$(media).on(playable ? 'canplay' : 'load', () => {
			if (sizeable) {
				this.scale_element(media);
			}
			_overlay.show();
		});
	}

	return upload_default;
});
define('chat_errors',[], function () {
	var errorCodes = {
		UPLOAD_DROPZONE_UNSAFE_URL_DETECTED: 40000
	};

	var errorMessages = {
		40000: 'chat.error.unable_to_load_file'
	};

	var ChatError = {
		getErrorMessage: function(code) {
			if (!errorMessages.hasOwnProperty(code)) {
				return false;
			}

			return errorMessages[code];
		}
	};

	for (const key in errorCodes) {
		Object.defineProperty(ChatError, key, {
			value: errorCodes[key],
			writable: false,
		});
	}

	return ChatError;
});
define('chat/upload/upload_extended_ux',[
], function() {

	var UploadExtendedUx = function() {
		this.$ddArea = null;
		this.$pasteArea = null;
		this.classFocus = 'dd-focus';
	};

	UploadExtendedUx.prototype = {
		init: function(eltDD, classPastElt, fnCallbackExec) {
			this.$ddArea = eltDD;
			this.$pasteArea = this.$ddArea.find('.' + classPastElt);
			this.fnExec = fnCallbackExec;

			var events = ['dragenter', 'dragover', 'dragleave', 'drop'],
				fnPreventDefaults = function(event) {
					event.preventDefault();
					event.stopPropagation();
				};

			for (var i in events) {
				this.$ddArea.on(events[i], fnPreventDefaults);
				if (events[i] === 'dragenter' || events[i] === 'dragover') {
					this.$ddArea.on(events[i], this.focus.bind(this));
				}
				if (events[i] === 'dragleave' || events[i] === 'drop') {
					this.$ddArea.on(events[i], this.unFocus.bind(this));
				}
			}

			this.$ddArea.on('drop', this.setDatas.bind(this));
			this.$pasteArea.on('paste', this.setDatas.bind(this));

			var self = this;
			this.$ddArea.on('touchstart', function() {
				self.$pasteArea.focus();
			});
		},

		focus: function(event) {
			this.$ddArea.addClass(this.classFocus);
		},

		unFocus: function(event) {
			this.$ddArea.removeClass(this.classFocus);
		},

		extractDatas: function(event) {
			if (event.type !== 'drop' && event.type !== 'paste') {
				return;
			}

			var source;
			if (event.type === 'drop' && !!event.originalEvent.dataTransfer && !!event.originalEvent.dataTransfer.files && event.originalEvent.dataTransfer.files.length > 0) {
				source = 'dataTransfer';
			}
			else if (event.type === 'paste' && !!event.originalEvent.clipboardData && !!event.originalEvent.clipboardData.files && event.originalEvent.clipboardData.files.length > 0) {
				source = 'clipboardData';
			}
			else {
				return;
			}
			return event.originalEvent[source].files;
		},

		setDatas: function(event) {
			event.preventDefault();
			event.stopPropagation();

			var files = this.extractDatas(event);
			this.fnExec(files);
		}
	}

	return UploadExtendedUx;

});
define('chat/upload/upload_dropzone',[
	'chat_errors',
	'chat/dropzone/dropzone',
	'chat/scroll_conversation/scroll_conversation',
	'chat/upload/upload',
	'chat/upload/upload_extended_ux',
	'config/chat',
	'log_and_tooltip',
	'lib/helpers/overlay',
	'lib/i18n!front',
	'lib/tools',
	'lib/utils',
	'mustache',
	'text!chat/upload/upload_file_display.mustache',
	'text!chat/upload/upload_file_placeholder.mustache'
], function (
	ChatErrors,
	Dropzone,
	ScrollConversation,
	upload,
	upload_extended_ux,
	config,
	log_and_tooltip,
	overlay,
	i18n,
	tools,
	utils,
	Mustache,
	tpl_file_display,
	tpl_file_placeholder
) {
	var name = "dropzone";
	var SEND_MESSAGE_MAX_ATTEMPTS = 10;

	var upload_dropzone = function (
		field_name,
		chat_friend_manager,
		format_timestamp_fct,
		format_timestamp_relative_fct,
		get_last_conv_key_fct,
		insert_temp_message_fct,
		make_real_message_fct,
		get_message_input_value_fct,
		empty_message_form_fct
	) {
		if (!config.file_upload.token && !config.file_upload.file_token) {
			wglog.error("upload_dropzone", "config.file_upload.token missing");
			return;
		}

		upload.call(this);

		this.available = false;
		this.field_name = field_name;
		this.dropzone = new Dropzone({
			id: field_name,
			token: this.get_token(field_name)
		});

		// in milliseconds
		this.extensions = {
			audios: ['mp3'],
			word: ['doc', 'docx'],
			excel: ['xls', 'xlsx', 'csv'],
			text: ['txt'],
			images: ['png', 'jpg', 'jpeg', 'webp'],
			videos: ['avi', 'mkv', 'mov', 'mp4', 'mpeg', 'mpeg4', 'mpg', 'wmv']
		};
		this.files_to_send = {};
		this.urls_to_get = {};
		this.updates = {};
		this.worker_crypt_queue = 0;
		this.thumb_max_width = 300;
		this.thumb_max_height = 300;
		this.dropzone_thumb_max_width = 300;
		this.dropzone_thumb_max_height = 300;

		this.max_height_percent = 0.90;
		this.max_width_percent = 0.95;

		this.chat_friend_manager = chat_friend_manager;
		this.format_timestamp = format_timestamp_fct;
		this.format_timestamp_relative = format_timestamp_relative_fct;
		this.get_last_conv_key = get_last_conv_key_fct;
		this.insert_temp_message = insert_temp_message_fct;
		this.make_real_message = make_real_message_fct;
		this.get_message_input_value = get_message_input_value_fct;
		this.empty_message_form = empty_message_form_fct;

		this.display_message_required_keys = ["type", "uuid", "thumb", "size", "filename"];
		this.temp_modifier = name;

		this.thumb_file_size_limit = 100 * 1000 * 1000; // 100MB

		this.send_message_attempts = 0;
	};

	upload_dropzone.prototype = Object.create(upload.prototype);

	upload_dropzone.prototype.add_to_conversation = function(friend_id) {
		if (!this.socket) {
			wglog.error("add_to_conversation", "Socket is undefined");
			log_and_tooltip.write_error({logTitle: 'upload_dropzone::add_to_conversation Socket is undefined', message: i18n.__('chat.error.connection_error'), refresh: true});
			return;
		}

		if (!this.dropzone) {
			wglog.error("add_to_conversation", "Dropzone is undefined");
			return;
		}

		if (Object.keys(this.files_to_send).length && !this.send_messages_interval) {
			this.send_messages_interval = setInterval(this.send_messages.bind(this, friend_id), 1000);
		}
	}

	upload_dropzone.prototype.send_messages = function(friend_id) {
		this.send_message_attempts++;

		var uuids = Object.keys(this.files_to_send);
		wglog.info('upload_dropzone::send_messages tester l\'upload avec de la latence');

		var filename = '';
		var filenameRequired = uuids.length === 1;

		for (var i = 0, l = uuids.length; i < l; i++) {
			var file = this.files_to_send[uuids[i]];
			if (!file || file.status !== window.Dropzone.SUCCESS) {
				wglog.error('upload_dropzone::send_messages File status not success', 'uuid: ' + uuids[i] + ', status: ' + file.status);

				if (this.send_message_attempts === SEND_MESSAGE_MAX_ATTEMPTS) {
					wglog.debug('upload_dropzone::send_messages files', this.files_to_send);
					wglog.error('upload_dropzone::send_messages Max attempts reached ()', 'Some files are still not uploaded with success');

					clearInterval(this.send_messages_interval);
					this.send_messages_interval = null;
					this.send_message_attempts = 0;
					this.dropzone.emit("reset");
					this.dropzone.emit("close");
					$('.chat-message-form__action--attachment').click();
					this.empty_message_form();
				}
				return;
			}
			if (filenameRequired) {
				filename = file.name;
			}
		}

		var message = {
			"type": "upload",
			"uuid" : uuids,
			"thumb" : true,
			"size" : 0,
			"filename": filename,
			"text": this.get_message_input_value()
		};

		var message_string = this.make_real_message(JSON.stringify(message), friend_id);
		var timestamp = Math.round(new Date().getTime()/1000);
		this.insert_temp_message(message_string, this.chat_friend_manager.get_friend_infos(friend_id), timestamp);

		var message_data = {
			'message': message_string,
			'recipient_id': friend_id,
			'file_ids': uuids,
			'temp_timestamp': timestamp
		};

		this.socket.emit("send_message", message_data);

		for (var j = 0, m = uuids.length; j < m; j++) {
			var _file = this.files_to_send[uuids[j]];
			if (!_file) {
				continue;
			}
			$(_file.previewElement).remove();
			this.dropzone.removeFile(_file);
		}
		this.files_to_send = {};

		clearInterval(this.send_messages_interval);
		this.send_messages_interval = null;
		this.send_message_attempts = 0;
		this.dropzone.emit("reset");
		this.dropzone.emit("close");
		$('.chat-message-form__action--attachment').click();
		this.empty_message_form();
	}

	upload_dropzone.prototype.alter_message_actions = function(actions, message_html, message_id) {
		var msg;

		if (message_html.hasClass('chat-message__id--file-shared')) {
			msg = message_html;
		} else {
			msg = message_html.find("#chat_message_" + message_id);
		}

		if (!msg.hasClass('chat-message__id--file-shared')) {
			return;
		}

		var anchorElement = message_html.find('.chat-message__file-link').clone().get(0);

		if (anchorElement) {
			var downloadAction = this.get_download_action(anchorElement);
			actions.unshift(downloadAction);
		}
	}


	upload_dropzone.prototype.check_files_urls = function (urls) {
		if (!urls || typeof urls.full != 'string' || typeof urls.thumb != 'string') {
			return false;
		}

		return (urls.full === '' || urls.full.startsWith("https:")) && (urls.thumb === '' || urls.thumb.startsWith("https:"));
	};

	upload_dropzone.prototype.create_encrypted_file = function (original, data) {
		var file = new File([data.contentCrypted], original.name, {
			type: original.type,
			lastModified: original.lastModified
		});
		file.chat = original.socketIO;
		file.accepted = original.accepted;
		file.previewElement = original.previewElement;
		file.previewTemplate = original.previewTemplate;
		file.status = original.status;
		file.upload = original.upload;
		file._removeLink = original._removeLink;
		return file;
	}

	upload_dropzone.prototype.enqueue_file = function (file) {
		var file_type = this.dropzone.getFileMainType(file.type);

		if (["audio", "image", "video", "text", "word", "excel"].indexOf(file_type) === -1) {
			wglog.error("on_reader_load", "File type not supported");
			return;
		}

		if (!file.hasOwnProperty('upload') || !file.upload.hasOwnProperty('uuid')) {
			return;
		}

		this.files_to_send[file.upload.uuid] = file;

		this.process_dropzone_queue();
	}

	upload_dropzone.prototype.file_encrypted = function (data) {
		if (!data.id_file || !data.contentCrypted) {
			wglog.error("file_encrypted", "File encryption failed");
			// Send the file but it won't be encrypted.
			this.worker_crypt_queue_decrease();
			this.process_dropzone_queue();
			return;
		}

		if (!this.files_to_send.hasOwnProperty(data.id_file)) {
			wglog.error("file_encrypted", "Unknown file ID");
			// Send the file but it won't be encrypted.
			this.worker_crypt_queue_decrease();
			this.process_dropzone_queue();
			return;
		}

		if (!data.contentCryptedThumb) {
			data.contentCryptedThumb = "";
		}

		var file = this.files_to_send[data.id_file];

		this.dropzone.replaceFile(file.socketIO.index, this.create_encrypted_file(file, data));

		this.worker_crypt_queue_decrease();
		this.process_dropzone_queue();
	}

	upload_dropzone.prototype.generate_thumb_from_file = function (file) {
		if (!file || !(file instanceof File)) {
			wglog.error("generate_thumb_from_file", "Invalid file argument");
			return;
		}

		var reader = new FileReader();
		reader.addEventListener('load', this.on_reader_load.bind(this));
		reader.file = file;
		reader.readAsDataURL(file);
	}

	upload_dropzone.prototype.get_download_action = function(anchorElement) {
		return {
			name: "download",
			position: 0,
			label: '<span class="icon-f icf-download"></span>' + i18n.__('misc.download'),
			callback: function() {
				window.open(anchorElement.href, '_blank');
			}
		};
	}

	upload_dropzone.prototype.get_multiple_download_action = function(anchorElements) {
		return {
			name: "multiple-download",
			position: 0,
			label: '<span class="icon-f icf-download"></span>' + i18n.__('misc.download'),
			callback: function() {
				anchorElements.each(function() {
					window.open($(this).get(0).href, "_blank");
				});
			}
		};
	}

	upload_dropzone.prototype.get_field = function() {
		return this.dropzone.getFieldHtml();
	}

	upload_dropzone.prototype.get_message_html = function(info, message_json, timestamp) {
		if (typeof message_json.uuid === 'string') {
			message_json.uuid = [message_json.uuid];
		}

		var params = {
			galleryId: 'id-' + Math.random().toString(32).substring(2),
			galleryVisible: [],
			galleryInvisible: [],
			text: null
		};

		for (var i = 0, l = message_json.uuid.length; i < l; i++) {
			var uuid = message_json.uuid[i];
			params.galleryVisible.push({
				uuid: uuid,
				modifier: this.temp_modifier,
				displayName: message_json.filename.indexOf('.pdf') > -1 ? message_json.filename : '',
				name: message_json.filename,
				tempId: 'id-' + Math.random().toString(32).substring(2),
				type: 'file'
			});
		}

		if (params.galleryVisible.length > 4) {
			var count = params.galleryVisible.length - 4;
			params.galleryInvisible = params.galleryVisible.splice(4, count);
			params.galleryVisible[3].more = '+' + count;
		}

		if (message_json.text) {
			params.text = message_json.text;
		}

		return Mustache.render(tpl_file_placeholder, params);
	}

	upload_dropzone.prototype.get_token = function (field_name) {
		if (config.file_upload.token) {
			if ("string" === typeof config.file_upload.token) {
				return config.file_upload.token;
			} else if (config.file_upload.token[field_name]){
				return config.file_upload.token[field_name];
			}

			throw new Error('token not found');
		} else if (!config.file_upload.file_token) {
			throw new Error('token not found');
		}
		return config.file_upload.file_token;
	}

	upload_dropzone.prototype.init = function () {
		if (config.file_upload.method !== "dropzone") {
			return;
		}
		var dz = this.dropzone.init();
		if (!dz) {
			return false;
		}
		this.available = true;
		this.dropzone.setOptions({
				autoProcessQueue: false,
				thumbnailWidth: this.dropzone_thumb_max_width,
				thumbnailHeight: this.dropzone_thumb_max_height,
				thumbnailMethod: "contain"
			})
			.on('addedfiles', (files) => {
				for (var i = 0, l = files.length; i < l; i++) {
					var file = files[i];
					file.chat = { index: this.dropzone.getFileIndex(file) };
					// @TODO generate_thumb_from_file seems not generating thumb at all.
					// this.generate_thumb_from_file(file);
					this.enqueue_file(file);
				}
			})
			.on('thumbnail', (file) => {
				this.try_encrypt_file(file);
			})
			.on('removedfile', (file) => {
				var keys = Object.keys(this.files_to_send);
				var uuid_index = keys.indexOf(file.upload.uuid);

				if (uuid_index > -1) {
					delete this.files_to_send[file.upload.uuid];
					keys.splice(uuid_index, 1);
				}

				if (!keys.length) {
					this.dropzone.emit("reset");
				}
			})
			.on('queuecomplete', () => {
				this.dropzone.setOptions({autoProcessQueue: false});
			});

		var fnAddFilesAndTriggerDzInputFile = function(files) {
			if (!(!!files) || files.length === 0) {
				return;
			}
			if (!$('#chat-attachment').is(':visible')) {
				$('.chat-message-form__action--attachment').trigger('click');
			}
			if ($('#chat-local').is(':visible')) {
				var $dzInput = document.querySelector('.dz-hidden-input');
				$dzInput.files = files;
				$dzInput.dispatchEvent(new Event('change'));
			}
		};

		var uploadExtendedUx = new upload_extended_ux();
		uploadExtendedUx.init($('div.chat-message-form__textarea'), 'emojionearea-editor', fnAddFilesAndTriggerDzInputFile);

		$('#chat-window').on('message-added', this.on_message_added.bind(this));
		$('#chat-window').on('message-rerendered', this.on_message_added.bind(this));
		$('#chat-window').on('conversation-loaded', this.on_conversation_loaded.bind(this));
	}

	upload_dropzone.prototype.init_socket = function(socket) {
		upload.prototype.init_socket.call(this, socket);

		this.socket.on("file_url", this.on_socket_file_url.bind(this));
		this.socket.init_send_file = true;
	}

	upload_dropzone.prototype.on_conversation_loaded = function (e) {
		if (e.details && e.details.friend_id) {
			this.get_url(e.details.friend_id);
		}
	}
	upload_dropzone.prototype.on_message_added = function (e) {
		var uuid = $(e.target).find('.chat-upload-temp--' + this.temp_modifier).map(function () {
			return $(this).data('uuid');
		}).get().join(',');

		if (!uuid) {
			return;
		}

		this.add_url_to_get(e.details.friend_id, uuid);

		if (e.details && e.details.hasOwnProperty('ready_for_get') && !!e.details.ready_for_get === false) {
			return;
		}

		this.get_url(e.details.friend_id);
	}
	upload_dropzone.prototype.on_reader_load = function (e) {
		var mime_type = e.target.result.substring(e.target.result.indexOf(":")+1, e.target.result.indexOf(";"));
		var file_type = this.dropzone.getFileMainType(mime_type);

		if (["audio", "image", "video", "text", "word", "excel"].indexOf(file_type) === -1) {
			wglog.error("on_reader_load", "File type not supported");
			return;
		}

		var file = e.target.file;

		if (!file.hasOwnProperty('upload') || !file.upload.hasOwnProperty('uuid')) {
			return;
		}

		file.socketIO.content = e.target.result;

		this.files_to_send[file.upload.uuid] = file;

		this.try_encrypt_file(file);
	}

	upload_dropzone.prototype.on_socket_file_url = function (data) {
		if (!data.urls || !Object.keys(data.urls).length) {
			return;
		}

		for(var uuid in data.urls) {
			this.replace_placeholders(data.friend_id, uuid, data.urls[uuid]);
			this.update_existing(uuid, data.urls[uuid]);
		}
	}

	upload_dropzone.prototype.on_worker_crypt_message_error = function () {
		this.worker_crypt_queue_decrease();
	}

	upload_dropzone.prototype.process_dropzone_queue = function () {
		if (this.worker_crypt_queue) {
			wglog.debug("process_dropzone_queue", "Wait for worker crypt queue end");
			return;
		}

		this.dropzone
			.setOptions({autoProcessQueue: true})
			.getInstance().processQueue();
	}

	upload_dropzone.prototype.replace_placeholders = function (friend_id, uuid, urls) {
		var self = this;
		$('.chat-upload-temp[data-uuid="' + uuid + '"]').each(function () {
			self.replace_placeholder(friend_id, uuid, urls, $(this));
		});
	}

	upload_dropzone.prototype.replace_placeholder = function (friend_id, uuid, urls, placeholder) {
		var replacement;

		if (this.check_files_urls(urls)) {
			replacement = this.get_file_view(placeholder, friend_id, uuid, urls);
		} else {
			replacement = this.get_file_load_error_view(ChatErrors.UPLOAD_DROPZONE_UNSAFE_URL_DETECTED, placeholder);
		}

		placeholder
			.parents(".chat-message-temp")
			.removeClass("chat-message-temp");
		placeholder
			.replaceWith(replacement);

		var message = replacement.closest('.chat-message__id'),
			contextMenu = message.find('.chat-message__action--context-menu').prop('contextMenu'),
			action = null;

		if (contextMenu) {
			var anchorElement = message.find('.chat-message__file-link').clone().get(0);
			if (!anchorElement) {
				var anchors = message.find('a');

				if (anchors.length === 1) {
					action = this.get_download_action(anchors.get(0));
					contextMenu.setAction(action);
				}
				else if (anchors.length > 1) {
					action = this.get_multiple_download_action(anchors);
					contextMenu.setAction(action);
				}
			}
			else {
				action = this.get_download_action(anchorElement);
				contextMenu.setAction(action);
			}
		}

		if (this.updates.hasOwnProperty(uuid)) {
			return;
		}

		var self = this;
		var inter = (23 * 60 * 60 * 1000) + ((50 + Math.floor(Math.random() * 9)) * 60 * 1000); // = 23:5x

		this.updates[uuid] = setInterval(function () {
			self.emit_get_file_url(friend_id, [uuid]);
		}, inter);
	}

	upload_dropzone.prototype.get_file_load_error_view = function (errorCode, placeholder) {
		placeholder
			.closest(".chat-message__id")
			.removeClass("chat-message__id--file-shared-loading")
		placeholder.closest('.chat-message__message').find('.chat-message__metas').remove();
		return $(`<span class="chat-content__gallery-item-tag">${i18n.__(ChatErrors.getErrorMessage(errorCode))} (${errorCode})</span>`);
	}

	upload_dropzone.prototype.get_file_missing_view = function (placeholder) {
		placeholder
			.closest(".chat-message__id")
			.removeClass("chat-message__id--file-shared-loading")
		placeholder.closest('.chat-message__message').find('.chat-message__metas').remove();
		return $(`<span class="chat-content__gallery-item-tag">${i18n.__('chat.error.unable_to_load_file')}</span>`);
	}

	upload_dropzone.prototype.get_file_view = function (placeholder, friend_id, uuid, urls) {
		try {
			var fullUrl = new URL(urls.full),
				filename = fullUrl.pathname.substring(fullUrl.pathname.lastIndexOf('/') + 1);
		} catch (e) {
			wglog.debug('Invalid urls:', urls);
			wglog.debug('upload_dropzone::get_file_view URL creation error', e.message + ' for file:' + uuid);
			return this.get_file_missing_view(placeholder);
		}

		var parent = placeholder.closest('.chat-content__gallery-item');
		parent.prop({
			href: urls.full,
			dataLightboxThumb: urls.thumb
		});
		parent
			.removeClass('chat-content__gallery-item--file')
			.addClass('chat-content__gallery-item--' + this.switch_file_type(filename, {
				default: 'file',
				image: 'image',
				video: 'video'
			}))

		var message_id = placeholder.closest(".chat-message__id");
		message_id
			.removeClass("chat-message__id--file-shared-loading")
			.data("uuid", uuid);

		message_id.find('.chat-message__delivery-status').hide();
		message_id.find('.chat-message__actions').removeAttr('style');

		var replacement = null;

		if (parent.hasClass('chat-content__gallery-item--hidden')) {
			replacement = $();
		} else {
			replacement = $(Mustache.render(tpl_file_display, {thumb_url: urls.thumb}));
		}

		replacement.filter('img').on('error', function () { $(this).hide(); });
		replacement.filter('img').on('load', function () {
			$(this).parent().css({backgroundImage: 'none'});
		});

		if (replacement.length && message_id.data('preserveScrollDownOnImageLoad')) {
			var thumb = replacement.get(0).tagName === 'IMG' ? replacement : replacement.find('img');
			if (thumb.prop('complete')) {
				ScrollConversation.down(friend_id);
			} else {
				thumb.on('load', function () {
					ScrollConversation.down(friend_id, ScrollConversation.getScrollTop(friend_id) + this.height);
				});
			}
			placeholder.data('preserveScrollDownOnImageLoad', false);
		}

		var message_report = message_id.find('.chat_message_report');
		var message_report_text = message_report.html() + ' - ' + urls.full;
		message_report.html(message_report_text);

		if (urls.full && this.extensions.videos && this.extensions.videos.indexOf(filename.split('.').pop()) >= 0) {
			this.generate_video_thumb_from_url(urls.full)
				.then(function (thumbUrl) {
					var thumb = $(Mustache.render(tpl_file_display, {thumb_url: thumbUrl}));
					parent.append(thumb);
					parent.attr('data-lightbox-thumb', thumbUrl);
				})
				.catch(function (error) {
					wglog.debug('upload_dropzone::get_file_view unable to get video thumb', error);
				});
		}

		return replacement;
	}

	upload_dropzone.prototype.generate_video_thumb_from_url = function(videoUrl, seekTo) {
		seekTo = seekTo || 1.0;
		return new Promise(function (resolve, reject) {
			var video = document.createElement('video');
			video.crossOrigin = 'anonymous';
			video.src = videoUrl;
			video.load();

			video.addEventListener('loadedmetadata', () => {
				if (video.duration < seekTo) {
					reject('Video too short');
					return;
				}
				video.currentTime = seekTo;
			});

			video.addEventListener('seeked', () => {
				var canvas = document.createElement('canvas');
				canvas.width = video.videoWidth;
				canvas.height = video.videoHeight;
				var ctx = canvas.getContext('2d');

				ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

				var imageUrl = canvas.toDataURL('image/png');
				resolve(imageUrl);
			});

			video.addEventListener('error', (err) => {
				reject('Error while playing the video: ' + err.message);
			});
		});
	}

	upload_dropzone.prototype.set_chat_friend_manager = function (manager) {
		this.chat_friend_manager = manager;
	}

	upload_dropzone.prototype.try_encrypt_file = function (file) {
		if (!file || !(file instanceof File)) {
			wglog.error("try_encrypt_file", "Invalid file argument");
			return;
		}
		// For now, uploaded files are not encrypted
		// var key = this.get_last_conv_key(this.chat_friend_manager.selected_friend);
		var key;

		if (key) {
			var uuid = file.upload.uuid;
			this.files_to_send[uuid] = file;
			var thumb_src = $(file.previewElement).find('img').attr('src');

			this.worker_crypt_queue++;
			this.worker_crypt.postMessage({
				content: file.chat.content,
				thumb: thumb_src !== undefined && thumb_src !== null && thumb_src !== "",
				key: key,
				id_file: uuid,
				id_recipient: this.chat_friend_manager.selected_friend
			});
		} else {
			this.process_dropzone_queue();
		}
	}

	upload_dropzone.prototype.worker_crypt_queue_decrease = function () {
		this.worker_crypt_queue = Math.max(0, this.worker_crypt_queue - 1);
	}

	upload_dropzone.prototype.canProcess = function () {
		var dropzone = this.dropzone.getInstance();

		if (!dropzone || !dropzone.files) {
			return false;
		}

		var files = dropzone.files.filter(file => file.status === "success");

		return files.length > 0;
	}

	upload_dropzone.prototype.add_url_to_get = function (friend_id, uuid) {
		if (this.urls_to_get.hasOwnProperty(friend_id) === false) {
			this.reset_url_to_get(friend_id);
		}

		this.urls_to_get[friend_id].push(...uuid.split(','));
	}

	upload_dropzone.prototype.get_url = function (friend_id) {
		this.emit_get_file_url(friend_id, this.urls_to_get[friend_id]);
		this.reset_url_to_get(friend_id);
	}

	upload_dropzone.prototype.emit_get_file_url = function (friend_id, uuids) {
		if (!uuids || !uuids.length) {
			return;
		}
		this.socket.emit("get_file_url", {friend_id: friend_id, uuids: uuids});
	}

	upload_dropzone.prototype.reset_url_to_get = function (friend_id) {
		this.urls_to_get[friend_id] = [];
	}

	upload_dropzone.prototype.update_existing = function (uuid, urls) {
		$(`.chat-message__file[data-uuid="${uuid}"] .chat-message__file-thumb`).attr('src', urls.thumb);
		$(`.chat-message__file[data-uuid="${uuid}"] .chat-message__file-link`).attr('href', urls.full);
	}

	return upload_dropzone;

});

/** For any further updates, just replace the content of the following function and return Cropper at the end. */
define('libs/cropper.common',[], function () {
/*!
 * Cropper.js v1.5.13
 * https://fengyuanchen.github.io/cropperjs
 *
 * Copyright 2015-present Chen Fengyuan
 * Released under the MIT license
 *
 * Date: 2022-11-20T05:30:46.114Z
 */

	'use strict';

	function ownKeys(object, enumerableOnly) {
		var keys = Object.keys(object);
		if (Object.getOwnPropertySymbols) {
			var symbols = Object.getOwnPropertySymbols(object);
			enumerableOnly && (symbols = symbols.filter(function (sym) {
				return Object.getOwnPropertyDescriptor(object, sym).enumerable;
			})), keys.push.apply(keys, symbols);
		}
		return keys;
	}
	function _objectSpread2(target) {
		for (var i = 1; i < arguments.length; i++) {
			var source = null != arguments[i] ? arguments[i] : {};
			i % 2 ? ownKeys(Object(source), !0).forEach(function (key) {
				_defineProperty(target, key, source[key]);
			}) : Object.getOwnPropertyDescriptors ? Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)) : ownKeys(Object(source)).forEach(function (key) {
				Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key));
			});
		}
		return target;
	}
	function _typeof(obj) {
		"@babel/helpers - typeof";

		return _typeof = "function" == typeof Symbol && "symbol" == typeof Symbol.iterator ? function (obj) {
			return typeof obj;
		} : function (obj) {
			return obj && "function" == typeof Symbol && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj;
		}, _typeof(obj);
	}
	function _classCallCheck(instance, Constructor) {
		if (!(instance instanceof Constructor)) {
			throw new TypeError("Cannot call a class as a function");
		}
	}
	function _defineProperties(target, props) {
		for (var i = 0; i < props.length; i++) {
			var descriptor = props[i];
			descriptor.enumerable = descriptor.enumerable || false;
			descriptor.configurable = true;
			if ("value" in descriptor) descriptor.writable = true;
			Object.defineProperty(target, descriptor.key, descriptor);
		}
	}
	function _createClass(Constructor, protoProps, staticProps) {
		if (protoProps) _defineProperties(Constructor.prototype, protoProps);
		if (staticProps) _defineProperties(Constructor, staticProps);
		Object.defineProperty(Constructor, "prototype", {
			writable: false
		});
		return Constructor;
	}
	function _defineProperty(obj, key, value) {
		if (key in obj) {
			Object.defineProperty(obj, key, {
				value: value,
				enumerable: true,
				configurable: true,
				writable: true
			});
		} else {
			obj[key] = value;
		}
		return obj;
	}
	function _toConsumableArray(arr) {
		return _arrayWithoutHoles(arr) || _iterableToArray(arr) || _unsupportedIterableToArray(arr) || _nonIterableSpread();
	}
	function _arrayWithoutHoles(arr) {
		if (Array.isArray(arr)) return _arrayLikeToArray(arr);
	}
	function _iterableToArray(iter) {
		if (typeof Symbol !== "undefined" && iter[Symbol.iterator] != null || iter["@@iterator"] != null) return Array.from(iter);
	}
	function _unsupportedIterableToArray(o, minLen) {
		if (!o) return;
		if (typeof o === "string") return _arrayLikeToArray(o, minLen);
		var n = Object.prototype.toString.call(o).slice(8, -1);
		if (n === "Object" && o.constructor) n = o.constructor.name;
		if (n === "Map" || n === "Set") return Array.from(o);
		if (n === "Arguments" || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)) return _arrayLikeToArray(o, minLen);
	}
	function _arrayLikeToArray(arr, len) {
		if (len == null || len > arr.length) len = arr.length;
		for (var i = 0, arr2 = new Array(len); i < len; i++) arr2[i] = arr[i];
		return arr2;
	}
	function _nonIterableSpread() {
		throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.");
	}

	var IS_BROWSER = typeof window !== 'undefined' && typeof window.document !== 'undefined';
	var WINDOW = IS_BROWSER ? window : {};
	var IS_TOUCH_DEVICE = IS_BROWSER && WINDOW.document.documentElement ? 'ontouchstart' in WINDOW.document.documentElement : false;
	var HAS_POINTER_EVENT = IS_BROWSER ? 'PointerEvent' in WINDOW : false;
	var NAMESPACE = 'cropper';

// Actions
	var ACTION_ALL = 'all';
	var ACTION_CROP = 'crop';
	var ACTION_MOVE = 'move';
	var ACTION_ZOOM = 'zoom';
	var ACTION_EAST = 'e';
	var ACTION_WEST = 'w';
	var ACTION_SOUTH = 's';
	var ACTION_NORTH = 'n';
	var ACTION_NORTH_EAST = 'ne';
	var ACTION_NORTH_WEST = 'nw';
	var ACTION_SOUTH_EAST = 'se';
	var ACTION_SOUTH_WEST = 'sw';

// Classes
	var CLASS_CROP = "".concat(NAMESPACE, "-crop");
	var CLASS_DISABLED = "".concat(NAMESPACE, "-disabled");
	var CLASS_HIDDEN = "".concat(NAMESPACE, "-hidden");
	var CLASS_HIDE = "".concat(NAMESPACE, "-hide");
	var CLASS_INVISIBLE = "".concat(NAMESPACE, "-invisible");
	var CLASS_MODAL = "".concat(NAMESPACE, "-modal");
	var CLASS_MOVE = "".concat(NAMESPACE, "-move");

// Data keys
	var DATA_ACTION = "".concat(NAMESPACE, "Action");
	var DATA_PREVIEW = "".concat(NAMESPACE, "Preview");

// Drag modes
	var DRAG_MODE_CROP = 'crop';
	var DRAG_MODE_MOVE = 'move';
	var DRAG_MODE_NONE = 'none';

// Events
	var EVENT_CROP = 'crop';
	var EVENT_CROP_END = 'cropend';
	var EVENT_CROP_MOVE = 'cropmove';
	var EVENT_CROP_START = 'cropstart';
	var EVENT_DBLCLICK = 'dblclick';
	var EVENT_TOUCH_START = IS_TOUCH_DEVICE ? 'touchstart' : 'mousedown';
	var EVENT_TOUCH_MOVE = IS_TOUCH_DEVICE ? 'touchmove' : 'mousemove';
	var EVENT_TOUCH_END = IS_TOUCH_DEVICE ? 'touchend touchcancel' : 'mouseup';
	var EVENT_POINTER_DOWN = HAS_POINTER_EVENT ? 'pointerdown' : EVENT_TOUCH_START;
	var EVENT_POINTER_MOVE = HAS_POINTER_EVENT ? 'pointermove' : EVENT_TOUCH_MOVE;
	var EVENT_POINTER_UP = HAS_POINTER_EVENT ? 'pointerup pointercancel' : EVENT_TOUCH_END;
	var EVENT_READY = 'ready';
	var EVENT_RESIZE = 'resize';
	var EVENT_WHEEL = 'wheel';
	var EVENT_ZOOM = 'zoom';

// Mime types
	var MIME_TYPE_JPEG = 'image/jpeg';

// RegExps
	var REGEXP_ACTIONS = /^e|w|s|n|se|sw|ne|nw|all|crop|move|zoom$/;
	var REGEXP_DATA_URL = /^data:/;
	var REGEXP_DATA_URL_JPEG = /^data:image\/jpeg;base64,/;
	var REGEXP_TAG_NAME = /^img|canvas$/i;

// Misc
// Inspired by the default width and height of a canvas element.
	var MIN_CONTAINER_WIDTH = 200;
	var MIN_CONTAINER_HEIGHT = 100;

	var DEFAULTS = {
		// Define the view mode of the cropper
		viewMode: 0,
		// 0, 1, 2, 3

		// Define the dragging mode of the cropper
		dragMode: DRAG_MODE_CROP,
		// 'crop', 'move' or 'none'

		// Define the initial aspect ratio of the crop box
		initialAspectRatio: NaN,
		// Define the aspect ratio of the crop box
		aspectRatio: NaN,
		// An object with the previous cropping result data
		data: null,
		// A selector for adding extra containers to preview
		preview: '',
		// Re-render the cropper when resize the window
		responsive: true,
		// Restore the cropped area after resize the window
		restore: true,
		// Check if the current image is a cross-origin image
		checkCrossOrigin: true,
		// Check the current image's Exif Orientation information
		checkOrientation: true,
		// Show the black modal
		modal: true,
		// Show the dashed lines for guiding
		guides: true,
		// Show the center indicator for guiding
		center: true,
		// Show the white modal to highlight the crop box
		highlight: true,
		// Show the grid background
		background: true,
		// Enable to crop the image automatically when initialize
		autoCrop: true,
		// Define the percentage of automatic cropping area when initializes
		autoCropArea: 0.8,
		// Enable to move the image
		movable: true,
		// Enable to rotate the image
		rotatable: true,
		// Enable to scale the image
		scalable: true,
		// Enable to zoom the image
		zoomable: true,
		// Enable to zoom the image by dragging touch
		zoomOnTouch: true,
		// Enable to zoom the image by wheeling mouse
		zoomOnWheel: true,
		// Define zoom ratio when zoom the image by wheeling mouse
		wheelZoomRatio: 0.1,
		// Enable to move the crop box
		cropBoxMovable: true,
		// Enable to resize the crop box
		cropBoxResizable: true,
		// Toggle drag mode between "crop" and "move" when click twice on the cropper
		toggleDragModeOnDblclick: true,
		// Size limitation
		minCanvasWidth: 0,
		minCanvasHeight: 0,
		minCropBoxWidth: 0,
		minCropBoxHeight: 0,
		minContainerWidth: MIN_CONTAINER_WIDTH,
		minContainerHeight: MIN_CONTAINER_HEIGHT,
		// Shortcuts of events
		ready: null,
		cropstart: null,
		cropmove: null,
		cropend: null,
		crop: null,
		zoom: null
	};

	var TEMPLATE = '<div class="cropper-container" touch-action="none">' + '<div class="cropper-wrap-box">' + '<div class="cropper-canvas"></div>' + '</div>' + '<div class="cropper-drag-box"></div>' + '<div class="cropper-crop-box">' + '<span class="cropper-view-box"></span>' + '<span class="cropper-dashed dashed-h"></span>' + '<span class="cropper-dashed dashed-v"></span>' + '<span class="cropper-center"></span>' + '<span class="cropper-face"></span>' + '<span class="cropper-line line-e" data-cropper-action="e"></span>' + '<span class="cropper-line line-n" data-cropper-action="n"></span>' + '<span class="cropper-line line-w" data-cropper-action="w"></span>' + '<span class="cropper-line line-s" data-cropper-action="s"></span>' + '<span class="cropper-point point-e" data-cropper-action="e"></span>' + '<span class="cropper-point point-n" data-cropper-action="n"></span>' + '<span class="cropper-point point-w" data-cropper-action="w"></span>' + '<span class="cropper-point point-s" data-cropper-action="s"></span>' + '<span class="cropper-point point-ne" data-cropper-action="ne"></span>' + '<span class="cropper-point point-nw" data-cropper-action="nw"></span>' + '<span class="cropper-point point-sw" data-cropper-action="sw"></span>' + '<span class="cropper-point point-se" data-cropper-action="se"></span>' + '</div>' + '</div>';

	/**
	 * Check if the given value is not a number.
	 */
	var isNaN = Number.isNaN || WINDOW.isNaN;

	/**
	 * Check if the given value is a number.
	 * @param {*} value - The value to check.
	 * @returns {boolean} Returns `true` if the given value is a number, else `false`.
	 */
	function isNumber(value) {
		return typeof value === 'number' && !isNaN(value);
	}

	/**
	 * Check if the given value is a positive number.
	 * @param {*} value - The value to check.
	 * @returns {boolean} Returns `true` if the given value is a positive number, else `false`.
	 */
	var isPositiveNumber = function isPositiveNumber(value) {
		return value > 0 && value < Infinity;
	};

	/**
	 * Check if the given value is undefined.
	 * @param {*} value - The value to check.
	 * @returns {boolean} Returns `true` if the given value is undefined, else `false`.
	 */
	function isUndefined(value) {
		return typeof value === 'undefined';
	}

	/**
	 * Check if the given value is an object.
	 * @param {*} value - The value to check.
	 * @returns {boolean} Returns `true` if the given value is an object, else `false`.
	 */
	function isObject(value) {
		return _typeof(value) === 'object' && value !== null;
	}
	var hasOwnProperty = Object.prototype.hasOwnProperty;

	/**
	 * Check if the given value is a plain object.
	 * @param {*} value - The value to check.
	 * @returns {boolean} Returns `true` if the given value is a plain object, else `false`.
	 */
	function isPlainObject(value) {
		if (!isObject(value)) {
			return false;
		}
		try {
			var _constructor = value.constructor;
			var prototype = _constructor.prototype;
			return _constructor && prototype && hasOwnProperty.call(prototype, 'isPrototypeOf');
		} catch (error) {
			return false;
		}
	}

	/**
	 * Check if the given value is a function.
	 * @param {*} value - The value to check.
	 * @returns {boolean} Returns `true` if the given value is a function, else `false`.
	 */
	function isFunction(value) {
		return typeof value === 'function';
	}
	var slice = Array.prototype.slice;

	/**
	 * Convert array-like or iterable object to an array.
	 * @param {*} value - The value to convert.
	 * @returns {Array} Returns a new array.
	 */
	function toArray(value) {
		return Array.from ? Array.from(value) : slice.call(value);
	}

	/**
	 * Iterate the given data.
	 * @param {*} data - The data to iterate.
	 * @param {Function} callback - The process function for each element.
	 * @returns {*} The original data.
	 */
	function forEach(data, callback) {
		if (data && isFunction(callback)) {
			if (Array.isArray(data) || isNumber(data.length) /* array-like */) {
				toArray(data).forEach(function (value, key) {
					callback.call(data, value, key, data);
				});
			} else if (isObject(data)) {
				Object.keys(data).forEach(function (key) {
					callback.call(data, data[key], key, data);
				});
			}
		}
		return data;
	}

	/**
	 * Extend the given object.
	 * @param {*} target - The target object to extend.
	 * @param {*} args - The rest objects for merging to the target object.
	 * @returns {Object} The extended object.
	 */
	var assign = Object.assign || function assign(target) {
		for (var _len = arguments.length, args = new Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {
			args[_key - 1] = arguments[_key];
		}
		if (isObject(target) && args.length > 0) {
			args.forEach(function (arg) {
				if (isObject(arg)) {
					Object.keys(arg).forEach(function (key) {
						target[key] = arg[key];
					});
				}
			});
		}
		return target;
	};
	var REGEXP_DECIMALS = /\.\d*(?:0|9){12}\d*$/;

	/**
	 * Normalize decimal number.
	 * Check out {@link https://0.30000000000000004.com/}
	 * @param {number} value - The value to normalize.
	 * @param {number} [times=100000000000] - The times for normalizing.
	 * @returns {number} Returns the normalized number.
	 */
	function normalizeDecimalNumber(value) {
		var times = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : 100000000000;
		return REGEXP_DECIMALS.test(value) ? Math.round(value * times) / times : value;
	}
	var REGEXP_SUFFIX = /^width|height|left|top|marginLeft|marginTop$/;

	/**
	 * Apply styles to the given element.
	 * @param {Element} element - The target element.
	 * @param {Object} styles - The styles for applying.
	 */
	function setStyle(element, styles) {
		var style = element.style;
		forEach(styles, function (value, property) {
			if (REGEXP_SUFFIX.test(property) && isNumber(value)) {
				value = "".concat(value, "px");
			}
			style[property] = value;
		});
	}

	/**
	 * Check if the given element has a special class.
	 * @param {Element} element - The element to check.
	 * @param {string} value - The class to search.
	 * @returns {boolean} Returns `true` if the special class was found.
	 */
	function hasClass(element, value) {
		return element.classList ? element.classList.contains(value) : element.className.indexOf(value) > -1;
	}

	/**
	 * Add classes to the given element.
	 * @param {Element} element - The target element.
	 * @param {string} value - The classes to be added.
	 */
	function addClass(element, value) {
		if (!value) {
			return;
		}
		if (isNumber(element.length)) {
			forEach(element, function (elem) {
				addClass(elem, value);
			});
			return;
		}
		if (element.classList) {
			element.classList.add(value);
			return;
		}
		var className = element.className.trim();
		if (!className) {
			element.className = value;
		} else if (className.indexOf(value) < 0) {
			element.className = "".concat(className, " ").concat(value);
		}
	}

	/**
	 * Remove classes from the given element.
	 * @param {Element} element - The target element.
	 * @param {string} value - The classes to be removed.
	 */
	function removeClass(element, value) {
		if (!value) {
			return;
		}
		if (isNumber(element.length)) {
			forEach(element, function (elem) {
				removeClass(elem, value);
			});
			return;
		}
		if (element.classList) {
			element.classList.remove(value);
			return;
		}
		if (element.className.indexOf(value) >= 0) {
			element.className = element.className.replace(value, '');
		}
	}

	/**
	 * Add or remove classes from the given element.
	 * @param {Element} element - The target element.
	 * @param {string} value - The classes to be toggled.
	 * @param {boolean} added - Add only.
	 */
	function toggleClass(element, value, added) {
		if (!value) {
			return;
		}
		if (isNumber(element.length)) {
			forEach(element, function (elem) {
				toggleClass(elem, value, added);
			});
			return;
		}

		// IE10-11 doesn't support the second parameter of `classList.toggle`
		if (added) {
			addClass(element, value);
		} else {
			removeClass(element, value);
		}
	}
	var REGEXP_CAMEL_CASE = /([a-z\d])([A-Z])/g;

	/**
	 * Transform the given string from camelCase to kebab-case
	 * @param {string} value - The value to transform.
	 * @returns {string} The transformed value.
	 */
	function toParamCase(value) {
		return value.replace(REGEXP_CAMEL_CASE, '$1-$2').toLowerCase();
	}

	/**
	 * Get data from the given element.
	 * @param {Element} element - The target element.
	 * @param {string} name - The data key to get.
	 * @returns {string} The data value.
	 */
	function getData(element, name) {
		if (isObject(element[name])) {
			return element[name];
		}
		if (element.dataset) {
			return element.dataset[name];
		}
		return element.getAttribute("data-".concat(toParamCase(name)));
	}

	/**
	 * Set data to the given element.
	 * @param {Element} element - The target element.
	 * @param {string} name - The data key to set.
	 * @param {string} data - The data value.
	 */
	function setData(element, name, data) {
		if (isObject(data)) {
			element[name] = data;
		} else if (element.dataset) {
			element.dataset[name] = data;
		} else {
			element.setAttribute("data-".concat(toParamCase(name)), data);
		}
	}

	/**
	 * Remove data from the given element.
	 * @param {Element} element - The target element.
	 * @param {string} name - The data key to remove.
	 */
	function removeData(element, name) {
		if (isObject(element[name])) {
			try {
				delete element[name];
			} catch (error) {
				element[name] = undefined;
			}
		} else if (element.dataset) {
			// #128 Safari not allows to delete dataset property
			try {
				delete element.dataset[name];
			} catch (error) {
				element.dataset[name] = undefined;
			}
		} else {
			element.removeAttribute("data-".concat(toParamCase(name)));
		}
	}
	var REGEXP_SPACES = /\s\s*/;
	var onceSupported = function () {
		var supported = false;
		if (IS_BROWSER) {
			var once = false;
			var listener = function listener() {};
			var options = Object.defineProperty({}, 'once', {
				get: function get() {
					supported = true;
					return once;
				},
				/**
				 * This setter can fix a `TypeError` in strict mode
				 * {@link https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Errors/Getter_only}
				 * @param {boolean} value - The value to set
				 */
				set: function set(value) {
					once = value;
				}
			});
			WINDOW.addEventListener('test', listener, options);
			WINDOW.removeEventListener('test', listener, options);
		}
		return supported;
	}();

	/**
	 * Remove event listener from the target element.
	 * @param {Element} element - The event target.
	 * @param {string} type - The event type(s).
	 * @param {Function} listener - The event listener.
	 * @param {Object} options - The event options.
	 */
	function removeListener(element, type, listener) {
		var options = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : {};
		var handler = listener;
		type.trim().split(REGEXP_SPACES).forEach(function (event) {
			if (!onceSupported) {
				var listeners = element.listeners;
				if (listeners && listeners[event] && listeners[event][listener]) {
					handler = listeners[event][listener];
					delete listeners[event][listener];
					if (Object.keys(listeners[event]).length === 0) {
						delete listeners[event];
					}
					if (Object.keys(listeners).length === 0) {
						delete element.listeners;
					}
				}
			}
			element.removeEventListener(event, handler, options);
		});
	}

	/**
	 * Add event listener to the target element.
	 * @param {Element} element - The event target.
	 * @param {string} type - The event type(s).
	 * @param {Function} listener - The event listener.
	 * @param {Object} options - The event options.
	 */
	function addListener(element, type, listener) {
		var options = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : {};
		var _handler = listener;
		type.trim().split(REGEXP_SPACES).forEach(function (event) {
			if (options.once && !onceSupported) {
				var _element$listeners = element.listeners,
					listeners = _element$listeners === void 0 ? {} : _element$listeners;
				_handler = function handler() {
					delete listeners[event][listener];
					element.removeEventListener(event, _handler, options);
					for (var _len2 = arguments.length, args = new Array(_len2), _key2 = 0; _key2 < _len2; _key2++) {
						args[_key2] = arguments[_key2];
					}
					listener.apply(element, args);
				};
				if (!listeners[event]) {
					listeners[event] = {};
				}
				if (listeners[event][listener]) {
					element.removeEventListener(event, listeners[event][listener], options);
				}
				listeners[event][listener] = _handler;
				element.listeners = listeners;
			}
			element.addEventListener(event, _handler, options);
		});
	}

	/**
	 * Dispatch event on the target element.
	 * @param {Element} element - The event target.
	 * @param {string} type - The event type(s).
	 * @param {Object} data - The additional event data.
	 * @returns {boolean} Indicate if the event is default prevented or not.
	 */
	function dispatchEvent(element, type, data) {
		var event;

		// Event and CustomEvent on IE9-11 are global objects, not constructors
		if (isFunction(Event) && isFunction(CustomEvent)) {
			event = new CustomEvent(type, {
				detail: data,
				bubbles: true,
				cancelable: true
			});
		} else {
			event = document.createEvent('CustomEvent');
			event.initCustomEvent(type, true, true, data);
		}
		return element.dispatchEvent(event);
	}

	/**
	 * Get the offset base on the document.
	 * @param {Element} element - The target element.
	 * @returns {Object} The offset data.
	 */
	function getOffset(element) {
		var box = element.getBoundingClientRect();
		return {
			left: box.left + (window.pageXOffset - document.documentElement.clientLeft),
			top: box.top + (window.pageYOffset - document.documentElement.clientTop)
		};
	}
	var location = WINDOW.location;
	var REGEXP_ORIGINS = /^(\w+:)\/\/([^:/?#]*):?(\d*)/i;

	/**
	 * Check if the given URL is a cross origin URL.
	 * @param {string} url - The target URL.
	 * @returns {boolean} Returns `true` if the given URL is a cross origin URL, else `false`.
	 */
	function isCrossOriginURL(url) {
		var parts = url.match(REGEXP_ORIGINS);
		return parts !== null && (parts[1] !== location.protocol || parts[2] !== location.hostname || parts[3] !== location.port);
	}

	/**
	 * Add timestamp to the given URL.
	 * @param {string} url - The target URL.
	 * @returns {string} The result URL.
	 */
	function addTimestamp(url) {
		var timestamp = "timestamp=".concat(new Date().getTime());
		return url + (url.indexOf('?') === -1 ? '?' : '&') + timestamp;
	}

	/**
	 * Get transforms base on the given object.
	 * @param {Object} obj - The target object.
	 * @returns {string} A string contains transform values.
	 */
	function getTransforms(_ref) {
		var rotate = _ref.rotate,
			scaleX = _ref.scaleX,
			scaleY = _ref.scaleY,
			translateX = _ref.translateX,
			translateY = _ref.translateY;
		var values = [];
		if (isNumber(translateX) && translateX !== 0) {
			values.push("translateX(".concat(translateX, "px)"));
		}
		if (isNumber(translateY) && translateY !== 0) {
			values.push("translateY(".concat(translateY, "px)"));
		}

		// Rotate should come first before scale to match orientation transform
		if (isNumber(rotate) && rotate !== 0) {
			values.push("rotate(".concat(rotate, "deg)"));
		}
		if (isNumber(scaleX) && scaleX !== 1) {
			values.push("scaleX(".concat(scaleX, ")"));
		}
		if (isNumber(scaleY) && scaleY !== 1) {
			values.push("scaleY(".concat(scaleY, ")"));
		}
		var transform = values.length ? values.join(' ') : 'none';
		return {
			WebkitTransform: transform,
			msTransform: transform,
			transform: transform
		};
	}

	/**
	 * Get the max ratio of a group of pointers.
	 * @param {string} pointers - The target pointers.
	 * @returns {number} The result ratio.
	 */
	function getMaxZoomRatio(pointers) {
		var pointers2 = _objectSpread2({}, pointers);
		var maxRatio = 0;
		forEach(pointers, function (pointer, pointerId) {
			delete pointers2[pointerId];
			forEach(pointers2, function (pointer2) {
				var x1 = Math.abs(pointer.startX - pointer2.startX);
				var y1 = Math.abs(pointer.startY - pointer2.startY);
				var x2 = Math.abs(pointer.endX - pointer2.endX);
				var y2 = Math.abs(pointer.endY - pointer2.endY);
				var z1 = Math.sqrt(x1 * x1 + y1 * y1);
				var z2 = Math.sqrt(x2 * x2 + y2 * y2);
				var ratio = (z2 - z1) / z1;
				if (Math.abs(ratio) > Math.abs(maxRatio)) {
					maxRatio = ratio;
				}
			});
		});
		return maxRatio;
	}

	/**
	 * Get a pointer from an event object.
	 * @param {Object} event - The target event object.
	 * @param {boolean} endOnly - Indicates if only returns the end point coordinate or not.
	 * @returns {Object} The result pointer contains start and/or end point coordinates.
	 */
	function getPointer(_ref2, endOnly) {
		var pageX = _ref2.pageX,
			pageY = _ref2.pageY;
		var end = {
			endX: pageX,
			endY: pageY
		};
		return endOnly ? end : _objectSpread2({
			startX: pageX,
			startY: pageY
		}, end);
	}

	/**
	 * Get the center point coordinate of a group of pointers.
	 * @param {Object} pointers - The target pointers.
	 * @returns {Object} The center point coordinate.
	 */
	function getPointersCenter(pointers) {
		var pageX = 0;
		var pageY = 0;
		var count = 0;
		forEach(pointers, function (_ref3) {
			var startX = _ref3.startX,
				startY = _ref3.startY;
			pageX += startX;
			pageY += startY;
			count += 1;
		});
		pageX /= count;
		pageY /= count;
		return {
			pageX: pageX,
			pageY: pageY
		};
	}

	/**
	 * Get the max sizes in a rectangle under the given aspect ratio.
	 * @param {Object} data - The original sizes.
	 * @param {string} [type='contain'] - The adjust type.
	 * @returns {Object} The result sizes.
	 */
	function getAdjustedSizes(_ref4) {
		var aspectRatio = _ref4.aspectRatio,
			height = _ref4.height,
			width = _ref4.width;
		var type = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : 'contain';
		var isValidWidth = isPositiveNumber(width);
		var isValidHeight = isPositiveNumber(height);
		if (isValidWidth && isValidHeight) {
			var adjustedWidth = height * aspectRatio;
			if (type === 'contain' && adjustedWidth > width || type === 'cover' && adjustedWidth < width) {
				height = width / aspectRatio;
			} else {
				width = height * aspectRatio;
			}
		} else if (isValidWidth) {
			height = width / aspectRatio;
		} else if (isValidHeight) {
			width = height * aspectRatio;
		}
		return {
			width: width,
			height: height
		};
	}

	/**
	 * Get the new sizes of a rectangle after rotated.
	 * @param {Object} data - The original sizes.
	 * @returns {Object} The result sizes.
	 */
	function getRotatedSizes(_ref5) {
		var width = _ref5.width,
			height = _ref5.height,
			degree = _ref5.degree;
		degree = Math.abs(degree) % 180;
		if (degree === 90) {
			return {
				width: height,
				height: width
			};
		}
		var arc = degree % 90 * Math.PI / 180;
		var sinArc = Math.sin(arc);
		var cosArc = Math.cos(arc);
		var newWidth = width * cosArc + height * sinArc;
		var newHeight = width * sinArc + height * cosArc;
		return degree > 90 ? {
			width: newHeight,
			height: newWidth
		} : {
			width: newWidth,
			height: newHeight
		};
	}

	/**
	 * Get a canvas which drew the given image.
	 * @param {HTMLImageElement} image - The image for drawing.
	 * @param {Object} imageData - The image data.
	 * @param {Object} canvasData - The canvas data.
	 * @param {Object} options - The options.
	 * @returns {HTMLCanvasElement} The result canvas.
	 */
	function getSourceCanvas(image, _ref6, _ref7, _ref8) {
		var imageAspectRatio = _ref6.aspectRatio,
			imageNaturalWidth = _ref6.naturalWidth,
			imageNaturalHeight = _ref6.naturalHeight,
			_ref6$rotate = _ref6.rotate,
			rotate = _ref6$rotate === void 0 ? 0 : _ref6$rotate,
			_ref6$scaleX = _ref6.scaleX,
			scaleX = _ref6$scaleX === void 0 ? 1 : _ref6$scaleX,
			_ref6$scaleY = _ref6.scaleY,
			scaleY = _ref6$scaleY === void 0 ? 1 : _ref6$scaleY;
		var aspectRatio = _ref7.aspectRatio,
			naturalWidth = _ref7.naturalWidth,
			naturalHeight = _ref7.naturalHeight;
		var _ref8$fillColor = _ref8.fillColor,
			fillColor = _ref8$fillColor === void 0 ? 'transparent' : _ref8$fillColor,
			_ref8$imageSmoothingE = _ref8.imageSmoothingEnabled,
			imageSmoothingEnabled = _ref8$imageSmoothingE === void 0 ? true : _ref8$imageSmoothingE,
			_ref8$imageSmoothingQ = _ref8.imageSmoothingQuality,
			imageSmoothingQuality = _ref8$imageSmoothingQ === void 0 ? 'low' : _ref8$imageSmoothingQ,
			_ref8$maxWidth = _ref8.maxWidth,
			maxWidth = _ref8$maxWidth === void 0 ? Infinity : _ref8$maxWidth,
			_ref8$maxHeight = _ref8.maxHeight,
			maxHeight = _ref8$maxHeight === void 0 ? Infinity : _ref8$maxHeight,
			_ref8$minWidth = _ref8.minWidth,
			minWidth = _ref8$minWidth === void 0 ? 0 : _ref8$minWidth,
			_ref8$minHeight = _ref8.minHeight,
			minHeight = _ref8$minHeight === void 0 ? 0 : _ref8$minHeight;
		var canvas = document.createElement('canvas');
		var context = canvas.getContext('2d');
		var maxSizes = getAdjustedSizes({
			aspectRatio: aspectRatio,
			width: maxWidth,
			height: maxHeight
		});
		var minSizes = getAdjustedSizes({
			aspectRatio: aspectRatio,
			width: minWidth,
			height: minHeight
		}, 'cover');
		var width = Math.min(maxSizes.width, Math.max(minSizes.width, naturalWidth));
		var height = Math.min(maxSizes.height, Math.max(minSizes.height, naturalHeight));

		// Note: should always use image's natural sizes for drawing as
		// imageData.naturalWidth === canvasData.naturalHeight when rotate % 180 === 90
		var destMaxSizes = getAdjustedSizes({
			aspectRatio: imageAspectRatio,
			width: maxWidth,
			height: maxHeight
		});
		var destMinSizes = getAdjustedSizes({
			aspectRatio: imageAspectRatio,
			width: minWidth,
			height: minHeight
		}, 'cover');
		var destWidth = Math.min(destMaxSizes.width, Math.max(destMinSizes.width, imageNaturalWidth));
		var destHeight = Math.min(destMaxSizes.height, Math.max(destMinSizes.height, imageNaturalHeight));
		var params = [-destWidth / 2, -destHeight / 2, destWidth, destHeight];
		canvas.width = normalizeDecimalNumber(width);
		canvas.height = normalizeDecimalNumber(height);
		context.fillStyle = fillColor;
		context.fillRect(0, 0, width, height);
		context.save();
		context.translate(width / 2, height / 2);
		context.rotate(rotate * Math.PI / 180);
		context.scale(scaleX, scaleY);
		context.imageSmoothingEnabled = imageSmoothingEnabled;
		context.imageSmoothingQuality = imageSmoothingQuality;
		context.drawImage.apply(context, [image].concat(_toConsumableArray(params.map(function (param) {
			return Math.floor(normalizeDecimalNumber(param));
		}))));
		context.restore();
		return canvas;
	}
	var fromCharCode = String.fromCharCode;

	/**
	 * Get string from char code in data view.
	 * @param {DataView} dataView - The data view for read.
	 * @param {number} start - The start index.
	 * @param {number} length - The read length.
	 * @returns {string} The read result.
	 */
	function getStringFromCharCode(dataView, start, length) {
		var str = '';
		length += start;
		for (var i = start; i < length; i += 1) {
			str += fromCharCode(dataView.getUint8(i));
		}
		return str;
	}
	var REGEXP_DATA_URL_HEAD = /^data:.*,/;

	/**
	 * Transform Data URL to array buffer.
	 * @param {string} dataURL - The Data URL to transform.
	 * @returns {ArrayBuffer} The result array buffer.
	 */
	function dataURLToArrayBuffer(dataURL) {
		var base64 = dataURL.replace(REGEXP_DATA_URL_HEAD, '');
		var binary = atob(base64);
		var arrayBuffer = new ArrayBuffer(binary.length);
		var uint8 = new Uint8Array(arrayBuffer);
		forEach(uint8, function (value, i) {
			uint8[i] = binary.charCodeAt(i);
		});
		return arrayBuffer;
	}

	/**
	 * Transform array buffer to Data URL.
	 * @param {ArrayBuffer} arrayBuffer - The array buffer to transform.
	 * @param {string} mimeType - The mime type of the Data URL.
	 * @returns {string} The result Data URL.
	 */
	function arrayBufferToDataURL(arrayBuffer, mimeType) {
		var chunks = [];

		// Chunk Typed Array for better performance (#435)
		var chunkSize = 8192;
		var uint8 = new Uint8Array(arrayBuffer);
		while (uint8.length > 0) {
			// XXX: Babel's `toConsumableArray` helper will throw error in IE or Safari 9
			// eslint-disable-next-line prefer-spread
			chunks.push(fromCharCode.apply(null, toArray(uint8.subarray(0, chunkSize))));
			uint8 = uint8.subarray(chunkSize);
		}
		return "data:".concat(mimeType, ";base64,").concat(btoa(chunks.join('')));
	}

	/**
	 * Get orientation value from given array buffer.
	 * @param {ArrayBuffer} arrayBuffer - The array buffer to read.
	 * @returns {number} The read orientation value.
	 */
	function resetAndGetOrientation(arrayBuffer) {
		var dataView = new DataView(arrayBuffer);
		var orientation;

		// Ignores range error when the image does not have correct Exif information
		try {
			var littleEndian;
			var app1Start;
			var ifdStart;

			// Only handle JPEG image (start by 0xFFD8)
			if (dataView.getUint8(0) === 0xFF && dataView.getUint8(1) === 0xD8) {
				var length = dataView.byteLength;
				var offset = 2;
				while (offset + 1 < length) {
					if (dataView.getUint8(offset) === 0xFF && dataView.getUint8(offset + 1) === 0xE1) {
						app1Start = offset;
						break;
					}
					offset += 1;
				}
			}
			if (app1Start) {
				var exifIDCode = app1Start + 4;
				var tiffOffset = app1Start + 10;
				if (getStringFromCharCode(dataView, exifIDCode, 4) === 'Exif') {
					var endianness = dataView.getUint16(tiffOffset);
					littleEndian = endianness === 0x4949;
					if (littleEndian || endianness === 0x4D4D /* bigEndian */) {
						if (dataView.getUint16(tiffOffset + 2, littleEndian) === 0x002A) {
							var firstIFDOffset = dataView.getUint32(tiffOffset + 4, littleEndian);
							if (firstIFDOffset >= 0x00000008) {
								ifdStart = tiffOffset + firstIFDOffset;
							}
						}
					}
				}
			}
			if (ifdStart) {
				var _length = dataView.getUint16(ifdStart, littleEndian);
				var _offset;
				var i;
				for (i = 0; i < _length; i += 1) {
					_offset = ifdStart + i * 12 + 2;
					if (dataView.getUint16(_offset, littleEndian) === 0x0112 /* Orientation */) {
						// 8 is the offset of the current tag's value
						_offset += 8;

						// Get the original orientation value
						orientation = dataView.getUint16(_offset, littleEndian);

						// Override the orientation with its default value
						dataView.setUint16(_offset, 1, littleEndian);
						break;
					}
				}
			}
		} catch (error) {
			orientation = 1;
		}
		return orientation;
	}

	/**
	 * Parse Exif Orientation value.
	 * @param {number} orientation - The orientation to parse.
	 * @returns {Object} The parsed result.
	 */
	function parseOrientation(orientation) {
		var rotate = 0;
		var scaleX = 1;
		var scaleY = 1;
		switch (orientation) {
			// Flip horizontal
			case 2:
				scaleX = -1;
				break;

			// Rotate left 180
			case 3:
				rotate = -180;
				break;

			// Flip vertical
			case 4:
				scaleY = -1;
				break;

			// Flip vertical and rotate right 90
			case 5:
				rotate = 90;
				scaleY = -1;
				break;

			// Rotate right 90
			case 6:
				rotate = 90;
				break;

			// Flip horizontal and rotate right 90
			case 7:
				rotate = 90;
				scaleX = -1;
				break;

			// Rotate left 90
			case 8:
				rotate = -90;
				break;
		}
		return {
			rotate: rotate,
			scaleX: scaleX,
			scaleY: scaleY
		};
	}

	var render = {
		render: function render() {
			this.initContainer();
			this.initCanvas();
			this.initCropBox();
			this.renderCanvas();
			if (this.cropped) {
				this.renderCropBox();
			}
		},
		initContainer: function initContainer() {
			var element = this.element,
				options = this.options,
				container = this.container,
				cropper = this.cropper;
			var minWidth = Number(options.minContainerWidth);
			var minHeight = Number(options.minContainerHeight);
			addClass(cropper, CLASS_HIDDEN);
			removeClass(element, CLASS_HIDDEN);
			var containerData = {
				width: Math.max(container.offsetWidth, minWidth >= 0 ? minWidth : MIN_CONTAINER_WIDTH),
				height: Math.max(container.offsetHeight, minHeight >= 0 ? minHeight : MIN_CONTAINER_HEIGHT)
			};
			this.containerData = containerData;
			setStyle(cropper, {
				width: containerData.width,
				height: containerData.height
			});
			addClass(element, CLASS_HIDDEN);
			removeClass(cropper, CLASS_HIDDEN);
		},
		// Canvas (image wrapper)
		initCanvas: function initCanvas() {
			var containerData = this.containerData,
				imageData = this.imageData;
			var viewMode = this.options.viewMode;
			var rotated = Math.abs(imageData.rotate) % 180 === 90;
			var naturalWidth = rotated ? imageData.naturalHeight : imageData.naturalWidth;
			var naturalHeight = rotated ? imageData.naturalWidth : imageData.naturalHeight;
			var aspectRatio = naturalWidth / naturalHeight;
			var canvasWidth = containerData.width;
			var canvasHeight = containerData.height;
			if (containerData.height * aspectRatio > containerData.width) {
				if (viewMode === 3) {
					canvasWidth = containerData.height * aspectRatio;
				} else {
					canvasHeight = containerData.width / aspectRatio;
				}
			} else if (viewMode === 3) {
				canvasHeight = containerData.width / aspectRatio;
			} else {
				canvasWidth = containerData.height * aspectRatio;
			}
			var canvasData = {
				aspectRatio: aspectRatio,
				naturalWidth: naturalWidth,
				naturalHeight: naturalHeight,
				width: canvasWidth,
				height: canvasHeight
			};
			this.canvasData = canvasData;
			this.limited = viewMode === 1 || viewMode === 2;
			this.limitCanvas(true, true);
			canvasData.width = Math.min(Math.max(canvasData.width, canvasData.minWidth), canvasData.maxWidth);
			canvasData.height = Math.min(Math.max(canvasData.height, canvasData.minHeight), canvasData.maxHeight);
			canvasData.left = (containerData.width - canvasData.width) / 2;
			canvasData.top = (containerData.height - canvasData.height) / 2;
			canvasData.oldLeft = canvasData.left;
			canvasData.oldTop = canvasData.top;
			this.initialCanvasData = assign({}, canvasData);
		},
		limitCanvas: function limitCanvas(sizeLimited, positionLimited) {
			var options = this.options,
				containerData = this.containerData,
				canvasData = this.canvasData,
				cropBoxData = this.cropBoxData;
			var viewMode = options.viewMode;
			var aspectRatio = canvasData.aspectRatio;
			var cropped = this.cropped && cropBoxData;
			if (sizeLimited) {
				var minCanvasWidth = Number(options.minCanvasWidth) || 0;
				var minCanvasHeight = Number(options.minCanvasHeight) || 0;
				if (viewMode > 1) {
					minCanvasWidth = Math.max(minCanvasWidth, containerData.width);
					minCanvasHeight = Math.max(minCanvasHeight, containerData.height);
					if (viewMode === 3) {
						if (minCanvasHeight * aspectRatio > minCanvasWidth) {
							minCanvasWidth = minCanvasHeight * aspectRatio;
						} else {
							minCanvasHeight = minCanvasWidth / aspectRatio;
						}
					}
				} else if (viewMode > 0) {
					if (minCanvasWidth) {
						minCanvasWidth = Math.max(minCanvasWidth, cropped ? cropBoxData.width : 0);
					} else if (minCanvasHeight) {
						minCanvasHeight = Math.max(minCanvasHeight, cropped ? cropBoxData.height : 0);
					} else if (cropped) {
						minCanvasWidth = cropBoxData.width;
						minCanvasHeight = cropBoxData.height;
						if (minCanvasHeight * aspectRatio > minCanvasWidth) {
							minCanvasWidth = minCanvasHeight * aspectRatio;
						} else {
							minCanvasHeight = minCanvasWidth / aspectRatio;
						}
					}
				}
				var _getAdjustedSizes = getAdjustedSizes({
					aspectRatio: aspectRatio,
					width: minCanvasWidth,
					height: minCanvasHeight
				});
				minCanvasWidth = _getAdjustedSizes.width;
				minCanvasHeight = _getAdjustedSizes.height;
				canvasData.minWidth = minCanvasWidth;
				canvasData.minHeight = minCanvasHeight;
				canvasData.maxWidth = Infinity;
				canvasData.maxHeight = Infinity;
			}
			if (positionLimited) {
				if (viewMode > (cropped ? 0 : 1)) {
					var newCanvasLeft = containerData.width - canvasData.width;
					var newCanvasTop = containerData.height - canvasData.height;
					canvasData.minLeft = Math.min(0, newCanvasLeft);
					canvasData.minTop = Math.min(0, newCanvasTop);
					canvasData.maxLeft = Math.max(0, newCanvasLeft);
					canvasData.maxTop = Math.max(0, newCanvasTop);
					if (cropped && this.limited) {
						canvasData.minLeft = Math.min(cropBoxData.left, cropBoxData.left + (cropBoxData.width - canvasData.width));
						canvasData.minTop = Math.min(cropBoxData.top, cropBoxData.top + (cropBoxData.height - canvasData.height));
						canvasData.maxLeft = cropBoxData.left;
						canvasData.maxTop = cropBoxData.top;
						if (viewMode === 2) {
							if (canvasData.width >= containerData.width) {
								canvasData.minLeft = Math.min(0, newCanvasLeft);
								canvasData.maxLeft = Math.max(0, newCanvasLeft);
							}
							if (canvasData.height >= containerData.height) {
								canvasData.minTop = Math.min(0, newCanvasTop);
								canvasData.maxTop = Math.max(0, newCanvasTop);
							}
						}
					}
				} else {
					canvasData.minLeft = -canvasData.width;
					canvasData.minTop = -canvasData.height;
					canvasData.maxLeft = containerData.width;
					canvasData.maxTop = containerData.height;
				}
			}
		},
		renderCanvas: function renderCanvas(changed, transformed) {
			var canvasData = this.canvasData,
				imageData = this.imageData;
			if (transformed) {
				var _getRotatedSizes = getRotatedSizes({
						width: imageData.naturalWidth * Math.abs(imageData.scaleX || 1),
						height: imageData.naturalHeight * Math.abs(imageData.scaleY || 1),
						degree: imageData.rotate || 0
					}),
					naturalWidth = _getRotatedSizes.width,
					naturalHeight = _getRotatedSizes.height;
				var width = canvasData.width * (naturalWidth / canvasData.naturalWidth);
				var height = canvasData.height * (naturalHeight / canvasData.naturalHeight);
				canvasData.left -= (width - canvasData.width) / 2;
				canvasData.top -= (height - canvasData.height) / 2;
				canvasData.width = width;
				canvasData.height = height;
				canvasData.aspectRatio = naturalWidth / naturalHeight;
				canvasData.naturalWidth = naturalWidth;
				canvasData.naturalHeight = naturalHeight;
				this.limitCanvas(true, false);
			}
			if (canvasData.width > canvasData.maxWidth || canvasData.width < canvasData.minWidth) {
				canvasData.left = canvasData.oldLeft;
			}
			if (canvasData.height > canvasData.maxHeight || canvasData.height < canvasData.minHeight) {
				canvasData.top = canvasData.oldTop;
			}
			canvasData.width = Math.min(Math.max(canvasData.width, canvasData.minWidth), canvasData.maxWidth);
			canvasData.height = Math.min(Math.max(canvasData.height, canvasData.minHeight), canvasData.maxHeight);
			this.limitCanvas(false, true);
			canvasData.left = Math.min(Math.max(canvasData.left, canvasData.minLeft), canvasData.maxLeft);
			canvasData.top = Math.min(Math.max(canvasData.top, canvasData.minTop), canvasData.maxTop);
			canvasData.oldLeft = canvasData.left;
			canvasData.oldTop = canvasData.top;
			setStyle(this.canvas, assign({
				width: canvasData.width,
				height: canvasData.height
			}, getTransforms({
				translateX: canvasData.left,
				translateY: canvasData.top
			})));
			this.renderImage(changed);
			if (this.cropped && this.limited) {
				this.limitCropBox(true, true);
			}
		},
		renderImage: function renderImage(changed) {
			var canvasData = this.canvasData,
				imageData = this.imageData;
			var width = imageData.naturalWidth * (canvasData.width / canvasData.naturalWidth);
			var height = imageData.naturalHeight * (canvasData.height / canvasData.naturalHeight);
			assign(imageData, {
				width: width,
				height: height,
				left: (canvasData.width - width) / 2,
				top: (canvasData.height - height) / 2
			});
			setStyle(this.image, assign({
				width: imageData.width,
				height: imageData.height
			}, getTransforms(assign({
				translateX: imageData.left,
				translateY: imageData.top
			}, imageData))));
			if (changed) {
				this.output();
			}
		},
		initCropBox: function initCropBox() {
			var options = this.options,
				canvasData = this.canvasData;
			var aspectRatio = options.aspectRatio || options.initialAspectRatio;
			var autoCropArea = Number(options.autoCropArea) || 0.8;
			var cropBoxData = {
				width: canvasData.width,
				height: canvasData.height
			};
			if (aspectRatio) {
				if (canvasData.height * aspectRatio > canvasData.width) {
					cropBoxData.height = cropBoxData.width / aspectRatio;
				} else {
					cropBoxData.width = cropBoxData.height * aspectRatio;
				}
			}
			this.cropBoxData = cropBoxData;
			this.limitCropBox(true, true);

			// Initialize auto crop area
			cropBoxData.width = Math.min(Math.max(cropBoxData.width, cropBoxData.minWidth), cropBoxData.maxWidth);
			cropBoxData.height = Math.min(Math.max(cropBoxData.height, cropBoxData.minHeight), cropBoxData.maxHeight);

			// The width/height of auto crop area must large than "minWidth/Height"
			cropBoxData.width = Math.max(cropBoxData.minWidth, cropBoxData.width * autoCropArea);
			cropBoxData.height = Math.max(cropBoxData.minHeight, cropBoxData.height * autoCropArea);
			cropBoxData.left = canvasData.left + (canvasData.width - cropBoxData.width) / 2;
			cropBoxData.top = canvasData.top + (canvasData.height - cropBoxData.height) / 2;
			cropBoxData.oldLeft = cropBoxData.left;
			cropBoxData.oldTop = cropBoxData.top;
			this.initialCropBoxData = assign({}, cropBoxData);
		},
		limitCropBox: function limitCropBox(sizeLimited, positionLimited) {
			var options = this.options,
				containerData = this.containerData,
				canvasData = this.canvasData,
				cropBoxData = this.cropBoxData,
				limited = this.limited;
			var aspectRatio = options.aspectRatio;
			if (sizeLimited) {
				var minCropBoxWidth = Number(options.minCropBoxWidth) || 0;
				var minCropBoxHeight = Number(options.minCropBoxHeight) || 0;
				var maxCropBoxWidth = limited ? Math.min(containerData.width, canvasData.width, canvasData.width + canvasData.left, containerData.width - canvasData.left) : containerData.width;
				var maxCropBoxHeight = limited ? Math.min(containerData.height, canvasData.height, canvasData.height + canvasData.top, containerData.height - canvasData.top) : containerData.height;

				// The min/maxCropBoxWidth/Height must be less than container's width/height
				minCropBoxWidth = Math.min(minCropBoxWidth, containerData.width);
				minCropBoxHeight = Math.min(minCropBoxHeight, containerData.height);
				if (aspectRatio) {
					if (minCropBoxWidth && minCropBoxHeight) {
						if (minCropBoxHeight * aspectRatio > minCropBoxWidth) {
							minCropBoxHeight = minCropBoxWidth / aspectRatio;
						} else {
							minCropBoxWidth = minCropBoxHeight * aspectRatio;
						}
					} else if (minCropBoxWidth) {
						minCropBoxHeight = minCropBoxWidth / aspectRatio;
					} else if (minCropBoxHeight) {
						minCropBoxWidth = minCropBoxHeight * aspectRatio;
					}
					if (maxCropBoxHeight * aspectRatio > maxCropBoxWidth) {
						maxCropBoxHeight = maxCropBoxWidth / aspectRatio;
					} else {
						maxCropBoxWidth = maxCropBoxHeight * aspectRatio;
					}
				}

				// The minWidth/Height must be less than maxWidth/Height
				cropBoxData.minWidth = Math.min(minCropBoxWidth, maxCropBoxWidth);
				cropBoxData.minHeight = Math.min(minCropBoxHeight, maxCropBoxHeight);
				cropBoxData.maxWidth = maxCropBoxWidth;
				cropBoxData.maxHeight = maxCropBoxHeight;
			}
			if (positionLimited) {
				if (limited) {
					cropBoxData.minLeft = Math.max(0, canvasData.left);
					cropBoxData.minTop = Math.max(0, canvasData.top);
					cropBoxData.maxLeft = Math.min(containerData.width, canvasData.left + canvasData.width) - cropBoxData.width;
					cropBoxData.maxTop = Math.min(containerData.height, canvasData.top + canvasData.height) - cropBoxData.height;
				} else {
					cropBoxData.minLeft = 0;
					cropBoxData.minTop = 0;
					cropBoxData.maxLeft = containerData.width - cropBoxData.width;
					cropBoxData.maxTop = containerData.height - cropBoxData.height;
				}
			}
		},
		renderCropBox: function renderCropBox() {
			var options = this.options,
				containerData = this.containerData,
				cropBoxData = this.cropBoxData;
			if (cropBoxData.width > cropBoxData.maxWidth || cropBoxData.width < cropBoxData.minWidth) {
				cropBoxData.left = cropBoxData.oldLeft;
			}
			if (cropBoxData.height > cropBoxData.maxHeight || cropBoxData.height < cropBoxData.minHeight) {
				cropBoxData.top = cropBoxData.oldTop;
			}
			cropBoxData.width = Math.min(Math.max(cropBoxData.width, cropBoxData.minWidth), cropBoxData.maxWidth);
			cropBoxData.height = Math.min(Math.max(cropBoxData.height, cropBoxData.minHeight), cropBoxData.maxHeight);
			this.limitCropBox(false, true);
			cropBoxData.left = Math.min(Math.max(cropBoxData.left, cropBoxData.minLeft), cropBoxData.maxLeft);
			cropBoxData.top = Math.min(Math.max(cropBoxData.top, cropBoxData.minTop), cropBoxData.maxTop);
			cropBoxData.oldLeft = cropBoxData.left;
			cropBoxData.oldTop = cropBoxData.top;
			if (options.movable && options.cropBoxMovable) {
				// Turn to move the canvas when the crop box is equal to the container
				setData(this.face, DATA_ACTION, cropBoxData.width >= containerData.width && cropBoxData.height >= containerData.height ? ACTION_MOVE : ACTION_ALL);
			}
			setStyle(this.cropBox, assign({
				width: cropBoxData.width,
				height: cropBoxData.height
			}, getTransforms({
				translateX: cropBoxData.left,
				translateY: cropBoxData.top
			})));
			if (this.cropped && this.limited) {
				this.limitCanvas(true, true);
			}
			if (!this.disabled) {
				this.output();
			}
		},
		output: function output() {
			this.preview();
			dispatchEvent(this.element, EVENT_CROP, this.getData());
		}
	};

	var preview = {
		initPreview: function initPreview() {
			var element = this.element,
				crossOrigin = this.crossOrigin;
			var preview = this.options.preview;
			var url = crossOrigin ? this.crossOriginUrl : this.url;
			var alt = element.alt || 'The image to preview';
			var image = document.createElement('img');
			if (crossOrigin) {
				image.crossOrigin = crossOrigin;
			}
			image.src = url;
			image.alt = alt;
			this.viewBox.appendChild(image);
			this.viewBoxImage = image;
			if (!preview) {
				return;
			}
			var previews = preview;
			if (typeof preview === 'string') {
				previews = element.ownerDocument.querySelectorAll(preview);
			} else if (preview.querySelector) {
				previews = [preview];
			}
			this.previews = previews;
			forEach(previews, function (el) {
				var img = document.createElement('img');

				// Save the original size for recover
				setData(el, DATA_PREVIEW, {
					width: el.offsetWidth,
					height: el.offsetHeight,
					html: el.innerHTML
				});
				if (crossOrigin) {
					img.crossOrigin = crossOrigin;
				}
				img.src = url;
				img.alt = alt;

				/**
				 * Override img element styles
				 * Add `display:block` to avoid margin top issue
				 * Add `height:auto` to override `height` attribute on IE8
				 * (Occur only when margin-top <= -height)
				 */
				img.style.cssText = 'display:block;' + 'width:100%;' + 'height:auto;' + 'min-width:0!important;' + 'min-height:0!important;' + 'max-width:none!important;' + 'max-height:none!important;' + 'image-orientation:0deg!important;"';
				el.innerHTML = '';
				el.appendChild(img);
			});
		},
		resetPreview: function resetPreview() {
			forEach(this.previews, function (element) {
				var data = getData(element, DATA_PREVIEW);
				setStyle(element, {
					width: data.width,
					height: data.height
				});
				element.innerHTML = data.html;
				removeData(element, DATA_PREVIEW);
			});
		},
		preview: function preview() {
			var imageData = this.imageData,
				canvasData = this.canvasData,
				cropBoxData = this.cropBoxData;
			var cropBoxWidth = cropBoxData.width,
				cropBoxHeight = cropBoxData.height;
			var width = imageData.width,
				height = imageData.height;
			var left = cropBoxData.left - canvasData.left - imageData.left;
			var top = cropBoxData.top - canvasData.top - imageData.top;
			if (!this.cropped || this.disabled) {
				return;
			}
			setStyle(this.viewBoxImage, assign({
				width: width,
				height: height
			}, getTransforms(assign({
				translateX: -left,
				translateY: -top
			}, imageData))));
			forEach(this.previews, function (element) {
				var data = getData(element, DATA_PREVIEW);
				var originalWidth = data.width;
				var originalHeight = data.height;
				var newWidth = originalWidth;
				var newHeight = originalHeight;
				var ratio = 1;
				if (cropBoxWidth) {
					ratio = originalWidth / cropBoxWidth;
					newHeight = cropBoxHeight * ratio;
				}
				if (cropBoxHeight && newHeight > originalHeight) {
					ratio = originalHeight / cropBoxHeight;
					newWidth = cropBoxWidth * ratio;
					newHeight = originalHeight;
				}
				setStyle(element, {
					width: newWidth,
					height: newHeight
				});
				setStyle(element.getElementsByTagName('img')[0], assign({
					width: width * ratio,
					height: height * ratio
				}, getTransforms(assign({
					translateX: -left * ratio,
					translateY: -top * ratio
				}, imageData))));
			});
		}
	};

	var events = {
		bind: function bind() {
			var element = this.element,
				options = this.options,
				cropper = this.cropper;
			if (isFunction(options.cropstart)) {
				addListener(element, EVENT_CROP_START, options.cropstart);
			}
			if (isFunction(options.cropmove)) {
				addListener(element, EVENT_CROP_MOVE, options.cropmove);
			}
			if (isFunction(options.cropend)) {
				addListener(element, EVENT_CROP_END, options.cropend);
			}
			if (isFunction(options.crop)) {
				addListener(element, EVENT_CROP, options.crop);
			}
			if (isFunction(options.zoom)) {
				addListener(element, EVENT_ZOOM, options.zoom);
			}
			addListener(cropper, EVENT_POINTER_DOWN, this.onCropStart = this.cropStart.bind(this));
			if (options.zoomable && options.zoomOnWheel) {
				addListener(cropper, EVENT_WHEEL, this.onWheel = this.wheel.bind(this), {
					passive: false,
					capture: true
				});
			}
			if (options.toggleDragModeOnDblclick) {
				addListener(cropper, EVENT_DBLCLICK, this.onDblclick = this.dblclick.bind(this));
			}
			addListener(element.ownerDocument, EVENT_POINTER_MOVE, this.onCropMove = this.cropMove.bind(this));
			addListener(element.ownerDocument, EVENT_POINTER_UP, this.onCropEnd = this.cropEnd.bind(this));
			if (options.responsive) {
				addListener(window, EVENT_RESIZE, this.onResize = this.resize.bind(this));
			}
		},
		unbind: function unbind() {
			var element = this.element,
				options = this.options,
				cropper = this.cropper;
			if (isFunction(options.cropstart)) {
				removeListener(element, EVENT_CROP_START, options.cropstart);
			}
			if (isFunction(options.cropmove)) {
				removeListener(element, EVENT_CROP_MOVE, options.cropmove);
			}
			if (isFunction(options.cropend)) {
				removeListener(element, EVENT_CROP_END, options.cropend);
			}
			if (isFunction(options.crop)) {
				removeListener(element, EVENT_CROP, options.crop);
			}
			if (isFunction(options.zoom)) {
				removeListener(element, EVENT_ZOOM, options.zoom);
			}
			removeListener(cropper, EVENT_POINTER_DOWN, this.onCropStart);
			if (options.zoomable && options.zoomOnWheel) {
				removeListener(cropper, EVENT_WHEEL, this.onWheel, {
					passive: false,
					capture: true
				});
			}
			if (options.toggleDragModeOnDblclick) {
				removeListener(cropper, EVENT_DBLCLICK, this.onDblclick);
			}
			removeListener(element.ownerDocument, EVENT_POINTER_MOVE, this.onCropMove);
			removeListener(element.ownerDocument, EVENT_POINTER_UP, this.onCropEnd);
			if (options.responsive) {
				removeListener(window, EVENT_RESIZE, this.onResize);
			}
		}
	};

	var handlers = {
		resize: function resize() {
			if (this.disabled) {
				return;
			}
			var options = this.options,
				container = this.container,
				containerData = this.containerData;
			var ratioX = container.offsetWidth / containerData.width;
			var ratioY = container.offsetHeight / containerData.height;
			var ratio = Math.abs(ratioX - 1) > Math.abs(ratioY - 1) ? ratioX : ratioY;

			// Resize when width changed or height changed
			if (ratio !== 1) {
				var canvasData;
				var cropBoxData;
				if (options.restore) {
					canvasData = this.getCanvasData();
					cropBoxData = this.getCropBoxData();
				}
				this.render();
				if (options.restore) {
					this.setCanvasData(forEach(canvasData, function (n, i) {
						canvasData[i] = n * ratio;
					}));
					this.setCropBoxData(forEach(cropBoxData, function (n, i) {
						cropBoxData[i] = n * ratio;
					}));
				}
			}
		},
		dblclick: function dblclick() {
			if (this.disabled || this.options.dragMode === DRAG_MODE_NONE) {
				return;
			}
			this.setDragMode(hasClass(this.dragBox, CLASS_CROP) ? DRAG_MODE_MOVE : DRAG_MODE_CROP);
		},
		wheel: function wheel(event) {
			var _this = this;
			var ratio = Number(this.options.wheelZoomRatio) || 0.1;
			var delta = 1;
			if (this.disabled) {
				return;
			}
			event.preventDefault();

			// Limit wheel speed to prevent zoom too fast (#21)
			if (this.wheeling) {
				return;
			}
			this.wheeling = true;
			setTimeout(function () {
				_this.wheeling = false;
			}, 50);
			if (event.deltaY) {
				delta = event.deltaY > 0 ? 1 : -1;
			} else if (event.wheelDelta) {
				delta = -event.wheelDelta / 120;
			} else if (event.detail) {
				delta = event.detail > 0 ? 1 : -1;
			}
			this.zoom(-delta * ratio, event);
		},
		cropStart: function cropStart(event) {
			var buttons = event.buttons,
				button = event.button;
			if (this.disabled

				// Handle mouse event and pointer event and ignore touch event
				|| (event.type === 'mousedown' || event.type === 'pointerdown' && event.pointerType === 'mouse') && (
					// No primary button (Usually the left button)
					isNumber(buttons) && buttons !== 1 || isNumber(button) && button !== 0

					// Open context menu
					|| event.ctrlKey)) {
				return;
			}
			var options = this.options,
				pointers = this.pointers;
			var action;
			if (event.changedTouches) {
				// Handle touch event
				forEach(event.changedTouches, function (touch) {
					pointers[touch.identifier] = getPointer(touch);
				});
			} else {
				// Handle mouse event and pointer event
				pointers[event.pointerId || 0] = getPointer(event);
			}
			if (Object.keys(pointers).length > 1 && options.zoomable && options.zoomOnTouch) {
				action = ACTION_ZOOM;
			} else {
				action = getData(event.target, DATA_ACTION);
			}
			if (!REGEXP_ACTIONS.test(action)) {
				return;
			}
			if (dispatchEvent(this.element, EVENT_CROP_START, {
				originalEvent: event,
				action: action
			}) === false) {
				return;
			}

			// This line is required for preventing page zooming in iOS browsers
			event.preventDefault();
			this.action = action;
			this.cropping = false;
			if (action === ACTION_CROP) {
				this.cropping = true;
				addClass(this.dragBox, CLASS_MODAL);
			}
		},
		cropMove: function cropMove(event) {
			var action = this.action;
			if (this.disabled || !action) {
				return;
			}
			var pointers = this.pointers;
			event.preventDefault();
			if (dispatchEvent(this.element, EVENT_CROP_MOVE, {
				originalEvent: event,
				action: action
			}) === false) {
				return;
			}
			if (event.changedTouches) {
				forEach(event.changedTouches, function (touch) {
					// The first parameter should not be undefined (#432)
					assign(pointers[touch.identifier] || {}, getPointer(touch, true));
				});
			} else {
				assign(pointers[event.pointerId || 0] || {}, getPointer(event, true));
			}
			this.change(event);
		},
		cropEnd: function cropEnd(event) {
			if (this.disabled) {
				return;
			}
			var action = this.action,
				pointers = this.pointers;
			if (event.changedTouches) {
				forEach(event.changedTouches, function (touch) {
					delete pointers[touch.identifier];
				});
			} else {
				delete pointers[event.pointerId || 0];
			}
			if (!action) {
				return;
			}
			event.preventDefault();
			if (!Object.keys(pointers).length) {
				this.action = '';
			}
			if (this.cropping) {
				this.cropping = false;
				toggleClass(this.dragBox, CLASS_MODAL, this.cropped && this.options.modal);
			}
			dispatchEvent(this.element, EVENT_CROP_END, {
				originalEvent: event,
				action: action
			});
		}
	};

	var change = {
		change: function change(event) {
			var options = this.options,
				canvasData = this.canvasData,
				containerData = this.containerData,
				cropBoxData = this.cropBoxData,
				pointers = this.pointers;
			var action = this.action;
			var aspectRatio = options.aspectRatio;
			var left = cropBoxData.left,
				top = cropBoxData.top,
				width = cropBoxData.width,
				height = cropBoxData.height;
			var right = left + width;
			var bottom = top + height;
			var minLeft = 0;
			var minTop = 0;
			var maxWidth = containerData.width;
			var maxHeight = containerData.height;
			var renderable = true;
			var offset;

			// Locking aspect ratio in "free mode" by holding shift key
			if (!aspectRatio && event.shiftKey) {
				aspectRatio = width && height ? width / height : 1;
			}
			if (this.limited) {
				minLeft = cropBoxData.minLeft;
				minTop = cropBoxData.minTop;
				maxWidth = minLeft + Math.min(containerData.width, canvasData.width, canvasData.left + canvasData.width);
				maxHeight = minTop + Math.min(containerData.height, canvasData.height, canvasData.top + canvasData.height);
			}
			var pointer = pointers[Object.keys(pointers)[0]];
			var range = {
				x: pointer.endX - pointer.startX,
				y: pointer.endY - pointer.startY
			};
			var check = function check(side) {
				switch (side) {
					case ACTION_EAST:
						if (right + range.x > maxWidth) {
							range.x = maxWidth - right;
						}
						break;
					case ACTION_WEST:
						if (left + range.x < minLeft) {
							range.x = minLeft - left;
						}
						break;
					case ACTION_NORTH:
						if (top + range.y < minTop) {
							range.y = minTop - top;
						}
						break;
					case ACTION_SOUTH:
						if (bottom + range.y > maxHeight) {
							range.y = maxHeight - bottom;
						}
						break;
				}
			};
			switch (action) {
				// Move crop box
				case ACTION_ALL:
					left += range.x;
					top += range.y;
					break;

				// Resize crop box
				case ACTION_EAST:
					if (range.x >= 0 && (right >= maxWidth || aspectRatio && (top <= minTop || bottom >= maxHeight))) {
						renderable = false;
						break;
					}
					check(ACTION_EAST);
					width += range.x;
					if (width < 0) {
						action = ACTION_WEST;
						width = -width;
						left -= width;
					}
					if (aspectRatio) {
						height = width / aspectRatio;
						top += (cropBoxData.height - height) / 2;
					}
					break;
				case ACTION_NORTH:
					if (range.y <= 0 && (top <= minTop || aspectRatio && (left <= minLeft || right >= maxWidth))) {
						renderable = false;
						break;
					}
					check(ACTION_NORTH);
					height -= range.y;
					top += range.y;
					if (height < 0) {
						action = ACTION_SOUTH;
						height = -height;
						top -= height;
					}
					if (aspectRatio) {
						width = height * aspectRatio;
						left += (cropBoxData.width - width) / 2;
					}
					break;
				case ACTION_WEST:
					if (range.x <= 0 && (left <= minLeft || aspectRatio && (top <= minTop || bottom >= maxHeight))) {
						renderable = false;
						break;
					}
					check(ACTION_WEST);
					width -= range.x;
					left += range.x;
					if (width < 0) {
						action = ACTION_EAST;
						width = -width;
						left -= width;
					}
					if (aspectRatio) {
						height = width / aspectRatio;
						top += (cropBoxData.height - height) / 2;
					}
					break;
				case ACTION_SOUTH:
					if (range.y >= 0 && (bottom >= maxHeight || aspectRatio && (left <= minLeft || right >= maxWidth))) {
						renderable = false;
						break;
					}
					check(ACTION_SOUTH);
					height += range.y;
					if (height < 0) {
						action = ACTION_NORTH;
						height = -height;
						top -= height;
					}
					if (aspectRatio) {
						width = height * aspectRatio;
						left += (cropBoxData.width - width) / 2;
					}
					break;
				case ACTION_NORTH_EAST:
					if (aspectRatio) {
						if (range.y <= 0 && (top <= minTop || right >= maxWidth)) {
							renderable = false;
							break;
						}
						check(ACTION_NORTH);
						height -= range.y;
						top += range.y;
						width = height * aspectRatio;
					} else {
						check(ACTION_NORTH);
						check(ACTION_EAST);
						if (range.x >= 0) {
							if (right < maxWidth) {
								width += range.x;
							} else if (range.y <= 0 && top <= minTop) {
								renderable = false;
							}
						} else {
							width += range.x;
						}
						if (range.y <= 0) {
							if (top > minTop) {
								height -= range.y;
								top += range.y;
							}
						} else {
							height -= range.y;
							top += range.y;
						}
					}
					if (width < 0 && height < 0) {
						action = ACTION_SOUTH_WEST;
						height = -height;
						width = -width;
						top -= height;
						left -= width;
					} else if (width < 0) {
						action = ACTION_NORTH_WEST;
						width = -width;
						left -= width;
					} else if (height < 0) {
						action = ACTION_SOUTH_EAST;
						height = -height;
						top -= height;
					}
					break;
				case ACTION_NORTH_WEST:
					if (aspectRatio) {
						if (range.y <= 0 && (top <= minTop || left <= minLeft)) {
							renderable = false;
							break;
						}
						check(ACTION_NORTH);
						height -= range.y;
						top += range.y;
						width = height * aspectRatio;
						left += cropBoxData.width - width;
					} else {
						check(ACTION_NORTH);
						check(ACTION_WEST);
						if (range.x <= 0) {
							if (left > minLeft) {
								width -= range.x;
								left += range.x;
							} else if (range.y <= 0 && top <= minTop) {
								renderable = false;
							}
						} else {
							width -= range.x;
							left += range.x;
						}
						if (range.y <= 0) {
							if (top > minTop) {
								height -= range.y;
								top += range.y;
							}
						} else {
							height -= range.y;
							top += range.y;
						}
					}
					if (width < 0 && height < 0) {
						action = ACTION_SOUTH_EAST;
						height = -height;
						width = -width;
						top -= height;
						left -= width;
					} else if (width < 0) {
						action = ACTION_NORTH_EAST;
						width = -width;
						left -= width;
					} else if (height < 0) {
						action = ACTION_SOUTH_WEST;
						height = -height;
						top -= height;
					}
					break;
				case ACTION_SOUTH_WEST:
					if (aspectRatio) {
						if (range.x <= 0 && (left <= minLeft || bottom >= maxHeight)) {
							renderable = false;
							break;
						}
						check(ACTION_WEST);
						width -= range.x;
						left += range.x;
						height = width / aspectRatio;
					} else {
						check(ACTION_SOUTH);
						check(ACTION_WEST);
						if (range.x <= 0) {
							if (left > minLeft) {
								width -= range.x;
								left += range.x;
							} else if (range.y >= 0 && bottom >= maxHeight) {
								renderable = false;
							}
						} else {
							width -= range.x;
							left += range.x;
						}
						if (range.y >= 0) {
							if (bottom < maxHeight) {
								height += range.y;
							}
						} else {
							height += range.y;
						}
					}
					if (width < 0 && height < 0) {
						action = ACTION_NORTH_EAST;
						height = -height;
						width = -width;
						top -= height;
						left -= width;
					} else if (width < 0) {
						action = ACTION_SOUTH_EAST;
						width = -width;
						left -= width;
					} else if (height < 0) {
						action = ACTION_NORTH_WEST;
						height = -height;
						top -= height;
					}
					break;
				case ACTION_SOUTH_EAST:
					if (aspectRatio) {
						if (range.x >= 0 && (right >= maxWidth || bottom >= maxHeight)) {
							renderable = false;
							break;
						}
						check(ACTION_EAST);
						width += range.x;
						height = width / aspectRatio;
					} else {
						check(ACTION_SOUTH);
						check(ACTION_EAST);
						if (range.x >= 0) {
							if (right < maxWidth) {
								width += range.x;
							} else if (range.y >= 0 && bottom >= maxHeight) {
								renderable = false;
							}
						} else {
							width += range.x;
						}
						if (range.y >= 0) {
							if (bottom < maxHeight) {
								height += range.y;
							}
						} else {
							height += range.y;
						}
					}
					if (width < 0 && height < 0) {
						action = ACTION_NORTH_WEST;
						height = -height;
						width = -width;
						top -= height;
						left -= width;
					} else if (width < 0) {
						action = ACTION_SOUTH_WEST;
						width = -width;
						left -= width;
					} else if (height < 0) {
						action = ACTION_NORTH_EAST;
						height = -height;
						top -= height;
					}
					break;

				// Move canvas
				case ACTION_MOVE:
					this.move(range.x, range.y);
					renderable = false;
					break;

				// Zoom canvas
				case ACTION_ZOOM:
					this.zoom(getMaxZoomRatio(pointers), event);
					renderable = false;
					break;

				// Create crop box
				case ACTION_CROP:
					if (!range.x || !range.y) {
						renderable = false;
						break;
					}
					offset = getOffset(this.cropper);
					left = pointer.startX - offset.left;
					top = pointer.startY - offset.top;
					width = cropBoxData.minWidth;
					height = cropBoxData.minHeight;
					if (range.x > 0) {
						action = range.y > 0 ? ACTION_SOUTH_EAST : ACTION_NORTH_EAST;
					} else if (range.x < 0) {
						left -= width;
						action = range.y > 0 ? ACTION_SOUTH_WEST : ACTION_NORTH_WEST;
					}
					if (range.y < 0) {
						top -= height;
					}

					// Show the crop box if is hidden
					if (!this.cropped) {
						removeClass(this.cropBox, CLASS_HIDDEN);
						this.cropped = true;
						if (this.limited) {
							this.limitCropBox(true, true);
						}
					}
					break;
			}
			if (renderable) {
				cropBoxData.width = width;
				cropBoxData.height = height;
				cropBoxData.left = left;
				cropBoxData.top = top;
				this.action = action;
				this.renderCropBox();
			}

			// Override
			forEach(pointers, function (p) {
				p.startX = p.endX;
				p.startY = p.endY;
			});
		}
	};

	var methods = {
		// Show the crop box manually
		crop: function crop() {
			if (this.ready && !this.cropped && !this.disabled) {
				this.cropped = true;
				this.limitCropBox(true, true);
				if (this.options.modal) {
					addClass(this.dragBox, CLASS_MODAL);
				}
				removeClass(this.cropBox, CLASS_HIDDEN);
				this.setCropBoxData(this.initialCropBoxData);
			}
			return this;
		},
		// Reset the image and crop box to their initial states
		reset: function reset() {
			if (this.ready && !this.disabled) {
				this.imageData = assign({}, this.initialImageData);
				this.canvasData = assign({}, this.initialCanvasData);
				this.cropBoxData = assign({}, this.initialCropBoxData);
				this.renderCanvas();
				if (this.cropped) {
					this.renderCropBox();
				}
			}
			return this;
		},
		// Clear the crop box
		clear: function clear() {
			if (this.cropped && !this.disabled) {
				assign(this.cropBoxData, {
					left: 0,
					top: 0,
					width: 0,
					height: 0
				});
				this.cropped = false;
				this.renderCropBox();
				this.limitCanvas(true, true);

				// Render canvas after crop box rendered
				this.renderCanvas();
				removeClass(this.dragBox, CLASS_MODAL);
				addClass(this.cropBox, CLASS_HIDDEN);
			}
			return this;
		},
		/**
		 * Replace the image's src and rebuild the cropper
		 * @param {string} url - The new URL.
		 * @param {boolean} [hasSameSize] - Indicate if the new image has the same size as the old one.
		 * @returns {Cropper} this
		 */
		replace: function replace(url) {
			var hasSameSize = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : false;
			if (!this.disabled && url) {
				if (this.isImg) {
					this.element.src = url;
				}
				if (hasSameSize) {
					this.url = url;
					this.image.src = url;
					if (this.ready) {
						this.viewBoxImage.src = url;
						forEach(this.previews, function (element) {
							element.getElementsByTagName('img')[0].src = url;
						});
					}
				} else {
					if (this.isImg) {
						this.replaced = true;
					}
					this.options.data = null;
					this.uncreate();
					this.load(url);
				}
			}
			return this;
		},
		// Enable (unfreeze) the cropper
		enable: function enable() {
			if (this.ready && this.disabled) {
				this.disabled = false;
				removeClass(this.cropper, CLASS_DISABLED);
			}
			return this;
		},
		// Disable (freeze) the cropper
		disable: function disable() {
			if (this.ready && !this.disabled) {
				this.disabled = true;
				addClass(this.cropper, CLASS_DISABLED);
			}
			return this;
		},
		/**
		 * Destroy the cropper and remove the instance from the image
		 * @returns {Cropper} this
		 */
		destroy: function destroy() {
			var element = this.element;
			if (!element[NAMESPACE]) {
				return this;
			}
			element[NAMESPACE] = undefined;
			if (this.isImg && this.replaced) {
				element.src = this.originalUrl;
			}
			this.uncreate();
			return this;
		},
		/**
		 * Move the canvas with relative offsets
		 * @param {number} offsetX - The relative offset distance on the x-axis.
		 * @param {number} [offsetY=offsetX] - The relative offset distance on the y-axis.
		 * @returns {Cropper} this
		 */
		move: function move(offsetX) {
			var offsetY = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : offsetX;
			var _this$canvasData = this.canvasData,
				left = _this$canvasData.left,
				top = _this$canvasData.top;
			return this.moveTo(isUndefined(offsetX) ? offsetX : left + Number(offsetX), isUndefined(offsetY) ? offsetY : top + Number(offsetY));
		},
		/**
		 * Move the canvas to an absolute point
		 * @param {number} x - The x-axis coordinate.
		 * @param {number} [y=x] - The y-axis coordinate.
		 * @returns {Cropper} this
		 */
		moveTo: function moveTo(x) {
			var y = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : x;
			var canvasData = this.canvasData;
			var changed = false;
			x = Number(x);
			y = Number(y);
			if (this.ready && !this.disabled && this.options.movable) {
				if (isNumber(x)) {
					canvasData.left = x;
					changed = true;
				}
				if (isNumber(y)) {
					canvasData.top = y;
					changed = true;
				}
				if (changed) {
					this.renderCanvas(true);
				}
			}
			return this;
		},
		/**
		 * Zoom the canvas with a relative ratio
		 * @param {number} ratio - The target ratio.
		 * @param {Event} _originalEvent - The original event if any.
		 * @returns {Cropper} this
		 */
		zoom: function zoom(ratio, _originalEvent) {
			var canvasData = this.canvasData;
			ratio = Number(ratio);
			if (ratio < 0) {
				ratio = 1 / (1 - ratio);
			} else {
				ratio = 1 + ratio;
			}
			return this.zoomTo(canvasData.width * ratio / canvasData.naturalWidth, null, _originalEvent);
		},
		/**
		 * Zoom the canvas to an absolute ratio
		 * @param {number} ratio - The target ratio.
		 * @param {Object} pivot - The zoom pivot point coordinate.
		 * @param {Event} _originalEvent - The original event if any.
		 * @returns {Cropper} this
		 */
		zoomTo: function zoomTo(ratio, pivot, _originalEvent) {
			var options = this.options,
				canvasData = this.canvasData;
			var width = canvasData.width,
				height = canvasData.height,
				naturalWidth = canvasData.naturalWidth,
				naturalHeight = canvasData.naturalHeight;
			ratio = Number(ratio);
			if (ratio >= 0 && this.ready && !this.disabled && options.zoomable) {
				var newWidth = naturalWidth * ratio;
				var newHeight = naturalHeight * ratio;
				if (dispatchEvent(this.element, EVENT_ZOOM, {
					ratio: ratio,
					oldRatio: width / naturalWidth,
					originalEvent: _originalEvent
				}) === false) {
					return this;
				}
				if (_originalEvent) {
					var pointers = this.pointers;
					var offset = getOffset(this.cropper);
					var center = pointers && Object.keys(pointers).length ? getPointersCenter(pointers) : {
						pageX: _originalEvent.pageX,
						pageY: _originalEvent.pageY
					};

					// Zoom from the triggering point of the event
					canvasData.left -= (newWidth - width) * ((center.pageX - offset.left - canvasData.left) / width);
					canvasData.top -= (newHeight - height) * ((center.pageY - offset.top - canvasData.top) / height);
				} else if (isPlainObject(pivot) && isNumber(pivot.x) && isNumber(pivot.y)) {
					canvasData.left -= (newWidth - width) * ((pivot.x - canvasData.left) / width);
					canvasData.top -= (newHeight - height) * ((pivot.y - canvasData.top) / height);
				} else {
					// Zoom from the center of the canvas
					canvasData.left -= (newWidth - width) / 2;
					canvasData.top -= (newHeight - height) / 2;
				}
				canvasData.width = newWidth;
				canvasData.height = newHeight;
				this.renderCanvas(true);
			}
			return this;
		},
		/**
		 * Rotate the canvas with a relative degree
		 * @param {number} degree - The rotate degree.
		 * @returns {Cropper} this
		 */
		rotate: function rotate(degree) {
			return this.rotateTo((this.imageData.rotate || 0) + Number(degree));
		},
		/**
		 * Rotate the canvas to an absolute degree
		 * @param {number} degree - The rotate degree.
		 * @returns {Cropper} this
		 */
		rotateTo: function rotateTo(degree) {
			degree = Number(degree);
			if (isNumber(degree) && this.ready && !this.disabled && this.options.rotatable) {
				this.imageData.rotate = degree % 360;
				this.renderCanvas(true, true);
			}
			return this;
		},
		/**
		 * Scale the image on the x-axis.
		 * @param {number} scaleX - The scale ratio on the x-axis.
		 * @returns {Cropper} this
		 */
		scaleX: function scaleX(_scaleX) {
			var scaleY = this.imageData.scaleY;
			return this.scale(_scaleX, isNumber(scaleY) ? scaleY : 1);
		},
		/**
		 * Scale the image on the y-axis.
		 * @param {number} scaleY - The scale ratio on the y-axis.
		 * @returns {Cropper} this
		 */
		scaleY: function scaleY(_scaleY) {
			var scaleX = this.imageData.scaleX;
			return this.scale(isNumber(scaleX) ? scaleX : 1, _scaleY);
		},
		/**
		 * Scale the image
		 * @param {number} scaleX - The scale ratio on the x-axis.
		 * @param {number} [scaleY=scaleX] - The scale ratio on the y-axis.
		 * @returns {Cropper} this
		 */
		scale: function scale(scaleX) {
			var scaleY = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : scaleX;
			var imageData = this.imageData;
			var transformed = false;
			scaleX = Number(scaleX);
			scaleY = Number(scaleY);
			if (this.ready && !this.disabled && this.options.scalable) {
				if (isNumber(scaleX)) {
					imageData.scaleX = scaleX;
					transformed = true;
				}
				if (isNumber(scaleY)) {
					imageData.scaleY = scaleY;
					transformed = true;
				}
				if (transformed) {
					this.renderCanvas(true, true);
				}
			}
			return this;
		},
		/**
		 * Get the cropped area position and size data (base on the original image)
		 * @param {boolean} [rounded=false] - Indicate if round the data values or not.
		 * @returns {Object} The result cropped data.
		 */
		getData: function getData() {
			var rounded = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : false;
			var options = this.options,
				imageData = this.imageData,
				canvasData = this.canvasData,
				cropBoxData = this.cropBoxData;
			var data;
			if (this.ready && this.cropped) {
				data = {
					x: cropBoxData.left - canvasData.left,
					y: cropBoxData.top - canvasData.top,
					width: cropBoxData.width,
					height: cropBoxData.height
				};
				var ratio = imageData.width / imageData.naturalWidth;
				forEach(data, function (n, i) {
					data[i] = n / ratio;
				});
				if (rounded) {
					// In case rounding off leads to extra 1px in right or bottom border
					// we should round the top-left corner and the dimension (#343).
					var bottom = Math.round(data.y + data.height);
					var right = Math.round(data.x + data.width);
					data.x = Math.round(data.x);
					data.y = Math.round(data.y);
					data.width = right - data.x;
					data.height = bottom - data.y;
				}
			} else {
				data = {
					x: 0,
					y: 0,
					width: 0,
					height: 0
				};
			}
			if (options.rotatable) {
				data.rotate = imageData.rotate || 0;
			}
			if (options.scalable) {
				data.scaleX = imageData.scaleX || 1;
				data.scaleY = imageData.scaleY || 1;
			}
			return data;
		},
		/**
		 * Set the cropped area position and size with new data
		 * @param {Object} data - The new data.
		 * @returns {Cropper} this
		 */
		setData: function setData(data) {
			var options = this.options,
				imageData = this.imageData,
				canvasData = this.canvasData;
			var cropBoxData = {};
			if (this.ready && !this.disabled && isPlainObject(data)) {
				var transformed = false;
				if (options.rotatable) {
					if (isNumber(data.rotate) && data.rotate !== imageData.rotate) {
						imageData.rotate = data.rotate;
						transformed = true;
					}
				}
				if (options.scalable) {
					if (isNumber(data.scaleX) && data.scaleX !== imageData.scaleX) {
						imageData.scaleX = data.scaleX;
						transformed = true;
					}
					if (isNumber(data.scaleY) && data.scaleY !== imageData.scaleY) {
						imageData.scaleY = data.scaleY;
						transformed = true;
					}
				}
				if (transformed) {
					this.renderCanvas(true, true);
				}
				var ratio = imageData.width / imageData.naturalWidth;
				if (isNumber(data.x)) {
					cropBoxData.left = data.x * ratio + canvasData.left;
				}
				if (isNumber(data.y)) {
					cropBoxData.top = data.y * ratio + canvasData.top;
				}
				if (isNumber(data.width)) {
					cropBoxData.width = data.width * ratio;
				}
				if (isNumber(data.height)) {
					cropBoxData.height = data.height * ratio;
				}
				this.setCropBoxData(cropBoxData);
			}
			return this;
		},
		/**
		 * Get the container size data.
		 * @returns {Object} The result container data.
		 */
		getContainerData: function getContainerData() {
			return this.ready ? assign({}, this.containerData) : {};
		},
		/**
		 * Get the image position and size data.
		 * @returns {Object} The result image data.
		 */
		getImageData: function getImageData() {
			return this.sized ? assign({}, this.imageData) : {};
		},
		/**
		 * Get the canvas position and size data.
		 * @returns {Object} The result canvas data.
		 */
		getCanvasData: function getCanvasData() {
			var canvasData = this.canvasData;
			var data = {};
			if (this.ready) {
				forEach(['left', 'top', 'width', 'height', 'naturalWidth', 'naturalHeight'], function (n) {
					data[n] = canvasData[n];
				});
			}
			return data;
		},
		/**
		 * Set the canvas position and size with new data.
		 * @param {Object} data - The new canvas data.
		 * @returns {Cropper} this
		 */
		setCanvasData: function setCanvasData(data) {
			var canvasData = this.canvasData;
			var aspectRatio = canvasData.aspectRatio;
			if (this.ready && !this.disabled && isPlainObject(data)) {
				if (isNumber(data.left)) {
					canvasData.left = data.left;
				}
				if (isNumber(data.top)) {
					canvasData.top = data.top;
				}
				if (isNumber(data.width)) {
					canvasData.width = data.width;
					canvasData.height = data.width / aspectRatio;
				} else if (isNumber(data.height)) {
					canvasData.height = data.height;
					canvasData.width = data.height * aspectRatio;
				}
				this.renderCanvas(true);
			}
			return this;
		},
		/**
		 * Get the crop box position and size data.
		 * @returns {Object} The result crop box data.
		 */
		getCropBoxData: function getCropBoxData() {
			var cropBoxData = this.cropBoxData;
			var data;
			if (this.ready && this.cropped) {
				data = {
					left: cropBoxData.left,
					top: cropBoxData.top,
					width: cropBoxData.width,
					height: cropBoxData.height
				};
			}
			return data || {};
		},
		/**
		 * Set the crop box position and size with new data.
		 * @param {Object} data - The new crop box data.
		 * @returns {Cropper} this
		 */
		setCropBoxData: function setCropBoxData(data) {
			var cropBoxData = this.cropBoxData;
			var aspectRatio = this.options.aspectRatio;
			var widthChanged;
			var heightChanged;
			if (this.ready && this.cropped && !this.disabled && isPlainObject(data)) {
				if (isNumber(data.left)) {
					cropBoxData.left = data.left;
				}
				if (isNumber(data.top)) {
					cropBoxData.top = data.top;
				}
				if (isNumber(data.width) && data.width !== cropBoxData.width) {
					widthChanged = true;
					cropBoxData.width = data.width;
				}
				if (isNumber(data.height) && data.height !== cropBoxData.height) {
					heightChanged = true;
					cropBoxData.height = data.height;
				}
				if (aspectRatio) {
					if (widthChanged) {
						cropBoxData.height = cropBoxData.width / aspectRatio;
					} else if (heightChanged) {
						cropBoxData.width = cropBoxData.height * aspectRatio;
					}
				}
				this.renderCropBox();
			}
			return this;
		},
		/**
		 * Get a canvas drawn the cropped image.
		 * @param {Object} [options={}] - The config options.
		 * @returns {HTMLCanvasElement} - The result canvas.
		 */
		getCroppedCanvas: function getCroppedCanvas() {
			var options = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};
			if (!this.ready || !window.HTMLCanvasElement) {
				return null;
			}
			var canvasData = this.canvasData;
			var source = getSourceCanvas(this.image, this.imageData, canvasData, options);

			// Returns the source canvas if it is not cropped.
			if (!this.cropped) {
				return source;
			}
			var _this$getData = this.getData(),
				initialX = _this$getData.x,
				initialY = _this$getData.y,
				initialWidth = _this$getData.width,
				initialHeight = _this$getData.height;
			var ratio = source.width / Math.floor(canvasData.naturalWidth);
			if (ratio !== 1) {
				initialX *= ratio;
				initialY *= ratio;
				initialWidth *= ratio;
				initialHeight *= ratio;
			}
			var aspectRatio = initialWidth / initialHeight;
			var maxSizes = getAdjustedSizes({
				aspectRatio: aspectRatio,
				width: options.maxWidth || Infinity,
				height: options.maxHeight || Infinity
			});
			var minSizes = getAdjustedSizes({
				aspectRatio: aspectRatio,
				width: options.minWidth || 0,
				height: options.minHeight || 0
			}, 'cover');
			var _getAdjustedSizes = getAdjustedSizes({
					aspectRatio: aspectRatio,
					width: options.width || (ratio !== 1 ? source.width : initialWidth),
					height: options.height || (ratio !== 1 ? source.height : initialHeight)
				}),
				width = _getAdjustedSizes.width,
				height = _getAdjustedSizes.height;
			width = Math.min(maxSizes.width, Math.max(minSizes.width, width));
			height = Math.min(maxSizes.height, Math.max(minSizes.height, height));
			var canvas = document.createElement('canvas');
			var context = canvas.getContext('2d');
			canvas.width = normalizeDecimalNumber(width);
			canvas.height = normalizeDecimalNumber(height);
			context.fillStyle = options.fillColor || 'transparent';
			context.fillRect(0, 0, width, height);
			var _options$imageSmoothi = options.imageSmoothingEnabled,
				imageSmoothingEnabled = _options$imageSmoothi === void 0 ? true : _options$imageSmoothi,
				imageSmoothingQuality = options.imageSmoothingQuality;
			context.imageSmoothingEnabled = imageSmoothingEnabled;
			if (imageSmoothingQuality) {
				context.imageSmoothingQuality = imageSmoothingQuality;
			}

			// https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D.drawImage
			var sourceWidth = source.width;
			var sourceHeight = source.height;

			// Source canvas parameters
			var srcX = initialX;
			var srcY = initialY;
			var srcWidth;
			var srcHeight;

			// Destination canvas parameters
			var dstX;
			var dstY;
			var dstWidth;
			var dstHeight;
			if (srcX <= -initialWidth || srcX > sourceWidth) {
				srcX = 0;
				srcWidth = 0;
				dstX = 0;
				dstWidth = 0;
			} else if (srcX <= 0) {
				dstX = -srcX;
				srcX = 0;
				srcWidth = Math.min(sourceWidth, initialWidth + srcX);
				dstWidth = srcWidth;
			} else if (srcX <= sourceWidth) {
				dstX = 0;
				srcWidth = Math.min(initialWidth, sourceWidth - srcX);
				dstWidth = srcWidth;
			}
			if (srcWidth <= 0 || srcY <= -initialHeight || srcY > sourceHeight) {
				srcY = 0;
				srcHeight = 0;
				dstY = 0;
				dstHeight = 0;
			} else if (srcY <= 0) {
				dstY = -srcY;
				srcY = 0;
				srcHeight = Math.min(sourceHeight, initialHeight + srcY);
				dstHeight = srcHeight;
			} else if (srcY <= sourceHeight) {
				dstY = 0;
				srcHeight = Math.min(initialHeight, sourceHeight - srcY);
				dstHeight = srcHeight;
			}
			var params = [srcX, srcY, srcWidth, srcHeight];

			// Avoid "IndexSizeError"
			if (dstWidth > 0 && dstHeight > 0) {
				var scale = width / initialWidth;
				params.push(dstX * scale, dstY * scale, dstWidth * scale, dstHeight * scale);
			}

			// All the numerical parameters should be integer for `drawImage`
			// https://github.com/fengyuanchen/cropper/issues/476
			context.drawImage.apply(context, [source].concat(_toConsumableArray(params.map(function (param) {
				return Math.floor(normalizeDecimalNumber(param));
			}))));
			return canvas;
		},
		/**
		 * Change the aspect ratio of the crop box.
		 * @param {number} aspectRatio - The new aspect ratio.
		 * @returns {Cropper} this
		 */
		setAspectRatio: function setAspectRatio(aspectRatio) {
			var options = this.options;
			if (!this.disabled && !isUndefined(aspectRatio)) {
				// 0 -> NaN
				options.aspectRatio = Math.max(0, aspectRatio) || NaN;
				if (this.ready) {
					this.initCropBox();
					if (this.cropped) {
						this.renderCropBox();
					}
				}
			}
			return this;
		},
		/**
		 * Change the drag mode.
		 * @param {string} mode - The new drag mode.
		 * @returns {Cropper} this
		 */
		setDragMode: function setDragMode(mode) {
			var options = this.options,
				dragBox = this.dragBox,
				face = this.face;
			if (this.ready && !this.disabled) {
				var croppable = mode === DRAG_MODE_CROP;
				var movable = options.movable && mode === DRAG_MODE_MOVE;
				mode = croppable || movable ? mode : DRAG_MODE_NONE;
				options.dragMode = mode;
				setData(dragBox, DATA_ACTION, mode);
				toggleClass(dragBox, CLASS_CROP, croppable);
				toggleClass(dragBox, CLASS_MOVE, movable);
				if (!options.cropBoxMovable) {
					// Sync drag mode to crop box when it is not movable
					setData(face, DATA_ACTION, mode);
					toggleClass(face, CLASS_CROP, croppable);
					toggleClass(face, CLASS_MOVE, movable);
				}
			}
			return this;
		}
	};

	var AnotherCropper = WINDOW.Cropper;
	var Cropper = /*#__PURE__*/function () {
		/**
		 * Create a new Cropper.
		 * @param {Element} element - The target element for cropping.
		 * @param {Object} [options={}] - The configuration options.
		 */
		function Cropper(element) {
			var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};
			_classCallCheck(this, Cropper);
			if (!element || !REGEXP_TAG_NAME.test(element.tagName)) {
				throw new Error('The first argument is required and must be an <img> or <canvas> element.');
			}
			this.element = element;
			this.options = assign({}, DEFAULTS, isPlainObject(options) && options);
			this.cropped = false;
			this.disabled = false;
			this.pointers = {};
			this.ready = false;
			this.reloading = false;
			this.replaced = false;
			this.sized = false;
			this.sizing = false;
			this.init();
		}
		_createClass(Cropper, [{
			key: "init",
			value: function init() {
				var element = this.element;
				var tagName = element.tagName.toLowerCase();
				var url;
				if (element[NAMESPACE]) {
					return;
				}
				element[NAMESPACE] = this;
				if (tagName === 'img') {
					this.isImg = true;

					// e.g.: "img/picture.jpg"
					url = element.getAttribute('src') || '';
					this.originalUrl = url;

					// Stop when it's a blank image
					if (!url) {
						return;
					}

					// e.g.: "https://example.com/img/picture.jpg"
					url = element.src;
				} else if (tagName === 'canvas' && window.HTMLCanvasElement) {
					url = element.toDataURL();
				}
				this.load(url);
			}
		}, {
			key: "load",
			value: function load(url) {
				var _this = this;
				if (!url) {
					return;
				}
				this.url = url;
				this.imageData = {};
				var element = this.element,
					options = this.options;
				if (!options.rotatable && !options.scalable) {
					options.checkOrientation = false;
				}

				// Only IE10+ supports Typed Arrays
				if (!options.checkOrientation || !window.ArrayBuffer) {
					this.clone();
					return;
				}

				// Detect the mime type of the image directly if it is a Data URL
				if (REGEXP_DATA_URL.test(url)) {
					// Read ArrayBuffer from Data URL of JPEG images directly for better performance
					if (REGEXP_DATA_URL_JPEG.test(url)) {
						this.read(dataURLToArrayBuffer(url));
					} else {
						// Only a JPEG image may contains Exif Orientation information,
						// the rest types of Data URLs are not necessary to check orientation at all.
						this.clone();
					}
					return;
				}

				// 1. Detect the mime type of the image by a XMLHttpRequest.
				// 2. Load the image as ArrayBuffer for reading orientation if its a JPEG image.
				var xhr = new XMLHttpRequest();
				var clone = this.clone.bind(this);
				this.reloading = true;
				this.xhr = xhr;

				// 1. Cross origin requests are only supported for protocol schemes:
				// http, https, data, chrome, chrome-extension.
				// 2. Access to XMLHttpRequest from a Data URL will be blocked by CORS policy
				// in some browsers as IE11 and Safari.
				xhr.onabort = clone;
				xhr.onerror = clone;
				xhr.ontimeout = clone;
				xhr.onprogress = function () {
					// Abort the request directly if it not a JPEG image for better performance
					if (xhr.getResponseHeader('content-type') !== MIME_TYPE_JPEG) {
						xhr.abort();
					}
				};
				xhr.onload = function () {
					_this.read(xhr.response);
				};
				xhr.onloadend = function () {
					_this.reloading = false;
					_this.xhr = null;
				};

				// Bust cache when there is a "crossOrigin" property to avoid browser cache error
				if (options.checkCrossOrigin && isCrossOriginURL(url) && element.crossOrigin) {
					url = addTimestamp(url);
				}

				// The third parameter is required for avoiding side-effect (#682)
				xhr.open('GET', url, true);
				xhr.responseType = 'arraybuffer';
				xhr.withCredentials = element.crossOrigin === 'use-credentials';
				xhr.send();
			}
		}, {
			key: "read",
			value: function read(arrayBuffer) {
				var options = this.options,
					imageData = this.imageData;

				// Reset the orientation value to its default value 1
				// as some iOS browsers will render image with its orientation
				var orientation = resetAndGetOrientation(arrayBuffer);
				var rotate = 0;
				var scaleX = 1;
				var scaleY = 1;
				if (orientation > 1) {
					// Generate a new URL which has the default orientation value
					this.url = arrayBufferToDataURL(arrayBuffer, MIME_TYPE_JPEG);
					var _parseOrientation = parseOrientation(orientation);
					rotate = _parseOrientation.rotate;
					scaleX = _parseOrientation.scaleX;
					scaleY = _parseOrientation.scaleY;
				}
				if (options.rotatable) {
					imageData.rotate = rotate;
				}
				if (options.scalable) {
					imageData.scaleX = scaleX;
					imageData.scaleY = scaleY;
				}
				this.clone();
			}
		}, {
			key: "clone",
			value: function clone() {
				var element = this.element,
					url = this.url;
				var crossOrigin = element.crossOrigin;
				var crossOriginUrl = url;
				if (this.options.checkCrossOrigin && isCrossOriginURL(url)) {
					if (!crossOrigin) {
						crossOrigin = 'anonymous';
					}

					// Bust cache when there is not a "crossOrigin" property (#519)
					crossOriginUrl = addTimestamp(url);
				}
				this.crossOrigin = crossOrigin;
				this.crossOriginUrl = crossOriginUrl;
				var image = document.createElement('img');
				if (crossOrigin) {
					image.crossOrigin = crossOrigin;
				}
				image.src = crossOriginUrl || url;
				image.alt = element.alt || 'The image to crop';
				this.image = image;
				image.onload = this.start.bind(this);
				image.onerror = this.stop.bind(this);
				addClass(image, CLASS_HIDE);
				element.parentNode.insertBefore(image, element.nextSibling);
			}
		}, {
			key: "start",
			value: function start() {
				var _this2 = this;
				var image = this.image;
				image.onload = null;
				image.onerror = null;
				this.sizing = true;

				// Match all browsers that use WebKit as the layout engine in iOS devices,
				// such as Safari for iOS, Chrome for iOS, and in-app browsers.
				var isIOSWebKit = WINDOW.navigator && /(?:iPad|iPhone|iPod).*?AppleWebKit/i.test(WINDOW.navigator.userAgent);
				var done = function done(naturalWidth, naturalHeight) {
					assign(_this2.imageData, {
						naturalWidth: naturalWidth,
						naturalHeight: naturalHeight,
						aspectRatio: naturalWidth / naturalHeight
					});
					_this2.initialImageData = assign({}, _this2.imageData);
					_this2.sizing = false;
					_this2.sized = true;
					_this2.build();
				};

				// Most modern browsers (excepts iOS WebKit)
				if (image.naturalWidth && !isIOSWebKit) {
					done(image.naturalWidth, image.naturalHeight);
					return;
				}
				var sizingImage = document.createElement('img');
				var body = document.body || document.documentElement;
				this.sizingImage = sizingImage;
				sizingImage.onload = function () {
					done(sizingImage.width, sizingImage.height);
					if (!isIOSWebKit) {
						body.removeChild(sizingImage);
					}
				};
				sizingImage.src = image.src;

				// iOS WebKit will convert the image automatically
				// with its orientation once append it into DOM (#279)
				if (!isIOSWebKit) {
					sizingImage.style.cssText = 'left:0;' + 'max-height:none!important;' + 'max-width:none!important;' + 'min-height:0!important;' + 'min-width:0!important;' + 'opacity:0;' + 'position:absolute;' + 'top:0;' + 'z-index:-1;';
					body.appendChild(sizingImage);
				}
			}
		}, {
			key: "stop",
			value: function stop() {
				var image = this.image;
				image.onload = null;
				image.onerror = null;
				image.parentNode.removeChild(image);
				this.image = null;
			}
		}, {
			key: "build",
			value: function build() {
				if (!this.sized || this.ready) {
					return;
				}
				var element = this.element,
					options = this.options,
					image = this.image;

				// Create cropper elements
				var container = element.parentNode;
				var template = document.createElement('div');
				template.innerHTML = TEMPLATE;
				var cropper = template.querySelector(".".concat(NAMESPACE, "-container"));
				var canvas = cropper.querySelector(".".concat(NAMESPACE, "-canvas"));
				var dragBox = cropper.querySelector(".".concat(NAMESPACE, "-drag-box"));
				var cropBox = cropper.querySelector(".".concat(NAMESPACE, "-crop-box"));
				var face = cropBox.querySelector(".".concat(NAMESPACE, "-face"));
				this.container = container;
				this.cropper = cropper;
				this.canvas = canvas;
				this.dragBox = dragBox;
				this.cropBox = cropBox;
				this.viewBox = cropper.querySelector(".".concat(NAMESPACE, "-view-box"));
				this.face = face;
				canvas.appendChild(image);

				// Hide the original image
				addClass(element, CLASS_HIDDEN);

				// Inserts the cropper after to the current image
				container.insertBefore(cropper, element.nextSibling);

				// Show the hidden image
				removeClass(image, CLASS_HIDE);
				this.initPreview();
				this.bind();
				options.initialAspectRatio = Math.max(0, options.initialAspectRatio) || NaN;
				options.aspectRatio = Math.max(0, options.aspectRatio) || NaN;
				options.viewMode = Math.max(0, Math.min(3, Math.round(options.viewMode))) || 0;
				addClass(cropBox, CLASS_HIDDEN);
				if (!options.guides) {
					addClass(cropBox.getElementsByClassName("".concat(NAMESPACE, "-dashed")), CLASS_HIDDEN);
				}
				if (!options.center) {
					addClass(cropBox.getElementsByClassName("".concat(NAMESPACE, "-center")), CLASS_HIDDEN);
				}
				if (options.background) {
					addClass(cropper, "".concat(NAMESPACE, "-bg"));
				}
				if (!options.highlight) {
					addClass(face, CLASS_INVISIBLE);
				}
				if (options.cropBoxMovable) {
					addClass(face, CLASS_MOVE);
					setData(face, DATA_ACTION, ACTION_ALL);
				}
				if (!options.cropBoxResizable) {
					addClass(cropBox.getElementsByClassName("".concat(NAMESPACE, "-line")), CLASS_HIDDEN);
					addClass(cropBox.getElementsByClassName("".concat(NAMESPACE, "-point")), CLASS_HIDDEN);
				}
				this.render();
				this.ready = true;
				this.setDragMode(options.dragMode);
				if (options.autoCrop) {
					this.crop();
				}
				this.setData(options.data);
				if (isFunction(options.ready)) {
					addListener(element, EVENT_READY, options.ready, {
						once: true
					});
				}
				dispatchEvent(element, EVENT_READY);
			}
		}, {
			key: "unbuild",
			value: function unbuild() {
				if (!this.ready) {
					return;
				}
				this.ready = false;
				this.unbind();
				this.resetPreview();
				var parentNode = this.cropper.parentNode;
				if (parentNode) {
					parentNode.removeChild(this.cropper);
				}
				removeClass(this.element, CLASS_HIDDEN);
			}
		}, {
			key: "uncreate",
			value: function uncreate() {
				if (this.ready) {
					this.unbuild();
					this.ready = false;
					this.cropped = false;
				} else if (this.sizing) {
					this.sizingImage.onload = null;
					this.sizing = false;
					this.sized = false;
				} else if (this.reloading) {
					this.xhr.onabort = null;
					this.xhr.abort();
				} else if (this.image) {
					this.stop();
				}
			}

			/**
			 * Get the no conflict cropper class.
			 * @returns {Cropper} The cropper class.
			 */
		}], [{
			key: "noConflict",
			value: function noConflict() {
				window.Cropper = AnotherCropper;
				return Cropper;
			}

			/**
			 * Change the default options.
			 * @param {Object} options - The new default options.
			 */
		}, {
			key: "setDefaults",
			value: function setDefaults(options) {
				assign(DEFAULTS, isPlainObject(options) && options);
			}
		}]);
		return Cropper;
	}();
	assign(Cropper.prototype, render, preview, events, handlers, change, methods);

	return Cropper;
});

define('text!chat/setting/setting_panel_action_button.mustache',[],function () { return '<button class="chat-setting__clickable chat-setting__action-btn" id="chat-setting-{{idName}}">{{label}}</button>';});


define('text!chat/setting/setting_panel_block.mustache',[],function () { return '<div class="chat-setting chat-setting--block chat-setting--{{name}}">\n\t<span class="chat-setting__title">\n\t\t<svg class="chat-setting__icon chat-scc"><use xlink:href="#{{icon}}"></use></svg>\n\t\t<span>{{label}}</span>\n\t</span>\n\t<div class="chat-setting__body chat-setting__body--action-btn-wrapper">\n\t</div>\n</div>';});


define('text!chat/setting/setting_view_content.mustache',[],function () { return '<div class="chat-setting-content chat-setting-content--{{idName}}">\n\t{{#info}}\n\t\t<div class="chat-setting-content__info">\n\t\t\t<p>{{info}}</p>\n\t\t</div>\n\t{{/info}}\n\t{{#content}}\n\t\t{{{content}}}\n\t{{/content}}\n</div>';});


define('text!chat/setting/setting_view_header.mustache',[],function () { return '<div class="chat-setting-header chat-setting-header--{{idName}}">\n\t<div class="chat-setting-header__body">\n\t\t<button class="chat-setting-header__back btn btn--flat" type="button" id="chat-setting-header-button">\n\t\t\t<span>{{backButtonLabel}}</span>\n\t\t</button>\n\t\t<div class="chat-setting-header__title">\n\t\t\t<b>{{title}}</b>\n\t\t</div>\n\t</div>\n</div>';});


define('text!chat/setting/setting_view_header_menu.mustache',[],function () { return '<div class="chat-setting-header__menu">\n\t<button type="button" class="btn btn--flat chat-setting-header__menu-item" id="{{btnId}}">\n\t\t<svg class="chat-scc"><use xlink:href="#scc-three-dots"></use></svg>\n\t</button>\n\t<div class="chat-friend-menu chat-setting-menu" id="{{menuId}}">\n\t\t{{#menuItems}}\n\t\t\t<div {{#id}}id="{{id}}" {{/id}} class="chat-message-header-menu-icon chat-friend-menu__item">\n\t\t\t\t{{{icon}}}\n\t\t\t\t<div class="chat-friend-menu__text">{{label}}</div>\n\t\t\t</div>\n\t\t{{/menuItems}}\n\t</div>\n</div>\n\n';});

define('chat/setting/setting',[
    'log_and_tooltip',
	'mustache',
	'config/chat',
	'lib/i18n!front',
	'lib/storage',
	'text!chat/setting/setting_panel_action_button.mustache',
	'text!chat/setting/setting_panel_block.mustache',
	'text!chat/setting/setting_view_content.mustache',
	'text!chat/setting/setting_view_header.mustache',
	'text!chat/setting/setting_view_header_menu.mustache'
], function(
    LogAndTooltip,
    Mustache,
    config,
	i18n,
    storage,
    tpl_setting_panel_action_button,
    tpl_setting_panel_block,
    tpl_setting_view_content,
    tpl_setting_view_header,
    tpl_setting_view_header_menu
) {
	var VIEW_HIDDEN = 'hidden';
	var VIEW_VISIBLE = 'visible';

	var PANEL_TYPE_ACTION = 'action';
	var PANEL_TYPE_BLOCK = 'block';

	var settings_requested = false;
	var settings = {};
	var locationHashPrefix = "setting-";
	var panelClassNamePrefix = '.chat-setting--';

    /**
     * Base class for settings. See WelcomeMessage as example of implementation.
     * Emit event
     * @constructor
     */
    var Setting = function() {
		this.userType = null;
		this.settingType = "block";
		this.block = {
			name: '',
			label: '',
			icon: 'scc-setting-icon'
		};
		this.label = "";
		this.name = null;
		this.idName = null;
		this.value = null;
		this.socket = null;
	    this.viewState = VIEW_HIDDEN;
	    this.unselectFriendFct = null;
		this.menuItems = new Map();
    }

    Setting.prototype = {
	    addSettingPanelAction: function () {
		    var blockBody = document.querySelector(this.getSettingPanelClass() + ' .chat-setting__body');

		    if (!blockBody) {
			    wglog.debug('Setting::addSettingPanelAction', 'setting body not found');
			    return;
		    }
		    if (blockBody.querySelector('#chat-setting-' + this.idName)) {
			    wglog.debug('Setting::addSettingPanelAction', 'action already setup');
			    return;
		    }

			var actionButton = this.createElementFromTpl(tpl_setting_panel_action_button, this);
			actionButton.addEventListener('click', this.onActionButtonClick.bind(this));
			blockBody.appendChild(actionButton);
	    },
	    addSettingPanelBlock: function() {
			var isValid = this.block
				&& this.block.hasOwnProperty('name')
				&& this.block.hasOwnProperty('label')
				&& this.block.name
				&& this.block.label;

			if (!isValid) {
				wglog.debug('Setting::addSettingPanelBlock', 'invalid block');
				return;
		    }

			var block = document.querySelector(this.getSettingPanelClass());

			if (block) {
				return;
			}

		    block = this.createElementFromTpl(tpl_setting_panel_block, this.block);
		    document.querySelector('.chat-settings-list__header').after(block);
	    },
	    addViewHeader: function () {
			var header = this.createElementFromTpl(tpl_setting_view_header, {
				"backButtonLabel": i18n.__('chat.button_return_friends'),
				"idName": this.idName,
				"title": this.label
			});
			header.querySelector('.chat-setting-header__back').addEventListener('click', this.hide.bind(this));
		    header.style.display = 'none';
			document.querySelector('.chat-header-messages').append(header);
			if (this.menuItems.length) {
				this.addViewHeaderMenu(header);
			}
	    },
	    addViewHeaderMenu: function (header) {
			var btnId = 'chat-setting-header-menu-btn' + this.idName,
				menuId = this.getHeaderMenuId();

			var menu = this.createElementFromTpl(tpl_setting_view_header_menu, {
				btnId: btnId,
				menuId: menuId,
				menuItems: Array.from(this.menuItems, function (item) {
					return item[1]
				}),
			});

			this.menuItems.forEach(function (item) {
				menu.querySelector(item.selector).addEventListener('click', item.callback);
			});

		    menu.querySelector('#' + btnId).addEventListener('click', this.onHeaderMenuBtnClick.bind(this));
			header.append(menu);
	    },
	    addViewContent: function () {
			var content = this.createElementFromTpl(tpl_setting_view_content, {
				"idName": this.idName,
				"content": false,
				"info": i18n.__('chat.no_content')
			});
		    content.style.display = 'none';
		    document.querySelector('.chat-setting-area').append(content);
	    },
	    createElementFromTpl: function (tpl, params, getHtmlOnly) {
			var div = document.createElement('div');
			getHtmlOnly = getHtmlOnly === true;

		    try {
				div.innerHTML = Mustache.render(tpl, params).trim();
				return getHtmlOnly ? div.firstChild.outerHTML : div.firstChild;
			} catch (e) {
				wglog.debug('Setting::createElementFromTpl', e.stack);
			}
		},
	    delete: function () {
			this.socket.emit('delete_setting', {'setting_name': this.name});
	    },
	    get: function() {
		    return this.value;
	    },
	    getLocationHash: function () {
			return locationHashPrefix + this.idName;
	    },
	    getSettingPanelClass: function () {
			return panelClassNamePrefix + this.block.name;
	    },
	    getHeaderMenuId: function (withHash) {
			return (withHash ? '#' : '') + 'chat-setting-header-menu-' + this.idName;
	    },
	    headerMenuOnClickOutside: function (event) {
			var menuId = this.getHeaderMenuId();
		    if (event.target.id !== menuId && !event.target.closest('#' + menuId)) {
			    this.headerMenuHide();
		    }
	    },
	    headerMenuShow: function () {
		    document.addEventListener('click', this.headerMenuOnClickOutside.bind(this));
		    document.getElementById(this.getHeaderMenuId()).style.display = 'block';
		    this.headerMenuIsVisible = true;
	    },
	    headerMenuHide: function () {
		    document.removeEventListener('click', this.headerMenuOnClickOutside.bind(this));
		    document.getElementById(this.getHeaderMenuId()).style.display = 'none';
		    this.headerMenuIsVisible = false;
	    },
	    headerMenuToggle: function () {
		    if (this.headerMenuIsVisible) {
			    this.headerMenuHide();
		    } else {
			    this.headerMenuShow();
		    }
	    },
	    init: function (socket, unselectFriendFct) {
			if (!this.socket) {
				this.setSocket(socket);
			}

			// if (settings_requested) {
			// 	this.value = settings[this.name] ? settings[this.name] : null;
			// } else {
			// 	settings_requested = true;
			// 	this.socket.emit('get_settings', {});
			// }
			settings_requested = true;
		    this.value = config.login_info.settings && config.login_info.settings[this.name] ? config.login_info.settings[this.name] : null;

			if (!this.unselectFriendFct) {
				this.setUnselectFriendFct(unselectFriendFct);
			}

			$(window).on('hashchange', this.onHashChange.bind(this));

		    this.addSettingPanelBlock();
		    this.addSettingPanelAction();
			this.addViewHeader();
			this.addViewContent();
	    },
	    onActionButtonClick: function (event) {
			document.querySelector('.chat-settings-list__close').dispatchEvent(new MouseEvent('click', {
				bubbles: true,
				cancelable: true,
				view: window
			}));
			this.refreshView();
			this.show();
	    },
	    onHashChange: function (event) {
	        var newHash = window.location.hash,
	            oldHash = new URL(event.originalEvent.oldURL).hash,
	            settingHash = '#' + this.getLocationHash();

			if (newHash === settingHash && !this.viewIsVisible()) {
				this.viewShow();
			} else if (oldHash === settingHash) {
				this.viewHide();
			}
	    },
	    onHeaderMenuBtnClick: function (event) {
		    event.stopPropagation();

			var menu = document.getElementById(this.getHeaderMenuId());
		    if (menu && getComputedStyle(menu).display !== "none") {
			    LogAndTooltip.popup_close();
		    }

		    this.headerMenuToggle();
	    },
	    onSocketAddSetting: function (data) {
		    if (!data.hasOwnProperty('setting_name')) {
		        wglog.debug('Setting::onSocketAddSetting', 'Missing property setting_name');
				return;
		    }
			if (!data.hasOwnProperty('setting_value')) {
		        wglog.debug('Setting::onSocketAddSetting', 'Missing property setting_value');
				return;
		    }

			if (data.setting_name !== this.name) {
				// Not handled setting. Nothing to do then.
		        return;
			}

	        this.value = data.setting_value;
	    },
	    onSocketDeleteSetting: function (data) {
			if (!data || Object.keys(data).length > 0) {
		        wglog.debug('Setting::onSocketAddSetting', 'Invalid delete setting return');
				return;
		    }

	        this.value = data;
	    },
	    onSocketGetSettings: function (data) {
		    if (!data.hasOwnProperty('settings')) {
			    wglog.debug('Setting::onSocketGetSettings', 'Missing property settings');
			    return;
		    }

			if (!data.settings.hasOwnProperty(this.name)) {
				// Setting not in data. Nothing to do.
				return;
			}

			if (!settings) {
				settings = data.settings;
			}

		    wglog.debug('Setting::onSocketGetSettings', 'setting ' + this.name + ' received');
			this.value = data.settings[this.name];
		},
	    refreshView: function () {},
	    save: function () {
			if (!this.name || !this.value) {
				return;
			}

		    this.socket.emit('add_setting', {
			    'setting_name': this.name,
			    'setting_value': this.value
		    });
	    },
	    setMenuItem: function (key, value) {
			if (typeof key !== 'string') {
				wglog.error('Setting::setMenuItem', 'key must be a string');
				return;
			}
			if (!value) {
				wglog.error('Setting::setMenuItem', 'value is undefined');
				return;
			}
		    if (!value.hasOwnProperty('callback') || typeof value.callback !== "function") {
			    wglog.error('Setting::setMenuItem', 'value.callback is missing or not a function');
			    return;
		    }

			if (!value.hasOwnProperty('id')) {
				value.id = this.idName + '-menu-' + key;
			}

			value.selector = '#' + value.id;

			this.menuItems.set(key, value);
	    },
	    setSocket: function(socket) {
		    this.socket = socket;
		    this.socket.on('get_settings', this.onSocketGetSettings.bind(this));
		    this.socket.on('add_setting', this.onSocketAddSetting.bind(this));
		    this.socket.on('delete_setting', this.onSocketDeleteSetting.bind(this));
	    },
	    setUnselectFriendFct: function (fct) {
			if (typeof fct !== "function") {
				wglog.error('Setting::setUnselectFriendFct', 'argument must be of type function');
			}
			this.unselectFriendFct = fct;
	    },
	    viewIsVisible: function () {
			return this.viewState === VIEW_VISIBLE;
	    },
	    viewHide: function () {
			var chatWindow = document.getElementById('chat-window');
			if (window.location.hash.indexOf(locationHashPrefix) === -1) {
				chatWindow.classList.remove('chat-window--settings');
			}
			if (window.location.hash === "") {
				chatWindow.classList.add('chat-window--home');
			}
		    chatWindow.classList.remove('chat-window--settings-' + this.idName);
			document.querySelector('.chat-setting-header--' + this.idName).style.display = 'none';
			document.querySelector('.chat-setting-content--' + this.idName).style.display = 'none';
		    this.viewState = VIEW_HIDDEN;
	    },
	    viewShow: function () {
			this.unselectFriendFct();
		    var chatWindow = document.getElementById('chat-window');
		    chatWindow.classList.add('chat-window--settings');
		    chatWindow.classList.add('chat-window--settings-' + this.idName);
		    chatWindow.classList.remove('chat-window--home');
			document.querySelector('.chat-setting-header--' + this.idName).style.display = 'flex';
			document.querySelector('.chat-setting-content--' + this.idName).style.display = 'flex';
			this.viewState = VIEW_VISIBLE;
		    storage.set('id_last_conversation', 0);
	    },
	    hide: function () {
		    window.location.hash = "";
	    },
	    show: function () {
		    window.location.hash = this.getLocationHash();
	    }
    }

    return Setting;
});


define('text!chat/setting/profile/profile_form.mustache',[],function () { return '<div class="chat-setting-content chat-setting-content--{{idName}}">\n\t<form>\n\t\t<div class="chat-form-field-group">\n\t\t\t{{#isFan}}\n\t\t\t\t<label for="{{idName}}__name">{{labels.name}}</label>\n\t\t\t\t<input type="text" class="chat-form-field{{#descriptions.name}} chat-form-field--with-description{{/descriptions.name}}" id="{{idName}}__name" name="name" value="{{values.name}}">\n\t\t\t\t{{#descriptions.name}}<p class="chat-form-field__description">{{descriptions.name}}</p>{{/descriptions.name}}\n\t\t\t{{/isFan}}\n\t\t\t{{#isCreator}}\n\t\t\t\t<div class="label">{{labels.name}}</div>\n\t\t\t\t<p>{{{editNameOnPage}}}</p>\n\t\t\t{{/isCreator}}\n\t\t</div>\n\t\t{{#showHeadshotField}}\n\t\t<div class="chat-form-field-group">\n\t\t\t<label for="{{idName}}__headshot">{{labels.headshot}}</label>\n\t\t\t<figure class="chat-avatar chat-avatar--size-175px chat-avatar--editable mx-auto" id="{{idName}}-headshot-wrapper">\n\t\t\t\t<img id="{{idName}}-headshot-img" src="{{{values.headshot}}}" />\n\t\t\t</figure>\n\t\t\t<div id="chat-headshot-field">\n\t\t\t\t<input type="file" id="{{idName}}__headshot" name="headshot" class="d-none"/>\n\t\t\t\t<img accept="image/*" id="{{idName}}-headshot-croppable" src="{{{values.headshot}}}" class="d-none" />\n\t\t\t</div>\n\t\t</div>\n\t\t{{/showHeadshotField}}\n\t\t<div class="chat-form-actions">\n\t\t\t<button type="submit" class="btn chat-btn">{{labels.submit}}</button>\n\t\t</div>\n\t</form>\n</div>';});


define('text!chat/setting/profile/profile_info.mustache',[],function () { return '<p>{{{message}}}</p>\n<!--<input type="checkbox" id="profile-info-display-again"{{#checked}} checked="checked"{{/checked}}> <label for="profile-info-display-again">{{display_again}}</label>-->';});

define('chat/setting/profile/profile',[
	'log_and_tooltip',
	'mustache',
	'config/chat',
	'lib/i18n!front',
	'libs/cropper.common',
	'chat_window_message',
	'chat/setting/setting',
	'text!chat/setting/profile/profile_form.mustache',
	'text!chat/setting/profile/profile_info.mustache'
], function(
	LogAndTooltip,
	Mustache,
	config,
	i18n,
	Cropper,
	ChatWindowMessage,
	Setting,
	tpl_profile_form,
	tpl_profile_info
) {
	var instance = null;

	/**
	 *
	 * @constructor
	 */
	var Profile = function() {
		if (instance !== null) {
			wglog.error("Profile::constructor", "Can not instantiate more than one instance, use Profile.getInstance();");
		}

		Setting.call(this);
		this.block.name = "general-settings";
		this.block.label = i18n.__('chat.settings.general_settings');
		this.name = 'profile';
		this.idName = 'profile';
		this.label = i18n.__('chat.edit_profile');
		this.formValues = {};
	}

	Profile.prototype = Object.create(Setting.prototype);

	Object.assign(Profile.prototype, {
		addViewContent: function () {
			this.refreshValueFromConfig();
			var content = this.createElementFromTpl(tpl_profile_form, {
				"isCreator": config.login_info.is_creator,
				"isFan": config.login_info.is_fan,
				"showHeadshotField": config.login_info.is_creator && config.login_info.verified,
				"idName": this.idName,
				"labels": {
					"name": i18n.__('chat.name'),
					"headshot": i18n.__('chat.headshot'),
					"submit": i18n.__('chat.save')
				},
				"editNameOnPage": i18n.__('chat.profile.edit_name_on_page', {
					"%link%": '<a target="_blank" href="' + (config.login_info.creator_settings_url || "") + '">' + i18n.__('chat.profile.account_settings_page') + '</a>'
				}),
				"descriptions": {
					"name": i18n.__('chat.profile.name_rules')
				},
				"values": this.formValues
			});
			content.style.display = 'none';
			document.querySelector('.chat-setting-area').append(content);
			content.querySelector('form').addEventListener('submit', this.onFormSubmit.bind(this));
			if (config.login_info.is_creator && config.login_info.verified) {
				document.getElementById(this.idName + '-headshot-wrapper').addEventListener('click', this.onHeadshotWrapperClick.bind(this));
				document.getElementById(this.idName + '__headshot').addEventListener('change', this.onHeadshotChange.bind(this));
			}
		},

		closeModal: function() {
			this.saveModal(false);
			LogAndTooltip.overlay_close();
		},

		displayErrors: function (messages) {
			if (messages.length > 1) {
				ChatWindowMessage.clear();
				ChatWindowMessage.add('<ul class="mb-0"><li>' + messages.join('</li><li>') + '</li></ul>');
			} else if (messages.length === 1) {
				ChatWindowMessage.clear();
				ChatWindowMessage.add(messages);
			}
		},

		hideHeadshotField: function () {
			document.getElementById(this.idName + '-headshot-wrapper').style.display = 'block';
			document.getElementById('chat-headshot-field').style.display = 'none';
		},

		init: function (socket, unselectFriendFct, dontShowUsernameModal) {
			Setting.prototype.init.call(this, socket, unselectFriendFct);
			if (!(!!dontShowUsernameModal)) {
				this.usernameModalShow();
			}
		},

		isFileSelected: function (input) {
			if (input.files && input.files[0]) {
				return true;
			}
			return false;
		},

		onFormSubmit: function (event) {
			event.preventDefault();
			var formData = new FormData(event.target),
				errors = this.validateFormData(formData);

			if (errors.length) {
				this.displayErrors(errors);
				return;
			}

			this.formValues = Object.fromEntries(formData);
			this.saveData(formData);
		},

		onHeadshotChange: function (event) {
			var input = event.target;
			if (!this.isFileSelected(input)) {
				return;
			}

			this.showHeadshotField(true);

			var image = document.getElementById(this.idName + '-headshot-croppable'),
				fileReader = new FileReader(),
				self = this;

			fileReader.readAsDataURL(input.files[0]);
			fileReader.onload = function (event) {
				image.src = this.result;
				document.getElementById('chat-headshot-field').style.opacity = 1;

				// Start cropper
				new Cropper(image, {
					aspectRatio: 1,
					autoCropArea: 1,
					toggleDragModeOnDblclick: false,
					viewMode: 1,
					minCropBoxWidth: 149,
					minCropBoxHeight: 149,
					dragMode: 'move',
					zoomable: true,
					zoomOnTouch: false,
					zoomOnWheel: false,
					ready: function (event) {
						var cropper = event.target.cropper;
						cropper.zoomTo(0);

						var imageData = cropper.getImageData(),
						    minSliderZoom = (imageData.width / imageData.naturalWidth).toFixed(4),
						    slider = self.setupZoomSlider(this.parentNode, minSliderZoom, minSliderZoom);

						slider.addEventListener('input', function (event) {
							var currentValue = event.target.value;
							var zoomValue = parseFloat(currentValue).toFixed(4);
							cropper.zoomTo(zoomValue);
						});
					},
					zoom: function (event) {
						if (event.detail.oldRatio > 1 && event.detail.ratio > 1) {
							event.preventDefault();
						}
					}
				});
			};
		},

		onSocketHeadshotUpdated: function (data) {
			this.updateAvatarUrl(data.url);
			this.hideHeadshotField();
			this.resetHeadshotField();
		},

		onHeadshotWrapperClick: function (event) {
			document.getElementById(this.idName + '__headshot').dispatchEvent(new MouseEvent('click', {
				bubbles: true,
				cancelable: true,
				view: window
			}));
		},

		onSocketChatError: function (error) {
			if (error.code === 63003) {
				ChatWindowMessage.clear();
				ChatWindowMessage.add(i18n.__(error.message, error.params || {}));
			}
		},

		onSocketNameUpdated: function (data) {
			if (!data.updated) {
				return;
			}

			this.updateNameEverywhere();
			this.showConfirmation();
		},

		refreshValueFromConfig: function () {
			this.formValues = Object.assign({display_again: true, name: '', headshot: ''}, this.value);
			this.formValues.name = config.login_info.profile_name;
			this.formValues.headshot = config.login_info.profile_picture;
		},

		refreshView: function () {
			this.refreshValueFromConfig();
			var nameInput = document.getElementById(this.idName + '__name');
			if (nameInput) {
				nameInput.value = this.formValues.name;
			}
			var headshotInput = document.getElementById(this.idName + '__headshot');
			if (headshotInput) {
				headshotInput.src = this.formValues.headshot;
			}
		},

		resetHeadshotField: function () {
			var hiddenImage = document.getElementById(this.idName + '-headshot-croppable'),
				cropper = hiddenImage.cropper;

			if (!cropper) {
				return;
			}

			cropper.destroy();
		},

		saveData: function (formData) {
			if (formData.has('name')) {
				this.socket.emit('update_name', {name: formData.get('name')});
			}
			var hiddenImage = document.getElementById(this.idName + '-headshot-croppable');
			if (!hiddenImage || !hiddenImage.cropper) {
				return;
			}
			if (formData.has('headshot')) {
				var data_uri = hiddenImage.cropper.getCroppedCanvas().toDataURL();
				this.socket.emit('update_headshot', {data_uri: data_uri});
			}
		},

		saveModal: function (val) {
			this.value = this.value || {};
			this.value.display_again = val;
			this.save();
		},

		setSocket: function (socket) {
			Setting.prototype.setSocket.call(this, socket);
			this.socket.on('name_updated', this.onSocketNameUpdated.bind(this));
			this.socket.on('headshot_updated', this.onSocketHeadshotUpdated.bind(this));
			this.socket.on('chat_error', this.onSocketChatError.bind(this));
		},

		setupZoomSlider: function (parentElement, value, min, max) {
			var input = document.createElement('input');
			input.type = 'range';
			input.className = 'chat-setting__slider';
			input.value = value || undefined;
			input.step = 0.0001;
			input.min = min || 0;
			input.max = max || 1;

			parentElement.appendChild(input);

			return input;
		},

		showConfirmation: function () {
			var message = i18n.__('chat.profile_saved');
			ChatWindowMessage.clear();
			ChatWindowMessage.add(message, {dismissible: true, message_type: 'success'});
		},

		showHeadshotField: function (setOpacityToHeadshotFieldAtZero) {
			document.getElementById(this.idName + '-headshot-wrapper').style.display = 'none';
			var headshotField = document.getElementById('chat-headshot-field');
			if (setOpacityToHeadshotFieldAtZero) {
				headshotField.style.opacity = 0;
			}
			headshotField.style.display = 'block';
		},

		updateNameEverywhere: function () {
			var username = this.formValues.name;

			config.login_info.profile_name = username;
			config.login_info.profile_name_lower = username.toLowerCase();

			document.querySelectorAll('.chat-message--me .chat-message__username span').forEach(function (element) {
				element.innerHTML = username;
			});
			document.querySelectorAll('.chat-message--me .chat-avatar img').forEach(function (element) {
				element.alt = username;
			});
			document.querySelectorAll('.chat-message__meta--cite[data-user-id="' + config.login_info.id + '"]').forEach(function (element) {
				element.innerHTML = username + ',';
			});

			document.querySelector('.chat-sidebar__username').textContent = username;
		},

		updateAvatarUrl: function (url) {
			if (!url) {
				return;
			}

			var avatar = document.getElementById(this.idName + '-headshot-img');
			if (!avatar) {
				return;
			}
			avatar.src = url;

			var selectors = 'chat-setting-content--' + this.idName + ' .chat-avatar'
				+ ', .chat-settings > .chat-avatar'
				+ ', .chat-message--me .chat-avatar';
			document.querySelectorAll(selectors).forEach(function (avatar) {
				var img = avatar.querySelector('img');
				if (!img) {
					return;
				}
				img.src = url;
			});

			config.login_info.profile_picture = url;
		},

		usernameModalShow: function () {
			if (this.value && this.value.display_again !== null && this.value.display_again === 'false') {
				return;
			}

			var self = this,
				username = '<b>' + $('<div>').text(config.login_info.profile_name).html() + '</b>',
				url = window.location.href.replace(/#.*/, '') + '#' + this.getLocationHash(),
				message = i18n.__('chat.profile.info_username_update', {
					'%username%': username
				}),
				content = Mustache.render(tpl_profile_info, {
					message: (message||'').replace(/[\r\n]+/g, '<br>'),
				}),
				modal = LogAndTooltip.modal(content, {
					type: 'confirm',
					text_ok: i18n.__('chat.profile.info_username_keep', {
						'%username%': username
					}),
					text_cancel: i18n.__('chat.profile.info_username_edit'),
					on_ok: function() {
						self.saveModal(false);
					},
					on_no: function() {
						self.saveModal(false);
						window.location = url;
					}
				});

			modal.container.addClass('chat-profile-modal');
			$('<div class="contextual-popup-message"><a class="change-nickname" href="' + url + '">' + i18n.__('chat.profile.info_username_update_settings') + '</a></div>').appendTo(modal.container.find('.contextual-popup-content'));
		},

		validateFormData: function (formData) {
			var name = formData.get('name'),
				headshot = formData.get('headshot'),
				errors = [];

			if (name !== null) {
				errors = errors.concat(this.validateName(name));
			}
			if (headshot !== null) {
				errors = errors.concat(this.validateHeadshot(headshot));
			}

			return errors;
		},

		validateHeadshot: function () {
			return [];
		},

		validateName: function (name) {
			var errors = [];

			if (name === "") {
				errors.push(i18n.__('chat.profile.name_empty'));
			} else if (name.length < 3) {
				errors.push(i18n.__('chat.profile.name_min_char'));
			} else if (name.length > 45) {
				errors.push(i18n.__('chat.profile.name_max_char'));
			} else if (!name.match(/^[\w\d\.-]{3,45}$/i)) {
				errors.push(i18n.__('chat.profile.name_allowed_chars'));
			} else if (name.match(/support/i)) {
				errors.push(i18n.__('chat.profile.name_not_allowed'));
			}

			return errors;
		},

		viewHide: function () {
			Setting.prototype.viewHide.call(this);
			ChatWindowMessage.clear();
		}
	});

	Profile.getInstance = function () {
		if (instance === null) {
			instance = new Profile();
		}

		return instance;
	}

	return Profile.getInstance();
});

define('text!chat/setting/hiddenUsers/hiddenUsers.mustache',[],function () { return '<div class="chat-setting-content chat-setting-content--{{idName}}">\n</div>';});


define('text!friend.mustache',[],function () { return '<div\n\tid="select_friend_li_{{#search}}search_{{/search}}{{id_user}}"\n\tclass="chat-user{{#type}} chat-user--{{type}}{{/type}}{{#selected}} chat-user--selected{{/selected}}{{#nb_unread}} chat-user--new{{/nb_unread}} user{{id_user}} {{#expenses}}chat-user--expense{{/expenses}}"\n>\n\t<div class="chat-user__avatar" title="{{{status_trad}}}">\n\t\t{{{avatar}}}\n\t</div>\n\t<div class="chat-user__body{{#expenses}} expense expense--chat-user{{/expenses}}">\n\t\t<div class="chat-user__name-wrapper">\n\t\t\t{{#is_support}}<span class="chat-user__prefix-icon icon-f icf-support"></span>{{/is_support}}\n\t\t\t<span class="chat-user__name" title="{{profile_name}}">{{profile_name}}</span>\n\t\t\t{{#is_user_inactive}}<span class="chat-user__inactive">({{inactive_status_text}})</span>{{/is_user_inactive}}\n\t\t\t{{#expenses}}\n\t\t\t\t{{#expenses.has_total}}\n\t\t\t\t<span class="expense__total {{ expenses.ranking }}">\n\t\t\t\t\t<strong class="expense__total-amount">{{ expenses.amount_total }}</strong>\n\t\t\t\t</span>\n\t\t\t\t{{/expenses.has_total}}\n\t\t\t{{/expenses}}\n\t\t</div>\n\t\t{{#expenses.has_total}}\n\t\t\t{{#expenses.subscription_months_total_active}}\n\t\t\t<span class="expense__period">\n\t\t\t\t<span class="expense__month expense__month--active"><strong>{{ expenses.subscription_months_total_active }}</strong> {{ expenses.text_month_active }}</span> / <span class="expense__month expense__month--total"><strong>{{ expenses.subscription_months_total }}</strong> {{ expenses.text_month_total }}</span>\n\t\t\t</span>\n\t\t\t{{/expenses.subscription_months_total_active}}\n\t\t{{/expenses.has_total}}\n\t\t{{#message}}\n\t\t\t<div class="chat-user__last-message">{{{message.content}}}</div>\n\t\t{{/message}}\n\t</div>\n\t{{#message}}\n\t\t<div class="chat-user__last-message-metas">\n\t\t\t<div class="chat-user__last-message-date"><small>{{message.date}}</small></div>\n\t\t\t{{#tip}}<div class="chat-user__tip"><span class="badge chat-user__badge chat-user__badge--secondary">{{tip.amount}}</span></div>{{/tip}}\n\t\t\t{{#nb_unread}}<div class="chat-user__last-message-status"><span class="badge chat-user__badge">{{nb_unread}}</span></div>{{/nb_unread}}\n\t\t</div>\n\t{{/message}}\n</div>';});

define('chat/setting/hiddenUsers/hiddenUsers',[
	'mustache',
	'config/chat',
	'lib/i18n!front',
	'chat/setting/setting',
	'text!chat/setting/hiddenUsers/hiddenUsers.mustache',
	'text!avatar.mustache',
	'text!friend.mustache',
], function(
	Mustache,
	config,
	i18n,
	Setting,
	tpl_hiddenUsers,
	tpl_avatar,
	tpl_contact
) {
	var instance = null;

	var CLASS_NO_HIDDEN_USERS = 'no-hidden-users';
	var CLASS_LIST_HIDDEN_USERS = 'list-hidden-users';

	/**
	 *
	 * @constructor
	 */
	var HiddenUsers = function() {
		if (instance !== null) {
			wglog.error("HiddenUsers::constructor", "Can not instantiate more than one instance, use HiddenUsers.getInstance();");
		}

		Setting.call(this);
		this.addFriend = null;
		this.block.name = "general-settings";
		this.block.label = i18n.__('chat.settings.general_settings');
		this.followersListManager = null;
		this.hiddenUsersIds = null;
		this.hiddenUsersInfos = null;
		this.idName = 'hidden-users';
		this.label = i18n.__('chat.settings.creator_settings.hidden_users');
		this.list = null;
		this.name = 'hiddenusers';
		this.sortFriendListHtml = null;
	}

	HiddenUsers.prototype = Object.create(Setting.prototype);

	Object.assign(HiddenUsers.prototype, {
		addViewContent: function () {
			this.content = this.createElementFromTpl(tpl_hiddenUsers, {
				"idName": this.idName
			});
			this.content.style.display = this.viewIsVisible() ? 'flex' : 'none';
			document.querySelector('.chat-setting-area').append(this.content);
		},
		onActionButtonClick: function(event) {
			this.socket.emit('get_all_hidden_users', {});
			Setting.prototype.onActionButtonClick.call(this, event);
		},
		onShowButtonClick: function(event) {
			this.socket.emit('unhide_user', {
				'friend_id': event.target.dataset.id
			});
		},
		setOptions: function(obj) {
			if (!obj) {
				return;
			}

			if (!!obj.followersListManager) {
				this.followersListManager = obj.followersListManager;
			}
			if (typeof obj.addFriend === 'function') {
				this.addFriend = obj.addFriend;
			}
		},
		setHiddenUsers: function(result) {
			if (!Object.keys(result).length) {

				if (!!this.content.querySelector('.' + CLASS_NO_HIDDEN_USERS)) {
					return;
				}

				var hiddenUsersList = this.content.querySelector('.' + CLASS_LIST_HIDDEN_USERS);
				if (!!hiddenUsersList) {
					hiddenUsersList.remove();
				}

				var paragraph = document.createElement('p');
				paragraph.classList.add(CLASS_NO_HIDDEN_USERS);
				paragraph.innerText = i18n.__('chat.infos.no_hidden_user');
				this.content.append(paragraph);
				return;
			}

			this.hiddenUsersIds = [];
			this.hiddenUsersInfos = result;

			var list = this.setList();
			if (!!list) {
				this.content.append(list);
			}
		},
		setList: function() {
			if (this.hiddenUsersIds.length > 0) {
				return;
			}

			var noHiddenUsers = this.content.querySelector('.' + CLASS_NO_HIDDEN_USERS);
			if (!!noHiddenUsers) {
				noHiddenUsers.remove();
			}

			if (!this.list) {
				this.list = document.createElement('div');
				this.list.classList.add(CLASS_LIST_HIDDEN_USERS);
			}

			var ids = Object.keys(this.hiddenUsersInfos);
			for (var id in ids) {
				this.hiddenUsersIds.push(parseInt(ids[id]));
				if (this.list.querySelector('#select_friend_li_' + ids[id]) === null) {
					this.list.append(this.setItem(this.hiddenUsersInfos[ids[id]]));
				}
			}

			return this.list;
		},
		setItem: function(user) {
			if (!user.userInfos) {
				user.userInfos = {};
			}

			user.userInfos.avatar = Mustache.render(tpl_avatar, {
				src: user.userInfos.profile_picture,
				alt: user.userInfos.profile_name,
			});

			var unhideButton = document.createElement('button');
			unhideButton.classList.add('chat-btn');
			unhideButton.dataset.id = user.userInfos.id_user;
			unhideButton.innerText = i18n.__('chat.menu.show_user');
			unhideButton.addEventListener('click', this.onShowButtonClick.bind(this));

			var item = this.createElementFromTpl(Mustache.render(tpl_contact, user.userInfos));
			item.append(unhideButton);

			return item;
		},
		unhideUser: function(data) {
			var idUser = parseInt(data.friend_id),
				indexUser = this.hiddenUsersIds.indexOf(idUser);

			if (indexUser === - 1) {
				return;
			}

			this.list.querySelectorAll('.chat-user').forEach(function(item) {
				if (item.classList.contains('user' + idUser)) {
					item.remove();
				}
			});

			this.addFriend(!!data.userInfo ? data.userInfo : this.hiddenUsersInfos[idUser].userInfos);

			this.hiddenUsersIds.splice(indexUser, 1);
			if (this.hiddenUsersInfos[idUser]) {
				delete this.hiddenUsersInfos[idUser];
			}

			if (this.followersListManager.getFollowersListEnable()) {
				if (data.userInfo.is_customer) {
					this.followersListManager.incrementFriendsTotal(1);
				} else {
					this.followersListManager.incrementFollowersTotal(1);
				}
				this.followersListManager.refreshContactCounters();
			}
		}
	});

	HiddenUsers.getInstance = function () {
		if (instance === null) {
			instance = new HiddenUsers();
		}

		return instance;
	}

	return HiddenUsers.getInstance();
});

define('text!expense_detail.mustache',[],function () { return '<ul class="expense__list">\n\t{{#has_ppd }}<li class="expense__item expense__item-ppd">{{ label_ppd }} : <strong>{{ ppd }}</strong></li>{{/has_ppd}}\n\t{{#has_subs }}<li class="expense__item expense__item-subs">{{ label_subs }} : <strong>{{ subs }}</strong></li>{{/has_subs}}\n\t{{#has_tips }}<li class="expense__item expense__item-tips">{{ label_tips }} : <strong>{{ tips }}</strong></li>{{/has_tips}}\n\t{{#header_message}}\n\t<li class="expense__item expense__item--sub-detail"><strong class="expense__item-month-active">{{ month_active }}</strong> {{ label_month_active }} / <strong class="expense__item-month-total">{{ month_total }}</strong> {{ label_month_total }} </li>\n\t{{/header_message}}\n</ul>';});


define('text!header_messages.mustache',[],function () { return '<div class="chat-message-header">\r\n\t<div class="chat-message-header__body">\r\n\t\t<button class="chat-message-header__back btn btn--flat" type="button" id="chat-message-header-button">\r\n\t\t\t<span>{{{ trad.button_back }}}</span>\r\n\t\t</button>\r\n\t\t<div class="chat-message-header__user-info-wrapper">\r\n\t\t\t<div class="chat-message-header__profile-wrapper">\r\n\t\t\t\t<div class="chat-message-header__avatar">\r\n\t\t\t\t\t{{{avatar}}}\r\n\t\t\t\t</div>\r\n\t\t\t\t<div class="chat-message-header__name-wrapper{{^has_followers_list}} full{{/has_followers_list}}">\r\n\t\t\t\t\t{{#profile_url}}<a href="{{profile_url}}">{{/profile_url}}\r\n\t\t\t\t\t\t<span class="chat-message-header__name">{{{profile_icon}}}{{profile_name}}</span>\r\n\t\t\t\t\t{{#profile_url}}</a>{{/profile_url}}\r\n\t\t\t\t\t{{#display_user_id}}\r\n\t\t\t\t\t\t<small><span class="chat-message-header__user-id"><b>ID:</b> {{id_user}}</span></small>\r\n\t\t\t\t\t\t{{#account_id}}\r\n\t\t\t\t\t\t\t<small><span class="chat-message-header__user-id"><b>Account ID:</b> {{account_id}}</span></small>\r\n\t\t\t\t\t\t{{/account_id}}\r\n\t\t\t\t\t\t{{#id_user_xv}}\r\n\t\t\t\t\t\t\t<small>\r\n\t\t\t\t\t\t\t\t{{#url_xv_admin}}\r\n\t\t\t\t\t\t\t\t<a class="chat-message-header__xvideos-admin-link" href="{{url_xv_admin}}">\r\n\t\t\t\t\t\t\t\t\t<i class="icon-f icf-link"></i><span class="chat-message-header__xvideos-id"><b>ID XV:</b> {{id_user_xv}}</span>\r\n\t\t\t\t\t\t\t\t</a>\r\n\t\t\t\t\t\t\t\t{{/url_xv_admin}}\r\n\t\t\t\t\t\t\t</small>\r\n\t\t\t\t\t\t{{/id_user_xv}}\r\n\t\t\t\t\t{{/display_user_id}}\r\n\t\t\t\t</div>\r\n\t\t\t\t{{#expenses}}\r\n\t\t\t\t\t{{#expenses.has_total}}\r\n\t\t\t\t\t<div class="chat-message-header__expenses expense expense--{{ id_user }} expense--header">\r\n\t\t\t\t\t\t<span class="expense__total {{ expenses.ranking }}">\r\n\t\t\t\t\t\t\t<strong class="expense__total-amount">{{ expenses.amount_total }}</strong>\r\n\t\t\t\t\t\t</span>\r\n\t\t\t\t\t\t<ul class="expense__detail">\r\n\t\t\t\t\t\t\t{{#expenses.has_ppd}}<li class="expense__detail-ppd">{{ expenses.text_ppd }} : <strong>{{ expenses.amount_ppd }}</strong></li>{{/expenses.has_ppd}}\r\n\t\t\t\t\t\t\t{{#expenses.has_subs}}<li class="expense__detail-subs">{{ expenses.text_subs }} : <strong>{{ expenses.amount_subs }}</strong></li>{{/expenses.has_subs}}\r\n\t\t\t\t\t\t\t{{#expenses.has_tips }}<li class="expense__detail-tips">{{ expenses.text_tips }} : <strong>{{ expenses.amount_tips }}</strong></li>{{/expenses.has_tips }}\r\n\t\t\t\t\t\t</ul>\r\n\t\t\t\t\t\t{{#expenses.subscription_months_total_active}}\r\n\t\t\t\t\t\t<span class="expense__period">\r\n\t\t\t\t\t\t\t<span class="expense__month expense__month--active"><strong>{{ expenses.subscription_months_total_active }}</strong> {{ expenses.text_month_active }}</span> / <span class="expense__month expense__month--total"><strong>{{ expenses.subscription_months_total }}</strong> {{ expenses.text_month_total }}</span>\r\n\t\t\t\t\t\t</span>\r\n\t\t\t\t\t\t{{/expenses.subscription_months_total_active}}\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t{{/expenses.has_total}}\r\n\t\t\t\t{{/expenses}}\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t</div>\r\n\r\n\t{{#conversation_menu}}\r\n\t\t<div class="chat-message-header__menu">\r\n\t\t\t{{{tip_button}}}\r\n\t\t\t<button type="button" class="btn btn--flat chat-message-header__menu-item" id="chat_friend_menu_switch">\r\n\t\t\t\t<svg class="chat-scc"><use xlink:href="#scc-three-dots"></use></svg>\r\n\t\t\t</button>\r\n\t\t</div>\r\n\r\n\t\t<div class="chat-friend-menu" id="chat_friend_menu">\r\n\t\t\t{{#hide_user_enabled}}\r\n\t\t\t\t<div class="chat-message-header-hide-user chat-message-header-menu-icon chat-friend-menu__item">\r\n\t\t\t\t\t<div class="icon-f icf-eye-slashed icf-2x"></div>\r\n\t\t\t\t\t<div class="chat-friend-menu__text">{{{ trad.menu.hide_user }}}</div>\r\n\t\t\t\t</div>\r\n\t\t\t{{/hide_user_enabled}}\r\n\t\t\t{{#has_followers_list}}\r\n\t\t\t\t<div class="chat-message-header-switch-contact chat-message-header-menu-icon chat-friend-menu__item">\r\n\t\t\t\t\t<svg class="chat-scc"><use xlink:href="#scc-switch-contact-list"></use></svg>\r\n\t\t\t\t\t<div class="chat-friend-menu__text"></div>\r\n\t\t\t\t</div>\r\n\t\t\t{{/has_followers_list}}\r\n\t\t\t{{#reminder_enabled}}\r\n\t\t\t<div class="chat-message-header-reminder chat-message-header-menu-icon chat-friend-menu__item">\r\n\t\t\t\t<div class="icon-f icf-bell icf-2x"></div>\r\n\t\t\t\t<div class="chat-friend-menu__text">{{{ trad.menu.reminder }}}</div>\r\n\t\t\t</div>\r\n\t\t\t{{/reminder_enabled}}\r\n\t\t\t{{#favorite_friend_enabled}}\r\n\t\t\t<div class="chat-message-header-change-fav chat-message-header-menu-icon chat-friend-menu__item" title="{{#is_favorite}}{{{ trad.remove_favorite }}}{{/is_favorite}}{{^is_favorite}}{{{ trad.add_favorite }}}{{/is_favorite}}">\r\n\t\t\t\t{{#is_favorite}}<div class="icon-f icf-star-full icf-2x"></div>{{/is_favorite}}{{^is_favorite}}<div class="icon-f icf-star-empty icf-2x"></div>{{/is_favorite}}\r\n\t\t\t\t<div class="chat-friend-menu__text">{{{ trad.menu.favorite }}}</div>\r\n\t\t\t</div>\r\n\t\t\t{{/favorite_friend_enabled}}\r\n\t\t\t{{#block_report_user_enabled}}\r\n\t\t\t<div class="chat-message-header-block chat-message-header-menu-icon chat-friend-menu__item" title="{{{ trad.block_or_ghost }}}">\r\n\t\t\t\t<div class="icon-f icf-user-minus icf-2x"></div>\r\n\t\t\t\t<div class="chat-friend-menu__text">{{{ trad.block_or_ghost }}}</div>\r\n\t\t\t</div>\r\n\t\t\t{{/block_report_user_enabled}}\r\n\t\t\t{{#copy_messages_enabled}}\r\n\t\t\t<div class="chat-message-header-copy chat-message-header-menu-icon chat-friend-menu__item" title="{{{ trad.copy_conv_to_clipboard }}}">\r\n\t\t\t\t<div class="icon-f icf-copy icf-2x"></div>\r\n\t\t\t\t<div class="chat-friend-menu__text">{{{ trad.menu.copy }}}</div>\r\n\t\t\t</div>\r\n\t\t\t{{/copy_messages_enabled}}\r\n\t\t\t{{#encrypt_messages_enabled}}\r\n\t\t\t<div class="chat-message-header-crypt-old-done chat-message-header-menu-icon chat-friend-menu__item">\r\n\t\t\t\t<div class="chat-icon-home icon-f icf-lock icf-2x" title="{{{ trad.crypt_old_messages_done }}}"></div>\r\n\t\t\t\t<div class="chat-friend-menu__text">{{{ trad.menu.encrypted }}}</div>\r\n\t\t\t</div>\r\n\t\t\t{{/encrypt_messages_enabled}}\r\n\t\t\t{{#delete_messages_enabled}}\r\n\t\t\t<div class="chat-message-header-delete-all chat-message-header-menu-icon chat-friend-menu__item">\r\n\t\t\t\t<div class="chat-icon-home icon-f icf-close icf-2x" title="{{{ trad.delete_all_messages }}}"></div>\r\n\t\t\t\t<div class="chat-friend-menu__text">{{{ trad.menu.delete }}}</div>\r\n\t\t\t</div>\r\n\t\t\t{{/delete_messages_enabled}}\r\n\t\t</div>\r\n\t{{/conversation_menu}}\r\n</div>';});


define('text!messages_tab.mustache',[],function () { return '<div id="{{tab_id}}" class="chat-tab-container {{is_typing_class}}">\n\t<ul id="{{list_id}}" class="chat-tab-container__list chat_group_tab_container"></ul>\n\n\t<div class="chat-tab-container__badges">\n\t\t<div class="badge chat-bg-secondary fade chat_block chat_blocking">{{blocking}}</div>\n\t\t<div class="badge chat-bg-secondary fade chat_block chat_ghosting">{{ghosting}}</div>\n\t\t<div class="badge chat-bg-secondary fade chat_block chat_blocked">{{blocked}}</div>\n\t\t<div class="badge chat-bg-primary fade chat_typing">{{is_typing}}</div>\n\t</div>\n</div>';});


define('text!chat_user_search_nav.mustache',[],function () { return '<div class="chat-users-search__nav">\n\t<button type="button" class="chat-users-search__back btn btn--flat" id="chat-users-search-close" title="{{return_label}}">\n\t\t<span class="icon-f icf-arrow-left"></span>\n\t</button>\n\t<span class="chat-users-search__count">{{{search_count}}}</span>\n</div>';});


define('chat_friends_manager',[
	'lib/tools',
	'mustache',
	'chat/attachment/attachment_manager',
	'chat/scroll_conversation/scroll_conversation',
	'chat/select_messages/select_messages',
	'chat/select_contacts/select_contacts',
	'config/chat',
	'./log_and_tooltip',
	'lib/cookies',
	'lib/emoji',
	'lib/i18n!front',
	'lib/storage',
	'lib/utils',
	'lib/helpers/inline_loader',
	'lib/helpers/popup',
	'lib/helpers/popup/contextual_menu',
	'libs/jsencrypt.min',
	'chat_window_message',
	'text!avatar.mustache',
	'text!friend.mustache',
	'text!expense_detail.mustache',
	'text!header_messages.mustache',
	'text!messages_tab.mustache',
	'text!chat_user_search_nav.mustache',
	'FriendManagerEvent',
	'features/Reminder/models/ReminderModel',
	'features/Reminder/events/ReminderEvent',
	'features/Draft/events/DraftEvent',
	'features/Message/utils/Message',
	'features/ContactList/events/ContactListEvent',
	'features/ContactList/CustomerList/events/CustomerListEvent',
	'features/ContactList/FollowerList/events/FollowerListEvent',
], function(
	tools,
	Mustache,
	attachment_manager,
	scroll_conversation,
	select_messages,
	select_contacts,
    config,
    log_and_tooltip,
    cookies,
    emoji,
    i18n,
    xv_storage,
    utils,
    inline_loader,
	popup,
	ContextualMenu,
    jsencrypt,
    chat_window_message,
	tpl_avatar,
    tpl_friend,
    tpl_expense_detail,
    tpl_header_messages,
    tpl_messages_tab,
    tpl_user_search_nav,
	FriendManagerEvent,
	ReminderModel,
	ReminderEvent,
	DraftEvent,
	MessageUtils,
	ContactListEvent,
	CustomerListEvent,
	FollowerListEvent
) {

	var friends_manager = function(
		chatInitsAndPrefs,
		chat_friend_action,
		chat_send_file,
		priv_key,
		node,
		url_base_profile,
		empty_message_form_fct,
		get_conversation_fct,
		get_real_message_fct,
		make_real_message_fct,
		set_read_date_fct,
		get_users_infos_enqueue_fct,
		initUploaderAndVaultFct,
		getContactListTypeAndEventsFct,
		textarea_input,
		content,
		vault,
		chatContext
	) {
		this.friends = {};
		this.friends_ids = [];
		this.selected_friend = 0;
		this.message_header_display_user_id = false;

		this.nb_friends_get_with_more_link = 40;

		this.chatInitsAndPrefs = chatInitsAndPrefs;
		this.chat_friend_action = chat_friend_action;
		this.chat_send_file = chat_send_file;

		this.priv_key = priv_key;
		this.node = node;

		this.input = textarea_input;

		this.send_button = this.node.find('#chat-send-btn');
		this.search_button = this.node.find('#chat-users-search-input button#chat-search-button');
		this.search_input = this.node.find('#chat-users-search-input input');
		this.userlistsearch = this.node.find('#chat-users-search');
		this.userlistsearchclose = this.node.find('#chat-users-search-close');
		this.msglist = this.node.find('.chat-messages');
		this.chat_header_messages = this.node.find(".chat-header-messages");

		this.request_search = null;
		this.old_search = null;
		this.cache_search = {};

		this.url_base_profile = url_base_profile;

		this.empty_message_form_fct = empty_message_form_fct;
		this.get_conversation_fct = get_conversation_fct;
		this.get_real_message_fct = get_real_message_fct;
		this.make_real_message_fct = make_real_message_fct;
		this.set_read_date_fct = set_read_date_fct;
		this.get_users_infos_enqueue_fct = get_users_infos_enqueue_fct;
		this.initUploaderAndVaultFct = initUploaderAndVaultFct;
		this.getListTypeAndEvents = getContactListTypeAndEventsFct;

		this.disabled_send_btn = false;
		/*this.is_registering_new_contact = false;*/

		this.support_ids = [];
		this.content = content;
		this.vault = vault;
		this.chatContext = chatContext;

		this.setup_last_tip_intersection_observer();
	};

	friends_manager.prototype = {

		set_chat_send_file: function(chat_send_file) {
			this.chat_send_file = chat_send_file;
		},

		set_friends: function(friends) {
			this.friends = friends;
		},

		get_friends: function() {
			return this.friends;
		},

		set_selected_friend: function(selected_friend) {
			this.selected_friend = selected_friend;
		},

		set_message_header_display_user_id: function(message_header_display_user_id) {
			this.message_header_display_user_id = message_header_display_user_id;
		},

		set_user_id: function(user_id) {
			this.user_id = user_id;
		},

		set_keys_create_timestamp: function(keys_create_timestamp) {
			this.keys_create_timestamp = keys_create_timestamp;
		},

		set_socket_connection: function( socket_connection ) {
			this.socket_connection = socket_connection;
		},

		get_friend_infos: function(friend_id) {
			if ( !this.friends.hasOwnProperty(friend_id) ) {
				return false;
			}

			return this.friends[friend_id];
		},

		get_selected_friend_id: function() {
			return this.selected_friend;
		},
		get_selected_friend_infos: function() {
			return this.get_friend_infos(this.selected_friend);
		},

		set_friends_id: function(friends_ids) {
			for (var id in friends_ids) {
				if (this.friends_ids.indexOf(friends_ids[id]) === -1) {
					this.friends_ids.push(friends_ids[id]);
				}
			}
		},

		set_friend_attribut: function(contact_id, name, value, updateUnread) {
			var contact = this.friends[contact_id];
			if (!contact) {
				return;
			}

			var listTypeAndEvents = this.getListTypeAndEvents(contact),
				events = listTypeAndEvents.events,
				listType = listTypeAndEvents.type;

			if (updateUnread && name === 'nb_unread' && !value) {
				value = !contact.nb_unread ? 1 : contact.nb_unread + 1;
			}

			this.chatContext.emit(events.ADD_CONTACT_ATTRIBUTE, {
				attrName: name,
				attrValue: value,
				contactId: contact_id,
				listType: listType
			});
		},
		setMultipleContactAttributes: function(contact_id, attributes) {
			var contact = this.friends[contact_id];
			if (!contact) {
				return;
			}

			var listTypeAndEvents = this.getListTypeAndEvents(contact),
				events = listTypeAndEvents.events,
				listType = listTypeAndEvents.type;

			for (var index in attributes) {
				var attr = attributes[index];
				this.chatContext.emit(events.ADD_CONTACT_ATTRIBUTE, {
					attrName: attr.name,
					attrValue: attr.value,
					contactId: contact_id,
					listType: listType
				});

			}
		},

		find_friend_id_by_name: function (name) {
			var friend_id = 0;

			for (var id in this.friends) {
				var friend = this.friends[id];

				if (friend.profile_name == name) {
					friend_id = id;
					break;
				}

				if (friend.alias == name) {
					friend_id = id;
					break;
				}
			}

			return friend_id;
		},

		select_friend_by_name: function (name) {
			var friend_to_select = this.find_friend_id_by_name(name);

			if (friend_to_select) {
				wglog.debug('select_friend_by_name', 'id found: ' + friend_to_select);
				this.select_friend(friend_to_select);
			}
		},

		select_friend: function (id_friend, last_read) {
			if ( this.hasOwnProperty( "not_logged" ) && this.not_logged == 1 ) {
				log_and_tooltip.write_error({logTitle:'chat_friend_manager::select_friend user not logged to the chat', "message": "You need to log in for using chat."});
				return;
			}

			var selectedFriend = this.friends[id_friend];

			this.chatContext.emit(DraftEvent.GET, id_friend, '#textarea-group .emojionearea-editor');

			if (
				this.chatContext.manager.contactLists.hasOwnProperty('followers')
				&& selectedFriend && selectedFriend.network && selectedFriend.network === 'xvideos'
				&& selectedFriend.id_user === selectedFriend.id_user_xv
			) {
				this.disabled_send_btn = true;
				this.allow_users_to_chat(null, true);
				this.send_button.find('span').text(i18n.__('chat.error.please_wait'));
				if (!this.is_registering_new_contact) {
					this.is_registering_new_contact = true;
					this.socket_connection.emit('register_new_user_from_xv', {
						'xv_user_id': this.friends[id_friend].id_user_xv || id_friend
					});
				}
			}

			// Authorize chat to selected not_friend ???
			if (this.selected_friend !== 0 && typeof selectedFriend !== "undefined" && (selectedFriend.not_friend)) {
				this.setMessageFormState();
			}

			select_contacts.hideSelectContact();

			// Unselect previous selected friend
			if (this.selected_friend && this.selected_friend !== id_friend) {
				this.unselect_friend();
			}

			window.location.hash = 'conversation_' + id_friend;
			xv_storage.set('id_last_conversation', id_friend);

			var conversationId = "chat_messages_tab_" + id_friend,
				conversationElt = $("#" + conversationId);

			if (id_friend == this.selected_friend && conversationElt.length > 0 && !$(".chat-window").hasClass("chat-window--home")) {
				wglog.debug("friend already selected");
				this.chatInitsAndPrefs.set_timer_away();
				return;
			}

			var add_typing = false;
			if ( typeof this.typing_to_friend !== "undefined" && this.typing_to_friend && this.typing_to_friend != id_friend && this.input.val().length > 0 ) {
				this.socket_connection.emit("typing_stop", {"id_friend": this.selected_friend});
				add_typing = true;
			}

			this.selected_friend = id_friend;

			var ul_id = "chat_group_messages_tab_" + id_friend;

			$(".chat-window").removeClass("chat-window--home");
			$(".chat-tab-container").hide();
			$("#chat-side-column .chat-user--selected").removeClass("chat-user--selected");

			var selectedFriendElt = $("#select_friend_li_" + id_friend);
			selectedFriendElt.addClass("chat-user--selected");

			var friend_total = selectedFriendElt.find('.expense__total');
			if (friend_total.length && friend_total.hasClass('new')) {
				friend_total.removeClass('new');
			}

			this.header_messages_html( id_friend );

			if (this.initUploaderAndVaultFct() === false) {
				this.uploader_unavalaible();
			}

			if (this.hasSwitchListButton(id_friend)) {
				this.setSwitchContactListBtn(id_friend);
			}

			if (typeof this.friends[id_friend] !== "undefined" && this.friends[id_friend].not_friend) {
				this.disable_send_button();
				conversationElt.show();
				return;
			}

			if (conversationElt.length === 0) {
				// don't let user send messages before loading history ( and conversation keys )
				this.send_button.prop('disabled', true);
				this.send_button.addClass("disabled");

				var tpl_vars = {
					tab_id: conversationId,
					list_id: ul_id,
					blocked: i18n.__("profile.tag.blocked_user"),
					blocking: i18n.__("profile.tag.blocking_user"),
					ghosting: i18n.__("profile.tag.ghosting_user")
				};

				var is_typing = i18n.__("profile.tag.is_typing");
				// to be sure ... but normally we need this.friends[id_friend] to call select
				if ( typeof selectedFriend !== "undefined" && typeof selectedFriend.profile_name !== "undefined" ) {
					is_typing = i18n.__("profile.tag.friend_is_typing", {'%name%': selectedFriend.profile_name});
				}
				tpl_vars.is_typing = is_typing;

				var is_typing_class = "";
				if ( $("#select_friend_li_" + id_friend).hasClass("chat_friend_typing") ) {
					is_typing_class = " chat_is_typing";
				}
				tpl_vars.is_typing_class = is_typing_class;

				this.msglist.append(Mustache.render(tpl_messages_tab, tpl_vars));

				this.observeTabListResize(this.msglist.find('#' + ul_id)[0]);
				this.change_block_status_from_friend_id(id_friend);

				// don't block background scroll on chat page
				if ( $("#account-chat-private-container").length == 0 ) {
					$("#" + ul_id).scrollLock();
				}

				this.get_conversation_fct(id_friend);
			} else {
				conversationElt.show();
        this.change_block_status_from_friend_id(id_friend);
				this.update_last_message_marker(id_friend, (typeof last_read !== 'undefined' && typeof last_read === 'number' && last_read > 0) ? last_read : null);
				scroll_conversation.downOrToFirstUnreadMarker(id_friend);
			}

			if (!!selectedFriend.cancel_set_read_date) {
				selectedFriend.cancel_set_read_date = false;
			}

			this.upsert_tip_button(this.friends[id_friend]);
			this.upsert_order_custom_content_button(this.friends[id_friend]);

			if (selectedFriend.user_status === 'inactive') {
				this.disable_send_button();
			}

			this.allow_users_to_chat(selectedFriend);

			attachment_manager.setVisibleServices(this.get_attachment_visible_services(selectedFriend));
			if (selectedFriend.is_support || config.login_info.is_support) {
				attachment_manager.addExtraFileType('pdf');
			} else {
				attachment_manager.removeExtraFileType('pdf');
			}
			attachment_manager.hide();

			if (selectedFriend.is_handle_by_manager || selectedFriend.is_handle_by_manager === 'true') {
				this.manage_user_creator_account_managed(true);
			}

			var self = this;
			$( "#" + ul_id).on("scroll", function(event) {
				if ( typeof self.messages_client_height !== "undefined" && self.messages_client_height != this.clientHeight ) {
					return;
				}

				self.messages_from_bottom = this.scrollHeight - this.clientHeight - this.scrollTop;
				self.messages_client_height =  this.clientHeight;
			});

			if (add_typing) {
				this.typing_to_friend = id_friend;
				this.socket_connection.emit("typing_start", {"id_friend": id_friend});
			}

			// update data in SW
			if (this.chatInitsAndPrefs.serviceWorker) {
				try {
					this.chatInitsAndPrefs.serviceWorker.postMessage({
						"action": "last_friend_conv",
						"friend_id": id_friend
					});
				} catch (e) {
					wglog.error('Failed to send last_friend_conv to SW', e.toString());
				}
			}
		},

		disable_send_button: function() {
			this.setMessageFormState(true);
		},
		upsert_tip_button: function (friend_info) {
			var btn = $('.chat-message-form__action--tip');

			if (!config.tip_enabled || !config.login_info.is_fan || friend_info.is_support || !friend_info.is_creator || !friend_info.tip_url || friend_info.network === 'xvideos') {
				btn.remove();
				return;
			}

			var tpl_tip_btn = '<button type="button" class="btn btn--flat chat-message-form__action chat-message-form__action--default chat-message-form__action--tip js-create-tips" title="{{ trad.send_tip }}" data-action="{{ tip_url }}" data-name="{{ profile_name }}" data-headshot="{{ profile_picture }}" data-poster="{{ poster_url }}" data-alias="{{#alias}}{{alias}}{{/alias}}{{#main_brand_alias}}{{main_brand_alias}}{{/main_brand_alias}}" data-label-id="{{ account_label_id }}"><svg class="chat-scc"><use xlink:href="#scc-tip-icon"></use></svg><span>{{ trad.tip }}</span></button>';

			if (config.tip_button_tpl && typeof config.tip_button_tpl == "string") {
				tpl_tip_btn = config.tip_button_tpl;
			}

			var tpl_infos = friend_info;
			tpl_infos.trad = {
				send_tip: i18n.__('chat.send_tip'),
				tip: i18n.__('chat.tip')
			};

			var html = Mustache.render(tpl_tip_btn, tpl_infos);

			if (btn.length) {
				btn.replaceWith(html);
			} else {
				$(html).insertBefore('#chat-send-btn');
			}

			var info = $('.modal-tip__info');

			if (!info.length) {
				$('.modal-tip__message').after(`<div class="modal-tip__info form-group"><p>${i18n.__('chat.tip.to_improve_contact_list_position', {"%name%": friend_info.profile_name})}</p></div>`);
			}
		},
		upsert_order_custom_content_button: function (friend_info) {
			var btn = $('.chat-message-form__action--order-custom-content');

			if (!friend_info.allow_custom_requests || !config.login_info.is_fan || friend_info.is_support || !friend_info.is_creator || friend_info.network === 'xvideos') {
				btn.remove();
				return;
			}

			var tpl_order_custom_content_btn = '<button type="button" class="btn btn--flat chat-message-form__action chat-message-form__action--default chat-message-form__action--order-custom-content js-custom-scene-order-button" data-alias="{{#alias}}{{alias}}{{/alias}}{{#main_brand_alias}}{{main_brand_alias}}{{/main_brand_alias}}" data-label-id="{{ account_label_id }}"><svg class="chat-scc"><use xlink:href="#scc-request-custom-order-icon"></use></svg><span>{{ trad.label }}</span></button>',
				tpl_infos = friend_info;

			tpl_infos.trad = {
				label: i18n.__('chat.custom_scene_order')
			};

			var html = Mustache.render(tpl_order_custom_content_btn, tpl_infos);

			if (btn.length) {
				btn.replaceWith(html);
			} else {
				$(html).insertBefore('.chat-message-form__action--tip');
			}

			$('body').trigger('setAliasOrderCustomScene', ['js-custom-scene-order-button']);
			$('body').trigger('setLabelIdOrderCustomScene', ['js-custom-scene-order-button']);

		},

		unselect_friend: function () {
			if (!this.friends[this.selected_friend]) {
				return;
			}

			chat_window_message.clear();

			this.empty_message_form_fct();

			this.selected_friend = 0;
			$('.chat-user--selected').removeClass('chat-user--selected');
		},

		reset_friend_meta: function (friend_id) {
			this.setMultipleContactAttributes(friend_id, [
				{ name: 'last_id_message', value: undefined },
				{ name: 'last_id_sender', value: undefined },
				{ name: 'last_message', value: undefined },
				{ name: 'last_read', value: 0 },
				{ name: 'last_timestamp', value: 0 },
				{ name: 'interaction', value: 0 },
				{ name: 'nb_unread', value: 0 }
			]);
		},

		header_messages_html: function(friend_id) {
			this.chat_header_messages.children('.chat-message-header').remove();

			var self = this,
				header_html = this.get_header_messages_html(friend_id);

			$(document).on('click', '.chat-message-header__back', this.close_conversation.bind(this));

			$('img', header_html).on('error', function() {
				$(this).hide();
			});
			this.chat_header_messages.append(header_html);

			this.chatContext.emit(FriendManagerEvent.HEADER_MESSAGE_CREATED, header_html.get(0), friend_id);

			if (config.login_info.is_creator) {
				var switchContact = this.chat_header_messages.find('.chat-message-header-switch-contact');
				if (switchContact.length) {
					switchContact.on('click', function(event) {
						self.chat_friend_action.switch_contact_list(event);
					});
				}
			}

			this.chat_header_messages.find('.chat-message-header-hide-user').on('click', function(event) {
				self.chat_friend_action.hide_user(self.selected_friend);
				self.remove_friend(self.selected_friend);
			});

			if (config.message_menu_feature.favorite_friend_enabled) {
				this.chat_header_messages.find(".chat-message-header-change-fav").on('click', function(event) {
					self.chat_friend_action.change_favorite_state(event);
				});
			}
			if (config.message_menu_feature.block_report_user_enabled) {
				this.chat_header_messages.find(".chat-message-header-block").on('click', function(event) {
					self.chat_friend_action.block_report(event, self.selected_friend, self.friends);
				});
			}
			if (config.message_menu_feature.copy_messages_enabled) {
				this.chat_header_messages.find(".chat-message-header-copy").on('click', function(event) {
					event.stopPropagation();
					self.chat_friend_action.copy_messages_to_clipboard(self.selected_friend);
				});
			}

			this.chat_friend_menu_is_visible = false;
			this.chat_header_messages.find("#chat_friend_menu_switch").on('click', this.chat_friend_menu_switch_on_click.bind(this));
			$(document).on('popupOpen', this.chat_friend_menu_hide.bind(this));
			$(document).on('chatFriendMenuShow', function () {
				$('.chat-user, .chat-message__action--context-menu').each(function () {
					if (this.contextMenu) this.contextMenu.close();
				});
			});

			if (config.message_menu_feature.delete_messages_enabled) {
				this.chat_header_messages.find(".chat-message-header-delete-all").on('click.delete_all_messages', function(event) {
					event.stopPropagation();
					self.chat_header_messages.find(".chat-message-header-delete-all").off('click.delete_all_messages');
					self.chat_friend_action.delete_all_messages( self.get_selected_friend_infos() );
				});
			}

			if (config.message_menu_feature.encrypt_messages_enabled) {
				this.header_message_set_warning_crypt();
				this.header_message_set_crypt_old();
			}

			var friend_infos = this.get_friend_infos(friend_id);

			if (config.login_info.is_creator) {
				this.set_header_expenses(friend_infos, this.chat_header_messages);
			}

			if (config.login_info.is_support) {
				var fnClickAddEditReminder = function(event) {
					event.stopPropagation();
					self.chat_friend_menu_hide();
					self.chatContext.emit(ReminderEvent.OPEN_FORM, self.selected_friend);
				};

				this.chat_header_messages.find(".chat-message-header-reminder").on('click', fnClickAddEditReminder);
			}
		},
		get_header_messages_html: function(friend_id) {
			var friend_infos = this.get_friend_infos(friend_id);

			if (!friend_infos) {
				wglog.error( "header_messages_html", "no data for this friend" );
				return;
			}

			var tpl_infos = Object.assign({}, friend_infos);
			tpl_infos.favorite_friend_enabled = config.message_menu_feature.favorite_friend_enabled;
			tpl_infos.block_report_user_enabled = friend_infos.is_support ? false : config.message_menu_feature.block_report_user_enabled;
			tpl_infos.copy_messages_enabled = config.login_info.is_support && config.message_menu_feature.copy_messages_enabled;
			tpl_infos.delete_messages_enabled = config.message_menu_feature.delete_messages_enabled;
			tpl_infos.encrypt_messages_enabled = config.message_menu_feature.encrypt_messages_enabled;
			tpl_infos.reminder_enabled = config.login_info.is_support;
			tpl_infos.hide_user_enabled = config.login_info.is_creator;
			tpl_infos.favorite = false;
			if ( tpl_infos.is_favorite == 1 ) {
				tpl_infos.favorite = this.favorite_img;
			}
			tpl_infos.display_user_id = config.login_info.is_support;
			tpl_infos.conversation_menu = (!friend_infos.is_support || !!friend_infos.not_friend);

			tpl_infos.trad = {};
			tpl_infos.trad.button_back = i18n.__('chat.button_return_friends');
			tpl_infos.trad.send_tip = i18n.__('chat.send_tip');
			tpl_infos.trad.profile_page = i18n.__('profile.title_link_page');
			tpl_infos.trad.remove_favorite = i18n.__('chat.remove_from_favorites');
			tpl_infos.trad.add_favorite = i18n.__('chat.add_to_favorites');
			tpl_infos.trad.block_or_ghost = i18n.__('chat.block_or_ghost');
			tpl_infos.trad.crypt_old_messages_done = i18n.__('chat.crypt_old_messages_done');
			tpl_infos.trad.report_last_message = i18n.__('chat.report_last_message');
			tpl_infos.trad.delete_all_messages = i18n.__('chat.delete_all_messages');
			tpl_infos.trad.copy_conv_to_clipboard = i18n.__('chat.copy_conv_to_clipboard');
			tpl_infos.trad.menu = {};
			tpl_infos.trad.menu.favorite = i18n.__('chat.menu.favorite');
			tpl_infos.trad.menu.block_report = i18n.__('chat.menu.block_report');
			tpl_infos.trad.menu.copy = i18n.__('chat.menu.copy');
			tpl_infos.trad.menu.not_encrypted = i18n.__('chat.menu.not_encrypted');
			tpl_infos.trad.menu.encrypt = i18n.__('chat.menu.encrypt');
			tpl_infos.trad.menu.encrypted = i18n.__('chat.menu.encrypted');
			tpl_infos.trad.menu.delete = i18n.__('chat.menu.delete');
			tpl_infos.trad.menu.hide_user = i18n.__('chat.menu.hide_user');

			tpl_infos.has_followers_list = this.hasSwitchListButton(friend_id);
			if (tpl_infos.has_followers_list) {
				var btn = {}
				if (this.customers_ids.indexOf(friend_id) === -1) {
					btn.label = 'Add to friends and customers list';
					btn.id = 'add';
				} else {
					btn.label = 'Remove from friends and customers list';
					btn.id = 'remove';
				}
			}

			tpl_infos.avatar = this.generate_avatar(friend_infos, false, null, true);

			if (tpl_infos.is_support) {
				tpl_infos.profile_icon = '<span class="icon-f icf-support"></span>';
			}

			tpl_infos.user = {
				earnings_label: i18n.__('chat.total_earnings'),
				earnings_amount: 0
			}

			if (this.message_header_display_user_id) {
				tpl_infos.user = {
					earnings_label: 'Id:',
					earnings_amount: friend_id
				}
			}

			if (config.login_info.is_fan || config.login_info.is_creator) {
				tpl_infos.delete_messages_enabled = false;
			}

			tpl_infos.encrypt_messages_enabled = false;

			if (tpl_infos.reminder_enabled) {
				tpl_infos.trad.menu.reminder = i18n.__('chat.menu.add_reminder');
			}

			return $(Mustache.render(tpl_header_messages, tpl_infos));
		},
		generate_avatar: function (friend_info, with_status, reminder, with_profile_link) {
			if (typeof friend_info === 'number' || typeof friend_info === 'string') {
				friend_info = this.friends[+friend_info];
			}
			var params = {
				src: friend_info.profile_picture,
				alt: friend_info.profile_name,
				is_user_inactive: friend_info.is_user_inactive,
				is_user_not_reviewed: friend_info.is_user_not_reviewed,
				review_not_validated: i18n.__('chat.application.not_validated'),
			};

			if (friend_info.is_creator && with_profile_link) {
				params.profile_url = friend_info.profile_url;
			}

			if (!!with_status && !!friend_info.status) {
				params.status = friend_info.status.toLowerCase();
			}

			if (!!reminder && !!reminder.remind_at) {
				params.reminder = {
					status: new Date(reminder.remind_at) > Date.now() ? 'waiting' : 'ringing',
					desc: reminder.reminder_description
				}
			}

			return Mustache.render(tpl_avatar, params);
		},
		set_header_expenses: function(infos, header_html) {
			var self = this,
				popup_header = null,
				fnResize = function() {
					if (!infos.expenses || typeof infos.expenses !== 'object') {
						return;
					}
					if (self.shouldSetExpensesPopup(infos) && window.matchMedia("(max-width: 619px)").matches && popup_header === null) {
						popup_header = self.setPopupExpenses(infos, header_html);
					}
					else {
						if (popup_header !== null && typeof popup_header === 'object') {
							popup_header = null;
						}
					}
				};

			fnResize();
			window.addEventListener('resize', fnResize);
		},
		shouldSetExpensesPopup: function(tpl_infos) {
			if (
				!!tpl_infos.expenses
				&& typeof tpl_infos.expenses === 'object'
				&& parseInt(tpl_infos.expenses.amount_total) > 0
				&& !!tpl_infos.expenses.amount_ppd
				&& !!tpl_infos.expenses.amount_subs
				&& !!tpl_infos.expenses.amount_tips
			) {
				return true;
			}
			else {
				return false;
			}
		},
		setPopupExpenses: function(tpl_infos, html) {
			var $btn = html.find('.expense__total-amount');
			if ($btn.attr('data-popup') === 'true') {
				return;
			}
			var is_header_message = html.hasClass('chat-message-header');
			var popup_expense = new popup($btn, $(Mustache.render(tpl_expense_detail, {
				'has_ppd': tpl_infos.expenses.has_ppd,
				'label_ppd': tpl_infos.expenses.text_ppd,
				'ppd': tpl_infos.expenses.amount_ppd,
				'has_subs': tpl_infos.expenses.has_subs,
				'label_subs': tpl_infos.expenses.text_subs,
				'subs': tpl_infos.expenses.amount_subs,
				'has_tips': tpl_infos.expenses.has_tips,
				'label_tips': tpl_infos.expenses.text_tips,
				'tips': tpl_infos.expenses.amount_tips,
				'header_message': is_header_message,
				'month_active': tpl_infos.expenses.subscription_months_total_active,
				'label_month_active': tpl_infos.expenses.text_month_active,
				'month_total': tpl_infos.expenses.subscription_months_total,
				'label_month_total': tpl_infos.expenses.text_month_total
			})), {
				popup_class: 'x-expenses expenses_' + tpl_infos.id_user + ' ' + (is_header_message ? 'popup_header' : 'popup_friend') +  ' ' + tpl_infos.expenses.ranking,
				position: {
					v: 'below',
					h: is_header_message ? 'right' : 'left'
				},
				autoclose_on_same_level: 'expense'
			});
			$btn.attr('data-popup','true');
			$btn.prop('popup', popup_expense);
			return popup_expense;
		},
		updatePopupExpenses: function(friend_id) {
			var expenses = this.friends[friend_id].expenses;
			var popupButtons = $('#select_friend_li_' + friend_id + ' .expense__total-amount, .expense--' + friend_id + '  .expense__total-amount');

			popupButtons.each((idx, elt) => {
				var $elt = $(elt);
				$(elt).text(expenses.amount_total);

				if (typeof elt.popup !== 'undefined') {
					elt.popup.content.find('.expense__item-ppd strong').text(expenses.amount_ppd);
					elt.popup.content.find('.expense__item-subs strong').text(expenses.amount_subs);
					elt.popup.content.find('.expense__item-tips strong').text(expenses.amount_tips);
					elt.popup.content.find('.expense__item-month-active').text(expenses.subscription_months_total_active);
					elt.popup.content.find('.expense__item-month-total').text(expenses.subscription_months_total);
				}

				var $parent = $elt.parents('.expense');

				var $detail = $parent.children('.expense__detail');
				if ($detail.length) {
					$detail.find('.expense__detail-ppd').text(expenses.amount_ppd);
					$detail.find('.expense__detail-subs').text(expenses.amount_subs);
					$detail.find('.expense__detail-tips').text(expenses.amount_tips);
				}

				var $period = $parent.children('.expense__period');
				if ($period.length) {
					$period.find('.expense__month--active strong').text(expenses.subscription_months_total_active);
					$period.find('.expense__month--total strong').text(expenses.subscription_months_total);
				}
			});

		},

		chat_friend_menu_switch_on_click: function (event) {
			event.stopPropagation();

			if (this.chat_header_messages.find("#chat_friend_menu").is(":visible")) {
				log_and_tooltip.popup_close();
			}

			this.chat_friend_menu_toggle();
		},

		chat_friend_menu_on_click_outside: function (event) {
			var target = $(event.target);
			if (target.is('#chat_friend_menu') === false && target.parents('#chat_friend_menu').length === 0) {
				this.chat_friend_menu_hide();
			}
		},

		chat_friend_menu_show: function () {
			$(document).on('click.chat_friend_menu_click_outside', this.chat_friend_menu_on_click_outside.bind(this));
			$('#chat_friend_menu').show();
			this.chat_friend_menu_is_visible = true;
			$('#chat_friend_menu').trigger(jQuery.Event('chatFriendMenuShow'));
		},

		chat_friend_menu_hide: function () {
			$(document).off('click.chat_friend_menu_click_outside');
			$('#chat_friend_menu').hide();
			this.chat_friend_menu_is_visible = false;
			$('#chat_friend_menu').trigger(jQuery.Event('chatFriendMenuHide'));
		},

		chat_friend_menu_toggle: function () {
			if (this.chat_friend_menu_is_visible) {
				this.chat_friend_menu_hide();
			} else {
				this.chat_friend_menu_show();
			}
		},

		header_message_set_warning_crypt: function() {
			var friend_infos = this.get_selected_friend_infos();
			if ( friend_infos !== false && friend_infos.hasOwnProperty("no_conversation_key_reason") && friend_infos["no_conversation_key_reason"] ) {
				$(".chat-header-warning-crypt").prop("title", friend_infos["no_conversation_key_reason"] );

				var self = this;
				$(".chat-header-warning-crypt").on( "click", function(event) {
					event.stopPropagation();
					log_and_tooltip.popup_open( $(".chat-header-warning-crypt"), "<p class='message'>" + friend_infos["no_conversation_key_reason"] + "</p>", {trigger: false});
				});
				$(".chat-header-crypt-old").hide();
			}
		},

		can_crypt: function(id_friend) {
			if (!this.priv_key) {
				return false;
			}

			var friend_infos = this.get_friend_infos(id_friend);

			var date_key = "";
			for ( var date in friend_infos["conversation_key"] ) {
				if ( friend_infos["conversation_key"][date] != null ) {
					return true;
				}
			}

			return false;
		},

		set_priv_key: function(priv_key) {
			this.priv_key = priv_key;
		},

		header_message_set_crypt_old: function() {
			var friend_infos = this.get_selected_friend_infos();
			if ( friend_infos !== false && friend_infos.hasOwnProperty("no_conversation_key_reason") && friend_infos["no_conversation_key_reason"] ) {
				return;
			}

			if ( friend_infos === false ) {
				return;
			}

			if ( !friend_infos.hasOwnProperty("crypt_old_conv_todo") && !friend_infos.hasOwnProperty("crypt_old_conv_pourcent") ) {
				return;
			}

			var self = this;

			$(".chat-header-warning-crypt").hide();
			$(".chat-header-crypt-old").show();

			if ( friend_infos["crypt_old_conv_todo"] == true ) {
				$(".chat-header-crypt-old").prop("title", i18n.__('chat.crypt_old_messages') );

				$(".chat-header-crypt-old div").on( "click", function(event) {
					event.stopPropagation();

					$("#popup_crypt_text" + self.selected_friend).remove();
					$("#header_popup_crypt_ok" + self.selected_friend).remove();
					$("#header_popup_crypt_cancel" + self.selected_friend).remove();

					var text_popup = '<p id="popup_crypt_text' + self.selected_friend + '">' + i18n.__('chat.crypt_old_messages_confirm') + "</p>";
					text_popup += '<p id="popup_crypt_buttons"><button id="header_popup_crypt_ok' + self.selected_friend + '">' + i18n.__('misc.OK') + '</button><button id="header_popup_crypt_cancel' + self.selected_friend + '">' + i18n.__('misc.cancel') + '</button></p>';

					log_and_tooltip.popup_open( $(".chat-header-crypt-old") , text_popup );

					$( "#header_popup_crypt_ok" + self.selected_friend ).on("click", function() {
						self.old_conversation_to_crypt_set( self.selected_friend );
						log_and_tooltip.popup_close();
					});
					$( "#header_popup_crypt_cancel" + self.selected_friend ).on("click", function() {
						log_and_tooltip.popup_close();
					});

				});

				var already_display = false;
				try {
					already_display_string = xv_storage.get("popup-crypt-old");
					already_display = JSON.parse(already_display_string);
				} catch (e) {
					already_display = false;
				}

				if ( !already_display ) {
					already_display = {};
				}

				if ( !already_display.hasOwnProperty( this.selected_friend ) ) {

					log_and_tooltip.popup_open( $(".chat-header-crypt-old") , "<p class='message' id='popup_crypt_old_" + this.selected_friend + "'>" + i18n.__('chat.crypt_old_messages') + "</p>" );

					$("#popup_crypt_old_" + this.selected_friend).css('cursor', 'pointer');
					$("#popup_crypt_old_" + this.selected_friend).on("click", function() {
						$("#popup_crypt_old_" + self.selected_friend).html( i18n.__('chat.crypt_old_messages_confirm') );
						$( '<p id="popup_crypt_buttons"><button id="popup_crypt_ok' + self.selected_friend + '">' + i18n.__('misc.OK') + '</button><button id="popup_crypt_cancel' + self.selected_friend + '">' + i18n.__('misc.cancel') + '</button></p>' ).insertAfter("#popup_crypt_old_" + self.selected_friend);
						$("#popup_crypt_old_" + self.selected_friend).css('cursor', 'default');
						$( "#popup_crypt_ok" + self.selected_friend ).on("click", function() {
							self.socket_connection.emit("crypt_old_conv", {	'id_friend': self.selected_friend });

							self.friends[ self.selected_friend ]["crypt_old_conv_pourcent"] = 0;
							self.friends[ self.selected_friend ]["crypt_old_conv_todo"] = false;

							self.header_message_set_crypt_old();
							log_and_tooltip.popup_close();
						});
						$( "#popup_crypt_cancel" + self.selected_friend ).on("click", function() {
							log_and_tooltip.popup_close();
						});
					});

					already_display[ this.selected_friend ] = true;

					xv_storage.set("popup-crypt-old", JSON.stringify( already_display) );
				}

				return;
			}

			var pourcent = 0;
			if (friend_infos.hasOwnProperty("crypt_old_conv_pourcent") && friend_infos["crypt_old_conv_pourcent"] ) {
				if ( friend_infos["crypt_old_conv_pourcent"] == 100 ) {
					$(".chat-header-warning-crypt").hide();
					$(".chat-header-crypt-old").hide();
					$(".chat-header-crypt-old-done").show();

					$(".chat-header-crypt-old-done").on( "click", function(event) {
						event.stopPropagation();
						log_and_tooltip.popup_open( $(".chat-header-crypt-old-done") , "<p class='message' id='popup_crypt_old_done_" + self.selected_friend + "'>" + i18n.__('chat.crypt_old_messages_done') + "</p>");
					});

					if ( typeof friend_infos["crypt_old_conv_last_pourcent"] !== "undefined" && friend_infos["crypt_old_conv_last_pourcent"] < 100 ) {
						log_and_tooltip.popup_open( $(".chat-header-crypt-old-done") , "<p class='message' id='popup_crypt_old_done_" + self.selected_friend + "'>" + i18n.__('chat.crypt_old_messages_done') + "</p>");
					}
				}
				if ( friend_infos["crypt_old_conv_pourcent"] == "error" ) {
					$(".chat-header-crypt-old").html( '<div class="chat-icon-home icon-f icf-unlock icf-2x" title="' +  i18n.__('misc.error_please_retry') + '"></div>' );
					return;
				}
				pourcent = friend_infos["crypt_old_conv_pourcent"];
			}

			var badge_text = "";
			var title = "";
			if ( pourcent == "pending" ) {
				badge_text = '<span class="chat-icon-home icon-f icf-spinner icf-anim-pulse"></span>';
				title = i18n.__('chat.crypt_old_message_pending');
			} else {
				badge_text = pourcent + "%";
				title = i18n.__('chat.crypt_old_messages_pending', {"%pourcent%": pourcent.toString()});
			}

			$(".chat-header-crypt-old").html( '<div class="chat-icon-home icon-f icf-unlock icf-2x" title="' + title + '"><span class="badge">' + badge_text + '</span></div>' );

			var self = this;
			$(".chat-header-crypt-old").on("click", function(event) {
				event.stopPropagation();
				var text_popup = '<p>' + title + '</p>';
				log_and_tooltip.popup_open( $(".chat-header-crypt-old") , text_popup);
			});

			this.friends[ this.selected_friend]["crypt_old_conv_last_pourcent"] = friend_infos["crypt_old_conv_pourcent"];
		},

		old_conversation_to_crypt_set: function( id_friend ) {

			if ( !this.hasOwnProperty("old_conversation_to_crypt") ) {
				this.old_conversation_to_crypt = [ id_friend ];
				this.old_conversation_to_crypt_launch( id_friend );
				return;
			}

			if ( this.old_conversation_to_crypt.indexOf( id_friend ) == -1 ) {
				this.old_conversation_to_crypt.push( id_friend );

				this.friends[ id_friend ]["crypt_old_conv_pourcent"] = "pending";
				this.friends[ id_friend ]["crypt_old_conv_todo"] = false;
				this.header_message_set_crypt_old();
			}
		},

		old_conversation_to_crypt_remove: function( id_friend ) {

			var index = this.old_conversation_to_crypt.indexOf( id_friend )
			if ( index == -1 ) {
				return;
			}

			this.old_conversation_to_crypt.splice( index, 1);
		},

		old_conversation_to_crypt_launch: function( id_friend ) {
			this.socket_connection.emit("crypt_old_conv", {	'id_friend': id_friend });

			this.friends[ id_friend ]["crypt_old_conv_pourcent"] = 0;
			this.friends[ id_friend ]["crypt_old_conv_todo"] = false;
			this.header_message_set_crypt_old();
		},

		old_conversation_to_crypt_launch_next: function() {
			if ( !this.hasOwnProperty("old_conversation_to_crypt") ) {
				return false;
			}
			if ( this.old_conversation_to_crypt.length == 0 ) {
				delete this.old_conversation_to_crypt;
				return;
			}

			var id_friend = this.old_conversation_to_crypt.shift();
			if ( this.get_friend_infos(id_friend) ) {
				this.old_conversation_to_crypt_launch( id_friend );
			} else {
				this.old_conversation_to_crypt_launch_next();
			}
		},

		search_friend: function() {
			this.chatInitsAndPrefs.set_timer_away();

			var search = this.search_input.val();

			wglog.debug('search_friend', search);

			if (search.length < 3) {
				var popup_options = {};
				popup_options.position = { v: 'bottom', h: 'right', trigger: false };
				log_and_tooltip.popup_open( $("#chat-window #chat-search-button"), "<p>" + i18n.__('chat.minimum_length', { '%nb_chars%': "3" }) + "</p>", popup_options );
				return;
			}

			this.search_button.attr("disabled", true);

			this.old_search = search;

			if (typeof this.cache_search[search] === 'undefined') {
				wglog.debug('search_friend request');
				this.socket_connection.emit("search_friends", { 'search': search });
			}
			else {
				wglog.debug('search_friend in cache');
				this.found_friends({
					'request_search': search,
					'friends': this.cache_search[search]
				});
			}
		},

		found_friends: function(data) {
			if (!this.cache_search[data.request_search]) {
				this.cache_search[data.request_search] = data.friends;
			}

			if (data.request_search !== this.old_search) {
				return;
			}

			wglog.debug('found_friends', data);

			$('.chat-tabs__item').each(function() {
				$(this).removeClass('active');
			});

			var listTypeAndEvents = this.getListTypeAndEvents(data.friends[0]),
				events;

            if (listTypeAndEvents) {
                events = listTypeAndEvents.events;
    			this.chatContext.emit(events.HIDE_CONTACT_LIST);
            }

			this.userlistsearch.show();
			this.userlistsearchclose.show();

			//remove users in search list
			this.clear_search();

			var search_count = i18n.__('chat.infos.no_contact_found');
			if (data.friends.length) {
				search_count = (data.friends.length === 1) ? i18n.__('chat.infos.one_contact_found') : i18n.__('chat.infos.nb_contacts_found', { "%nb_contacts%": data.friends.length.toString() });
				search_count = search_count.charAt(0).toLocaleUpperCase(config.locale) + search_count.slice(1);
			}

			this.userlistsearch.append(Mustache.render(tpl_user_search_nav, {
				return_label: i18n.__('chat.button_return_friends'),
				search_count: search_count
			}));

			this.userlistsearch.on('click', '#chat-users-search-close', this.hide_search_list.bind(this, events));

			for (var id in data.friends) {
				var friend = data.friends[id];

				if (this.friends_ids.indexOf(friend.id_user) === -1) {
					this.friends_ids.push(id);
				}
				if (!this.friends[friend.id_user]) {
					this.friends[friend.id_user] = friend;
				}

                if (events) {
				    this.chatContext.emit(events.ADD_CONTACT_FROM_SEARCH, friend);
                }
			}
		},

		clear_search: function() {
			this.userlistsearch.empty();
			this.search_button.removeAttr("disabled");
		},

		hide_search_list: function(events) {
			this.chatInitsAndPrefs.set_timer_away();
			this.userlistsearch.hide();
			this.userlistsearchclose.hide();

            if (events) {
			    this.chatContext.emit(events.SHOW_CONTACT_LIST);
            }
		},

		enable_message_form: function () {
            $('.chat-message-form').show();
            $('.chat-messages-blocked').hide();
        },
    	block_message_form: function (text) {
            text = text || ' ' + i18n.__('profile.tag.blocked_user');

            $('.chat-message-form').hide();
            $('.chat-messages-blocked').css('display', 'flex');
            $('.chat-messages-blocked p').text(text);
        },

		change_block_status: function (friend_id, status) {
			this.enable_message_form();
			$('#chat_messages_tab_' + friend_id + ' .chat_block').removeClass('show');
			this.allow_users_to_chat(this.friends[friend_id]);
			switch (status) {
				case 'blocked':
			    this.block_message_form();
					break;
				case 'blocking':
					$('#chat_messages_tab_' + friend_id + ' .chat_blocking').addClass('show');
					break;
				case 'ghosting':
					$('#chat_messages_tab_' + friend_id + ' .chat_ghosting').addClass('show');
					break;
				default:
			}
		},

		change_block_status_from_friend_id: function (friend_id) {
			if (!friend_id) {
				wglog.debug( "change_block_status_from_friend_id", 'missing friend_id');
				return;
			}

			if (!this.friends[friend_id]) {
				wglog.debug( "change_block_status_from_friend_id", 'invalid friend_id');
				return;
			}

			var friend = this.friends[friend_id];

			if (friend.is_ghosted) {
				this.change_block_status(friend.id_user, 'ghosting');
			}
			else if (friend.is_blocked) {
				this.change_block_status(friend.id_user, 'blocking');
			}
			else if (friend.blocked) {
				this.change_block_status(friend.id_user, 'blocked');
			}
			else {
				this.change_block_status(friend.id_user);
			}
		},

		blocked_by_friend: function(data) {
			if (!this.friends[data.friend_id]) {
				wglog.debug( "blocked_by_friend", 'unknown friend_id');
				return;
			}

			this.friends[data.friend_id].blocked = data.blocked;
			this.change_block_status_from_friend_id(data.friend_id);
		},

		blocking_friend: function(data) {
			if (!this.friends[data.friend_id]) {
				wglog.debug( "blocking_friend", 'unknown friend_id');
				return;
			}

			if (data.is_ghosted) {
				this.friends[data.friend_id].is_blocked = false;
				this.friends[data.friend_id].is_ghosted = true;
			}
			else if (data.is_ghosted === 0) {
				this.friends[data.friend_id].is_blocked = true;
				this.friends[data.friend_id].is_ghosted = false;
			} else {
				this.friends[data.friend_id].is_blocked = false;
				this.friends[data.friend_id].is_ghosted = false;
			}

			this.change_block_status_from_friend_id(data.friend_id);
		},

		is_typing: function(data) {
			wglog.debug("is_typing", data);

			if ( typeof data.id_friend == "undefined" || typeof this.friends[data.id_friend] == "undefined" ) {
				wglog.error("is_typing", "bad id_friend");
				return;
			}

			if (this.friends[data.id_friend].is_blocked || this.friends[data.id_friend].is_ghosted) {
				return;
			}

			if (!$("#select_friend_li_" + data.id_friend).hasClass("chat_friend_typing")) {
				$("#select_friend_li_" + data.id_friend).addClass("chat_friend_typing");
			}

			var messages_container = $("#chat_group_messages_tab_" + data.id_friend);
			if ( messages_container.length > 0 ) {
				var messages_container_html = messages_container[0];

				var scroll_down = ( Math.abs(messages_container_html.scrollHeight - messages_container_html.scrollTop - messages_container_html.clientHeight) < 10);

				$("#chat_messages_tab_" + data.id_friend + ' .chat_typing').removeClass("show").addClass("show");

				if (scroll_down) {
					scroll_conversation.down(data.id_friend);
				}
			}
		},

		stop_typing: function(data) {
			wglog.debug("stop_typing", data);

			if ( typeof data.id_friend == "undefined" || typeof this.friends[data.id_friend] == "undefined" ) {
				wglog.error("stop_typing", "bad id_friend");
				return;
			}

			if (this.friends[data.id_friend].is_blocked || this.friends[data.id_friend].is_ghosted) {
				return;
			}

			$("#select_friend_li_" + data.id_friend).removeClass("chat_friend_typing");

			$("#chat_messages_tab_" + data.id_friend + " .chat_typing").removeClass("show");

		},

		update_last_message_marker: function (friend_id, timestamp) {
			var $tab = $("#chat_group_messages_tab_" + friend_id);

			if (!$tab.length) {
				return;
			}

			$tab.find('.chat-messages__first-unread-message-marker').remove();

			var $first_unread_msg;

			if (timestamp && typeof timestamp === "number") {
				$first_unread_msg = $tab.find('.chat-message__read-status input')
					.filter(function (index) {
						return Number.parseInt(this.dataset.timestamp) > timestamp;
					})
					.first()
					.parents('.chat-message__id');
			} else {
				$first_unread_msg = $tab.find('.chat-message__read-status input')
					.not(':checked')
					.first()
					.parents('.chat-message__id');
			}

			if (!$first_unread_msg.length) {
				return;
			}

			if ($first_unread_msg.is(':first-child')) {
				$first_unread_msg.parents('.chat-message').before('<li class="chat-messages__first-unread-message-marker"><span>' + i18n.__('chat.infos.unread_messages') + '</span></li>');
			} else {
				$first_unread_msg.before('<div class="chat-messages__first-unread-message-marker"><span>' + i18n.__('chat.infos.unread_messages') + '</span></div>');
			}
			this.reset_last_tip_intersection_observer(friend_id);
		},

		setup_last_tip_intersection_observer: function () {
			if (!window.IntersectionObserver) {
				return;
			}

			this.last_tip_intersection_observer_targets = {};
			this.last_tip_intersection_observer = new IntersectionObserver(this.last_tip_intersection_observer_cb.bind(this), {
				root: $('.chat-messages').get(0),
				threshold: 1
			});
		},

		last_tip_intersection_observer_cb: function (entries) {
			var self = this;

			entries.forEach(function (entry) {
				if (entry.isIntersecting) {
					var tab_container = entry.target.closest('.chat-tab-container');
					if (!tab_container) {
						return;
					}
					var friend_id = +tab_container.id.replace('chat_messages_tab_', ''),
						timestamp = +entry.target.dataset.timestamp || Date.now();

					self.delete_last_tip_intersection_observer_target(friend_id);

					self.setMultipleContactAttributes(friend_id, [
						{ name: 'tip_amount', value: false }
					]);
					// self.friends[friend_id].tip_amount = false;

					var contact = self.friends[friend_id];
					if (!contact) {
						return;
					}
					var events = self.chat_friend_manager.getListTypeAndEvents(contact).events;
					this.chatContext.emit(events.UPDATE_LIST, false, 'update');
					/*
					self.update_friend_meta(friend_id);
					self.update_friend_sort_score(friend_id);
					self.update_friend_position(friend_id);
					*/
					self.set_read_date_fct(friend_id, timestamp, self.friends[friend_id].nb_unread);
				}
			});
		},

		delete_last_tip_intersection_observer_target: function (friend_id) {
			if (this.last_tip_intersection_observer_targets[friend_id]) {
				this.last_tip_intersection_observer.unobserve(this.last_tip_intersection_observer_targets[friend_id]);
				delete this.last_tip_intersection_observer_targets[friend_id];
			}
		},

		reset_last_tip_intersection_observer: function (friend_id) {
			this.delete_last_tip_intersection_observer_target(friend_id);

			var availableTargets = document.querySelectorAll(`#chat_messages_tab_${friend_id} .chat-message--tip`),
				target = availableTargets.length ? availableTargets[availableTargets.length - 1] : undefined;

			if (!target) {
				return;
			}

			this.last_tip_intersection_observer.observe(target);
			this.last_tip_intersection_observer_targets[friend_id] = target;
		},

		get_conversation_keys: function(recipient_id) {
			var friend_infos = this.get_friend_infos(recipient_id);
			var keys = [];

			if (friend_infos.conversation_key && Object.getPrototypeOf(friend_infos.conversation_key) == Object.prototype) {
				keys = Object.values(friend_infos.conversation_key);
			}

			return keys;
		},

		decrypt_conv_keys: function(data) {
			var friend_info = this.get_friend_infos(data.recipient_id);

			if (friend_info.is_support) {
				return;
			}
			if ((typeof data.key === "undefined" || !data.key) && friend_info.disable_encryption) {
				wglog.debug("decrypt_conv_keys: ", "encryption disabled, no conv keys");
				return;
			}

			delete this.friends[data.recipient_id]["no_conversation_key_reason"];

			if ( typeof data.key == "undefined" || data.key == "undefined" ) {
				var message_no_key = "";
				if ( typeof data.no_key == "undefined" || data.no_key == "undefined" ) {
					message_no_key = i18n.__('chat.unable_crypt_friend', { '%reason%': i18n.__('error.internal_err_please_reload') });
					wglog.debug('no_private_key "undefined"');
				} else {
					if ( data.no_key == "user" ) {
						log_and_tooltip.write_message_no_private_key();
						wglog.error('no_private_key "user"');
					} else if ( data.no_key == "friend" ) {
						message_no_key = i18n.__('chat.unable_crypt_friend', { '%reason%': i18n.__('chat.unable_crypt_friend_friend_key', { "%website_domain_name%": config.i18n_website_domain_name }) });
						wglog.error('no_private_key "friend"');
					} else if ( data.no_key == "create_failed" ) {
						message_no_key = i18n.__('chat.unable_crypt_friend', { '%reason%': i18n.__('error.internal_err_please_reload') });
						wglog.error('no_private_key "create_failed"');
					}
				}

				this.friends[data.recipient_id]["no_conversation_key_reason"] = message_no_key;
				this.header_message_set_warning_crypt();

			} else {
				if (friend_info !== false) {
					var keys = this.decrypt_conv_key(data.key);

					this.friends[data.recipient_id]["conversation_key"] = keys;

					var most_recent_key = null;
					var last_timestamp = 0;
					for (var i in keys) {
						if ( i > last_timestamp && keys[i] != null ) {
							last_timestamp = i;
							most_recent_key = keys[i];
						}
					}

					if ( last_timestamp != 0) {
						// wait 1 week before asking a conv key again
						// ask a conv key we can't decode with this user to his friend
						var timestamp_retry_ask = Math.round((new Date()).getTime() / 1000) - ( 60*60*24*7 );
						for (var i in keys) {
							if ( i !== last_timestamp && keys[i] == null && data.key[i] !== "null" && ( ( parseInt(data.key[i]) != data.key[i] ) || data.key[i] < timestamp_retry_ask ) ) {
								this.socket_connection.emit("internal_message", {
									"hexavid_login": cookies.get( config.cookie_name ),
									"id_friend": data.recipient_id,
									"action": "ask_conv_key",
									"params": {
										"message": this.make_real_message_fct( JSON.stringify( { "action":"ask_conv_key", "timestamp": i } ), data.recipient_id ),
										"timestamp_key": i
									}
								});
							}
						}
					}

					if ( most_recent_key == null || most_recent_key == false ) {

						wglog.error("data key", data.key);
						wglog.error("no key found", keys);
						wglog.error("private key", "private key: " + this.priv_key.substring(0, 50) + " ... " + this.priv_key.substring( this.priv_key.length - 50) );

						// no conv key after the create_date of keys ?
						if ( typeof this.keys_create_timestamp !== "undefined" ) {
							var conv_key_found = false;
							var conv_key_found_timestamp;

							for (var i in keys) {
								if ( i > this.keys_create_timestamp ) {
									conv_key_found = true;
									conv_key_found_timestamp = i;
									break;
								}
							}

							if ( !conv_key_found ) {
								wglog.error("no conv key found after the priv/pub keys create_date", keys);

								if ( friend_info !== false && ( typeof friend_info['new_conv_key_asked'] == "undefined"
									|| friend_info['new_conv_key_asked'] !== true) ) {

									this.friends[data.recipient_id]['new_conv_key_asked'] = true;
									this.socket_connection.emit("get_conv_key", {"id_friend": data.recipient_id});
								}

							} else {
								wglog.error("conv_key not decryptable : ", data.key[conv_key_found_timestamp] );
								this.socket_connection.emit("create_new_conv_key", {"id_friend": data.recipient_id});
							}
						}

						this.friends[data.recipient_id]["no_conversation_key_reason"] = i18n.__('chat.unable_crypt_friend', { '%reason%': i18n.__('error.internal_err_please_reload') });
						if ( data.recipient_id == this.selected_friend ) {
							this.header_message_set_warning_crypt();
						}

					} else {
						//check if all message with this friends are crypted
						this.friends[data.recipient_id].all_conv_crypted = false;
						if ( typeof data.all_conv_crypted != "undefined" && data.all_conv_crypted) {
							this.friends[data.recipient_id ].all_conv_crypted = true;
							this.friends[ data.recipient_id ]["crypt_old_conv_pourcent"] = 100;
						} else {
							//display a link for crypting all messages
							this.friends[ data.recipient_id ]["crypt_old_conv_todo"] = true;
							this.old_conversation_to_crypt_set( data.recipient_id );
						}
						if ( data.recipient_id == this.selected_friend ) {
							this.header_message_set_crypt_old();
						}
					}
				}
			}
		},

		new_conversation_key: function(data) {
			wglog.debug("new_conversation_key", data);
			if ( typeof data.recipient_id == "undefined" || (typeof data.new_key == "undefined" && typeof data.refresh_conv == "undefined" ) ) {
				wglog.error("new_conversation_key", "missing param");
				return;
			}

			var friend_infos = this.get_friend_infos(data.recipient_id);
			if ( friend_infos === false ) {
				wglog.debug("new_conversation_key", "no infos for friend " + data.recipient_id);
				return;
			}

			if ( typeof data.refresh_conv != "undefined" && data.refresh_conv ) {
				$("#chat_group_messages_tab_" + data.recipient_id).empty();
				this.get_conversation_fct(data.recipient_id);

			} else {
				this.friends[data.recipient_id]["conversation_key"] = this.decrypt_conv_key(data.new_key);
			}

		},

		decrypt_conv_key: function(key) {
			// decrypt key
			var decrypt = new jsencrypt.JSEncrypt();
			decrypt.setPrivateKey( this.priv_key );

			var decrypted = {};

			for ( var date in key ) {
				decrypted[date] = decrypt.decrypt( key[date] );
			}

			return decrypted;
		},

		crypt_old_conversation: function(data) {
			wglog.debug("crypt_old_conversation", data);

			if ( typeof data.conversation !== "undefined" && data.conversation == false ) {
				if ( typeof data.id_friend != "undefined" ) {
					this.friends[ data.id_friend ]["crypt_old_conv_pourcent"] = 100;
					this.header_message_set_crypt_old();

					this.old_conversation_to_crypt_remove( data.id_friend );
					this.old_conversation_to_crypt_launch_next();
				}
				wglog.debug("crypt_old_conversation all crypted :)");
				return
			}

			var friend_infos = this.get_friend_infos(data.id_friend);
			if ( typeof data.conversation == "undefined" || !data.conversation || data.conversation == "ERROR" || typeof data.id_friend == "undefined" || friend_infos === false ) {
				if ( typeof data.id_friend != "undefined" ) {
					this.friends[ data.id_friend ]["crypt_old_conv_pourcent"] = "error";
					this.header_message_set_crypt_old();
				}
				wglog.debug("crypt_old_conversation ERROR");
				return;
			}

			if ( typeof data.conversation.nb_conv !== "undefined" && typeof data.conversation.nb_conv_crypted !== "undefined" ) {
				var pourcent = Math.floor(( parseInt(data.conversation.nb_conv_crypted) / parseInt(data.conversation.nb_conv) )*100);
				wglog.debug("crypt previous messages : " + pourcent + "%" );
				this.friends[ data.id_friend ]["crypt_old_conv_pourcent"] = pourcent;
				this.header_message_set_crypt_old();
			}

			var message;
			if ( typeof data.conversation.index !== "undefined" && typeof data.conversation.messages !== "undefined" ) {
				for (var i in data.conversation.messages) {
					message = data.conversation.messages[i].m;
					// don't crypt the message twice
					if ( message.length < 3 || message.substring(0, 2) != "c-" && message.substring(0, 2) != "x-" ) {
						data.conversation.messages[i].m = this.make_real_message_fct( message, data.id_friend);
					}
				}
			}

			this.socket_connection.emit("crypt_old_conv", {	'id_friend': data.id_friend, 'crypted_conv': JSON.stringify(data.conversation) });

		},

		allow_users_to_chat: function (friend_info, force_disable) {
			if (this.disabled_send_btn) {
				return;
			}
			force_disable = !!force_disable;
			if (typeof friend_info === 'undefined' || friend_info === null) {
				friend_info = {};
				friend_info.blocked = force_disable;
			}

			var unfollowWithConv = (!config.login_info.is_creator && !config.login_info.is_support && !friend_info.is_followed && !friend_info.is_paid_user),
				disabled = force_disable
					|| friend_info.blocked
					|| friend_info.is_inactive
					|| unfollowWithConv;

			if (!friend_info.is_support && disabled) {
        		var textBtn = !config.login_info.is_support ? 'chat.unable_message_send' : '';
				this.setMessageFormState(!config.login_info.is_support, textBtn);
				if (friend_info.is_inactive) {
					this.add_user_deactivated_to_chat_message(friend_info.is_creator);
					if (friend_info.is_creator) {
						this.remove_link_header_conversation();
					}
				}
				if (unfollowWithConv) {
					this.add_unfollow_not_paid_message(friend_info);
				}
			}
			else {
				chat_window_message.clear();
				this.setMessageFormState();
				$('.chat-message-form__action--attachment').show();
			}
		},

		remove_link_header_conversation: function() {
			var $avatarWrapper = document.querySelector('.chat-message-header__avatar'),
				$nameWrapper = document.querySelector('.chat-message-header__name-wrapper');

			if (!$avatarWrapper.querySelector('a') || !$nameWrapper.querySelector('a')) {
				return;
			}

			var name = document.querySelector('.chat-message-header__name').innerText,
				$avatar = $avatarWrapper.querySelector('img');

			$avatarWrapper.querySelector('a').remove();
			$nameWrapper.querySelector('a').remove();

			$avatarWrapper.querySelector('.chat-avatar').append($avatar);
			$nameWrapper.innerText = name;
		},

		setMessageFormState: function (isDisabled, textBtn) {
			isDisabled = !!isDisabled;
			$('.chat-message-form')[isDisabled ? 'addClass' : 'removeClass']('chat-message-form--disabled');
			this.input.prop('disabled', isDisabled);
			if ($.fn.emojioneArea) {
				this.input[0].emojioneArea[(isDisabled ? 'disable' : 'enable')]();
			}

			if (!isDisabled || !textBtn) {
				textBtn = 'chat.message_send';
			}

			var sendButtonDisabledClasses = 'disabled';
			/*if (textBtn === 'chat.error.please_wait') {
				sendButtonDisabledClasses += ' loader';
			}*/

			this.send_button.prop('disabled', isDisabled);
			this.send_button[(isDisabled ? 'addClass' : 'removeClass')](sendButtonDisabledClasses);
			this.send_button.find('span').text(i18n.__(textBtn));

			$('.chat-message-form__action--tip').prop('disabled', isDisabled);
			$('.chat-message-form__action--attachment').prop('disabled', isDisabled);
			$('.chat-message-form__action--order-custom-content').prop('disabled', isDisabled);
		},

		add_tip_to_chat_message: function (friend_info) {
			if (!friend_info) {
				friend_info = this.friends[this.selected_friend];
			}

			if (friend_info.tip_url && this.selected_friend == friend_info.id_user) {
				var message = i18n.__('chat.tip_to_chat_with_this_user', {"%username%": friend_info.profile_name});

				message = '<button ' +
					'href="' + friend_info.profile_url + '" ' +
					'class="chat-alert__button--link js-create-tips" ' +
					'data-action="' + friend_info.tip_url + '" ' +
					'data-name="' + friend_info.profile_name + '" ' +
					'data-headshot="' + friend_info.profile_picture + '" ' +
					'data-poster="' + friend_info.poster_url + '" ' +
					'data-alias="' + friend_info.alias + '"' +
					'>' + message + '</button>';

				chat_window_message.add(message);
			}
		},

		add_user_deactivated_to_chat_message: function (isCreator) {
			var self = this;
			chat_window_message.add(i18n.__('chat.infos.contact_deactivated', {
				'%userType%' : i18n.__('misc.' + (isCreator ? 'creator': 'user'))
			}), {
				message_type: 'hidden-user',
				action_label: i18n.__('chat.menu.hide_user'),
				action_icon: 'icf-eye-slashed',
				action: function () {
					self.chat_friend_action.hide_user(self.selected_friend);
				}
			});
			if (!config.login_info.is_support) {
				$('.chat-message-form').remove();
			}
		},

		add_unfollow_not_paid_message: function(friend_info) {
			var self = this;
			chat_window_message.add(i18n.__('chat.infos.creator_unfollow_not_paid'), {
				message_type: 'hidden-user',
				action_label: i18n.__('follow'),
				action: function () {
					self.chat_friend_action.follow_creator(friend_info);
				}
			});
			this.setMessageFormState(true, 'chat.unable_message_send');
		},

		creator_followed: function() {
			this.setMessageFormState(false);
			var messages = chat_window_message.getAll();

			for (var index in messages) {
				if (messages[index].options.message_type === 'hidden-user') {
					chat_window_message.delete(+index);
				}
			}
		},

		manage_user_creator_account_managed: function(addMessage) {
			var messages = chat_window_message.getAll(),
				indexManagerMessage = false;

			for (var index in messages) {
				if (messages[index].options.message_type === 'manager') {
					indexManagerMessage = parseInt(index);
				}
			}

			if (addMessage && indexManagerMessage === false) {
				chat_window_message.add(i18n.__('chat.handled_by_manager', {
					'%creator%': this.get_selected_friend_infos().profile_name
				}), { message_type: 'manager' });
			}

			if (!addMessage && indexManagerMessage !== false) {
				chat_window_message.delete(indexManagerMessage);
			}
		},

		uploader_unavalaible: function() {
			var messages = chat_window_message.getAll(),
				indexUploaderMessage = false;

			for (var index in messages) {
				if (messages[index].options.message_type === 'uploader') {
					indexUploaderMessage = parseInt(index);
				}
			}

			if (indexUploaderMessage === false) {
				chat_window_message.add(i18n.__('chat.unavailable_uploader'), {
					message_type: 'uploader',
					action_label: i18n.__('misc.refresh_this_page'),
					action: function () {
						location.reload();
					}
				});
			}

			$('.chat-message-form__action--attachment').replaceWith('<div><div>');
		},

		observeTabListResize: function (ul) {
			if (!window.ResizeObserver) {
				return;
			}

			ul.scrollIgnore = false;
			ul.scrollBottom = ul.scrollTop + ul.clientHeight;
			ul.addEventListener('scroll', ({ target: t }) => {
				if (t.scrollIgnore) return;
				t.scrollBottom = t.scrollTop + t.clientHeight;
			});

			if (!this.lists_resize_observer) {
				this.lists_resize_observer = new ResizeObserver((entries) => {
					entries.forEach(({ target: t }) => {
						if (getComputedStyle(t).display === "none") return;

						t.scrollIgnore = true;
						t.scrollTop += t.scrollBottom - (t.scrollTop + t.clientHeight);

						clearTimeout(t.scrollTimeoutId);
						t.scrollTimeoutId = setTimeout(() => {
							t.scrollIgnore = false;
						}, 50);
					});
				});
			}
			this.lists_resize_observer.observe(ul);
		},

		get_attachment_visible_services: function (friend_info) {
			// Sheer creator to box & sheer fans only
			if (
				config.login_info.is_creator
				&& !friend_info.is_support
				&& !friend_info.is_creator
			) {
				return ['local', 'content', 'vault'];
			} else {
				return ['local'];
			}
		},

		update_conversation_header: function (friend_id) {
			if (this.selected_friend !== friend_id) {
				return;
			}

			this.header_messages_html(friend_id);
		},
		remove_friend: function (friend_id) {
			if (this.selected_friend == friend_id) {
				this.close_conversation();
			}

			if (!friend_id) {
				wglog.error('remove_friend', "friend_id missing");
				return;
			}

			var contactHtml = $("#select_friend_li_" + friend_id);
			if (contactHtml.length) {
				contactHtml.remove();
			}

			if (this.friends[friend_id]) {
				delete this.friends[friend_id];
			}

			var index = this.friends_ids.indexOf(friend_id);
			if (index > -1) {
				this.friends_ids.splice(index, 1);
			}
		},
		close_conversation: function () {
			this.close_conversation_without_selected_friend()
			this.unselect_friend();
		},
		close_conversation_without_selected_friend: function () {
			$(".chat-window__message").empty();
			$('.chat-window').addClass('chat-window--home');
			$('.x-popup.popup_header').remove();
			document.location.hash = '';
			xv_storage.set('id_last_conversation', 0);
		},

		hasSwitchListButton: function(id_user) {
			var friend_infos = this.get_friend_infos(id_user);
			return !!friend_infos.switch_list;
		},
		setSwitchContactListBtn: function(id_user) {
			var $btn = $('.chat-message-header-switch-contact');
			if ($btn.length === 0) {
				return;
			}

			var isCustomer = this.customers_ids.indexOf(id_user) > -1,
				isFollower = this.followers_ids.indexOf(id_user) > -1;

			if (!isCustomer && !isFollower) {
				return;
			}

			var state = !isCustomer ? 'add' : 'remove';

			id_user = +id_user;
			$btn.off('click');
			$btn.find('.chat-friend-menu__text').text(i18n.__('chat.move_to', {'%dest%': state === 'add' ? i18n.__('chat.friends_costumers') : i18n.__('chat.followers_tab')}));

			var self = this;
			$btn.on('click', function() {
				var event = state === 'add' ? FollowerListEvent.ADD_CONTACT_TO_CUSTOMER_LIST : CustomerListEvent.REMOVE_CONTACT_FROM_CUSTOMER_LIST;
				self.chatContext.emit(event, id_user);
			});
		},

		add_or_update_friend: function (friend_info, updateListByBulk, updateUnread) {
			if (!friend_info || !friend_info.id_user) {
				wglog.error('add_or_update_friend', "friend_info missing");
				return;
			}

			updateListByBulk = !!updateListByBulk;
			updateUnread = !updateUnread && updateUnread !== false;

			var contactId = friend_info.id_user,
				listTypeAndEvents = this.getListTypeAndEvents(friend_info),
				events = listTypeAndEvents.events;

			if (!this.chatContext.manager.contactLists[listTypeAndEvents.type].mediator.getContactIndex(contactId)) {
				this.chatContext.emit(events.ADD_CONTACT, friend_info, null, updateListByBulk);
			}
			else {
				if (friend_info.is_support) {
					this.set_friend_attribut(contactId, 'status', 'Offline');
				}

				for (var key in friend_info) {
					this.set_friend_attribut(contactId, key, friend_info[key], updateUnread);
				}

				this.chatContext.emit(events.UPDATE_LIST);
			}
		},
		update_friend: function (friend_info) {
			if (typeof friend_info === 'number') {
				friend_info = this.get_friend_infos(friend_info);
			}

			var friend_id = friend_info.id_user;

			this.setMultipleContactAttributes(friend_id, [
				{ name: 'status', value: friend_info.status },
				{ name: 'is_blocked', value: friend_info.is_blocked },
				{ name: 'is_ghosted', value: friend_info.is_ghosted },
				{ name: 'interaction_off_limit', value: this.is_interaction_off_limit(this.friends[friend_id].interaction) },
			]);
			this.update_conversation_header(friend_id);

			if (this.selected_friend === friend_id) {
				this.allow_users_to_chat(friend_info);
			}

			var listTypeAndEvents = this.getListTypeAndEvents(friend_info),
				events = listTypeAndEvents.events;

			this.chatContext.emit(events.UPDATE_LIST, false, 'update');

			//this.chatContext.emit(FriendManagerEvent.FRIEND_UPDATED, $("#select_friend_li_" + friend_id).get(0), friend_info);
		},
		close_conversation_without_selected_friend: function () {
			$(".chat-window__message").empty();
			$('.chat-window').addClass('chat-window--home');
			$('.x-popup.popup_header').remove();
			document.location.hash = '';
			xv_storage.set('id_last_conversation', 0);
		},
		reset: function() {
			this.close_conversation();
			delete this.last_friend_conv;

			$('#chat-support-toggler-button.active').click();

			this.friends = {};
			this.friends_ids = [];
			this.support_ids = [];

			$('.chat-messages').children().remove();

			this.clearContactList();
		},
		clearContactList: function() {
			if (config.login_info.is_creator) {
				this.chatContext.emit(CustomerListEvent.CLEAR_CONTACT_LIST);
				this.chatContext.emit(FollowerListEvent.CLEAR_CONTACT_LIST);
			} else {
				this.chatContext.emit(ContactListEvent.CLEAR_CONTACT_LIST);
			}
		},
		is_interaction_off_limit: function (interaction) {
			if (typeof interaction == 'undefined') {
				return false;
			}

			var date = new Date();
			// limit for interaction is 7 days
			date.setDate(date.getDate() - 7);
			date.setHours(0, 0, 0, 0);

			return interaction < (date.getTime() / 1000);
		},
		friend_status_changed: function(data) {
			wglog.debug( "friend_status_changed", data);

			if (!this.friends[data.id_user]) {
				return;
			}

			this.friends[data.id_user].status = data.status;

			this.add_or_update_friend(this.friends[data.id_user], false, false);

			if ( data.status != "Online" ) {
				this.stop_typing({"id_friend": data.id_user});
			}
		},

		prepareExpenses: function(friend_id, expenses) {
			var existent = this.friends[friend_id].expenses;

			if (typeof expenses === "undefined") {
				expenses = existent;
			}

			if (typeof existent === 'object') {
				if (typeof existent.currency === 'undefined') {
					existent.currency = 'USD';
				}

				if (typeof existent.text_ppd === 'undefined') {
					existent.text_ppd = i18n.__('chat.label_ppc');
					existent.text_subs = i18n.__('chat.label_subs');
					existent.text_tips = i18n.__('chat.label_tips');
					existent.total_text = i18n.__('chat.spent');
					existent.text_month_active = i18n.__('chat.months_sub');
					existent.text_month_total = i18n.__('chat.months_total');
				}

				existent.has_ppd = !!parseInt(expenses.amount_ppd);
				existent.has_subs = !!parseInt(expenses.amount_subs);
				existent.has_tips = !!parseInt(expenses.amount_tips);
				existent.has_total = !!parseInt(expenses.amount_total);

				if (existent.has_ppd) {
					existent.amount_ppd = this.formatFloat(existent.amount_ppd, existent.currency);
				}

				if (existent.has_subs) {
					existent.amount_subs = this.formatFloat(existent.amount_subs, existent.currency);
				}

				if (existent.has_tips) {
					existent.amount_tips = this.formatFloat(existent.amount_tips, existent.currency);
				}

				if (existent.has_total) {
					existent.amount_total = this.formatFloat(existent.amount_total, existent.currency);
				}
			}
			else {
				existent = {
					amount_total: existent,
					currency: 'USD'
				};
				existent.amount_total = this.formatFloat(existent.amount_total, existent.currency);
			}

			this.friends[friend_id].expenses = existent;
		},
		generate_avatar_html: function (params) {
			return Mustache.render(tpl_avatar, params);
		}
	};

	return friends_manager;

});

Date.prototype.toDatetimeString = function() {
	return this.getFullYear() +
		'-' + (this.getMonth() + 1).toString().padStart(2, 0) +
		'-' + (this.getDate()).toString().padStart(2, 0) +
		'T' + (this.getHours()).toString().padStart(2, 0) +
		':' + (this.getMinutes()).toString().padStart(2, 0);
};

define('chat_friend_action',[
	'config/chat',
	'./log_and_tooltip',
	'lib/tools',
	'lib/cookies',
	'lib/i18n!front',
	'lib/utils',
	'lib/helpers/inline_loader',
	'features/ContactList/events/ContactListEvent',
	'features/ContactList/CustomerList/events/CustomerListEvent',
	'features/ContactList/FollowerList/events/FollowerListEvent',
], function(
	config,
	log_and_tooltip,
	tools,
	cookies,
	i18n,
	utils,
	inline_loader,
	ContactListEvent,
	CustomerListEvent,
	FollowerListEvent
) {
	
	var chat_friend_action = function(chatInitsAndPrefs, url_base_profile, chat_icon_home, msglist, get_conversation_fct, getContactListTypeAndEventsFct, chatContext) {
		this.nb_friend_request_sent = 0;
		this.nb_friend_request_sent_display = 0;

		this.chatInitsAndPrefs = chatInitsAndPrefs;
		this.url_base_profile = url_base_profile;
		this.url_friends_requests = "/account/friends/requests";
		this.chat_icon_home = chat_icon_home;
		this.msglist = msglist;
		this.get_conversation_fct = get_conversation_fct;
		this.getListTypeAndEvents = getContactListTypeAndEventsFct;
		this.report_reasons = ['spammer', 'underage', 'child_pornography', 'other'];
		this.chatContext = chatContext;
	};
	
	chat_friend_action.prototype = {

		set_user_infos: function(user_id, profile_name) {
			this.user_id = user_id;
			this.profile_name = profile_name;
		},
		
		set_socket_connection: function( socket_connection ) {
			this.socket_connection = socket_connection;
		},
		
		set_chat_friend_manager: function(chat_friend_manager) {
			this.chat_friend_manager = chat_friend_manager;
		},
		
		friend_requests_html: function( data ) {
			if ( typeof data.nb_friend_request !== "undefined" && parseInt( data.nb_friend_request ) > 0 ) {
				$("#chat-home-friend-request").html( i18n.__('chat.infos.nb_friends_requests_received', { '%nb_friend_request%': data.nb_friend_request.toString(), '%start_link%': '<a href="' + this.url_friends_requests + '" target="_blank" rel="noopener noreferrer">', '%end_link%': '</a>' }) );
				this.set_badge_friend_request(data.nb_friend_request);
				
				var self = this;
				if ( typeof data.last_friend_request !== "undefined" && data.last_friend_request.length > 0 ) {
					var friend_requests = '<p>' + i18n.__('chat.infos.last_friends_requests') + '</p><ul id="chat-friend-requests">';
					
					data.last_friend_request.sort(function (a, b) {
						
						if (typeof a.ts == "undefined" && typeof b.ts == "undefined" ) {
							return 0;
						}
						if (typeof a.ts == "undefined" ) {
							return 1;
						}
						if (typeof b.ts == "undefined" ) {
							return -1;
						}
						
						if (a.ts > b.ts ) {
							return -1;
						}
						if (a.ts < b.ts ) {
							return 1;
						}
						return 0;
					});
					
					for (var f in data.last_friend_request) {
						friend_requests += this.friend_requests_li_html( data.last_friend_request[f] );
					}
					
					friend_requests += '</ul>';
					
					$("#chat-home-last-friend-request").html(friend_requests);
					
					for (var f in data.last_friend_request) {
						$("#chat-friend-request-" + data.last_friend_request[f]['id_friend'] + "-link").on('click', function(event) { event.stopPropagation();self.friend_request_accept(this); } );
						$("#chat-friend-request-" + data.last_friend_request[f]['id_friend'] + "-link-refuse").on('click', function(event) { event.stopPropagation();self.friend_request_refuse(this); } );
					}
					
				}
			} else {
				$("#chat-home-friend-request").html( i18n.__('chat.infos.no_friends_requests') );
			}
			
			if ( typeof data.nb_friend_request_sent !== "undefined" && parseInt( data.nb_friend_request_sent ) > 0 ) {
				$("#chat-home-friend-request-sent").html( i18n.__('chat.infos.nb_friends_requests_sent', { '%nb_friend_request_sent%': data.nb_friend_request_sent.toString() }) );
				this.set_badge_friend_request_sent(data.nb_friend_request_sent);
				
				this.nb_friend_request_sent = 0;
				this.nb_friend_request_sent_display = 0;
				
				var self = this;
				if ( typeof data.last_friend_request_sent !== "undefined" && data.last_friend_request_sent.length > 0 ) {
					var friend_requests = '<p>' + i18n.__('chat.infos.last_friends_requests_sent') + '</p><ul id="chat-friend-requests-sent">';
					
					data.last_friend_request_sent.sort(function (a, b) {
						
						if (typeof a.ts == "undefined" && typeof b.ts == "undefined" ) {
							return 0;
						}
						if (typeof a.ts == "undefined" ) {
							return 1;
						}
						if (typeof b.ts == "undefined" ) {
							return -1;
						}
						
						if (a.ts > b.ts ) {
							return -1;
						}
						if (a.ts < b.ts ) {
							return 1;
						}
						return 0;
					});
					
					for (var f in data.last_friend_request_sent) {
						friend_requests += this.friend_requests_li_html( data.last_friend_request_sent[f], true );
					}
					
					friend_requests += '</ul>';
					
					$("#chat-home-last-friend-request-sent").html(friend_requests);
					
					for (var f in data.last_friend_request_sent) {
						$("#chat-friend-request-" + data.last_friend_request_sent[f]['id_friend'] + "-link-cancel").on('click', function(event) { event.stopPropagation();self.friend_request_sent_cancel(this); } );
					}
					
					this.nb_friend_request_sent = parseInt(data.nb_friend_request_sent);
					this.nb_friend_request_sent_display = $("#chat-friend-requests-sent li").length;
					
				}
			} else {
				$("#chat-home-friend-request-sent").html( i18n.__('chat.infos.no_friends_requests_sent') );
			}
			
			$("#chat-home-tabs").show();
			$("#chat-home-tabs-news .chat-home-tabs-icon").on("click", function() {
				$("#chat-home-tabs li").removeClass("chat-selected");
				$("#chat-home-tabs-news").addClass("chat-selected");
				$(".chat-home-tab-container").removeClass("chat-selected");
				$("#chat-home-tab-container-home").addClass("chat-selected");
			});
			
			$("#chat-home-tabs-requests").css("display", "inline-block");
			$("#chat-home-tabs-requests .chat-home-tabs-icon").on("click", function() {
				$("#chat-home-tabs li").removeClass("chat-selected");
				$("#chat-home-tabs-requests").addClass("chat-selected");
				$(".chat-home-tab-container").removeClass("chat-selected");
				$("#chat-home-tab-container-requests").addClass("chat-selected");
			});
			
			$("#chat-home-tabs-requests-sent").css("display", "inline-block");
			$("#chat-home-tabs-requests-sent .chat-home-tabs-icon").on("click", function() {
				$("#chat-home-tabs li").removeClass("chat-selected");
				$("#chat-home-tabs-requests-sent").addClass("chat-selected");
				$(".chat-home-tab-container").removeClass("chat-selected");
				$("#chat-home-tab-container-requests-sent").addClass("chat-selected");
			});
			
		},
		
		set_badge_friend_request: function( nb_requests ) {
			
			if ( nb_requests == 0 || nb_requests != parseInt( nb_requests ) ) {
				this.chat_icon_home.find("span.badge").remove();
				$("#chat-home-tabs-requests span.icon-f span.badge").remove();
				return;
			}
			
			this.chat_icon_home.html('<span class="badge">' + parseInt( nb_requests ) + '</span>');
			$("#chat-home-tabs-requests span.icon-f").html('<span class="badge">' + parseInt( nb_requests ) + '</span>');
			
		},
		
		set_badge_friend_request_sent: function( nb_requests ) {
			if ( nb_requests == 0 || nb_requests != parseInt( nb_requests ) ) {
				$("#chat-home-tabs-requests-sent span.icon-f span.badge").remove();
				return;
			}
			$("#chat-home-tabs-requests-sent span.icon-f").html('<span class="badge">' + parseInt( nb_requests ) + '</span>');
		},
		
		friend_requests_li_html: function(data, sent) {
			
			var friend_request = '<li id="chat-friend-request-' + data['id_friend'] + '">';
			friend_request += '<div class="chat-friend-request-image"><a href="' + this.url_base_profile + data['profile_name'] + '" title="' + i18n.__('profile.title_link_page') + '" target="_blank" rel="noopener noreferrer"><img src="' + data['profile_picture'] + '" /></a></div>';
			if (!sent ) {
				friend_request += '<div class="chat-friend-request-button"><span id="chat-friend-request-' + data['id_friend'] + '-link-refuse" title="' + i18n.__('misc.refuse') + '" class="icon-f icf-close-circle"></span></div>';
				friend_request += '<div class="chat-friend-request-button"><span id="chat-friend-request-' + data['id_friend'] + '-link" title="' + i18n.__('misc.accept') + '" class="icon-f icf-check-circle"></span></div>';
			} else {
				friend_request += '<div class="chat-friend-request-button"><span id="chat-friend-request-' + data['id_friend'] + '-link-cancel" title="' + i18n.__('misc.cancel') + '" class="icon-f icf-close-circle"></span></div>';
			}
			var display_ago = '';
			if (typeof data.ts == "number") {
				display_ago= " (" + tools.formatDuration( ((new Date()).getTime() / 1000) - data.ts, tools.formatDurationMethods.diff ) + ")";
			}
			friend_request += '<div class="chat-friend-request-name"><a href="' + this.url_base_profile + data['profile_name'] + '" title="' + data['profile_name_display'] + '" target="_blank" rel="noopener noreferrer">' + data['profile_name_display'] + '</a>' + display_ago + '</div>';
			friend_request += '</li>';
			
			return friend_request;
		},
		
		friend_request_accept: function(friend_id_link) {
			this.chatInitsAndPrefs.set_timer_away();
			var friend_id = parseInt(friend_id_link.id.replace("chat-friend-request-", "").replace("-link","") );
			
			if ( friend_id == 0 ) {
				log_and_tooltip.popup_title_open( "<p>" + i18n.__('misc.error_please_retry') + "</p>");
				return;
			}
			
			if ( typeof this.socket_connection !== "undefined" && typeof this.socket_connection.emit == "function" ) {
				this.socket_connection.emit("accept_friend", { "friend_id" : friend_id });
				
				$("#chat-friend-request-" + friend_id).find(".chat-friend-request-button button").hide();
				$(friend_id_link).parent().append('<div id="div-load-request-' + friend_id + '">' + inline_loader.getSafe('after', i18n.__("loading.loading")).getHtml() + '</div>');
				
				setTimeout(function() {
					$("#div-load-request-" + friend_id).remove();
					$("#chat-friend-request-" + friend_id).find(".chat-friend-request-button button").show();
				}, 12*1000);
				
			} else {
				log_and_tooltip.popup_title_open( "<p>" + i18n.__('misc.error_please_retry') + "</p>");
			}
		},
		
		friend_request_accepted: function(data) {
			wglog.debug("friend_request_accepted"/*, data*/);
			
			if ( typeof data.user == "undefined" || typeof data.friend == "undefined" ) {
				if ( typeof data.user !== "undefined" && data.user.id_user == this.user_id ) {
					log_and_tooltip.popup_title_open( "<p>" + i18n.__('misc.error_please_retry') + "</p>");
				}
				return;
			}

			var listTypeAndEvents = this.getListTypeAndEvents(data.friend);

			if ( data.user.id_user == this.user_id ) {
				this.chatContext.emit(listTypeAndEvents.events.UPDATE_LIST, false, 'update');
				//this.chat_friend_manager.add_friend( data.friend, true );
				
				$("#chat-friend-request-" + data.friend.id_user).remove();
				
				if ( typeof data.nb_friend_request != "undefined" ) {
					
					if ( parseInt(data.nb_friend_request) == 0 ) {
						$("#chat-home-friend-request").html( i18n.__('chat.infos.no_friends_requests') );
						$("#chat-home-last-friend-request").html("");
						this.set_badge_friend_request( 0 );
					} else {
						this.set_badge_friend_request( data.nb_friend_request );
						
						$("#chat-home-friend-request").html( i18n.__('chat.infos.nb_friends_requests_received', { '%nb_friend_request%': data.nb_friend_request.toString(), '%start_link%': '<a href="' + this.url_friends_requests + '" target="_blank" rel="noopener noreferrer">', '%end_link%': '</a>' }) );
						
						var self = this;
						
						if ( typeof data.last_friend_request != "undefined" ) {
							for (var f in data.last_friend_request) {
								if ( $("#chat-friend-request-" + data.last_friend_request[f]['id_friend']).length == 0 ) {
									$("#chat-friend-requests").append( this.friend_requests_li_html( data.last_friend_request[f] ) );
									$("#chat-friend-request-" + data.last_friend_request[f]['id_friend'] + "-link").on('click', function(event) { event.stopPropagation();self.friend_request_accept(this); } );
									$("#chat-friend-request-" + data.last_friend_request[f]['id_friend'] + "-link-refuse").on('click', function(event) { event.stopPropagation();self.friend_request_refuse(this); } );
								}
							}
						}
					}
				}
			}
			
			if ( data.friend.id_user == this.user_id ) {
				this.chatContext.emit(listTypeAndEvents.events.ADD_CONTACT, data.user);
				// this.chat_friend_manager.add_friend( data.user, true );
			}
		},
		
		friend_request_refuse: function(friend_id_link) {
			this.chatInitsAndPrefs.set_timer_away();
			
			var friend_id = parseInt(friend_id_link.id.replace("chat-friend-request-", "").replace("-link-refuse","") );
			
			if ( friend_id == 0 ) {
				log_and_tooltip.popup_title_open( "<p>" + i18n.__('misc.error_please_retry') + "</p>");
				return;
			}
			
			if ( typeof this.socket_connection !== "undefined" && typeof this.socket_connection.emit == "function" ) {
				this.socket_connection.emit("refuse_friend_request", { "friend_id" : friend_id });
				
				$("#chat-friend-request-" + friend_id).find(".chat-friend-request-button button").hide();
				$(friend_id_link).parent().append('<div id="div-load-request-' + friend_id + '">' + inline_loader.getSafe('after', i18n.__("loading.loading")).getHtml() + '</div>');
				
				setTimeout(function() {
					$("#div-load-request-" + friend_id).remove();
					$("#chat-friend-request-" + friend_id).find(".chat-friend-request-button button").show();
				}, 12*1000);
				
			} else {
				log_and_tooltip.popup_title_open( "<p>" + i18n.__('misc.error_please_retry') + "</p>");
			}
		},
		
		friend_request_refused: function(data) {
			wglog.debug("friend_request_refused"/*, data*/);
			
			if ( typeof data.user_id == "undefined" || typeof data.friend_id == "undefined" ) {
				if ( typeof data.user_id !== "undefined" && data.user_id == this.user_id ) {
					log_and_tooltip.popup_title_open( "<p>" + i18n.__('misc.error_please_retry') + "</p>");
				}
				return;
			}
			
			if ( data.user_id == this.user_id ) {
				
				$("#chat-friend-request-" + data.friend_id).remove();
				
				if ( typeof data.nb_friend_request != "undefined" ) {
					
					if ( parseInt(data.nb_friend_request) == 0 ) {
						$("#chat-home-friend-request").html( i18n.__('chat.infos.no_friends_requests') );
						$("#chat-home-last-friend-request").html("");
						this.set_badge_friend_request( 0 );
					} else {
						this.set_badge_friend_request( data.nb_friend_request );
						
						$("#chat-home-friend-request").html( i18n.__('chat.infos.nb_friends_requests_received', { '%nb_friend_request%': data.nb_friend_request.toString(), '%start_link%': '<a href="' + this.url_friends_requests + '" target="_blank" rel="noopener noreferrer">', '%end_link%': '</a>' }) );
						
						var self = this;
						
						if ( typeof data.last_friend_request != "undefined" ) {
							for (var f in data.last_friend_request) {
								if ( $("#chat-friend-request-" + data.last_friend_request[f]['id_friend']).length == 0 ) {
									$("#chat-friend-requests").append( this.friend_requests_li_html( data.last_friend_request[f] ) );
									$("#chat-friend-request-" + data.last_friend_request[f]['id_friend'] + "-link").on('click', function(elt) { self.friend_request_accept(this); } );
									$("#chat-friend-request-" + data.last_friend_request[f]['id_friend'] + "-link-refuse").on('click', function(elt) { self.friend_request_refuse(this); } );
								}
							}
						}
					}
				}
			}
		},
		
		friend_request_sent_cancel: function(friend_id_link) {
			 this.chatInitsAndPrefs.set_timer_away();
			
			var friend_id = parseInt(friend_id_link.id.replace("chat-friend-request-", "").replace("-link-cancel","") );
			
			if ( friend_id == 0 ) {
				log_and_tooltip.popup_title_open( "<p>" + i18n.__('misc.error_please_retry') + "</p>");
				return;
			}
			
			if ( typeof this.socket_connection !== "undefined" && typeof this.socket_connection.emit == "function" ) {
				this.socket_connection.emit("cancel_friend_request_sent", { "friend_id" : friend_id });
				
				$("#chat-friend-request-" + friend_id).find(".chat-friend-request-button button").hide();
				$(friend_id_link).parent().append('<div id="div-load-request-' + friend_id + '">' + inline_loader.getSafe('after', i18n.__("loading.loading")).getHtml() + '</div>');
				
				setTimeout(function() {
					$("#div-load-request-" + friend_id).remove();
					$("#chat-friend-request-" + friend_id).find(".chat-friend-request-button button").show();
				}, 12*1000);
				
			} else {
				log_and_tooltip.popup_title_open( "<p>" + i18n.__('misc.error_please_retry') + "</p>");
			}
		},
		
		friend_request_sent_canceled:function(data) {
			wglog.debug("friend_request_sent_canceled"/*, data*/);
			
			if ( typeof data.user_id == "undefined" || typeof data.friend_id == "undefined" ) {
				if ( typeof data.user_id !== "undefined" && data.user_id == this.user_id ) {
					log_and_tooltip.popup_title_open( "<p>" + i18n.__('misc.error_please_retry') + "</p>");
				}
				return;
			}
			
			if ( data.user_id == this.user_id ) {
				$("#chat-friend-request-" + data.friend_id).remove();
				this.friend_request_sent_reinit_count();
			} else if ( data.friend_id == this.user_id ) {
				$("#chat-friend-request-" + data.user_id).remove();
			}
		},
		
		friend_request_sent_reinit_count: function() {
			
			var count = $("#chat-friend-requests-sent li").length;
			if (count == this.nb_friend_request_sent_display) {
				return;
			}
			
			this.nb_friend_request_sent = this.nb_friend_request_sent - ( this.nb_friend_request_sent_display - count );
			
			if (this.nb_friend_request_sent > 0) {
				$("#chat-home-friend-request-sent").html( i18n.__('chat.infos.nb_friends_requests_sent', { '%nb_friend_request_sent%': this.nb_friend_request_sent.toString() }) );
			} else {
				$("#chat-home-friend-request-sent").html( i18n.__('chat.infos.no_friends_requests_sent') );
				$("#chat-home-last-friend-request-sent").html("");
			}
			this.set_badge_friend_request_sent(this.nb_friend_request_sent);
		},
		
		friend_request_send: function(friend_id) {
			this.chatInitsAndPrefs.set_timer_away();
			
			wglog.debug("friend_request_send");
			
			friend_id = parseInt( friend_id );
			
			if ( friend_id == 0 ) {
				log_and_tooltip.popup_title_open( "<p>" + i18n.__('misc.error_please_retry') + "</p>");
				return;
			}
			
			if ( typeof this.socket_connection !== "undefined" && typeof this.socket_connection.emit == "function" ) {
				this.socket_connection.emit("make_friend_request", { "friend_id" : friend_id, "hexavid_login": cookies.get( config.cookie_name ) });
				
				var p_send_request = $("#chat-profile-send-request");
				$('<p id="div-send-request-profile">' + inline_loader.getSafe('after', i18n.__("loading.loading")).getHtml() + '</p>').insertAfter( p_send_request );
				p_send_request.hide();
				
				setTimeout(function() {
					p_send_request.show();
					$("#div-send-request-profile").remove();
				}, 12*1000);
				
			} else {
				log_and_tooltip.popup_title_open( "<p>" + i18n.__('misc.error_please_retry') + "</p>");
			}
		},
		
		friend_request_done: function(data) {
			wglog.debug("friend_request_done"/*, data*/);
			
			if ( typeof data.vpn !== "undefined" && data.vpn == 1 ) {
				
				var message_error = "<p><b>" + i18n.__('chat.error.using_vpn') + "</b></p><p>" + i18n.__('chat.error.vpn_red_member_needed', { "%link_start%": '<a href="https://www.xvideos.red">', "%link_end%": "</a>", "%verif_link_start%": '<a href="/account/verify_account">' }) + "</p>";
				
				if (typeof data.friend_id == "undefined" || $("#chat_group_messages_tab_" + data.friend_id).length ===0 ) {
					log_and_tooltip.write_error({logTitle: 'chat_friend_action::friend_request_done friend_id undefined or tab not found', logMessage: message_error, "message": message_error});
				}
				
				$("#chat_group_messages_tab_" + data.friend_id).html( '<li id="chat-profile-send-request">' + message_error + "</li>" );
				return;
			}
			
			if ( typeof data.user == "undefined" || typeof data.friend == "undefined" ) {
				if ( data.user.id_user == this.user_id ) {
					log_and_tooltip.popup_title_open( "<p>" + i18n.__('misc.error_please_retry') + "</p>");
				}
				return;
			}
			
			var self = this;
			
			if ( data.user.id_user == this.user_id ) {
				$("#chat-profile-send-request").html( "<p>" + i18n.__('profile.friends.you_asked_friends', {"%name%": data.friend.profile_name}) + "</p><p>" + i18n.__("chat.waiting_request_response") + "</p>" );
				$("#chat-profile-send-request").show();
				$("#div-send-request-profile").remove();
				
				if ( typeof config != "undefined" && typeof config.user != "undefined" && data.friend.id_user == config.user.id_user ) {
					if ($("#chat-friend-requests-sent").length == 0) {
						$("#chat-home-last-friend-request-sent").html('<p>' + i18n.__('chat.infos.last_friends_requests_sent') + '</p><ul id="chat-friend-requests-sent"></ul>');
					}
					
					var data_friend = {};
					data_friend["id_friend"] = data.friend.id_user;
					data_friend["profile_name"] = config.user.display;
					if ( $("select_friend_li_" + data.friend.id_user + " .chat_profile_name").length > 0 ) {
						data_friend["profile_name_display"] = $("select_friend_li_" + data.friend.id_user + " .chat_profile_name").html();
					} else {
						data_friend["profile_name_display"] = config.user.display;
					}
					data_friend["profile_picture"] = config.user.profile_picture_small;
					$("#chat-friend-requests-sent").append(this.friend_requests_li_html(data_friend, true));
					$("#chat-friend-request-" + data.friend.id_user + "-link-cancel").on('click', function(event) { event.stopPropagation();self.friend_request_sent_cancel(this); } );
					this.friend_request_sent_reinit_count();
				}
			} else if ( data.friend.id_user == this.user_id ) {
				// to be sure
				$("#chat-friend-request-" + data.user.id_user).remove();
				
				if ( $("#chat-friend-requests").length == 0 ) {
					$("#chat-home-last-friend-request").html( '<p>' + i18n.__('chat.infos.last_friends_requests') + '</p><ul id="chat-friend-requests"></ul>' );
				}
				
				if ( typeof data.nb_request !== "undefined" ) {
					$("#chat-home-friend-request").html( i18n.__('chat.infos.nb_friends_requests_received', { '%nb_friend_request%': data.nb_request.toString(), '%start_link%': '<a href="' + this.url_friends_requests + '" target="_blank" rel="noopener noreferrer">', '%end_link%': '</a>' }) );
					this.set_badge_friend_request( data.nb_request );
				}
				
				if ( $("#chat-friend-request-" + data.user.id_user).length == 0 ) {
					var infos = {};
					infos.id_friend = data.user.id_user;
					infos.profile_picture = data.user.profile_picture;
					infos.profile_name = data.user.profile_name_lower;
					infos.profile_name_display = data.user.profile_name;
					
					$("#chat-friend-requests").prepend( this.friend_requests_li_html( infos ) );
					$("#chat-friend-request-" + data.user.id_user + "-link").on('click', function(elt) { self.friend_request_accept(this); } );
					$("#chat-friend-request-" + data.user.id_user + "-link-refuse").on('click', function(elt) { self.friend_request_refuse(this); } );
				}
				
			}
			
		},
		
		pending_request_checked: function(data) {
			wglog.debug("pending_request_checked"/*, data*/);

			if ( typeof data.pending_request == "undefined" || typeof data.friend_id == "undefined" || typeof data.friend_name == "undefined" || typeof data.can_request == "undefined" ) {
				return;
			}
			
			if ( !config.hasOwnProperty('data') || !config.hasOwnProperty('user') || !config.user.hasOwnProperty('id_user') || config.user.id_user != data.friend_id ) {
				return;
			}
			
			var friend = {};
			friend.nb_unread = 0;
			friend.profile_name = config.user.display;
			friend.profile_name_lower = config.user.username;
			friend.is_favorite = false;
			friend.is_online = true;
			friend.selected = false;
			friend.id_user = config.user.id_user;
			friend.profile_picture = config.user.profile_picture_small;
			friend.not_friend = true;
			
			// create conversation tab
			var div_id = "chat_messages_tab_" + friend.id_user;
			var ul_id = "chat_group_messages_tab_" + friend.id_user;
			if ($("#" + div_id).length === 0) {
				this.msglist.append('<div id="' + div_id + '" class="chat_tab_container"><ul id="' + ul_id + '" class="chat_group_tab_container"></ul></div>');
			}
			
			if ( data.pending_request ){
				var trad_waiting = "chat.waiting_request_response";
				if ( config.user.hasOwnProperty('sex') ) {
					var sex = config.user.sex;
					if ( sex == "Woman" || sex == "Lesbian woman" || sex == "Transsexual" ) {
						trad_waiting = "chat.waiting_request_response_her";
					} else if ( sex.toLowerCase().indexOf("couple") !== -1 ) {
						trad_waiting = "chat.waiting_request_response_them";
					}
				}
				trad_waiting = i18n.__(trad_waiting);
				
				$("#" + ul_id).html( '<li id="chat-profile-send-request">' + "<p>" + i18n.__('profile.friends.you_asked_friends', {"%name%": data.friend_name}) + "</p><p>" + trad_waiting + "</p>" + "</li>" );
			} else {
				if ( data.can_request ) {
					if ( data.asked_you ) {
						$("#" + ul_id).html( '<li id="chat-profile-send-request">' + i18n.__('profile.friends.asked_you_friend', {"%name%": data.friend_name }) + "</li>" );
					} else {
						var trad_id = 'chat.friend_request_from_profile';
						if ( config.user.hasOwnProperty('sex') ) {
							var sex = config.user.sex;
							if ( sex == "Woman" || sex == "Lesbian woman" || sex == "Transsexual" ) {
								trad_id = "chat.friend_request_from_profile_her";
							} else if ( sex.toLowerCase().indexOf("couple") !== -1 ) {
								trad_id = "chat.friend_request_from_profile_them";
							}
						}
						
						var trad = i18n.__( trad_id, {"%name%": data.friend_name, "%start_link%": '<a id="chat-profile-send-request-link">', "%end_link%": "</a>"});
						
						$("#" + ul_id).html( '<li id="chat-profile-send-request">' + trad + "</li>" );
						var self = this;
	
						$("#chat-profile-send-request").find("a").on("click", function(event){
							event.stopPropagation();
							self.friend_request_send( config.user.id_user );
						});
					}
				} else {
					$("#" + ul_id).html( '<li id="chat-profile-send-request">' + i18n.__('profile.friends.ask_friend_not_allowed', {"%user%": data.friend_name}) + "</li>" );
				}
			}

			// $("#select_friend_li_" + config.user.id_user ).remove();
			// this.chat_friend_manager.add_friend(friend);

			var listTypeAndEvents = this.getListTypeAndEvents(data);
			this.chatContext.emit(listTypeAndEvents.events.ADD_CONTACT, friend);

			this.chat_friend_manager.select_friend(config.user.id_user);
		},
		
		block_report: function( event, selected_friend, friends ) {
			if ( event != null ) {
				event.stopPropagation();
			}
			
			var friend_id = selected_friend;
			
			if ( friend_id == 0 ) {
				wglog.error("block_report", "no friend selected");
				log_and_tooltip.popup_open(
					$(".chat-header-container .chat-header-block"),
					"<p>" + i18n.__('chat.error.no_friends_selected') + "</p>"
				);
				return;
			}
			
			var friend_infos = friends[ friend_id ];
			
			var text_popup = '<ul class="chat_popup_choice">';
			text_popup += config.block_user_enabled ? '<li class="text-left"><input type="checkbox" name="is_blocked" id="is_blocked" class="js-limit-checks"' + (friend_infos.is_blocked ? ' checked' : '') + '> <label for="is_blocked" title="' + i18n.__('profile.description.block_user')  + '">' + i18n.__('profile.actions.block_user') + '</label></li>' : '';
			text_popup += config.block_user_enabled ? '<li class="text-left"><input type="checkbox" name="is_ghosted" id="is_ghosted" class="js-limit-checks"' + (friend_infos.is_ghosted ? ' checked' : '') + '> <label for="is_ghosted" title="' + i18n.__('profile.description.ghost_user')  + '">' + i18n.__('profile.actions.ghost_user') + '</label></li>' : '';
			text_popup += config.report_last_message_enabled ? '<li id="chat_popup_li_report">' + i18n.__('profile.actions.report_user') + '</li>' : '';
			text_popup += '</ul>';
	
			if (config.block_user_enabled && !this.block_checkboxes_listener_on) {
				this.block_checkboxes_listener_on = true;
				$(document).on('change', '.js-limit-checks', function(event) {
					var states = {};
					
					$('.js-limit-checks').each(function (idx, elt) {
						if (elt != event.currentTarget) {
							elt.checked = false;
						}
						states[elt.name] = elt.checked;
					});
					
					event.stopPropagation();
					// log_and_tooltip.popup_close();
					self.block_friend(selected_friend, null, friends, states);
				});
			}
			
			$(event.currentTarget).off('click');
			log_and_tooltip.popup_open( $(event.currentTarget) , text_popup, { no_dispatch_event: true });
			
			var self = this;
			
			if (config.report_last_message_enabled) {
				$( "#chat_popup_li_report" ).on("click", function(event) {
					event.stopPropagation();
					log_and_tooltip.popup_close();
					self.report_last_message( $(".chat-header-container .chat-header-block"), 0, selected_friend, friends );
				});
			}
		},
		
		block_friend: function( friend_id, message, friends, states ) {
			
			if ( friend_id == 0 || typeof friends == "undefined" || typeof friends[ friend_id ] == "undefined"  ) {
				wglog.error("block_friend", "no friend selected");
				log_and_tooltip.popup_open( $(".chat-header-container .chat-header-block"), "<p>" + i18n.__('chat.error.no_friends_selected') + "</p>" );
				return;
			}
			
			var friend_infos = friends[ friend_id ];
			
			if ( message == null ) {
				message = i18n.__('profile.confirm_block', {"%user%": friend_infos.profile_name});
			}
			
			if ( typeof this.socket_connection != "undefined" && typeof this.socket_connection.emit == "function" ) {
				var params = {'friend_id': friend_id};
				
				if (states.is_ghosted) {
					// Update friend data
					friends[friend_id].is_blocked = false;
					friends[friend_id].is_ghosted = true;
					// Update for socket
					params.is_ghosted = 1;
				}
				else if (states.is_blocked) {
					// Update friend data
					friends[friend_id].is_blocked = true;
					friends[friend_id].is_ghosted = false;
					// Update for socket
					params.is_ghosted = 0;
				}
				
				if (params.hasOwnProperty('is_ghosted')) {
					wglog.debug('block_or_ghost_friend', params);
					this.socket_connection.emit("block_or_ghost_friend", params);
				} else {
					// Update friend data
					friends[friend_id].is_blocked = false;
					friends[friend_id].is_ghosted = false;
					// Update for socket
					wglog.debug('unblock_or_unghost_friend', params);
					this.socket_connection.emit("unblock_or_unghost_friend", params);
				}
			} else {
				wglog.error("block_friend", "no socket connection");
			}
			
		},
		
		friend_blocked: function(data) {
			wglog.debug('friend_blocked', data);
			
			if (typeof data.friend_id === 'undefined') {
				log_and_tooltip.popup_title_open( "<p>" + i18n.__('misc.error_please_retry') + "</p>" );
				return;
			}

			var listTypeAndEvents = this.getListTypeAndEvents(data),
				contactData = { id_user: data.friend_id };

			if (listTypeAndEvents.type === 'customers') {
				contactData.is_customer = true;
			} else if (listTypeAndEvents.type === 'followers') {
				contactData.is_follower = true;
			}

			this.chatContext.emit(listTypeAndEvents.events.REMOVE_CONTACT, contactData);
			// $('#select_friend_li_' + data.friend_id).remove();
			$('#chat_group_messages_tab_' + data.friend_id).remove();
			
			// update data in SW
			if (this.chatInitsAndPrefs.serviceWorker) {
				try {
					this.chatInitsAndPrefs.serviceWorker.postMessage({
						"action": "block_friend",
						"friend_id": data.friend_id
					});
				} catch (e) {
					wglog.error('Failed to send block_friend to SW', e.toString());
				}
			}
		},
		
		report_message: function(message_link, friend_id, friend_infos) {
			wglog.debug("report_message");

			var message = $(message_link).closest(".chat-actions").parent().find(".chat_message_report");

			var popup_options = {};

			if ( ( $( message_link ).offset().top - $("#chat-window").offset().top ) > ( $("#chat-window").height() /2  ) ) {
				popup_options.position = { v: 'above', h: 'right' };
			}
			this.report_message_confirm(message, $( message_link ), 0, 0, friend_id, friend_infos, popup_options);
		},

		report_last_message: function(message_link, block, selected_friend, friends) {
			wglog.debug("report_last_message");

			if ( block != 1 ) {
				block = 0;
			}

			var messages = $("#chat_group_messages_tab_" + selected_friend + " .chat_message_report.message_left");
			var last_message = messages[messages.length - 1];

			this.report_message_confirm( last_message, $(".chat-header-container .chat-header-block"), block, 1, selected_friend, friends[selected_friend] );
		},

		report_message_confirm: function(message, popup_btn, block, user, selected_friend, friend_infos, popup_options) {

			if (typeof popup_options != "object") {
				popup_options = {};
			}

			var text_popup = "<h4>" + i18n.__('chat.report_message') + "</h4>";
			text_popup += '<div id="popup_report_message_errors" class="error"></div>';
			text_popup += '<p><span>' + i18n.__('report_form.reason') + ': </span><select id="popup_report_message_select">';
			for (var i in this.report_reasons) {
				text_popup += '<option value="' + this.report_reasons[i] + '">' + i18n.__('report_form.' + this.report_reasons[i]) + '</option>';
			}
			text_popup += '</select></p><p><textarea id="popup_report_message_text" placeholder="' + i18n.__('report_form.give_details') + '"></textarea></p>';
			text_popup += '<p class="chat_popup_buttons"><button id="chat_popup_report_yes">' + i18n.__('misc.yes') + '</button><button id="chat_popup_report_no">' + i18n.__('misc.no') + '</button></p>';

			var self = this;

			log_and_tooltip.popup_open( popup_btn , text_popup, popup_options);
			$( "#chat_popup_report_yes" ).on("click", function() {
				$("#popup_report_message_errors").hide();
				$("#popup_report_message_errors").empty();
				var reason = $("#popup_report_message_select").val();
				var reason_text = $("#popup_report_message_text").val();
				var errors = [];
				if (!reason || self.report_reasons.indexOf(reason) == -1) {
					errors.push(i18n.__('report_form.sending_failed_2'));
				}
				if (!reason_text || reason_text.length < 10) {
					errors.push(i18n.__('report_form.enter_reason', {"%nb_chars%":"10"}));
				}
				if (errors.length > 0) {
					for (var i in errors) {
						$("#popup_report_message_errors").append('<p>' + errors[i] + '</p>');
						$("#popup_report_message_errors").show();
					}
					return;
				}

				self.report_message_send( message, block, user, selected_friend, friend_infos, reason, reason_text );
				log_and_tooltip.popup_close();
			});
			$( "#chat_popup_report_no" ).on("click", function() {
				log_and_tooltip.popup_close();
			});
		},
		
		report_message_send: function(message, block, user, selected_friend, friend_infos, reason, reason_text) {
			
			wglog.debug("report_message_send");
			
			if ( block != 1 ) {
				block = 0;
			}
			
			if ( user != 1 ) {
				user = 0;
			}
			
			// get enough messages
			var messages = $("#chat_group_messages_tab_" + selected_friend + " .chat_message_report");
			if ( messages.length < 100 && $('#history_' + selected_friend).length > 0 ) {
				
				// get the messages
				var report_data = { "nb_messages": messages.length, "block": block, "user": user, "message_id": $(message).closest(".chat_message_id").attr('id') };
				this.get_conversation_fct(selected_friend, friend_infos['first_timestamp']-1, null, report_data);
				return;
			}
			
			var index_message = messages.index( message );
			var messages_report = this.get_messages_for_report(messages, index_message, friend_infos);
			
			this.report_message_confirmed( messages_report, block, user, selected_friend, reason, reason_text);
			
		},
		
		get_messages_for_report: function( messages, index_message, friend_infos) {
			var first = Math.max( 0, messages.length - 100 );
			var last = messages.length - 1;
			
			var temp_message, temp, messages_report = [];
			for ( var i=first;i<=last;i++) {
				if ( !messages.hasOwnProperty(i) ) {
					continue;
				}
				temp_message = $(messages[i]).clone();
				temp = {};
				if ( temp_message.hasClass("message_right") ) {
					temp.name = this.profile_name;
					temp.id_user = this.user_id;
				} else {
					temp.name = friend_infos.profile_name;
					temp.id_user = friend_infos.id_user;
					
				}
				temp.message = temp_message.html().trim();
				
				if ( i == index_message ) {
					temp.reported = true;
				}
				
				messages_report.push( temp );
			}
			
			return messages_report;
		},
		
		report_message_confirmed: function( messages_report, block, user, selected_friend, reason, reason_text ) {
			if ( block != 1 ) {
				block = 0;
			}
			if ( user != 1 ) {
				user = 0;
			}
			
			if (typeof this.socket_connection != "undefined" && typeof this.socket_connection.emit == "function") {
				this.socket_connection.emit("report_friend", {
					"friend_id": selected_friend,
					"messages": JSON.stringify(messages_report),
					"block": block,
					"trad_user": user,
					"reason": reason,
					"reason_text": reason_text
				});
			} else {
				wglog.error("report_message_confirmed", "bad socket connection" );
			}
			log_and_tooltip.popup_close();
		},
		
		friend_reported: function(data, friends) {
			wglog.debug("friend_reported");
			if ( !data.hasOwnProperty("friend_id") || !friends.hasOwnProperty( data.friend_id ) ) {
				wglog.error("friend_reported", "unknowd friend_id " + data.friend_id );
				return;
			}

			$("#chat_friend_menu").hide();
			
			var text_popup = '<p>' + i18n.__('chat.message_reported') + '</p>';
			if ( data.hasOwnProperty("trad_user") && parseInt(data.trad_user) === 1 ) {
				text_popup = '<p>' + i18n.__('profile.user_reported') + '</p>';
			}
			log_and_tooltip.popup_open( $("#chat_friend_menu_switch") , text_popup);
		},
		
		copy_messages_to_clipboard: function(id_friend) {

			$("#chat_friend_menu").hide();
			
			var messages = "";
			var self = this;
			var regex_clear = /(\r\n\t|\n|\r|\t)/gm;
			var date_formatter = new Intl.DateTimeFormat("en-US", {
				year: "numeric", month: "numeric", day: "numeric",
				hour: "numeric", minute: "numeric", second: "numeric",
				hour12: false
			});
			$("#chat_group_messages_tab_" + id_friend + " .chat-message__body").each( function() {
				var $username = $(this).find(".chat-message__username");

				if ($username.length) {
					var $username_link = $username.find('a');
					var username = $username_link.length ? $username_link.text() + ' - ' + $username_link.attr('href') : $username.html();
					username = username.replace(regex_clear, '');
					messages += "\n" + username + "\n";
				}
				
				$(this).find(".chat_message_report").each(function() {
					var html = $(this).html();
					try {
						var json = JSON.parse(html);
						if ( json && json.type == "upload" && json.verif == "file uploaded in chat" ) {
							if (json.file_broken) {
								html = "[ " + i18n.__("chat.file_expired") + " ]";
							} else {
								html = "[ " + i18n.__("chat.uploaded_file") + " ]";
							}
						}
					} catch (e) {
					}
					html = html.replace(regex_clear, '');
					
					var timestamp = $(this).parent().find('.chat-message__meta--time').data('timestamp');
					
					if (timestamp) {
						var date = new Date(timestamp * 1000);
						messages += date_formatter.format(date) + "\n";
					}

					//var message_indent = $(this).parents('.chat-message--system, .chat-message--tip').length ? "" : "    ";
					messages += utils.escapeHtml(html) + "\n";
				});
				
			});

			var textarea = document.createElement('textarea');
			textarea.value = messages;
			textarea.id = "chat_textarea_clipboard";
			textarea.style.width = "100";
			textarea.style.height = "100";
			textarea.style.border = "0";
			$("div#chat-window div.chat-messages")[0].appendChild(textarea);
			textarea.select();
			document.execCommand('copy');
			$("#chat_textarea_clipboard").remove();
			
			log_and_tooltip.popup_open( $("#chat_friend_menu_switch") , "<p class='message'>" + i18n.__("chat.conv_copied_to_clipboard") + "</p>", {trigger: false});
		},
		
		delete_all_messages: function(friend_infos) {
			
			var text_popup;
			var error = false;
			
			if ( friend_infos === false || typeof friend_infos["profile_name"] == "undefined" ) {
				error = true;
				text_popup = "<p>" + i18n.__('misc.error_please_retry') + "</p>";
			}
			
			if (!error) {
				text_popup = "<h4 style='text-align:center;margin-bottom:15px;'>" + i18n.__('chat.delete_all_messages_for_all') + "</h4>";
				text_popup += '<div class="chat_delete_all"><div><div><div class="icon-f icf-warning"></div></div><div>' + i18n.__('chat.delete_all_messages_ask_for_all') + '</div></div></div>';
				text_popup += '<p class="chat_popup_buttons"><button id="chat_popup_delete_all_yes" class="btn btn--flat" disabled>' + i18n.__('chat.delete_all_messages_for_all') + '</button><button id="chat_popup_delete_all_no" class="btn btn--flat">' + i18n.__('misc.no') + '</button></p>';
			}
			
			log_and_tooltip.popup_open( $(".chat-message-header-delete-all") , text_popup);
			
			var timeout = 4000;
			var countdown;
			
			setTimeout( function() {
				$("#chat_popup_delete_all_yes").prop("disabled", false);
				clearInterval(countdown);
				$("#chat_popup_delete_all_yes").html( i18n.__('chat.delete_all_messages_for_all') );
			}, timeout);
			
			$("#chat_popup_delete_all_yes").html( i18n.__('chat.delete_all_messages_for_all') + " ... " + ( Math.round( timeout / 1000 ) ) );
			countdown = setInterval( function() {
				timeout -= 1000;
				$("#chat_popup_delete_all_yes").html( i18n.__('chat.delete_all_messages_for_all') + " ... " + ( Math.round( timeout / 1000 ) ) );
			} , 1000 );
			
			if (!error) {
				var self = this;
				var id_friend = friend_infos.id_user;
				
				$("#chat_popup_delete_all_yes").on("click", function () {
					self.socket_connection.emit("delete_allmessages", {"recipient_id": id_friend});
					log_and_tooltip.popup_close();
					wglog.debug("emit delete_allmessages", {"recipient_id": id_friend});
				});
				$("#chat_popup_delete_all_no").on("click", function () {
					log_and_tooltip.popup_close();
				});
			}
		},
		
		message_all_deleted: function(data) {
			wglog.debug("message_all_deleted", data);
			
			if ( typeof data.recipient_id == "undefined" ) {
				wglog.debug("message_all_deleted", 'data.recipient_id is missing');
				return;
			}
			if ( typeof data.deleted == "undefined") {
				wglog.debug("message_all_deleted", 'data.deleted is missing');
				return;
			}
			if ( data.deleted != "me" && data.deleted != "friend" ) {
				wglog.debug("message_all_deleted", 'data.deleted must be either "me" or "friend"');
				return;
			}
			
			// We try to know what we have to do
			var friend_infos = this.chat_friend_manager.get_friend_infos(data.recipient_id);
			if ( friend_infos === false ) {
				wglog.debug("message_all_deleted", 'friend not found');
				return;
			}
			
			// Hide the chat friend menu (conversation menu)
			$("#chat_friend_menu").hide();
			
			// We delete all messages by type
			for (let i = 0, l = config.delete_all_messages_from.length; i < l; i++) {
				var user_type = config.delete_all_messages_from[i];
				
				if (['me', 'friend', 'system'].indexOf(user_type) === -1) {
					continue;
				}
				
				$("ul#chat_group_messages_tab_" + data.recipient_id + " .chat-message--" + user_type).remove();
			}

			// We display a no history message there is any
			if ( $("ul#chat_group_messages_tab_" + data.recipient_id + " li").length == 0 ) {
				$("ul#chat_group_messages_tab_" + data.recipient_id).html('<li class="chat-message chat-message--system chat-message--empty"><p>' + i18n.__('chat.infos.no_history') + '</p></li>');
			}
			
			// We reset friend's meta (last_message, last_read, last_)
			this.chat_friend_manager.reset_friend_meta(data.recipient_id);
			
			// We reset friend in list
			var listTypeAndEvents = this.getListTypeAndEvents(friend_infos);
			this.chatContext.emit(listTypeAndEvents.events.UPDATE_LIST, false, 'update');

			//this.chat_friend_manager.add_friend(friend_infos);
		},
		
		change_favorite_state: function(event) {
			this.chatInitsAndPrefs.set_timer_away();
			event.stopPropagation();
			
			if ( this.chat_friend_manager.selected_friend == 0 ) {
				wglog.error("change_favorite_state", "no friend selected");
				log_and_tooltip.popup_open( $("#chat-window .chat-header-change-fav"), "<p>" + i18n.__('chat.error.no_friends_selected') + "</p>" );
				return;
			}
			
			var friend_infos = this.chat_friend_manager.get_selected_friend_infos();
			
			if (!friend_infos) {
				log_and_tooltip.popup_open( $("#chat-window .chat-header-change-fav"), "<p>" + i18n.__('chat.error.no_friends_selected') + "</p>" );
				return;
			}
			
			wglog.debug('change_favorite_state', friend_infos['id_user']);
			
			var link = $(".chat-header-container .chat-header-change-fav");
			
			// if something went wrong -> refresh header 5s later
			if ( link.length > 0 ) {
				var link_div = link[0];
				var selected_friend = this.chat_friend_manager.selected_friend;
				var self = this;
				link.remove();
				setTimeout( function() {
					if ( self.chat_friend_manager.selected_friend == selected_friend && $(".chat-header-container .chat-header-change-fav").length == 0 ) {
						self.chat_friend_manager.header_messages_html( self.chat_friend_manager.selected_friend );
					}
				}, 5000);
			}
			
			if ( friend_infos.is_favorite == 1 ) {
				this.socket_connection.emit("unfavorite_friend", {'id': friend_infos.id_user});
			} else {
				this.socket_connection.emit("favorite_friend", {'id': friend_infos.id_user});
			}
			
		},
		
		update_favorite: function(data) {
			wglog.debug("update_favorite", data);
			
			if (typeof data.id === 'undefined' || typeof data.favorite === 'undefined') {
				log_and_tooltip.popup_open( $("#chat-window #chat_friend_menu_switch"), "<p>" + i18n.__('chat.error.update_favorite_failed') + "</p>" );
				return;
			}
			
			var friend_infos = this.chat_friend_manager.get_friend_infos(data.id);
			if ( friend_infos === false ) {
				log_and_tooltip.popup_open( $("#chat-window #chat_friend_menu_switch"), "<p>" + i18n.__('chat.error.update_favorite_failed') + "</p>" );
				return;
			}

			this.chat_friend_manager.set_friend_attribut(data.id, "is_favorite", data.favorite ? 1 : 0);
			
			// update data in SW
			if (this.chatInitsAndPrefs.serviceWorker) {
				try {
					this.chatInitsAndPrefs.serviceWorker.postMessage({
						"action": "friend_favorite",
						"friend_id": data.id,
						"favorite": friend_infos.is_favorite
					});
				} catch (e) {
					wglog.error('Failed to send friend_favorite to SW', e.toString());
				}
			}

			var listTypeAndEvents = this.getListTypeAndEvents(friend_infos);
			this.chatContext.emit(listTypeAndEvents.events.UPDATE_LIST, false, 'update');

			// $("#select_friend_li_" + data.id).remove();
			// this.chat_friend_manager.add_friend( friend_infos, true );
			
			if ( data.id == this.chat_friend_manager.selected_friend ) {
				this.chat_friend_manager.header_messages_html( this.chat_friend_manager.selected_friend );
			}
		},

		switch_contact_list: function() {
			this.chat_friend_manager.setSwitchContactListBtn();
		},

		hide_user: function(id) {
			this.socket_connection.emit('hide_user', {
				'friend_id': id
			});
		},

		follow_creator: function(friend_info) {
			var self = this,
				isPornbox = config.i18n_website_name === 'Pornbox',
				url = isPornbox ? (friend_info.profile_url.split('application')[1] + '/rating') : ('/api/follow/' + friend_info.alias),
				ajaxData = {
					url: url,
					type: 'POST',
					headers: {'Content-Type': 'application/x-www-form-urlencoded'},
					success: function(response) {
						if (response.success || (isPornbox && response.rate === 2)) {
							self.chat_friend_manager.creator_followed();
						}
					}
				};

			if (isPornbox) {
				ajaxData.data = { rate: 2 }
			}

			$.ajax(ajaxData);
		}
	};
	
	return chat_friend_action;
});
define('features/FanInfo/directives/FanInfoSendMessage',[
	'config/chat',
	'features/FanInfo/events/FanInfoEvent',
	'features/FanInfo/models/FanInfo',
	'lib/i18n!front',
	'libs/EventEmitter'
], function(
	Config,
	FanInfoEvent,
	FanInfo,
	i18n,
	EventEmitter
) {
	var DISPLAY_COUNT_LIMIT = 1,
		FAN_INFO_NAME = 'send-message',
		KEYWORDS = [];

	var FanInfoSendMessage = function() {
		this.fanInfo = new FanInfo();
	};

	Object.assign(FanInfoSendMessage.prototype, {
		_canDisplayModal: function () {
			var fanInfo = this.fanInfo.findByName(FAN_INFO_NAME);

			return !fanInfo || fanInfo.count < DISPLAY_COUNT_LIMIT;
		},

		_initKeywords: function () {
			KEYWORDS = i18n.__('chat.fan_support_keywords').replace(/[ \r]+$/gm, '').split(/\n/gm);
		},

		_messageHasKeywords: function (message) {
			if (!KEYWORDS.length) {
				this._initKeywords();
			}

			var words = message.toLowerCase()
					.replaceAll(/'s/g, "s")
					.replaceAll(/[\W]+/g, " ")
					.replaceAll(/\s{2,}/g, " ")
					.split(' '),
				result = false;

			for (var word of words) {
				if (KEYWORDS.indexOf(word) > -1) {
					result = true;
					break;
				}
			}

			return result;
		},

		_upsertFanInfo: function () {
			var entry = this.fanInfo.findByName(FAN_INFO_NAME);

			if (entry) {
				entry.count++;
			} else {
				entry = {name: FAN_INFO_NAME, count: 1};
			}

			this.fanInfo.save(entry);
		},

		displayModal: function (message, friendName) {
			if (Config.login_info.is_fan && this._canDisplayModal() && this._messageHasKeywords(message)) {
				this._upsertFanInfo();
				EventEmitter.emit(FanInfoEvent.OPEN_SEND_MESSAGE_MODAL, friendName);
				return true;
			}

			return false;
		},
	});

	return new FanInfoSendMessage();
});

define('text!ui/MediaGrid/MediaGrid.mustache',[],function () { return '<div class="chat-ui-media-grid{{#classes}} {{{classes}}}{{/classes}}"{{#attributes}} {{{attributes}}}{{/attributes}}>\n    <div class="chat-ui-media-grid__grid">\n    {{#visibleItems}}\n        <a\n            class="chat-ui-media-grid__item chat-ui-media-grid__item--{{type}}"\n            href="{{url}}"\n            {{#lightbox}}data-lightbox="{{mediaGridId}}"{{/lightbox}}\n            {{#lightbox}}data-lightbox-thumb="{{thumbUrl}}"{{/lightbox}}\n            target="_blank"\n            {{#fileName}}download="{{fileName}}"{{/fileName}}\n            {{#more}} data-more="{{more}}"{{/more}}\n        >\n            {{#thumbUrl}}<img class="chat-ui-media-grid__thumb" src="{{thumbUrl}}" alt="{{fileName}}" />{{/thumbUrl}}\n            {{#fileVideo}}<span class="chat-ui-media-grid__file"><i class="fa fa-play"></i>{{#fileDuration}} <span class="chat-ui-media-grid__duration">{{fileDuration}}</span>{{/fileDuration}}</span>{{/fileVideo}}\n        </a>\n    {{/visibleItems}}\n    </div>\n    {{#invisibleItems}}\n    <a\n        class="chat-ui-media-grid__item chat-ui-media-grid__item--hidden"\n        href="{{url}}"\n        data-lightbox="{{mediaGridId}}"\n        data-lightbox-thumb="{{thumbUrl}}"\n        target="_blank"\n        download="{{fileName}}"\n    >\n    </a>\n    {{/invisibleItems}}\n</div>';});

define('ui/MediaGrid/MediaGrid',[
    'config/chat',
    'core/Component',
    'text!ui/MediaGrid/MediaGrid.mustache'
], function(
    Config,
    Component,
    tplMediaGrid
) {
    var BASE_CLASS_NAME = 'chat-ui-media-grid';
    /**
     * @extends Component
     * @constructor
     */
    var MediaGrid = function(urls, options) {
        this.template = tplMediaGrid;
        this.urlsCount = urls.length;
        this.invisibleItems = [];
        this.visibleItems = [];
        this.mediaGridId = 'id-' + Math.random().toString(32).substring(2);
        this.options = Object.assign({}, {
            attributes: [],
            classes: "",
            visibleItems: 4,
            display: 'grid',
            roundedCorners: false,
            lightbox: true
        }, options);
        if (this.options.roundedCorners) {
            this.options.classes += `${BASE_CLASS_NAME}--rounded-corners `;
        }
        this.addUrls(urls);
        Component.call(this);
    };

    MediaGrid.prototype = Object.create(Component.prototype);

    Object.assign(MediaGrid.prototype, {
        addListeners: function () {
            this.addElementListener(`.${BASE_CLASS_NAME}__thumb`, 'error', this.onThumbError.bind(this));
        },
        addItem: function (urlObject) {
            var visibleItemsNexIndex = this.visibleItems.length + 1;

            if (visibleItemsNexIndex > this.options.visibleItems) {
                this.invisibleItems.push(urlObject);
            } else {
                if (visibleItemsNexIndex === this.options.visibleItems && this.urlsCount > this.options.visibleItems) {
                    urlObject.more = '+' + (this.urlsCount - this.options.visibleItems);
                }
                this.visibleItems.push(urlObject);
            }
        },
        addItemString: function (url) {
            var data = {
                url: url,
            };

            if (/\.(jpeg|jpg|gif|png|webp|svg|bmp|avif)(\?.*)?$/i.test(url)) {
                data.thumbUrl = url;
                data.type = 'image';
            }

            if (/\.(avi|mp4|mpeg4|webm)(\?.*)?$/i.test(url)) {
                data.type = 'video';
            }

            this.addItem(data);
        },
        addUrls: function (urls) {
            for (var i = 0, len = urls.length; i < len; i++) {
                if (typeof urls[i] === 'string') {
                    this.addItemString(urls[i]);
                } else {
                    this.addItem(urls[i]);
                }
            }
        },
        getForcedTemplateParams: function () {
            return {
                mediaGridId: this.mediaGridId,
                lightbox: this.options.lightbox,
                invisibleItems: this.invisibleItems,
                visibleItems: this.visibleItems,
            };
        },
        onThumbError: function (event) {
            event.currentTarget.style.display = 'none';
        }
    });

    return MediaGrid;
});
define('features/Message/SFWMessage',[
    'ui/MediaGrid/MediaGrid',
    'features/Message/views/SFWFormView'
], function(
    MediaGrid,
    SFWFormView
) {
    /**
     * Classe "interface/api" pour communiquer avec le reste du chat en mode synchrone (sans passer par des events).
     *
     * @constructor
     */
    var SFWMessage = function() {
    };

    Object.assign(SFWMessage.prototype, {
        appendMediaGrid: function(message, params) {
            var urls = this.generateUrlArrayFromParams(params);

            if (!urls.length) {
                return;
            }

            var mediaGrid = new MediaGrid(urls, {roundedCorners: true});
            message.find('.chat-message__metas').before(mediaGrid.getElement());
        },
        appendSFWForm: function (message, sfwValue, isSupport) {
            var form = new SFWFormView(message, sfwValue, isSupport);
            message.find('.chat-message__metas').before(form.getElement());
        },
        generateUrlArrayFromParams: function (params) {
            var urls = [];

            if (params.sfwvp) {
                urls.push({
                    type: 'video',
                    url: params.sfwvp
                });
            }

            if (params.sfwip && params.sfwip.length) {
                urls = urls.concat(params.sfwip.map(function (url) {
                    return {
                        type: 'image',
                        url: url,
                        thumbUrl: url
                    };
                }));
            }

            return urls;
        },
    });

    return new SFWMessage();
});
define('jquery',[], function() { return window.jQuery; });
/*! jquery-textcomplete - v1.8.5 - 2019-02-17 */
!function(a){if("function"==typeof define&&define.amd)define('jquery.textcomplete.min',["jquery"],a);else if("object"==typeof module&&module.exports){var b=require("jquery");module.exports=a(b)}else a(jQuery)}(function(a){if("undefined"==typeof a)throw new Error("jQuery.textcomplete requires jQuery");return+function(a){"use strict";var b=function(a){console.warn&&console.warn(a)},c=1;a.fn.textcomplete=function(d,e){var f=Array.prototype.slice.call(arguments);return this.each(function(){var g=this,h=a(this),i=h.data("textComplete");if(i||(e||(e={}),e._oid=c++,i=new a.fn.textcomplete.Completer(this,e),h.data("textComplete",i)),"string"==typeof d){if(!i)return;f.shift(),i[d].apply(i,f),"destroy"===d&&h.removeData("textComplete")}else a.each(d,function(c){a.each(["header","footer","placement","maxCount"],function(a){c[a]&&(i.option[a]=c[a],b(a+"as a strategy param is deprecated. Use option."),delete c[a])})}),i.register(a.fn.textcomplete.Strategy.parse(d,{el:g,$el:h}))})}}(a),+function(a){"use strict";function b(c,d){if(this.$el=a(c),this.id="textcomplete"+e++,this.strategies=[],this.views=[],this.option=a.extend({},b.defaults,d),!(this.$el.is("input[type=text]")||this.$el.is("input[type=search]")||this.$el.is("textarea")||c.isContentEditable||"true"==c.contentEditable))throw new Error("textcomplete must be called on a Textarea or a ContentEditable.");if(c===c.ownerDocument.activeElement)this.initialize();else{var g=this;this.$el.one("focus."+this.id,function(){g.initialize()}),this.option.adapter&&"CKEditor"!=this.option.adapter||"undefined"==typeof CKEDITOR||!this.$el.is("textarea")||CKEDITOR.on("instanceReady",function(b){-1==a.inArray(b.editor.id,f)&&(f.push(b.editor.id),b.editor.on("focus",function(c){g.$el=a(b.editor.editable().$),g.option.adapter||(g.option.adapter=a.fn.textcomplete.CKEditor),g.option.ckeditor_instance=b.editor,g.initialize()}))})}}var c=function(a){var b,c;return function(){var d=Array.prototype.slice.call(arguments);if(b)return void(c=d);b=!0;var e=this;d.unshift(function f(){if(c){var d=c;c=void 0,d.unshift(f),a.apply(e,d)}else b=!1}),a.apply(this,d)}},d=function(a){return"[object String]"===Object.prototype.toString.call(a)},e=0,f=[];b.defaults={appendTo:"body",className:"",dropdownClassName:"dropdown-menu textcomplete-dropdown",maxCount:10,zIndex:"100",rightEdgeOffset:30},a.extend(b.prototype,{id:null,option:null,strategies:null,adapter:null,dropdown:null,$el:null,$iframe:null,initialize:function(){var b=this.$el.get(0);if(this.$el.prop("ownerDocument")!==document&&window.frames.length)for(var c=0;c<window.frames.length;c++)if(this.$el.prop("ownerDocument")===window.frames[c].document){this.$iframe=a(window.frames[c].frameElement);break}this.dropdown=new a.fn.textcomplete.Dropdown(b,this,this.option);var d,e;this.option.adapter?d=this.option.adapter:(e=this.$el.is("textarea")||this.$el.is("input[type=text]")||this.$el.is("input[type=search]")?"number"==typeof b.selectionEnd?"Textarea":"IETextarea":"ContentEditable",d=a.fn.textcomplete[e]),this.adapter=new d(b,this,this.option)},destroy:function(){this.$el.off("."+this.id),this.adapter&&this.adapter.destroy(),this.dropdown&&this.dropdown.destroy(),this.$el=this.adapter=this.dropdown=null},deactivate:function(){this.dropdown&&this.dropdown.deactivate()},trigger:function(a,b){this.dropdown||this.initialize(),null!=a||(a=this.adapter.getTextFromHeadToCaret());var c=this._extractSearchQuery(a);if(c.length){var d=c[1];if(b&&this._term===d&&""!==d)return;this._term=d,this._search.apply(this,c)}else this._term=null,this.dropdown.deactivate()},fire:function(a){var b=Array.prototype.slice.call(arguments,1);return this.$el.trigger(a,b),this},register:function(a){Array.prototype.push.apply(this.strategies,a)},select:function(a,b,c){this._term=null,this.adapter.select(a,b,c),this.fire("change").fire("textComplete:select",a,b),this.adapter.focus()},_clearAtNext:!0,_term:null,_extractSearchQuery:function(b){for(var c=0;c<this.strategies.length;c++){var e=this.strategies[c],f=e.context(b);if(f||""===f){var g=a.isFunction(e.match)?e.match(b):e.match;d(f)&&(b=f);var h=b.match(g);if(h)return[e,h[e.index],h]}}return[]},_search:c(function(a,b,c,d){var e=this;b.search(c,function(d,f){e.dropdown.shown||e.dropdown.activate(),e._clearAtNext&&(e.dropdown.clear(),e._clearAtNext=!1),e.dropdown.setPosition(e.adapter.getCaretPosition()),e.dropdown.render(e._zip(d,b,c)),f||(a(),e._clearAtNext=!0)},d)}),_zip:function(b,c,d){return a.map(b,function(a){return{value:a,strategy:c,term:d}})}}),a.fn.textcomplete.Completer=b}(a),+function(a){"use strict";function b(c,d,f){this.$el=b.createElement(f),this.completer=d,this.id=d.id+"dropdown",this._data=[],this.$inputEl=a(c),this.option=f,f.listPosition&&(this.setPosition=f.listPosition),f.height&&this.$el.height(f.height);var g=this;a.each(["maxCount","placement","footer","header","noResultsMessage","className"],function(a,b){null!=f[b]&&(g[b]=f[b])}),this._bindEvents(c),e[this.id]=this}var c=a(window),d=function(a,b){var c,d,e=b.strategy.idProperty;for(c=0;c<a.length;c++)if(d=a[c],d.strategy===b.strategy)if(e){if(d.value[e]===b.value[e])return!0}else if(d.value===b.value)return!0;return!1},e={};a(document).on("click",function(b){var c=b.originalEvent&&b.originalEvent.keepTextCompleteDropdown;a.each(e,function(a,b){a!==c&&b.deactivate()})});var f={SKIP_DEFAULT:0,KEY_UP:1,KEY_DOWN:2,KEY_ENTER:3,KEY_PAGEUP:4,KEY_PAGEDOWN:5,KEY_ESCAPE:6};a.extend(b,{createElement:function(b){var c=b.appendTo;c instanceof a||(c=a(c));var d=a("<ul></ul>").addClass(b.dropdownClassName).attr("id","textcomplete-dropdown-"+b._oid).css({display:"none",left:0,position:"absolute",zIndex:b.zIndex}).appendTo(c);return d}}),a.extend(b.prototype,{$el:null,$inputEl:null,completer:null,footer:null,header:null,id:null,maxCount:null,placement:"",shown:!1,data:[],className:"",destroy:function(){this.deactivate(),this.$el.off("."+this.id),this.$inputEl.off("."+this.id),this.clear(),this.$el.remove(),this.$el=this.$inputEl=this.completer=null,delete e[this.id]},render:function(b){var c=this._buildContents(b),d=a.map(b,function(a){return a.value});if(b.length){var e=b[0].strategy;e.id?this.$el.attr("data-strategy",e.id):this.$el.removeAttr("data-strategy"),this._renderHeader(d),this._renderFooter(d),c&&(this._renderContents(c),this._fitToBottom(),this._fitToRight(),this._activateIndexedItem()),this._setScroll()}else this.noResultsMessage?this._renderNoResultsMessage(d):this.shown&&this.deactivate()},setPosition:function(b){var d="absolute";return this.$inputEl.add(this.$inputEl.parents()).each(function(){return"absolute"===a(this).css("position")?!1:"fixed"===a(this).css("position")?(b.top-=c.scrollTop(),b.left-=c.scrollLeft(),d="fixed",!1):void 0}),this.$el.css(this._applyPlacement(b)),this.$el.css({position:d}),this},clear:function(){this.$el.html(""),this.data=[],this._index=0,this._$header=this._$footer=this._$noResultsMessage=null},activate:function(){return this.shown||(this.clear(),this.$el.show(),this.className&&this.$el.addClass(this.className),this.completer.fire("textComplete:show"),this.shown=!0),this},deactivate:function(){return this.shown&&(this.$el.hide(),this.className&&this.$el.removeClass(this.className),this.completer.fire("textComplete:hide"),this.shown=!1),this},isUp:function(a){return 38===a.keyCode||a.ctrlKey&&80===a.keyCode},isDown:function(a){return 40===a.keyCode||a.ctrlKey&&78===a.keyCode},isEnter:function(a){var b=a.ctrlKey||a.altKey||a.metaKey||a.shiftKey;return!b&&(13===a.keyCode||9===a.keyCode||this.option.completeOnSpace===!0&&32===a.keyCode)},isPageup:function(a){return 33===a.keyCode},isPagedown:function(a){return 34===a.keyCode},isEscape:function(a){return 27===a.keyCode},_data:null,_index:null,_$header:null,_$noResultsMessage:null,_$footer:null,_bindEvents:function(){this.$el.on("mousedown."+this.id,".textcomplete-item",a.proxy(this._onClick,this)),this.$el.on("touchstart."+this.id,".textcomplete-item",a.proxy(this._onClick,this)),this.$el.on("mouseover."+this.id,".textcomplete-item",a.proxy(this._onMouseover,this)),this.$inputEl.on("keydown."+this.id,a.proxy(this._onKeydown,this))},_onClick:function(b){var c=a(b.target);b.preventDefault(),b.originalEvent.keepTextCompleteDropdown=this.id,c.hasClass("textcomplete-item")||(c=c.closest(".textcomplete-item"));var d=this.data[parseInt(c.data("index"),10)];this.completer.select(d.value,d.strategy,b);var e=this;setTimeout(function(){e.deactivate(),"touchstart"===b.type&&e.$inputEl.focus()},0)},_onMouseover:function(b){var c=a(b.target);b.preventDefault(),c.hasClass("textcomplete-item")||(c=c.closest(".textcomplete-item")),this._index=parseInt(c.data("index"),10),this._activateIndexedItem()},_onKeydown:function(b){if(this.shown){var c;switch(a.isFunction(this.option.onKeydown)&&(c=this.option.onKeydown(b,f)),null==c&&(c=this._defaultKeydown(b)),c){case f.KEY_UP:b.preventDefault(),this._up();break;case f.KEY_DOWN:b.preventDefault(),this._down();break;case f.KEY_ENTER:b.preventDefault(),this._enter(b);break;case f.KEY_PAGEUP:b.preventDefault(),this._pageup();break;case f.KEY_PAGEDOWN:b.preventDefault(),this._pagedown();break;case f.KEY_ESCAPE:b.preventDefault(),this.deactivate()}}},_defaultKeydown:function(a){return this.isUp(a)?f.KEY_UP:this.isDown(a)?f.KEY_DOWN:this.isEnter(a)?f.KEY_ENTER:this.isPageup(a)?f.KEY_PAGEUP:this.isPagedown(a)?f.KEY_PAGEDOWN:this.isEscape(a)?f.KEY_ESCAPE:void 0},_up:function(){0===this._index?this._index=this.data.length-1:this._index-=1,this._activateIndexedItem(),this._setScroll()},_down:function(){this._index===this.data.length-1?this._index=0:this._index+=1,this._activateIndexedItem(),this._setScroll()},_enter:function(a){var b=this.data[parseInt(this._getActiveElement().data("index"),10)];this.completer.select(b.value,b.strategy,a),this.deactivate()},_pageup:function(){var b=0,c=this._getActiveElement().position().top-this.$el.innerHeight();this.$el.children().each(function(d){return a(this).position().top+a(this).outerHeight()>c?(b=d,!1):void 0}),this._index=b,this._activateIndexedItem(),this._setScroll()},_pagedown:function(){var b=this.data.length-1,c=this._getActiveElement().position().top+this.$el.innerHeight();this.$el.children().each(function(d){return a(this).position().top>c?(b=d,!1):void 0}),this._index=b,this._activateIndexedItem(),this._setScroll()},_activateIndexedItem:function(){this.$el.find(".textcomplete-item.active").removeClass("active"),this._getActiveElement().addClass("active")},_getActiveElement:function(){return this.$el.children(".textcomplete-item:nth("+this._index+")")},_setScroll:function(){var a=this._getActiveElement(),b=a.position().top,c=a.outerHeight(),d=this.$el.innerHeight(),e=this.$el.scrollTop();0===this._index||this._index==this.data.length-1||0>b?this.$el.scrollTop(b+e):b+c>d&&this.$el.scrollTop(b+c+e-d)},_buildContents:function(a){var b,c,e,f="";for(c=0;c<a.length&&this.data.length!==this.maxCount;c++)b=a[c],d(this.data,b)||(e=this.data.length,this.data.push(b),f+='<li class="textcomplete-item" data-index="'+e+'"><a>',f+=b.strategy.template(b.value,b.term),f+="</a></li>");return f},_renderHeader:function(b){if(this.header){this._$header||(this._$header=a('<li class="textcomplete-header"></li>').prependTo(this.$el));var c=a.isFunction(this.header)?this.header(b):this.header;this._$header.html(c)}},_renderFooter:function(b){if(this.footer){this._$footer||(this._$footer=a('<li class="textcomplete-footer"></li>').appendTo(this.$el));var c=a.isFunction(this.footer)?this.footer(b):this.footer;this._$footer.html(c)}},_renderNoResultsMessage:function(b){if(this.noResultsMessage){this._$noResultsMessage||(this._$noResultsMessage=a('<li class="textcomplete-no-results-message"></li>').appendTo(this.$el));var c=a.isFunction(this.noResultsMessage)?this.noResultsMessage(b):this.noResultsMessage;this._$noResultsMessage.html(c)}},_renderContents:function(a){this._$footer?this._$footer.before(a):this.$el.append(a)},_fitToBottom:function(){var a=c.scrollTop()+c.height(),b=this.$el.height();this.$el.position().top+b>a&&(this.completer.$iframe||this.$el.offset({top:a-b}))},_fitToRight:function(){for(var a,b=this.option.rightEdgeOffset,d=this.$el.offset().left,e=this.$el.width(),f=c.width()-b;d+e>f&&(this.$el.offset({left:d-b}),a=this.$el.offset().left,!(a>=d));)d=a},_applyPlacement:function(a){return-1!==this.placement.indexOf("top")?a={top:"auto",bottom:this.$el.parent().height()-a.top+a.lineHeight,left:a.left}:(a.bottom="auto",delete a.lineHeight),-1!==this.placement.indexOf("absleft")?a.left=0:-1!==this.placement.indexOf("absright")&&(a.right=0,a.left="auto"),a}}),a.fn.textcomplete.Dropdown=b,a.extend(a.fn.textcomplete,f)}(a),+function(a){"use strict";function b(b){a.extend(this,b),this.cache&&(this.search=c(this.search))}var c=function(a){var b={};return function(c,d){b[c]?d(b[c]):a.call(this,c,function(a){b[c]=(b[c]||[]).concat(a),d.apply(null,arguments)})}};b.parse=function(c,d){return a.map(c,function(a){var c=new b(a);return c.el=d.el,c.$el=d.$el,c})},a.extend(b.prototype,{match:null,replace:null,search:null,id:null,cache:!1,context:function(){return!0},index:2,template:function(a){return a},idProperty:null}),a.fn.textcomplete.Strategy=b}(a),+function(a){"use strict";function b(){}var c=Date.now||function(){return(new Date).getTime()},d=function(a,b){var d,e,f,g,h,i=function(){var j=c()-g;b>j?d=setTimeout(i,b-j):(d=null,h=a.apply(f,e),f=e=null)};return function(){return f=this,e=arguments,g=c(),d||(d=setTimeout(i,b)),h}};a.extend(b.prototype,{id:null,completer:null,el:null,$el:null,option:null,initialize:function(b,c,e){this.el=b,this.$el=a(b),this.id=c.id+this.constructor.name,this.completer=c,this.option=e,this.option.debounce&&(this._onKeyup=d(this._onKeyup,this.option.debounce)),this._bindEvents()},destroy:function(){this.$el.off("."+this.id),this.$el=this.el=this.completer=null},select:function(){throw new Error("Not implemented")},getCaretPosition:function(){var b=this._getCaretRelativePosition(),c=this.$el.offset(),d=this.option.appendTo;if(d){d instanceof a||(d=a(d));var e=d.offsetParent().offset();c.top-=e.top,c.left-=e.left}return b.top+=c.top,b.left+=c.left,b},focus:function(){this.$el.focus()},_bindEvents:function(){this.$el.on("keyup."+this.id,a.proxy(this._onKeyup,this))},_onKeyup:function(a){this._skipSearch(a)||this.completer.trigger(this.getTextFromHeadToCaret(),!0)},_skipSearch:function(a){switch(a.keyCode){case 9:case 13:case 16:case 17:case 18:case 33:case 34:case 40:case 38:case 27:return!0}if(a.ctrlKey)switch(a.keyCode){case 78:case 80:return!0}}}),a.fn.textcomplete.Adapter=b}(a),+function(a){"use strict";function b(a,b,c){this.initialize(a,b,c)}a.extend(b.prototype,a.fn.textcomplete.Adapter.prototype,{select:function(b,c,d){var e,f=this.getTextFromHeadToCaret(),g=this.el.value.substring(this.el.selectionEnd),h=c.replace(b,d);"undefined"!=typeof h&&(a.isArray(h)&&(g=h[1]+g,h=h[0]),e=a.isFunction(c.match)?c.match(f):c.match,f=f.replace(e,h),this.$el.val(f+g),this.el.selectionStart=this.el.selectionEnd=f.length)},getTextFromHeadToCaret:function(){return this.el.value.substring(0,this.el.selectionEnd)},_getCaretRelativePosition:function(){var b=a.fn.textcomplete.getCaretCoordinates(this.el,this.el.selectionStart);return{top:b.top+this._calculateLineHeight()-this.$el.scrollTop(),left:b.left-this.$el.scrollLeft(),lineHeight:this._calculateLineHeight()}},_calculateLineHeight:function(){var a=parseInt(this.$el.css("line-height"),10);if(isNaN(a)){var b=this.el.parentNode,c=document.createElement(this.el.nodeName),d=this.el.style;c.setAttribute("style","margin:0px;padding:0px;font-family:"+d.fontFamily+";font-size:"+d.fontSize),c.innerHTML="test",b.appendChild(c),a=c.clientHeight,b.removeChild(c)}return a}}),a.fn.textcomplete.Textarea=b}(a),+function(a){"use strict";function b(b,d,e){this.initialize(b,d,e),a("<span>"+c+"</span>").css({position:"absolute",top:-9999,left:-9999}).insertBefore(b)}var c="";a.extend(b.prototype,a.fn.textcomplete.Textarea.prototype,{select:function(b,c,d){var e,f=this.getTextFromHeadToCaret(),g=this.el.value.substring(f.length),h=c.replace(b,d);if("undefined"!=typeof h){a.isArray(h)&&(g=h[1]+g,h=h[0]),e=a.isFunction(c.match)?c.match(f):c.match,f=f.replace(e,h),this.$el.val(f+g),this.el.focus();var i=this.el.createTextRange();i.collapse(!0),i.moveEnd("character",f.length),i.moveStart("character",f.length),i.select()}},getTextFromHeadToCaret:function(){this.el.focus();var a=document.selection.createRange();a.moveStart("character",-this.el.value.length);var b=a.text.split(c);return 1===b.length?b[0]:b[1]}}),a.fn.textcomplete.IETextarea=b}(a),+function(a){"use strict";function b(a,b,c){this.initialize(a,b,c)}a.extend(b.prototype,a.fn.textcomplete.Adapter.prototype,{select:function(b,c,d){var e=this.getTextFromHeadToCaret(),f=this.el.ownerDocument.getSelection(),g=f.getRangeAt(0),h=g.cloneRange();h.selectNodeContents(g.startContainer);var i,j=h.toString(),k=j.substring(g.startOffset),l=c.replace(b,d);if("undefined"!=typeof l){a.isArray(l)&&(k=l[1]+k,l=l[0]),i=a.isFunction(c.match)?c.match(e):c.match,e=e.replace(i,l).replace(/ $/,"&nbsp"),g.selectNodeContents(g.startContainer),g.deleteContents();var m=this.el.ownerDocument.createElement("div");m.innerHTML=e;var n=this.el.ownerDocument.createElement("div");n.innerHTML=k;for(var o,p,q=this.el.ownerDocument.createDocumentFragment();o=m.firstChild;)p=q.appendChild(o);for(;o=n.firstChild;)q.appendChild(o);g.insertNode(q),g.setStartAfter(p),g.collapse(!0),f.removeAllRanges(),f.addRange(g)}},_getCaretRelativePosition:function(){var b=this.el.ownerDocument.getSelection().getRangeAt(0).cloneRange(),c=b.endContainer.parentNode,d=this.el.ownerDocument.createElement("span");b.insertNode(d),b.selectNodeContents(d),b.deleteContents(),setTimeout(function(){c.normalize()},0);var e=a(d),f=e.offset();if(f.left-=this.$el.offset().left,f.top+=e.height()-this.$el.offset().top,f.lineHeight=e.height(),this.completer.$iframe){var g=this.completer.$iframe.offset();f.top+=g.top,f.left+=g.left,f.top-=a(this.completer.$iframe[0].contentWindow.document).scrollTop()}return e.remove(),f},getTextFromHeadToCaret:function(){var a=this.el.ownerDocument.getSelection().getRangeAt(0),b=a.cloneRange();return b.selectNodeContents(a.startContainer),b.toString().substring(0,a.startOffset)}}),a.fn.textcomplete.ContentEditable=b}(a),+function(a){"use strict";function b(a,b,c){this.initialize(a,b,c)}a.extend(b.prototype,a.fn.textcomplete.ContentEditable.prototype,{_bindEvents:function(){var b=this;this.option.ckeditor_instance.on("key",function(a){var c=a.data;return b._onKeyup(c),b.completer.dropdown.shown&&b._skipSearch(c)?!1:void 0},null,null,1),this.$el.on("keyup."+this.id,a.proxy(this._onKeyup,this))}}),a.fn.textcomplete.CKEditor=b}(a),function(a){function b(a,b,f){if(!d)throw new Error("textarea-caret-position#getCaretCoordinates should only be called in a browser");var g=f&&f.debug||!1;if(g){var h=document.querySelector("#input-textarea-caret-position-mirror-div");h&&h.parentNode.removeChild(h)}var i=document.createElement("div");i.id="input-textarea-caret-position-mirror-div",document.body.appendChild(i);var j=i.style,k=window.getComputedStyle?getComputedStyle(a):a.currentStyle;j.whiteSpace="pre-wrap","INPUT"!==a.nodeName&&(j.wordWrap="break-word"),j.position="absolute",g||(j.visibility="hidden"),c.forEach(function(a){j[a]=k[a]}),e?a.scrollHeight>parseInt(k.height)&&(j.overflowY="scroll"):j.overflow="hidden",i.textContent=a.value.substring(0,b),"INPUT"===a.nodeName&&(i.textContent=i.textContent.replace(/\s/g,""));var l=document.createElement("span");l.textContent=a.value.substring(b)||".",i.appendChild(l);var m={top:l.offsetTop+parseInt(k.borderTopWidth),left:l.offsetLeft+parseInt(k.borderLeftWidth)};return g?l.style.backgroundColor="#aaa":document.body.removeChild(i),m}var c=["direction","boxSizing","width","height","overflowX","overflowY","borderTopWidth","borderRightWidth","borderBottomWidth","borderLeftWidth","borderStyle","paddingTop","paddingRight","paddingBottom","paddingLeft","fontStyle","fontVariant","fontWeight","fontStretch","fontSize","fontSizeAdjust","lineHeight","fontFamily","textAlign","textTransform","textIndent","textDecoration","letterSpacing","wordSpacing","tabSize","MozTabSize"],d="undefined"!=typeof window,e=d&&null!=window.mozInnerScreenX;a.fn.textcomplete.getCaretCoordinates=b}(a),a});

define('text!error_nofatal.mustache',[],function () { return '<div class="chat-error chat-error--nofatal">\n\t<button type="button" class="btn-close" aria-label="Close"></button>\n\t<p class="error-content">{{ content }}</p>\n\t<p class="error-source">{{ source }} {{# code}}({{ code }}){{/ code}}</p>\n</div>';});

// Fix Safari VH bug
try {
	$(window).on('resize', function() {
		var vh = window.innerHeight * 0.01;
		document.documentElement.style.setProperty('--vh', vh.toString(10) + 'px');
	});
	$(window).trigger('resize');
} catch (e) {
	//error
}

// Polyfill bind()
if(!Function.prototype.bind) {
	Function.prototype.bind = function (context) {
		var args = Array.prototype.slice.call(arguments, 1);
		var me = this; // the function being called
		return function () {
			return me.apply(context, new Array(args, arguments));
		}
	}
}

// Polyfill atob() [https://gist.github.com/EddyVerbruggen/8146fe5e1b8dfbf287b5f2be351045ed]
if (!window.atob) {
	function InvalidCharacterError(message) {
		this.message = message;
	}
	InvalidCharacterError.prototype = new Error ();
	InvalidCharacterError.prototype.name = 'InvalidCharacterError';

	// decoder
	// [https://gist.github.com/1020396] by [https://github.com/atk]
	function atob(input) {
		var chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=';

		var str = (String (input)).replace (/[=]+$/, ''); // #31: ExtendScript bad parse of /=
		if (str.length % 4 === 1) {
			throw new InvalidCharacterError ("'atob' failed: The string to be decoded is not correctly encoded.");
		}
		for (
			// initialize result and counters
			var bc = 0, bs, buffer, idx = 0, output = '';
			// get next character
			buffer = str.charAt (idx++); // eslint-disable-line no-cond-assign
			// character found in table? initialize bit storage and add its ascii value;
			~buffer && (bs = bc % 4 ? bs * 64 + buffer : buffer,
				// and if not first of each 4 characters,
				// convert the first 8 bits to one ascii character
			bc++ % 4) ? output += String.fromCharCode (255 & bs >> (-2 * bc & 6)) : 0
		) {
			// try to find character in table (0-63, not found => -1)
			buffer = chars.indexOf (buffer);
		}
		return output;
	}
}

define('chat/manager',['config/chat', 'lib/storage'], function(config, xv_storage) {

	if (!window.sheerChat) {		    window.sheerChat = {}	        }
	if (!window.sheerChat.infos) {	window.sheerChat.infos = {}	    }
	if (!window.sheerChat.actions) {	window.sheerChat.actions = {}    }

	var test_storage = xv_storage.get("chat_storage_test");
	if (!test_storage) {
		xv_storage.set("chat_storage_test", "1");
		xv_storage.remove("chat-display");
		xv_storage.remove("server_connection_time");
		xv_storage.remove("server_connection");
		xv_storage.remove("popup-crypt-old");
		xv_storage.remove("chat-size");
		xv_storage.remove("chat-color");
	}

	var display_error_without_connect = function( error_id, error_params ) {
		require([
			'mustache',
			'lib/helpers/overlay',
			'text!window_error.mustache',
			'lib/i18n!front'
		], function (Mustache, overlay, tpl_window_error, i18n) {

			var tpl_window_trad = { "xvideos_chat": i18n.__( "chat.infos.xvideos_chat" ) };
			var error_trad;
			if ( typeof error_params == "object" ) {
				error_trad = i18n.__( error_id, error_params );
			} else {
				error_trad = i18n.__( error_id );
			}

			var account_container = $("#account-chat-private-container");
			if ( account_container.length > 0 ) {
				var node = $(Mustache.render(tpl_window_error, { "window_class": "", "trad": tpl_window_trad } ));
				account_container.html( node );

				if ( node.height() > ( window.innerHeight - node.offset().top ) ) {
					node.height( window.innerHeight - node.offset().top );
				}

				overlay = overlay.get($('body > .chat-external-overlay-container'), false, 'hide');
				overlay.setContent('<h3>' + i18n.__('error') + '</h3><p>' + error_trad + '</p>').show();

			} else {
				// no friends + not account page + not profile page (if removed -> remove same thing on the beginning of user_connected
				if ( typeof config.nb_friends !== "undefined" && config.nb_friends == 0 &&
					(!config.hasOwnProperty('data') || !config.hasOwnProperty('user') || !config.user.hasOwnProperty('id_user') )
				) {
					node = $(Mustache.render(tpl_window_error, { "window_class": "chat-totaly-hidden", "trad": tpl_window_trad } )).appendTo("div#page");
				} else {
					node = $(Mustache.render(tpl_window_error, { "window_class": "chat-hidden", "trad": tpl_window_trad } )).appendTo("div#page");
				}

				overlay = overlay.get($('body > .chat-external-overlay-container'), false, 'hide');
				overlay.setContent('<h3>' + i18n.__('error') + '</h3><p>' + error_trad + '</p>').show();

				$('.chat-title').on('click', function() {
					node.toggleClass('chat-hidden');
				});
			}

		});
	};

	if (!config.enabled) {
		return;
	}

	if (!config.login_info.is_logged) {
		xv_storage.remove("chat-pk");
	}

	//not logged && not on a profile page
	if ( !config.login_info.is_logged && ( !config.user || !config.user.show_mini_chat ) ) {
		console.log("no chat if !logged and not a profile page with recent chat interaction");
		return;
	}

	// mini chat disabled
	if ( $("#account-chat-private-container").length === 0 && typeof config.prefs !== 'undefined' && config.prefs.mini_disabled == 1) {
		console.log("mini chat has been disabled");
		return;
	}

	// not the account page
	var browser_ok = true;

	if ( !window.WebSocket ) {
		browser_ok = false;
		if ( typeof navigator.userAgent !== "undefined" && /safari/i.test(navigator.userAgent) ) {
			var version = navigator.userAgent.match(/version\/(\d+)/i);
			if (version != null && typeof version[1] != "undefined" && parseInt(version[1]) >= 4) {
				browser_ok = true;
			}
		}

		if ( typeof navigator.userAgent !== "undefined" && /MSIE/i.test(navigator.userAgent) ) {

			version = navigator.userAgent.match(/MSIE\s(\d+)/i);
			if ( version !== null && typeof version[1] !== "undefined" && parseInt(version[1]) >= 9 ) {
				browser_ok = true;
			}
		}

		if ( $("#account-chat-private-container").length === 0 && !browser_ok ) {
			console.log("Browser doesn't support Websocket");
			return;
		}
	}

	var require_libs_done = false;

	require([
		'mustache',
		'lib/cookies',
		'lib/socket_queue_manager',
		'lib/emoji',
		'lib/storage',
		'lib/tools',
		'lib/helpers/events',
		'lib/helpers/inline_loader',
		'lib/helpers/overlay',
		'lib/helpers/overlay/contextual_popup',
		'lib/helpers/popup/contextual_menu',
		'libs/socket.io',
		'text!avatar.mustache',
		'text!get_history.mustache',
		'text!icon_sprite.mustache',
		'text!message.mustache',
		'text!message_inside.mustache',
		'text!message_quote.mustache',
		'text!message_edit.mustache',
		'text!window.mustache',
		'text!system_message.mustache',
		'text!textarea_error_popup.mustache',
		'lib/i18n!front',
		'lib/utils',
		'libs/c3r18y25p16t',
		'internal_message',
		'log_and_tooltip',
		'chat_inits',
		'ChatContext',
		'chat/ManagerEvent',
		'chat/attachment/attachment_manager',
		'chat/select_contacts/select_contacts',
		'chat/select_messages/select_messages',
		'chat/scroll_conversation/scroll_conversation',
		'chat/upload/upload_default',
		'chat/upload/upload_dropzone',
		'chat/setting/profile/profile',
		'chat/setting/hiddenUsers/hiddenUsers',
		'chat/content/content',
		'chat/content/vault',
		'chat_friends_manager',
		'chat_friend_action',
		'services/SocketConnection',
		'features/FanInfo/directives/FanInfoSendMessage',
		'features/CreatorMessages/MassMessage/events/MassMessageEvent',
		'features/CreatorMessages/AutoMessage/events/AutoMessageEvent',
		'features/Message/events/MessageEvent',
		'features/Message/ReportMessage',
		'features/Message/SFWMessage',
		'features/Message/utils/ForwardMessage',
		'features/Message/utils/Message',
		'features/Reminder/events/ReminderEvent',
		'features/Settings/events/SettingsEvent',
		'features/Studio/events/StudioEvent',
		'features/Draft/events/DraftEvent',
		'features/ContactList/events/ContactListEvent',
		'features/ContactList/CustomerList/events/CustomerListEvent',
		'features/ContactList/FollowerList/events/FollowerListEvent',
		'features/ContactList/SupportList/events/SupportListEvent',
		'jquery-scrollLock',
		'jquery.textcomplete.min'
	], function (
		Mustache,
		cookies,
		socket_queue_manager,
		emoji,
		storage,
		tools,
		events,
		inline_loader,
		overlay,
		contextual_popup,
		contextual_menu,
		io,
		tpl_avatar,
		tpl_get_history,
		tpl_icon_sprite,
		tpl_message,
		tpl_message_inside,
		tpl_message_quote,
		tpl_message_edit,
		tpl_window,
		tpl_system_message,
		tpl_textarea_error_popup,
		i18n,
		utils,
		cryptojs,
		chat_internal_message,
		log_and_tooltip,
		ChatInitsAndPrefs,
		ChatContext,
		ManagerEvent,
		attachment_manager,
		select_contacts,
		select_messages,
		ScrollConversation,
		UploadDefault,
		UploadDropzone,
		Profile,
		HiddenUsers,
		Content,
		Vault,
		ChatFriendManager,
		ChatFriendAction,
		SocketConnection,
		FanInfoSendMessage,
		MassMessageEvent,
		AutoMessageEvent,
		MessageEvent,
		ReportMessage,
		SFWMessage,
		ForwardMessageUtils,
		MessageUtils,
		ReminderEvent,
		SettingsEvent,
		StudioEvent,
		DraftEvent,
		ContactListEvent,
		CustomerListEvent,
		FollowerListEvent,
		SupportListEvent,
	) {
		require_libs_done = true;
		var uploaders = {};

		var manager = function (debug) {
			window.chatLogout = this.user_logout.bind(this);
			this.chatContext = new ChatContext();
			this.chatContext.setManager(this);
			this.chatContext.on(StudioEvent.LOAD_STUDIO, this.load_studio, this);
			this.url_base_profile = config.domains.slave + '/';
			if ( window.location.href.indexOf(config.domains.premium) >= 0 ) {
				this.url_base_profile = config.domains.premium + '/';
			}

			this.sound_file = config.domains.static + "/audio/notif1.mp3";

			this.friends_infos_from_SW = null;
			this.connect_done = false;
			this.init_connect_and_contacts = false;

			this.force_friend = 0;

			this.cookie_deco_name = "chat_deco";
			// time in ms
			this.interval_check_deco = 3000;
			this.interval_check_nb_user = 120000;
			this.interval_check_nb_user_function = null;

			this.timeout_reconnect = null;

			this.verif_connection_done = 0;

			this.is_retrying = false;
			this.retry_timer = null;
			this.retry_attempt = 0;

			this.messages = [];
			this.messagesBatch = 40;
			this.messagesLoadedCount = {};
			this.idMassMessage = null;

			this.tabVisible = document.visibilityState === 'visible';
			this.tabQueue = [];

			this.creator_messages_access = !!config.login_info.is_creator;

			//debug on id
			log_and_tooltip.init(debug, 47530703);

			this.display_message_old_browser = false;

			this.shift_key_hold = false;

			this.last_iud_received = null;

			this.first_customers_load = true;

			this.chat_send_file = null;
			this.chat_send_file_available = false;
			this.content = null;
			this.vault = null;

			storage.set("chat_failed_attempts", {});
			storage.remove('get_users_infos_queues');

			// if a message receive before time_for_message_group seconds after the last, we'll group this 2 messages
			this.time_for_message_group = 60;

			this.chatInitsAndPrefs = new ChatInitsAndPrefs(this.change_status.bind(this));

			this.initUploaderAndVault();

			// !loggued
			if ( !config.login_info.is_logged ) {
				this.initNode();
				this.chatInitsAndPrefs.initSettings(this.change_status.bind(this),
					this.emit_change_prefs.bind(this),
					this.toggle_home.bind(this),
					this.chat_icon_home,
					this.node,
					this.setSwToken.bind(this),
					this.remove_SW_token.bind(this));

				$("#chat-option-notification").hide();
				$("#chat-option-mini-disabled").hide();

				var friend = {};
				friend.nb_unread = 0;
				friend.profile_name = config.user.display;
				friend.is_favorite = false;
				friend.status = "Online";
				friend.selected = true;
				friend.id_user = config.user.id_user;
				friend.profile_picture = config.user.profile_picture_small;

				// this.chat_friend_manager.userlistinbox.append(this.chat_friend_manager.add_friend_html(friend, "offline"));

				$("#chat-home p").hide();

				// @TODO Login form? Display message?
				// require(['skins/default/form/login'], function(login_form) {
				// 	login_form.setupLinks($('<h4 class="text-danger">' + i18n.__('chat.must_have_account') + ' <a class="text-danger">' + i18n.__('misc.click_here_login_create_account') + '</a></h4>')
				// 		.appendTo( $("#chat-home"))
				// 		.children('a').on("click", function(){self.chat_toggle_display();}) );
				// });

				return;
			}

			if (window.location.protocol.toLowerCase() == "http:") {
				this.initNode();
				this.chatInitsAndPrefs.initSettings(this.change_status.bind(this),
					this.emit_change_prefs.bind(this),
					this.toggle_home.bind(this),
					this.chat_icon_home,
					this.node,
					this.setSwToken.bind(this),
					this.remove_SW_token.bind(this));
				this.no_https = true;

				$("#chat-option-notification").hide();
				$("#chat-option-mini-disabled").hide();
				$("#chat_loading_overlay").hide();

				if (config.no_support_SSL !== "undefined" &&  config.no_support_SSL === true) {
					wglog.error('NOT HTTPS && no support HTTPS');
					log_and_tooltip.write_error( {logTitle: 'manager::constructor https not supported', logMessage:'Https not supported', message: i18n.__('chat.https_not_supported')});
					return;
				}

				var link_https = window.location.href.replace("http://", "https://");
				wglog.error('NOT HTTPS -> need reload');
				log_and_tooltip.write_error( {
					logTitle: 'manager::constructor reload required for https use',
					logMessage: 'Need https reload',
					message: i18n.__('chat.need_https_reload'),
					type: 'alert',
					text_ok: i18n.__('misc.reload_with_https'),
					on_ok: function () { window.location.href = link_https; }
				});
				return;
			}

			this.priv_key = this.chatInitsAndPrefs.initKey();
			if ( this.priv_key == false ) {
				wglog.error("no private key in local");
				this.no_priv_key = true;
				this.priv_key = "";
			}

			if (!"serviceWorker" in navigator || typeof navigator.serviceWorker === "undefined" || this.no_priv_key) {
				try {
					this.initNode();
					this.chatInitsAndPrefs.initSettings(this.change_status.bind(this),
						this.emit_change_prefs.bind(this),
						this.toggle_home.bind(this),
						this.chat_icon_home,
						this.node,
						this.setSwToken.bind(this),
						this.remove_SW_token.bind(this));

					if( window.SharedWorker ){
						try {
							this.chatInitsAndPrefs.initSharedWorker(this.connect.bind(this),
								this.connect_SW.bind(this),
								this.reinitChat.bind(this));
							if ( typeof this.shared_worker_no_support == "undefined" || this.shared_worker_no_support !== true ) {
								if ( document.visibilityState == "visible" && typeof this.chatInitsAndPrefs.shared_worker != "undefined" && typeof this.chatInitsAndPrefs.shared_worker.port != "undefined" ) {
									this.chatInitsAndPrefs.shared_worker.port.postMessage( { "action": "focus" } );
									connect_to_do = false;
								}
							}
							this.connect();
						} catch (e) {
							wglog.error('init (no SW / w shared', e);
							this.connect();
						}
					} else {
						this.connect();
					}
				} catch (e) {
					wglog.error("inits failed (no SW)", e.message);
					this.connect();
				}
				return;
			}

			try {
				this.initNode();
				this.chatInitsAndPrefs.initNotif(this.inputnotif);
				this.chatInitsAndPrefs.initSettings(this.change_status.bind(this),
					this.emit_change_prefs.bind(this),
					this.toggle_home.bind(this),
					this.chat_icon_home,
					this.node,
					this.setSwToken.bind(this),
					this.remove_SW_token.bind(this));
			} catch (e) {
				wglog.debug("first inits failed -> stop loading chat", e.message + "\n" + e.stack);
			}

			try {
				this.chatInitsAndPrefs.initSharedWorker(this.connect.bind(this),
					this.connect_SW.bind(this),
					this.reinitChat.bind(this));
				this.chatInitsAndPrefs.initServiceWorker(this.connect.bind(this),
					this.connect_SW.bind(this),
					this.serviceWorkerOnMessage.bind(this),
					this.setSwToken.bind(this));

			} catch (e) {
				wglog.debug("workers inits failed -> launch connect manually", e.message);
				this.connect();
			}

			this.chatContext.emit(DraftEvent.CREATE_STORE);
		};

		manager.prototype = {
			initUploaderAndVault: function(fnCallback) {
				if (!!this.chat_send_file && !!this.content && !!this.vault) {
					if (!this.chat_send_file_available) {
						return false;
					}
					return true;
				}

				this.chat_send_file = this.get_uploader_instance();

				this.content = new Content();
				this.content.setEmptyMessageForm(this.empty_message_form.bind(this));
				this.content.setMessageEncrypter(this.make_real_message.bind(this));
				this.content.setMessageProvider(this.get_input_value.bind(this));

				this.vault = new Vault();
				this.vault.setEmptyMessageForm(this.empty_message_form.bind(this));
				this.vault.setMessageEncrypter(this.make_real_message.bind(this));
				this.vault.setMessageProvider(this.get_input_value.bind(this));

				if (!!this.socket_connection) {
					this.chat_send_file.init_socket(this.socket_connection);
					this.content.setSocket(this.socket_connection);
					this.vault.setSocket(this.socket_connection);
				}

				if (!!this.chat_friend_manager) {
					this.content.setMessageFormActivation(this.chat_friend_manager.setMessageFormState.bind(this.chat_friend_manager));
					this.content.setSelectedFriendIdProvider(this.chat_friend_manager.get_selected_friend_id.bind(this.chat_friend_manager));
					this.vault.setMessageFormActivation(this.chat_friend_manager.setMessageFormState.bind(this.chat_friend_manager));
					this.vault.setSelectedFriendIdProvider(this.chat_friend_manager.get_selected_friend_id.bind(this.chat_friend_manager));
				}

				attachment_manager.setService('local', {
					instance: this.chat_send_file,
					label: i18n.__('chat.local_file'),
					icon: '#scc-file-sharing-icon',
					isActive: true,
					isDefault: true
				});
				attachment_manager.setService('content', {
					instance: this.content,
					label: i18n.__('chat.content'),
					icon: '#scc-safe-icon'
				});
				attachment_manager.setService('vault', {
					instance: this.vault,
					label: i18n.__('chat.vault'),
					icon: '#scc-safe-icon'
				});

				if (config.file_upload.method === "default") {
					this.chat_send_file.init_input_file();
					if (typeof window.xv === "object" &&
						typeof window.xv.messages === "object" &&
						typeof window.xv.messages.setMessageNextToChat === "function"
					) {
						window.xv.messages.setMessageNextToChat();
					}

					this.chat_send_file.init_drag_drop();
				}

				if (typeof fnCallback === 'function') {
					fnCallback();
				}
			},

			replaceUploadElements: function() {
				var attachmentBtnPlaceholder = $('.attachment-button-placeholder'),
					attachmentFieldsPlaceholder = $('.attachment-fields-placeholder');

				if (attachmentBtnPlaceholder.length === 0 && attachmentFieldsPlaceholder.length === 0) {
					return;
				}

				attachmentBtnPlaceholder.replaceWith(attachment_manager.getMessageFormButton());
				attachmentFieldsPlaceholder.replaceWith(attachment_manager.getMessageFormFields());

				if (config.file_upload.method === "dropzone") {
					this.chat_send_file_available = this.chat_send_file.init() !== false;
				}

				attachment_manager.addMessageFormFieldsListeners();
			},

			initNode: function() {
				var tpl_window_trad = {};
				tpl_window_trad.xvideos_chat 					= i18n.__('chat.infos.window_title');
				tpl_window_trad.small_size 						= i18n.__('chat.settings.small_size');
				tpl_window_trad.medium_size 					= i18n.__('chat.settings.medium_size');
				tpl_window_trad.big_size 						= i18n.__('chat.settings.big_size');
				tpl_window_trad.sound 							= i18n.__('chat.settings.sound');
				tpl_window_trad.notifications 					= i18n.__('chat.settings.notifications');
				tpl_window_trad.creator_settings			    = i18n.__('chat.settings.creator_settings');
				tpl_window_trad.disable_mini_chat 				= i18n.__('chat.settings.disable_mini_chat');
				tpl_window_trad.welcome 						= i18n.__('chat.infos.welcome', { "%website_name%": config.i18n_website_name });
				tpl_window_trad.still_working 					= i18n.__('chat.infos.still_working');
				tpl_window_trad.textarea_message_placeholder 	= i18n.__('chat.textarea_message_placeholder');
				tpl_window_trad.message_send 					= i18n.__('chat.message_send');
				tpl_window_trad.input_search_placeholder 		= i18n.__('chat.input_search_placeholder');
				tpl_window_trad.button_search_friends 			= i18n.__('chat.button_search_friends');
				tpl_window_trad.loading 						= i18n.__('loading.loading');
				tpl_window_trad.chat_size      					= i18n.__('chat.chat_size');
				tpl_window_trad.status      					= i18n.__('chat.status');
				tpl_window_trad.status_online 					= i18n.__('chat.status.online');
				tpl_window_trad.status_away 					= i18n.__('chat.status.away');
				tpl_window_trad.status_invisible				= i18n.__('chat.status.invisible');
				tpl_window_trad.crypt_home						= i18n.__('chat.crypt_home');
				tpl_window_trad.new_feature						= i18n.__('chat.new_feature');
				tpl_window_trad.all_conv_encrypted 				= i18n.__('chat.all_conv_encrypted');
				tpl_window_trad.crypt_enabling					= i18n.__('chat.crypt_enabling', { "%website_name%": config.i18n_website_name });
				tpl_window_trad.crypt_even_for_us				= i18n.__('chat.crypt_even_for_us');
				tpl_window_trad.friend_requests					= i18n.__('chat.infos.friend_requests');
				tpl_window_trad.friend_requests_sent			= i18n.__('chat.infos.friend_requests_sent');
				tpl_window_trad.blur_image						= i18n.__('chat.blur_option');
				tpl_window_trad.chat_settings					= i18n.__('chat.chat_settings');
				tpl_window_trad.contacts                        = i18n.__('chat.contacts');
				tpl_window_trad.inbox                           = config.login_info.is_creator ? i18n.__('chat.friends_costumers') : i18n.__('chat.inbox'); //@TODO UPDATE TRAD KEY customers
				tpl_window_trad.color_theme                     = i18n.__('chat.color_theme');
				tpl_window_trad.close                           = i18n.__('misc.close');
				tpl_window_trad.tab_label_file_upload           = i18n.__('chat.local_file');
				tpl_window_trad.tab_label_vault                 = i18n.__('chat.vault');
				tpl_window_trad.support_button_label            = i18n.__('chat.contact_sheer_support');
				tpl_window_trad.mass_message 					= i18n.__('chat.mass_message');
				tpl_window_trad.auto_message 					= i18n.__('chat.auto_message');
				tpl_window_trad.silent_ppv 						= i18n.__('chat.silent');
				tpl_window_trad.manager 						= i18n.__('chat.manager');
				tpl_window_trad.message_editing				    = i18n.__('chat.message_editing');

				if (config.settings_menu_items.color_switch_enabled && config.settings_menu_items.color_switch_colors instanceof Array) {
					for (var index in config.settings_menu_items.color_switch_colors) {
						var color = config.settings_menu_items.color_switch_colors[index];
						if (color.hasOwnProperty('i18n') && typeof color.i18n === "string") {
							config.settings_menu_items.color_switch_colors[index].i18n = i18n.__(color.i18n);
						}
					}
				} else {
					config.settings_menu_items.color_switch_colors = [];
				}

				var window_class = "chat-hidden",
					window_container = $("div#page"),
					account_container = $("#account-chat-private-container"),
					account_chat_container = false;

				if ( account_container.length > 0 ) {
					account_chat_container = true;
					window_class = "";
					window_container = account_container;
				} else {
					// no friends + not account page + not profile page (if removed -> remove same thing on the beginning of user_connected
					if ( typeof config.nb_friends !== "undefined"
						&& config.nb_friends == 0
						&& (!config.hasOwnProperty('data') || !config.hasOwnProperty('user') || !config.user.hasOwnProperty('id_user') )
					) {
						window_class = "chat-totaly-hidden";
					}
				}

				// Here we hide search form.
				if (config.sidebar_feature.search_form_enabled && typeof config.sidebar_feature.search_form_limited_to === 'array' && config.sidebar_feature.search_form_limited_to.length) {
					if (config.login_info.is_fan && config.sidebar_feature.search_form_limited_to.indexOf('fan') === -1) {
						config.sidebar_feature.search_form_enabled = false;
					} else if (config.login_info.is_creator && config.sidebar_feature.search_form_limited_to.indexOf('creator') === -1) {
						config.sidebar_feature.search_form_enabled = false;
					} else if (config.login_info.is_support && config.sidebar_feature.search_form_limited_to.indexOf('support') === -1) {
						config.sidebar_feature.search_form_enabled = false;
					}
				}

				if (config.login_info.is_support && config.settings_menu_items.status_switch_enabled) {
					config.settings_menu_items.status_switch_enabled = false;
				}

				$(window_container).append(Mustache.render(tpl_icon_sprite));

				this.initUploaderAndVault();

				this.node = $(Mustache.render(tpl_window, {
					"window_class": window_class,
					"sound_file": this.sound_file,
					"trad": tpl_window_trad,
					"is_dev": config.is_dev,
					"is_fan": config.login_info.is_fan,
					"contact_count": this.nb_friends,
					"is_creator": config.login_info.is_creator,
					"is_support": config.login_info.is_support,
					"sidebar_feature": config.sidebar_feature,
					"settings_menu_items": config.settings_menu_items,
					"friend_request_enabled": config.friend_request_enabled,
					"attachment_button": attachment_manager.getMessageFormButton(),
					"attachment_fields": attachment_manager.getMessageFormFields(),
					"chat_log_debug_on": xv_storage.get("chat_log_debug_on"),
					// See also updateSupportToggler
					"display_support_toggler": !config.login_info.is_fan
					})).appendTo(window_container);

				if (!$('body > .chat-external-overlay-container').length) {
					$('<div id="chat-external-overlay-container" class="chat-external-overlay-container"></div>').appendTo('body');
				}

				this.chatContext.emit(ManagerEvent.NODE_CREATED, this.node.get(0));

				$(document).on('click', '[data-toggle]', function () {
					var className = 'chat-toggle--show',
						activeClassName = 'active',
						disabledClassName = 'disabled',
						selector = $(this).data('toggle'),
						group = $(this).data('group');

					if (group) {
						$('[data-group=' + group + ']').each(function () {
							var toggler = $(this),
							    target = $(this).data('toggle');
							if (toggler.is(':disabled') ||  toggler.hasClass(disabledClassName)) {
								return;
							}

							if (typeof this.dataset.closable !== "undefined" && $(target).hasClass(className)) {
								$(this).removeClass(activeClassName);
								$(target).removeClass(className);
							} else {
								if ($(target).hasClass(className)) {
									$(this).removeClass(activeClassName);
									$(target).removeClass(className);
								}
								if (target === selector) {
									$(this).toggleClass(activeClassName);
									$(selector).addClass(className);
								}
							}

						});
					} else {
						var toggler = $('[data-toggle="' + selector + '"]');
						if (toggler.is(':disabled') ||  toggler.hasClass(disabledClassName)) {
							return;
						}
						toggler.toggleClass(activeClassName);
						$(selector).toggleClass(className);
					}
				});

				$('.chat-sidebar__search-open').on('click', this.search_input_focus.bind(this));

				if (window.IntersectionObserver) {
					this.message_intersection_observer = new IntersectionObserver(this.message_intersection_observer_cb.bind(this), {
						root: this.node.find('.chat-messages').get(0),
						threshold: 1
					});
				}

				var self = this;
				if ($.fn.emojioneArea) {
					$("#chat-textarea-message").emojioneArea({
						hideSource: true,
						useInternalCDN: true,
						sprite: true,
						autocomplete: false,
						container: '#container-emojionearea',
						textcomplete: {
							maxCount: 12
						},
						attributes: {
							spellcheck: true,
							autocomplete: "on",
							autocorrect: "on"
						},
						events: {
							ready: function (editor) {
								editor.on('textComplete:show', function () {
									self.emoji_autocomplete_visible = true;
								});
								editor.on('textComplete:hide', function () {
									self.emoji_autocomplete_visible = false;
								});
							},
							paste: function () {
								self.scroll_to_caret();
							},
							keydown: function (editor, event) {
								self.key_down(event, editor);
							},
							keyup: function (editor, event) {
								self.key_pressed(event, editor);
							},
							focus: function(editor) {
								var range = document.createRange();
								var sel = window.getSelection();

								range.selectNodeContents(editor[0]);
								range.collapse(false);
								sel.removeAllRanges();
								sel.addRange(range);

								var quoteForm = editor.closest('#container-emojionearea').siblings('.chat-quote--form');
								if (quoteForm.length) {
									quoteForm.addClass('chat-quote--form-focused');
								}
							},
							blur: function(editor) {
								var quoteForm = editor.closest('#container-emojionearea').siblings('.chat-quote--form');
								if (quoteForm.length) {
									quoteForm.removeClass('chat-quote--form-focused');
								}
							}
						}
					});

					$(window).on('resize', function (event) {
						$('#chat-textarea-message').trigger('input');
					});
				}

				this.title = this.node.find('.chat-title');

				if ( !account_chat_container ) {
					this.title.on('click', this.chat_toggle_display.bind(this));
				}

				if (config.is_dev) {
					$("#chat-setting-debug").prop("checked", xv_storage.get("chat_log_debug_on") === true);
					$("#chat-setting-debug").on('change', function(event) {
						event.stopPropagation();

						var chat_log_debug_on = $("#chat-setting-debug").prop("checked") ? 1 : 0;

						xv_storage.set("chat_log_debug_on", chat_log_debug_on);
						log_and_tooltip.set_log_debug(chat_log_debug_on);
					});
				}

				this.msglist = this.node.find('.chat-messages');
				this.input = this.node.find('textarea');
				this.inputnotif = this.node.find('#chat_checkbox_notif');
				this.inputsound = this.node.find('#chat_checkbox_sound');
				this.chat_icon_home = this.node.find(".chat-icon-home");

				this.opened = false;

				if ( !browser_ok && $("#account-chat-private-container").length > 0 ) {
					wglog.error('Old browser');
					$("#chat_loading_overlay").hide();
					log_and_tooltip.write_error_old_browser();
					this.display_message_old_browser = true;
				}

				//this.interval_refresh_messages_rt = setInterval(this.refresh_messages_rt.bind(this), 60000);

				this.chat_friend_action = new ChatFriendAction(
					this.chatInitsAndPrefs,
					this.url_base_profile,
					this.chat_icon_home,
					this.msglist,
					this.get_conversation.bind(this),
					this.getContactListTypeAndEvents.bind(this),
					this.chatContext
				);
				this.chat_friend_manager = new ChatFriendManager(
					this.chatInitsAndPrefs,
					this.chat_friend_action,
					this.chat_send_file,
					this.priv_key,
					this.node,
					this.url_base_profile,
					this.empty_message_form.bind(this),
					this.get_conversation.bind(this),
					this.get_real_message.bind(this),
					this.make_real_message.bind(this),
					this.set_read_date_v2.bind(this),
					this.get_users_infos_enqueue.bind(this),
					this.initUploaderAndVault.bind(this, this.replaceUploadElements.bind(this)),
					this.getContactListTypeAndEvents.bind(this),
					this.input,
					this.content,
					this.vault,
					this.chatContext);

				this.content.setChatFriendManager(this.chat_friend_manager);
				this.vault.setChatFriendManager(this.chat_friend_manager);

				this.chat_friend_action.set_chat_friend_manager( this.chat_friend_manager );
				this.chatContext.setChatFriendManager(this.chat_friend_manager);

				if (!!this.chat_send_file && config.file_upload.method === "dropzone") {
					this.chat_send_file_available = this.chat_send_file.init() !== false;
					this.chat_send_file.set_chat_friend_manager(this.chat_friend_manager);
				}

				if ($('.attachment-button-placeholder').length === 0 && $('.attachment-fields-placeholder').length === 0) {
					attachment_manager.addMessageFormFieldsListeners();
				}

				if (config.cookie_expires) {
					this.setup_refresh_cookie();
				}

				events.addListener(events.TAB_VISIBLE, function() {
					self.tabVisible = true;
					self.execTabQueue();
				});
				events.addListener(events.TAB_HIDDEN, function() {
					self.tabVisible = false;
				});
				document.addEventListener('url-in-message-replaced', this.onUrlInMessageReplaced.bind(this));
			},

			execTabQueue: function() {
				if (this.tabQueue.length === 0) {
					return;
				}

				while (this.tabQueue.length > 0) {
					if (typeof this.tabQueue[0] === 'function') {
						this.tabQueue[0]()
					}
					this.tabQueue.shift();
				}
			},

			onUrlInMessageReplaced: function (event) {
				if (!config.login_info.is_fan && !event.detail || !event.detail.message || (!event.detail.message.dataset.am && !event.detail.message.dataset.mm)) {
					return;
				}

				var amId = event.detail.message.dataset.am,
					mmId = event.detail.message.dataset.mm,
					self = this;

				if (!amId && !mmId) {
					return;
				}

				event.detail.links.forEach(function(a) {
					var socketEvent = 'update_stats';

					if (amId) {
						socketEvent += '_auto_message';
					} else if (mmId) {
						socketEvent += '_mass_message';
					}

					$(a).off('click.' + socketEvent);
					$(a).on('click.' + socketEvent, function() {
						self.socket_connection.emit(socketEvent, {
							stats: 'link_clicked',
							auto_message_id: amId,
							mass_message_id: mmId
						});
					});
				});
			},

			reinitChat: function() {
				this.reinit = true;

				this.chat_toggle_display( false, true );

				this.connect_done = false;
				if ( this.cookie_deco_name ) {
					clearInterval( this.check_deco_interval );
					delete this.cookie_deco_name;
				}
				if ( this.socketMaster ) {
					this.socketMaster.disconnect();
				}
				if ( this.socket_connection ) {
					this.socket_connection.disconnect();
				}

				$(".chat_tab_container").remove();

				$(".chat-window").removeClass("chat-window--home").addClass("chat-window--home");

				this.input.val("");
				this.chat_friend_manager.setMessageFormState(true);
				this.chat_friend_manager.search_input.prop('disabled', true);
				this.chat_friend_manager.search_input.val("");
				this.chat_friend_manager.search_button.prop('disabled', true);

				if ( this.interval_check_nb_user_function != null ) {
					clearInterval(this.interval_check_nb_user_function);
					this.interval_check_nb_user_function = null;
				}
			},

			serviceWorkerOnMessage: function (event) {
				if (typeof event.data.action === "undefined") {
					return;
				}
				if (event.data.action === "selectFriend" && typeof event.data.userId !== "undefined") {
					if (typeof this.chat_friend_manager.friends[event.data.userId] === "undefined") {
						wglog.debug("click on notif from an unknown friend. Ask for informations for user " + event.data.userId);
						this.socket_connection.emit("getuserinfos", {
							'friend_id': event.data.userId,
							'callback_obj': {"open_tab": true}
						});
						return;
					}
					this.chat_toggle_display(true);
					this.chat_friend_manager.select_friend(event.data.userId);
				}
			},

			connect_SW: function() {
				if (!this.chatInitsAndPrefs.serviceWorker) {
					wglog.debug("manager::connect_SW no serviceWorker");
					this.connect();
					return;
				}

				this.chatInitsAndPrefs.serviceWorker.postMessage({"action": "set_config", "config": this.chatInitsAndPrefs.getServiceWorkerConfig()});
				var self = this;
				new Promise(function (resolve, reject) {
					// Create a Message Channel
					var msg_chan = new MessageChannel();

					// Handler for recieving message reply from service worker
					msg_chan.port1.onmessage = function (event) {
						if (event.data.error) {
							reject(event.data.error);
							return;
						}

						if (typeof event.data.connected === "undefined" || event.data.connected !== "ok") {
							reject("sw connect failed");
							return;
						}

						// if (typeof event.data.friends_ids === "undefined") {
						// 	reject("no friends ids return");
						// 	return;
						// }

						// if (typeof event.data.friends_infos === "undefined") {
						// 	reject("no first friends infos");
						// 	return;
						// }

						var chat_display = false;
						if (typeof event.data.chat_display === "boolean" ) {
							chat_display = event.data.chat_display;
						}

						var last_friend_conv = 0;
						if ( typeof event.data.last_friend_conv !== "undefined" && parseInt(event.data.last_friend_conv) > 0 ) {
							last_friend_conv = event.data.last_friend_conv;
						}

						resolve({
							"friends_ids": event.data.friends_ids || [],
							"friends_infos": event.data.friends_infos || {},
							"chat_display": chat_display,
							"last_friend_conv": last_friend_conv,
							"last_set_friend": event.data.last_set_friend
						});
					};

					// Send message to service worker along with port for reply
					self.chatInitsAndPrefs.serviceWorker.postMessage({
						"action": "connect_sw",
						"id_user": config.login_info.id
					}, [msg_chan.port2]);

					// Set up a timeout
					var ms = 4000;
					setTimeout(function () {
						reject('connect_sw timed out after ' + ms + ' ms');
					}, ms);

				}).then(function (data) {
					var expired = Date.now() - (24 * 60 * 60 * 1000);
					if (typeof data.last_set_friend !== "undefined" && data.last_set_friend && data.last_set_friend > expired) {
						self.chat_friend_manager.set_friends_id(data.friends_ids);
						self.friends_infos_from_SW = data.friends_infos;
					} else {
						wglog.debug("manager::connect_SW SW friends data expired");
					}
					if (!!data.last_friend_conv && !!self.force_friend) {
						self.last_friend_conv = data.last_friend_conv;
					}

					self.connect();
				})["catch"](function (err) {
					wglog.debug("manager::connect_SW connection to service worker failed: ", err);
					self.connect();
				});
			},

			chat_toggle_display: function( open_it, noUpdateStorage ) {
				this.chatInitsAndPrefs.set_timer_away();

				if ( $("#account-chat-private-container").length > 0 ) {
					return;
				}

				if ( typeof open_it != "undefined" && open_it == this.opened ) {
					return;
				}

				if ( typeof noSW == "undefined" ) {
					noSW = false;
				}

				this.opened = !this.opened;
				if (/XXXAndroidApp/.test(navigator.userAgent)) { //is_android_app
					if (typeof AndroidInterface !== 'undefined') {
						AndroidInterface.isChatOpened(this.opened ? 'true' : 'false');
					}
				}
				this.node.toggleClass('chat-hidden');

				if ( this.no_https || this.priv_key == "" ) {
					return;
				}

				if ( !config.login_info.is_logged ) {
					log_and_tooltip.overlay_remove();
					$("#chat_loading_overlay").remove();
					return;
				}

				if ( this.connect_done && this.opened && typeof this.chat_friend_manager.selected_friend !== "undefined" && this.chat_friend_manager.selected_friend != 0) {
					ScrollConversation.down(this.chat_friend_manager.selected_friend);
				}

				if ( !this.connect_done && this.opened) {
					this.connect();
				}

				this.set_interval_nb_users();

				if (this.opened) {
					this.chatInitsAndPrefs.checkNotifPermissionAsked(this.setSwToken.bind(this));
				}

				if ( noUpdateStorage ) {
					return;
				}

				xv_storage.set("chat-display", this.opened);
			},

			toggle_home: function(event, open) {
				this.chatInitsAndPrefs.set_timer_away();

				if (event !== null ) {
					event.stopPropagation();
				}

				if ( this.chat_friend_manager.selected_friend == 0 ) {
					return;
				}

				if ( typeof open != "undefined" ) {
					$(".chat-window").removeClass("chat-window--home").addClass("chat-window--home");
					$("#select_friend_li_" + this.chat_friend_manager.selected_friend).removeClass("chat-user--selected");
				} else {
					$(".chat-window").toggleClass("chat-window--home");
					$("#select_friend_li_" + this.chat_friend_manager.selected_friend).toggleClass("chat-user--selected");
				}
			},

			connect: function () {
				if (this.connect_done){
					return;
				}

				this.connect_done = true;

				var infos_connection;

				var infos_connection_last_master = xv_storage.get("server_connection_time");
				var now = (new Date()).getTime();
				if ( infos_connection_last_master ) {
					if ( ( now - parseInt(infos_connection_last_master) ) < ( 24*60*60*1000 ) ) {
						infos_connection = xv_storage.get("server_connection");
					} else {
						xv_storage.set("server_connection_time", ( (new Date()).getTime() - ( 24*60*60*1000 ) + 60*1000 ) );
					}
				}

				if ( typeof infos_connection !== "undefined" && infos_connection != "" && infos_connection ) {
					this.connect_js_connection( infos_connection );
					return;
				}

				this.connect_master();
			},

			reconnect: function () {
				if (!this.connect_done) {
					this.connect();
					return;
				}

				var infos_connection = xv_storage.get("server_connection");

				if (!infos_connection) {
					return;
				}

				if (this.loading_studio_id) {
					this.connect_js_connection(infos_connection);
				} else if (!this.try_refresh_cookie_on_reconnect) {
					wglog.debug('try refresh cookie before reconnect');
					this.try_refresh_cookie_on_reconnect = true;
					this.refresh_cookie();
				} else {
					wglog.debug('reconnect');
					this.try_refresh_cookie_on_reconnect = false;
					this.connect_js_connection(infos_connection);
				}
			},

			connect_master: function() {
				xv_storage.set("server_connection", config.server_master );
				xv_storage.set("server_connection_time", (new Date()).getTime() );

				this.connect_js_connection( config.server_master );
			},

			connect_js_connection: function(host) {
				this.socket_connection_connected = false;
				this.reinit = false;
				if ( !this.nb_switch_server ) {
					this.nb_switch_server = 0;
				}

				if ( this.socket_connection ) {
					this.socket_connection.disconnect();
					delete this.socket_connection;
				}

				var self = this;
				if ( typeof this.force_close === "undefined" ) {
					this.force_close = false;
					window.addEventListener('beforeunload', function(event) {
						self.force_close = true;
						if ( typeof self.socket_connection != "undefined" ) {
							self.socket_connection.emit("force_close");
						}
					});
				}

				var last_id_conversation = xv_storage.get('id_last_conversation');
				this.force_friend = (last_id_conversation !== null && last_id_conversation > 0 ) ? parseInt(last_id_conversation) : 0;

				if (typeof window.location.hash !== "undefined" && window.location.hash !== "") {
					var regex = /^#conversation_([0-9]+)$/;
					var res = regex.exec(window.location.hash);
					if (res && res.length === 2) {
						var friend_id = parseInt(res[1]);
						if (friend_id !== 0) {
							this.force_friend = friend_id;
						}
					}
				}

				if ( $("#account-chat-force-friend").length > 0 ) {
					var friend_id = parseInt($("#account-chat-force-friend").html());
					if (friend_id !== 0) {
						this.force_friend = friend_id;
					}
				}

				var cookie_hexavid = config[config.cookie_name];

				wglog.debug('manager::connect_js_connection JWT', cookie_hexavid);

				var query_params = {
					"no_priv_key": self.no_priv_key,
					"cookie_name": config.cookie_name
				};
				query_params[config.cookie_name] = cookie_hexavid;
				try {
					SocketConnection.init(host, query_params);
					this.socket_connection = SocketConnection.getConnection();
					this.chat_friend_action.set_socket_connection(this.socket_connection);
					this.chat_friend_manager.set_socket_connection(this.socket_connection);

					if (!!this.chat_send_file) {
						this.chat_send_file.init_socket(this.socket_connection);
					}
					if (!!this.content) {
						this.content.setMessageFormActivation(this.chat_friend_manager.setMessageFormState.bind(this.chat_friend_manager));
						this.content.setEmptyMessageForm(this.empty_message_form.bind(this));
						this.content.setMessageEncrypter(this.make_real_message.bind(this));
						this.content.setMessageProvider(this.get_input_value.bind(this));
						this.content.setSelectedFriendIdProvider(this.chat_friend_manager.get_selected_friend_id.bind(this.chat_friend_manager));
						this.content.setSocket(this.socket_connection);
					}
					if (!!this.vault) {
						this.vault.setMessageFormActivation(this.chat_friend_manager.setMessageFormState.bind(this.chat_friend_manager));
						this.vault.setEmptyMessageForm(this.empty_message_form.bind(this));
						this.vault.setMessageEncrypter(this.make_real_message.bind(this));
						this.vault.setMessageProvider(this.get_input_value.bind(this));
						this.vault.setSelectedFriendIdProvider(this.chat_friend_manager.get_selected_friend_id.bind(this.chat_friend_manager));
						this.vault.setSocket(this.socket_connection);
					}
				} catch (e) {
					wglog.error("socket connection error", e);
					log_and_tooltip.write_error({
						logTitle: 'manager::connect_js_connection socket connection error',
						logMessage: e.message,
						message: i18n.__('chat.error.connection_error'),
						refresh: true,
						source: "connect_js_connection"
					});
				}

				this.setSocketEvents();

				self.input.val('');

				if ( typeof self.event_after_connection_done === "undefined" ) {
					self.event_after_connection_done = true;

					self.node.on('keydown','textarea#chat-textarea-message', function(e) { self.key_down(e); });
					self.node.on('keyup', 'textarea#chat-textarea-message', function(e) { self.key_pressed(e) });
					self.input.on('click', function () {
						self.set_read_date(self.chat_friend_manager.selected_friend);
					});

					if ( self.chat_friend_manager.search_input.length > 0 ) {
						self.chat_friend_manager.search_input.on('keyup', function (e) {
							self.search_key_pressed(e)
						});
					}

					if ( self.chat_friend_manager.send_button.length > 0 ) {
						self.chat_friend_manager.send_button.on('click', function(event) {
							event.stopPropagation();
							self.sendMessageDispatch();
						});
					}

					if ( self.chat_friend_manager.search_button.length > 0 ) { self.chat_friend_manager.search_button.on('click', function(event) { event.stopPropagation();  self.chat_friend_manager.search_friend(); } ); }

					if (config.file_upload.method === "default") {
						this.chat_send_file.init();
					}
				}

				//auto scroll down if height change
				$(window).resize(function() {
					if ( typeof self.chat_friend_manager.selected_friend !== "undefined" && self.chat_friend_manager.selected_friend > 0 ) {
						var ul_selected_friend = $("#chat_group_messages_tab_" + self.chat_friend_manager.selected_friend );
						if ( ul_selected_friend.length == 0 ) {
							return;
						}
						ul_selected_friend = ul_selected_friend[0];

						if ( typeof self.messages_from_bottom =="undefined" ) {
							self.messages_from_bottom = ul_selected_friend.scrollHeight - ul_selected_friend.clientHeight - ul_selected_friend.scrollTop;
						}

						$(ul_selected_friend).scrollTop( ul_selected_friend.scrollHeight - ul_selected_friend.clientHeight - self.messages_from_bottom );
						self.messages_client_height =  ul_selected_friend.clientHeight;
					}
				});

				var opened = xv_storage.get("chat-display");
				if ( typeof opened !== "undefined" && (opened === true || opened === "true" ) ) {
					//timeout to see the chat displayed after select the tab
					setTimeout(function(){self.chat_toggle_display( true );},500);
				}

				if ( $("#account-chat-private-container").length > 0 ) {
					this.chatInitsAndPrefs.checkNotifPermissionAsked(this.setSwToken.bind(this));
				}
			},

			setSocketEvents: function() {
				var fnTranslateMessage = function(data) {
					var trad = "",
						data_array = data,
						message;

					if ( typeof data.message == "string" ) {
						data_array = {};
						data_array.message = [data];
					}

					for (var i in data_array.message) {
						if (trad != "") {
							trad += "<br />";
						}
						message = data_array.message[i];

						if ( typeof message == "string" ) {
							trad += log_and_tooltip.encode_html_special_cars(i18n.__(message));
						} else if (typeof message.message == "string") {
							if (typeof message.params !== "undefined" && message.params !== null) {
								trad += log_and_tooltip.encode_html_special_cars(i18n.__(message.message, message.params));
							} else {
								trad += log_and_tooltip.encode_html_special_cars(i18n.__(message.message));
							}
						}
					}

					if ( trad == "") {
						trad = i18n.__('misc.error_please_retry');
					}

					return trad;
				},
					fnCallbackErrorFatal = function (data) {
					wglog.error('chat_error event', data);
					log_and_tooltip.popup_close();

					if (!data.code || data.code !== 60008) {
						self.reinit = true;
						self.reinitChat();
					}

					if (typeof data.message == "undefined") {
						log_and_tooltip.write_error({
							logTitle:'manager::fnCallbackErrorFatal message undefined',
							message: i18n.__('misc.error_please_retry'),
							refresh: true
						});
						return;
					}
					if (data.code && data.code === 60008) {
						self.chat_friend_manager.add_tip_to_chat_message();
						return;
					}

					var trad = fnTranslateMessage(data);
					var errorCode = ((typeof data.code !== 'undefined' && data.code) ? '(' + data.code +')' : '');
					trad = (typeof data.source !== 'undefined' && typeof data.source === 'string' && data.source.length > 0)
						? trad + ' <span class="source">' + data.source + ' ' +  (errorCode ? errorCode : '') + '</span>'
						: trad +  (errorCode ? errorCode : '');

					wglog.error('manager::fnCallbackErrorFatal ' + data.message, 'Error displayed to user', data);
					log_and_tooltip.write_error( {
						logTitle: 'manager::fnCallbackErrorFatal ' + data.message,
						message: trad,
						refresh: true
					} );
				},
					self = this;

				// Define events callback
				this.socket_connection.on("user_connected", function(data) {
					self.user_connected(data);
				});
				this.socket_connection.on("user_logout", this.user_logout.bind(this));
				this.socket_connection.on("get_online_friends", function(data) {
					self.get_online_friends(data);
				});
				this.socket_connection.on("send_conversation", function(data) {
					self.put_history(data);
				} );
				this.socket_connection.on("message_received", function(data) {
					self.receive_message(data);
				} );
				this.socket_connection.on("update_content_message", function(data) {
					self.update_content_message(data);
				});
				this.socket_connection.on("creator_message_sent", function(data) {
					self.creator_message_sent(data);
				});
				this.socket_connection.on("message_deleted", function(data) {
					self.delete_message(data);
				} );
				this.socket_connection.on("message_edited", function(data) {
					self.edit_message(data);
				} );
				this.socket_connection.on("message_updated", function(data) {
					self.update_message(data);
				} );
				this.socket_connection.on("read_date_set", function(data) {
					self.read_date_set(data);
				} );
				this.socket_connection.on("new_conversation_key", function(data) {
					self.chat_friend_manager.new_conversation_key(data);
				} );
				this.socket_connection.on("get_priv_key_error", function() {
					$("#chat_pass_no_key_check_pass").hide();
					$("#chat_pass_no_key_form").show();
					$("#chat_pass_no_key_error").html( i18n.__('error.invalid_password'));
				} );
				this.socket_connection.on("crypt_old_conversation", function(data) {
					self.chat_friend_manager.crypt_old_conversation(data);
				} );
				this.socket_connection.on("setuserinfos", function(data) {
					self.setuserinfos(data);
				} );
				this.socket_connection.on("contacts", function(data) {
					self.send_users_infos(data);
				} );
				this.socket_connection.on("found_friends", function(data) {
					if (data.is_chat_startup_conv_load && data.friends && data.friends.length) {
						var friend = data.friends[0],
							event = self.getContactListTypeAndEvents(friend).events.ADD_CONTACT;
						self.chatContext.emit(event, friend);
						self.chat_friend_manager.select_friend(friend.id_user);
					} else {
						self.chat_friend_manager.found_friends(data);
					}
				} );
				this.socket_connection.on("change_prefs", function(data) {
					self.chatInitsAndPrefs.set_change_prefs(data, self.reinitChat.bind(self));
				} );
				this.socket_connection.on("change_favorite", function(data) {
					self.chat_friend_action.update_favorite(data);
				} );
				this.socket_connection.on("friend_request_accepted", function(data) {
					self.chat_friend_action.friend_request_accepted(data);
				} );
				this.socket_connection.on("friend_request_refused", function(data) {
					self.chat_friend_action.friend_request_refused(data);
				} );
				this.socket_connection.on("friend_request_done", function(data) {
					self.chat_friend_action.friend_request_done(data);
				} );
				this.socket_connection.on("pending_request_checked", function(data) {
					self.chat_friend_action.pending_request_checked(data);
				} );
				this.socket_connection.on("friend_request_sent_canceled", function(data) {
					self.chat_friend_action.friend_request_sent_canceled(data);
				} );
				this.socket_connection.on("blocking_friend", function(data) {
					self.chat_friend_manager.blocking_friend(data);
				} );
				this.socket_connection.on("blocked_by_friend", function(data) {
					self.chat_friend_manager.blocked_by_friend(data);
				} );
				this.socket_connection.on("friend_reported", function(data) {
					self.chat_friend_action.friend_reported(data, self.chat_friend_manager.friends);
				} );
				this.socket_connection.on("auto_banned", function(data) {
					wglog.debug("auto_banned");
					window.location.reload();
				} );
				this.socket_connection.on("message_all_deleted", function(data) {
					self.chat_friend_action.message_all_deleted(data);
				} );
				this.socket_connection.on("status_changed", function(data) {
					self.status_changed(data);
				} );
				this.socket_connection.on("friend_status_changed", function(data) {
					self.chat_friend_manager.friend_status_changed(data);
				} );
				this.socket_connection.on("is_typing", function(data) {
					self.chat_friend_manager.is_typing(data);
				} );
				this.socket_connection.on("stop_typing", function(data) {
					self.chat_friend_manager.stop_typing(data);
				} );
				this.socket_connection.on("set_nb_users", function(data) {
					self.set_nb_users(data);
				} );
				this.socket_connection.on("update_report_words", function(data) {
					wglog.debug("update_report_words", data);
					if (typeof data.black_words != "object" || typeof data.white_words != "object") {
						return;
					}
					self.report_blacklist = data.black_words;
					self.report_whitelist = data.white_words;
				} );
				this.socket_connection.on("update_ban_words", function(data) {
					wglog.debug("update_ban_words", data);
					if (typeof data.ban_words != "object") {
						return;
					}
					self.ban_words = data.ban_words;
				} );
				this.socket_connection.on("chat_error", function(data) {
					if (typeof data.error_display !== 'undefined' && typeof data.error_display === 'boolean' && !data.error_display) {
						return;
					}

					$('#chat_loading_overlay').hide();

					var classErrorNoFatal = '.chat-error--nofatal',
						$errorNoFatal = $(classErrorNoFatal),
						nbErrorsNoFatal = $errorNoFatal.length,
						useFatalError = data.source !== 'get_allusersids_and_firstusersinfos_callback' && data.source !== 'get_followers_list_callback';

					if (data.message.indexOf('chat.error') !== -1) {
						self.chat_friend_manager.clear_search();
					}

					if ((typeof data.attempt_id !== 'undefined' && self.check_show_error_on_failed_attempts(data.attempt_id) === true) || self.retry_attempt >= 5) {
						if (useFatalError) {
							fnCallbackErrorFatal(data);
							if (nbErrorsNoFatal) {
								$errorNoFatal.remove();
							}
						}
						else {
							var textError;
							if (data.source === 'get_allusersids_and_firstusersinfos_callback') {
								textError = i18n.__('chat.error.unable_get_friends');
							}
							else if (data.source === 'get_followers_list_callback') {
								textError = i18n.__('chat.error.unable_get_followers');
							}
							else if (data.source === 'create_vault_content_callback') {
								textError = i18n.__('chat.error.unable_to_create_vault_content');
							}
							self.retry_attempt = 0;
							$errorNoFatal.find('.error-content').text(textError);
						}

					}
					else {
						if ((typeof data.attempt_id !== 'undefined' && data.message === 'misc.error_please_retry') || (typeof data.retry !== 'undefined' && typeof data.retry === 'object') ) {
							data.message = 'chat.error.please_wait';
						}
						if (typeof data.error_message_rpc !== 'undefined') {
							data.message = data.error_message_rpc;
						}

						require(['text!error_nofatal.mustache'], function(tplErrorNoFatal) {
							if (window.matchMedia('(min-width: 769px)').matches && nbErrorsNoFatal > 5) {
								return;
							}
							if (window.matchMedia('(max-width: 768px)').matches && nbErrorsNoFatal > 0 && typeof data.retry === 'undefined') {
								$errorNoFatal.remove();
							}
							if (!nbErrorsNoFatal || !$errorNoFatal.hasClass('is-retry')) {
								$errorNoFatal = $(Mustache.render(tplErrorNoFatal, {
									'content': fnTranslateMessage(data),
									'source': data.source,
									'code': data.code || null
								}));
								$errorNoFatal.find('.btn-close').on('click', function (event) {
									$(event.currentTarget).closest(classErrorNoFatal).remove();
								});
								$('.chat-window').prepend($errorNoFatal);

								if (window.matchMedia('(min-width: 769px)').matches && nbErrorsNoFatal > 0) {
									$(classErrorNoFatal).each(function (index) {
										$(this).css('transform', 'translateY(-' + (nbErrorsNoFatal - index) * 100 + '%)');
									});
								}
							}

							var isNodeError = data.code >= 50000 && data.code < 60000;
							if (isNodeError || (typeof data.retry !== 'undefined' && typeof data.retry === 'object')) {
								$errorNoFatal.addClass('is-retry');
								if (window.matchMedia('(min-width: 769px)').matches) {
									var $errorMsgLoading = $errorNoFatal.find('.chat-scc--spin');
									if ($errorMsgLoading.length === 0) {
										$errorNoFatal.find('.error-content').append(' <svg class="chat-scc chat-scc--spin"><use xlink:href="#scc-message-loader-icon" /></svg');
									}
								}
							}
							if (isNodeError && typeof data.recipient_id !== 'undefined') {
								var fnTimeoutErrorRPC = setTimeout(function() {
									$('.chat-message').remove();
									//self.get_conversation(data.recipient_id);
									$errorNoFatal.remove();
									clearTimeout(fnTimeoutErrorRPC);
								}, 5000);
							}


							if (typeof data.retry !== 'undefined' && typeof data.retry === 'object') {
								if (!self.is_retrying) {
									self.is_retrying = true;
								}
								self.retry_timer = setTimeout(function() {
									self.retry_attempt++;
									if (data.source === 'get_allusersids_and_firstusersinfos_callback') {
										self.socket_connection.emit('get_allusersids_and_firstusersinfos', data.retry);
									}
									if (data.source === 'get_followers_list_callback') {
										self.socket_connection.emit('get_followers_list', data.retry);
									}
									if (data.source === 'newmessage_callback') {
										self.socket_connection.emit('send_message', data.retry);
									}
									if (data.source === 'create_vault_content_callback') {
										self.socket_connection.emit('create_vault_content', data.retry);
									}
								}, 1000);
							}
							else {
								var fnTimeoutError = setTimeout(function() {
									$errorNoFatal.remove();
									clearTimeout(fnTimeoutError);
									if (isNodeError && data.source === 'create_vault_content' || data.source === 'create_vault_content_callback') {
										self.chat_friend_manager.setMessageFormState(false);
									}
								}, 10000);
							}

						});
					}
				});
				this.socket_connection.on("chat_error_fatal", fnCallbackErrorFatal);
				this.socket_connection.on("chat_error_no_private_key", function() {
					wglog.debug("chat_error_no_private_key");
					self.no_priv_key = true;
					clearTimeout(self.timeout_reconnect);
					self.timeout_reconnect = null;
					log_and_tooltip.write_message_no_private_key(self.no_key_send_pass.bind(self));
				} );
				this.socket_connection.on("disconnect", function () {
					self.socket_conn_disco = true;

					if ( !!self.reinit ) {
						return;
					}

					if (!(!!self.loading_studio) && !!self.not_logged) {
						wglog.debug('User was not logged, so he was disconnected.');
						log_and_tooltip.modal(
							`<p>${i18n.__('chat.error.not_logged')}</p>`,
							{
								title: i18n.__('chat.error_no_reload.disconnected'),
								type: 'refresh'
							}
						)
						return;
					}

					if (self.hide_lost_connection_popup_on_disconnect) {
						self.hide_lost_connection_popup_on_disconnect = false;
						self.force_close = false;
					}
				});
				this.socket_connection.on("reconnecting", function (attemptNumber) {
					var message = '<p>' + i18n.__('chat.error.lost_connection', {
							'%duration%': tools.formatDuration(SocketConnection.getMaxReconnectionDuration(), 'long'),
							'%attemptNumber%': attemptNumber,
							'%maxAttempts%': SocketConnection.getMaxReconnectionAttempts()
						}) + '</p>',
						messageId = 'chat-recconnecting-message',
						existantMessage = $(`#${messageId}`);

					switch (SocketConnection.getDisconnectReason()) {
						case 'transport close':
							message += `<p><br />${i18n.__('chat.error.please_check_network')}</p>`;
							break;
					}

					if (existantMessage.length) {
						existantMessage.html(message);
					} else {
						log_and_tooltip.modal(`<div id="${messageId}">${message}</div>`, {
							title: i18n.__('chat.error_no_reload.disconnected')
						});
					}
				});
				this.socket_connection.on("reconnect", function () {
					log_and_tooltip.overlay_close();
				});
				this.socket_connection.on("reconnect_failed", function () {
					var reason = SocketConnection.getDisconnectReason();
					switch (reason) {
						case 'transport close':
							log_and_tooltip.modal(`<p>${i18n.__('chat.error.reconnection_failed')}<br />${i18n.__('chat.error.please_check_network')}</p>`, {
								type: 'refresh',
								title: i18n.__('chat.error_no_reload.disconnected')
							});
							break;
						default:
							log_and_tooltip.write_error({
								logTitle: 'Socket connection error: ' + reason,
								logMessage: 'Unable to reconnect.',
								title: i18n.__('chat.error_no_reload.disconnected'),
								message: i18n.__('chat.error.reconnection_failed'),
								refresh: true
							});
					}
				});
				this.socket_connection.on('connect', function() {
					log_and_tooltip.overlay_close();
				});
				this.socket_connection.on("new_jwt_token", function(data) {
					self.new_cookie(data);
				} );
				this.socket_connection.on("tip_notification", function(data) {
					self.tip_notification(data);
				} );
				this.socket_connection.on("filtered-friend-list", function(data) {
					self.filtered_friend_list(data);
				});
				this.socket_connection.on("register_new_user_from_xv_success", function(data) {
					self.register_new_user_from_xv_success(data);
				});
				this.socket_connection.on('hide_user_done', function(data) {
					self.user_is_hidden(data);
				});
				this.socket_connection.on('unhide_user_done', function(data) {
					HiddenUsers.unhideUser(data);
				});
				this.socket_connection.on('get_all_hidden_users_success', function(data) {
					HiddenUsers.setHiddenUsers(data);
				});
			},

			no_key_send_pass: function(password) {
				if (typeof password != "undefined" && password.length > 0) {
					this.socket_connection.emit("get_priv_key", {"password": password});
				}
			},

			user_connected: function (data) {
				wglog.debug('manager::user_connected unread messages count ' + data.nb_unread_messages_sum);
				if (data.nb_unread_messages_sum) {
					wglog.debug('manager::user_connected unread messages', data.nb_unread_messages);
				}

				if ( typeof data.priv_key !== "undefined" ) {

					xv_storage.set("chat-pk", data.priv_key);
					cookies.setLocal(config.cookie_name , "", 0, "/", true, "Strict");

					this.priv_key = this.chatInitsAndPrefs.initKey();
					this.chat_friend_manager.set_priv_key(this.priv_key);
					if ( this.priv_key == false ) {
						wglog.error("no private key in local");
						this.no_priv_key = true;
						this.priv_key = "";
					}
				}

				var self = this;

				this.connect_websocket_nb_error = 0;
				this.verif_connection_done = 0;
				if (typeof this.timeout_reconnect !== null && typeof this.timeout_reconnect === 'number') {
					clearTimeout(this.timeout_reconnect);
					this.timeout_reconnect = null;
				}

				if ( !this.display_message_old_browser ) {
					log_and_tooltip.overlay_close();
				}

				this.socket_connection_connected = true;

				// no friends + not account page + not profile page
				if ( typeof config.nb_friends !== "undefined" && config.nb_friends == 0 &&
					$("#account-chat-private-container").length == 0 &&
					(!config.hasOwnProperty('data') || !config.hasOwnProperty('user') || !config.user.hasOwnProperty('id_user') )
				) {
					return;
				}

				if (typeof(data.infos_user) === 'undefined') {
					wglog.error("infos_user is undefined");
					log_and_tooltip.write_error({logTitle: 'manager::user_connected user info is undefined', message: i18n.__('chat.error.no_infos_user')});
					return;
				}

				if ( typeof this.user_id !== "undefined" && this.user_id != data.infos_user.id_user) {
					delete this.last_friend_conv;

					this.chat_friend_manager.set_friends({});
					this.chat_friend_manager.set_friends_id([]);
					this.chat_friend_manager.reset();
					this.friends_infos_from_SW = null;

					this.chat_friend_manager.set_selected_friend(0);
					this.force_friend = null;

					if (this.loading_studio_id) {
						this.user_id = data.infos_user.id_user;
						config.login_info.id = data.infos_user.id_user;
						for (var prop in config.login_info) {
							if (data.infos_user[prop]) {
								config.login_info[prop] = data.infos_user[prop];
							}
						}
					} else {
						$("#chat_loading_overlay").show();
					}
				}

				config.login_info.profile_name = data.infos_user.profile_name;
				config.login_info.profile_picture = data.infos_user.profile_picture;
				if (data.infos_user.verified) {
					config.login_info.verified = data.infos_user.verified;
				}

				config.login_info.is_handle_by_manager = data.infos_user.settings.is_handle_by_manager === 'true';

				this.user_id = data.infos_user.id_user;
				this.chat_friend_action.set_user_infos(data.infos_user.id_user, data.infos_user.profile_name);
				this.chat_friend_manager.set_user_id(data.infos_user.id_user);
				this.chat_friend_manager.set_message_header_display_user_id(data.infos_user.is_support);
				this.nb_unread_messages = data.nb_unread_messages;
				this.nb_unread_messages_sum = data.nb_unread_messages_sum;
				this.is_xv_creator = data.is_xv_creator;

				if ( typeof data.unread_message_friends == "undefined" ) {
					data.unread_message_friends = [];
				}
				this.unread_message_friends = data.unread_message_friends;

				if (!data.infos_user.is_creator && !data.infos_user.is_support) {
					config.login_info.is_silent_ppv = data.infos_user.settings.silent_auto_publish_ppv === 'true';
				}

				this.update_window_after_user_connected(data.infos_user);

				if ( typeof data.keys_create_timestamp !== "undefined" && data.keys_create_timestamp == parseInt(data.keys_create_timestamp) ) {
					this.chat_friend_manager.set_keys_create_timestamp( parseInt(data.keys_create_timestamp) );
				}

				this.chat_friend_action.friend_requests_html( data );

				// for socket reconnect and if SW don't have infos
				if (this.friends_infos_from_SW === null && !$.isEmptyObject(this.chat_friend_manager.friends) && this.chat_friend_manager.friends_ids.length != 0) {
					this.friends_infos_from_SW = this.chat_friend_manager.friends;
				}

				if (typeof this.chatInitsAndPrefs.sw_token !== "undefined" && this.chatInitsAndPrefs.sw_token != "") {
					this.setSwToken(this.chatInitsAndPrefs.sw_token);
				}

				$('div.chat-loader').hide();

				var filter = !storage.get('chatcontact_list_filter') ? {filter: 'unreads'} : {filter: storage.get('chat.filter_contact_list')};
				if (data.infos_user.is_creator) {
					this.chatContext.emit(CustomerListEvent.CREATE_CONTACT_LIST, filter);
					this.chatContext.emit(FollowerListEvent.CREATE_CONTACT_LIST, filter);
					this.chatContext.emit(SupportListEvent.CREATE_CONTACT_LIST, {});
				} else {
					filter.invisible = this.chatInitsAndPrefs.status === "Invisible"
					this.chatContext.emit(ContactListEvent.CREATE_CONTACT_LIST, filter);
				}

				cookies.setLocal( this.cookie_deco_name , 0, 0, "/");
				this.check_deco_interval = setInterval( function() { self.check_cookie_deco(); } , this.interval_check_deco);

				if (typeof data.block_words != "undefined") {
					ReportMessage.addAutoBlockWords(data.block_words);
				}
				if (typeof data.report_words != "undefined") {
					ReportMessage.addAutoReportWords(data.report_words);
				}
				if (typeof data.mm_rules_unavailabilities != "undefined") {
					config.mmRulesUnavailabilities = data.mm_rules_unavailabilities;
				} else {
					config.mmRulesUnavailabilities = false
				}

				config.login_info.is_studio = !!this.loading_studio_id && !!this.studios && !!this.studios[this.loading_studio_id];
				// Reset loading_studio_id 'cause we don't need it anymore
				this.loading_studio_id = null;

				// send id_user to SW
				if (this.chatInitsAndPrefs.serviceWorker) {
					try {
						this.chatInitsAndPrefs.serviceWorker.postMessage({
							"action": "set_id_user",
							"id_user": data.infos_user.id_user
						});
					} catch (e) {
						wglog.error('Failed to send id_user to SW', e.toString());
					}
				}

				this.chatContext.emit(ManagerEvent.USER_CONNECTED, data);
			},

			user_logout: function () {
				this.not_logged = true;

				if (this.socket_connection) {
					this.socket_connection.close();
				}

				xv_storage.remove("chat-pk");
				this.priv_key = '';
				this.chat_friend_manager.set_priv_key(this.priv_key);

				cookies.removeLocal(config.cookie_name);
				cookies.setLocal(this.cookie_deco_name , 0, 0, "/");
				this.check_cookie_deco();
			},

			check_cookie_deco: function() {
				var chat_deco = cookies.get( this.cookie_deco_name );
				if ( chat_deco == 1 ) {
					clearInterval( this.check_deco_interval );
					this.reinitChat();
				}
			},

			send_translations: function (data) {
				if ( !data.hasOwnProperty("translations") ) {
					wglog.debug("send_translations", "property translations missing");
					return;
				}

				storage.set('chat_translations', data.translations);
			},

			get_online_friends: function(data) {
				/*if ( !data.hasOwnProperty("friends_online") ) {
					wglog.debug("get_online_friends", "parameter friends_online missing");
					this.connect_and_contacts_done(this.friends_infos_from_SW);
					return;
				}

				if ( typeof data.friends_id !== "undefined") {
					this.chat_friend_manager.set_friends_id(data.friends_id);
					if (config.login_info.is_support) {
						select_contacts.setContactsId(data.friends_id);
					}
				}*/

				var unknown_friends = [];
				// set online friends and get online friends not in friends_infos_from_SW
				for (var i in data.friends_online) {
					if (!this.friends_infos_from_SW[data.friends_online[i]]) {
						unknown_friends.push(data.friends_online[i]);
						continue;
					}

					// Status for SW ... getting real status (online || away) with get_users_infos
					this.friends_infos_from_SW[data.friends_online[i]].status = "Online";
				}

				//set offline friends and update nb unread messages
				for (var id in this.friends_infos_from_SW) {
					if (data.friends_online.indexOf(parseInt(id)) === -1) {
						this.friends_infos_from_SW[id].status = "Offline";
					}

					this.friends_infos_from_SW[id].nb_unread = 0;
					if ( this.nb_unread_messages.hasOwnProperty(id) ) {
						this.friends_infos_from_SW[id].nb_unread = this.nb_unread_messages[id];
					}
				}

				if (unknown_friends.length) {
					this.get_users_infos_enqueue(unknown_friends);
				}

				this.chatContext.emit(ContactListEvent.CREATE_CONTACT_LIST, {
					friends_ids: data.friends_id,
					first_friends_infos: this.friends_infos_from_SW
				});
			},

			initContactListManager: function (data) {
				this.connect_and_contacts_done(data.friends_infos);

				// send friends to SW
				if (this.chatInitsAndPrefs.serviceWorker) {
					try {
						this.chatInitsAndPrefs.serviceWorker.postMessage({
							"action": "set_friends",
							"contact_count": data.contact_count,
							"friends_ids": data.friends_ids,
							"first_friends_infos": data.friends_infos
						});
					} catch (e) {
						wglog.error('Failed to send friends_ids to SW', e.toString());
					}
				}

				if (this.is_retrying) {
					this.is_retrying = false;
					clearTimeout(this.retry_timer);
					var $error = $('.chat-error--nofatal.is-retry');
					if ($error.length) {
						$error.remove();
					}
				}
			},
			initContactListForSupport: function(friends_ids) {
				var self = this;

				this.chatContext.emit(ReminderEvent.GET_ACTIVE_REMINDERS, {});
				select_contacts.setContactsId(friends_ids);

				select_messages.init(this.node, this.chat_friend_manager);
				select_messages.setForwardHandler(function(ids, supportId) {
					self.emit_forward_message(ids, supportId);
				});
			},
			initContactListForCreator: function() {},

			connect_and_contacts_done: function (friends_infos) {
				this.init_connect_and_contacts_done();

				var friend_id,
					friend_to_select = false;

				if (location.hash && location.hash.length > 1) {
					friend_id = (this.force_friend !== 0 && location.hash.indexOf(this.force_friend) !== -1) ? this.force_friend : +this.chat_friend_manager.find_friend_id_by_name(location.hash.substring(1));
					if (friend_id) {
						friend_to_select = friend_id;
					}
				} else if ( config.hasOwnProperty('user') && config.user.id_user ) {
					friend_to_select = config.user.id_user;
				} else if ( config.hasOwnProperty('user') && config.user.username ) {
					friend_id = this.chat_friend_manager.find_friend_id_by_name(config.user.username);
					if (friend_id) {
						friend_to_select = friend_id;
					}
				} else if (typeof this.last_friend_conv !== "undefined" && this.last_friend_conv !== 0) {
					friend_to_select = this.last_friend_conv;
				} else if (this.force_friend) {
					friend_to_select = this.force_friend;
				} else if ( typeof this.chat_friend_manager.selected_friend !== "undefined" && this.chat_friend_manager.selected_friend != 0 ) {
					friend_to_select = this.chat_friend_manager.selected_friend;
				}

				if (friend_to_select
					&& ((!config.login_info.is_support && (this.chat_friend_manager.friends.hasOwnProperty(friend_to_select) || this.chat_friend_manager.friends_ids.indexOf(friend_to_select) !== -1))
					    || (config.login_info.is_support && !config.login_info.is_manager))
				) {
					this.chat_toggle_display(true);
					if (this.chat_friend_manager.friends.hasOwnProperty(friend_to_select)) {
						this.chat_friend_manager.select_friend(friend_to_select);
					} else if (config.login_info.is_support) {
						this.socket_connection.emit("search_friends", {
							'search': friend_to_select,
							'is_chat_startup_conv_load': true
						});
					} else {
						this.socket_connection.emit("getuserinfos", {
							'friend_id': friend_to_select,
							"callback_obj": {"open_tab": true}
						});
					}
				}

				var self = this;

				this.input.off('blur');
				this.input.on('blur', function(e) {
					self.typing_to_friend = false;
					if (self.typing_timout) {
						clearTimeout(self.typing_timeout);
					}
					self.socket_connection.emit("typing_stop", {"id_friend": self.chat_friend_manager.selected_friend});

					var content = self.getContentInTextarea();
					if (content.length) {
						self.chatContext.emit(DraftEvent.SAVE, self.chat_friend_manager.selected_friend, content);
					} else {
						self.chatContext.emit(DraftEvent.DELETE, self.chat_friend_manager.selected_friend);
					}

					var $this = $(e.currentTarget);
					if (!$this.length) {
						return;
					}

					var $textareaWrapper = $this.closest('.chat-message-form__textarea-wrapper');
					if (!$textareaWrapper.length) {
						return;
					}

					var $editor = $textareaWrapper.find('.emojionearea-editor');
					if ($editor.length && $editor.html().length === 0) {
						$this.val('');
						if (typeof $this.data('convchunk') !== 'undefined' && typeof $this.data('convchunk') === 'string' && $this.data('convchunk').length) {
							$this.removeData('convchunk');
						}
						if (typeof $this.data('quote') !== 'undefined' && typeof $this.data('quote') === 'string' && $this.data('quote').length) {
							$this.removeData('quote');
						}
					}
				});

				$('body, #chat-window').off('switch-chat');
				$('body, #chat-window').on('switch-chat', function (e) {
					if (e.detail && e.detail.alias && typeof e.detail.alias === "string") {
						wglog.debug('switch-chat', 'try to select friend by name: ' + e.detail.alias);
						self.chat_friend_manager.select_friend_by_name(e.detail.alias);
					}
				});

				$(document).off('change.chat-message-read-status-change');
				$(document).on('change.chat-message-read-status-change', '.chat-message__read-status input', function(e) {
					if (!e.target.dataset || !e.target.dataset.userId) {
						wglog.debug('chat_message_read_status_change_callback', 'Unable to set read date (input.dataset.userId is undefined)');
						return;
					}
					self.message_mark_as_read($(e.target).parents('.chat-message__id'));
				});

				this.socket_connection.emit("get_nb_users");
				this.set_interval_nb_users();

				if (config.sort_friend_list) {
					this.node.on('friends-loaded', function (e) {
						$("#chat_loading_overlay").hide();
						self.node.off('friends-loaded');
					});
				} else {
					$("#chat_loading_overlay").hide();
				}

				if (config.after_load && typeof config.after_load == "function") {
					config.after_load();
				}
			},
			init_connect_and_contacts_done: function() {
				if (this.init_connect_and_contacts) {
					return;
				}

				var self = this;
				this.set_read_date_queue_manager = new socket_queue_manager(this.socket_connection, 'set_read_date', 1000);

				this.chat_friend_manager.setMessageFormState();
				this.chat_friend_manager.search_input.prop('disabled', false);
				this.chat_friend_manager.search_button.prop('disabled', false);

				if (typeof this.link_outside_done == "undefined" && config.hasOwnProperty('data') && config.hasOwnProperty('user') && config.user.hasOwnProperty('id_user')) {
					this.link_outside_done = true;
					window.sheerChat.infos.link_outside_done = true;
					if (typeof(window.sheerChat.infos.to_set_chat_toggle_link_outside_done) !== "undefined") {
						console.log("window.sheerChat.infos.to_set_chat_toggle_link_outside_done", window.sheerChat.infos.to_set_chat_toggle_link_outside_done);
						for (var i in window.sheerChat.infos.to_set_chat_toggle_link_outside_done) {
							var to_set = window.sheerChat.infos.to_set_chat_toggle_link_outside_done[i];
							window.sheerChat.actions.set_chat_toggle(to_set.elem);
							if (typeof(to_set.setted_func) === "function") {
								to_set.setted_func();
							}
						}
					}

					$("#profile-title .profile-pic .external-link").addClass("mobile-hide");

					var banner_chat_toggle_button = $(".has-banner .chat-toggle-button-outside");
					if (banner_chat_toggle_button.length > 0) {
						var banner_chat_toggle_button_pos = function () {
							banner_chat_toggle_button.each(function(){
								$(this).css("left", ($(".has-banner .profile-pic img:first").width() - $(this).width() + 2));
							});
						};
						$( window ).resize( banner_chat_toggle_button_pos);
						banner_chat_toggle_button_pos();
					}

					$(".chat-toggle-button-outside").css("display", "inline-block")
						.on('click', function (event) {
							event.stopPropagation();
							self.chat_toggle_display();
						});

					if ( this.chat_friend_manager.friends_ids.indexOf( config.user.id_user ) === -1 && config.user.id_user !== this.user_id ) {
						if (typeof this.socket_connection !== "undefined") {
							this.socket_connection.emit("check_pending_request", {"friend_id":  config.user.id_user});
						}
					}
				}

				attachment_manager.setFriendManager(this.chat_friend_manager);

				if ((config.login_info.is_fan && !config.login_info.is_xv_user) || config.login_info.is_creator) {
					Profile.init(
						this.socket_connection,
						this.chat_friend_manager.unselect_friend.bind(this.chat_friend_manager),
						!!config.login_info.is_studio
					);

					if (window.location.hash.slice(1) === Profile.getLocationHash()) {
						Profile.viewShow();
					}
				}

				if (config.login_info.is_creator) {
					HiddenUsers.init(
						this.socket_connection,
						this.chat_friend_manager.unselect_friend.bind(this.chat_friend_manager)
					);
					HiddenUsers.setOptions({
						'addFriend': this.chat_friend_manager.add_or_update_friend.bind(this.chat_friend_manager)
					});
					if (window.location.hash.slice(1) === HiddenUsers.getLocationHash()) {
						HiddenUsers.viewShow();
						HiddenUsers.onActionButtonClick();
					}
				}

				if (config.login_info.is_support) {
					select_messages.init(this.node, this.chat_friend_manager);
					select_messages.setForwardHandler(function(ids, supportId) {
						self.emit_forward_message(ids, supportId);
					});
				}

				this.init_connect_and_contacts = true;
			},

			getContactListTypeAndEvents: function(contact_info) {
				if (!this.contactLists) {
					wglog.debug('getContactListTypeAndEvents - No Contact List');
					return;
				}

				if (contact_info && typeof contact_info === 'number') {
					contact_info = this.chat_friend_manager.get_friend_infos(contact_info);
				}

				if (!contact_info) {
					wglog.debug('getContactListTypeAndEvents - No contact info');
					return;
				}

				var type = '';
				if (config.login_info.is_fan || config.login_info.is_support) type = 'inbox';
				else {
					if (contact_info.is_support) type = 'supports';
					else if (contact_info.is_customer) type = 'customers';
					else type = 'followers';
				}
				if (!type) {
					wglog.debug('getContactListTypeAndEvents - No contacts list type');
					return;
				}

				var events = null;
				if (type === 'inbox') events = ContactListEvent;
				if (type === 'customers') events = CustomerListEvent;
				if (type === 'followers') events = FollowerListEvent;
				if (type === 'supports') events = SupportListEvent;

				if (!events) {
					wglog.debug('getContactListTypeAndEvents - No events');
					return;
				}

				return {
					events: events,
					type: type
				}
			},

			get_users_infos_batch: function(friends_ids, sort) {
				var count = 0,
					attempt_id = "get_users_infos_batch";
				while (friends_ids.length > 0) {
					this.socket_connection.emit("get_users_infos", {'friends_ids': friends_ids.splice(0, 49), "attempt_id": attempt_id});
					count++;
				}

				if (typeof sort != "undefined") {
					config.sort_friend_list = count;
				}
			},

			get_users_infos_enqueue: function(friends_ids, params, length) {
				if (friends_ids.length === 0) return;

				var queues = storage.get('get_users_infos_queues') || {},
					_length = length || 49,
                    idForThrottle = null;

				for (var i = 0; i < friends_ids.length; i += _length) {
					var queueId = Math.random().toString(32).slice(2),
						_friends_ids = friends_ids.slice(i, i + _length);
                    if (!idForThrottle) {
                        idForThrottle = queueId;
                    }
					queues[queueId] = {friends_ids: _friends_ids, params: params || {}};
				}

				storage.set('get_users_infos_queues', queues);
                this.get_users_infos_throttle(queueId);
			},
			get_users_infos_throttle: function(queueId) {
				if (!this.get_users_infos_throttle_data) {
					this.get_users_infos_throttle_data = {active: [], pending: []};
				}

				var activeIndex = this.get_users_infos_throttle_data.active.indexOf(queueId),
					pendingIndex = this.get_users_infos_throttle_data.pending.indexOf(queueId);

				var isActive = activeIndex >= 0;

				if (!isActive && pendingIndex < 0) {
					this.get_users_infos_throttle_data.pending.push(queueId);
				}

				// Here we limit the number of active queues to 1
				if (!isActive && this.get_users_infos_throttle_data.active.length <= 1) {
					var nextActiveQueueId = this.get_users_infos_throttle_data.pending.shift();
					this.get_users_infos_throttle_data.active.push(nextActiveQueueId);
					isActive = queueId === nextActiveQueueId;
				}

				if (isActive) {
					this.get_users_infos_queue(queueId);
				}
			},
			get_users_infos_queue: function(queueId) {
				var queues = storage.get('get_users_infos_queues') || {};

				if (!queues[queueId]) return;

				var queue = queues[queueId];

				var params = Object.assign({friends_ids: queue.friends_ids}, queue.params);

				if (queue.friends_ids.length === 0) {
					delete queues[queueId];
					this.get_users_infos_throttle_data.active.splice(this.get_users_infos_throttle_data.active.indexOf(queueId), 1);
				} else {
					params.queue_id = queueId;
				}

				if (Object.keys(queues).length) {
					storage.set('get_users_infos_queues', queues);
				} else {
					storage.remove('get_users_infos_queues');
				}

				this.socket_connection.emit("get_contacts", params);
			},

			set_interval_nb_users: function() {
				if ( this.opened ) {
					if (this.interval_check_nb_user_function == null) {
						var self = this;
						this.interval_check_nb_user_function = setInterval(
							function() {
								if (self.socket_connection) {
									self.socket_connection.emit("get_nb_users");
								}
							}
							, this.interval_check_nb_user);
					}
				} else if ( this.interval_check_nb_user_function != null ) {
					clearInterval(this.interval_check_nb_user_function);
					this.interval_check_nb_user_function = null;
				}
			},

			set_nb_users: function(data) {
				if (!config.show_nb_users_enabled) {
					return;
				}
				if ( typeof data.nb_users === "undefined" || !parseInt(data.nb_users) || parseInt(data.nb_users) == 0 ) {
					wglog.error("set_nb_users", "bad nb_users : " + parseInt(data.nb_users));
					return;
				}

				var container = $("#chat-window .chat-title .chat-nb-users");
				var self = this;
				this.nb_users_display = tools.formatNumberUnits(parseInt(data.nb_users), 0);
				if ( !container || container.length == 0 ) {
					$("#chat-window .chat-title .chat-icon-home").after('<div class="chat-nb-users"><div class="chat-nb-users-count"></div><div class="chat-nb-users-icon icon-f icf-users">&nbsp;</div></div>');

					$("#chat-window .chat-title .chat-nb-users").on("click", function(event) {
						event.stopPropagation();
						if (typeof self.nb_users_display === "undefined" || self.nb_users_display == 0 ) {
							return;
						}

						log_and_tooltip.popup_open($("#chat-window .chat-title .chat-nb-users"), "<p class='message'>" + i18n.__('chat.infos.nb_users_on_chat', { '%nb_users%': self.nb_users_display.toString() }) + "</p>");
					});

					container = $("#chat-window .chat-title .chat-nb-users");
				}

				var count_html = $("#chat-window .chat-title .chat-nb-users .chat-nb-users-count");

				if ( !count_html || count_html.length == 0 ) {
					return;
				}

				count_html.html( this.nb_users_display );

				if ( container && container.length > 0 ) {
					$(container[0]).prop("title", i18n.__('chat.infos.nb_users_on_chat', { '%nb_users%': this.nb_users_display }));
				}
			},

			get_conversation: function (id_friend, offset, a, report) {
				if (typeof a !== 'undefined' && a !== null) {
					$(a).parents('li').remove();
				}
				if (typeof offset === 'undefined') {
					offset = 0;
				}
				if ( typeof report === "undefined" || report === null) {
					report = false;
				}
				$("#chat_group_messages_tab_" + id_friend).prepend('<li class="chat-message chat-message--system chat-message--empty div_load_history"><p>' + i18n.__("loading.loading") + '</p></li>');
				this.socket_connection.emit("get_conversation_friend", {
					sender_id: this.user_id,
					recipient_id: id_friend,
					offset: offset,
					report: report
				});
			},

			put_history: function (data) {
				wglog.log('manager::put_history', data);

				var $loadHistory = $('.div_load_history');
				if ($loadHistory.length) {
					$loadHistory.remove();
				}

				var id_div_tab = "chat_group_messages_tab_" + data.recipient_id;

				var friend_info = this.chat_friend_manager.get_friend_infos(data.recipient_id);
				if (friend_info === false) {
					return;
				}

				var self = this;
				this.chat_friend_manager.decrypt_conv_keys(data);
				this.chat_friend_manager.set_friend_attribut(data.recipient_id, "load_history", false);

				// Temporary transtype all specific delete all messages to system message type
				for (let i = 0, l = data.conversations.length; i < l; i++) {
					if (data.conversations[i].y === 'i' && data.conversations[i].m.indexOf('{\"trad\":\"chat.infos.user_deleted_all\"') === 0) {
						data.conversations[i].m = data.conversations[i].m.replace('chat.infos.user_deleted_all', 'chat.infos.user_deleted_all_messages');
						data.conversations[i].y = 's';
					}
				}

				if ((friend_info.nb_unread || friend_info.last_read || friend_info.interaction) && $("#" + id_div_tab + ' > li').length === 0 && data.conversations.length === 0) {
					wglog.debug('manager::put_history data', data);
					wglog.debug('manager::put_history nb_unread', friend_info.nb_unread);
					log_and_tooltip.write_error({
						logTitle: 'manager::put_history error missing messages in conversation',
						logMessage: 'There are unread messages but messages in conversation are missing.',
						title: i18n.__('misc.important'),
						message: i18n.__('chat.error.missing_messages_in_conversation'),
						refresh: false,
						closable: true,
						source: "put_history"
					});

					this.chat_friend_manager.disable_send_button();
				}

				$("#" + id_div_tab + " li.chat-message--empty").remove();
				if ( $.isEmptyObject( data.conversations ) ) {
					if ($("#" + id_div_tab + ' > li').length == 0) {
						if (config.login_info.is_creator && typeof friend_info.network !== 'undefined') {

							var msg = {
								"s": this.user_id,
								"m": "{\"raw\":\"" + i18n.__('chat.infos.creator_message_network_fan') + "\"}",
								"y": "s",
								"t": new Date().getTime(),
								"r": friend_info.id_user,
								"id": "convchunk_" + this.user_id + "_" + friend_info.id_user + "_" + (Math.floor(Math.random() * 9000000 + 1000000)) + "-alert-info"
							}

							$("#" + id_div_tab).append(this.message_html(this.params_to_html_params(
								msg.id,
								msg.m,
								msg.s,
								friend_info.profile_name,
								friend_info.profile_picture,
								msg.t,
								null,
								null,
								null,
								friend_info,
								'alert-info'
							)));
							return;
						}
						if (config.login_info.is_creator && !friend_info.is_support && friend_info.is_creator) {
							var msg = null;
							if (friend_info.is_referral) {
								msg = {
									"s": this.user_id,
									"m": "{\"raw\":\"" + i18n.__('chat.infos.creator_referral_message') + "\"}",
									"y": "s",
									"t": new Date().getTime(),
									"r": friend_info.id_user,
									"id": "convchunk_" + this.user_id + "_" + friend_info.id_user + "_" + (Math.floor(Math.random() * 9000000 + 1000000)) + "-alert-info"
								}
							} else if (friend_info.is_referred) {
								msg = {
									"s": this.user_id,
									"m": "{\"raw\":\"" + i18n.__('chat.infos.creator_referred_message') + "\"}",
									"y": "s",
									"t": new Date().getTime(),
									"r": friend_info.id_user,
									"id": "convchunk_" + this.user_id + "_" + friend_info.id_user + "_" + (Math.floor(Math.random() * 9000000 + 1000000)) + "-alert-info"
								}
							}
							if (msg) {
								$("#" + id_div_tab).append(this.message_html(this.params_to_html_params(
									msg.id,
									msg.m,
									msg.s,
									users_infos[msg.s].profile_name,
									users_infos[msg.s].profile_picture,
									msg.t,
									null,
									null,
									null,
									friend_info,
									'alert-info')
								));
							}
						}
						if (config.login_info.is_fan && friend_info.is_support){
							var msg = {
								"s": friend_info.id_user,
								"m": "{\"raw\":\"" + i18n.__('chat.header.support_to_fan_alert_message', {'%site%':  config.i18n_website_name }) + "\"}",
								"y": "s",
								"t": new Date().getTime(),
								"r": this.user_id,
								"id": "convchunk_" + this.user_id + "_" + friend_info.id_user + "_" + (Math.floor(Math.random() * 9000000 + 1000000)) + "-alert-info"
							}

							$("#" + id_div_tab).append(this.message_html(this.params_to_html_params(
								msg.id,
								msg.m,
								msg.s,
								friend_info.profile_name,
								friend_info.profile_picture,
								msg.t,
								null,
								null,
								null,
								friend_info,
								'alert-info'
							)));
							return;
						}
						$("#" + id_div_tab).append('<li class="chat-message chat-message--system chat-message--empty"><p>' + i18n.__('chat.infos.no_history') + '</p></li>');
						return;
					}
				}

				var first_history = true,
					old_height_from_bottom = 0;

				if ($("#" + id_div_tab + ' > li').length > 0) {
					first_history = false;
					old_height_from_bottom = $("#" + id_div_tab)[0].scrollHeight - $("#" + id_div_tab)[0].scrollTop;//$("#" + id_div_tab)[0].scrollHeight;
				}

				$('#history_' + data.recipient_id).remove();

				var users_infos = {};
				users_infos[data.recipient_id] = friend_info;
				users_infos[data.recipient_id]['is_silent_ppv'] = !!data.is_silent_ppv;
				users_infos[this.user_id] = {};
				users_infos[this.user_id].profile_name = config.login_info.profile_name;
				users_infos[this.user_id].profile_picture = config.login_info.profile_picture;

				var last_message_id = 0;
				var last_timestamp = 0;
				var last_sender = 0;
				var last_type = null;
				var message_not_displayed = false;

				var can_crypt = this.chat_friend_manager.can_crypt(data.recipient_id);
				var to_crypt = [];

				if (first_history) {
					if (friend_info.is_support) {
						if (config.login_info.is_fan) {
							var msg = {
								"s": friend_info.id_user,
								"m": "{\"raw\":\"" + i18n.__('chat.header.support_to_fan_alert_message', {'%site%':  config.i18n_website_name }) + "\"}",
								"y": "s",
								"t": new Date().getTime(),
								"r": this.user_id,
								"id": "convchunk_" + this.user_id + "_" + friend_info.id_user + "_" + (Math.floor(Math.random() * 9000000 + 1000000)) + "-alert-info"
							}

							$("#" + id_div_tab).append(
								this.message_html(this.params_to_html_params(
									msg.id,
									msg.m,
									msg.s,
									friend_info.profile_name,
									friend_info.profile_picture,
									msg.t,
									null,
									null,
									null,
									friend_info,
									'alert-info'
								))
							);
						}
					}
					else {
						if (config.login_info.is_creator) {
							if (friend_info.is_creator) {
								msg = null;
								if (friend_info.is_referral) {
									var msg = {
										"s": this.user_id,
										"m": "{\"raw\":\"" + i18n.__('chat.infos.creator_referral_message') + "\"}",
										"y": "s",
										"t": new Date().getTime(),
										"r": friend_info.id_user,
										"id": "convchunk_" + this.user_id + "_" + friend_info.id_user + "_" + (Math.floor(Math.random() * 9000000 + 1000000)) + "-alert-info"
									}
								} else if (friend_info.is_referred) {
									var msg = {
										"s": this.user_id,
										"m": "{\"raw\":\"" + i18n.__('chat.infos.creator_referred_message') + "\"}",
										"y": "s",
										"t": new Date().getTime(),
										"r": friend_info.id_user,
										"id": "convchunk_" + this.user_id + "_" + friend_info.id_user + "_" + (Math.floor(Math.random() * 9000000 + 1000000)) + "-alert-info"
									}
								}
								if (msg) {
									$("#" + id_div_tab).append(
										this.message_html(this.params_to_html_params(
											msg.id,
											msg.m,
											msg.s,
											users_infos[msg.s].profile_name,
											users_infos[msg.s].profile_picture,
											msg.t,
											null,
											null,
											null,
											friend_info,
											'alert-info'
										))
									);
								}
							}
							else {
								if (typeof friend_info.network !== 'undefined' && friend_info.network !== 'sheer') {
									var msg = {
										"s": this.user_id,
										"m": "{\"raw\":\"" + i18n.__('chat.infos.creator_message_network_fan') + "\"}",
										"y": "s",
										"t": new Date().getTime(),
										"r": friend_info.id_user,
										"id": "convchunk_" + this.user_id + "_" + friend_info.id_user + "_" + (Math.floor(Math.random() * 9000000 + 1000000)) + "-alert-info"
									}

									$("#" + id_div_tab).append(
										this.message_html(this.params_to_html_params(
											msg.id,
											msg.m,
											msg.s,
											users_infos[msg.s].profile_name,
											users_infos[msg.s].profile_picture,
											msg.t,
											null,
											null,
											null,
											friend_info,
											'alert-info'
										))
									);
								}
							}
						}
					}
				}

				var first_li = $("#" + id_div_tab + ' > li:not(.chat-message--alert-info)').first();

				for (var i in data.conversations) {
					var check_display = this.check_display_message(data.conversations[i].m, data.conversations[i].t, data.conversations[i].y, data.recipient_id);

					if ( check_display === 0 ) {
						continue;
					}

					if ( check_display === false ) {
						message_not_displayed = true;
						continue;
					}

					var fnGetForwardData = function(message) {
							var data = {};

							if (typeof message.fw !== 'undefined') data.fw = message.fw;
							if (typeof message.fwl !== 'undefined') data.fwl = message.fwl;
							if (typeof message.fwcn !== 'undefined') data.fwcn = message.fwcn;
							if (typeof message.fwsn !== 'undefined') data.fwsn = message.fwsn;

							return Object.keys(data).length ? data : null;
						},
						forward_data = fnGetForwardData(data.conversations[i]);

					if (check_display === 1 && can_crypt && (typeof data.conversations[i]["y"] == "undefined" || data.conversations[i]["y"] == "f" ) ) {
						to_crypt.push(data.conversations[i]);
					}

					var message,
						messageParams = this.message_to_html_params(data.conversations[i]),
						lastMessageisMassMessage = false;

					if (data.conversations[i].y === 'i') {
						messageParams.info_friend = friend_info;
						this.message_html(messageParams);
						continue;
					}

					if (data.conversations[i].t - last_timestamp < this.time_for_message_group
						&& last_sender === data.conversations[i].s
						&& last_timestamp > 0
						&& last_type == "f"
						&& (typeof data.conversations[i].y == "undefined" || data.conversations[i].y == "f")
					) {
						messageParams.forward = forward_data;
						messageParams.info_friend = friend_info;
						message = this.message_inside_html(messageParams);
						$("#chat_message_" + last_message_id).parent().append(message);
					} else if(first_history) {
						messageParams.forward = forward_data;
						messageParams.info_friend = friend_info;
						messageParams.user_name = users_infos[data.conversations[i].s].profile_name;
						messageParams.user_picture = users_infos[data.conversations[i].s].profile_picture;
						message = this.message_html(messageParams);
						$("#" + id_div_tab).append(message);
					} else {
						messageParams.forward = forward_data;
						messageParams.info_friend = friend_info;
						messageParams.user_name = users_infos[data.conversations[i].s].profile_name;
						messageParams.user_picture = users_infos[data.conversations[i].s].profile_picture;
						message = this.message_html(messageParams);
						message.insertBefore(first_li);
					}

					if (!message) {
						continue;
					}

					var m = message.is('.chat-message__id') ? message : message.find('.chat-message__id'),
						sender_is_user = +data.conversations[i].s === +this.user_id;
					m.data(data.conversations[i]);
					m.data({
						s: sender_is_user ? this.user_id : friend_info.id_user,
						r: sender_is_user ? friend_info.id_user : this.user_id,
						mc: this.make_real_message(this.get_real_message(data.conversations[i].m, friend_info.id_user), 'make it clear'),
						sfwv: data.conversations[i].sfwv || null,
						sfwcid: data.conversations[i].sfwcid || null,
						sfwip: data.conversations[i].sfwip || null,
						sfwiv: data.conversations[i].sfwiv || null
					});

					if (message && typeof message.trigger === "function") {
						this.chatContext.emit(ManagerEvent.MESSAGE_ADDED, message.get(0));
						message.trigger(jQuery.Event('message-added', {details: {friend_id: data.recipient_id, no_scroll: true, ready_for_get: false}}));
					}

					last_message_id = data.conversations[i].id;
					last_timestamp = data.conversations[i].t;
					last_sender = data.conversations[i].s;
					last_type = data.conversations[i].y;

					lastMessageisMassMessage = (message.find('.chat-mass-message').data('mm') && typeof message.find('.chat-mass-message').data('mm') === 'number');
				}

				$("#" + id_div_tab).trigger(jQuery.Event('conversation-loaded', {details: {friend_id: data.recipient_id}}));

				if (first_history) {
					this.chat_friend_manager.update_last_message_marker(data.recipient_id, friend_info.last_read);
				}

				if (data.conversations[0]) {
					this.chat_friend_manager.set_friend_attribut(data.recipient_id, "first_timestamp", data.conversations[0].t);
				}

				var get_history_label = '';

				if (this.messagesBatch !== data.max_nb_messages) {
					this.messagesBatch = data.max_nb_messages;
				}

				this.messagesLoadedCount[data.recipient_id] = !this.messagesLoadedCount[data.recipient_id] ? 1 : this.messagesLoadedCount[data.recipient_id] + 1;

				if ( message_not_displayed ) {
					get_history_label =  i18n.__('chat.previous_messages_cannot_decrypted');
				} else if (data.count > (this.messagesLoadedCount[data.recipient_id] * this.messagesBatch)) {
					get_history_label = i18n.__('chat.show_more_messages');
				}

				if (get_history_label && data.conversations[0]) {
					$("#" + id_div_tab)
						.prepend(Mustache.render(tpl_get_history, {id: 'history_' + data.recipient_id, label: get_history_label}))
						.find("#history_" + data.recipient_id)
						.on('click', function() {
							self.get_conversation(data.recipient_id, data.conversations[0].t - 1, this);
						});
				}

				$("#" + id_div_tab + " .chat-message__id").each(function () {
					self.quote_show_more_button_init($(this));
				});

				var allowPreserveScrollDownOnImageLoad = true;
				if (data.scroll_to_first) {
					$('#chat_loading_overlay').hide();
					ScrollConversation.toMessage("#chat_message_" + data.conversations[0].id, true);
				} else if (first_history) {
					if (ScrollConversation.getMarker(data.recipient_id).length) {
						allowPreserveScrollDownOnImageLoad = false;
						ScrollConversation.toFirstUnreadMarker(data.recipient_id);
					} else {
						ScrollConversation.down(data.recipient_id);
					}
				} else {
					ScrollConversation.down(data.recipient_id, $("#" + id_div_tab)[0].scrollHeight - old_height_from_bottom);
				}

				if (allowPreserveScrollDownOnImageLoad) {
					$("#" + id_div_tab).find('.chat-message__id--content').each(function () {
						self.vault.preserveScrollDownOnImageLoad($(this));
					});
					$("#" + id_div_tab).find('.chat-message__id--file-shared').each(function () {
						self.chat_send_file.preserveScrollDownOnImageLoad($(this));
					});
				}

				if ( data.hasOwnProperty("report") && data.report && data.report.hasOwnProperty("message_id") && data.report.hasOwnProperty("block") && data.report.hasOwnProperty("user") ) {
					message = $("#chat_group_messages_tab_" + data.recipient_id + " #" + data.report.message_id + " .chat_message_report");
					if (message.length > 0) {
						this.chat_friend_action.report_message_send( message[0], data.report.block, data.report.user, data.recipient_id, friend_info );
					}
				}

				if (to_crypt.length > 0) {

					for (var i in to_crypt) {

						if ( to_crypt[i]["m"].length >= 3 && to_crypt[i]["m"].substring(0, 2) == "c-" || to_crypt[i]["m"].substring(0, 2) == "x-" ) {
							to_crypt.splice(i,1);
							continue;
						}

						to_crypt[i]["mc"] = this.make_real_message(to_crypt[i]["m"], data.recipient_id);
					}
				}

				this.chat_friend_manager.allow_users_to_chat(friend_info);

				this.message_observe_input(friend_info.id_user);
				this.chat_friend_manager.reset_last_tip_intersection_observer(friend_info.id_user);
			},

			insert_temp_message: function (message, friend_info, timestamp) {
				var $messages = $('#chat_group_messages_tab_' + friend_info.id_user),
					$last_message = $messages.children('li').last(),
					last_sender = $last_message.hasClass('chat-message--me') ? this.user_id : friend_info.id_user,
					last_timestamp = $messages.find('.chat-message__meta--time').last().data('timestamp');

				timestamp = timestamp || Math.floor(new Date().getTime() / 1000);

				var is_inside_msg = (timestamp - last_timestamp) < this.time_for_message_group
					&& last_sender === this.user_id
					&& last_timestamp !== 0;

				var message_html = this.message_html_all(this.params_to_html_params(
					'temp_' + timestamp,
					message,
					this.user_id,
					config.login_info.profile_name,
					config.login_info.profile_picture,
					timestamp,
					null,
					null,
					null,
					friend_info,
					"f",
					is_inside_msg,
					true
				));

				$messages.find('.chat-message--empty').remove();

				if (is_inside_msg) {
					$last_message.find('.chat-message__display').append(message_html);
				} else {
					$messages.append(message_html);
				}

				ScrollConversation.down(friend_info.id_user);
			},

			message_mark_as_read: function (message, cancel_set_read_date) {
				if (!this.tabVisible) {
					wglog.debug("message_mark_as_read", 'tab is hidden');
					return;
				}

				if ($(message).length === 0) {
					wglog.debug("message_mark_as_read", 'message is undefined');
					return;
				}

				var $input = $(message).find('.chat-message__read-status input'),
					timestamp,
					$inputs = $input.parents('.chat-tab-container__list').find('.chat-message__read-status input');

				if ($input.is(':checked')) {
					timestamp = $input.data('timestamp');
				} else {
					var index = $inputs.index($input) - 1;
					timestamp = index >= 0 ? $inputs.eq(index).data('timestamp') : $input.data('timestamp') - 1;
				}

				var ref_index = $inputs.index($input);
				$inputs.each(function(index) {
					if ((index < ref_index && this.checked === false)) {
						this.checked = true;
					} else if ((index > ref_index && this.checked === true)) {
						this.checked = false;
					}

					if (this.checked) {
						$(this).siblings('label').attr('title', i18n.__('chat.mark_unread'));
					} else {
						$(this).siblings('label').attr('title', i18n.__('chat.mark_read'));
					}

					var contextual_menu = $(this).parents('.chat-message__id').find('.chat-message__action--context-menu').prop('contextMenu');
					if (contextual_menu) {
						var action = contextual_menu.getAction("read-status");

						if (!action) {
							return;
						}

						if (this.checked) {
							action.label = '<svg class="chat-scc"><use xlink:href="#scc-unread-message-indicator-icon" /></svg>' + i18n.__('chat.mark_unread');
						} else {
							action.label = '<svg class="chat-scc"><use xlink:href="#scc-unread-message-indicator-icon" /></svg>' + i18n.__('chat.mark_read');
						}

						contextual_menu.setAction(action);
					}
				});

				// Avoid set_read_date prior new friend selection (see chat friends manager select_friend()).
				var user_id = $input.data('userId');
				if (user_id === "") {
					wglog.debug("message_mark_as_read", 'user_id is empty');
					return;
				}

				var user = this.chat_friend_manager.friends[user_id];

				if (!user.cancel_set_read_date) {
					user.cancel_set_read_date = typeof cancel_set_read_date == "boolean" ? cancel_set_read_date : false;
				}

                var nbUnread = $inputs.filter(':not(:checked)').length;

                var selectedFriendInfos = this.chat_friend_manager.get_selected_friend_infos();
                if (config.login_info.is_creator && selectedFriendInfos && (selectedFriendInfos.is_blocked || selectedFriendInfos.is_ghosted)) {
                    nbUnread = 0;
                }

				this.set_read_date_v2(user_id, timestamp, nbUnread);
				this.chat_friend_manager.set_friend_attribut(user_id, 'last_read', timestamp);
				this.nb_unread_messages[user_id] = nbUnread;
			},

			message_set_pending_state: function (message_id) {
				$('#chat_message_' + message_id).find('.chat-message__actions').hide();
				$('#chat_message_' + message_id).find('.chat-message__delivery-status').removeAttr('style');
			},

			/*
			message_set_ready_state: function (message_id) {
				$('#chat_message_' + message_id).find('.chat-message__delivery-status').hide();
				$('#chat_message_' + message_id).find('.chat-message__actions').removeAttr('style');
			},
			*/

			get_default_html_params: function () {
				return {
					message_id: null,
					message: null,
					user_id: null,
					timestamp: null,
					mass_message_id: null,
					auto_message_id: null,
					type: null,
					edit: null,
					uid: null,
					forward: null,
					info_friend: null,
					user_name: '',
					user_picture: '',
					inside: false,
					isTemp: false,
					tempTime: null,
					tip: null,
					sender_id: null,
					recipient_id: null,
					sfwv: null,
					sfwcid: null,
					sfwip: null,
					sfwvp: null,
				}
			},

			params_to_html_params: function (message_id, message, user_id, user_name, user_picture, timestamp, mass_message_id, auto_message_id, forward, info_friend, type, inside, isTemp, editTime, uid, tip, sfwv, sfwcid, sfwip, sfwvp) {
				var params = this.get_default_html_params();

				if (message_id) params.message_id = message_id;
				if (message) params.message = message;
				if (user_id) params.user_id = user_id;
				if (user_name) params.user_name = user_name;
				if (user_picture) params.user_picture = user_picture;
				if (timestamp) params.timestamp = timestamp;
				if (mass_message_id) params.mass_message_id = mass_message_id;
				if (auto_message_id) params.auto_message_id = auto_message_id;
				if (forward) params.forward = forward;
				if (info_friend) params.info_friend = info_friend;
				if (type) params.type = type;
				if (inside) params.inside = inside;
				if (isTemp) params.isTemp = isTemp;
				if (editTime) params.editTime = editTime;
				if (uid) params.uid = uid;
				if (tip) params.tip = tip;
				if (sfwv) params.sfwv = sfwv;
				if (sfwcid) params.sfwcid = sfwcid;
				if (sfwip) params.sfwip = sfwip;
				if (sfwvp) params.sfwvp = sfwvp;

				return params;
			},

			message_to_html_params: function (message) {
				var params = this.get_default_html_params();

				if (message.id) params.message_id = message.id;
				if (message.m) params.message = message.m;
				if (message.s) params.user_id = message.s;
				if (message.s) params.sender_id = message.s;
				if (message.r) params.recipient_id = message.r;
				if (message.t) params.timestamp = message.t;
				if (message.mm) params.mass_message_id = message.mm;
				if (message.am) params.auto_message_id = message.am;
				if (message.y) params.type = message.y;
				if (message.e) params.edit = message.e;
				if (message.u) params.uid = message.u;
				if (message.tip) params.tip = message.tip;
				if (message.hasOwnProperty('sfwv')) params.sfwv = message.sfwv;
				if (message.sfwcid) params.sfwcid = message.sfwcid;
				if (message.sfwip) params.sfwip = message.sfwip;
				if (message.sfwvp) params.sfwvp = message.sfwvp;

				return params;
			},

			message_html: function (params) {
				if (params.type === "i" && params.info_friend) {
					params.message = this.get_real_message(params.message, params.info_friend.id_user)
					this.message_internal(params);
					return "";
				}
				return this.message_html_all(params);
			},

			message_inside_html: function (params) {
				params.inside = true;
				return this.message_html_all(params);
			},

			message_for_upload_progress_bar: function(file_id, upload_bar_html, id_recipient) {
				var message = "Encrypting file ...",
					messageParams = this.params_to_html_params(
						"upload_bar_" + file_id,
						message,
						this.user_id,
						this.profile_name,
						this.profile_picture,
						(new Date()).getTime()/1000,
						null,
						null,
						null,
						this.chat_friend_manager.get_friend_infos(id_recipient),
						"js",
						false
					);
				var message_html = this.message_html_all(messageParams);
				message_html.find(".chat_message.message_right").html(upload_bar_html);
				$("#chat_group_messages_tab_" + id_recipient).append($(message_html));
			},

			message_html_all: function (params) {
				var message_id = params.message_id,
					message = params.message,
					user_id = params.user_id,
					user_name = params.user_name,
					user_picture = params.user_picture,
					timestamp = params.timestamp,
					mass_message_id = params.mass_message_id,
					auto_message_id = params.auto_message_id,
					forward = params.forward,
					info_friend = params.info_friend,
					type = params.type,
					inside = params.inside,
					isTemp = params.isTemp,
					editTime = params.edit,
					uid = params.uid;

				var info = {};
				info.is_temp = typeof isTemp === "boolean" ? isTemp : false;
				info.class_date = "";
				info.class_name = "";
				info.message_from = "";
				if (user_id === this.user_id) {
					info.class_li = "message_right";
					info.class_name = "header_message_right";
					info.message_from = "me";
					info.is_user_not_reviewed = false;
				} else {
					info.class_li = "message_left";
					info.class_name = "header_message_left";
					info.message_from = "friend";
					info.profile_url = info_friend.profile_url;
					info.is_user_not_reviewed = config.login_info.is_support && info_friend.is_creator && info_friend.review_status && info_friend.review_status !== 'validated';
				}

				info.message_id = message_id;
				info.message = this.get_real_message(message, info_friend.id_user);
				info.message_report = info.message;
				info.user_id = user_id;
				info.friend_id = info_friend.id_user;
				info.display_user_name = user_id != this.user_id;
				info.user_name = `<b>${(user_name)}</b>`;
				info.user_picture = user_picture;
				info.avatar = Mustache.render(tpl_avatar, {
					src: user_picture,
					alt: user_name,
					profile_url: info_friend.profile_url,
					display_handshake: info.display_handshake,
					review_not_validated: i18n.__('chat.application.not_validated'),
				});
				info.profile_url = info_friend.profile_url;
				info.last_read = info_friend.last_read;
				info.display_read_status = user_id != this.user_id;
				info.read = info_friend.last_read ? timestamp < info_friend.last_read : false;
				info.read_status_label_title = info.read ? i18n.__('chat.mark_unread') : i18n.__('chat.mark_read');
				info.display_delivery_status = user_id === this.user_id;
				info.display_metas = true;
				info.display_cm = true;
				info.has_delete = user_id === this.user_id;
				info.time = this.format_timestamp(timestamp);
				info.timestamp = timestamp;
				info.relative_time = this.format_timestamp_relative(timestamp);
				info.enable_refresh_rt = (Date.now() - timestamp * 1000) < (24 * 3600000); // Limit refresh to messages from last 24 hours
				info.read_status_timestamp = timestamp;

				if (!!mass_message_id) {
					info.id_mass_message = parseInt(mass_message_id);
				}
				if (!!auto_message_id) {
					info.id_auto_message = parseInt(auto_message_id);
				}

				info.class_multi = (inside) ? 'message_multi' : '';
				info.class_multi += (info.is_temp ? ' chat-message-temp' : '');
				info.class_multi += (!!mass_message_id ? ' chat-mass-message' : '');
				info.class_multi += (!!auto_message_id ? ' chat-auto-message' : '');

				if (!!editTime) {
					info.e = editTime;
				}

				info.uid = (typeof uid !== 'undefined' && typeof uid === 'string' && uid.length > 0) ? true : false;

				info.trad = {
					remove: i18n.__('misc.actions.remove'),
					report: i18n.__('misc.actions.report'),
					quote: i18n.__('misc.actions.quote'),
					edit: i18n.__('misc.actions.edit'),
					select: i18n.__('misc.actions.select'),
					forward_to_fan_support: i18n.__('chat.forward_to_fan_support')
				}

				var msg,
					self = this,
					is_content = false,
	                json = null,
	                quote = null,
					is_upload = false,
					is_sfw = type === 'sfw',
					is_original_message = false;

				if (typeof info.message === "string" && info.message.startsWith('{') && info.message.endsWith('}')) {
					try {
						json = JSON.parse(info.message);
					} catch (e) {
						// Not a json content.
						wglog.debug('Manager::message_html_all', 'The JSON data from info.message can\'t be parsed');
					}
				}

				if (forward) {
					info.forwarded = true;
					var forward_datas = {};

					if (forward.fw) {
						is_original_message = (typeof forward.fw.s === 'undefined' || typeof forward.fw.t === 'undefined');

						forward_datas.from = {
							t: parseInt(forward.fw.t),
							id: parseInt(forward.fw.s)
						}

						if (forward.fwcn) {
							forward_datas.from.name = forward.fwcn;
						}
					}
					if (forward.fwl) {
						var array_keys = Object.keys(forward.fwl),
							last_key = array_keys[array_keys.length - 1];

						forward_datas.to = {
							t: parseInt(last_key),
							id: parseInt(forward.fwl[last_key])
						}

						if (forward.fwsn) {
							forward_datas.to.name = forward.fwsn;
						}
					}
					info.display_cm = !is_original_message;

					for (var key in forward_datas) {
						if (typeof this.chat_friend_manager.friends[forward_datas[key].id] === "undefined") {
							forward_datas[key].profile_name = forward_datas[key].name || i18n.__('chat.another_support');
							forward_datas[key].id = null;
						}
						else {
							forward_datas[key].profile_name = this.chat_friend_manager.friends[forward_datas[key].id].profile_name;
						}
					}

					if (!!forward_datas.from) {
						info.forwarded_from = !!forward_datas.from;
						info.forward_label_from = i18n.__('chat.forwarded_from');
						info.timestamp_forward_from = forward_datas.from.t;
						info.time_forward_from = this.format_timestamp(forward_datas.from.t);
						info.relative_time_forward_from = this.format_timestamp_relative(forward_datas.from.t);
						info.user_name_forward_from = forward_datas.from.profile_name || '';
						info.user_id_from = forward_datas.from.id || '';
						info.read_status_timestamp = forward_datas.from.t;
					}

					if (!!forward_datas.to) {
						info.forwarded_to = !!forward_datas.to;
						info.forward_label_to = i18n.__('chat.forwarded_to');
						info.timestamp_forward_to = forward_datas.to.t;
						info.time_forward_to = this.format_timestamp(forward_datas.to.t);
						info.relative_time_forward_to = this.format_timestamp_relative(forward_datas.to.t);
						info.user_id_to = forward_datas.to.id || '';
						info.user_name_forward_to = (forward_datas.to.profile_name !== config.login_info.profile_name) ? forward_datas.to.profile_name : i18n.__('chat.another_support');
					}
				}

				if (!json && forward) {
					var f_info;
					if (!!forward.fw && !!forward.fw.s) {
						f_info = this.chat_friend_manager.friends[forward.fw.s];
					}
					if (typeof f_info === 'undefined') {
						f_info = {
							profile_name: i18n.__('chat.another_support'),
							id: null
						}
					}
					var modifier_forward = 'forward';

					if (is_original_message) {
						modifier_forward += ' chat-quote--forward-origin';
					}

					var quotable_msg = info.message;

					info.display_metas = true;
					info.timestamp = timestamp;
					info.time = this.format_timestamp(timestamp);
					info.relative_time = this.format_timestamp_relative(timestamp);
					info.user_name = user_name || '';
					info.quote = Mustache.render(tpl_message_quote, {
						modifier: modifier_forward,
						forwarded: !!forward,
						content: emoji.utf8ToHtml(utils.escapeHtml(info.message))
							.replace(new RegExp('(\n|&lt;br ?\/?&gt;)', 'g'), '<br>')
							.replace('&amp;', '&')
							.replace(/&lt;\/?font( style=\"vertical-align: inherit;\")?&gt;/gm, ''),
						user_id: f_info.id || '',
						user_name: f_info.profile_name
					});

					info.message = '';

					if (inside) {
						msg = $(Mustache.render(tpl_message_inside, info));
					} else {
						msg = $(Mustache.render(tpl_message, info, {"inside": tpl_message_inside} ));
					}

					(inside ? msg : msg.find('.chat-message__id')).prop('quotable_msg', quotable_msg);
				} else if (typeof type =="undefined" || type === "f" || type === "c" || type === "js" || type === "sr" || type === "sfw") {
					if (json && (json.q || json.qI)) {
                        if (json.qI) {
                            json.qI = utils.sanitizeId(json.qI);

                            if (!json.q) {
                                var $el = $('#' + json.qI);
                                json.q = $el.length ? $el.find('.chat-message__message p').text().trim() : i18n.__('chat.error.param_no_message');
                            }
                        }

						quote = json;

						var t = parseInt(json.t),
							modifier_class = 'message';

						if (!!forward) {
							modifier_class += ' chat-quote--message-forwarded';
						}
						if (is_original_message) {
							modifier_class += ' chat-quote--message-forwarded-origin';
						}

						var content = "",
							use_paragraph = true;
						if (typeof json.q === 'string') {
							content = emoji.utf8ToHtml(utils.escapeHtml(json.q))
								.replace(new RegExp('(\n|&lt;br ?\/?&gt;)', 'g'), '<br>')
								.replace('&amp;', '&')
								.replace(/&lt;\/?font( style=\"vertical-align: inherit;\")?&gt;/gm, '');
						} else if (json.q.hasOwnProperty('type') && json.q.type === 'upload') {
							use_paragraph = false;
							content = this.chat_send_file.get_message_html({}, json.q, Date.now());
							modifier_class += ' chat-quote--message-visible';
							modifier_class += ' chat-quote--file-shared';
						}

						info.message = json.m;
						info.message_report = '"' + json.m + '"  ' + json.aN + ', ' + this.format_timestamp(t);
						info.quote = Mustache.render(tpl_message_quote, {
							modifier: modifier_class,
							enable_refresh_rt: (Date.now() - timestamp * 1000) < (24 * 3600000),
							content: content,
							time: this.format_timestamp(t),
							timestamp: t,
							relative_time: this.format_timestamp_relative(t),
							user_id: json.aI || '',
							user_name: json.aN || '',
							message_id: json.qI,
							show_more_label: is_original_message ? false : i18n.__('chat.show_more'),
							use_paragraph: use_paragraph
						});
					}

					if (json && json.type === "upload") {
						is_upload = true;
						info.is_temp = true;
						json.filename = utils.sanitize_filename(json.filename);
						info.message = JSON.stringify(json);
						info.message_html = this.get_uploaded_file_message_html(info, json, timestamp);
						info.message_report = json.filename;

						if (json.text) {
							info.message_report += '\n\n' + json.text;
						} else {
							info.class_multi += " chat-message-temp chat-message__id--file-shared chat-message__id--file-shared-loading";
						}
					}

					if (json && type === "sr") {
						var _srMessage = MessageUtils.getSpamReportMessage(json.r);

						info.message_html = '<p>' + _srMessage.replace(new RegExp('\n', 'g'), '<br>') + '</p>';
						info.message_html += '\n<ol class="chat-message__message-list">';
						for (var _msg of json.ml) {
							if (typeof _msg !== 'string') {
								info.message_html += '\n<li class="chat-message__message-list-item">' + i18n.__('chat.error.unable_to_display_message') + '</li>';
								continue;
							}

							var _msgToDisplay = '';
							if (_msg.substring(0, 2) === 'c-') {
								_msg = _msg.substring(2);
							}

							try {
								var _msgJson = JSON.parse(_msg),
									_msgJsonMessage = null;

								if (typeof _msgJson.message === 'string') {
									if (_msgJson.message.substring(0, 2) === 'c-') {
										_msgJson.message = _msgJson.message.substring(2);
									}

									_msgJsonMessage = JSON.parse(_msgJson.message);
								} else if (typeof _msgJson.message === 'undefined') {
									_msgJsonMessage = _msgJson;
								}

								_msgToDisplay = this.vault.getTempContentHtml(_msgJsonMessage, info, null, 'row');
							} catch (e) {
								_msgToDisplay = _msg.replace(new RegExp('\n', 'g'), '<br>');
							}
							info.message_html += '\n<li class="chat-message__message-list-item">' + _msgToDisplay + '</li>';
						}
						info.message_html += '\n</ol>';

					} else if (json && type === "c") {
						is_content = true;
						inside = false;
						info.is_temp = true;
						info.class_multi += " chat-message-temp chat-message__id--content";
						var messageJSON;
						try {
							messageJSON = (typeof json.message === 'string' && json.message ? JSON.parse(json.message.substring(2)) : json);
						} catch (e) {
							wglog.debug('json', json);
							wglog.error('manager::message_html_all unable to display content/vault message', e.message);
						}
						info.message_html = this.vault.getTempContentHtml(messageJSON, info);
						info.message_report = i18n.__('chat.paid_content_message');
					}

					info.message = utils.escapeHtml(info.message);
					info.message = emoji.utf8ToHtml(info.message).replace(new RegExp('\n', 'g'), '<br>');

					if (inside) {
						msg = $(Mustache.render(tpl_message_inside, info));
					} else {
						msg = $(Mustache.render(tpl_message, info, {"inside": tpl_message_inside} ));
					}

					if (type === "sfw") {
						var creatorId = config.login_info.is_support ? params.friend_id : null;
						msg.data()
						SFWMessage.appendMediaGrid(msg, params);
						SFWMessage.appendSFWForm(msg, params.sfwv, config.login_info.is_support);
					}

					if (!!info.e) {
						var msg_edit = msg.hasClass('chat-message__id') ? msg : msg.find('.chat-message__id');
						if (info.message_from === 'me') {
							msg_edit.prepend($(Mustache.render(tpl_message_edit, { date: editTime })));
						}
						if (info.message_from === 'friend') {
							msg_edit.append($(Mustache.render(tpl_message_edit, { date: editTime })));
						}
					}

					$('img', msg).on('error', function() {
						$(this).hide();
					});

					if (type === "f") {
						(inside ? msg : msg.find('.chat-message__id')).prop('quotable_msg', info.message);
					}
					if (is_upload) {
						(inside ? msg : msg.find('.chat-message__id')).prop('quotable_msg', json.text);
						(inside ? msg : msg.find('.chat-message__id')).prop('quotable_upload', json);
					}
				} else if (type === "tip" && params.tip) {
					info.display_user_name = true;
					info.type = "tip";
					if (params.message) {
						info.tip_with_message = params.message.length > 0;
						// Start fix - fix some message badly saved
						if (params.message.substring(0, 1) === '{' && params.message.substring(params.message.length - 1) === '}') {
							var paramMessageJSON;
							try {
								paramMessageJSON = JSON.parse(params.message);
							} catch (e) {
								// not JSON
								info.tip_with_message = false;
								info.message = '';
							}
							if (paramMessageJSON.param['%message%']) {
								info.message = paramMessageJSON.param['%message%'];
							} else {
								info.tip_with_message = false;
								info.message = '';
							}
						}
						// End fix
					}

					var messageDisplayI18nKey = "chat.tip.confirmation_fan",
						messageDisplayI18nParams = {
							"%amount%": '<b>' + new Intl.NumberFormat(config.locale, { style: 'currency', currency: 'USD' }).format(params.tip) + '</b>',
							"%username%": '<b>' + info_friend.profile_name + '</b>',
						};

					if (user_id !== this.user_id) {
						messageDisplayI18nKey = "chat.tip.confirmation_creator";
						messageDisplayI18nParams["%username%"] = '<b>' + params.user_name + '</b>';
					}

					message_display = i18n.__(messageDisplayI18nKey, messageDisplayI18nParams);

					var tpl = tpl_system_message,
						tpl_partials = {};

					if (info.tip_with_message) {
						info.user_name = message_display;
						info.message_from = +user_id === +this.user_id ? 'me-tip' : 'friend-tip';
						info.message = emoji.utf8ToHtml(utils.escapeHtml(info.message)).replace(new RegExp('\n', 'g'), '<br>');
						tpl = tpl_message;
						tpl_partials = {"inside": tpl_message_inside};
					}  else {
						info.message = message_display;
					}

					msg = $(Mustache.render(tpl, info, tpl_partials));
					msg.get(0).dataset.timestamp = timestamp;
				} else if ( type === "alert-info" ) {
					var message_system;

					try {
						message_system = JSON.parse(info.message);
					} catch (e) {
						wglog.debug("system message: failed to parse JSON");
						return "";
					}

					var message_display = message_system.raw;

					if ( message_display == "" ) {
						return "";
					}

					info.message = utils.escapeHtml(message_display);
					info.type = "alert-info";

					msg = $(Mustache.render(tpl_system_message, info));
				} else if ( type == "s" ) {

					var message_system;
					var message_display = "";
					try {
						message_system = JSON.parse(info.message);
					} catch (e) {
						wglog.debug("system message: failed to parse JSON");
						return "";
					}

					if ( typeof message_system.trad !== "undefined" ) {
						var params = {};
						if ( typeof message_system.param !== "undefined" ) {
							for (var key in message_system.param) {
								if ( typeof message_system.param[key].trad !== "undefined" ) {
									params[key] = i18n.__( message_system.param[key].trad );
								} else if ( typeof message_system.param[key].raw !== "undefined" ) {
									params[key] = message_system.param[key].raw;
								}
							}
						}
						message_display = i18n.__(message_system.trad, params);
						info.type = 'system';
					} else if ( typeof message_system.raw !== "undefined" ) {
						message_display = message_system.raw;
					}

					if ( message_display == "" ) {
						return "";
					}

					info.message = utils.escapeHtml(message_display);
					msg = $(Mustache.render(tpl_system_message, info));
				} else {
					wglog.debug("message_html_all: unknown message type");
					return "";
				}

				if(!!forward_datas) {
					this.add_forward_link_message(msg, ((!!forward_datas.to && !!forward_datas.to.id) ? forward_datas.to.id : null));
				}

				var msg_event = msg;
				if (!inside) {
					msg_event = msg.find('#chat_message_' + message_id );
				}

				if ( $('html').hasClass("notouch") ) {
					msg_event.on('mouseover', function() {
						$('#chat_message_' + message_id + ' .report-message').show();
					});
					msg_event.on('mouseout', function() {
						$('#chat_message_' + message_id + ' .report-message').hide();
					});
				}

				if (msg_event.length) {
					var cm_actions = [];
					if (info.message_from === 'me') {
						if (is_upload || info.uid && !is_content && !is_sfw) {
							cm_actions.push({
								name: 'edit',
								label: '<svg class="chat-scc"><use xlink:href="#scc-edit-message"></use></svg>' + info.trad.edit,
								disabled: (parseInt(Date.now() / 1000) - timestamp) >= (7 * 24 * 60 * 60),
								reason: '<small><i>' + i18n.__('chat.editing_disabled') + '</i></small>',
								callback: function() {
									if (info.message_id === null || info.message_id.length === 0 || info.message === null || info.message.length === 0) {
										return;
									}
									var expireEditTime = new Date().setDate(new Date().getDate() + 7);
									if (info.timestamp > expireEditTime) {
										log_and_tooltip.modal(
											'<p>'+i18n.__('chat.warning_unable_to_edit_content')+'</p>',
											{
												title: i18n.__('chat.warning_unable_to_edit'),
												closable: true
											}
										);
										return;
									}
									var $chat_message_id = this.getButton().closest('.chat-message__id'),
										quotable_message = $chat_message_id.prop('quotable_msg');

									var data = {
										'convchunk': $chat_message_id.prop('id').split('chat_message_')[1]
									};
									if (quote) {
										data.quote = quote;
										self.display_quote_into_form(quote.q, quote.qI.split(/#?chat_message_/)[1], quote.aI, quote.aN, quote.t);
									}
									if (is_upload) {
										data.upload = json;
									}
									$('.chat-message-form__textarea-edit-popup').addClass('chat-message-form__textarea-edit-popup--visible');
									$('#chat-textarea-edit-close').on('click', function() {
										self.empty_message_form();
										$('#textarea-group .emojionearea-editor')
											.html('')
											.blur();
									});
									self.input
										.val(quotable_message.replace(/<br>/g, '\n'))
										.data(data);
									$('#textarea-group .emojionearea-editor')
										.html(utils.escapeHtml(quotable_message))
										.focus();
								}
							});
						}

						//cm_actions.push({name: 'remove', label: '<span class="icon-f icf-bin"></span>' + info.trad.remove, callback: function() { self.ask_delete_message(message_id); }});
					}

					if ((info_friend.network !== 'xvideos' || info_friend.is_creator) && !is_content) {
						cm_actions.push({
							name: 'quote',
							before: 'remove',
							label: '<span class="icon-f icf-quotes-left"></span>' + info.trad.quote,
							callback: function(message, message_id, user_id, user_name, timestamp) {
								var _msg = is_upload && json.text ? json.text : message;
								self.display_quote_into_form(_msg, message_id, user_id, user_name, timestamp);
							},
							callback_params: [
								info.message,
								message_id,
								user_id,
								(user_id == this.user_id ? config.login_info.profile_name : info_friend.profile_name),
								timestamp
							]
						});
					}

					if (info.message_from === 'friend' || info.message_from === 'friend-tip') {
						cm_actions.push({
							name: 'read-status',
							label: '<svg class="chat-scc"><use xlink:href="#scc-unread-message-indicator-icon" /></svg>' + info.read_status_label_title,
							callback: function() {
								var input = msg_event.find('.chat-message__read-status input');
								if (input.length) {
									input.prop('checked', !input.prop('checked'));
								}

								self.message_mark_as_read(msg_event);
							}
						});
						if (config.login_info.is_fan && info_friend.is_creator) {
							cm_actions.push({
								name: 'report',
								label: '<span class="icon-f icf-flag"></span>' + i18n.__('report_form.report'),
								callback: function() {
									self.chatContext.emit(MessageEvent.REPORT_OPEN_FORM, {
										message: info.message_report,
										idUser: info_friend.id_user,
										massMessageId: mass_message_id,
									});
								}
							});
							cm_actions.push({
								name: 'silent',
								label: !!info_friend.is_silent_ppv ? ('<span class="icon-f icf-bell"></span>' + i18n.__('chat.silent_mode_disable')) : ('<span class="icon-f icf-bell-slashed"></span>' + i18n.__('chat.silent_mode_enable')),
								callback: function() {
									self.chatContext.emit(MessageEvent.SILENT_PPV, info_friend.id_user);
								}
							});
						} else if (config.login_info.is_creator && !info_friend.is_creator && !info_friend.is_support) {
							cm_actions.push({
								name: 'report',
								label: '<span class="icon-f icf-flag"></span>' + i18n.__('report_form.report'),
								callback: function() {
									self.chatContext.emit(MessageEvent.FAN_REPORT_OPEN_FORM, {
										messageId: info.message_id,
										idUser: info_friend.id_user,
									});
								}
							});
						}
					}

					if (config.login_info.is_creator && info.message_from === 'friend' && !info_friend.is_creator && !info_friend.is_support) {
						cm_actions.push({
							name: 'forward-to-support',
							label: '<span class="icon-f icf-forward"></span>' + info.trad.forward_to_fan_support,
							callback: function() {
								self.chatContext.emit(MessageEvent.FORWARD_MESSAGE_TO_FAN_SUPPORT, message_id, info_friend.id_user);
							}
						});
					}

					if (config.file_upload != "none" && !!this.chat_send_file) {
						this.chat_send_file.alter_message_actions(cm_actions, msg, message_id);
					}

					if (!is_sfw && config.login_info.is_support && +config.login_info.id !== 43038155) {
						cm_actions.push({
							name: 'select',
							label: '<span class="icon-f icf-checkbox-checked"></span>' + info.trad.select,
							callback: function() {
								select_messages.addToSelection(message_id);
							}
						});
					}

					if (info.display_metas) {
						if (cm_actions.length === 0) {
							msg_event.find('.chat-message__action--context-menu').prop('disabled', true).hide();
						}
						else {
							var target = msg.hasClass('chat-message__id') ? msg : msg.find('.chat-message__id');
							if (msg_event.find('.chat-message__action--context-menu').length) {
								new contextual_menu(msg_event.find('.chat-message__action--context-menu'), cm_actions, {
									relative_to: $('.chat-messages'),
									position: {v: 'above', h: 'right'},
									offset: {above: 8},
									close_on_scroll: $('#chat_group_messages_tab_' + info_friend.id_user),
									on_open: function () {
										target.addClass('chat-message__id--context-menu-open');
									},
									on_close: function () {
										target.removeClass('chat-message__id--context-menu-open');
									}
								});
							}
						}
					}
				}

				msg.on('click', '.chat-quote[data-quote-message-id]:not(.chat-quote--file-shared)', function (event) {
					if ($(event.target).hasClass('chat-quote__show-more') || select_messages.isSelecting()) {
						return;
					}
					self.quote_scroll_or_request($(this).data('quote-message-id'));
				});

				msg.find('.report-message').on('click', function(event) {
					event.preventDefault();
					event.stopPropagation();
					self.chat_friend_action.report_message(this, user_id, info_friend);
				});

				if (typeof type =="undefined" || type == "f") {
					if (config.file_upload.method === "default") {
						this.chat_send_file.check_for_upload(msg, info.message, this.user_id, info_friend.id_user, "chat_message_" +message_id, this.key_decrypt_last_message, info.not_read, timestamp);
					}
				}

				return msg;
			},

			message_internal: function( message_id, message, user_id, user_name, timestamp, info_friend ) {
				var ret = chat_internal_message.execute_action( this, message_id, message, user_id, timestamp, info_friend );

				if ( ret === true ) {
					return true;
				}
				if ( typeof ret.error !== "undefined" ) {
					wglog.debug("chat_internal_message", ret.error);
				}

				return false;
			},

			message_observe_input: function (friend_id, unobserve) {
				if (!window.IntersectionObserver) {
					return;
				}

				var method = (typeof unobserve == 'boolean' && unobserve ? 'un' : '') + 'observe';
				var self = this;

				$("#chat_messages_tab_" + friend_id + " .chat-message__read-status label").each(function () {
					self.message_intersection_observer[method](this);
				});
			},
			message_intersection_observer_cb: function (entries) {
				if (this.chat_friend_manager.get_selected_friend_infos().cancel_set_read_date) {
					wglog.debug("message_intersection_observer_cb", 'selected user cancel_set_read_date: true');
					return;
				}

				var self = this,
					allEntries = entries,
					updateMessages = function() {
						var message = undefined;
						allEntries.forEach(function(entry) {
							var input = entry.target.parentNode.querySelector('input');
							if (input && !input.checked && entry.isIntersecting) {
								input.checked = true;
								message = entry.target.closest('.chat-message__id');
								if (message && config.login_info.is_fan) {
									self.updateStatMessageViewed(message);
								}
							}
						});
						if (message) {
							self.message_mark_as_read(message);
						}
					};

				if (!this.tabVisible) {
					wglog.debug("message_intersection_observer_cb", 'tab is hidden');
					this.tabQueue.push(updateMessages);
					return;
				}

				updateMessages();
			},

			updateStatMessageViewed: function(message) {
				message = $(message);
				var idMassMessage = this.getIdCreatorMessageFromAFriend(message, 'mm'),
					idAutoMessage = this.getIdCreatorMessageFromAFriend(message, 'am');

				if ((!idMassMessage && !idAutoMessage) || !(message.closest('li').hasClass('chat-message--friend'))) {
					return;
				}

				var feature_event = idMassMessage !== false ? 'update_stats_mass_message' : 'update_stats_auto_message',
					data_stats = { stats: 'message_viewed' };

				if (feature_event === 'update_stats_mass_message') {
					data_stats.mass_message_id = parseInt(idMassMessage);
				} else if (feature_event === 'update_stats_auto_message') {
					data_stats.auto_message_id = parseInt(idAutoMessage);
				}

				this.socket_connection.emit(feature_event, data_stats);
			},

			check_display_message: function(message, timestamp, message_type, recipient_id) {
				if ( ["c-", "x-"].indexOf(message.substring(0, 2)) !== -1 ) {
					return 1;
				}
				if (message.substring(0, 1) === "{") {
					return 1;
				}
				if (message_type === 'tip' && ["c-", "x-"].indexOf(message.substring(0, 2)) === -1) {
					return 1;
				}

				var message_decrypt = this.get_real_message_try_decrypt( message, recipient_id);
				if (message_decrypt) {
					return true;
				}

				if ( typeof this.chat_friend_manager.keys_create_timestamp == "undefined" || timestamp > this.chat_friend_manager.keys_create_timestamp ) {
					return 0;
				}

				return false;
			},

			add_forward_link_message: function(msg, id) {
				if (config.login_info.is_support) {
					return;
				}
				var $msgMetaForward = msg.find('.chat-message__meta-forward');
				if ($msgMetaForward.length === 0) {
					return;
				}

				var $msgContainer = msg.find('.chat-message__message'),
					self = this;

				if (typeof id !== 'undefined' && id !== null) {
					$msgContainer.addClass('is-clickable').on('click', function(event) {
						event.preventDefault();
						event.stopPropagation();
						self.chat_friend_manager.select_friend(id);
					});
				}

				$msgMetaForward.each(function() {
					var $this = $(this),
						$supportConv = $this.find('.chat-message__meta-contact'),
						idConv = $supportConv.data('id');

					if (typeof idConv === 'number' && idConv !== config.login_info.id_user) {
						$supportConv.addClass('is-clickable').on('click', function(event) {
							event.preventDefault();
							event.stopPropagation();
							self.chat_friend_manager.select_friend(idConv);
						});
					}
				});
			},

			get_real_message: function(message, recipient_id, keys) {
				if (!message) {
					wglog.debug("get_real_message", 'no message');
					return i18n.__('chat.unable_decrypt');
				}

				if (!keys) {
					keys = this.chat_friend_manager.get_conversation_keys(recipient_id);
				}

				// Invalid message formats
				var prefix = message.substring(0, 2);
				if ( ["c-", "x-"].indexOf(prefix) === -1 ) {
					if (prefix[0] !== '{') {
						wglog.debug("get_real_message", 'invalid prefix');
					}
					return message;
				}

				if ( prefix === "x-" && message.length < 21 ) {
					wglog.debug("get_real_message", 'invalid length for encrypted message');
					return message;
				}

				// Handle valid formats
				message = utils.unescapeHtml(message);

				if (prefix === "c-") {
					return message.substring(2);
				}

				var real_message = this.get_real_message_decrypt(message, recipient_id, keys);
				if (typeof real_message != "string") {
					wglog.debug("get_real_message", 'unable to decrypt message');
					real_message = i18n.__('chat.unable_decrypt');
				}

				return real_message;
			},

			get_real_message_decrypt: function(message, recipient_id, keys) {
				var friend_infos = this.chat_friend_manager.get_friend_infos(recipient_id);

				if ( !keys && (friend_infos === false || typeof friend_infos["conversation_key"] == "undefined") ) {
					if ( friend_infos !== "false" && ( typeof friend_infos['new_conv_key_asked'] == "undefined" || friend_infos['new_conv_key_asked'] !== true ) ) {
						this.chat_friend_manager.set_friend_attribut(recipient_id, "new_conv_key_asked", true);
						this.socket_connection.emit("get_conv_key", {"id_friend": recipient_id});
					}

					return i18n.__('chat.unable_decrypt') + " " + i18n.__('misc.reload_the_page');
				}

				message = this.get_real_message_try_decrypt(message, recipient_id, keys);

				if ( message === false ) {
					return i18n.__('chat.unable_decrypt');
				}

				return message;
			},

			get_real_message_try_decrypt: function(message, recipient_id, keys) {
				// Remove message prefix
				message = message.substring(2);

				// Get conversation keys
				if (!Array.isArray(keys)) {
					keys = this.chat_friend_manager.get_conversation_keys(recipient_id);
				}

				if (keys.length === 0) {
					return false;
				}

				// Decrypt message
				return this.decrypt_message(message, keys);
			},

			decrypt_message: function (message, keys) {
				var decrypted;
				this.key_decrypt_last_message = "";

				for (var i in keys) {
					try {
						decrypted = cryptojs.AES.decrypt(message, keys[i]).toString(cryptojs.enc.Utf8);
						this.key_decrypt_last_message = keys[i];
					} catch (e) {
						continue;
					}
					if (decrypted) {
						break;
					}
				}

				if (!decrypted) {
					return false;
				}

				return decrypted;
			},

			make_real_message: function(message, recipient_id) {
				if(isNaN(parseInt(recipient_id))) {
					return "c-" + message;
				}

				var key = this.get_last_conv_key(recipient_id);

				if (key == "") {
					return "c-" + message;
				}
				if (config.login_info.is_support || this.chat_friend_manager.get_friend_infos(recipient_id).is_support || this.chat_friend_manager.get_friend_infos(recipient_id).disable_encryption) {
					return "c-" + message;
				}

				try {
					var crypted = cryptojs.AES.encrypt(message, key).toString();
				} catch (e) {
					wglog.debug("Failed to encrypt message");
					return "c-" + message;
				}

				return "x-" + crypted;
			},

			get_last_conv_key: function(recipient_id) {
				var friend_infos = this.chat_friend_manager.get_friend_infos(recipient_id);
				if (friend_infos === false) {
					wglog.error("Failed to encrypt message, no friend infos");
					return "";
				}
				if (typeof friend_infos["conversation_key"] == "undefined") {
					return "";
				}

				var date_key = "";
				for (var date in friend_infos["conversation_key"]) {
					if ( date > date_key && friend_infos["conversation_key"][date] != null) {
						date_key = date;
					}
				}

				if (date_key == "") {
					wglog.error("Failed to encrypt message, no decryptable friend keys");
					return "";
				}

				return friend_infos["conversation_key"][date_key];
			},

			scroll_to_caret: function () {
				var selection = window.getSelection();

				if (!selection.rangeCount) {
					return;
				}
				var range = selection.getRangeAt(0);
				if (range.commonAncestorContainer === document) {
					return;
				}
				var br = document.createElement('br');
				range.insertNode(br);
				br.scrollIntoView({block: 'end'});
				br.remove();
			},

			// Rewrite of set_read_date.
			set_read_date_v2: function (friend_id, timestamp, nb_unread) {
				if (friend_id == 0) {
					wglog.debug("set_read_date_v2", "friend_id is 0");
					return;
				}

				if (this.chat_friend_manager.friends[friend_id].cancel_set_read_date) {
					delete this.chat_friend_manager.friends[friend_id].cancel_set_read_date;
					wglog.debug("set_read_date_v2", "friend_is has cancel_set_read_date");
					return;
				}

				if (typeof timestamp !== "number") {
					wglog.debug("set_read_date_v2", "timestamp is not a number");
					return;
				}

				if (this.set_read_date_queue_manager) {
					this.set_read_date_queue_manager.set(friend_id, {
						"type": "friend",
						"id": friend_id,
						"timestamp": timestamp || (Math.round(new Date().getTime() / 1000)),
						"nb_unread": nb_unread || 0
					});
				} else {
					this.socket_connection.emit("set_read_date", {
						"type": "friend",
						"id": friend_id,
						"timestamp": timestamp || (Math.round(new Date().getTime() / 1000)),
						"nb_unread": nb_unread || 0
					});
				}

				// update last_read_date to SW
				if (this.chatInitsAndPrefs.serviceWorker) {
					try {
						this.chatInitsAndPrefs.serviceWorker.postMessage({
							"action": "update_friend_last_read",
							"friend_id": friend_id,
							"friend_last_read": timestamp
						});
					} catch (e) {
						wglog.error('Failed to send update_friend_last_read to SW', e.toString());
					}
				}
			},

			set_read_date: function (id, no_emit, no_badge_update) {
				this.chatInitsAndPrefs.set_timer_away();

				if (id == 0) {
					wglog.debug("set_read_date id_user = 0");
					return;
				}

				var friend_infos = this.chat_friend_manager.get_friend_infos(id);

				if ( friend_infos.nb_unread == 0 ) {
					wglog.debug("set_read_date", "no need : 0 messages unread");
					return;
				}

				if (typeof no_emit === "undefined" || no_emit === false) {
					this.socket_connection.emit("set_read_date", {"type": "friend", "id": id});
				}

				var last_read = Math.round(new Date().getTime() / 1000);
				if ( friend_infos !== false) {
					this.chat_friend_manager.set_friend_attribut(id, "last_read", last_read);

					if (typeof no_badge_update === "undefined" || no_badge_update === false) {
						total_unread = this.nb_unread_messages_sum - friend_infos.nb_unread;
						if ( total_unread < 0 ) {
							total_unread = 0;
						}
						this.updateTotalNbUnreadHeader( total_unread );

						this.chat_friend_manager.set_friend_attribut(data.id, 'nb_unread', 0);
						this.update_badge(id);
					}
				}

				// update last_read_date to SW
				if (this.chatInitsAndPrefs.serviceWorker) {
					try {
						this.chatInitsAndPrefs.serviceWorker.postMessage({
							"action": "update_friend_last_read",
							"friend_id": id,
							"friend_last_read": last_read
						});
					} catch (e) {
						wglog.error('Failed to send update_friend_last_read to SW', e.toString());
					}
				}

			},

			read_date_set: function(data) {
				if ( typeof data.id == "undefined" ) {
					wglog.debug("read_date_set", "missing (friend) id");
					return;
				}
				if ( typeof data.type == "undefined" ) {
					wglog.debug("read_date_set", "missing type");
					return;
				}
				if ( typeof data.timestamp == "undefined" ) {
					wglog.debug("read_date_set", "missing timestamp");
					return;
				}
				if ( typeof data.nb_unread == "undefined" ) {
					wglog.debug("read_date_set", "missing nb_unread");
					return;
				}

				var friend_infos = this.chat_friend_manager.get_friend_infos(data.id);
				if (!friend_infos) {
					return;
				}

				var $inputs = $("#chat_group_messages_tab_" + data.id).find('.chat-message__read-status input');

				var last_read = data.timestamp || $inputs.last().data('timestamp');
				this.chat_friend_manager.set_friend_attribut(data.id, 'last_read', last_read);
				// this.chat_friend_manager.set_friend_attribut(data.id, "last_read", last_read);
				this.nb_unread_messages[data.id] = data.nb_unread;

				var sum = 0;

				if (data.studios && data.studios.length) {
					sum = data.studios.reduce(function (acc, studio) {
						return acc + studio.nb_unread_messages_sum;
					}, 0);
				} else {
					for (var id in this.nb_unread_messages) {
						sum += this.nb_unread_messages[id];
					}
				}
				this.updateTotalNbUnreadHeader(sum);

				var $input = $inputs
					.filter(function () {
						return Number.parseInt(this.dataset.timestamp) <= last_read;
					})
					.last();

				if ($input.length) {
					this.message_mark_as_read($input.parents('.chat-message__id').get(0), true);
				}

				if (data.nb_unread !== friend_infos.nb_unread) {
					this.chatContext.emit(ContactListEvent.UNREAD_MESSAGE_BADGE, {
						id: data.id,
						nb_unread: data.nb_unread,
						type: this.getContactListTypeAndEvents(friend_infos).type
					});
				}
			},

			update_badge: function (id) {
				var nb_not_read = 0;
				var friend_infos = this.chat_friend_manager.get_friend_infos(id);
				if (friend_infos !== false && typeof friend_infos.nb_unread !== "undefined") {
					nb_not_read = friend_infos.nb_unread;
				}

				$("#select_friend_li_" + id + " span.badge").remove();

				if (nb_not_read !== 0) {
					$("#select_friend_li_" + id + "  .chat-user__last-message-status").append('<span class="badge chat-user__badge">' + nb_not_read + '</span>');
				}
			},

			updateTotalNbUnreadHeader: function ( nb_unread ) {
				var toInt = parseInt(nb_unread);
				if ( toInt != nb_unread || toInt < 0 ) {
					wglog.error("updateTotalNbUnreadHeader", "bad value for nb_unread : " + nb_unread);
					return;
				}

				this.nb_unread_messages_sum = toInt;

				this.node.trigger(jQuery.Event('unread-message-change', {detail: {unread: this.nb_unread_messages_sum}}));

				$(".chat-title > .unread-messages").remove();

				if ( toInt === 0 ) {
					return;
				}

				this.title.append('<span class="unread-messages">-<span class="badge">' + toInt + '</span> ' + i18n.__('chat.title.new_messages') + '</span>');
			},

			sendMessageDispatch: function () {
				this.setMD5(this.getMD5());
				if (attachment_manager.isVisible()) {
					attachment_manager.activeServiceSendMessage(this.chat_friend_manager.selected_friend);
				} else {
					this.send_message();
				}
			},

			setMD5: function(id) {
				this.idMassMessage = id;
			},
			getMD5: function () {
				var sKey = '',
					sChar = 'abcdefABCDEF0123456789';
				for (var i = 32; i > 0; i--) {
					sKey += sChar[Math.floor(Math.random() * sChar.length)];
				}
				return sKey;
			},

			send_message: function (delay) {
				if (typeof this.chat_friend_manager.disabled_send_btn === 'boolean' && this.chat_friend_manager.disabled_send_btn) {
					return;
				}

				var isEditing = false,
					quote = null,
					upload = null;

				if (typeof this.input.data('convchunk') !== 'undefined' && typeof this.input.data('convchunk') === 'string' && this.input.data('convchunk').length > 0) {
					var convchunk = this.input.data('convchunk');
					this.input.removeData('convchunk');
					isEditing = true;
				}
				if (typeof this.input.data('quote') !== 'undefined' && typeof this.input.data('quote') === 'string' && this.input.data('quote').length > 0) {
					quote = this.input.data('quote');
				}
				if (typeof this.input.data('upload') !== 'undefined') {
					upload = this.input.data('upload');
				}

				this.chatInitsAndPrefs.set_timer_away();

				if (this.chat_friend_manager.selected_friend == 0) {
					wglog.error("send message", "no friend selected");
					return;
				}

				var friend_info = this.chat_friend_manager.get_friend_infos(this.chat_friend_manager.selected_friend);
				if (friend_info.load_history) {
					wglog.debug("send message", "loading history");
					return;
				}

				var textarea_message = this.get_input_value();
				if (!textarea_message || !textarea_message.trim().length) {
					return;
				}
				// Fan keywords info popup
				if (FanInfoSendMessage.displayModal(textarea_message, friend_info.profile_name)) {
					return;
				}

				// Include quote
				textarea_message = this.include_quote_message(textarea_message, quote);

				// Include upload
				textarea_message = this.include_upload_message(textarea_message, upload);

				var timestamp = Math.floor(new Date().getTime() / 1000);
				var message = this.make_real_message(textarea_message, this.chat_friend_manager.selected_friend);

				if (textarea_message == message) {
					var popup_options = {};
					popup_options.position = { v: 'above', h: 'right', trigger: false };
					log_and_tooltip.popup_open( $("#chat-window #chat-send-btn"), "<p>" + i18n.__('chat.unable_crypt') + "</p>", popup_options );
					wglog.error("popup unable_crypt");
					return;
				}

				if (!isEditing) {
					this.insert_temp_message(message, friend_info, timestamp);
				}

				if (typeof delay !== "number") {
					delay = 0;
				}

				var self = this;
				setTimeout(function () {
					if (isEditing) { // EDIT MESSAGE
						self.socket_connection.emit('edit_message', {
							'message': message,
							'message_id': convchunk,
							'recipient_id': self.chat_friend_manager.selected_friend
						});
					}
					else { // NEW MESSAGE
						var recipientId = self.chat_friend_manager.get_selected_friend_id();

						var dataMessage = {
							'message': message,
							'recipient_id': recipientId,
							'temp_timestamp': timestamp
						};

						self.socket_connection.emit('send_message', dataMessage);

						if (config.login_info.is_fan) {
							var $lastMessage = $('#chat_group_messages_tab_' + friend_info.id_user + ' .chat-message__id:not(.chat-message-temp):not(.chat-upload-temp)').last(),
								idMassMessage = self.getIdCreatorMessageFromAFriend($lastMessage, 'mm'),
								idAutoMessage = self.getIdCreatorMessageFromAFriend($lastMessage, 'am');

							if (idMassMessage !== false || idAutoMessage !== false) {
								var feature_event = idMassMessage !== false ? 'update_stats_mass_message' : 'update_stats_auto_message',
									data_stats = { stats: 'message_answered' };
								if (feature_event === 'update_stats_mass_message') {
									data_stats.mass_message_id = parseInt(idMassMessage);
								} else if (feature_event === 'update_stats_auto_message') {
									data_stats.auto_message_id = parseInt(idAutoMessage);
								}
								self.socket_connection.emit(feature_event, data_stats);
							}
						}
					}
				}, delay);

				this.empty_message_form();
				$("#textarea-group .emojionearea-editor").focus();
				this.chatContext.emit(DraftEvent.DELETE, this.chat_friend_manager.selected_friend);
			},

			getIdCreatorMessageFromAFriend: function($message, typeOfCreatorMessage) {
				if (
					['mm','am'].indexOf(typeOfCreatorMessage) !== -1
					&& $message.data(typeOfCreatorMessage)
					&& $message.closest('li').hasClass('chat-message--friend')
				) {
					return $message.data(typeOfCreatorMessage);
				}
				return false;
			},

			setMessages: function(messages) {
				this.messages = messages;
			},

			include_quote_message: function(message, quote) {
				var $quote = quote === null ? $('#textarea-group .chat-quote') : $(quote);
				if (!$quote.length) {
					return message;
				}
				var quoteMessageId = '#chat_message_' + $quote.data('quote-message-id');

				var originalMsgHtml = $(quoteMessageId).prop('quotable_msg');
				var originalUploadMsg = $(quoteMessageId).prop('quotable_upload');
				var qValue = '';

				if (originalUploadMsg) {
					qValue = originalUploadMsg;
				} else {
					qValue = $quote.find('blockquote p').html(emoji.htmlToUtf8(utils.escapeHtml(originalMsgHtml)).replace(new RegExp('<br>', 'g'), '\n')).text();
				}

				var quote = {
					q: qValue,
					qI: quoteMessageId,
					aN: $quote.find('.chat-message__meta--cite').text().replace(',', ''),
					aI: $quote.find('.chat-message__meta--cite').data('user-id'),
					t: $quote.find('.chat-message__meta--time').data('timestamp'),
					m: message
				}

				try {
					var output = JSON.stringify(quote);
				} catch (e) {
					output = message;
				}

				return output;
			},

			include_upload_message: function(message, upload) {
				if (!upload || !upload.type || upload.type !== 'upload') {
					return message;
				}

				upload.text = message;

				return JSON.stringify(upload);
			},

			receive_message: function (data) {
				if (data.recipient_id === 'undefined') {
					wglog.error("receive_message", "data.recipient_id is undefined");
					return;
				}

				if (typeof data.message_id === 'undefined') {
					wglog.error("receive_message", "data.message_id is undefined");
					return;
				}

				if (typeof data.sender_id === 'undefined') {
					wglog.error("receive_message", "data.sender_id is undefined");
					return;
				}

				if (typeof data.message === 'undefined') {
					wglog.error("receive_message", "data.message is undefined");
					return;
				}

				if (typeof data.uid === 'undefined') {
					wglog.error("receive_message", "no data.uid");
					return;
				}

				if (data.uid === this.last_iud_received) {
					wglog.error("receive_message", "message already received");
					return;
				}

				this.last_iud_received = data.uid;

				var recipient_id = +data.recipient_id,
					sender_id = +data.sender_id,
					is_recipient = recipient_id === this.user_id,
					is_sender = sender_id === this.user_id,
					no_update_friend = is_sender && !!data.mass_message_id,
					friend_id = is_recipient ? sender_id : recipient_id,
					friend_infos = this.chat_friend_manager.get_friend_infos(friend_id),
					recipient_is_studio = !!this.studios && !!this.studios[recipient_id];

				if (recipient_is_studio && !is_recipient) {
					this.chatContext.emit(StudioEvent.INCREMENT_STUDIO_UNREAD, recipient_id);
					this.updateTotalNbUnread(this.get_studios_total_nb_unread());
					return;
				}

				// user is sender and friend isn't loaded
				if ((is_sender && !friend_infos) || no_update_friend) {
					return;
				}

				var callback_obj= {
					'new_message': true
				}

				if (!typeof data.add_to_friend_list === 'undefined') {
					this.chat_friend_manager.friends_ids.push(data.add_to_friend_list);
					this.socket_connection.emit("getuserinfos", {
						'friend_id': data.add_to_friend_list,
						'callback_obj': callback_obj
					});
					return;
				}

				if (!!friend_infos && typeof friend_infos.not_friend !== "undefined" && friend_infos.not_friend) {
					wglog.error("receive message from a non friend");
					// maybe it's a new friend
					this.socket_connection.emit("getuserinfos", {
						'friend_id': friend_id,
						'callback_obj': callback_obj
					});
					return;
				}

				if (!friend_infos) {
					wglog.error("receive message from an unknown friend. Ask for informations for user " + friend_id);
					this.socket_connection.emit("getuserinfos", {
						'friend_id': friend_id,
						'callback_obj': callback_obj
					});
					return;
				}

				var timestamp = data.timestamp || Math.floor(new Date().getTime() / 1000),
					msg = {
						m: data.message,
						s: data.sender_id,
						r: data.recipient_id,
						t: timestamp,
						y: data.type || "f",
						u: data.uid
					};

				if (data.forward && data.forward.fw) {
					msg.fw = data.forward.fw;
				}

				if (data.mass_message_id) {
					msg.mm = +data.mass_message_id;
					if (!data.mm_type) {
						data.mm_type = 'regular';
					}
				} else if (data.auto_message_id) {
					msg.am = +data.auto_message_id;
				}

				if (data.type && data.type == "c" && data.ci) {
					msg.ci = data.ci;
				}

				var contactAttributesToAdd = [];
				if (data.type === "f" || (data.type === "c" && (data.mass_message_id || data.auto_message_id))) {
					if (is_recipient && (data.mm_type === 'regular' || (data.mm_type !== 'regular' && !config.login_info.is_silent_ppv)) ) {
						this.chatInitsAndPrefs.play_notif();
						if (!friend_infos.is_blocked && !friend_infos.is_ghosted) {
							var nb_unread_messages_sum = this.nb_unread_messages_sum + 1;

							if (!!this.studios && !!this.studios[this.user_id]) {
								this.studios[this.user_id].nb_unread_messages_sum++;
								nb_unread_messages_sum = this.get_studios_total_nb_unread();
							}
							contactAttributesToAdd.push({name: 'nb_unread', value: (friend_infos.nb_unread + 1)});
							this.updateTotalNbUnreadHeader(nb_unread_messages_sum);
						}
					}
				}

				contactAttributesToAdd.push(
					{ name: 'interaction', value: timestamp },
					{ name: 'last_message', value: msg },
					{ name: 'last_timestamp', value: timestamp },
					{ name: 'last_id_message', value: data.message_id },
					{ name: 'last_id_sender', value: data.sender_id }
				);

				if ($("#chat_messages_tab_" + friend_id).length) {
					var chatEmptyElt = $("#chat_group_messages_tab_" + friend_id + " .chat-message--empty");
					if (chatEmptyElt.length) {
						chatEmptyElt.remove();
					}

					this.add_message_friend(data.message_id, friend_id, data.sender_id, data.message, timestamp, data.type, data.uid, data.temp_timestamp, data.forward, data.mass_message_id, data.auto_message_id);

					ScrollConversation.down(friend_id);
					if (!this.tabVisible) {
						this.chat_friend_manager.update_last_message_marker(friend_id);
					}

				} else {
					wglog.debug("no tab for this friend");
				}

				this.chat_friend_manager.setMultipleContactAttributes(friend_id, contactAttributesToAdd);

				var events = this.getContactListTypeAndEvents(friend_infos).events;
				this.chatContext.emit(events.UPDATE_LIST, false, 'receive');

				// update interaction to SW
				if (this.chatInitsAndPrefs.serviceWorker) {
					try {
						this.chatInitsAndPrefs.serviceWorker.postMessage({
							"action": "update_friend_interaction",
							"friend_id": friend_id,
							"friend_interaction": friend_infos.interaction
						});
					} catch (e) {
						wglog.error('Failed to send update_friends_interaction to SW', e.toString());
					}
				}

				if (this.is_retrying) {
					this.is_retrying = false;
					clearTimeout(this.retry_timer);
					var $error = $('.chat-error--nofatal.is-retry');
					if ($error.length) {
						$error.remove();
					}
				}
			},

			creator_message_sent: function(data) {
				if (typeof data.mass_message_id === 'undefined' && typeof data.auto_message_id === 'undefined') {
					wglog.error("creator_message_sent", "data.mass_message_id or data.auto_message_id is undefined");
					return;
				}

				if (typeof data.messages === 'undefined') {
					wglog.error("creator_message_sent", "data.messages is undefined");
					return;
				}

				if (typeof data.sender_id === 'undefined') {
					wglog.error("creator_message_sent", "data.sender_id is undefined");
					return;
				}

				var creatorMessage = {
					type : !!data.mass_message_id ? 'mm' : 'am',
					id: !!data.mass_message_id ? data.mass_message_id : data.auto_message_id,
					event: !!data.mass_message_id ? MassMessageEvent.MASS_MESSAGE_SENT : AutoMessageEvent.AUTO_MESSAGE_SENT,
				};

				this.chatContext.emit(creatorMessage.event, creatorMessage.id);

				var idsFriendsLoaded = Object.keys(this.chat_friend_manager.get_friends()),
					recipients = Object.keys(data.messages);

				for (var index in recipients) {
					var friend_id = recipients[index];
					if (idsFriendsLoaded.indexOf(friend_id) !== -1) {
						for (var idx in data.messages[friend_id]) {
							var messageParamData = data.messages[friend_id][idx],
								timestamp = messageParamData['timestamp'] || Math.floor(new Date().getTime() / 1000),
								msg = {
									m: messageParamData['message'],
									s: data.sender_id,
									r: friend_id,
									t: timestamp,
									y: messageParamData['type'] || "f",
									u: messageParamData['uid']
								};

							msg[creatorMessage.type] = creatorMessage.id;

							this.add_message_friend(messageParamData['message_id'], friend_id, parseInt(data.sender_id), messageParamData['message'], timestamp, messageParamData['type'], messageParamData['uid'], null, null, data.mass_message_id, data.auto_message_id);
							ScrollConversation.down(friend_id);
							if (!this.tabVisible) {
								this.chat_friend_manager.update_last_message_marker(friend_id);
							}
						}
					}
					else {
						wglog.error("creator_message_sent", "recipient is not loaded");
						if (creatorMessage.type === 'mm') {
							continue;
						}
						this.socket_connection.emit("getuserinfos", {
							'friend_id': friend_id,
							'callback_obj': {
								'new_auto_message': true
							}
						});
					}
				}
			},

			add_message_friend: function (message_id, friend_id, sender_id, message, timestamp, type, uid, tempTime, forward, mass_message_id, auto_message_id) {
				var messages_container = $("#chat_group_messages_tab_" + friend_id);

				if (messages_container.length === 0) {
					wglog.error("add_message_friend", "No tab for this friend");
					return;
				}

				var friend_infos = this.chat_friend_manager.get_friend_infos(friend_id);
				if (friend_infos === false) {
					wglog.error("add_message_friend", "No informations for this friend");
					return;
				}

				var sender_is_user = sender_id == this.user_id;
				var scroll_down = ScrollConversation.isDown(friend_id);
				var new_message;
				var real_message = this.get_real_message(message, friend_id);
				var is_upload = real_message.indexOf('{"type":"upload"') > -1;

				var match = real_message.match(/"uuid":"([a-z\d-]+)"/);
				var uuid = match ? match[1] : "";

				var selector = '.chat-message--' + (sender_is_user ? 'me' : 'friend');

				if (typeof tempTime === "number" && tempTime) {
					selector = "#chat_message_temp_" + tempTime;
				} else if (is_upload) {
					selector += ' .chat-upload-temp[data-uuid="' + uuid + '"]';
				} else {
					selector += ' .chat-message-temp:not(.chat-message__id--file-shared)';
				}

				var temp = messages_container.find(selector);
				if (temp.length && (is_upload || sender_is_user)) {
					var contextMenu, quoteAction;

					if (is_upload) {
						temp.prop('id', 'chat_message_' + message_id);
						new_message = temp;
						contextMenu = temp.find('.chat-message__action--context-menu').get(0).contextMenu;
					} else if (sender_is_user) {
						new_message = this.message_inside_html(this.params_to_html_params(
							message_id,
							message,
							sender_id,
							null,
							null,
							timestamp,
							mass_message_id,
							auto_message_id,
							forward,
							friend_infos,
							type,
							true,
							false,
							null,
							uid)
						);
						temp.first().replaceWith(new_message);
						contextMenu = temp.first().find('.chat-message__action--context-menu').get(0).contextMenu;
					}

					if (contextMenu && contextMenu.getAction) {
						quoteAction = contextMenu.getAction('quote');
					}

					if (quoteAction && quoteAction.callback_params) {
						quoteAction.callback_params[1] = message_id;
					}
				} else {
					new_message = this.add_message_friend_new_message(message_id, message, sender_id, timestamp, friend_infos, type, forward, mass_message_id, auto_message_id, uid);
				}

				this.quote_show_more_button_init(new_message);

				(new_message.is('.chat-message__id') ? new_message : new_message.find('.chat-message__id')).data({
					m: message,
					mc: this.make_real_message(this.get_real_message(message, friend_infos.id_user), 'make it clear'),
					s: sender_is_user ? this.user_id : friend_infos.id_user,
					r: sender_is_user ? friend_infos.id_user : this.user_id,
					t: timestamp,
					y: type,
					u: uid
				});

				this.chatContext.emit(ManagerEvent.MESSAGE_ADDED, new_message.get(0));
				new_message.trigger(jQuery.Event('message-added', {details: {friend_id: friend_id}}));
				var observer_subject = $('#chat_message_' + message_id + ' .chat-message__read-status label');
				if (sender_is_user === false && this.message_intersection_observer && observer_subject.length) {
					this.message_intersection_observer.observe(observer_subject[0]);
				}

				var true_message = new_message.is('.chat-message__id') ? new_message : new_message.find('.chat-message__id:last-child');
				if (scroll_down && new_message.is('.chat-message--content')) {
					this.vault.preserveScrollDownOnImageLoad(true_message);
				} else if (scroll_down && true_message.is('.chat-message__id--file-shared')) {
					this.chat_send_file.preserveScrollDownOnImageLoad(true_message);
				} else if (scroll_down) {
					ScrollConversation.down(friend_id);
				}
			},

			// @TODO Try to use this method inside put_history
			add_message_friend_new_message: function (message_id, message, sender_id, timestamp, friend_infos, type, forward, mass_message_id, auto_message_id, uid) {
				var new_message,
					last_message_sender_id,
					last_message_timestamp,
					$last_message = $('#chat_group_messages_tab_' + friend_infos.id_user + ' .chat-message__id:not(.chat-message-temp):not(.chat-upload-temp)').last();

				if ($last_message.length) {
					last_message_sender_id = parseInt($last_message.attr('id').split('-')[1]);
					last_message_timestamp = $last_message.find('.chat-message__meta--time').data('timestamp');
				}

				if (last_message_timestamp
					&& (timestamp - last_message_timestamp) < this.time_for_message_group
					&& last_message_sender_id === sender_id
					&& (typeof type == "undefined" || type === "f")
				) {
					new_message = this.message_inside_html(this.params_to_html_params(
						message_id,
						message,
						sender_id,
						null,
						null,
						timestamp,
						mass_message_id,
						auto_message_id,
						forward,
						friend_infos,
						type,
						null,
						null,
						null,
						uid)
					);
					$last_message.parent().append(new_message);
				} else {
					var sender_id_user = this.user_id === sender_id;
					var sender_name = sender_id_user ? config.login_info.profile_name : friend_infos.profile_name,
						sender_picture = sender_id_user ? config.login_info.profile_picture : friend_infos.profile_picture;

					new_message = this.message_html(this.params_to_html_params(
						message_id,
						message,
						sender_id,
						sender_name,
						sender_picture,
						timestamp,
						mass_message_id,
						auto_message_id,
						forward,
						friend_infos,
						type,
						null,
						null,
						null,
						uid)
					);

					if ($last_message.length) {
						$last_message.parents('.chat-message').after(new_message);
					} else {
						$('#chat_group_messages_tab_' + friend_infos.id_user).append(new_message);
					}
				}

				return new_message;
			},

			rerender_message: function (data) {
				if (!!data === false) {
					return false;
				}

				var friend_id = this.user_id === parseInt(data.sender_id) ? +data.recipient_id : +data.sender_id,
					friend_info = this.chat_friend_manager.get_friend_infos(friend_id);

				if (!friend_info) {
					return false;
				}

				var $old_message = $('#chat_message_' + data.message_id);

				if (!$old_message.length) {
					return false;
				}

				var message_params = this.params_to_html_params(
					data.message_id,
						data.message,
						data.sender_id,
						null,
						null,
						data.timestamp,
						null,
						null,
						data.forward,
						friend_info,
						data.type
					),
					$new_message = this.message_inside_html(message_params);

				$old_message.replaceWith($new_message);

				$new_message.trigger(jQuery.Event('message-rerendered', {details: {friend_id: friend_id}}));

				return true;
			},

			add_expense_notif_in_list: function(friend_id) {
				var friend_item = $('#select_friend_li_' + friend_id);
				if (friend_item.length === 0) {
					return;
				}
				friend_item.find('.expense__total').addClass('new');
			},

			setuserinfos: function (data) {
				var on_top = false;
				if (typeof data.callback_obj.new_message !== "undefined" && data.callback_obj.new_message === true) {
					on_top = true;
				}
				if (typeof data.callback_obj.open_tab !== "undefined" && data.callback_obj.open_tab === true) {
					on_top = true;
				}

				var friend_info = data.friendlist.shift();
				if (!friend_info || !friend_info.id_user) {
					wglog.error('setuserinfos', "no friend infos found");
					return;
				}

				this.chat_friend_manager.add_or_update_friend(friend_info, on_top);

				if (data.callback_obj.open_tab) {
					this.chat_friend_manager.select_friend(friend_info.id_user);
					this.chat_toggle_display(true);
					var contactListTab = this.chat_friend_manager.customers_ids.indexOf(friend_info.id_user) !== -1 ? 'customers' : 'followers';
					this.contactLists[contactListTab].switchContactListUI(contactListTab);
				}

				// send friend to SW
				/*if (this.chatInitsAndPrefs.serviceWorker) {
					try {
						this.chatInitsAndPrefs.serviceWorker.postMessage({
							"action": "add_friend_info",
							"friend_info": friend_info
						});
					} catch (e) {
						wglog.error('Failed to send add_friend_info to SW', e.toString());
					}
				}*/

			},

			send_users_infos: function (data) {
				$("#new_tab_select_spin").remove();

				if (typeof data.friendlist === "undefined" || data.friendlist.length === 0) {
					wglog.debug("manager::send_users_infos friendlist is undefined or empty");
					return;
				}

				if (!config.login_info.is_creator) {
					if (data.requested_ids.length && data.friendlist.length && !data.source) {
						data.source = 'loadMore';
					}
                    if (data.source && data.source === 'ContactSocketHandler._emitSocketEventContactInfos') {
                        this.chatContext.emit(ContactListEvent.ADD_USERS_INFOS, data);
                    } else {
					    this.chatContext.emit(ContactListEvent.ALL_IDS_AND_FIRST_CONTACT_SUCCESS, data);
                    }
				} else {
					var listToUpdate = [];
					for (var j in data.friendlist) {
						var currentContact = data.friendlist[j];
						if (config.login_info.is_creator) {
							if (currentContact.is_customer && listToUpdate.indexOf('customers') === -1) {
								listToUpdate.push('customers');
							} else if (listToUpdate.indexOf('followers') === -1) {
								listToUpdate.push('followers')
							}
						} else if (listToUpdate.indexOf('inbox') === -1) {
							listToUpdate.push('inbox');
						}

						this.chat_friend_manager.add_or_update_friend(currentContact, !!data.queue_id);
					}

					if (listToUpdate.length) {
						for (var list in listToUpdate) {
							var events = config.login_info.is_creator ? (listToUpdate[list] === 'customers' ? CustomerListEvent : FollowerListEvent) : ContactListEvent;
							this.chatContext.emit(events.UPDATE_LIST, null, 'update');
						}
					}

				}

				if (typeof data.queue_id !== "undefined") {
					this.get_users_infos_queue(data.queue_id);
					return;
				}

				if (typeof data.source !== 'undefined' && data.source === 'select-contacts') {
					select_contacts.setInterface();
				}

				var friends_keys = [];
				for (var key in this.chat_friend_manager.friends) {
					friends_keys.push(key);
				}

				// send friends to SW
				if (this.chatInitsAndPrefs.serviceWorker) {
					try {
						this.chatInitsAndPrefs.serviceWorker.postMessage({
							"action": "add_friends_infos",
							"friendlist": data.friendlist
						});
					} catch (e) {
						wglog.error('Failed to send add_friends_infos to SW', e.toString());
					}
				}

				if (this.get_users_infos_throttle_data.pending.length) {
					this.get_users_infos_throttle(this.get_users_infos_throttle_data.pending[0]);
				}
			},

			display_quote_into_form: function (message, message_id, user_id, user_name, timestamp) {
				this.remove_quote_into_form();

				// Prepare Data
				var $message = $('#chat_message_' + message_id);
				var isFileShared = $message.hasClass('chat-message__id--file-shared');
				var $file = $message.find('.chat-message__file').clone();

				if ($file.length) {
					$file.children('.chat-message__file-metas, .chat-message__file-link').remove();
					$file.addClass('chat-message__file--quote');
				}

				// Render quote
				var params = {
					message_id: message_id,
					modifier: 'form',
					in_form: true,
					is_file_shared: isFileShared,
					enable_refresh_rt: (Date.now() - timestamp * 1000) < (24 * 3600000),
					content: isFileShared ? $file.prop('outerHTML') : utils.escapeHtml(message),
					user_id: user_id,
					user_name: user_name,
					time: this.format_timestamp(timestamp),
					timestamp: timestamp,
					relative_time: this.format_timestamp_relative(timestamp),
					show_more_label: i18n.__('chat.show_more'),
					trad: {
						remove: i18n.__('misc.actions.remove')
					}
				};

				var self = this;

				var $textareaGroup = $('#textarea-group');

				$textareaGroup
					.addClass('chat-message-form__textarea-group--with-quote')
					.find('#chat-textarea-message')
					.before(Mustache.render(tpl_message_quote, params))
					.on('click', '.remove-quote',event => {
						event.preventDefault();
						self.remove_quote_into_form();
					});

				var $textareaGroupQuote = $textareaGroup.find('.chat-quote');
				$textareaGroupQuote.data('quote-message-id', message_id);

				if (isFileShared) {
					$textareaGroupQuote.addClass('chat-quote--message-visible');
				} else {
					this.quote_show_more_button_init($textareaGroup);
				}

				// Handle textarea focus state
				$textareaGroupEmojione = $textareaGroup.find('.emojionearea');
				if ($textareaGroupEmojione.length) {
					if (!this.textarea_mutation_observer) {
						this.textarea_mutation_observer = new MutationObserver(mutations => {
							mutations.forEach(mutation => {
								if (mutation.type == 'attributes' && mutation.attributeName == 'class') {
									if (mutation.target.classList.contains('focused')) {
										$textareaGroupQuote.addClass('chat-quote--form-focused');
									} else {
										$textareaGroupQuote.removeClass('chat-quote--form-focused');
									}
								}
							});
						});
					}

					this.textarea_mutation_observer.observe(
						$textareaGroupEmojione.get(0),
						{
							attributes: true,
							attributeFilter: ['class']
						}
					);
					$("#textarea-group .emojionearea-editor").focus();
				} else {
					this.input.on('focus', function () {
						$textareaGroupQuote.addClass('chat-quote--form-focused');
					});
					this.input.on('blur', function () {
						$textareaGroupQuote.removeClass('chat-quote--form-focused');
					});
					this.input.trigger('focus');
				}

			},

			remove_quote_into_form: function () {
				$('#textarea-group .chat-quote').remove();
				$('#textarea-group').removeClass('chat-message-form__textarea-group--with-quote');

				if (this.textarea_mutation_observer) {
					this.textarea_mutation_observer.disconnect();
				}
			},

			empty_message_form: function () {
				this.remove_quote_into_form();

				this.input.val('').data({quote: null, upload: null});
				$("#textarea-group .emojionearea-editor").empty();

				this.typing_to_friend = false;
				this.socket_connection.emit("typing_stop", {"id_friend": this.chat_friend_manager.selected_friend});

				this.chatContext.emit(DraftEvent.DELETE, this.chat_friend_manager.selected_friend);

				$('.chat-message-form__textarea-edit-popup').removeClass('chat-message-form__textarea-edit-popup--visible');
			},

			ask_delete_message: function (message_id) {
				this.chatInitsAndPrefs.set_timer_away();
				var self = this;
				contextual_popup.confirm(
					utils.escapeHtml(i18n.__('chat.confirm_delete_message')),
					function () {
						self.emit_delete_message(message_id);
					},
					null,
					false,
					{ text_ok: i18n.__('misc.yes'), popup: { container: $('body > .chat-external-overlay-container') } });
			},

			emit_delete_message: function (message_id) {
				var self = this;

				this.message_set_pending_state(message_id);

				self.socket_connection.emit("delete_message", {
					"message_id": message_id,
					"recipient_id": self.chat_friend_manager.selected_friend,
					"type": "friend"
				});
			},

			emit_forward_message: function(ids, supportId) {
				var messages = ForwardMessageUtils.getMessagesToForward(ids);

				if (messages.length) {
					this.socket_connection.emit("forward_message", {
						"messages": messages,
						"support_id": supportId,
						"sender_id": this.chat_friend_manager.selected_friend
					});
				}
			},

			delete_last_messages: function (listSelector, count) {
				var list = $(listSelector);

				if (!list.length) {
					return 'List not found';
				}

				list.find('.chat-message--me .chat-message__id').slice((-1 * count)).each((index, item) => {
					this.emit_delete_message(item.id.substring(13));
				});
			},

			delete_message: function (data) {
				var friend_id = data.sender_id === this.user_id ? data.recipient_id : data.sender_id;

				var div_message = $("#chat_message_" + data.message_id);

				if (div_message.length) {
					var parent = div_message.parent();
					var list = parent.closest("ul");

					if (parent.children().length > 1) {
						div_message.remove();
					} else {
						parent.closest("li").remove();
					}

					if (list.children().length === 0) {
						list.append('<li class="chat-message chat-message--system chat-message--empty"><p>' + i18n.__('chat.infos.no_history') + '</p></li>');
					}
				}

				if (data.last_message) {
					this.chat_friend_manager.set_friend_attribut(friend_id, 'last_message', data.last_message);
				} else {
					this.chat_friend_manager.reset_friend_meta(friend_id);
				}

				var friend_info = this.chat_friend_manager.get_friend_infos(friend_id);
				if (friend_info && data.message_timestamp && friend_info.last_read && data.message_timestamp > friend_info.last_read) {
					friend_info.nb_unread = Math.max(0, friend_info.nb_unread - 1);
					this.updateTotalNbUnreadHeader( Math.max(0, this.nb_unread_messages_sum - 1));
				}

				var events = this.getContactListTypeAndEvents(friend_info).events;
				this.chatContext.emit(events.UPDATE_LIST, false, 'update');
			},

			update_message: function (data) {
				if (!this.rerender_message(data)) {
					return;
				}

				if (this.chat_friend_manager.friends[data.recipient_id]) {
					var events = this.getContactListTypeAndEvents(+data.recipient_id).events;
					this.chatContext.emit(events.UPDATE_LIST, false, 'update');
				}
			},

			edit_message: function(data) {
				var id = 'chat_message_' + data.message_id,
					id_user = this.user_id === data.sender_id ? data.recipient_id : data.sender_id,
					$messages = $('#chat_group_messages_tab_' + id_user),
					$message = $messages.find('#' + id),
					message_real = this.get_real_message(data.message, id_user),
					is_upload = false;

				if (message_real.startsWith('{') && message_real.endsWith('}')) {
					try {
						var json = JSON.parse(message_real);
						if (json.qI) {
							message_real = json.m;
						}
						if (json.type && json.type === 'upload') {
							message_real = json.text;
							is_upload = true;
						}
					} catch (e) {
						// Not a json content.
					}
				}

				if (id === $messages.children('li').last().find('.chat-message__id').last().prop('id')) {
					$('#chat-users-inbox').find('#select_friend_li_' + id_user).find('.chat-user__last-message').text(utils.escapeHtml(message_real).replace(/\n/g, ' ').replace(/\s+/g, ' '));
				}

				var date = typeof data.edit_time === 'number' ? this.format_timestamp(data.edit_time) : null;
				if ($message.find('.chat-message__edit').length === 0) {
					if (this.user_id === data.sender_id) {
						$message.prepend($(Mustache.render(tpl_message_edit, { date: date })));
					}
					else {
						$message.append($(Mustache.render(tpl_message_edit, { date: date })));
					}
				}
				else {
					$message.find('.chat-message__edit').prop('title', date);
				}

				var scrollIsDown = ScrollConversation.isDown(id_user),
					$chat_message = $message.find('.chat-message__message');

				message_real = utils.escapeHtml(message_real).replace(/\n/g, '<br>');

				var paragraph = is_upload ? $chat_message.find('.chat-content__inner p') : $chat_message.children('p');
				paragraph.replaceWith('<p>' + message_real + '</p>');
				$message.prop('quotable_msg', message_real);

				if (scrollIsDown) {
					ScrollConversation.down(id_user);
				}

				this.chatContext.emit(ManagerEvent.MESSAGE_UPDATED, $message.get(0));
			},

			emit_change_prefs: function(sound, mini_disabled, blur_image) {
				if ( typeof this.socket_connection !== "undefined" ) {
					var params = { "sound" : sound, "mini_disabled": mini_disabled, "invisible": (this.chatInitsAndPrefs.status == "Invisible"), "blur_image": blur_image };
					params[config.cookie_name] = cookies.get( config.cookie_name );
					this.socket_connection.emit("change_prefs", params);
				}
			},

			remove_SW_token: function() {
				if ( typeof this.socket_connection !== "undefined" ) {
					this.socket_connection.emit("remove_SW_token");
				}
			},

			change_status:function(status) {
				if (status !== "Online" && status !== "Away" && status !== "Invisible") {
					wglog.error("bad status for change_status : " + status);
					return;
				}

				if (this.socket_connection) {
					this.socket_connection.emit("change_status", {"status": status});
				}
			},

			status_changed:function(data) {
				if ( data.status != "Online" && data.status != "Away" && data.status != "Invisible" ) {
					wglog.error("bad status for status_changed : " + data.status);
					return;
				}

				this.chatInitsAndPrefs.status = data.status;

				if (data.status != "Away") {
					this.chatInitsAndPrefs.set_timer_away();
				}

				$("#chat-setting-status-" + data.status.toLowerCase()).prop('checked', true);
				if ( this.chatInitsAndPrefs.status == "Online" ) {
					$(".chat-title-text").html( i18n.__('chat.infos.window_title') );
				} else if ( this.chatInitsAndPrefs.status == "Away" ) {
					$(".chat-title-text").html( i18n.__('chat.infos.window_title') + " (" + i18n.__('chat.status.away') + ")" );
				} else if ( this.chatInitsAndPrefs.status == "Invisible" ) {
					$(".chat-title-text").html( i18n.__('chat.infos.window_title') + " (" + i18n.__('chat.status.invisible') + ")" );
				}

				this.set_profile_pic_status(this.chatInitsAndPrefs.status);

				if (data.status != "Online") {
					this.typing_to_friend = false;
				}
				if ( data.status == "Online" && this.input.val().length > 0 && this.chat_friend_manager.selected_friend != 0 ) {
					this.typing_to_friend = this.chat_friend_manager.selected_friend;
					this.socket_connection.emit("typing_start", {"id_friend": this.chat_friend_manager.selected_friend});
				}

				if (typeof data.cookie !== 'undefined') {
					wglog.debug('set cookie');
					cookies.setLocal( config.cookie_name , data.cookie, 0, "/");
				}
			},

			set_profile_pic_status: function (status) {
				if (typeof status !== 'string') {
					wglog.error('set_profile_pic_status', 'status must be a string');
					return;
				}

				status = status.toLowerCase();

				if (status != 'away' && status != 'invisible' && status != 'online' && status != 'offline') {
					wglog.error('set_profile_pic_status', 'invalid status (authorized values: away, invisible, online, offline; provided: ' + status + ')');
					return;
				}

				$('.chat-sidebar__profile .chat-avatar')
					.removeClass('chat-avatar--away chat-avatar--invisible chat-avatar--online chat-avatar--offline')
					.addClass('chat-avatar--' + status);
			},

			setSwToken: function (token) {
				this.chatInitsAndPrefs.sw_token = token;
				if (this.chatInitsAndPrefs.notif && this.socket_connection) {
					this.socket_connection.emit("SW_token", {"token": this.chatInitsAndPrefs.sw_token});
					cookies.setLocal("chat_sw_token", token, 10 * 24 * 3600 * 1000, '/');
				}
			},

			key_down: function (e, editor) {
				e.which = e.which || e.keyCode;

				if (e.which == 16) {
					this.shift_key_hold = true;
				}

				if (e.which == 13 && !this.shift_key_hold) {
					// Avoid display new line into textarea
					e.preventDefault();

					// Avoid sending message just after emoji autocomplete hide on "Enter" key
					if (this.emoji_autocomplete_visible) {
						this.prevent_send_message = true;
					}
				}
			},

			key_pressed: function (e, editor) {
				this.chatInitsAndPrefs.set_timer_away();

				e.which = e.which || e.keyCode;

				if (e.which === 16) {
					this.shift_key_hold = false;
				}

				var selected_friend = this.chat_friend_manager.selected_friend;

				if (selected_friend === 0) {
					return;
				}

				if (e.which === 13 && !this.shift_key_hold && !this.prevent_send_message) {
					if (typeof editor != "undefined") {
						// editor.blur();
						this.input.val($(this.input)[0].emojioneArea.getText());
					}
					this.sendMessageDispatch();
					this.typing_to_friend = false;
				} else	if ( this.chatInitsAndPrefs.status != "Invisible" ) {
					var set_timeout = false;
					var self = this;

					if ( typeof editor !== "undefined" && typeof editor[0] !== "undefined" ) {
						if (editor[0].innerHTML.length > 0) {
							if (!this.typing_to_friend) {
								this.typing_to_friend = selected_friend;
								this.socket_connection.emit("typing_start", {"id_friend": selected_friend});
							}
							set_timeout = true;
						} else if ( typeof this.typing_to_friend == "undefined" || !this.typing_to_friend ) {
							this.typing_to_friend = false;
							this.socket_connection.emit("typing_stop", {"id_friend": selected_friend});
							this.chatContext.emit(DraftEvent.DELETE, selected_friend);
						}
					} else {
						if (this.input.val().length === 0) {
							this.typing_to_friend = false;
							this.socket_connection.emit("typing_stop", {"id_friend": selected_friend});
							this.chatContext.emit(DraftEvent.DELETE, selected_friend);
						} else if ( typeof this.typing_to_friend == "undefined" || !this.typing_to_friend ) {
							if (!this.typing_to_friend) {
								this.typing_to_friend = selected_friend;
								this.socket_connection.emit("typing_start", {"id_friend": selected_friend});
							}
							set_timeout = true;
						}
					}

					if (set_timeout) {
						if (this.typing_timout) {
							clearTimeout(this.typing_timout);
						}
						this.typing_timout = setTimeout(function() {
							self.typing_to_friend = false;
							self.socket_connection.emit("typing_stop", {"id_friend": selected_friend});

							var content = self.getContentInTextarea();
							if (content.length) {
								self.chatContext.emit(DraftEvent.SAVE, selected_friend, content);
							} else {
								self.chatContext.emit(DraftEvent.DELETE, selected_friend);
							}
						}, 2000);
					}
				}

				if (this.prevent_send_message && !this.emoji_autocomplete_visible) {
					this.prevent_send_message = false;
				}
			},

			getContentInTextarea: function() {
				var textareaWrapper = this.input.closest('.chat-message-form__textarea-wrapper');
				if (!textareaWrapper.length) {
					return false;
				}

				var editor = textareaWrapper.find('.emojionearea-editor');
				if (!editor.length) {
					return false;
				}

				return utils.escape(editor.text());
			},

			search_key_pressed: function (e) {
				this.chatInitsAndPrefs.set_timer_away();
				e.which = e.which || e.keyCode;
				if (e.which == 13) {
					this.chat_friend_manager.search_friend();
				}
			},

			format_timestamp: function (timestamp) {
				var date = new Date(timestamp * 1000);
				var now = new Date();
				var date_string = '';

				if (date.getFullYear() != now.getFullYear()) {
					date_string += date.getFullYear() + '/';
				}
				if (date.getDate() != now.getDate()) {
					date_string += this.format_date_number(date.getMonth() + 1) + '/' + this.format_date_number(date.getDate()) + ' ';
				}
				date_string += this.format_date_number(date.getHours()) + ':' + this.format_date_number(date.getMinutes());

				return date_string;
			},

			format_date_number: function (num) {
				if (num <= 9) {
					return '0' + num;
				}
				else {
					return num;
				}
			},

			format_timestamp_relative: function (timestamp, is_ms) {
				var duration = Date.now()/1000 - timestamp/(is_ms ? 1000 : 1);
				var prefix = duration >= 0 ? "" : "in ";
				var method = duration >= 0 ? "ago" : "medium";
				return prefix + tools.formatDuration(Math.abs(duration), method);
			},

			// refresh message relative time and other info
			/*refresh_messages_rt: function() {
				var self = this;
				$('.chat-message__meta--time[data-refresh-rt]').each(function(idx, elt) {
					elt.innerHTML = self.format_timestamp_relative(elt.dataset.timestamp);
				});
				if (config.file_upload.method === "dropzone") {
					$('.chat-message__file-expiration').each(function(idx, elt) {
						self.chat_send_file.update_message_meta($(elt).parents('.chat-message__id'));
					});
				}
			},*/

			update_window_after_user_connected: function (data) {
				config.login_info = Object.assign(config.login_info, data);
				Profile.refreshView();
				delete config.login_info.id_user;
				var existingAvatar = $('.chat-sidebar__settings figure');
				if (existingAvatar.length === 0) {
					var avatar = Mustache.render(tpl_avatar, {
						src: data.profile_picture,
						alt: '',
						status: this.chatInitsAndPrefs.status ? this.chatInitsAndPrefs.status.toLowerCase() : 'offline',
						is_user_not_reviewed: 'review_status' in data && data.review_status !== 'validated',
						review_not_validated: i18n.__('chat.application.not_validated'),
					});
					var $avatar = $(avatar);
					$('img', $avatar).on('error', function() {
						$(this).hide();
					});
					$('.chat-sidebar__settings').prepend($avatar);
				} else if (existingAvatar.length) {
					existingAvatar.find('img').attr('src', data.profile_picture);
					Profile.updateAvatarUrl(data.profile_picture);
				}
				$('.chat-sidebar__username').text(data.profile_name);

				var studios = data.studios || [];

				if (studios && studios.length) {
					this.studios = studios.reduce(function (acc, studio) {
						acc[studio.website_user_id] = studio;
						return acc;
					}, {});
					// Be careful with this one. Here `this.studios` is passed by reference to the StudioSelectorView.
					// So any changes on impact the view too.
					this.chatContext.emit(StudioEvent.INIT_SELECTOR, this.studios);
				}

				var self = this;
				if (config.login_info.is_creator) {
					this.manager_setting = $("#chat-setting-manager");
					this.manager_setting.off('change').on('change', function(event) {
						self.chatContext.emit(SettingsEvent.SWITCH_SETTING, event);
					});
					this.manage_setting_manager(config.login_info.is_handle_by_manager);
				}

				if (config.login_info.is_fan) {
					this.silent_ppv_setting = $("#chat-setting-silent-ppv");
					this.silent_ppv_setting.off('change').on('change', function(event) {
						self.chatContext.emit(SettingsEvent.SWITCH_SETTING, event);
					});
					this.manage_setting_silent_ppv(config.login_info.is_silent_ppv);
				}
			},

			load_studio: function (website_user_id) {
				this.loading_studio_id = website_user_id;
				this.first_customers_load = true;
				this.socket_connection.emit("refresh_jwt", {website_user_id: website_user_id});
			},

			get_studios_total_nb_unread: function () {
				return Object.values(this.studios).reduce(function (acc, studio) { return acc + studio.nb_unread_messages_sum; }, 0);
			},

			search_input_focus: function (event) {
				var self = this,
					$input = $('.chat-search__input'),
					throttle = null,
					delay = 500;
				$('.chat-sidebar__top').addClass('chat-sidebar__top--search-focus');
				$input.focus();
				$input.on('keyup', function(event) {
					if (throttle !== null) {
						clearTimeout(throttle);
					}
					throttle = setTimeout(function () {
						throttle = null;
						self.search_input_keyup(event);
						clearTimeout(throttle);
					}, delay);
				});
				$('.chat-sidebar__search-close').on('click', this.search_input_blur);
			},
			search_input_blur: function (event) {
				$('.chat-sidebar__top').removeClass('chat-sidebar__top--search-focus');
				$('.chat-search__input').off('keyup');
				$('.chat-sidebar__search-close').off('click');
			},
			search_input_keyup: function (event) {
				if (event.key === 'Enter' || event.keyCode === 13) {
					return;
				}
				var value = $('#chat-users-search-input input').val() || "";

				if (value.length < 2) {
					return;
				}

				this.chat_friend_manager.search_friend();
			},

			setup_refresh_cookie: function () {
				if (!config.cookie_expires) {
					// Nothing to do.
					return;
				}

				var delay = this.get_cookie_refresh_delay();

				if (delay) {
					if (this.refresh_cookie_interval) {
						clearInterval(this.refresh_cookie_interval);
					}

					this.refresh_cookie_interval = setInterval(this.refresh_cookie.bind(this), delay);
				} else {
					wglog.debug("setup_refresh_cookie", "unable to setup refresh (delay: " + delay +")");
				}
			},

			parse_jwt: function (token) {
				var base64Url = token.split('.')[1];
				var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
				var jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
					return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
				}).join(''));

				return JSON.parse(jsonPayload);
			},

			get_cookie_expiration: function () {
				var token = this.parse_jwt(config[config.cookie_name]);

				if (!token.exp) {
					wglog.debug("get_cookie_expiration", "token has no exp property : " + token);
					return 0;
				}

				return new Date(token.exp * 1000 || 0).getTime() - Date.now();
			},

			get_cookie_refresh_delay: function () {
				var expiration = this.get_cookie_expiration();

				if (!expiration) {
					wglog.debug("get_cookie_refresh_delay", "token expiration is: " + expiration);
					return 0;
				}

				if (!config.cookie_refresh_time_before_expiration || !Number.isInteger(config.cookie_refresh_time_before_expiration)) {
					wglog.debug("get_cookie_refresh_delay", "invalid config.cookie_refresh_time_before_expiration, must be a number >= 10000");
					return 0;
				}

				if (config.cookie_refresh_time_before_expiration < 10000) {
					wglog.debug("get_cookie_refresh_delay", "config.cookie_refresh_time_before_expiration, must be a number above then equal to 10000");
					return 0;
				}

				return Math.max(expiration - config.cookie_refresh_time_before_expiration, 10000);
			},

			refresh_cookie: function () {
				if (!config.cookie_refresh_method || ['post', 'socket'].indexOf(config.cookie_refresh_method) === -1) {
					wglog.debug("refresh_cookie", "invalid config.cookie_refresh_method value (must be: post or socket)");
					return;
				}

				switch (config.cookie_refresh_method) {
					case 'post':
						if (!config.cookie_refresh_post_path || typeof config.cookie_refresh_post_path !== 'string') {
							wglog.debug("refresh_cookie", "invalid config.cookie_refresh_post_path");
							return;
						}

						var self = this;

						$.ajax({
							'type': 'POST',
							'dataType': 'json',
							'url': config.cookie_refresh_post_path,
						})
							.done(this.new_cookie.bind(this))
							.fail(function(jqXHR, textStatus, errorThrown) {
								wglog.error("refresh_cookie", "error while requesting a new cookie", {
									errorThrown: errorThrown,
									textStatus: textStatus,
									responseText: jqXHR.responseText,
									status: jqXHR.status
								});
								log_and_tooltip.write_error({
									logTitle: 'manager::refresh_cookie error while requesting a new cookie',
									message: i18n.__('chat.error.connection_error'),
									refresh: true,
									source: "refresh_cookie"
								});
							});
						break;
					case 'socket':
						this.socket_connection.emit("refresh_jwt");
						break;
				}
			},

			new_cookie: function (data) {
				if (!data.chat_token) {
					wglog.error("new_cookie", "server response has no chat_token property", data);
					log_and_tooltip.write_error({
						logTitle: 'manager::new_cookie server response has no chat_token property',
						message: i18n.__('chat.error.connection_error'),
						refresh: true,
						source: "new_cookie"
					});
					return;
				}

				config[config.cookie_name] = data.chat_token;

				if (typeof data.chat_data_c === "string" && data.chat_data_c) {
					xv_storage.set('chat-pk', data.chat_data_c);
					config.login_info.id = this.loading_studio_id;
					this.priv_key = this.chatInitsAndPrefs.initKey(true);
					this.chat_friend_manager.set_priv_key(this.priv_key);
					this.init_connect_and_contacts = false;

					if ( this.priv_key == false ) {
						log_and_tooltip.log_error("new cookie, no private key in local");
						this.no_priv_key = true;
						this.priv_key = "";
					}
				}

				this.setup_refresh_cookie();
				this.hide_lost_connection_popup_on_disconnect = true;
				this.reconnect();
			},

			tip_notification: function (data) {
				if (!data.sender_id || !data.recipient_id || !data.message || (config.login_info.is_creator && !data.fans_expenses)) {
					wglog.error("tip_notification", "some data are missing to handle notification correctly", data);
					log_and_tooltip.write_error({
						logTitle: 'manager::new_cookie some data are missing to handle notification correctly',
						message: i18n.__('chat.error.connection_error'),
						refresh: true
					});
					return;
				}

				var message = {
					m: data.message,
					r: data.recipient_id,
					s: data.sender_id,
					y: 's',
					t: data.timestamp
				};

				var friend_id;

				if (data.sender_id == this.user_id) {
					friend_id = data.recipient_id;

					var selected_user = this.chat_friend_manager.get_selected_friend_infos();
					if (selected_user && selected_user.id_user == friend_id) {
						this.chat_friend_manager.allow_users_to_chat(selected_user);
					}
				} else {
					friend_id = data.sender_id;

					if (config.login_info.is_creator && typeof data.fans_expenses !== "undefined") {
						data.fans_expenses.amount_tips = parseFloat(data.fans_expenses.amount_tips).toString();
						data.fans_expenses.amount_total = parseFloat(data.fans_expenses.amount_total).toString();
						this.chat_friend_manager.prepareExpenses(friend_id, data.fans_expenses);
						this.chat_friend_manager.updatePopupExpenses(friend_id);
					}
				}

				try {
					var messageJson = JSON.parse(data.message);
					this.chat_friend_manager.setMultipleContactAttributes(friend_id, [
						{'name': 'tip_amount', 'value': messageJson.param['%amount%']},
						{'name': 'tip_created', 'value': message.t}
					]);
				} catch (e) {}

				this.add_message_friend(data.message_id, friend_id, message.s, message.m, message.t, message.y);
				this.chat_friend_manager.update_friend(friend_id);
				this.chat_friend_manager.reset_last_tip_intersection_observer(friend_id);
				this.add_expense_notif_in_list(friend_id);
			},

			filtered_friend_list: function (data) {
				wglog.debug("filtered_friend_list", data);
				if (data.friends_ids.length === 0) {
					//mass_message_manager.getBtn().prop('disabled', true);
					return;
				}
				//mass_message_manager.setFilteredIds(data);
			},

			register_new_user_from_xv_success: function(data) {
				this.chat_friend_manager.is_registering_new_contact = false;

				this.chat_friend_manager.selected_friend = data.website_user_id;
				this.chat_friend_manager.friends[data.website_user_id] = data.user_infos;

				$("#select_friend_li_" + data.xv_user_id).prop('id', 'select_friend_li_' + data.website_user_id);

				delete this.chat_friend_manager.friends[data.xv_user_id];

				this.chat_friend_manager.disabled_send_btn = false;
				this.chat_friend_manager.allow_users_to_chat(null, false);
				this.chat_friend_manager.send_button.find('span').text(i18n.__('chat.message_send'));

				this.chat_friend_manager.select_friend(data.website_user_id, null);
			},

			register_new_user_from_xv_error: function(data) {
				wglog.debug('register_new_user_from_xv_error', data);
			},

			user_is_hidden: function(data) {
				this.chat_friend_manager.remove_friend(data.friend_id);
				this.chat_friend_manager.close_conversation();
			},

			getPosition: function (element) {
				var $element = $(element);
				var $parent = $element.parent();

				if (!$element.length) {
					return false;
				}

				var position = {};

				if ($parent.length) {
					var parentPos = $parent.get(0).getBoundingClientRect(),
						childPos = $element.get(0).getBoundingClientRect();

					position.top = childPos.top - parentPos.top;
					position.left = childPos.left - parentPos.left;
				} else {
					var childPos = $element.get(0).getBoundingClientRect();
					position.top = childPos.top;
					position.left = childPos.left;
				}

				return position;
			},

			get_uploader_instance: function (method) {
				var _method = "default";

				if (typeof method === "string") {
					_method = method;
				} else if (config.file_upload && config.file_upload.method && typeof config.file_upload.method === "string") {
					_method = config.file_upload.method;
				}

				if (uploaders[_method]) {
					return uploaders[_method];
				}

				if (_method === "dropzone") {
					uploaders["dropzone"] = new UploadDropzone(
						'chat-files',
						this.chat_friend_manager,
						this.format_timestamp.bind(this),
						this.format_timestamp_relative.bind(this),
						this.get_last_conv_key.bind(this),
						this.insert_temp_message.bind(this),
						this.make_real_message.bind(this),
						this.get_input_value.bind(this),
						this.empty_message_form.bind(this)
					);
				} else {
					uploaders["default"] = new UploadDefault(
						this.make_real_message.bind(this),
						this.get_last_conv_key.bind(this),
						this.message_for_upload_progress_bar.bind(this),
						this.format_timestamp.bind(this),
						this.format_timestamp_relative.bind(this),
						this.chatInitsAndPrefs
					);
					uploaders["default"].init();
					uploaders["default"].init_socket(this.socket_connection);
				}

				return uploaders[_method];
			},

			check_show_error_on_failed_attempts: function (attempt_id) {
				if (typeof attempt_id !== "number" && typeof attempt_id !== "string") {
					return true;
				}

				var failed_attempts = storage.get("chat_failed_attempts");
				var previous_attempts = failed_attempts[attempt_id] || 1;

				if (previous_attempts > 2) {
					delete failed_attempts[attempt_id];
					storage.set("chat_failed_attempts", failed_attempts);
					return true;
				}

				failed_attempts[attempt_id] = previous_attempts + 1;

				storage.set("chat_failed_attempts", failed_attempts);
				return false;
			},

			get_input_value: function () {
				var textarea_message = this.input.val().trim();
				var editor = $('#chat-textarea-message')[0].emojioneArea;

				if (textarea_message === "" && editor && editor.getText() !== "") {
					textarea_message = editor.getText();
				}

				if (textarea_message === "") {
					wglog.debug("send message", "textarea empty");
					return "";
				}

				var error_message = "";
				$('#chat-textarea-error-popup').parents('.chat_xv_popup').remove();
				if (textarea_message.length > 10000) {
					error_message = i18n.__('chat.error.message_too_long', {'%nb_chars%': "10000"});
				}

				if (config.login_info.is_creator && !ReportMessage.checkAutoBlockAndAutoReport(textarea_message, this.user_id)) {
					error_message = i18n.__('chat.error.blocking_word_in_message', {'%word%': ReportMessage.getLastAutoBlockingWord()});
				}

				if (error_message) {
					log_and_tooltip.popup_open(
						$('.chat-message-form'),
						Mustache.render(tpl_textarea_error_popup, {content: error_message, timer: '10s'}),
						{popup_class: 'chat-ui-textarea-error-popup', position: {v: 'above', h: 'center'}, offset: {above: 16}, trigger: false, autoclose: 10000}
					);
					editor.setFocus();
					return "";
				}

				return textarea_message;
			},

			get_input_value_encrypted: function () {
				var value = this.get_input_value();
				return this.make_real_message(value, this.chat_friend_manager.selected || "make it clear");
			},

			quote_scroll_or_request: function (message_id) {
                var messageId = String(message_id);
                messageId = utils.sanitizeId(messageId);

                if (messageId[0] !== '#') {
                    messageId = '#' + messageId;
                }

                if ($(messageId).length) {
                    ScrollConversation.toMessage(messageId, true);
				} else {
					$('#chat_loading_overlay').show();

					this.socket_connection.emit("get_conversation_friend_part", {
						'recipient_id': this.chat_friend_manager.selected_friend,
						'most_ancient_message_uid': messageId.split('-')[2],
						'most_recent_message_uid': $("#chat_group_messages_tab_" + this.chat_friend_manager.selected_friend + ' .chat-message__id').first().prop('id').split('-')[2]
					});
				}
			},

			quote_show_more_button_init: function (element) {
				var paragraph = element.find('.chat-quote blockquote p'),
					showMoreBtn = element.find('.chat-quote__show-more');

				if (paragraph.prop('offsetWidth') < paragraph.prop('scrollWidth') || paragraph.prop('offsetHeight') < paragraph.prop('scrollHeight')) {
					showMoreBtn.removeClass('chat-quote__show-more--hidden');
				}

				showMoreBtn.off('click.quoteShow');
				showMoreBtn.on('click.quoteShow', function (event) {
					var quote = element.find('.chat-quote'),
						className = 'chat-quote--message-visible';
					quote.toggleClass(className);
					if (quote.hasClass(className)) {
						showMoreBtn.text(i18n.__('chat.show_less'));
					} else {
						showMoreBtn.text(i18n.__('chat.show_more'));
					}
				});
			},

			get_uploaded_file_message_html: function (info, json, timestamp) {
				if (!!this.chat_send_file && this.chat_send_file.can_display_message(json)) {
					return this.chat_send_file.get_message_html(info, json, timestamp);
				}

				var defaultUploader = this.get_uploader_instance('default');

				if (defaultUploader.can_display_message(json)) {
					return defaultUploader.get_message_html(info, json, timestamp);
				}

				return "";
			},

			update_content_message: function (data) {
				if (!this.vault) {
					return;
				}

				this.vault.refreshMessage(data);
			},

			manage_setting_silent_ppv: function(isSilentPPV) {
				this.silent_ppv_setting.prop('checked', isSilentPPV);
			},
			setting_silent_ppv_update_cm: function(user_id) {
				var friend_infos = this.chat_friend_manager.get_friend_infos(user_id);
				$('.contextual-menu__action[data-action="silent"]').each(function() {
					var $this = $(this);
					$this.find('.icon-f').remove();
					if (!!friend_infos.is_silent_ppv) {
						$this.text(i18n.__('chat.silent_mode_disable'));
						$this.prepend('<span class="icon-f icf-bell"></span>');
					} else {
						$this.text(i18n.__('chat.silent_mode_enable'));
						$this.prepend('<span class="icon-f icf-bell"></span>');
					}
				});
			},
			manage_setting_manager: function(isHandledByManager) {
				var classUsernameManager = 'chat-sidebar__username-managed',
					$usernameManagerManaged = $('.' + classUsernameManager);
				if (isHandledByManager) {
					if (!$usernameManagerManaged.length) {
						$usernameManagerManaged = $('<span>', {
							class: classUsernameManager,
							text: i18n.__('chat.manager')
						});
						$('.chat-sidebar__username-wrapper').append($usernameManagerManaged);
						this.manager_setting.prop("checked", true);
					}
				}
				else {
					$usernameManagerManaged.remove();
					this.manager_setting.prop("checked", false);
				}
			}
		};

		new manager(true);

	}, function( err ) {
		console.log('requirejs send error', err);

		if ( require_libs_done ) {
			return;
		}

		display_error_without_connect( 'chat.error.connection_adblock' );

	});
});

require.config({
	waitSeconds: 300,
	paths: {
		'jquery': 'jquery',
		'text': 'text',
		'json': 'json'
	},
	config: {
		text: {
			useXhr: function (url, protocol, hostname, port) {
				if (url.substr(0, 1) === '/') {
					return true;
				}
				
				if (url.substr(0, 2) === './') {
					return true;
				}
				
				/*if (url.match(/^https?:\/\/static[\w-]*\.(xvideos|red)-cdn\.com\/.*$/)) {
					return true;
				}*/
				
				var local_host = protocol + '://' + hostname;
				if (url.substr(0, local_host.length) === local_host) {
					return true;
				} else if (-1 !== hostname.split('.').pop().indexOf('local')) {
					return true;
				}
				return false;
			}
		}
	}
});

require(["chat/manager"]);
define("chat", function(){});

define('lib/i18n/translator',['config/chat', 'lib/storage', 'lib/utils'], function (conf, storage, utils) {
	
	var var_regexp = /%\w+%/g;
	
	var load_handlers = {};
	
	var clean_loc = function(loc) {
		loc = loc.replace(/\s+/, '');
		if (loc.length !== 2 && loc.length !== 5) {
			return false;
		}
		if (!loc.match(/^[a-z]{2}(-[A-Z]{2})?$/g)) {
			return false;
		}
		return loc;
	};
	
	var get_locale = function() {
		if (typeof(conf) === 'object' && typeof(conf.locale) === 'string') {
			var loc = clean_loc(conf.locale);
			if (loc) {
				return loc;
			}
		}
		if (document.documentElement && document.documentElement.lang && typeof(document.documentElement.lang) === 'string') {
			var loc = clean_loc(document.documentElement.lang);
			if (loc) {
				return loc;
			}
		}
		return 'en';
	};
	
	var jsonParse = function(text) {
		if(typeof(JSON) !== 'undefined' && typeof(JSON.parse) === 'function') {
			return JSON.parse(text);
		}
		return eval('(' + text + ')');
	};
	
	var get_version_path = function(catalog, locale) {
		if (typeof(conf) !== 'object' || typeof(conf.i18nvers) !== 'object') {
			return conf.i18n_path + '';
		}
		if (typeof(conf.i18nvers[catalog]) !== 'object' || typeof(conf.i18nvers[catalog][locale]) !== 'string') {
			return conf.i18n_path + '';
		}
		return '/v-' + conf.i18nvers[catalog][locale];
	};
	
	var load_translations = function(locale, catalog, on_loaded) {
		if (typeof conf.i18n === "object" && conf.i18n.hasOwnProperty('chat')) {
			on_loaded(conf.i18n);
		} else {
			load_translations_file(locale, catalog, on_loaded);
		}
	}
	
	var load_translations_file = function(locale, catalog, on_loaded) {
		var translations = false,
			path = get_version_path(catalog, locale);
		load_handlers[locale+'_'+catalog] = on_loaded;
		try {
			var req_obj = utils.createRequestObject();
			req_obj.open('GET', path + "/" + locale + ".json");
			req_obj.onreadystatechange = function (aEvt) {
				if(req_obj.readyState == 4) {
					if (req_obj.status == 200) {
						translations = req_obj.responseText;
						if(typeof(translations) === 'string') {
							translations = jsonParse(translations);
						}
					}
					on_loaded(translations);
				}
			};
			req_obj.send(null);
			return;
		}
		catch(err) {
			console.error(err.toString());
		}
		on_loaded(translations);
	};
	
	var strtr_val = function(key, value, default_val, args) {
		if (!value) {
			if (!default_val) {
				return key.split('_').join(' ');
			}
			value = default_val;
		}
		if (typeof args === 'object') {
			value = value.replace(var_regexp, function(match) {
				var replacement = typeof args[match] !== 'undefined' && args[match] !== null ? args[match] : match;
				return typeof replacement.toString === 'function' ? replacement.toString() : replacement;
			});
		}
		return value;
	};
	
	var flatten_val = function(value, args) {
		var $0 = null,
			trs = {},
			has_trs = false;
		for (var key in value) {
			if (value.hasOwnProperty(key)) {
				if (key === '$0') {
					$0 = strtr_val(key, value[key], null, args);
				} else if (typeof(value[key]) === 'object') {
					trs[key] = flatten_val(value[key], args);
					has_trs = true;
				} else {
					trs[key] = strtr_val(key, value[key], null, args);
					has_trs = true;
				}
			}
		}
		if (has_trs) {
			return trs;
		}
		return $0;
	};
	
	var i18n_catalog = function(catalog, locale) {
		this.trs = {};
		this.catalog = catalog;
		this.locale = locale;
		this.status = 'not_loaded';
		this._on_loaded = [];
	};
	
	i18n_catalog.prototype = {

		formatStringList: function (strings, langCode) {
			if (!Array.isArray(strings)) {
				throw new TypeError('strings must be an Array');
			}

			if (strings.length === 0) {
				return "";
			}
			if (strings.length === 1) {
				return strings[0];
			}

			var lang = langCode || this.getLocale(),
				localeRules = {
					"ar": { "separator": " ", "connector": " " },
					"cs": { "separator": ", ", "connector": " a" },
					"de": { "separator": ", ", "connector": " und" },
					"el": { "separator": ", ", "connector": " " },
					"en": { "separator": ", ", "connector": " and" },
					"es": { "separator": ", ", "connector": " y" },
					"fr": { "separator": ", ", "connector": " et" },
					"he": { "separator": ", ", "connector": " " },
					"hi": { "separator": ", ", "connector": " " },
					"hu": { "separator": ", ", "connector": " s" },
					"it": { "separator": ", ", "connector": " e" },
					"ja": { "separator": "", "connector": "" },
					"nl": { "separator": ", ", "connector": " en" },
					"no": { "separator": ", ", "connector": " og" },
					"pl": { "separator": ", ", "connector": " i" },
					"pt": { "separator": ", ", "connector": " e" },
					"ro": { "separator": ", ", "connector": " i" },
					"ru": { "separator": ", ", "connector": " " },
					"sv": { "separator": ", ", "connector": " och" },
					"tr": { "separator": ", ", "connector": " ve" },
					"vi-VN": { "separator": ", ", "connector": " v" },
					"zh": { "separator": "", "connector": "" }
				};

			if (!localeRules[lang]) {
				throw new TypeError('langCode must be one of: ' + Object.keys(localeRules).join(', ') + '.');
			}

			var rules = localeRules[lang],
				joined = strings.join(rules.separator),
				trimmedSeparator = rules.separator.trim(),
				lastIndex = joined.lastIndexOf(trimmedSeparator);

			if (lastIndex === -1) {
				return joined;
			}

			return (
				joined.substring(0, lastIndex) +
				localeRules[lang].connector +
				joined.substring(lastIndex + trimmedSeparator.length)
			);
		},
		
		getCatalog: function() {
			return this.catalog;
		},
		
		getLocale: function() {
			return this.locale;
		},
		
		getStatus: function() {
			return this.status;
		},
		
		isLoaded: function() {
			this.status === 'loaded';
		},
		
		load: function(on_loaded) {
			if (this.status === 'loaded') {
				if (typeof(on_loaded) === 'function') {
					on_loaded(this);
				}
				return true;
			}
			if (this.catalog === '#') {
				this.status = 'loaded'
				if (typeof(on_loaded) === 'function') {
					on_loaded(this);
				}
				return true;
			}
			if (typeof(on_loaded) === 'function') {
				this._on_loaded.push(on_loaded);
			}
			if (this.status === 'loading') {
				return -1;
			}
			this.status = 'loading';
			var self = this;
			load_translations(this.locale, this.catalog, function(trs) {
				if (typeof(trs) === 'object') {
					self.status = 'loaded'
					self.trs = trs;
					for (var f in self._on_loaded) {
						self._on_loaded[f](self);
					}
					return;
				}
				console.log('i18n: Cannot load '+self.locale+' translations for catalog '+self.catalog+'.');
				if (self.locale !== 'en') {
					load_translations('en', self.catalog, function(trs) {
						if (typeof(trs) === 'object') {
							console.log('i18n: Loaded en translations either.');
							self.trs = trs;
						} else {
							console.log('i18n: Cannot load en translations either.');
						}
						self.status = 'loaded'
						for (var f in self._on_loaded) {
							self._on_loaded[f](self);
						}
					});
				}
				self.status = 'loaded'
				for (var f in self._on_loaded) {
					self._on_loaded[f](self);
				}
			});
			return -1;
		},

		plural: function (single, multiple, count, countPlaceholder) {
			if (count === 0) {
				return this.__(single).replace('1', '0');
			} else if (count === 1) {
				return this.__(single);
			} else {
				var params = {};
				params[countPlaceholder] = count.toString(10);
				return this.__(multiple, params);
			}
		},
		
		__: function(key, args, default_val) {
			if (this.status !== 'loaded') {
				this.load();
				return strtr_val(key.split('.').pop(), false, default_val, args);
			}
			var namespace = key.split('.'),
				val = this.trs;
			for (var i in namespace) {
				if (namespace[i] === '*') {
					return flatten_val(val, args);
				}
				if (typeof(val[namespace[i]]) !== 'object') {
					return strtr_val(namespace.pop(), false, default_val, args);
				}
				val = val[namespace[i]];
			}
			if (typeof(val['$0']) !== 'string') {
				return strtr_val(namespace.pop(), false, default_val, args);
			}
			return strtr_val(key, val['$0'], default_val, args);
		},
		
		___: function(key_args) {
			var out = {};
			for (var k in key_args) {
				if (key_args.hasOwnProperty(k)) {
					out[k] = this.__(k, key_args[k]);
				}
			}
			return out;
		}
		
	};
	
	var i18n = function() {
		this.catalogs = {};
		this.locale = false;
		this.default_catalog = false;
	};
	
	i18n.prototype = {
		
		getLocale: function() {
			if (!this.locale) {
				this.locale = get_locale();
			}
			return this.locale;
		},
		
		setDefaultCatalog: function(catalog, load) {
			this.default_catalog = catalog;
			if (typeof(load) === 'undefined' || load) {
				this.getCatalog(catalog);
			}
		},
		
		getCatalog: function(catalog, on_loaded) {
			if (typeof(catalog) === 'undefined' || !catalog) {
				if (!this.default_catalog) {
					console.error('i18n: No default catalog defined');
					this.default_catalog = '#';
				}
				catalog = this.default_catalog;
			}
			this.getLocale();
			if (typeof(this.catalogs[catalog]) === 'undefined') {
				this.catalogs[catalog] = new i18n_catalog(catalog, this.locale);
			}
			this.catalogs[catalog].load(on_loaded);
			return this.catalogs[catalog];
		},
		
		__: function(key, args, catalog, default_val) {
			return this.getCatalog(catalog).__(key, args, default_val);
		},
		
		___: function(key_args, catalog) {
			return this.getCatalog(catalog).__(key_args);
		},
		
		loadLocaleTranslations: function(locale, catalog, translations) {
			if (typeof(load_handlers[locale+'_'+catalog]) === 'function') {
				(load_handlers[locale+'_'+catalog])(translations);
				return;
			}
			this.getLocale();
			if (typeof(this.catalogs[catalog]) === 'undefined') {
				this.catalogs[catalog] = new i18n_catalog(catalog, this.locale);
			}
			if (this.catalogs[catalog].getStatus() !== 'not_loaded') {
				console.warn('i18n: Catalog ' + catalog + ' is already being loaded');
			}
			this.catalogs[catalog].status = 'loaded';
			this.catalogs[catalog].trs = translations;
		}
		
	};
	
	return new i18n();
});

